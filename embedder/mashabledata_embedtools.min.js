(function(e){var t={set:{colors:1,values:1,backgroundColor:1,scaleColors:1,normalizeFunction:1,focus:1},get:{selectedRegions:1,selectedMarkers:1,mapObject:1,regionName:1}};e.fn.vectorMap=function(e){var n,r,i,n=this.children(".jvectormap-container").data("mapObject");if(e==="addMap")jvm.WorldMap.maps[arguments[1]]=arguments[2];else{if(!(e!=="set"&&e!=="get"||!t[e][arguments[1]]))return r=arguments[1].charAt(0).toUpperCase()+arguments[1].substr(1),n[e+r].apply(n,Array.prototype.slice.call(arguments,2));e=e||{},e.container=this,n=new jvm.WorldMap(e)}return this}})(jQuery),function(e){function r(t){var n=t||window.event,r=[].slice.call(arguments,1),i=0,s=!0,o=0,u=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(i=n.wheelDelta/120),n.detail&&(i=-n.detail/3),u=i,n.axis!==undefined&&n.axis===n.HORIZONTAL_AXIS&&(u=0,o=-1*i),n.wheelDeltaY!==undefined&&(u=n.wheelDeltaY/120),n.wheelDeltaX!==undefined&&(o=-1*n.wheelDeltaX/120),r.unshift(t,i,o,u),(e.event.dispatch||e.event.handle).apply(this,r)}var t=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var n=t.length;n;)e.event.fixHooks[t[--n]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=t.length;e;)this.addEventListener(t[--e],r,!1);else this.onmousewheel=r},teardown:function(){if(this.removeEventListener)for(var e=t.length;e;)this.removeEventListener(t[--e],r,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery);var jvm={inherits:function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.parentClass=t},mixin:function(e,t){var n;for(n in t.prototype)t.prototype.hasOwnProperty(n)&&(e.prototype[n]=t.prototype[n])},min:function(e){var t=Number.MAX_VALUE,n;if(e instanceof Array)for(n=0;n<e.length;n++)e[n]<t&&(t=e[n]);else for(n in e)e[n]<t&&(t=e[n]);return t},max:function(e){var t=Number.MIN_VALUE,n;if(e instanceof Array)for(n=0;n<e.length;n++)e[n]>t&&(t=e[n]);else for(n in e)e[n]>t&&(t=e[n]);return t},keys:function(e){var t=[],n;for(n in e)t.push(n);return t},values:function(e){var t=[],n,r;for(r=0;r<arguments.length;r++){e=arguments[r];for(n in e)t.push(e[n])}return t}};jvm.$=jQuery,jvm.AbstractElement=function(e,t){this.node=this.createElement(e),this.name=e,this.properties={},t&&this.set(t)},jvm.AbstractElement.prototype.set=function(e,t){var n;if(typeof e=="object")for(n in e)this.properties[n]=e[n],this.applyAttr(n,e[n]);else this.properties[e]=t,this.applyAttr(e,t)},jvm.AbstractElement.prototype.get=function(e){return this.properties[e]},jvm.AbstractElement.prototype.applyAttr=function(e,t){this.node.setAttribute(e,t)},jvm.AbstractElement.prototype.remove=function(){jvm.$(this.node).remove()},jvm.AbstractCanvasElement=function(e,t,n){this.container=e,this.setSize(t,n),this.rootElement=new jvm[this.classPrefix+"GroupElement"],this.node.appendChild(this.rootElement.node),this.container.appendChild(this.node)},jvm.AbstractCanvasElement.prototype.add=function(e,t){t=t||this.rootElement,t.add(e),e.canvas=this},jvm.AbstractCanvasElement.prototype.addPath=function(e,t,n){var r=new jvm[this.classPrefix+"PathElement"](e,t);return this.add(r,n),r},jvm.AbstractCanvasElement.prototype.addCircle=function(e,t,n){var r=new jvm[this.classPrefix+"CircleElement"](e,t);return this.add(r,n),r},jvm.AbstractCanvasElement.prototype.addGroup=function(e){var t=new jvm[this.classPrefix+"GroupElement"];return e?e.node.appendChild(t.node):this.node.appendChild(t.node),t.canvas=this,t},jvm.AbstractShapeElement=function(e,t,n){this.style=n||{},this.style.current={},this.isHovered=!1,this.isSelected=!1,this.updateStyle()},jvm.AbstractShapeElement.prototype.setHovered=function(e){this.isHovered!==e&&(this.isHovered=e,this.updateStyle())},jvm.AbstractShapeElement.prototype.setSelected=function(e){this.isSelected!==e&&(this.isSelected=e,this.updateStyle(),jvm.$(this.node).trigger("selected",[e]))},jvm.AbstractShapeElement.prototype.setStyle=function(e,t){var n={};typeof e=="object"?n=e:n[e]=t,jvm.$.extend(this.style.current,n),this.updateStyle()},jvm.AbstractShapeElement.prototype.updateStyle=function(){var e={};jvm.AbstractShapeElement.mergeStyles(e,this.style.initial),jvm.AbstractShapeElement.mergeStyles(e,this.style.current),this.isHovered&&jvm.AbstractShapeElement.mergeStyles(e,this.style.hover),this.isSelected&&(jvm.AbstractShapeElement.mergeStyles(e,this.style.selected),this.isHovered&&jvm.AbstractShapeElement.mergeStyles(e,this.style.selectedHover)),this.set(e)},jvm.AbstractShapeElement.mergeStyles=function(e,t){var n;t=t||{};for(n in t)t[n]===null?delete e[n]:e[n]=t[n]},jvm.SVGElement=function(e,t){jvm.SVGElement.parentClass.apply(this,arguments)},jvm.inherits(jvm.SVGElement,jvm.AbstractElement),jvm.SVGElement.svgns="http://www.w3.org/2000/svg",jvm.SVGElement.prototype.createElement=function(e){return document.createElementNS(jvm.SVGElement.svgns,e)},jvm.SVGElement.prototype.addClass=function(e){this.node.setAttribute("class",e)},jvm.SVGElement.prototype.getElementCtr=function(e){return jvm["SVG"+e]},jvm.SVGElement.prototype.getBBox=function(){return this.node.getBBox()},jvm.SVGGroupElement=function(){jvm.SVGGroupElement.parentClass.call(this,"g")},jvm.inherits(jvm.SVGGroupElement,jvm.SVGElement),jvm.SVGGroupElement.prototype.add=function(e){this.node.appendChild(e.node)},jvm.SVGCanvasElement=function(e,t,n){this.classPrefix="SVG",jvm.SVGCanvasElement.parentClass.call(this,"svg"),jvm.AbstractCanvasElement.apply(this,arguments)},jvm.inherits(jvm.SVGCanvasElement,jvm.SVGElement),jvm.mixin(jvm.SVGCanvasElement,jvm.AbstractCanvasElement),jvm.SVGCanvasElement.prototype.setSize=function(e,t){this.width=e,this.height=t,this.node.setAttribute("width",e),this.node.setAttribute("height",t)},jvm.SVGCanvasElement.prototype.applyTransformParams=function(e,t,n){this.scale=e,this.transX=t,this.transY=n,this.rootElement.node.setAttribute("transform","scale("+e+") translate("+t+", "+n+")")},jvm.SVGShapeElement=function(e,t,n){jvm.SVGShapeElement.parentClass.call(this,e,t),jvm.AbstractShapeElement.apply(this,arguments)},jvm.inherits(jvm.SVGShapeElement,jvm.SVGElement),jvm.mixin(jvm.SVGShapeElement,jvm.AbstractShapeElement),jvm.SVGPathElement=function(e,t){jvm.SVGPathElement.parentClass.call(this,"path",e,t),this.node.setAttribute("fill-rule","evenodd")},jvm.inherits(jvm.SVGPathElement,jvm.SVGShapeElement),jvm.SVGCircleElement=function(e,t){jvm.SVGCircleElement.parentClass.call(this,"circle",e,t)},jvm.inherits(jvm.SVGCircleElement,jvm.SVGShapeElement),jvm.VMLElement=function(e,t){jvm.VMLElement.VMLInitialized||jvm.VMLElement.initializeVML(),jvm.VMLElement.parentClass.apply(this,arguments)},jvm.inherits(jvm.VMLElement,jvm.AbstractElement),jvm.VMLElement.VMLInitialized=!1,jvm.VMLElement.initializeVML=function(){try{document.namespaces.rvml||document.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),jvm.VMLElement.prototype.createElement=function(e){return document.createElement("<rvml:"+e+' class="rvml">')}}catch(e){jvm.VMLElement.prototype.createElement=function(e){return document.createElement("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}document.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)"),jvm.VMLElement.VMLInitialized=!0},jvm.VMLElement.prototype.getElementCtr=function(e){return jvm["VML"+e]},jvm.VMLElement.prototype.addClass=function(e){jvm.$(this.node).addClass(e)},jvm.VMLElement.prototype.applyAttr=function(e,t){this.node[e]=t},jvm.VMLElement.prototype.getBBox=function(){var e=jvm.$(this.node);return{x:e.position().left/this.canvas.scale,y:e.position().top/this.canvas.scale,width:e.width()/this.canvas.scale,height:e.height()/this.canvas.scale}},jvm.VMLGroupElement=function(){jvm.VMLGroupElement.parentClass.call(this,"group"),this.node.style.left="0px",this.node.style.top="0px",this.node.coordorigin="0 0"},jvm.inherits(jvm.VMLGroupElement,jvm.VMLElement),jvm.VMLGroupElement.prototype.add=function(e){this.node.appendChild(e.node)},jvm.VMLCanvasElement=function(e,t,n){this.classPrefix="VML",jvm.VMLCanvasElement.parentClass.call(this,"group"),jvm.AbstractCanvasElement.apply(this,arguments),this.node.style.position="absolute"},jvm.inherits(jvm.VMLCanvasElement,jvm.VMLElement),jvm.mixin(jvm.VMLCanvasElement,jvm.AbstractCanvasElement),jvm.VMLCanvasElement.prototype.setSize=function(e,t){var n,r,i,s;this.width=e,this.height=t,this.node.style.width=e+"px",this.node.style.height=t+"px",this.node.coordsize=e+" "+t,this.node.coordorigin="0 0";if(this.rootElement){n=this.rootElement.node.getElementsByTagName("shape");for(i=0,s=n.length;i<s;i++)n[i].coordsize=e+" "+t,n[i].style.width=e+"px",n[i].style.height=t+"px";r=this.node.getElementsByTagName("group");for(i=0,s=r.length;i<s;i++)r[i].coordsize=e+" "+t,r[i].style.width=e+"px",r[i].style.height=t+"px"}},jvm.VMLCanvasElement.prototype.applyTransformParams=function(e,t,n){this.scale=e,this.transX=t,this.transY=n,this.rootElement.node.coordorigin=this.width-t-this.width/100+","+(this.height-n-this.height/100),this.rootElement.node.coordsize=this.width/e+","+this.height/e},jvm.VMLShapeElement=function(e,t){jvm.VMLShapeElement.parentClass.call(this,e,t),this.fillElement=new jvm.VMLElement("fill"),this.strokeElement=new jvm.VMLElement("stroke"),this.node.appendChild(this.fillElement.node),this.node.appendChild(this.strokeElement.node),this.node.stroked=!1,jvm.AbstractShapeElement.apply(this,arguments)},jvm.inherits(jvm.VMLShapeElement,jvm.VMLElement),jvm.mixin(jvm.VMLShapeElement,jvm.AbstractShapeElement),jvm.VMLShapeElement.prototype.applyAttr=function(e,t){switch(e){case"fill":this.node.fillcolor=t;break;case"fill-opacity":this.fillElement.node.opacity=Math.round(t*100)+"%";break;case"stroke":t==="none"?this.node.stroked=!1:this.node.stroked=!0,this.node.strokecolor=t;break;case"stroke-opacity":this.strokeElement.node.opacity=Math.round(t*100)+"%";break;case"stroke-width":parseInt(t,10)===0?this.node.stroked=!1:this.node.stroked=!0,this.node.strokeweight=t;break;case"d":this.node.path=jvm.VMLPathElement.pathSvgToVml(t);break;default:jvm.VMLShapeElement.parentClass.prototype.applyAttr.apply(this,arguments)}},jvm.VMLPathElement=function(e,t){var n=new jvm.VMLElement("skew");jvm.VMLPathElement.parentClass.call(this,"shape",e,t),this.node.coordorigin="0 0",n.node.on=!0,n.node.matrix="0.01,0,0,0.01,0,0",n.node.offset="0,0",this.node.appendChild(n.node)},jvm.inherits(jvm.VMLPathElement,jvm.VMLShapeElement),jvm.VMLPathElement.prototype.applyAttr=function(e,t){e==="d"?this.node.path=jvm.VMLPathElement.pathSvgToVml(t):jvm.VMLShapeElement.prototype.applyAttr.call(this,e,t)},jvm.VMLPathElement.pathSvgToVml=function(e){var t="",n=0,r=0,i,s;return e=e.replace(/(-?\d+)e(-?\d+)/g,"0"),e.replace(/([MmLlHhVvCcSs])\s*((?:-?\d*(?:\.\d+)?\s*,?\s*)+)/g,function(e,t,o,u){o=o.replace(/(\d)-/g,"$1,-").replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s+/g,",").split(","),o[0]||o.shift();for(var a=0,f=o.length;a<f;a++)o[a]=Math.round(100*o[a]);switch(t){case"m":return n+=o[0],r+=o[1],"t"+o.join(",");case"M":return n=o[0],r=o[1],"m"+o.join(",");case"l":return n+=o[0],r+=o[1],"r"+o.join(",");case"L":return n=o[0],r=o[1],"l"+o.join(",");case"h":return n+=o[0],"r"+o[0]+",0";case"H":return n=o[0],"l"+n+","+r;case"v":return r+=o[0],"r0,"+o[0];case"V":return r=o[0],"l"+n+","+r;case"c":return i=n+o[o.length-4],s=r+o[o.length-3],n+=o[o.length-2],r+=o[o.length-1],"v"+o.join(",");case"C":return i=o[o.length-4],s=o[o.length-3],n=o[o.length-2],r=o[o.length-1],"c"+o.join(",");case"s":return o.unshift(r-s),o.unshift(n-i),i=n+o[o.length-4],s=r+o[o.length-3],n+=o[o.length-2],r+=o[o.length-1],"v"+o.join(",");case"S":return o.unshift(r+r-s),o.unshift(n+n-i),i=o[o.length-4],s=o[o.length-3],n=o[o.length-2],r=o[o.length-1],"c"+o.join(",")}return""}).replace(/z/g,"e")},jvm.VMLCircleElement=function(e,t){jvm.VMLCircleElement.parentClass.call(this,"oval",e,t)},jvm.inherits(jvm.VMLCircleElement,jvm.VMLShapeElement),jvm.VMLCircleElement.prototype.applyAttr=function(e,t){switch(e){case"r":this.node.style.width=t*2+"px",this.node.style.height=t*2+"px",this.applyAttr("cx",this.get("cx")||0),this.applyAttr("cy",this.get("cy")||0);break;case"cx":if(!t)return;this.node.style.left=t-(this.get("r")||0)+"px";break;case"cy":if(!t)return;this.node.style.top=t-(this.get("r")||0)+"px";break;default:jvm.VMLCircleElement.parentClass.prototype.applyAttr.call(this,e,t)}},jvm.VectorCanvas=function(e,t,n){return this.mode=window.SVGAngle?"svg":"vml",this.mode=="svg"?this.impl=new jvm.SVGCanvasElement(e,t,n):this.impl=new jvm.VMLCanvasElement(e,t,n),this.impl},jvm.SimpleScale=function(e){this.scale=e},jvm.SimpleScale.prototype.getValue=function(e){return e},jvm.OrdinalScale=function(e){this.scale=e},jvm.OrdinalScale.prototype.getValue=function(e){return this.scale[e]},jvm.NumericScale=function(e,t,n,r){this.scale=[],t=t||"linear",e&&this.setScale(e),t&&this.setNormalizeFunction(t),n&&this.setMin(n),r&&this.setMax(r)},jvm.NumericScale.prototype={setMin:function(e){this.clearMinValue=e,typeof this.normalize=="function"?this.minValue=this.normalize(e):this.minValue=e},setMax:function(e){this.clearMaxValue=e,typeof this.normalize=="function"?this.maxValue=this.normalize(e):this.maxValue=e},setScale:function(e){var t;for(t=0;t<e.length;t++)this.scale[t]=[e[t]]},setNormalizeFunction:function(e){e==="polynomial"?this.normalize=function(e){return Math.pow(e,.2)}:e==="linear"?delete this.normalize:this.normalize=e,this.setMin(this.clearMinValue),this.setMax(this.clearMaxValue)},getValue:function(e){var t=[],n=0,r,i=0,s;typeof this.normalize=="function"&&(e=this.normalize(e));for(i=0;i<this.scale.length-1;i++)r=this.vectorLength(this.vectorSubtract(this.scale[i+1],this.scale[i])),t.push(r),n+=r;s=(this.maxValue-this.minValue)/n;for(i=0;i<t.length;i++)t[i]*=s;i=0,e-=this.minValue;while(e-t[i]>=0)e-=t[i],i++;return i==this.scale.length-1?e=this.vectorToNum(this.scale[i]):e=this.vectorToNum(this.vectorAdd(this.scale[i],this.vectorMult(this.vectorSubtract(this.scale[i+1],this.scale[i]),e/t[i]))),e},vectorToNum:function(e){var t=0,n;for(n=0;n<e.length;n++)t+=Math.round(e[n])*Math.pow(256,e.length-n-1);return t},vectorSubtract:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]-t[r];return n},vectorAdd:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]+t[r];return n},vectorMult:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]*t;return n},vectorLength:function(e){var t=0,n;for(n=0;n<e.length;n++)t+=e[n]*e[n];return Math.sqrt(t)}},jvm.ColorScale=function(e,t,n,r){jvm.ColorScale.parentClass.apply(this,arguments)},jvm.inherits(jvm.ColorScale,jvm.NumericScale),jvm.ColorScale.prototype.setScale=function(e){var t;for(t=0;t<e.length;t++)this.scale[t]=jvm.ColorScale.rgbToArray(e[t])},jvm.ColorScale.prototype.getValue=function(e){return jvm.ColorScale.numToRgb(jvm.ColorScale.parentClass.prototype.getValue.call(this,e))},jvm.ColorScale.arrayToRgb=function(e){var t="#",n,r;for(r=0;r<e.length;r++)n=e[r].toString(16),t+=n.length==1?"0"+n:n;return t},jvm.ColorScale.numToRgb=function(e){e=e.toString(16);while(e.length<6)e="0"+e;return"#"+e},jvm.ColorScale.rgbToArray=function(e){return e=e.substr(1),[parseInt(e.substr(0,2),16),parseInt(e.substr(2,2),16),parseInt(e.substr(4,2),16)]},jvm.DataSeries=function(e,t){var n;e=e||{},e.attribute=e.attribute||"fill",this.elements=t,this.params=e,e.attributes&&this.setAttributes(e.attributes),jvm.$.isArray(e.scale)?(n=e.attribute==="fill"||e.attribute==="stroke"?jvm.ColorScale:jvm.NumericScale,this.scale=new n(e.scale,e.normalizeFunction,e.min,e.max)):e.scale?this.scale=new jvm.OrdinalScale(e.scale):this.scale=new jvm.SimpleScale(e.scale),this.values=e.values||{},this.setValues(this.values)},jvm.DataSeries.prototype={setAttributes:function(e,t){var n=e,r;if(typeof e=="string")this.elements[e]&&this.elements[e].setStyle(this.params.attribute,t);else for(r in n)this.elements[r]&&this.elements[r].element.setStyle(this.params.attribute,n[r])},setValues:function(e){var t=Number.MIN_VALUE,n=Number.MAX_VALUE,r,i,s={};if(this.scale instanceof jvm.OrdinalScale||this.scale instanceof jvm.SimpleScale)for(i in e)e[i]?s[i]=this.scale.getValue(e[i]):s[i]=this.elements[i].element.style.initial[this.params.attribute];else{if(!this.params.min||!this.params.max){for(i in e)r=parseFloat(e[i]),r>t&&(t=e[i]),r<n&&(n=r);this.params.min||this.scale.setMin(n),this.params.max||this.scale.setMax(t),this.params.min=n,this.params.max=t}for(i in e)r=parseFloat(e[i]),isNaN(r)?s[i]=this.elements[i].element.style.initial[this.params.attribute]:s[i]=this.scale.getValue(r)}this.setAttributes(s),jvm.$.extend(this.values,e)},clear:function(){var e,t={};for(e in this.values)this.elements[e]&&(t[e]=this.elements[e].element.style.initial[this.params.attribute]);this.setAttributes(t),this.values={}},setScale:function(e){this.scale.setScale(e),this.values&&this.setValues(this.values)},setNormalizeFunction:function(e){this.scale.setNormalizeFunction(e),this.values&&this.setValues(this.values)}},jvm.Proj={degRad:180/Math.PI,radDeg:Math.PI/180,radius:6381372,sgn:function(e){return e>0?1:e<0?-1:e},mill:function(e,t,n){return{x:this.radius*(t-n)*this.radDeg,y:-this.radius*Math.log(Math.tan((45+.4*e)*this.radDeg))/.8}},mill_inv:function(e,t,n){return{lat:(2.5*Math.atan(Math.exp(.8*t/this.radius))-5*Math.PI/8)*this.degRad,lng:(n*this.radDeg+e/this.radius)*this.degRad}},merc:function(e,t,n){return{x:this.radius*(t-n)*this.radDeg,y:-this.radius*Math.log(Math.tan(Math.PI/4+e*Math.PI/360))}},merc_inv:function(e,t,n){return{lat:(2*Math.atan(Math.exp(t/this.radius))-Math.PI/2)*this.degRad,lng:(n*this.radDeg+e/this.radius)*this.degRad}},aea:function(e,t,n){var r=0,i=n*this.radDeg,s=29.5*this.radDeg,o=45.5*this.radDeg,u=e*this.radDeg,a=t*this.radDeg,f=(Math.sin(s)+Math.sin(o))/2,l=Math.cos(s)*Math.cos(s)+2*f*Math.sin(s),c=f*(a-i),h=Math.sqrt(l-2*f*Math.sin(u))/f,p=Math.sqrt(l-2*f*Math.sin(r))/f;return{x:h*Math.sin(c)*this.radius,y:-(p-h*Math.cos(c))*this.radius}},aea_inv:function(e,t,n){var r=e/this.radius,i=t/this.radius,s=0,o=n*this.radDeg,u=29.5*this.radDeg,a=45.5*this.radDeg,f=(Math.sin(u)+Math.sin(a))/2,l=Math.cos(u)*Math.cos(u)+2*f*Math.sin(u),c=Math.sqrt(l-2*f*Math.sin(s))/f,h=Math.sqrt(r*r+(c-i)*(c-i)),p=Math.atan(r/(c-i));return{lat:Math.asin((l-h*h*f*f)/(2*f))*this.degRad,lng:(o+p/f)*this.degRad}},lcc:function(e,t,n){var r=0,i=n*this.radDeg,s=t*this.radDeg,o=33*this.radDeg,u=45*this.radDeg,a=e*this.radDeg,f=Math.log(Math.cos(o)*(1/Math.cos(u)))/Math.log(Math.tan(Math.PI/4+u/2)*(1/Math.tan(Math.PI/4+o/2))),l=Math.cos(o)*Math.pow(Math.tan(Math.PI/4+o/2),f)/f,c=l*Math.pow(1/Math.tan(Math.PI/4+a/2),f),h=l*Math.pow(1/Math.tan(Math.PI/4+r/2),f);return{x:c*Math.sin(f*(s-i))*this.radius,y:-(h-c*Math.cos(f*(s-i)))*this.radius}},lcc_inv:function(e,t,n){var r=e/this.radius,i=t/this.radius,s=0,o=n*this.radDeg,u=33*this.radDeg,a=45*this.radDeg,f=Math.log(Math.cos(u)*(1/Math.cos(a)))/Math.log(Math.tan(Math.PI/4+a/2)*(1/Math.tan(Math.PI/4+u/2))),l=Math.cos(u)*Math.pow(Math.tan(Math.PI/4+u/2),f)/f,c=l*Math.pow(1/Math.tan(Math.PI/4+s/2),f),h=this.sgn(f)*Math.sqrt(r*r+(c-i)*(c-i)),p=Math.atan(r/(c-i));return{lat:(2*Math.atan(Math.pow(l/h,1/f))-Math.PI/2)*this.degRad,lng:(o+p/f)*this.degRad}}},jvm.WorldMap=function(e){var t=this,n;this.params=jvm.$.extend(!0,{},jvm.WorldMap.defaultParams,e);if(!jvm.WorldMap.maps[this.params.map])throw new Error("Attempt to use map which was not loaded: "+this.params.map);this.mapData=jvm.WorldMap.maps[this.params.map],this.markers={},this.regions={},this.regionsColors={},this.regionsData={},this.container=jvm.$("<div>").css({width:"100%",height:"100%"}).addClass("jvectormap-container"),this.params.container.append(this.container),this.container.data("mapObject",this),this.container.css({position:"relative",overflow:"hidden"}),this.defaultWidth=this.mapData.width,this.defaultHeight=this.mapData.height,this.setBackgroundColor(this.params.backgroundColor),this.onResize=function(){t.setSize()},jvm.$(window).resize(this.onResize);for(n in jvm.WorldMap.apiEvents)this.params[n]&&this.container.bind(jvm.WorldMap.apiEvents[n]+".jvectormap",this.params[n]);this.canvas=new jvm.VectorCanvas(this.container[0],this.width,this.height),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?this.params.bindTouchEvents&&this.bindContainerTouchEvents():this.bindContainerEvents(),this.bindElementEvents(),this.createLabel(),this.params.zoomButtons&&this.bindZoomButtons(),this.createRegions(),this.createMarkers(this.params.markers||{}),this.setSize(),this.params.focusOn&&(typeof this.params.focusOn=="object"?this.setFocus.call(this,this.params.focusOn.scale,this.params.focusOn.x,this.params.focusOn.y):this.setFocus.call(this,this.params.focusOn)),this.params.selectedRegions&&this.setSelectedRegions(this.params.selectedRegions),this.params.selectedMarkers&&this.setSelectedMarkers(this.params.selectedMarkers),this.params.series&&this.createSeries()},jvm.WorldMap.prototype={transX:0,transY:0,scale:1,baseTransX:0,baseTransY:0,baseScale:1,width:0,height:0,setBackgroundColor:function(e){this.container.css("background-color",e)},resize:function(){var e=this.baseScale;this.width/this.height>this.defaultWidth/this.defaultHeight?(this.baseScale=this.height/this.defaultHeight,this.baseTransX=Math.abs(this.width-this.defaultWidth*this.baseScale)/(2*this.baseScale)):(this.baseScale=this.width/this.defaultWidth,this.baseTransY=Math.abs(this.height-this.defaultHeight*this.baseScale)/(2*this.baseScale)),this.scale*=this.baseScale/e,this.transX*=this.baseScale/e,this.transY*=this.baseScale/e},setSize:function(){this.width=this.container.width(),this.height=this.container.height(),this.resize(),this.canvas.setSize(this.width,this.height),this.applyTransform()},reset:function(){var e,t;for(e in this.series)for(t=0;t<this.series[e].length;t++)this.series[e][t].clear();this.scale=this.baseScale,this.transX=this.baseTransX,this.transY=this.baseTransY,this.applyTransform()},applyTransform:function(){var e,t,n,r;this.defaultWidth*this.scale<=this.width?(e=(this.width-this.defaultWidth*this.scale)/(2*this.scale),n=(this.width-this.defaultWidth*this.scale)/(2*this.scale)):(e=0,n=(this.width-this.defaultWidth*this.scale)/this.scale),this.defaultHeight*this.scale<=this.height?(t=(this.height-this.defaultHeight*this.scale)/(2*this.scale),r=(this.height-this.defaultHeight*this.scale)/(2*this.scale)):(t=0,r=(this.height-this.defaultHeight*this.scale)/this.scale),this.transY>t?this.transY=t:this.transY<r&&(this.transY=r),this.transX>e?this.transX=e:this.transX<n&&(this.transX=n),this.canvas.applyTransformParams(this.scale,this.transX,this.transY),this.markers&&this.repositionMarkers(),this.container.trigger("viewportChange",[this.scale/this.baseScale,this.transX,this.transY])},bindContainerEvents:function(){var e=!1,t,n,r=this;this.container.mousemove(function(i){return e&&(r.transX-=(t-i.pageX)/r.scale,r.transY-=(n-i.pageY)/r.scale,r.applyTransform(),t=i.pageX,n=i.pageY),!1}).mousedown(function(r){return e=!0,t=r.pageX,n=r.pageY,!1}),jvm.$("body").mouseup(function(){e=!1}),this.params.zoomOnScroll&&this.container.mousewheel(function(e,t,n,i){var s=jvm.$(r.container).offset(),o=e.pageX-s.left,u=e.pageY-s.top,a=Math.pow(1.3,i);r.label.hide(),r.setScale(r.scale*a,o,u),e.preventDefault()})},bindContainerTouchEvents:function(){var e,t,n=this,r,i,s,o,u,a=function(a){var f=a.originalEvent.touches,l,c,h,p;a.type=="touchstart"&&(u=0),f.length==1?(u==1&&(h=n.transX,p=n.transY,n.transX-=(r-f[0].pageX)/n.scale,n.transY-=(i-f[0].pageY)/n.scale,n.applyTransform(),n.label.hide(),(h!=n.transX||p!=n.transY)&&a.preventDefault()),r=f[0].pageX,i=f[0].pageY):f.length==2&&(u==2?(c=Math.sqrt(Math.pow(f[0].pageX-f[1].pageX,2)+Math.pow(f[0].pageY-f[1].pageY,2))/t,n.setScale(e*c,s,o),n.label.hide(),a.preventDefault()):(l=jvm.$(n.container).offset(),f[0].pageX>f[1].pageX?s=f[1].pageX+(f[0].pageX-f[1].pageX)/2:s=f[0].pageX+(f[1].pageX-f[0].pageX)/2,f[0].pageY>f[1].pageY?o=f[1].pageY+(f[0].pageY-f[1].pageY)/2:o=f[0].pageY+(f[1].pageY-f[0].pageY)/2,s-=l.left,o-=l.top,e=n.scale,t=Math.sqrt(Math.pow(f[0].pageX-f[1].pageX,2)+Math.pow(f[0].pageY-f[1].pageY,2)))),u=f.length};jvm.$(this.container).bind("touchstart",a),jvm.$(this.container).bind("touchmove",a)},bindElementEvents:function(){var e=this,t;this.container.mousemove(function(){t=!0}),this.container.delegate("[class~='jvectormap-element']","mouseover mouseout",function(t){var n=this,r=jvm.$(this).attr("class").baseVal?jvm.$(this).attr("class").baseVal:jvm.$(this).attr("class"),i=r.indexOf("jvectormap-region")===-1?"marker":"region",s=i=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),o=i=="region"?e.regions[s].element:e.markers[s].element,u=i=="region"?e.mapData.paths[s].name:e.markers[s].config.name||"",a=jvm.$.Event(i+"LabelShow.jvectormap"),f=jvm.$.Event(i+"Over.jvectormap");t.type=="mouseover"?(e.container.trigger(f,[s]),f.isDefaultPrevented()||o.setHovered(!0),e.label.text(u),e.container.trigger(a,[e.label,s]),a.isDefaultPrevented()||(e.label.show(),e.labelWidth=e.label.width(),e.labelHeight=e.label.height())):(o.setHovered(!1),e.label.hide(),e.container.trigger(i+"Out.jvectormap",[s]))}),this.container.delegate("[class~='jvectormap-element']","mousedown",function(e){t=!1}),this.container.delegate("[class~='jvectormap-element']","mouseup",function(n){var r=this,i=jvm.$(this).attr("class").baseVal?jvm.$(this).attr("class").baseVal:jvm.$(this).attr("class"),s=i.indexOf("jvectormap-region")===-1?"marker":"region",o=s=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),u=jvm.$.Event(s+"Click.jvectormap"),a=s=="region"?e.regions[o].element:e.markers[o].element;if(!t){e.container.trigger(u,[o]);if(s==="region"&&e.params.regionsSelectable||s==="marker"&&e.params.markersSelectable)u.isDefaultPrevented()||(e.params[s+"sSelectableOne"]&&e.clearSelected(s+"s"),a.setSelected(!a.isSelected))}})},bindZoomButtons:function(){var e=this;jvm.$("<div/>").addClass("jvectormap-zoomin").text("+").appendTo(this.container),jvm.$("<div/>").addClass("jvectormap-zoomout").html("&#x2212;").appendTo(this.container),this.container.find(".jvectormap-zoomin").click(function(){e.setScale(e.scale*e.params.zoomStep,e.width/2,e.height/2)}),this.container.find(".jvectormap-zoomout").click(function(){e.setScale(e.scale/e.params.zoomStep,e.width/2,e.height/2)})},createLabel:function(){var e=this;this.label=jvm.$("<div/>").addClass("jvectormap-label").appendTo(jvm.$("body")),this.container.mousemove(function(t){var n=t.pageX-15-e.labelWidth,r=t.pageY-15-e.labelHeight;n<5&&(n=t.pageX+15),r<5&&(r=t.pageY+15),e.label.is(":visible")&&e.label.css({left:n,top:r})})},setScale:function(e,t,n,r){var i,s=jvm.$.Event("zoom.jvectormap");e>this.params.zoomMax*this.baseScale?e=this.params.zoomMax*this.baseScale:e<this.params.zoomMin*this.baseScale&&(e=this.params.zoomMin*this.baseScale),typeof t!="undefined"&&typeof n!="undefined"&&(i=e/this.scale,r?(this.transX=t+this.defaultWidth*(this.width/(this.defaultWidth*e))/2,this.transY=n+this.defaultHeight*(this.height/(this.defaultHeight*e))/2):(this.transX-=(i-1)/e*t,this.transY-=(i-1)/e*n)),this.scale=e,this.applyTransform(),this.container.trigger(s,[e/this.baseScale])},setFocus:function(e,t,n){var r,i,s,o,u;if(jvm.$.isArray(e)||this.regions[e]){jvm.$.isArray(e)?o=e:o=[e];for(u=0;u<o.length;u++)this.regions[o[u]]&&(i=this.regions[o[u]].element.getBBox(),i&&(typeof r=="undefined"?r=i:(s={x:Math.min(r.x,i.x),y:Math.min(r.y,i.y),width:Math.max(r.x+r.width,i.x+i.width)-Math.min(r.x,i.x),height:Math.max(r.y+r.height,i.y+i.height)-Math.min(r.y,i.y)},r=s)));this.setScale(Math.min(this.width/r.width,this.height/r.height),-(r.x+r.width/2),-(r.y+r.height/2),!0)}else e*=this.baseScale,this.setScale(e,-t*this.defaultWidth,-n*this.defaultHeight,!0)},getSelected:function(e){var t,n=[];for(t in this[e])this[e][t].element.isSelected&&n.push(t);return n},getSelectedRegions:function(){return this.getSelected("regions")},getSelectedMarkers:function(){return this.getSelected("markers")},setSelected:function(e,t){var n;typeof t!="object"&&(t=[t]);if(jvm.$.isArray(t))for(n=0;n<t.length;n++)this[e][t[n]].element.setSelected(!0);else for(n in t)this[e][n].element.setSelected(!!t[n])},setSelectedRegions:function(e){this.setSelected("regions",e)},setSelectedMarkers:function(e){this.setSelected("markers",e)},clearSelected:function(e){var t={},n=this.getSelected(e),r;for(r=0;r<n.length;r++)t[n[r]]=!1;this.setSelected(e,t)},clearSelectedRegions:function(){this.clearSelected("regions")},clearSelectedMarkers:function(){this.clearSelected("markers")},getMapObject:function(){return this},getRegionName:function(e){return this.mapData.paths[e].name},createRegions:function(){var e,t,n=this;for(e in this.mapData.paths)t=this.canvas.addPath({d:this.mapData.paths[e].path,"data-code":e},jvm.$.extend(!0,{},this.params.regionStyle)),jvm.$(t.node).bind("selected",function(e,t){n.container.trigger("regionSelected.jvectormap",[jvm.$(this).attr("data-code"),t,n.getSelectedRegions()])}),t.addClass("jvectormap-region jvectormap-element"),this.regions[e]={element:t,config:this.mapData.paths[e]}},createMarkers:function(e){var t,n,r,i,s,o=this;this.markersGroup=this.markersGroup||this.canvas.addGroup();if(jvm.$.isArray(e)){s=e.slice(),e={};for(t=0;t<s.length;t++)e[t]=s[t]}for(t in e)i=e[t]instanceof Array?{latLng:e[t]}:e[t],r=this.getMarkerPosition(i),r!==!1&&(n=this.canvas.addCircle({"data-index":t,cx:r.x,cy:r.y},jvm.$.extend(!0,{},this.params.markerStyle,{initial:i.style||{}}),this.markersGroup),n.addClass("jvectormap-marker jvectormap-element"),jvm.$(n.node).bind("selected",function(e,t){o.container.trigger("markerSelected.jvectormap",[jvm.$(this).attr("data-index"),t,o.getSelectedMarkers()])}),this.markers[t]&&this.removeMarkers([t]),this.markers[t]={element:n,config:i})},repositionMarkers:function(){var e,t;for(e in this.markers)t=this.getMarkerPosition(this.markers[e].config),t!==!1&&this.markers[e].element.setStyle({cx:t.x,cy:t.y})},getMarkerPosition:function(e){return jvm.WorldMap.maps[this.params.map].projection?this.latLngToPoint.apply(this,e.latLng||[0,0]):{x:e.coords[0]*this.scale+this.transX*this.scale,y:e.coords[1]*this.scale+this.transY*this.scale}},addMarker:function(e,t,n){var r={},i=[],s,o,n=n||[];r[e]=t;for(o=0;o<n.length;o++)s={},s[e]=n[o],i.push(s);this.addMarkers(r,i)},addMarkers:function(e,t){var n;t=t||[],this.createMarkers(e);for(n=0;n<t.length;n++)this.series.markers[n].setValues(t[n]||{})},removeMarkers:function(e){var t;for(t=0;t<e.length;t++)this.markers[e[t]].element.remove(),delete this.markers[e[t]]},removeAllMarkers:function(){var e,t=[];for(e in this.markers)t.push(e);this.removeMarkers(t)},latLngToPoint:function(e,t){var n,r=jvm.WorldMap.maps[this.params.map].projection,i=r.centralMeridian,s=this.width-this.baseTransX*2*this.baseScale,o=this.height-this.baseTransY*2*this.baseScale,u,a,f=this.scale/this.baseScale;return t<-180+i&&(t+=360),n=jvm.Proj[r.type](e,t,i),u=this.getInsetForPoint(n.x,n.y),u?(a=u.bbox,n.x=(n.x-a[0].x)/(a[1].x-a[0].x)*u.width*this.scale,n.y=(n.y-a[0].y)/(a[1].y-a[0].y)*u.height*this.scale,{x:n.x+this.transX*this.scale+u.left*this.scale,y:n.y+this.transY*this.scale+u.top*this.scale}):!1},pointToLatLng:function(e,t){var n=jvm.WorldMap.maps[this.params.map].projection,r=n.centralMeridian,i=jvm.WorldMap.maps[this.params.map].insets,s,o,u,a,f;for(s=0;s<i.length;s++){o=i[s],u=o.bbox,a=e-(this.transX*this.scale+o.left*this.scale),f=t-(this.transY*this.scale+o.top*this.scale),a=a/(o.width*this.scale)*(u[1].x-u[0].x)+u[0].x,f=f/(o.height*this.scale)*(u[1].y-u[0].y)+u[0].y;if(a>u[0].x&&a<u[1].x&&f>u[0].y&&f<u[1].y)return jvm.Proj[n.type+"_inv"](a,-f,r)}return!1},getInsetForPoint:function(e,t){var n=jvm.WorldMap.maps[this.params.map].insets,r,i;for(r=0;r<n.length;r++){i=n[r].bbox;if(e>i[0].x&&e<i[1].x&&t>i[0].y&&t<i[1].y)return n[r]}},createSeries:function(){var e,t;this.series={markers:[],regions:[]};
for(t in this.params.series)for(e=0;e<this.params.series[t].length;e++)this.series[t][e]=new jvm.DataSeries(this.params.series[t][e],this[t])},remove:function(){this.label.remove(),this.container.remove(),jvm.$(window).unbind("resize",this.onResize)}},jvm.WorldMap.maps={},jvm.WorldMap.defaultParams={map:"world_mill_en",backgroundColor:"#505050",zoomButtons:!0,zoomOnScroll:!0,zoomMax:8,zoomMin:1,zoomStep:1.6,regionsSelectable:!1,markersSelectable:!1,bindTouchEvents:!0,regionStyle:{initial:{fill:"white","fill-opacity":1,stroke:"none","stroke-width":0,"stroke-opacity":1},hover:{"fill-opacity":.8},selected:{fill:"yellow"},selectedHover:{}},markerStyle:{initial:{fill:"grey",stroke:"#505050","fill-opacity":1,"stroke-width":1,"stroke-opacity":1,r:5},hover:{stroke:"black","stroke-width":2},selected:{fill:"blue"},selectedHover:{}}},jvm.WorldMap.apiEvents={onRegionLabelShow:"regionLabelShow",onRegionOver:"regionOver",onRegionOut:"regionOut",onRegionClick:"regionClick",onRegionSelected:"regionSelected",onMarkerLabelShow:"markerLabelShow",onMarkerOver:"markerOver",onMarkerOut:"markerOut",onMarkerClick:"markerClick",onMarkerSelected:"markerSelected",onViewportChange:"viewportChange"};(function($){$.color={};$.color.make=function(r,g,b,a){var o={};o.r=r||0;o.g=g||0;o.b=b||0;o.a=a!=null?a:1;o.add=function(c,d){for(var i=0;i<c.length;++i)o[c.charAt(i)]+=d;return o.normalize()};o.scale=function(c,f){for(var i=0;i<c.length;++i)o[c.charAt(i)]*=f;return o.normalize()};o.toString=function(){if(o.a>=1){return"rgb("+[o.r,o.g,o.b].join(",")+")"}else{return"rgba("+[o.r,o.g,o.b,o.a].join(",")+")"}};o.normalize=function(){function clamp(min,value,max){return value<min?min:value>max?max:value}o.r=clamp(0,parseInt(o.r),255);o.g=clamp(0,parseInt(o.g),255);o.b=clamp(0,parseInt(o.b),255);o.a=clamp(0,o.a,1);return o};o.clone=function(){return $.color.make(o.r,o.b,o.g,o.a)};return o.normalize()};$.color.extract=function(elem,css){var c;do{c=elem.css(css).toLowerCase();if(c!=""&&c!="transparent")break;elem=elem.parent()}while(elem.length&&!$.nodeName(elem.get(0),"body"));if(c=="rgba(0, 0, 0, 0)")c="transparent";return $.color.parse(c)};$.color.parse=function(str){var res,m=$.color.make;if(res=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(str))return m(parseInt(res[1],10),parseInt(res[2],10),parseInt(res[3],10));if(res=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str))return m(parseInt(res[1],10),parseInt(res[2],10),parseInt(res[3],10),parseFloat(res[4]));if(res=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(str))return m(parseFloat(res[1])*2.55,parseFloat(res[2])*2.55,parseFloat(res[3])*2.55);if(res=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str))return m(parseFloat(res[1])*2.55,parseFloat(res[2])*2.55,parseFloat(res[3])*2.55,parseFloat(res[4]));if(res=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(str))return m(parseInt(res[1],16),parseInt(res[2],16),parseInt(res[3],16));if(res=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(str))return m(parseInt(res[1]+res[1],16),parseInt(res[2]+res[2],16),parseInt(res[3]+res[3],16));var name=$.trim(str).toLowerCase();if(name=="transparent")return m(255,255,255,0);else{res=lookupColors[name]||[0,0,0];return m(res[0],res[1],res[2])}};var lookupColors={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]}})(jQuery);(function($){var hasOwnProperty=Object.prototype.hasOwnProperty;if(!$.fn.detach){$.fn.detach=function(){return this.each(function(){if(this.parentNode){this.parentNode.removeChild(this)}})}}function Canvas(cls,container){var element=container.children("."+cls)[0];if(element==null){element=document.createElement("canvas");element.className=cls;$(element).css({direction:"ltr",position:"absolute",left:0,top:0}).appendTo(container);if(!element.getContext){if(window.G_vmlCanvasManager){element=window.G_vmlCanvasManager.initElement(element)}else{throw new Error("Canvas is not available. If you're using IE with a fall-back such as Excanvas, then there's either a mistake in your conditional include, or the page has no DOCTYPE and is rendering in Quirks Mode.")}}}this.element=element;var context=this.context=element.getContext("2d");var devicePixelRatio=window.devicePixelRatio||1,backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;this.pixelRatio=devicePixelRatio/backingStoreRatio;this.resize(container.width(),container.height());this.textContainer=null;this.text={};this._textCache={}}Canvas.prototype.resize=function(width,height){if(width<=0||height<=0){throw new Error("Invalid dimensions for plot, width = "+width+", height = "+height)}var element=this.element,context=this.context,pixelRatio=this.pixelRatio;if(this.width!=width){element.width=width*pixelRatio;element.style.width=width+"px";this.width=width}if(this.height!=height){element.height=height*pixelRatio;element.style.height=height+"px";this.height=height}context.restore();context.save();context.scale(pixelRatio,pixelRatio)};Canvas.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)};Canvas.prototype.render=function(){var cache=this._textCache;for(var layerKey in cache){if(hasOwnProperty.call(cache,layerKey)){var layer=this.getTextLayer(layerKey),layerCache=cache[layerKey];layer.hide();for(var styleKey in layerCache){if(hasOwnProperty.call(layerCache,styleKey)){var styleCache=layerCache[styleKey];for(var key in styleCache){if(hasOwnProperty.call(styleCache,key)){var positions=styleCache[key].positions;for(var i=0,position;position=positions[i];i++){if(position.active){if(!position.rendered){layer.append(position.element);position.rendered=true}}else{positions.splice(i--,1);if(position.rendered){position.element.detach()}}}if(positions.length==0){delete styleCache[key]}}}}}layer.show()}}};Canvas.prototype.getTextLayer=function(classes){var layer=this.text[classes];if(layer==null){if(this.textContainer==null){this.textContainer=$("<div class='flot-text'></div>").css({position:"absolute",top:0,left:0,bottom:0,right:0,"font-size":"smaller",color:"#545454"}).insertAfter(this.element)}layer=this.text[classes]=$("<div></div>").addClass(classes).css({position:"absolute",top:0,left:0,bottom:0,right:0}).appendTo(this.textContainer)}return layer};Canvas.prototype.getTextInfo=function(layer,text,font,angle,width){var textStyle,layerCache,styleCache,info;text=""+text;if(typeof font==="object"){textStyle=font.style+" "+font.variant+" "+font.weight+" "+font.size+"px/"+font.lineHeight+"px "+font.family}else{textStyle=font}layerCache=this._textCache[layer];if(layerCache==null){layerCache=this._textCache[layer]={}}styleCache=layerCache[textStyle];if(styleCache==null){styleCache=layerCache[textStyle]={}}info=styleCache[text];if(info==null){var element=$("<div></div>").html(text).css({position:"absolute","max-width":width,top:-9999}).appendTo(this.getTextLayer(layer));if(typeof font==="object"){element.css({font:textStyle,color:font.color})}else if(typeof font==="string"){element.addClass(font)}info=styleCache[text]={width:element.outerWidth(true),height:element.outerHeight(true),element:element,positions:[]};element.detach()}return info};Canvas.prototype.addText=function(layer,x,y,text,font,angle,width,halign,valign){var info=this.getTextInfo(layer,text,font,angle,width),positions=info.positions;if(halign=="center"){x-=info.width/2}else if(halign=="right"){x-=info.width}if(valign=="middle"){y-=info.height/2}else if(valign=="bottom"){y-=info.height}for(var i=0,position;position=positions[i];i++){if(position.x==x&&position.y==y){position.active=true;return}}position={active:true,rendered:false,element:positions.length?info.element.clone():info.element,x:x,y:y};positions.push(position);position.element.css({top:Math.round(y),left:Math.round(x),"text-align":halign})};Canvas.prototype.removeText=function(layer,x,y,text,font,angle){if(text==null){var layerCache=this._textCache[layer];if(layerCache!=null){for(var styleKey in layerCache){if(hasOwnProperty.call(layerCache,styleKey)){var styleCache=layerCache[styleKey];for(var key in styleCache){if(hasOwnProperty.call(styleCache,key)){var positions=styleCache[key].positions;for(var i=0,position;position=positions[i];i++){position.active=false}}}}}}}else{var positions=this.getTextInfo(layer,text,font,angle).positions;for(var i=0,position;position=positions[i];i++){if(position.x==x&&position.y==y){position.active=false}}}};function Plot(placeholder,data_,options_,plugins){var series=[],options={colors:["#edc240","#afd8f8","#cb4b4b","#4da74d","#9440ed"],legend:{show:true,noColumns:1,labelFormatter:null,labelBoxBorderColor:"#ccc",container:null,position:"ne",margin:5,backgroundColor:null,backgroundOpacity:.85,sorted:null},xaxis:{show:null,position:"bottom",mode:null,font:null,color:null,tickColor:null,transform:null,inverseTransform:null,min:null,max:null,autoscaleMargin:null,ticks:null,tickFormatter:null,labelWidth:null,labelHeight:null,reserveSpace:null,tickLength:null,alignTicksWithAxis:null,tickDecimals:null,tickSize:null,minTickSize:null},yaxis:{autoscaleMargin:.02,position:"left"},xaxes:[],yaxes:[],series:{points:{show:false,radius:3,lineWidth:2,fill:true,fillColor:"#ffffff",symbol:"circle"},lines:{lineWidth:2,fill:false,fillColor:null,steps:false},bars:{show:false,lineWidth:2,barWidth:1,fill:true,fillColor:null,align:"left",horizontal:false,zero:true},shadowSize:3,highlightColor:null},grid:{show:true,aboveData:false,color:"#545454",backgroundColor:null,borderColor:null,tickColor:null,margin:0,labelMargin:5,axisMargin:8,borderWidth:2,minBorderMargin:null,markings:null,markingsColor:"#f4f4f4",markingsLineWidth:2,clickable:false,hoverable:false,autoHighlight:true,mouseActiveRadius:10},interaction:{redrawOverlayInterval:1e3/60},hooks:{}},surface=null,overlay=null,eventHolder=null,ctx=null,octx=null,xaxes=[],yaxes=[],plotOffset={left:0,right:0,top:0,bottom:0},plotWidth=0,plotHeight=0,hooks={processOptions:[],processRawData:[],processDatapoints:[],processOffset:[],drawBackground:[],drawSeries:[],draw:[],bindEvents:[],drawOverlay:[],shutdown:[]},plot=this;plot.setData=setData;plot.setupGrid=setupGrid;plot.draw=draw;plot.getPlaceholder=function(){return placeholder};plot.getCanvas=function(){return surface.element};plot.getPlotOffset=function(){return plotOffset};plot.width=function(){return plotWidth};plot.height=function(){return plotHeight};plot.offset=function(){var o=eventHolder.offset();o.left+=plotOffset.left;o.top+=plotOffset.top;return o};plot.getData=function(){return series};plot.getAxes=function(){var res={},i;$.each(xaxes.concat(yaxes),function(_,axis){if(axis)res[axis.direction+(axis.n!=1?axis.n:"")+"axis"]=axis});return res};plot.getXAxes=function(){return xaxes};plot.getYAxes=function(){return yaxes};plot.c2p=canvasToAxisCoords;plot.p2c=axisToCanvasCoords;plot.getOptions=function(){return options};plot.highlight=highlight;plot.unhighlight=unhighlight;plot.triggerRedrawOverlay=triggerRedrawOverlay;plot.pointOffset=function(point){return{left:parseInt(xaxes[axisNumber(point,"x")-1].p2c(+point.x)+plotOffset.left,10),top:parseInt(yaxes[axisNumber(point,"y")-1].p2c(+point.y)+plotOffset.top,10)}};plot.shutdown=shutdown;plot.destroy=function(){shutdown();placeholder.removeData("plot").empty();series=[];options=null;surface=null;overlay=null;eventHolder=null;ctx=null;octx=null;xaxes=[];yaxes=[];hooks=null;highlights=[];plot=null};plot.resize=function(){var width=placeholder.width(),height=placeholder.height();surface.resize(width,height);overlay.resize(width,height)};plot.hooks=hooks;initPlugins(plot);parseOptions(options_);setupCanvases();setData(data_);setupGrid();draw();bindEvents();function executeHooks(hook,args){args=[plot].concat(args);for(var i=0;i<hook.length;++i)hook[i].apply(this,args)}function initPlugins(){var classes={Canvas:Canvas};for(var i=0;i<plugins.length;++i){var p=plugins[i];p.init(plot,classes);if(p.options)$.extend(true,options,p.options)}}function parseOptions(opts){$.extend(true,options,opts);if(opts&&opts.colors){options.colors=opts.colors}if(options.xaxis.color==null)options.xaxis.color=$.color.parse(options.grid.color).scale("a",.22).toString();if(options.yaxis.color==null)options.yaxis.color=$.color.parse(options.grid.color).scale("a",.22).toString();if(options.xaxis.tickColor==null)options.xaxis.tickColor=options.grid.tickColor||options.xaxis.color;if(options.yaxis.tickColor==null)options.yaxis.tickColor=options.grid.tickColor||options.yaxis.color;if(options.grid.borderColor==null)options.grid.borderColor=options.grid.color;if(options.grid.tickColor==null)options.grid.tickColor=$.color.parse(options.grid.color).scale("a",.22).toString();var i,axisOptions,axisCount,fontSize=placeholder.css("font-size"),fontSizeDefault=fontSize?+fontSize.replace("px",""):13,fontDefaults={style:placeholder.css("font-style"),size:Math.round(.8*fontSizeDefault),variant:placeholder.css("font-variant"),weight:placeholder.css("font-weight"),family:placeholder.css("font-family")};axisCount=options.xaxes.length||1;for(i=0;i<axisCount;++i){axisOptions=options.xaxes[i];if(axisOptions&&!axisOptions.tickColor){axisOptions.tickColor=axisOptions.color}axisOptions=$.extend(true,{},options.xaxis,axisOptions);options.xaxes[i]=axisOptions;if(axisOptions.font){axisOptions.font=$.extend({},fontDefaults,axisOptions.font);if(!axisOptions.font.color){axisOptions.font.color=axisOptions.color}if(!axisOptions.font.lineHeight){axisOptions.font.lineHeight=Math.round(axisOptions.font.size*1.15)}}}axisCount=options.yaxes.length||1;for(i=0;i<axisCount;++i){axisOptions=options.yaxes[i];if(axisOptions&&!axisOptions.tickColor){axisOptions.tickColor=axisOptions.color}axisOptions=$.extend(true,{},options.yaxis,axisOptions);options.yaxes[i]=axisOptions;if(axisOptions.font){axisOptions.font=$.extend({},fontDefaults,axisOptions.font);if(!axisOptions.font.color){axisOptions.font.color=axisOptions.color}if(!axisOptions.font.lineHeight){axisOptions.font.lineHeight=Math.round(axisOptions.font.size*1.15)}}}if(options.xaxis.noTicks&&options.xaxis.ticks==null)options.xaxis.ticks=options.xaxis.noTicks;if(options.yaxis.noTicks&&options.yaxis.ticks==null)options.yaxis.ticks=options.yaxis.noTicks;if(options.x2axis){options.xaxes[1]=$.extend(true,{},options.xaxis,options.x2axis);options.xaxes[1].position="top";if(options.x2axis.min==null){options.xaxes[1].min=null}if(options.x2axis.max==null){options.xaxes[1].max=null}}if(options.y2axis){options.yaxes[1]=$.extend(true,{},options.yaxis,options.y2axis);options.yaxes[1].position="right";if(options.y2axis.min==null){options.yaxes[1].min=null}if(options.y2axis.max==null){options.yaxes[1].max=null}}if(options.grid.coloredAreas)options.grid.markings=options.grid.coloredAreas;if(options.grid.coloredAreasColor)options.grid.markingsColor=options.grid.coloredAreasColor;if(options.lines)$.extend(true,options.series.lines,options.lines);if(options.points)$.extend(true,options.series.points,options.points);if(options.bars)$.extend(true,options.series.bars,options.bars);if(options.shadowSize!=null)options.series.shadowSize=options.shadowSize;if(options.highlightColor!=null)options.series.highlightColor=options.highlightColor;for(i=0;i<options.xaxes.length;++i)getOrCreateAxis(xaxes,i+1).options=options.xaxes[i];for(i=0;i<options.yaxes.length;++i)getOrCreateAxis(yaxes,i+1).options=options.yaxes[i];for(var n in hooks)if(options.hooks[n]&&options.hooks[n].length)hooks[n]=hooks[n].concat(options.hooks[n]);executeHooks(hooks.processOptions,[options])}function setData(d){series=parseData(d);fillInSeriesOptions();processData()}function parseData(d){var res=[];for(var i=0;i<d.length;++i){var s=$.extend(true,{},options.series);if(d[i].data!=null){s.data=d[i].data;delete d[i].data;$.extend(true,s,d[i]);d[i].data=s.data}else s.data=d[i];res.push(s)}return res}function axisNumber(obj,coord){var a=obj[coord+"axis"];if(typeof a=="object")a=a.n;if(typeof a!="number")a=1;return a}function allAxes(){return $.grep(xaxes.concat(yaxes),function(a){return a})}function canvasToAxisCoords(pos){var res={},i,axis;for(i=0;i<xaxes.length;++i){axis=xaxes[i];if(axis&&axis.used)res["x"+axis.n]=axis.c2p(pos.left)}for(i=0;i<yaxes.length;++i){axis=yaxes[i];if(axis&&axis.used)res["y"+axis.n]=axis.c2p(pos.top)}if(res.x1!==undefined)res.x=res.x1;if(res.y1!==undefined)res.y=res.y1;return res}function axisToCanvasCoords(pos){var res={},i,axis,key;for(i=0;i<xaxes.length;++i){axis=xaxes[i];if(axis&&axis.used){key="x"+axis.n;if(pos[key]==null&&axis.n==1)key="x";if(pos[key]!=null){res.left=axis.p2c(pos[key]);break}}}for(i=0;i<yaxes.length;++i){axis=yaxes[i];if(axis&&axis.used){key="y"+axis.n;if(pos[key]==null&&axis.n==1)key="y";if(pos[key]!=null){res.top=axis.p2c(pos[key]);break}}}return res}function getOrCreateAxis(axes,number){if(!axes[number-1])axes[number-1]={n:number,direction:axes==xaxes?"x":"y",options:$.extend(true,{},axes==xaxes?options.xaxis:options.yaxis)};return axes[number-1]}function fillInSeriesOptions(){var neededColors=series.length,maxIndex=-1,i;for(i=0;i<series.length;++i){var sc=series[i].color;if(sc!=null){neededColors--;if(typeof sc=="number"&&sc>maxIndex){maxIndex=sc}}}if(neededColors<=maxIndex){neededColors=maxIndex+1}var c,colors=[],colorPool=options.colors,colorPoolSize=colorPool.length,variation=0;for(i=0;i<neededColors;i++){c=$.color.parse(colorPool[i%colorPoolSize]||"#666");if(i%colorPoolSize==0&&i){if(variation>=0){if(variation<.5){variation=-variation-.2}else variation=0}else variation=-variation}colors[i]=c.scale("rgb",1+variation)}var colori=0,s;for(i=0;i<series.length;++i){s=series[i];if(s.color==null){s.color=colors[colori].toString();++colori}else if(typeof s.color=="number")s.color=colors[s.color].toString();if(s.lines.show==null){var v,show=true;for(v in s)if(s[v]&&s[v].show){show=false;break}if(show)s.lines.show=true}if(s.lines.zero==null){s.lines.zero=!!s.lines.fill}s.xaxis=getOrCreateAxis(xaxes,axisNumber(s,"x"));s.yaxis=getOrCreateAxis(yaxes,axisNumber(s,"y"))}}function processData(){var topSentry=Number.POSITIVE_INFINITY,bottomSentry=Number.NEGATIVE_INFINITY,fakeInfinity=Number.MAX_VALUE,i,j,k,m,length,s,points,ps,x,y,axis,val,f,p,data,format;function updateAxis(axis,min,max){if(min<axis.datamin&&min!=-fakeInfinity)axis.datamin=min;if(max>axis.datamax&&max!=fakeInfinity)axis.datamax=max}$.each(allAxes(),function(_,axis){axis.datamin=topSentry;axis.datamax=bottomSentry;axis.used=false});for(i=0;i<series.length;++i){s=series[i];s.datapoints={points:[]};executeHooks(hooks.processRawData,[s,s.data,s.datapoints])}for(i=0;i<series.length;++i){s=series[i];data=s.data;format=s.datapoints.format;if(!format){format=[];format.push({x:true,number:true,required:true});format.push({y:true,number:true,required:true});if(s.bars.show||s.lines.show&&s.lines.fill){var autoscale=!!(s.bars.show&&s.bars.zero||s.lines.show&&s.lines.zero);format.push({y:true,number:true,required:false,defaultValue:0,autoscale:autoscale});if(s.bars.horizontal){delete format[format.length-1].y;format[format.length-1].x=true}}s.datapoints.format=format}if(s.datapoints.pointsize!=null)continue;s.datapoints.pointsize=format.length;ps=s.datapoints.pointsize;points=s.datapoints.points;var insertSteps=s.lines.show&&s.lines.steps;s.xaxis.used=s.yaxis.used=true;for(j=k=0;j<data.length;++j,k+=ps){p=data[j];var nullify=p==null;if(!nullify){for(m=0;m<ps;++m){val=p[m];f=format[m];if(f){if(f.number&&val!=null){val=+val;if(isNaN(val))val=null;else if(val==Infinity)val=fakeInfinity;else if(val==-Infinity)val=-fakeInfinity}if(val==null){if(f.required)nullify=true;if(f.defaultValue!=null)val=f.defaultValue}}points[k+m]=val}}if(nullify){for(m=0;m<ps;++m){val=points[k+m];if(val!=null){f=format[m];if(f.autoscale!==false){if(f.x){updateAxis(s.xaxis,val,val)}if(f.y){updateAxis(s.yaxis,val,val)}}}points[k+m]=null}}else{if(insertSteps&&k>0&&points[k-ps]!=null&&points[k-ps]!=points[k]&&points[k-ps+1]!=points[k+1]){for(m=0;m<ps;++m)points[k+ps+m]=points[k+m];points[k+1]=points[k-ps+1];k+=ps}}}}for(i=0;i<series.length;++i){s=series[i];executeHooks(hooks.processDatapoints,[s,s.datapoints])}for(i=0;i<series.length;++i){s=series[i];points=s.datapoints.points;ps=s.datapoints.pointsize;format=s.datapoints.format;var xmin=topSentry,ymin=topSentry,xmax=bottomSentry,ymax=bottomSentry;for(j=0;j<points.length;j+=ps){if(points[j]==null)continue;for(m=0;m<ps;++m){val=points[j+m];f=format[m];if(!f||f.autoscale===false||val==fakeInfinity||val==-fakeInfinity)continue;if(f.x){if(val<xmin)xmin=val;if(val>xmax)xmax=val}if(f.y){if(val<ymin)ymin=val;if(val>ymax)ymax=val}}}if(s.bars.show){var delta;switch(s.bars.align){case"left":delta=0;break;case"right":delta=-s.bars.barWidth;break;default:delta=-s.bars.barWidth/2}if(s.bars.horizontal){ymin+=delta;ymax+=delta+s.bars.barWidth}else{xmin+=delta;xmax+=delta+s.bars.barWidth}}updateAxis(s.xaxis,xmin,xmax);updateAxis(s.yaxis,ymin,ymax)}$.each(allAxes(),function(_,axis){if(axis.datamin==topSentry)axis.datamin=null;if(axis.datamax==bottomSentry)axis.datamax=null})}function setupCanvases(){placeholder.css("padding",0).children().filter(function(){return!$(this).hasClass("flot-overlay")&&!$(this).hasClass("flot-base")}).remove();if(placeholder.css("position")=="static")placeholder.css("position","relative");surface=new Canvas("flot-base",placeholder);overlay=new Canvas("flot-overlay",placeholder);ctx=surface.context;octx=overlay.context;eventHolder=$(overlay.element).unbind();var existing=placeholder.data("plot");if(existing){existing.shutdown();overlay.clear()}placeholder.data("plot",plot)}function bindEvents(){if(options.grid.hoverable){eventHolder.mousemove(onMouseMove);eventHolder.bind("mouseleave",onMouseLeave)}if(options.grid.clickable)eventHolder.click(onClick);executeHooks(hooks.bindEvents,[eventHolder])}function shutdown(){if(redrawTimeout)clearTimeout(redrawTimeout);eventHolder.unbind("mousemove",onMouseMove);eventHolder.unbind("mouseleave",onMouseLeave);eventHolder.unbind("click",onClick);executeHooks(hooks.shutdown,[eventHolder])}function setTransformationHelpers(axis){function identity(x){return x}var s,m,t=axis.options.transform||identity,it=axis.options.inverseTransform;if(axis.direction=="x"){s=axis.scale=plotWidth/Math.abs(t(axis.max)-t(axis.min));m=Math.min(t(axis.max),t(axis.min))}else{s=axis.scale=plotHeight/Math.abs(t(axis.max)-t(axis.min));s=-s;m=Math.max(t(axis.max),t(axis.min))}if(t==identity)axis.p2c=function(p){return(p-m)*s};else axis.p2c=function(p){return(t(p)-m)*s};if(!it)axis.c2p=function(c){return m+c/s};else axis.c2p=function(c){return it(m+c/s)}}function measureTickLabels(axis){var opts=axis.options,ticks=axis.ticks||[],labelWidth=opts.labelWidth||0,labelHeight=opts.labelHeight||0,maxWidth=labelWidth||(axis.direction=="x"?Math.floor(surface.width/(ticks.length||1)):null),legacyStyles=axis.direction+"Axis "+axis.direction+axis.n+"Axis",layer="flot-"+axis.direction+"-axis flot-"+axis.direction+axis.n+"-axis "+legacyStyles,font=opts.font||"flot-tick-label tickLabel";for(var i=0;i<ticks.length;++i){var t=ticks[i];if(!t.label)continue;var info=surface.getTextInfo(layer,t.label,font,null,maxWidth);labelWidth=Math.max(labelWidth,info.width);labelHeight=Math.max(labelHeight,info.height)}axis.labelWidth=opts.labelWidth||labelWidth;axis.labelHeight=opts.labelHeight||labelHeight}function allocateAxisBoxFirstPhase(axis){var lw=axis.labelWidth,lh=axis.labelHeight,pos=axis.options.position,isXAxis=axis.direction==="x",tickLength=axis.options.tickLength,axisMargin=options.grid.axisMargin,padding=options.grid.labelMargin,innermost=true,outermost=true,first=true,found=false;$.each(isXAxis?xaxes:yaxes,function(i,a){if(a&&(a.show||a.reserveSpace)){if(a===axis){found=true}else if(a.options.position===pos){if(found){outermost=false}else{innermost=false}}if(!found){first=false}}});if(outermost){axisMargin=0}if(tickLength==null){tickLength=first?"full":5}if(!isNaN(+tickLength))padding+=+tickLength;if(isXAxis){lh+=padding;if(pos=="bottom"){plotOffset.bottom+=lh+axisMargin;axis.box={top:surface.height-plotOffset.bottom,height:lh}}else{axis.box={top:plotOffset.top+axisMargin,height:lh};plotOffset.top+=lh+axisMargin}}else{lw+=padding;if(pos=="left"){axis.box={left:plotOffset.left+axisMargin,width:lw};plotOffset.left+=lw+axisMargin}else{plotOffset.right+=lw+axisMargin;axis.box={left:surface.width-plotOffset.right,width:lw}}}axis.position=pos;axis.tickLength=tickLength;axis.box.padding=padding;axis.innermost=innermost}function allocateAxisBoxSecondPhase(axis){if(axis.direction=="x"){axis.box.left=plotOffset.left-axis.labelWidth/2;axis.box.width=surface.width-plotOffset.left-plotOffset.right+axis.labelWidth}else{axis.box.top=plotOffset.top-axis.labelHeight/2;axis.box.height=surface.height-plotOffset.bottom-plotOffset.top+axis.labelHeight}}function adjustLayoutForThingsStickingOut(){var minMargin=options.grid.minBorderMargin,axis,i;if(minMargin==null){minMargin=0;for(i=0;i<series.length;++i)minMargin=Math.max(minMargin,2*(series[i].points.radius+series[i].points.lineWidth/2))}var margins={left:minMargin,right:minMargin,top:minMargin,bottom:minMargin};$.each(allAxes(),function(_,axis){if(axis.reserveSpace&&axis.ticks&&axis.ticks.length){if(axis.direction==="x"){margins.left=Math.max(margins.left,axis.labelWidth/2);margins.right=Math.max(margins.right,axis.labelWidth/2)}else{margins.bottom=Math.max(margins.bottom,axis.labelHeight/2);margins.top=Math.max(margins.top,axis.labelHeight/2)}}});plotOffset.left=Math.ceil(Math.max(margins.left,plotOffset.left));plotOffset.right=Math.ceil(Math.max(margins.right,plotOffset.right));plotOffset.top=Math.ceil(Math.max(margins.top,plotOffset.top));plotOffset.bottom=Math.ceil(Math.max(margins.bottom,plotOffset.bottom))}function setupGrid(){var i,axes=allAxes(),showGrid=options.grid.show;for(var a in plotOffset){var margin=options.grid.margin||0;plotOffset[a]=typeof margin=="number"?margin:margin[a]||0}executeHooks(hooks.processOffset,[plotOffset]);for(var a in plotOffset){if(typeof options.grid.borderWidth=="object"){plotOffset[a]+=showGrid?options.grid.borderWidth[a]:0}else{plotOffset[a]+=showGrid?options.grid.borderWidth:0}}$.each(axes,function(_,axis){var axisOpts=axis.options;axis.show=axisOpts.show==null?axis.used:axisOpts.show;axis.reserveSpace=axisOpts.reserveSpace==null?axis.show:axisOpts.reserveSpace;setRange(axis)});if(showGrid){var allocatedAxes=$.grep(axes,function(axis){return axis.show||axis.reserveSpace});$.each(allocatedAxes,function(_,axis){setupTickGeneration(axis);setTicks(axis);snapRangeToTicks(axis,axis.ticks);measureTickLabels(axis)});for(i=allocatedAxes.length-1;i>=0;--i)allocateAxisBoxFirstPhase(allocatedAxes[i]);adjustLayoutForThingsStickingOut();$.each(allocatedAxes,function(_,axis){allocateAxisBoxSecondPhase(axis)})}plotWidth=surface.width-plotOffset.left-plotOffset.right;plotHeight=surface.height-plotOffset.bottom-plotOffset.top;$.each(axes,function(_,axis){setTransformationHelpers(axis)});if(showGrid){drawAxisLabels()}insertLegend()}function setRange(axis){var opts=axis.options,min=+(opts.min!=null?opts.min:axis.datamin),max=+(opts.max!=null?opts.max:axis.datamax),delta=max-min;if(delta==0){var widen=max==0?1:.01;if(opts.min==null)min-=widen;if(opts.max==null||opts.min!=null)max+=widen}else{var margin=opts.autoscaleMargin;if(margin!=null){if(opts.min==null){min-=delta*margin;if(min<0&&axis.datamin!=null&&axis.datamin>=0)min=0}if(opts.max==null){max+=delta*margin;if(max>0&&axis.datamax!=null&&axis.datamax<=0)max=0}}}axis.min=min;axis.max=max}function setupTickGeneration(axis){var opts=axis.options;var noTicks;if(typeof opts.ticks=="number"&&opts.ticks>0)noTicks=opts.ticks;else noTicks=.3*Math.sqrt(axis.direction=="x"?surface.width:surface.height);var delta=(axis.max-axis.min)/noTicks,dec=-Math.floor(Math.log(delta)/Math.LN10),maxDec=opts.tickDecimals;if(maxDec!=null&&dec>maxDec){dec=maxDec}var magn=Math.pow(10,-dec),norm=delta/magn,size;if(norm<1.5){size=1}else if(norm<3){size=2;if(norm>2.25&&(maxDec==null||dec+1<=maxDec)){size=2.5;++dec}}else if(norm<7.5){size=5}else{size=10}size*=magn;if(opts.minTickSize!=null&&size<opts.minTickSize){size=opts.minTickSize}axis.delta=delta;axis.tickDecimals=Math.max(0,maxDec!=null?maxDec:dec);axis.tickSize=opts.tickSize||size;if(opts.mode=="time"&&!axis.tickGenerator){throw new Error("Time mode requires the flot.time plugin.")}if(!axis.tickGenerator){axis.tickGenerator=function(axis){var ticks=[],start=floorInBase(axis.min,axis.tickSize),i=0,v=Number.NaN,prev;do{prev=v;v=start+i*axis.tickSize;ticks.push(v);++i}while(v<axis.max&&v!=prev);return ticks};axis.tickFormatter=function(value,axis){var factor=axis.tickDecimals?Math.pow(10,axis.tickDecimals):1;var formatted=""+Math.round(value*factor)/factor;if(axis.tickDecimals!=null){var decimal=formatted.indexOf(".");var precision=decimal==-1?0:formatted.length-decimal-1;if(precision<axis.tickDecimals){return(precision?formatted:formatted+".")+(""+factor).substr(1,axis.tickDecimals-precision)}}return formatted}}if($.isFunction(opts.tickFormatter))axis.tickFormatter=function(v,axis){return""+opts.tickFormatter(v,axis)};if(opts.alignTicksWithAxis!=null){var otherAxis=(axis.direction=="x"?xaxes:yaxes)[opts.alignTicksWithAxis-1];if(otherAxis&&otherAxis.used&&otherAxis!=axis){var niceTicks=axis.tickGenerator(axis);if(niceTicks.length>0){if(opts.min==null)axis.min=Math.min(axis.min,niceTicks[0]);if(opts.max==null&&niceTicks.length>1)axis.max=Math.max(axis.max,niceTicks[niceTicks.length-1])}axis.tickGenerator=function(axis){var ticks=[],v,i;for(i=0;i<otherAxis.ticks.length;++i){v=(otherAxis.ticks[i].v-otherAxis.min)/(otherAxis.max-otherAxis.min);v=axis.min+v*(axis.max-axis.min);ticks.push(v)}return ticks};if(!axis.mode&&opts.tickDecimals==null){var extraDec=Math.max(0,-Math.floor(Math.log(axis.delta)/Math.LN10)+1),ts=axis.tickGenerator(axis);if(!(ts.length>1&&/\..*0$/.test((ts[1]-ts[0]).toFixed(extraDec))))axis.tickDecimals=extraDec}}}}function setTicks(axis){var oticks=axis.options.ticks,ticks=[];if(oticks==null||typeof oticks=="number"&&oticks>0)ticks=axis.tickGenerator(axis);else if(oticks){if($.isFunction(oticks))ticks=oticks(axis);else ticks=oticks}var i,v;axis.ticks=[];for(i=0;i<ticks.length;++i){var label=null;var t=ticks[i];if(typeof t=="object"){v=+t[0];if(t.length>1)label=t[1]}else v=+t;if(label==null)label=axis.tickFormatter(v,axis);if(!isNaN(v))axis.ticks.push({v:v,label:label})}}function snapRangeToTicks(axis,ticks){if(axis.options.autoscaleMargin&&ticks.length>0){if(axis.options.min==null)axis.min=Math.min(axis.min,ticks[0].v);if(axis.options.max==null&&ticks.length>1)axis.max=Math.max(axis.max,ticks[ticks.length-1].v)}}function draw(){surface.clear();executeHooks(hooks.drawBackground,[ctx]);var grid=options.grid;if(grid.show&&grid.backgroundColor)drawBackground();if(grid.show&&!grid.aboveData){drawGrid()}for(var i=0;i<series.length;++i){executeHooks(hooks.drawSeries,[ctx,series[i]]);drawSeries(series[i])}executeHooks(hooks.draw,[ctx]);if(grid.show&&grid.aboveData){drawGrid()}surface.render();triggerRedrawOverlay()
}function extractRange(ranges,coord){var axis,from,to,key,axes=allAxes();for(var i=0;i<axes.length;++i){axis=axes[i];if(axis.direction==coord){key=coord+axis.n+"axis";if(!ranges[key]&&axis.n==1)key=coord+"axis";if(ranges[key]){from=ranges[key].from;to=ranges[key].to;break}}}if(!ranges[key]){axis=coord=="x"?xaxes[0]:yaxes[0];from=ranges[coord+"1"];to=ranges[coord+"2"]}if(from!=null&&to!=null&&from>to){var tmp=from;from=to;to=tmp}return{from:from,to:to,axis:axis}}function drawBackground(){ctx.save();ctx.translate(plotOffset.left,plotOffset.top);ctx.fillStyle=getColorOrGradient(options.grid.backgroundColor,plotHeight,0,"rgba(255, 255, 255, 0)");ctx.fillRect(0,0,plotWidth,plotHeight);ctx.restore()}function drawGrid(){var i,axes,bw,bc;ctx.save();ctx.translate(plotOffset.left,plotOffset.top);var markings=options.grid.markings;if(markings){if($.isFunction(markings)){axes=plot.getAxes();axes.xmin=axes.xaxis.min;axes.xmax=axes.xaxis.max;axes.ymin=axes.yaxis.min;axes.ymax=axes.yaxis.max;markings=markings(axes)}for(i=0;i<markings.length;++i){var m=markings[i],xrange=extractRange(m,"x"),yrange=extractRange(m,"y");if(xrange.from==null)xrange.from=xrange.axis.min;if(xrange.to==null)xrange.to=xrange.axis.max;if(yrange.from==null)yrange.from=yrange.axis.min;if(yrange.to==null)yrange.to=yrange.axis.max;if(xrange.to<xrange.axis.min||xrange.from>xrange.axis.max||yrange.to<yrange.axis.min||yrange.from>yrange.axis.max)continue;xrange.from=Math.max(xrange.from,xrange.axis.min);xrange.to=Math.min(xrange.to,xrange.axis.max);yrange.from=Math.max(yrange.from,yrange.axis.min);yrange.to=Math.min(yrange.to,yrange.axis.max);var xequal=xrange.from===xrange.to,yequal=yrange.from===yrange.to;if(xequal&&yequal){continue}xrange.from=Math.floor(xrange.axis.p2c(xrange.from));xrange.to=Math.floor(xrange.axis.p2c(xrange.to));yrange.from=Math.floor(yrange.axis.p2c(yrange.from));yrange.to=Math.floor(yrange.axis.p2c(yrange.to));if(xequal||yequal){var lineWidth=m.lineWidth||options.grid.markingsLineWidth,subPixel=lineWidth%2?.5:0;ctx.beginPath();ctx.strokeStyle=m.color||options.grid.markingsColor;ctx.lineWidth=lineWidth;if(xequal){ctx.moveTo(xrange.to+subPixel,yrange.from);ctx.lineTo(xrange.to+subPixel,yrange.to)}else{ctx.moveTo(xrange.from,yrange.to+subPixel);ctx.lineTo(xrange.to,yrange.to+subPixel)}ctx.stroke()}else{ctx.fillStyle=m.color||options.grid.markingsColor;ctx.fillRect(xrange.from,yrange.to,xrange.to-xrange.from,yrange.from-yrange.to)}}}axes=allAxes();bw=options.grid.borderWidth;for(var j=0;j<axes.length;++j){var axis=axes[j],box=axis.box,t=axis.tickLength,x,y,xoff,yoff;if(!axis.show||axis.ticks.length==0)continue;ctx.lineWidth=1;if(axis.direction=="x"){x=0;if(t=="full")y=axis.position=="top"?0:plotHeight;else y=box.top-plotOffset.top+(axis.position=="top"?box.height:0)}else{y=0;if(t=="full")x=axis.position=="left"?0:plotWidth;else x=box.left-plotOffset.left+(axis.position=="left"?box.width:0)}if(!axis.innermost){ctx.strokeStyle=axis.options.color;ctx.beginPath();xoff=yoff=0;if(axis.direction=="x")xoff=plotWidth+1;else yoff=plotHeight+1;if(ctx.lineWidth==1){if(axis.direction=="x"){y=Math.floor(y)+.5}else{x=Math.floor(x)+.5}}ctx.moveTo(x,y);ctx.lineTo(x+xoff,y+yoff);ctx.stroke()}ctx.strokeStyle=axis.options.tickColor;ctx.beginPath();for(i=0;i<axis.ticks.length;++i){var v=axis.ticks[i].v;xoff=yoff=0;if(isNaN(v)||v<axis.min||v>axis.max||t=="full"&&(typeof bw=="object"&&bw[axis.position]>0||bw>0)&&(v==axis.min||v==axis.max))continue;if(axis.direction=="x"){x=axis.p2c(v);yoff=t=="full"?-plotHeight:t;if(axis.position=="top")yoff=-yoff}else{y=axis.p2c(v);xoff=t=="full"?-plotWidth:t;if(axis.position=="left")xoff=-xoff}if(ctx.lineWidth==1){if(axis.direction=="x")x=Math.floor(x)+.5;else y=Math.floor(y)+.5}ctx.moveTo(x,y);ctx.lineTo(x+xoff,y+yoff)}ctx.stroke()}if(bw){bc=options.grid.borderColor;if(typeof bw=="object"||typeof bc=="object"){if(typeof bw!=="object"){bw={top:bw,right:bw,bottom:bw,left:bw}}if(typeof bc!=="object"){bc={top:bc,right:bc,bottom:bc,left:bc}}if(bw.top>0){ctx.strokeStyle=bc.top;ctx.lineWidth=bw.top;ctx.beginPath();ctx.moveTo(0-bw.left,0-bw.top/2);ctx.lineTo(plotWidth,0-bw.top/2);ctx.stroke()}if(bw.right>0){ctx.strokeStyle=bc.right;ctx.lineWidth=bw.right;ctx.beginPath();ctx.moveTo(plotWidth+bw.right/2,0-bw.top);ctx.lineTo(plotWidth+bw.right/2,plotHeight);ctx.stroke()}if(bw.bottom>0){ctx.strokeStyle=bc.bottom;ctx.lineWidth=bw.bottom;ctx.beginPath();ctx.moveTo(plotWidth+bw.right,plotHeight+bw.bottom/2);ctx.lineTo(0,plotHeight+bw.bottom/2);ctx.stroke()}if(bw.left>0){ctx.strokeStyle=bc.left;ctx.lineWidth=bw.left;ctx.beginPath();ctx.moveTo(0-bw.left/2,plotHeight+bw.bottom);ctx.lineTo(0-bw.left/2,0);ctx.stroke()}}else{ctx.lineWidth=bw;ctx.strokeStyle=options.grid.borderColor;ctx.strokeRect(-bw/2,-bw/2,plotWidth+bw,plotHeight+bw)}}ctx.restore()}function drawAxisLabels(){$.each(allAxes(),function(_,axis){var box=axis.box,legacyStyles=axis.direction+"Axis "+axis.direction+axis.n+"Axis",layer="flot-"+axis.direction+"-axis flot-"+axis.direction+axis.n+"-axis "+legacyStyles,font=axis.options.font||"flot-tick-label tickLabel",tick,x,y,halign,valign;surface.removeText(layer);if(!axis.show||axis.ticks.length==0)return;for(var i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.v<axis.min||tick.v>axis.max)continue;if(axis.direction=="x"){halign="center";x=plotOffset.left+axis.p2c(tick.v);if(axis.position=="bottom"){y=box.top+box.padding}else{y=box.top+box.height-box.padding;valign="bottom"}}else{valign="middle";y=plotOffset.top+axis.p2c(tick.v);if(axis.position=="left"){x=box.left+box.width-box.padding;halign="right"}else{x=box.left+box.padding}}surface.addText(layer,x,y,tick.label,font,null,null,halign,valign)}})}function drawSeries(series){if(series.lines.show)drawSeriesLines(series);if(series.bars.show)drawSeriesBars(series);if(series.points.show)drawSeriesPoints(series)}function drawSeriesLines(series){function plotLine(datapoints,xoffset,yoffset,axisx,axisy){var points=datapoints.points,ps=datapoints.pointsize,prevx=null,prevy=null;ctx.beginPath();for(var i=ps;i<points.length;i+=ps){var x1=points[i-ps],y1=points[i-ps+1],x2=points[i],y2=points[i+1];if(x1==null||x2==null)continue;if(y1<=y2&&y1<axisy.min){if(y2<axisy.min)continue;x1=(axisy.min-y1)/(y2-y1)*(x2-x1)+x1;y1=axisy.min}else if(y2<=y1&&y2<axisy.min){if(y1<axisy.min)continue;x2=(axisy.min-y1)/(y2-y1)*(x2-x1)+x1;y2=axisy.min}if(y1>=y2&&y1>axisy.max){if(y2>axisy.max)continue;x1=(axisy.max-y1)/(y2-y1)*(x2-x1)+x1;y1=axisy.max}else if(y2>=y1&&y2>axisy.max){if(y1>axisy.max)continue;x2=(axisy.max-y1)/(y2-y1)*(x2-x1)+x1;y2=axisy.max}if(x1<=x2&&x1<axisx.min){if(x2<axisx.min)continue;y1=(axisx.min-x1)/(x2-x1)*(y2-y1)+y1;x1=axisx.min}else if(x2<=x1&&x2<axisx.min){if(x1<axisx.min)continue;y2=(axisx.min-x1)/(x2-x1)*(y2-y1)+y1;x2=axisx.min}if(x1>=x2&&x1>axisx.max){if(x2>axisx.max)continue;y1=(axisx.max-x1)/(x2-x1)*(y2-y1)+y1;x1=axisx.max}else if(x2>=x1&&x2>axisx.max){if(x1>axisx.max)continue;y2=(axisx.max-x1)/(x2-x1)*(y2-y1)+y1;x2=axisx.max}if(x1!=prevx||y1!=prevy)ctx.moveTo(axisx.p2c(x1)+xoffset,axisy.p2c(y1)+yoffset);prevx=x2;prevy=y2;ctx.lineTo(axisx.p2c(x2)+xoffset,axisy.p2c(y2)+yoffset)}ctx.stroke()}function plotLineArea(datapoints,axisx,axisy){var points=datapoints.points,ps=datapoints.pointsize,bottom=Math.min(Math.max(0,axisy.min),axisy.max),i=0,top,areaOpen=false,ypos=1,segmentStart=0,segmentEnd=0;while(true){if(ps>0&&i>points.length+ps)break;i+=ps;var x1=points[i-ps],y1=points[i-ps+ypos],x2=points[i],y2=points[i+ypos];if(areaOpen){if(ps>0&&x1!=null&&x2==null){segmentEnd=i;ps=-ps;ypos=2;continue}if(ps<0&&i==segmentStart+ps){ctx.fill();areaOpen=false;ps=-ps;ypos=1;i=segmentStart=segmentEnd+ps;continue}}if(x1==null||x2==null)continue;if(x1<=x2&&x1<axisx.min){if(x2<axisx.min)continue;y1=(axisx.min-x1)/(x2-x1)*(y2-y1)+y1;x1=axisx.min}else if(x2<=x1&&x2<axisx.min){if(x1<axisx.min)continue;y2=(axisx.min-x1)/(x2-x1)*(y2-y1)+y1;x2=axisx.min}if(x1>=x2&&x1>axisx.max){if(x2>axisx.max)continue;y1=(axisx.max-x1)/(x2-x1)*(y2-y1)+y1;x1=axisx.max}else if(x2>=x1&&x2>axisx.max){if(x1>axisx.max)continue;y2=(axisx.max-x1)/(x2-x1)*(y2-y1)+y1;x2=axisx.max}if(!areaOpen){ctx.beginPath();ctx.moveTo(axisx.p2c(x1),axisy.p2c(bottom));areaOpen=true}if(y1>=axisy.max&&y2>=axisy.max){ctx.lineTo(axisx.p2c(x1),axisy.p2c(axisy.max));ctx.lineTo(axisx.p2c(x2),axisy.p2c(axisy.max));continue}else if(y1<=axisy.min&&y2<=axisy.min){ctx.lineTo(axisx.p2c(x1),axisy.p2c(axisy.min));ctx.lineTo(axisx.p2c(x2),axisy.p2c(axisy.min));continue}var x1old=x1,x2old=x2;if(y1<=y2&&y1<axisy.min&&y2>=axisy.min){x1=(axisy.min-y1)/(y2-y1)*(x2-x1)+x1;y1=axisy.min}else if(y2<=y1&&y2<axisy.min&&y1>=axisy.min){x2=(axisy.min-y1)/(y2-y1)*(x2-x1)+x1;y2=axisy.min}if(y1>=y2&&y1>axisy.max&&y2<=axisy.max){x1=(axisy.max-y1)/(y2-y1)*(x2-x1)+x1;y1=axisy.max}else if(y2>=y1&&y2>axisy.max&&y1<=axisy.max){x2=(axisy.max-y1)/(y2-y1)*(x2-x1)+x1;y2=axisy.max}if(x1!=x1old){ctx.lineTo(axisx.p2c(x1old),axisy.p2c(y1))}ctx.lineTo(axisx.p2c(x1),axisy.p2c(y1));ctx.lineTo(axisx.p2c(x2),axisy.p2c(y2));if(x2!=x2old){ctx.lineTo(axisx.p2c(x2),axisy.p2c(y2));ctx.lineTo(axisx.p2c(x2old),axisy.p2c(y2))}}}ctx.save();ctx.translate(plotOffset.left,plotOffset.top);ctx.lineJoin="round";var lw=series.lines.lineWidth,sw=series.shadowSize;if(lw>0&&sw>0){ctx.lineWidth=sw;ctx.strokeStyle="rgba(0,0,0,0.1)";var angle=Math.PI/18;plotLine(series.datapoints,Math.sin(angle)*(lw/2+sw/2),Math.cos(angle)*(lw/2+sw/2),series.xaxis,series.yaxis);ctx.lineWidth=sw/2;plotLine(series.datapoints,Math.sin(angle)*(lw/2+sw/4),Math.cos(angle)*(lw/2+sw/4),series.xaxis,series.yaxis)}ctx.lineWidth=lw;ctx.strokeStyle=series.color;var fillStyle=getFillStyle(series.lines,series.color,0,plotHeight);if(fillStyle){ctx.fillStyle=fillStyle;plotLineArea(series.datapoints,series.xaxis,series.yaxis)}if(lw>0)plotLine(series.datapoints,0,0,series.xaxis,series.yaxis);ctx.restore()}function drawSeriesPoints(series){function plotPoints(datapoints,radius,fillStyle,offset,shadow,axisx,axisy,symbol){var points=datapoints.points,ps=datapoints.pointsize;for(var i=0;i<points.length;i+=ps){var x=points[i],y=points[i+1];if(x==null||x<axisx.min||x>axisx.max||y<axisy.min||y>axisy.max)continue;ctx.beginPath();x=axisx.p2c(x);y=axisy.p2c(y)+offset;if(symbol=="circle")ctx.arc(x,y,radius,0,shadow?Math.PI:Math.PI*2,false);else symbol(ctx,x,y,radius,shadow);ctx.closePath();if(fillStyle){ctx.fillStyle=fillStyle;ctx.fill()}ctx.stroke()}}ctx.save();ctx.translate(plotOffset.left,plotOffset.top);var lw=series.points.lineWidth,sw=series.shadowSize,radius=series.points.radius,symbol=series.points.symbol;if(lw==0)lw=1e-4;if(lw>0&&sw>0){var w=sw/2;ctx.lineWidth=w;ctx.strokeStyle="rgba(0,0,0,0.1)";plotPoints(series.datapoints,radius,null,w+w/2,true,series.xaxis,series.yaxis,symbol);ctx.strokeStyle="rgba(0,0,0,0.2)";plotPoints(series.datapoints,radius,null,w/2,true,series.xaxis,series.yaxis,symbol)}ctx.lineWidth=lw;ctx.strokeStyle=series.color;plotPoints(series.datapoints,radius,getFillStyle(series.points,series.color),0,false,series.xaxis,series.yaxis,symbol);ctx.restore()}function drawBar(x,y,b,barLeft,barRight,fillStyleCallback,axisx,axisy,c,horizontal,lineWidth){var left,right,bottom,top,drawLeft,drawRight,drawTop,drawBottom,tmp;if(horizontal){drawBottom=drawRight=drawTop=true;drawLeft=false;left=b;right=x;top=y+barLeft;bottom=y+barRight;if(right<left){tmp=right;right=left;left=tmp;drawLeft=true;drawRight=false}}else{drawLeft=drawRight=drawTop=true;drawBottom=false;left=x+barLeft;right=x+barRight;bottom=b;top=y;if(top<bottom){tmp=top;top=bottom;bottom=tmp;drawBottom=true;drawTop=false}}if(right<axisx.min||left>axisx.max||top<axisy.min||bottom>axisy.max)return;if(left<axisx.min){left=axisx.min;drawLeft=false}if(right>axisx.max){right=axisx.max;drawRight=false}if(bottom<axisy.min){bottom=axisy.min;drawBottom=false}if(top>axisy.max){top=axisy.max;drawTop=false}left=axisx.p2c(left);bottom=axisy.p2c(bottom);right=axisx.p2c(right);top=axisy.p2c(top);if(fillStyleCallback){c.fillStyle=fillStyleCallback(bottom,top);c.fillRect(left,top,right-left,bottom-top)}if(lineWidth>0&&(drawLeft||drawRight||drawTop||drawBottom)){c.beginPath();c.moveTo(left,bottom);if(drawLeft)c.lineTo(left,top);else c.moveTo(left,top);if(drawTop)c.lineTo(right,top);else c.moveTo(right,top);if(drawRight)c.lineTo(right,bottom);else c.moveTo(right,bottom);if(drawBottom)c.lineTo(left,bottom);else c.moveTo(left,bottom);c.stroke()}}function drawSeriesBars(series){function plotBars(datapoints,barLeft,barRight,fillStyleCallback,axisx,axisy){var points=datapoints.points,ps=datapoints.pointsize;for(var i=0;i<points.length;i+=ps){if(points[i]==null)continue;drawBar(points[i],points[i+1],points[i+2],barLeft,barRight,fillStyleCallback,axisx,axisy,ctx,series.bars.horizontal,series.bars.lineWidth)}}ctx.save();ctx.translate(plotOffset.left,plotOffset.top);ctx.lineWidth=series.bars.lineWidth;ctx.strokeStyle=series.color;var barLeft;switch(series.bars.align){case"left":barLeft=0;break;case"right":barLeft=-series.bars.barWidth;break;default:barLeft=-series.bars.barWidth/2}var fillStyleCallback=series.bars.fill?function(bottom,top){return getFillStyle(series.bars,series.color,bottom,top)}:null;plotBars(series.datapoints,barLeft,barLeft+series.bars.barWidth,fillStyleCallback,series.xaxis,series.yaxis);ctx.restore()}function getFillStyle(filloptions,seriesColor,bottom,top){var fill=filloptions.fill;if(!fill)return null;if(filloptions.fillColor)return getColorOrGradient(filloptions.fillColor,bottom,top,seriesColor);var c=$.color.parse(seriesColor);c.a=typeof fill=="number"?fill:.4;c.normalize();return c.toString()}function insertLegend(){if(options.legend.container!=null){$(options.legend.container).html("")}else{placeholder.find(".legend").remove()}if(!options.legend.show){return}var fragments=[],entries=[],rowStarted=false,lf=options.legend.labelFormatter,s,label;for(var i=0;i<series.length;++i){s=series[i];if(s.label){label=lf?lf(s.label,s):s.label;if(label){entries.push({label:label,color:s.color})}}}if(options.legend.sorted){if($.isFunction(options.legend.sorted)){entries.sort(options.legend.sorted)}else if(options.legend.sorted=="reverse"){entries.reverse()}else{var ascending=options.legend.sorted!="descending";entries.sort(function(a,b){return a.label==b.label?0:a.label<b.label!=ascending?1:-1})}}for(var i=0;i<entries.length;++i){var entry=entries[i];if(i%options.legend.noColumns==0){if(rowStarted)fragments.push("</tr>");fragments.push("<tr>");rowStarted=true}fragments.push('<td class="legendColorBox"><div style="border:1px solid '+options.legend.labelBoxBorderColor+';padding:1px"><div style="width:4px;height:0;border:5px solid '+entry.color+';overflow:hidden"></div></div></td>'+'<td class="legendLabel">'+entry.label+"</td>")}if(rowStarted)fragments.push("</tr>");if(fragments.length==0)return;var table='<table style="font-size:smaller;color:'+options.grid.color+'">'+fragments.join("")+"</table>";if(options.legend.container!=null)$(options.legend.container).html(table);else{var pos="",p=options.legend.position,m=options.legend.margin;if(m[0]==null)m=[m,m];if(p.charAt(0)=="n")pos+="top:"+(m[1]+plotOffset.top)+"px;";else if(p.charAt(0)=="s")pos+="bottom:"+(m[1]+plotOffset.bottom)+"px;";if(p.charAt(1)=="e")pos+="right:"+(m[0]+plotOffset.right)+"px;";else if(p.charAt(1)=="w")pos+="left:"+(m[0]+plotOffset.left)+"px;";var legend=$('<div class="legend">'+table.replace('style="','style="position:absolute;'+pos+";")+"</div>").appendTo(placeholder);if(options.legend.backgroundOpacity!=0){var c=options.legend.backgroundColor;if(c==null){c=options.grid.backgroundColor;if(c&&typeof c=="string")c=$.color.parse(c);else c=$.color.extract(legend,"background-color");c.a=1;c=c.toString()}var div=legend.children();$('<div style="position:absolute;width:'+div.width()+"px;height:"+div.height()+"px;"+pos+"background-color:"+c+';"> </div>').prependTo(legend).css("opacity",options.legend.backgroundOpacity)}}}var highlights=[],redrawTimeout=null;function findNearbyItem(mouseX,mouseY,seriesFilter){var maxDistance=options.grid.mouseActiveRadius,smallestDistance=maxDistance*maxDistance+1,item=null,foundPoint=false,i,j,ps;for(i=series.length-1;i>=0;--i){if(!seriesFilter(series[i]))continue;var s=series[i],axisx=s.xaxis,axisy=s.yaxis,points=s.datapoints.points,mx=axisx.c2p(mouseX),my=axisy.c2p(mouseY),maxx=maxDistance/axisx.scale,maxy=maxDistance/axisy.scale;ps=s.datapoints.pointsize;if(axisx.options.inverseTransform)maxx=Number.MAX_VALUE;if(axisy.options.inverseTransform)maxy=Number.MAX_VALUE;if(s.lines.show||s.points.show){for(j=0;j<points.length;j+=ps){var x=points[j],y=points[j+1];if(x==null)continue;if(x-mx>maxx||x-mx<-maxx||y-my>maxy||y-my<-maxy)continue;var dx=Math.abs(axisx.p2c(x)-mouseX),dy=Math.abs(axisy.p2c(y)-mouseY),dist=dx*dx+dy*dy;if(dist<smallestDistance){smallestDistance=dist;item=[i,j/ps]}}}if(s.bars.show&&!item){var barLeft,barRight;switch(s.bars.align){case"left":barLeft=0;break;case"right":barLeft=-s.bars.barWidth;break;default:barLeft=-s.bars.barWidth/2}barRight=barLeft+s.bars.barWidth;for(j=0;j<points.length;j+=ps){var x=points[j],y=points[j+1],b=points[j+2];if(x==null)continue;if(series[i].bars.horizontal?mx<=Math.max(b,x)&&mx>=Math.min(b,x)&&my>=y+barLeft&&my<=y+barRight:mx>=x+barLeft&&mx<=x+barRight&&my>=Math.min(b,y)&&my<=Math.max(b,y))item=[i,j/ps]}}}if(item){i=item[0];j=item[1];ps=series[i].datapoints.pointsize;return{datapoint:series[i].datapoints.points.slice(j*ps,(j+1)*ps),dataIndex:j,series:series[i],seriesIndex:i}}return null}function onMouseMove(e){if(options.grid.hoverable)triggerClickHoverEvent("plothover",e,function(s){return s["hoverable"]!=false})}function onMouseLeave(e){if(options.grid.hoverable)triggerClickHoverEvent("plothover",e,function(s){return false})}function onClick(e){triggerClickHoverEvent("plotclick",e,function(s){return s["clickable"]!=false})}function triggerClickHoverEvent(eventname,event,seriesFilter){var offset=eventHolder.offset(),canvasX=event.pageX-offset.left-plotOffset.left,canvasY=event.pageY-offset.top-plotOffset.top,pos=canvasToAxisCoords({left:canvasX,top:canvasY});pos.pageX=event.pageX;pos.pageY=event.pageY;var item=findNearbyItem(canvasX,canvasY,seriesFilter);if(item){item.pageX=parseInt(item.series.xaxis.p2c(item.datapoint[0])+offset.left+plotOffset.left,10);item.pageY=parseInt(item.series.yaxis.p2c(item.datapoint[1])+offset.top+plotOffset.top,10)}if(options.grid.autoHighlight){for(var i=0;i<highlights.length;++i){var h=highlights[i];if(h.auto==eventname&&!(item&&h.series==item.series&&h.point[0]==item.datapoint[0]&&h.point[1]==item.datapoint[1]))unhighlight(h.series,h.point)}if(item)highlight(item.series,item.datapoint,eventname)}placeholder.trigger(eventname,[pos,item])}function triggerRedrawOverlay(){var t=options.interaction.redrawOverlayInterval;if(t==-1){drawOverlay();return}if(!redrawTimeout)redrawTimeout=setTimeout(drawOverlay,t)}function drawOverlay(){redrawTimeout=null;octx.save();overlay.clear();octx.translate(plotOffset.left,plotOffset.top);var i,hi;for(i=0;i<highlights.length;++i){hi=highlights[i];if(hi.series.bars.show)drawBarHighlight(hi.series,hi.point);else drawPointHighlight(hi.series,hi.point)}octx.restore();executeHooks(hooks.drawOverlay,[octx])}function highlight(s,point,auto){if(typeof s=="number")s=series[s];if(typeof point=="number"){var ps=s.datapoints.pointsize;point=s.datapoints.points.slice(ps*point,ps*(point+1))}var i=indexOfHighlight(s,point);if(i==-1){highlights.push({series:s,point:point,auto:auto});triggerRedrawOverlay()}else if(!auto)highlights[i].auto=false}function unhighlight(s,point){if(s==null&&point==null){highlights=[];triggerRedrawOverlay();return}if(typeof s=="number")s=series[s];if(typeof point=="number"){var ps=s.datapoints.pointsize;point=s.datapoints.points.slice(ps*point,ps*(point+1))}var i=indexOfHighlight(s,point);if(i!=-1){highlights.splice(i,1);triggerRedrawOverlay()}}function indexOfHighlight(s,p){for(var i=0;i<highlights.length;++i){var h=highlights[i];if(h.series==s&&h.point[0]==p[0]&&h.point[1]==p[1])return i}return-1}function drawPointHighlight(series,point){var x=point[0],y=point[1],axisx=series.xaxis,axisy=series.yaxis,highlightColor=typeof series.highlightColor==="string"?series.highlightColor:$.color.parse(series.color).scale("a",.5).toString();if(x<axisx.min||x>axisx.max||y<axisy.min||y>axisy.max)return;var pointRadius=series.points.radius+series.points.lineWidth/2;octx.lineWidth=pointRadius;octx.strokeStyle=highlightColor;var radius=1.5*pointRadius;x=axisx.p2c(x);y=axisy.p2c(y);octx.beginPath();if(series.points.symbol=="circle")octx.arc(x,y,radius,0,2*Math.PI,false);else series.points.symbol(octx,x,y,radius,false);octx.closePath();octx.stroke()}function drawBarHighlight(series,point){var highlightColor=typeof series.highlightColor==="string"?series.highlightColor:$.color.parse(series.color).scale("a",.5).toString(),fillStyle=highlightColor,barLeft;switch(series.bars.align){case"left":barLeft=0;break;case"right":barLeft=-series.bars.barWidth;break;default:barLeft=-series.bars.barWidth/2}octx.lineWidth=series.bars.lineWidth;octx.strokeStyle=highlightColor;drawBar(point[0],point[1],point[2]||0,barLeft,barLeft+series.bars.barWidth,function(){return fillStyle},series.xaxis,series.yaxis,octx,series.bars.horizontal,series.bars.lineWidth)}function getColorOrGradient(spec,bottom,top,defaultColor){if(typeof spec=="string")return spec;else{var gradient=ctx.createLinearGradient(0,top,0,bottom);for(var i=0,l=spec.colors.length;i<l;++i){var c=spec.colors[i];if(typeof c!="string"){var co=$.color.parse(defaultColor);if(c.brightness!=null)co=co.scale("rgb",c.brightness);if(c.opacity!=null)co.a*=c.opacity;c=co.toString()}gradient.addColorStop(i/(l-1),c)}return gradient}}}$.plot=function(placeholder,data,options){var plot=new Plot($(placeholder),data,options,$.plot.plugins);return plot};$.plot.version="0.8.3";$.plot.plugins=[];$.fn.plot=function(data,options){return this.each(function(){$.plot(this,data,options)})};function floorInBase(n,base){return base*Math.floor(n/base)}})(jQuery);if(!document.createElement("canvas").getContext){(function(){var ab=Math;var n=ab.round;var l=ab.sin;var A=ab.cos;var H=ab.abs;var N=ab.sqrt;var d=10;var f=d/2;var z=+navigator.userAgent.match(/MSIE ([\d.]+)?/)[1];function y(){return this.context_||(this.context_=new D(this))}var t=Array.prototype.slice;function g(j,m,p){var i=t.call(arguments,2);return function(){return j.apply(m,i.concat(t.call(arguments)))}}function af(i){return String(i).replace(/&/g,"&amp;").replace(/"/g,"&quot;")}function Y(m,j,i){if(!m.namespaces[j]){m.namespaces.add(j,i,"#default#VML")}}function R(j){Y(j,"g_vml_","urn:schemas-microsoft-com:vml");Y(j,"g_o_","urn:schemas-microsoft-com:office:office");if(!j.styleSheets.ex_canvas_){var i=j.createStyleSheet();i.owningElement.id="ex_canvas_";i.cssText="canvas{display:inline-block;overflow:hidden;text-align:left;width:300px;height:150px}"}}R(document);var e={init:function(i){var j=i||document;j.createElement("canvas");j.attachEvent("onreadystatechange",g(this.init_,this,j))},init_:function(p){var m=p.getElementsByTagName("canvas");for(var j=0;j<m.length;j++){this.initElement(m[j])}},initElement:function(j){if(!j.getContext){j.getContext=y;R(j.ownerDocument);j.innerHTML="";j.attachEvent("onpropertychange",x);j.attachEvent("onresize",W);var i=j.attributes;if(i.width&&i.width.specified){j.style.width=i.width.nodeValue+"px"}else{j.width=j.clientWidth}if(i.height&&i.height.specified){j.style.height=i.height.nodeValue+"px"}else{j.height=j.clientHeight}}return j}};function x(j){var i=j.srcElement;switch(j.propertyName){case"width":i.getContext().clearRect();i.style.width=i.attributes.width.nodeValue+"px";i.firstChild.style.width=i.clientWidth+"px";break;case"height":i.getContext().clearRect();i.style.height=i.attributes.height.nodeValue+"px";i.firstChild.style.height=i.clientHeight+"px";break}}function W(j){var i=j.srcElement;if(i.firstChild){i.firstChild.style.width=i.clientWidth+"px";i.firstChild.style.height=i.clientHeight+"px"}}e.init();var k=[];for(var ae=0;ae<16;ae++){for(var ad=0;ad<16;ad++){k[ae*16+ad]=ae.toString(16)+ad.toString(16)}}function B(){return[[1,0,0],[0,1,0],[0,0,1]]}function J(p,m){var j=B();for(var i=0;i<3;i++){for(var ah=0;ah<3;ah++){var Z=0;for(var ag=0;ag<3;ag++){Z+=p[i][ag]*m[ag][ah]}j[i][ah]=Z}}return j}function v(j,i){i.fillStyle=j.fillStyle;i.lineCap=j.lineCap;i.lineJoin=j.lineJoin;i.lineWidth=j.lineWidth;i.miterLimit=j.miterLimit;i.shadowBlur=j.shadowBlur;i.shadowColor=j.shadowColor;i.shadowOffsetX=j.shadowOffsetX;i.shadowOffsetY=j.shadowOffsetY;i.strokeStyle=j.strokeStyle;i.globalAlpha=j.globalAlpha;i.font=j.font;i.textAlign=j.textAlign;i.textBaseline=j.textBaseline;i.arcScaleX_=j.arcScaleX_;i.arcScaleY_=j.arcScaleY_;i.lineScale_=j.lineScale_}var b={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgreen:"#006400",darkgrey:"#A9A9A9",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",grey:"#808080",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgreen:"#90EE90",lightgrey:"#D3D3D3",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",oldlace:"#FDF5E6",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",whitesmoke:"#F5F5F5",yellowgreen:"#9ACD32"};function M(j){var p=j.indexOf("(",3);var i=j.indexOf(")",p+1);var m=j.substring(p+1,i).split(",");if(m.length!=4||j.charAt(3)!="a"){m[3]=1}return m}function c(i){return parseFloat(i)/100}function r(j,m,i){return Math.min(i,Math.max(m,j))}function I(ag){var i,ai,aj,ah,ak,Z;ah=parseFloat(ag[0])/360%360;if(ah<0){ah++}ak=r(c(ag[1]),0,1);Z=r(c(ag[2]),0,1);if(ak==0){i=ai=aj=Z}else{var j=Z<.5?Z*(1+ak):Z+ak-Z*ak;var m=2*Z-j;i=a(m,j,ah+1/3);ai=a(m,j,ah);aj=a(m,j,ah-1/3)}return"#"+k[Math.floor(i*255)]+k[Math.floor(ai*255)]+k[Math.floor(aj*255)]}function a(j,i,m){if(m<0){m++}if(m>1){m--}if(6*m<1){return j+(i-j)*6*m}else{if(2*m<1){return i}else{if(3*m<2){return j+(i-j)*(2/3-m)*6}else{return j}}}}var C={};function F(j){if(j in C){return C[j]}var ag,Z=1;j=String(j);if(j.charAt(0)=="#"){ag=j}else{if(/^rgb/.test(j)){var p=M(j);var ag="#",ah;for(var m=0;m<3;m++){if(p[m].indexOf("%")!=-1){ah=Math.floor(c(p[m])*255)}else{ah=+p[m]}ag+=k[r(ah,0,255)]}Z=+p[3]}else{if(/^hsl/.test(j)){var p=M(j);ag=I(p);Z=p[3]}else{ag=b[j]||j}}}return C[j]={color:ag,alpha:Z}}var o={style:"normal",variant:"normal",weight:"normal",size:10,family:"sans-serif"};var L={};function E(i){if(L[i]){return L[i]}var p=document.createElement("div");var m=p.style;try{m.font=i}catch(j){}return L[i]={style:m.fontStyle||o.style,variant:m.fontVariant||o.variant,weight:m.fontWeight||o.weight,size:m.fontSize||o.size,family:m.fontFamily||o.family}}function u(m,j){var i={};for(var ah in m){i[ah]=m[ah]}var ag=parseFloat(j.currentStyle.fontSize),Z=parseFloat(m.size);if(typeof m.size=="number"){i.size=m.size}else{if(m.size.indexOf("px")!=-1){i.size=Z}else{if(m.size.indexOf("em")!=-1){i.size=ag*Z}else{if(m.size.indexOf("%")!=-1){i.size=ag/100*Z}else{if(m.size.indexOf("pt")!=-1){i.size=Z/.75}else{i.size=ag}}}}}i.size*=.981;return i}function ac(i){return i.style+" "+i.variant+" "+i.weight+" "+i.size+"px "+i.family}var s={butt:"flat",round:"round"};function S(i){return s[i]||"square"}function D(i){this.m_=B();this.mStack_=[];this.aStack_=[];this.currentPath_=[];this.strokeStyle="#000";this.fillStyle="#000";this.lineWidth=1;this.lineJoin="miter";this.lineCap="butt";this.miterLimit=d*1;this.globalAlpha=1;this.font="10px sans-serif";this.textAlign="left";this.textBaseline="alphabetic";this.canvas=i;var m="width:"+i.clientWidth+"px;height:"+i.clientHeight+"px;overflow:hidden;position:absolute";var j=i.ownerDocument.createElement("div");j.style.cssText=m;i.appendChild(j);var p=j.cloneNode(false);p.style.backgroundColor="red";p.style.filter="alpha(opacity=0)";i.appendChild(p);this.element_=j;this.arcScaleX_=1;this.arcScaleY_=1;this.lineScale_=1}var q=D.prototype;q.clearRect=function(){if(this.textMeasureEl_){this.textMeasureEl_.removeNode(true);this.textMeasureEl_=null}this.element_.innerHTML=""};q.beginPath=function(){this.currentPath_=[]};q.moveTo=function(j,i){var m=V(this,j,i);this.currentPath_.push({type:"moveTo",x:m.x,y:m.y});this.currentX_=m.x;this.currentY_=m.y};q.lineTo=function(j,i){var m=V(this,j,i);this.currentPath_.push({type:"lineTo",x:m.x,y:m.y});this.currentX_=m.x;this.currentY_=m.y};q.bezierCurveTo=function(m,j,ak,aj,ai,ag){var i=V(this,ai,ag);var ah=V(this,m,j);var Z=V(this,ak,aj);K(this,ah,Z,i)};function K(i,Z,m,j){i.currentPath_.push({type:"bezierCurveTo",cp1x:Z.x,cp1y:Z.y,cp2x:m.x,cp2y:m.y,x:j.x,y:j.y});i.currentX_=j.x;i.currentY_=j.y}q.quadraticCurveTo=function(ai,m,j,i){var ah=V(this,ai,m);var ag=V(this,j,i);var aj={x:this.currentX_+2/3*(ah.x-this.currentX_),y:this.currentY_+2/3*(ah.y-this.currentY_)};var Z={x:aj.x+(ag.x-this.currentX_)/3,y:aj.y+(ag.y-this.currentY_)/3};K(this,aj,Z,ag)};q.arc=function(al,aj,ak,ag,j,m){ak*=d;var ap=m?"at":"wa";var am=al+A(ag)*ak-f;var ao=aj+l(ag)*ak-f;var i=al+A(j)*ak-f;var an=aj+l(j)*ak-f;if(am==i&&!m){am+=.125}var Z=V(this,al,aj);var ai=V(this,am,ao);var ah=V(this,i,an);this.currentPath_.push({type:ap,x:Z.x,y:Z.y,radius:ak,xStart:ai.x,yStart:ai.y,xEnd:ah.x,yEnd:ah.y})};q.rect=function(m,j,i,p){this.moveTo(m,j);this.lineTo(m+i,j);this.lineTo(m+i,j+p);this.lineTo(m,j+p);this.closePath()};q.strokeRect=function(m,j,i,p){var Z=this.currentPath_;this.beginPath();this.moveTo(m,j);this.lineTo(m+i,j);this.lineTo(m+i,j+p);this.lineTo(m,j+p);this.closePath();this.stroke();this.currentPath_=Z};q.fillRect=function(m,j,i,p){var Z=this.currentPath_;this.beginPath();this.moveTo(m,j);this.lineTo(m+i,j);this.lineTo(m+i,j+p);this.lineTo(m,j+p);this.closePath();this.fill();this.currentPath_=Z};q.createLinearGradient=function(j,p,i,m){var Z=new U("gradient");Z.x0_=j;Z.y0_=p;Z.x1_=i;Z.y1_=m;return Z};q.createRadialGradient=function(p,ag,m,j,Z,i){var ah=new U("gradientradial");
ah.x0_=p;ah.y0_=ag;ah.r0_=m;ah.x1_=j;ah.y1_=Z;ah.r1_=i;return ah};q.drawImage=function(aq,m){var aj,ah,al,ay,ao,am,at,aA;var ak=aq.runtimeStyle.width;var ap=aq.runtimeStyle.height;aq.runtimeStyle.width="auto";aq.runtimeStyle.height="auto";var ai=aq.width;var aw=aq.height;aq.runtimeStyle.width=ak;aq.runtimeStyle.height=ap;if(arguments.length==3){aj=arguments[1];ah=arguments[2];ao=am=0;at=al=ai;aA=ay=aw}else{if(arguments.length==5){aj=arguments[1];ah=arguments[2];al=arguments[3];ay=arguments[4];ao=am=0;at=ai;aA=aw}else{if(arguments.length==9){ao=arguments[1];am=arguments[2];at=arguments[3];aA=arguments[4];aj=arguments[5];ah=arguments[6];al=arguments[7];ay=arguments[8]}else{throw Error("Invalid number of arguments")}}}var az=V(this,aj,ah);var p=at/2;var j=aA/2;var ax=[];var i=10;var ag=10;ax.push(" <g_vml_:group",' coordsize="',d*i,",",d*ag,'"',' coordorigin="0,0"',' style="width:',i,"px;height:",ag,"px;position:absolute;");if(this.m_[0][0]!=1||this.m_[0][1]||this.m_[1][1]!=1||this.m_[1][0]){var Z=[];Z.push("M11=",this.m_[0][0],",","M12=",this.m_[1][0],",","M21=",this.m_[0][1],",","M22=",this.m_[1][1],",","Dx=",n(az.x/d),",","Dy=",n(az.y/d),"");var av=az;var au=V(this,aj+al,ah);var ar=V(this,aj,ah+ay);var an=V(this,aj+al,ah+ay);av.x=ab.max(av.x,au.x,ar.x,an.x);av.y=ab.max(av.y,au.y,ar.y,an.y);ax.push("padding:0 ",n(av.x/d),"px ",n(av.y/d),"px 0;filter:progid:DXImageTransform.Microsoft.Matrix(",Z.join(""),", sizingmethod='clip');")}else{ax.push("top:",n(az.y/d),"px;left:",n(az.x/d),"px;")}ax.push(' ">','<g_vml_:image src="',aq.src,'"',' style="width:',d*al,"px;"," height:",d*ay,'px"',' cropleft="',ao/ai,'"',' croptop="',am/aw,'"',' cropright="',(ai-ao-at)/ai,'"',' cropbottom="',(aw-am-aA)/aw,'"'," />","</g_vml_:group>");this.element_.insertAdjacentHTML("BeforeEnd",ax.join(""))};q.stroke=function(ao){var Z=10;var ap=10;var ag=5e3;var ai={x:null,y:null};var an={x:null,y:null};for(var aj=0;aj<this.currentPath_.length;aj+=ag){var am=[];var ah=false;am.push("<g_vml_:shape",' filled="',!!ao,'"',' style="position:absolute;width:',Z,"px;height:",ap,'px;"',' coordorigin="0,0"',' coordsize="',d*Z,",",d*ap,'"',' stroked="',!ao,'"',' path="');var aq=false;for(var ak=aj;ak<Math.min(aj+ag,this.currentPath_.length);ak++){if(ak%ag==0&&ak>0){am.push(" m ",n(this.currentPath_[ak-1].x),",",n(this.currentPath_[ak-1].y))}var m=this.currentPath_[ak];var al;switch(m.type){case"moveTo":al=m;am.push(" m ",n(m.x),",",n(m.y));break;case"lineTo":am.push(" l ",n(m.x),",",n(m.y));break;case"close":am.push(" x ");m=null;break;case"bezierCurveTo":am.push(" c ",n(m.cp1x),",",n(m.cp1y),",",n(m.cp2x),",",n(m.cp2y),",",n(m.x),",",n(m.y));break;case"at":case"wa":am.push(" ",m.type," ",n(m.x-this.arcScaleX_*m.radius),",",n(m.y-this.arcScaleY_*m.radius)," ",n(m.x+this.arcScaleX_*m.radius),",",n(m.y+this.arcScaleY_*m.radius)," ",n(m.xStart),",",n(m.yStart)," ",n(m.xEnd),",",n(m.yEnd));break}if(m){if(ai.x==null||m.x<ai.x){ai.x=m.x}if(an.x==null||m.x>an.x){an.x=m.x}if(ai.y==null||m.y<ai.y){ai.y=m.y}if(an.y==null||m.y>an.y){an.y=m.y}}}am.push(' ">');if(!ao){w(this,am)}else{G(this,am,ai,an)}am.push("</g_vml_:shape>");this.element_.insertAdjacentHTML("beforeEnd",am.join(""))}};function w(m,ag){var j=F(m.strokeStyle);var p=j.color;var Z=j.alpha*m.globalAlpha;var i=m.lineScale_*m.lineWidth;if(i<1){Z*=i}ag.push("<g_vml_:stroke",' opacity="',Z,'"',' joinstyle="',m.lineJoin,'"',' miterlimit="',m.miterLimit,'"',' endcap="',S(m.lineCap),'"',' weight="',i,'px"',' color="',p,'" />')}function G(aq,ai,aK,ar){var aj=aq.fillStyle;var aB=aq.arcScaleX_;var aA=aq.arcScaleY_;var j=ar.x-aK.x;var p=ar.y-aK.y;if(aj instanceof U){var an=0;var aF={x:0,y:0};var ax=0;var am=1;if(aj.type_=="gradient"){var al=aj.x0_/aB;var m=aj.y0_/aA;var ak=aj.x1_/aB;var aM=aj.y1_/aA;var aJ=V(aq,al,m);var aI=V(aq,ak,aM);var ag=aI.x-aJ.x;var Z=aI.y-aJ.y;an=Math.atan2(ag,Z)*180/Math.PI;if(an<0){an+=360}if(an<1e-6){an=0}}else{var aJ=V(aq,aj.x0_,aj.y0_);aF={x:(aJ.x-aK.x)/j,y:(aJ.y-aK.y)/p};j/=aB*d;p/=aA*d;var aD=ab.max(j,p);ax=2*aj.r0_/aD;am=2*aj.r1_/aD-ax}var av=aj.colors_;av.sort(function(aN,i){return aN.offset-i.offset});var ap=av.length;var au=av[0].color;var at=av[ap-1].color;var az=av[0].alpha*aq.globalAlpha;var ay=av[ap-1].alpha*aq.globalAlpha;var aE=[];for(var aH=0;aH<ap;aH++){var ao=av[aH];aE.push(ao.offset*am+ax+" "+ao.color)}ai.push('<g_vml_:fill type="',aj.type_,'"',' method="none" focus="100%"',' color="',au,'"',' color2="',at,'"',' colors="',aE.join(","),'"',' opacity="',ay,'"',' g_o_:opacity2="',az,'"',' angle="',an,'"',' focusposition="',aF.x,",",aF.y,'" />')}else{if(aj instanceof T){if(j&&p){var ah=-aK.x;var aC=-aK.y;ai.push("<g_vml_:fill",' position="',ah/j*aB*aB,",",aC/p*aA*aA,'"',' type="tile"',' src="',aj.src_,'" />')}}else{var aL=F(aq.fillStyle);var aw=aL.color;var aG=aL.alpha*aq.globalAlpha;ai.push('<g_vml_:fill color="',aw,'" opacity="',aG,'" />')}}}q.fill=function(){this.stroke(true)};q.closePath=function(){this.currentPath_.push({type:"close"})};function V(j,Z,p){var i=j.m_;return{x:d*(Z*i[0][0]+p*i[1][0]+i[2][0])-f,y:d*(Z*i[0][1]+p*i[1][1]+i[2][1])-f}}q.save=function(){var i={};v(this,i);this.aStack_.push(i);this.mStack_.push(this.m_);this.m_=J(B(),this.m_)};q.restore=function(){if(this.aStack_.length){v(this.aStack_.pop(),this);this.m_=this.mStack_.pop()}};function h(i){return isFinite(i[0][0])&&isFinite(i[0][1])&&isFinite(i[1][0])&&isFinite(i[1][1])&&isFinite(i[2][0])&&isFinite(i[2][1])}function aa(j,i,p){if(!h(i)){return}j.m_=i;if(p){var Z=i[0][0]*i[1][1]-i[0][1]*i[1][0];j.lineScale_=N(H(Z))}}q.translate=function(m,j){var i=[[1,0,0],[0,1,0],[m,j,1]];aa(this,J(i,this.m_),false)};q.rotate=function(j){var p=A(j);var m=l(j);var i=[[p,m,0],[-m,p,0],[0,0,1]];aa(this,J(i,this.m_),false)};q.scale=function(m,j){this.arcScaleX_*=m;this.arcScaleY_*=j;var i=[[m,0,0],[0,j,0],[0,0,1]];aa(this,J(i,this.m_),true)};q.transform=function(Z,p,ah,ag,j,i){var m=[[Z,p,0],[ah,ag,0],[j,i,1]];aa(this,J(m,this.m_),true)};q.setTransform=function(ag,Z,ai,ah,p,j){var i=[[ag,Z,0],[ai,ah,0],[p,j,1]];aa(this,i,true)};q.drawText_=function(am,ak,aj,ap,ai){var ao=this.m_,at=1e3,j=0,ar=at,ah={x:0,y:0},ag=[];var i=u(E(this.font),this.element_);var p=ac(i);var au=this.element_.currentStyle;var Z=this.textAlign.toLowerCase();switch(Z){case"left":case"center":case"right":break;case"end":Z=au.direction=="ltr"?"right":"left";break;case"start":Z=au.direction=="rtl"?"right":"left";break;default:Z="left"}switch(this.textBaseline){case"hanging":case"top":ah.y=i.size/1.75;break;case"middle":break;default:case null:case"alphabetic":case"ideographic":case"bottom":ah.y=-i.size/2.25;break}switch(Z){case"right":j=at;ar=.05;break;case"center":j=ar=at/2;break}var aq=V(this,ak+ah.x,aj+ah.y);ag.push('<g_vml_:line from="',-j,' 0" to="',ar,' 0.05" ',' coordsize="100 100" coordorigin="0 0"',' filled="',!ai,'" stroked="',!!ai,'" style="position:absolute;width:1px;height:1px;">');if(ai){w(this,ag)}else{G(this,ag,{x:-j,y:0},{x:ar,y:i.size})}var an=ao[0][0].toFixed(3)+","+ao[1][0].toFixed(3)+","+ao[0][1].toFixed(3)+","+ao[1][1].toFixed(3)+",0,0";var al=n(aq.x/d)+","+n(aq.y/d);ag.push('<g_vml_:skew on="t" matrix="',an,'" ',' offset="',al,'" origin="',j,' 0" />','<g_vml_:path textpathok="true" />','<g_vml_:textpath on="true" string="',af(am),'" style="v-text-align:',Z,";font:",af(p),'" /></g_vml_:line>');this.element_.insertAdjacentHTML("beforeEnd",ag.join(""))};q.fillText=function(m,i,p,j){this.drawText_(m,i,p,j,false)};q.strokeText=function(m,i,p,j){this.drawText_(m,i,p,j,true)};q.measureText=function(m){if(!this.textMeasureEl_){var i='<span style="position:absolute;top:-20000px;left:0;padding:0;margin:0;border:none;white-space:pre;"></span>';this.element_.insertAdjacentHTML("beforeEnd",i);this.textMeasureEl_=this.element_.lastChild}var j=this.element_.ownerDocument;this.textMeasureEl_.innerHTML="";this.textMeasureEl_.style.font=this.font;this.textMeasureEl_.appendChild(j.createTextNode(m));return{width:this.textMeasureEl_.offsetWidth}};q.clip=function(){};q.arcTo=function(){};q.createPattern=function(j,i){return new T(j,i)};function U(i){this.type_=i;this.x0_=0;this.y0_=0;this.r0_=0;this.x1_=0;this.y1_=0;this.r1_=0;this.colors_=[]}U.prototype.addColorStop=function(j,i){i=F(i);this.colors_.push({offset:j,color:i.color,alpha:i.alpha})};function T(j,i){Q(j);switch(i){case"repeat":case null:case"":this.repetition_="repeat";break;case"repeat-x":case"repeat-y":case"no-repeat":this.repetition_=i;break;default:O("SYNTAX_ERR")}this.src_=j.src;this.width_=j.width;this.height_=j.height}function O(i){throw new P(i)}function Q(i){if(!i||i.nodeType!=1||i.tagName!="IMG"){O("TYPE_MISMATCH_ERR")}if(i.readyState!="complete"){O("INVALID_STATE_ERR")}}function P(i){this.code=this[i];this.message=i+": DOM Exception "+this.code}var X=P.prototype=new Error;X.INDEX_SIZE_ERR=1;X.DOMSTRING_SIZE_ERR=2;X.HIERARCHY_REQUEST_ERR=3;X.WRONG_DOCUMENT_ERR=4;X.INVALID_CHARACTER_ERR=5;X.NO_DATA_ALLOWED_ERR=6;X.NO_MODIFICATION_ALLOWED_ERR=7;X.NOT_FOUND_ERR=8;X.NOT_SUPPORTED_ERR=9;X.INUSE_ATTRIBUTE_ERR=10;X.INVALID_STATE_ERR=11;X.SYNTAX_ERR=12;X.INVALID_MODIFICATION_ERR=13;X.NAMESPACE_ERR=14;X.INVALID_ACCESS_ERR=15;X.VALIDATION_ERR=16;X.TYPE_MISMATCH_ERR=17;G_vmlCanvasManager=e;CanvasRenderingContext2D=D;CanvasGradient=U;CanvasPattern=T;DOMException=P})()}var requirejs,require,define;(function(W){function D(b){return M.call(b)==="[object Function]"}function E(b){return M.call(b)==="[object Array]"}function t(b,c){if(b){var d;for(d=0;d<b.length;d+=1)if(b[d]&&c(b[d],d,b))break}}function N(b,c){if(b){var d;for(d=b.length-1;d>-1;d-=1)if(b[d]&&c(b[d],d,b))break}}function A(b,c){for(var d in b)if(b.hasOwnProperty(d)&&c(b[d],d))break}function O(b,c,d,g){c&&A(c,function(c,j){if(d||!F.call(b,j))g&&typeof c!=="string"?(b[j]||(b[j]={}),O(b[j],c,d,g)):b[j]=c});return b}function r(b,c){return function(){return c.apply(b,arguments)}}function X(b){if(!b)return b;var c=W;t(b.split("."),function(b){c=c[b]});return c}function G(b,c,d,g){c=Error(c+"\nhttp://requirejs.org/docs/errors.html#"+b);c.requireType=b;c.requireModules=g;if(d)c.originalError=d;return c}function ba(){if(H&&H.readyState==="interactive")return H;N(document.getElementsByTagName("script"),function(b){if(b.readyState==="interactive")return H=b});return H}var g,s,u,y,q,B,H,I,Y,Z,ca=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,da=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,$=/\.js$/,ea=/^\.\//;s=Object.prototype;var M=s.toString,F=s.hasOwnProperty,fa=Array.prototype.splice,v=!!(typeof window!=="undefined"&&navigator&&document),aa=!v&&typeof importScripts!=="undefined",ga=v&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,R=typeof opera!=="undefined"&&opera.toString()==="[object Opera]",w={},n={},P=[],J=!1;if(typeof define==="undefined"){if(typeof requirejs!=="undefined"){if(D(requirejs))return;n=requirejs;requirejs=void 0}typeof require!=="undefined"&&!D(require)&&(n=require,require=void 0);g=requirejs=function(b,c,d,p){var i,j="_";!E(b)&&typeof b!=="string"&&(i=b,E(c)?(b=c,c=d,d=p):b=[]);if(i&&i.context)j=i.context;(p=w[j])||(p=w[j]=g.s.newContext(j));i&&p.configure(i);return p.require(b,c,d)};g.config=function(b){return g(b)};g.nextTick=typeof setTimeout!=="undefined"?function(b){setTimeout(b,4)}:function(b){b()};require||(require=g);g.version="2.1.1";g.jsExtRegExp=/^\/|:|\?|\.js$/;g.isBrowser=v;s=g.s={contexts:w,newContext:function(b){function c(a,f,x){var e,m,b,c,d,h,i,g=f&&f.split("/");e=g;var j=k.map,l=j&&j["*"];if(a&&a.charAt(0)===".")if(f){e=k.pkgs[f]?g=[f]:g.slice(0,g.length-1);f=a=e.concat(a.split("/"));for(e=0;f[e];e+=1)if(m=f[e],m===".")f.splice(e,1),e-=1;else if(m==="..")if(e===1&&(f[2]===".."||f[0]===".."))break;else e>0&&(f.splice(e-1,2),e-=2);e=k.pkgs[f=a[0]];a=a.join("/");e&&a===f+"/"+e.main&&(a=f)}else a.indexOf("./")===0&&(a=a.substring(2));if(x&&(g||l)&&j){f=a.split("/");for(e=f.length;e>0;e-=1){b=f.slice(0,e).join("/");if(g)for(m=g.length;m>0;m-=1)if(x=j[g.slice(0,m).join("/")])if(x=x[b]){c=x;d=e;break}if(c)break;!h&&l&&l[b]&&(h=l[b],i=e)}!c&&h&&(c=h,d=i);c&&(f.splice(0,d,c),a=f.join("/"))}return a}function d(a){v&&t(document.getElementsByTagName("script"),function(f){if(f.getAttribute("data-requiremodule")===a&&f.getAttribute("data-requirecontext")===h.contextName)return f.parentNode.removeChild(f),!0})}function p(a){var f=k.paths[a];if(f&&E(f)&&f.length>1)return d(a),f.shift(),h.require.undef(a),h.require([a]),!0}function i(a){var f,b=a?a.indexOf("!"):-1;b>-1&&(f=a.substring(0,b),a=a.substring(b+1,a.length));return[f,a]}function j(a,f,b,e){var m,K,d=null,g=f?f.name:null,j=a,l=!0,k="";a||(l=!1,a="_@r"+(M+=1));a=i(a);d=a[0];a=a[1];d&&(d=c(d,g,e),K=o[d]);a&&(d?k=K&&K.normalize?K.normalize(a,function(a){return c(a,g,e)}):c(a,g,e):(k=c(a,g,e),a=i(k),d=a[0],k=a[1],b=!0,m=h.nameToUrl(k)));b=d&&!K&&!b?"_unnormalized"+(N+=1):"";return{prefix:d,name:k,parentMap:f,unnormalized:!!b,url:m,originalName:j,isDefine:l,id:(d?d+"!"+k:k)+b}}function n(a){var f=a.id,b=l[f];b||(b=l[f]=new h.Module(a));return b}function q(a,f,b){var e=a.id,m=l[e];if(F.call(o,e)&&(!m||m.defineEmitComplete))f==="defined"&&b(o[e]);else n(a).on(f,b)}function z(a,f){var b=a.requireModules,e=!1;if(f)f(a);else if(t(b,function(f){if(f=l[f])f.error=a,f.events.error&&(e=!0,f.emit("error",a))}),!e)g.onError(a)}function s(){P.length&&(fa.apply(C,[C.length-1,0].concat(P)),P=[])}function u(a,f,b){var e=a.map.id;a.error?a.emit("error",a.error):(f[e]=!0,t(a.depMaps,function(e,c){var d=e.id,g=l[d];g&&!a.depMatched[c]&&!b[d]&&(f[d]?(a.defineDep(c,o[d]),a.check()):u(g,f,b))}),b[e]=!0)}function w(){var a,f,b,e,m=(b=k.waitSeconds*1e3)&&h.startTime+b<(new Date).getTime(),c=[],g=[],i=!1,j=!0;if(!S){S=!0;A(l,function(b){a=b.map;f=a.id;if(b.enabled&&(a.isDefine||g.push(b),!b.error))if(!b.inited&&m)p(f)?i=e=!0:(c.push(f),d(f));else if(!b.inited&&b.fetched&&a.isDefine&&(i=!0,!a.prefix))return j=!1});if(m&&c.length)return b=G("timeout","Load timeout for modules: "+c,null,c),b.contextName=h.contextName,z(b);j&&t(g,function(a){u(a,{},{})});if((!m||e)&&i)if((v||aa)&&!T)T=setTimeout(function(){T=0;w()},50);S=!1}}function y(a){n(j(a[0],null,!0)).init(a[1],a[2])}function B(a){var a=a.currentTarget||a.srcElement,b=h.onScriptLoad;a.detachEvent&&!R?a.detachEvent("onreadystatechange",b):a.removeEventListener("load",b,!1);b=h.onScriptError;a.detachEvent&&!R||a.removeEventListener("error",b,!1);return{node:a,id:a&&a.getAttribute("data-requiremodule")}}function I(){var a;for(s();C.length;)if(a=C.shift(),a[0]===null)return z(G("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));else y(a)}var S,U,h,L,T,k={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},shim:{},map:{},config:{}},l={},V={},C=[],o={},Q={},M=1,N=1;L={require:function(a){return a.require?a.require:a.require=h.makeRequire(a.map)},exports:function(a){a.usingExports=!0;if(a.map.isDefine)return a.exports?a.exports:a.exports=o[a.map.id]={}},module:function(a){return a.module?a.module:a.module={id:a.map.id,uri:a.map.url,config:function(){return k.config&&k.config[a.map.id]||{}},exports:o[a.map.id]}}};U=function(a){this.events=V[a.id]||{};this.map=a;this.shim=k.shim[a.id];this.depExports=[];this.depMaps=[];this.depMatched=[];this.pluginMaps={};this.depCount=0};U.prototype={init:function(a,b,c,e){e=e||{};if(!this.inited){this.factory=b;if(c)this.on("error",c);else this.events.error&&(c=r(this,function(a){this.emit("error",a)}));this.depMaps=a&&a.slice(0);this.errback=c;this.inited=!0;this.ignore=e.ignore;e.enabled||this.enabled?this.enable():this.check()}},defineDep:function(a,b){this.depMatched[a]||(this.depMatched[a]=!0,this.depCount-=1,this.depExports[a]=b)},fetch:function(){if(!this.fetched){this.fetched=!0;h.startTime=(new Date).getTime();var a=this.map;if(this.shim)h.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],r(this,function(){return a.prefix?this.callPlugin():this.load()}));else return a.prefix?this.callPlugin():this.load()}},load:function(){var a=this.map.url;Q[a]||(Q[a]=!0,h.load(this.map.id,a))},check:function(){if(this.enabled&&!this.enabling){var a,b,c=this.map.id;b=this.depExports;var e=this.exports,m=this.factory;if(this.inited)if(this.error)this.emit("error",this.error);else{if(!this.defining){this.defining=!0;if(this.depCount<1&&!this.defined){if(D(m)){if(this.events.error)try{e=h.execCb(c,m,b,e)}catch(d){a=d}else e=h.execCb(c,m,b,e);if(this.map.isDefine)if((b=this.module)&&b.exports!==void 0&&b.exports!==this.exports)e=b.exports;else if(e===void 0&&this.usingExports)e=this.exports;if(a)return a.requireMap=this.map,a.requireModules=[this.map.id],a.requireType="define",z(this.error=a)}else e=m;this.exports=e;if(this.map.isDefine&&!this.ignore&&(o[c]=e,g.onResourceLoad))g.onResourceLoad(h,this.map,this.depMaps);delete l[c];this.defined=!0}this.defining=!1;if(this.defined&&!this.defineEmitted)this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0}}else this.fetch()}},callPlugin:function(){var a=this.map,b=a.id,d=j(a.prefix);this.depMaps.push(d);q(d,"defined",r(this,function(e){var m,d;d=this.map.name;var x=this.map.parentMap?this.map.parentMap.name:null,i=h.makeRequire(a.parentMap,{enableBuildCallback:!0,skipMap:!0});if(this.map.unnormalized){if(e.normalize&&(d=e.normalize(d,function(a){return c(a,x,!0)})||""),e=j(a.prefix+"!"+d,this.map.parentMap),q(e,"defined",r(this,function(a){this.init([],function(){return a},null,{enabled:!0,ignore:!0})})),d=l[e.id]){this.depMaps.push(e);if(this.events.error)d.on("error",r(this,function(a){this.emit("error",a)}));d.enable()}}else m=r(this,function(a){this.init([],function(){return a},null,{enabled:!0})}),m.error=r(this,function(a){this.inited=!0;this.error=a;a.requireModules=[b];A(l,function(a){a.map.id.indexOf(b+"_unnormalized")===0&&delete l[a.map.id]});z(a)}),m.fromText=r(this,function(b,e){var f=a.name,c=j(f),d=J;e&&(b=e);d&&(J=!1);n(c);try{g.exec(b)}catch(x){throw Error("fromText eval for "+f+" failed: "+x)}d&&(J=!0);this.depMaps.push(c);h.completeLoad(f);i([f],m)}),e.load(a.name,i,m,k)}));h.enable(d,this);this.pluginMaps[d.id]=d},enable:function(){this.enabling=this.enabled=!0;t(this.depMaps,r(this,function(a,b){var c,e;if(typeof a==="string"){a=j(a,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap);this.depMaps[b]=a;if(c=L[a.id]){this.depExports[b]=c(this);return}this.depCount+=1;q(a,"defined",r(this,function(a){this.defineDep(b,a);this.check()}));this.errback&&q(a,"error",this.errback)}c=a.id;e=l[c];!L[c]&&e&&!e.enabled&&h.enable(a,this)}));A(this.pluginMaps,r(this,function(a){var b=l[a.id];b&&!b.enabled&&h.enable(a,this)}));this.enabling=!1;this.check()},on:function(a,b){var c=this.events[a];c||(c=this.events[a]=[]);c.push(b)},emit:function(a,b){t(this.events[a],function(a){a(b)});a==="error"&&delete this.events[a]}};h={config:k,contextName:b,registry:l,defined:o,urlFetched:Q,defQueue:C,Module:U,makeModuleMap:j,nextTick:g.nextTick,configure:function(a){a.baseUrl&&a.baseUrl.charAt(a.baseUrl.length-1)!=="/"&&(a.baseUrl+="/");var b=k.pkgs,c=k.shim,e={paths:!0,config:!0,map:!0};A(a,function(a,b){e[b]?b==="map"?O(k[b],a,!0,!0):O(k[b],a,!0):k[b]=a});if(a.shim)A(a.shim,function(a,b){E(a)&&(a={deps:a});if(a.exports&&!a.exportsFn)a.exportsFn=h.makeShimExports(a);c[b]=a}),k.shim=c;if(a.packages)t(a.packages,function(a){a=typeof a==="string"?{name:a}:a;b[a.name]={name:a.name,location:a.location||a.name,main:(a.main||"main").replace(ea,"").replace($,"")}}),k.pkgs=b;A(l,function(a,b){if(!a.inited&&!a.map.unnormalized)a.map=j(b)});if(a.deps||a.callback)h.require(a.deps||[],a.callback)},makeShimExports:function(a){return function(){var b;a.init&&(b=a.init.apply(W,arguments));return b||X(a.exports)}},makeRequire:function(a,f){function d(e,c,i){var k,p;if(f.enableBuildCallback&&c&&D(c))c.__requireJsBuild=!0;if(typeof e==="string"){if(D(c))return z(G("requireargs","Invalid require call"),i);if(a&&L[e])return L[e](l[a.id]);if(g.get)return g.get(h,e,a);k=j(e,a,!1,!0);k=k.id;return!F.call(o,k)?z(G("notloaded",'Module name "'+k+'" has not been loaded yet for context: '+b+(a?"":". Use require([])"))):o[k]}I();h.nextTick(function(){I();p=n(j(null,a));p.skipMap=f.skipMap;p.init(e,c,i,{enabled:!0});w()});return d}f=f||{};O(d,{isBrowser:v,toUrl:function(b){var d=b.lastIndexOf("."),f=null;d!==-1&&(f=b.substring(d,b.length),b=b.substring(0,d));return h.nameToUrl(c(b,a&&a.id,!0),f)},defined:function(b){b=j(b,a,!1,!0).id;return F.call(o,b)},specified:function(b){b=j(b,a,!1,!0).id;return F.call(o,b)||F.call(l,b)}});if(!a)d.undef=function(b){s();var c=j(b,a,!0),d=l[b];delete o[b];delete Q[c.url];delete V[b];if(d){if(d.events.defined)V[b]=d.events;delete l[b]}};return d},enable:function(a){l[a.id]&&n(a).enable()},completeLoad:function(a){var b,c,d=k.shim[a]||{},g=d.exports;for(s();C.length;){c=C.shift();if(c[0]===null){c[0]=a;if(b)break;b=!0}else c[0]===a&&(b=!0);y(c)}c=l[a];if(!b&&!o[a]&&c&&!c.inited)if(k.enforceDefine&&(!g||!X(g)))if(p(a))return;else return z(G("nodefine","No define call for "+a,null,[a]));else y([a,d.deps||[],d.exportsFn]);w()},nameToUrl:function(a,b){var c,d,i,h,j,l;if(g.jsExtRegExp.test(a))h=a+(b||"");else{c=k.paths;d=k.pkgs;h=a.split("/");for(j=h.length;j>0;j-=1)if(l=h.slice(0,j).join("/"),i=d[l],l=c[l]){E(l)&&(l=l[0]);h.splice(0,j,l);break}else if(i){c=a===i.name?i.location+"/"+i.main:i.location;h.splice(0,j,c);break}h=h.join("/");h+=b||(/\?/.test(h)?"":".js");h=(h.charAt(0)==="/"||h.match(/^[\w\+\.\-]+:/)?"":k.baseUrl)+h}return k.urlArgs?h+((h.indexOf("?")===-1?"?":"&")+k.urlArgs):h},load:function(a,b){g.load(h,a,b)},execCb:function(a,b,c,d){return b.apply(d,c)},onScriptLoad:function(a){if(a.type==="load"||ga.test((a.currentTarget||a.srcElement).readyState))H=null,a=B(a),h.completeLoad(a.id)},onScriptError:function(a){var b=B(a);if(!p(b.id))return z(G("scripterror","Script error",a,[b.id]))}};h.require=h.makeRequire();return h}};g({});t(["toUrl","undef","defined","specified"],function(b){g[b]=function(){var c=w._;return c.require[b].apply(c,arguments)}});if(v&&(u=s.head=document.getElementsByTagName("head")[0],y=document.getElementsByTagName("base")[0]))u=s.head=y.parentNode;g.onError=function(b){throw b};g.load=function(b,c,d){var g=b&&b.config||{},i;if(v)return i=g.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),i.type=g.scriptType||"text/javascript",i.charset="utf-8",i.async=!0,i.setAttribute("data-requirecontext",b.contextName),i.setAttribute("data-requiremodule",c),i.attachEvent&&!(i.attachEvent.toString&&i.attachEvent.toString().indexOf("[native code")<0)&&!R?(J=!0,i.attachEvent("onreadystatechange",b.onScriptLoad)):(i.addEventListener("load",b.onScriptLoad,!1),i.addEventListener("error",b.onScriptError,!1)),i.src=d,I=i,y?u.insertBefore(i,y):u.appendChild(i),I=null,i;else aa&&(importScripts(d),b.completeLoad(c))};v&&N(document.getElementsByTagName("script"),function(b){if(!u)u=b.parentNode;if(q=b.getAttribute("data-main")){if(!n.baseUrl)B=q.split("/"),Y=B.pop(),Z=B.length?B.join("/")+"/":"./",n.baseUrl=Z,q=Y;q=q.replace($,"");n.deps=n.deps?n.deps.concat(q):[q];return!0}});define=function(b,c,d){var g,i;typeof b!=="string"&&(d=c,c=b,b=null);E(c)||(d=c,c=[]);!c.length&&D(d)&&d.length&&(d.toString().replace(ca,"").replace(da,function(b,d){c.push(d)}),c=(d.length===1?["require"]:["require","exports","module"]).concat(c));if(J&&(g=I||ba()))b||(b=g.getAttribute("data-requiremodule")),i=w[g.getAttribute("data-requirecontext")];(i?i.defQueue:P).push([b,c,d])};define.amd={jQuery:!0};g.exec=function(b){return eval(b)};g(n)}})(this);(function(b){var m,t,u,f,D,j,E,n,z,A,q=0,e={},o=[],p=0,d={},l=[],G=null,v=new Image,J=/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i,W=/[^\.]\.(swf)\s*$/i,K,L=1,y=0,s="",r,i,h=false,B=b.extend(b("<div/>")[0],{prop:0}),M=b.browser.msie&&b.browser.version<7&&!window.XMLHttpRequest,N=function(){t.hide();v.onerror=v.onload=null;G&&G.abort();m.empty()},O=function(){if(false===e.onError(o,q,e)){t.hide();h=false}else{e.titleShow=false;e.width="auto";e.height="auto";m.html('<p id="fancybox-error">The requested content cannot be loaded.<br />Please try again later.</p>');F()}},I=function(){var a=o[q],c,g,k,C,P,w;N();e=b.extend({},b.fn.fancybox.defaults,typeof b(a).data("fancybox")=="undefined"?e:b(a).data("fancybox"));w=e.onStart(o,q,e);if(w===false)h=false;else{if(typeof w=="object")e=b.extend(e,w);k=e.title||(a.nodeName?b(a).attr("title"):a.title)||"";if(a.nodeName&&!e.orig)e.orig=b(a).children("img:first").length?b(a).children("img:first"):b(a);if(k===""&&e.orig&&e.titleFromAlt)k=e.orig.attr("alt");c=e.href||(a.nodeName?b(a).attr("href"):a.href)||null;if(/^(?:javascript)/i.test(c)||c=="#")c=null;if(e.type){g=e.type;if(!c)c=e.content}else if(e.content)g="html";else if(c)g=c.match(J)?"image":c.match(W)?"swf":b(a).hasClass("iframe")?"iframe":c.indexOf("#")===0?"inline":"ajax";if(g){if(g=="inline"){a=c.substr(c.indexOf("#"));g=b(a).length>0?"inline":"ajax"}e.type=g;e.href=c;e.title=k;if(e.autoDimensions)if(e.type=="html"||e.type=="inline"||e.type=="ajax"){e.width="auto";e.height="auto"}else e.autoDimensions=false;if(e.modal){e.overlayShow=true;e.hideOnOverlayClick=false;e.hideOnContentClick=false;e.enableEscapeButton=false;e.showCloseButton=false}e.padding=parseInt(e.padding,10);e.margin=parseInt(e.margin,10);m.css("padding",e.padding+e.margin);b(".fancybox-inline-tmp").unbind("fancybox-cancel").bind("fancybox-change",function(){b(this).replaceWith(j.children())});switch(g){case"html":m.html(e.content);F();break;case"inline":if(b(a).parent().is("#fancybox-content")===true){h=false;break}b('<div class="fancybox-inline-tmp" />').hide().insertBefore(b(a)).bind("fancybox-cleanup",function(){b(this).replaceWith(j.children())}).bind("fancybox-cancel",function(){b(this).replaceWith(m.children())});b(a).appendTo(m);F();break;case"image":h=false;b.fancybox.showActivity();v=new Image;v.onerror=function(){O()};v.onload=function(){h=true;v.onerror=v.onload=null;e.width=v.width;e.height=v.height;b("<img />").attr({id:"fancybox-img",src:v.src,alt:e.title}).appendTo(m);Q()};v.src=c;break;case"swf":e.scrolling="no";C='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+e.width+'" height="'+e.height+'"><param name="movie" value="'+c+'"></param>';P="";b.each(e.swf,function(x,H){C+='<param name="'+x+'" value="'+H+'"></param>';P+=" "+x+'="'+H+'"'});C+='<embed src="'+c+'" type="application/x-shockwave-flash" width="'+e.width+'" height="'+e.height+'"'+P+"></embed></object>";m.html(C);F();break;case"ajax":h=false;b.fancybox.showActivity();e.ajax.win=e.ajax.success;G=b.ajax(b.extend({},e.ajax,{url:c,data:e.ajax.data||{},error:function(x){x.status>0&&O()},success:function(x,H,R){if((typeof R=="object"?R:G).status==200){if(typeof e.ajax.win=="function"){w=e.ajax.win(c,x,H,R);if(w===false){t.hide();return}else if(typeof w=="string"||typeof w=="object")x=w}m.html(x);F()}}}));break;case"iframe":Q()}}else O()}},F=function(){var a=e.width,c=e.height;a=a.toString().indexOf("%")>-1?parseInt((b(window).width()-e.margin*2)*parseFloat(a)/100,10)+"px":a=="auto"?"auto":a+"px";c=c.toString().indexOf("%")>-1?parseInt((b(window).height()-e.margin*2)*parseFloat(c)/100,10)+"px":c=="auto"?"auto":c+"px";m.wrapInner('<div style="width:'+a+";height:"+c+";overflow: "+(e.scrolling=="auto"?"auto":e.scrolling=="yes"?"scroll":"hidden")+';position:relative;"></div>');e.width=m.width();e.height=m.height();Q()},Q=function(){var a,c;t.hide();if(f.is(":visible")&&false===d.onCleanup(l,p,d)){b.event.trigger("fancybox-cancel");h=false}else{h=true;b(j.add(u)).unbind();b(window).unbind("resize.fb scroll.fb");b(document).unbind("keydown.fb");f.is(":visible")&&d.titlePosition!=="outside"&&f.css("height",f.height());l=o;p=q;d=e;if(d.overlayShow){u.css({"background-color":d.overlayColor,opacity:d.overlayOpacity,cursor:d.hideOnOverlayClick?"pointer":"auto",height:b(document).height()});if(!u.is(":visible")){M&&b("select:not(#fancybox-tmp select)").filter(function(){return this.style.visibility!=="hidden"}).css({visibility:"hidden"}).one("fancybox-cleanup",function(){this.style.visibility="inherit"});u.show()}}else u.hide();i=X();s=d.title||"";y=0;n.empty().removeAttr("style").removeClass();if(d.titleShow!==false){if(b.isFunction(d.titleFormat))a=d.titleFormat(s,l,p,d);else a=s&&s.length?d.titlePosition=="float"?'<table id="fancybox-title-float-wrap" cellpadding="0" cellspacing="0"><tr><td id="fancybox-title-float-left"></td><td id="fancybox-title-float-main">'+s+'</td><td id="fancybox-title-float-right"></td></tr></table>':'<div id="fancybox-title-'+d.titlePosition+'">'+s+"</div>":false;s=a;if(!(!s||s==="")){n.addClass("fancybox-title-"+d.titlePosition).html(s).appendTo("body").show();switch(d.titlePosition){case"inside":n.css({width:i.width-d.padding*2,marginLeft:d.padding,marginRight:d.padding});y=n.outerHeight(true);n.appendTo(D);i.height+=y;break;case"over":n.css({marginLeft:d.padding,width:i.width-d.padding*2,bottom:d.padding}).appendTo(D);break;case"float":n.css("left",parseInt((n.width()-i.width-40)/2,10)*-1).appendTo(f);break;default:n.css({width:i.width-d.padding*2,paddingLeft:d.padding,paddingRight:d.padding}).appendTo(f)}}}n.hide();if(f.is(":visible")){b(E.add(z).add(A)).hide();a=f.position();r={top:a.top,left:a.left,width:f.width(),height:f.height()};c=r.width==i.width&&r.height==i.height;j.fadeTo(d.changeFade,.3,function(){var g=function(){j.html(m.contents()).fadeTo(d.changeFade,1,S)};b.event.trigger("fancybox-change");j.empty().removeAttr("filter").css({"border-width":d.padding,width:i.width-d.padding*2,height:e.autoDimensions?"auto":i.height-y-d.padding*2});if(c)g();else{B.prop=0;b(B).animate({prop:1},{duration:d.changeSpeed,easing:d.easingChange,step:T,complete:g})}})}else{f.removeAttr("style");j.css("border-width",d.padding);if(d.transitionIn=="elastic"){r=V();j.html(m.contents());f.show();if(d.opacity)i.opacity=0;B.prop=0;b(B).animate({prop:1},{duration:d.speedIn,easing:d.easingIn,step:T,complete:S})}else{d.titlePosition=="inside"&&y>0&&n.show();j.css({width:i.width-d.padding*2,height:e.autoDimensions?"auto":i.height-y-d.padding*2}).html(m.contents());f.css(i).fadeIn(d.transitionIn=="none"?0:d.speedIn,S)}}}},Y=function(){if(d.enableEscapeButton||d.enableKeyboardNav)b(document).bind("keydown.fb",function(a){if(a.keyCode==27&&d.enableEscapeButton){a.preventDefault();b.fancybox.close()}else if((a.keyCode==37||a.keyCode==39)&&d.enableKeyboardNav&&a.target.tagName!=="INPUT"&&a.target.tagName!=="TEXTAREA"&&a.target.tagName!=="SELECT"){a.preventDefault();b.fancybox[a.keyCode==37?"prev":"next"]()}});if(d.showNavArrows){if(d.cyclic&&l.length>1||p!==0)z.show();if(d.cyclic&&l.length>1||p!=l.length-1)A.show()}else{z.hide();A.hide()}},S=function(){if(!b.support.opacity){j.get(0).style.removeAttribute("filter");f.get(0).style.removeAttribute("filter")}e.autoDimensions&&j.css("height","auto");f.css("height","auto");s&&s.length&&n.show();d.showCloseButton&&E.show();Y();d.hideOnContentClick&&j.bind("click",b.fancybox.close);d.hideOnOverlayClick&&u.bind("click",b.fancybox.close);b(window).bind("resize.fb",b.fancybox.resize);d.centerOnScroll&&b(window).bind("scroll.fb",b.fancybox.center);if(d.type=="iframe")b('<iframe id="fancybox-frame" name="fancybox-frame'+(new Date).getTime()+'" frameborder="0" hspace="0" '+(b.browser.msie?'allowtransparency="true""':"")+' scrolling="'+e.scrolling+'" src="'+d.href+'"></iframe>').appendTo(j);f.show();h=false;b.fancybox.center();d.onComplete(l,p,d);var a,c;if(l.length-1>p){a=l[p+1].href;if(typeof a!=="undefined"&&a.match(J)){c=new Image;c.src=a}}if(p>0){a=l[p-1].href;if(typeof a!=="undefined"&&a.match(J)){c=new Image;c.src=a}}},T=function(a){var c={width:parseInt(r.width+(i.width-r.width)*a,10),height:parseInt(r.height+(i.height-r.height)*a,10),top:parseInt(r.top+(i.top-r.top)*a,10),left:parseInt(r.left+(i.left-r.left)*a,10)};if(typeof i.opacity!=="undefined")c.opacity=a<.5?.5:a;f.css(c);j.css({width:c.width-d.padding*2,height:c.height-y*a-d.padding*2})},U=function(){return[b(window).width()-d.margin*2,b(window).height()-d.margin*2,b(document).scrollLeft()+d.margin,b(document).scrollTop()+d.margin]},X=function(){var a=U(),c={},g=d.autoScale,k=d.padding*2;
c.width=d.width.toString().indexOf("%")>-1?parseInt(a[0]*parseFloat(d.width)/100,10):d.width+k;c.height=d.height.toString().indexOf("%")>-1?parseInt(a[1]*parseFloat(d.height)/100,10):d.height+k;if(g&&(c.width>a[0]||c.height>a[1]))if(e.type=="image"||e.type=="swf"){g=d.width/d.height;if(c.width>a[0]){c.width=a[0];c.height=parseInt((c.width-k)/g+k,10)}if(c.height>a[1]){c.height=a[1];c.width=parseInt((c.height-k)*g+k,10)}}else{c.width=Math.min(c.width,a[0]);c.height=Math.min(c.height,a[1])}c.top=parseInt(Math.max(a[3]-20,a[3]+(a[1]-c.height-40)*.5),10);c.left=parseInt(Math.max(a[2]-20,a[2]+(a[0]-c.width-40)*.5),10);return c},V=function(){var a=e.orig?b(e.orig):false,c={};if(a&&a.length){c=a.offset();c.top+=parseInt(a.css("paddingTop"),10)||0;c.left+=parseInt(a.css("paddingLeft"),10)||0;c.top+=parseInt(a.css("border-top-width"),10)||0;c.left+=parseInt(a.css("border-left-width"),10)||0;c.width=a.width();c.height=a.height();c={width:c.width+d.padding*2,height:c.height+d.padding*2,top:c.top-d.padding-20,left:c.left-d.padding-20}}else{a=U();c={width:d.padding*2,height:d.padding*2,top:parseInt(a[3]+a[1]*.5,10),left:parseInt(a[2]+a[0]*.5,10)}}return c},Z=function(){if(t.is(":visible")){b("div",t).css("top",L*-40+"px");L=(L+1)%12}else clearInterval(K)};b.fn.fancybox=function(a){if(!b(this).length)return this;b(this).data("fancybox",b.extend({},a,b.metadata?b(this).metadata():{})).unbind("click.fb").bind("click.fb",function(c){c.preventDefault();if(!h){h=true;b(this).blur();o=[];q=0;c=b(this).attr("rel")||"";if(!c||c==""||c==="nofollow")o.push(this);else{o=b("a[rel="+c+"], area[rel="+c+"]");q=o.index(this)}I()}});return this};b.fancybox=function(a,c){var g;if(!h){h=true;g=typeof c!=="undefined"?c:{};o=[];q=parseInt(g.index,10)||0;if(b.isArray(a)){for(var k=0,C=a.length;k<C;k++)if(typeof a[k]=="object")b(a[k]).data("fancybox",b.extend({},g,a[k]));else a[k]=b({}).data("fancybox",b.extend({content:a[k]},g));o=jQuery.merge(o,a)}else{if(typeof a=="object")b(a).data("fancybox",b.extend({},g,a));else a=b({}).data("fancybox",b.extend({content:a},g));o.push(a)}if(q>o.length||q<0)q=0;I()}};b.fancybox.showActivity=function(){clearInterval(K);t.show();K=setInterval(Z,66)};b.fancybox.hideActivity=function(){t.hide()};b.fancybox.next=function(){return b.fancybox.pos(p+1)};b.fancybox.prev=function(){return b.fancybox.pos(p-1)};b.fancybox.pos=function(a){if(!h){a=parseInt(a);o=l;if(a>-1&&a<l.length){q=a;I()}else if(d.cyclic&&l.length>1){q=a>=l.length?0:l.length-1;I()}}};b.fancybox.cancel=function(){if(!h){h=true;b.event.trigger("fancybox-cancel");N();e.onCancel(o,q,e);h=false}};b.fancybox.close=function(){function a(){u.fadeOut("fast");n.empty().hide();f.hide();b.event.trigger("fancybox-cleanup");j.empty();d.onClosed(l,p,d);l=e=[];p=q=0;d=e={};h=false}if(!(h||f.is(":hidden"))){h=true;if(d&&false===d.onCleanup(l,p,d))h=false;else{N();b(E.add(z).add(A)).hide();b(j.add(u)).unbind();b(window).unbind("resize.fb scroll.fb");b(document).unbind("keydown.fb");j.find("iframe").attr("src",M&&/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank");d.titlePosition!=="inside"&&n.empty();f.stop();if(d.transitionOut=="elastic"){r=V();var c=f.position();i={top:c.top,left:c.left,width:f.width(),height:f.height()};if(d.opacity)i.opacity=1;n.empty().hide();B.prop=1;b(B).animate({prop:0},{duration:d.speedOut,easing:d.easingOut,step:T,complete:a})}else f.fadeOut(d.transitionOut=="none"?0:d.speedOut,a)}}};b.fancybox.resize=function(){u.is(":visible")&&u.css("height",b(document).height());b.fancybox.center(true)};b.fancybox.center=function(a){var c,g;if(!h){g=a===true?1:0;c=U();!g&&(f.width()>c[0]||f.height()>c[1])||f.stop().animate({top:parseInt(Math.max(c[3]-20,c[3]+(c[1]-j.height()-40)*.5-d.padding)),left:parseInt(Math.max(c[2]-20,c[2]+(c[0]-j.width()-40)*.5-d.padding))},typeof a=="number"?a:200)}};b.fancybox.init=function(){if(!b("#fancybox-wrap").length){b("body").append(m=b('<div id="fancybox-tmp"></div>'),t=b('<div id="fancybox-loading"><div></div></div>'),u=b('<div id="fancybox-overlay"></div>'),f=b('<div id="fancybox-wrap"></div>'));D=b('<div id="fancybox-outer"></div>').append('<div class="fancybox-bg" id="fancybox-bg-n"></div><div class="fancybox-bg" id="fancybox-bg-ne"></div><div class="fancybox-bg" id="fancybox-bg-e"></div><div class="fancybox-bg" id="fancybox-bg-se"></div><div class="fancybox-bg" id="fancybox-bg-s"></div><div class="fancybox-bg" id="fancybox-bg-sw"></div><div class="fancybox-bg" id="fancybox-bg-w"></div><div class="fancybox-bg" id="fancybox-bg-nw"></div>').appendTo(f);D.append(j=b('<div id="fancybox-content"></div>'),E=b('<a id="fancybox-close"></a>'),n=b('<div id="fancybox-title"></div>'),z=b('<a href="javascript:;" id="fancybox-left"><span class="fancy-ico" id="fancybox-left-ico"></span></a>'),A=b('<a href="javascript:;" id="fancybox-right"><span class="fancy-ico" id="fancybox-right-ico"></span></a>'));E.click(b.fancybox.close);t.click(b.fancybox.cancel);z.click(function(a){a.preventDefault();b.fancybox.prev()});A.click(function(a){a.preventDefault();b.fancybox.next()});b.fn.mousewheel&&f.bind("mousewheel.fb",function(a,c){if(h)a.preventDefault();else if(b(a.target).get(0).clientHeight==0||b(a.target).get(0).scrollHeight===b(a.target).get(0).clientHeight){a.preventDefault();b.fancybox[c>0?"prev":"next"]()}});b.support.opacity||f.addClass("fancybox-ie");if(M){t.addClass("fancybox-ie6");f.addClass("fancybox-ie6");b('<iframe id="fancybox-hide-sel-frame" src="'+(/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank")+'" scrolling="no" border="0" frameborder="0" tabindex="-1"></iframe>').prependTo(D)}}};b.fn.fancybox.defaults={padding:10,margin:40,opacity:false,modal:false,cyclic:false,scrolling:"auto",width:560,height:340,autoScale:true,autoDimensions:true,centerOnScroll:false,ajax:{},swf:{wmode:"transparent"},hideOnOverlayClick:true,hideOnContentClick:false,overlayShow:true,overlayOpacity:.7,overlayColor:"#777",titleShow:true,titlePosition:"float",titleFormat:null,titleFromAlt:false,transitionIn:"fade",transitionOut:"fade",speedIn:300,speedOut:300,changeSpeed:300,changeFade:"fast",easingIn:"swing",easingOut:"swing",showCloseButton:true,showNavArrows:true,enableEscapeButton:true,enableKeyboardNav:true,onStart:function(){},onCancel:function(){},onComplete:function(){},onCleanup:function(){},onClosed:function(){},onError:function(){}};b(document).ready(function(){b.fancybox.init()})})(jQuery);(function(a){a.fn.mask=function(c,b){a(this).each(function(){if(b!==undefined&&b>0){var d=a(this);d.data("_mask_timeout",setTimeout(function(){a.maskElement(d,c)},b))}else{a.maskElement(a(this),c)}})};a.fn.unmask=function(){a(this).each(function(){a.unmaskElement(a(this))})};a.fn.isMasked=function(){return this.hasClass("masked")};a.maskElement=function(d,c){if(d.data("_mask_timeout")!==undefined){clearTimeout(d.data("_mask_timeout"));d.removeData("_mask_timeout")}if(d.isMasked()){a.unmaskElement(d)}if(d.css("position")=="static"){d.addClass("masked-relative")}d.addClass("masked");var e=a('<div class="loadmask"></div>');if(navigator.userAgent.toLowerCase().indexOf("msie")>-1){e.height(d.height()+parseInt(d.css("padding-top"))+parseInt(d.css("padding-bottom")));e.width(d.width()+parseInt(d.css("padding-left"))+parseInt(d.css("padding-right")))}if(navigator.userAgent.toLowerCase().indexOf("msie 6")>-1){d.find("select").addClass("masked-hidden")}d.append(e);if(c!==undefined){var b=a('<div class="loadmask-msg" style="display:none;"></div>');b.append("<div>"+c+"</div>");d.append(b);b.css("top",Math.round(d.height()/2-(b.height()-parseInt(b.css("padding-top"))-parseInt(b.css("padding-bottom")))/2)+"px");b.css("left",Math.round(d.width()/2-(b.width()-parseInt(b.css("padding-left"))-parseInt(b.css("padding-right")))/2)+"px");b.show()}};a.unmaskElement=function(b){if(b.data("_mask_timeout")!==undefined){clearTimeout(b.data("_mask_timeout"));b.removeData("_mask_timeout")}b.find(".loadmask-msg,.loadmask").remove();b.removeClass("masked");b.removeClass("masked-relative");b.find("select").removeClass("masked-hidden")}})(jQuery);function Colour(){this.getIntegerRGB=function(){var rgb=this.getRGB();return{r:Math.round(rgb.r),g:Math.round(rgb.g),b:Math.round(rgb.b),a:rgb.a}};this.getPercentageRGB=function(){var rgb=this.getRGB();return{r:100*rgb.r/255,g:100*rgb.g/255,b:100*rgb.b/255,a:rgb.a}};this.getCSSHexadecimalRGB=function(){var rgb=this.getIntegerRGB();var r16=rgb.r.toString(16);var g16=rgb.g.toString(16);var b16=rgb.b.toString(16);return"#"+(r16.length==2?r16:"0"+r16)+(g16.length==2?g16:"0"+g16)+(b16.length==2?b16:"0"+b16)};this.getCSSIntegerRGB=function(){var rgb=this.getIntegerRGB();return"rgb("+rgb.r+","+rgb.g+","+rgb.b+")"};this.getCSSIntegerRGBA=function(){var rgb=this.getIntegerRGB();return"rgb("+rgb.r+","+rgb.g+","+rgb.b+","+rgb.a+")"};this.getCSSPercentageRGB=function(){var rgb=this.getPercentageRGB();return"rgb("+rgb.r+"%,"+rgb.g+"%,"+rgb.b+"%)"};this.getCSSPercentageRGBA=function(){var rgb=this.getPercentageRGB();return"rgb("+rgb.r+"%,"+rgb.g+"%,"+rgb.b+"%,"+rgb.a+")"};this.getCSSHSL=function(){var hsl=this.getHSL();return"hsl("+hsl.h+","+hsl.s+"%,"+hsl.l+"%)"};this.getCSSHSLA=function(){var hsl=this.getHSL();return"hsl("+hsl.h+","+hsl.s+"%,"+hsl.l+"%,"+hsl.a+")"};this.setNodeColour=function(node){node.style.color=this.getCSSHexadecimalRGB()};this.setNodeBackgroundColour=function(node){node.style.backgroundColor=this.getCSSHexadecimalRGB()}}RGBColour.prototype=new Colour;function RGBColour(r,g,b,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var rgb={r:Math.max(0,Math.min(255,r)),g:Math.max(0,Math.min(255,g)),b:Math.max(0,Math.min(255,b))};var hsv=null;var hsl=null;function getHue(maximum,range){if(range==0){var hue=0}else{switch(maximum){case rgb.r:var hue=(rgb.g-rgb.b)/range*60;if(hue<0)hue+=360;break;case rgb.g:var hue=(rgb.b-rgb.r)/range*60+120;break;case rgb.b:var hue=(rgb.r-rgb.g)/range*60+240;break}}return hue}function calculateHSV(){var maximum=Math.max(rgb.r,rgb.g,rgb.b);var range=maximum-Math.min(rgb.r,rgb.g,rgb.b);hsv={h:getHue(maximum,range),s:maximum==0?0:100*range/maximum,v:maximum/2.55}}function calculateHSL(){var maximum=Math.max(rgb.r,rgb.g,rgb.b);var range=maximum-Math.min(rgb.r,rgb.g,rgb.b);var l=maximum/255-range/510;hsl={h:getHue(maximum,range),s:range==0?0:range/2.55/(l<.5?l*2:2-l*2),l:100*l}}this.getRGB=function(){return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){if(hsv==null)calculateHSV();return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){if(hsl==null)calculateHSL();return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}HSVColour.prototype=new Colour;function HSVColour(h,s,v,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var hsv={h:(h%360+360)%360,s:Math.max(0,Math.min(100,s)),v:Math.max(0,Math.min(100,v))};var rgb=null;var hsl=null;function calculateRGB(){if(hsv.s==0){var r=hsv.v;var g=hsv.v;var b=hsv.v}else{var f=hsv.h/60-Math.floor(hsv.h/60);var p=hsv.v*(1-hsv.s/100);var q=hsv.v*(1-hsv.s/100*f);var t=hsv.v*(1-hsv.s/100*(1-f));switch(Math.floor(hsv.h/60)){case 0:var r=hsv.v;var g=t;var b=p;break;case 1:var r=q;var g=hsv.v;var b=p;break;case 2:var r=p;var g=hsv.v;var b=t;break;case 3:var r=p;var g=q;var b=hsv.v;break;case 4:var r=t;var g=p;var b=hsv.v;break;case 5:var r=hsv.v;var g=p;var b=q;break}}rgb={r:r*2.55,g:g*2.55,b:b*2.55}}function calculateHSL(){var l=(2-hsv.s/100)*hsv.v/2;hsl={h:hsv.h,s:hsv.s*hsv.v/(l<50?l*2:200-l*2),l:l};if(isNaN(hsl.s))hsl.s=0}this.getRGB=function(){if(rgb==null)calculateRGB();return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){if(hsl==null)calculateHSL();return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}HSLColour.prototype=new Colour;function HSLColour(h,s,l,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var hsl={h:(h%360+360)%360,s:Math.max(0,Math.min(100,s)),l:Math.max(0,Math.min(100,l))};var rgb=null;var hsv=null;function calculateRGB(){if(hsl.s==0){rgb={r:hsl.l*2.55,g:hsl.l*2.55,b:hsl.l*2.55}}else{var p=hsl.l<50?hsl.l*(1+hsl.s/100):hsl.l+hsl.s-hsl.l*hsl.s/100;var q=2*hsl.l-p;rgb={r:(h+120)/60%6,g:h/60,b:(h+240)/60%6};for(var key in rgb){if(rgb.hasOwnProperty(key)){if(rgb[key]<1){rgb[key]=q+(p-q)*rgb[key]}else if(rgb[key]<3){rgb[key]=p}else if(rgb[key]<4){rgb[key]=q+(p-q)*(4-rgb[key])}else{rgb[key]=q}rgb[key]*=2.55}}}}function calculateHSV(){var t=hsl.s*(hsl.l<50?hsl.l:100-hsl.l)/100;hsv={h:hsl.h,s:200*t/(hsl.l+t),v:t+hsl.l};if(isNaN(hsv.s))hsv.s=0}this.getRGB=function(){if(rgb==null)calculateRGB();return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){if(hsv==null)calculateHSV();return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}var MashableData={globals:{totalServerTime:0,isEmbedded:window.location.hostname.indexOf("www.mashabledata.com")===-1||window.location.pathname.indexOf("workbench")===-1,isDev:window.location.hostname.indexOf("www.mashabledata.com")!==-1&&window.location.pathname.indexOf("workbenchdev")!==-1,lang:{decimalPoint:".",thousandsSep:","},BAND_TRANSPARENCY:.5,colorsPlotBands:["aaaaaa","ffaaaa","aaffaa","aaaaff"],standardAnnotations:[],iconsHMTL:{mapset:'<span class="ui-icon ui-icon-mapset" title="series is part of a map set"></span>',pointset:'<span class="ui-icon ui-icon-pointset" title="series is part of a set of markers (defined longitude and latitude)"></span>',hasCubeViz:'<span class="ui-icon ui-icon-cube" title="map has supplemental visualizations"></span>',hasHeatMap:'<span class="ui-icon ui-icon-mapset" title="contains a heat-map"></span>',hasMarkerMap:'<span class="ui-icon ui-icon-pointset" title="contains sets of mapped markers (defined longitude and latitude)."></span>',hasBubbleMap:'<span class="ui-icon ui-icon-bubble" title="bubble map of data aggregated into user-defined regions"></span>'},themeCubes:{},panelGraphs:{},MySets:{},MyGraphs:{},MAP_COLORS:{POS:"#0071A4",NEG:"#FF0000",MID:"#E5E5E5"},DEFAULT_RADIUS_SCALE:30,DEFAULT_RADIUS_FIXED:10,hcColors:["#2f7ed8","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92","#0d233a"],primeColors:["#008000","#FF0000","#0000FF","#FFFF00","#FF9900","#00FFFF","#FF0000"],dashStyles:["Solid","Short Dash","Short Dot","Short Dash Dot","Short Dash Dot Dot","Dot","Dash","Long Dash","Dash Dot","Long Dash Dot","Long Dash Dot Dot"],period:{value:{N:1e3,D:24*3600*1e3,W:7*24*3600*1e3,M:30*24*3600*1e3,Q:365/4*24*3600*1e3,SA:365/2*24*3600*1e3,A:365*24*3600*1e3},order:["N","D","W","M","Q","SA","A"],name:{N:"non period data",D:"daily",W:"weekly",M:"monthly",Q:"quarterly",SA:"semiannual",A:"annual"},units:{N:"non-periodic data",D:"day",W:"week",M:"month",Q:"quarter",SA:"half-year",A:"year"}},op:{value:{"+":1,"-":2,"*":3,"/":4},cssClass:{"+":"op-addition","-":"op-subtraction","*":"op-multiply","/":"op-divide"}},mapBackground:"#AAAAAA",graphScriptFiles:["/global/js/highcharts/js/modules/exporting.src.js","/global/js/colorpicker/jquery.colorPicker.min.js","/global/js/colour/Colour.js","/global/js/jvectormap/jquery-jvectormap-2.0.1.min.js"],rowPosition:{name:0,units:1,source:2,notes:3,region:4,lat_lon:5,date:6,dataStart:7},patVariable:/(\b[A-Z]{1,2}\b)/g,isIE:/msie/i.test(navigator.userAgent)&&!window.opera,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],mapModes:{heat:"colored heat map of values","abs-change":"colored heat map of changes","percent-change":"colored heat map of percent changes",bubbles:"overlay circles to show values","change-bubbles":"overlay circles to show changes",correlation:"correlation (requires two maps)",treemap:"abstract values to rectangles","change-treemap":"abstract change to rectangles"}}};if(typeof console=="undefined")console={info:function(m){},log:function(m){}};MashableData.common={numberFormat:function numberFormat(number,decimals,decPoint,thousandsSep){var lang=MashableData.globals.lang,n=+number||0,c=decimals===-1?(n.toString().split(".")[1]||"").length:isNaN(decimals=Math.abs(decimals))?2:decimals,d=decPoint===undefined?lang.decimalPoint:decPoint,t=thousandsSep===undefined?lang.thousandsSep:thousandsSep,s=n<0?"-":"",i=String(parseInt(n=Math.abs(n).toFixed(c))),j=i.length>3?i.length%3:0;return s+(j?i.substr(0,j)+t:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+t)+(c?d+Math.abs(n-i).toFixed(c).slice(2):"")},octet:function octet(s){s=s.toString(16);return(s.length==1?0:"")+s},mustacheRegex:/{{([^}]+)}}/g,mustache:function(template,valuesObject){rep=template.match(this.mustacheRegex);if(valuesObject){var key,searchRegex;for(key in valuesObject){searchRegex=new RegExp("{{"+key+"}}","g");template=template.replace(searchRegex,valuesObject[key])}}return template},mashableDataString:function mashableDataString(serie){var i,points=[];if(typeof serie.data=="string"){return serie.data}else{for(i=0;i<serie.data.length;i++){points.push(mashableDate(serie.data[i][0],serie.period)+":"+(isNaN(serie.data[i][1])||serie.data[i][1]===null?"null":serie.data[i][1]))}return points.join("|")}},mashableDate:function mashableDate(jsDate,period){var dt=new Date(parseInt(jsDate));var mdDate=dt.getUTCFullYear();switch(period){case"M":mdDate+=(dt.getUTCMonth().toString().length==1?"0":"")+dt.getUTCMonth();break;case"Q":mdDate+="Q"+parseInt((dt.getUTCMonth()+3)/3);break;case"SA":mdDate+="H"+parseInt((dt.getUTCMonth()+6)/6);break;case"W":case"D":mdDate+=(dt.getUTCMonth().toString().length==1?"0":"")+dt.getUTCMonth();mdDate+=(dt.getUTCDate().toString().length==1?"0":"")+dt.getUTCDate();break}return mdDate},dateFromMdDate:function dateFromMdDate(mddt){var udt;udt=new Date("1/1/"+mddt.substr(0,4)+" UTC");if(mddt.length>4){switch(mddt.substr(4,1)){case"Q":udt.period="Q";udt.setUTCMonth((mddt.substr(5,1)-1)*3);break;case"H":udt.period="H";udt.setUTCMonth((mddt.substr(5,1)-1)*6);break;default:udt.period="M";udt.setUTCMonth(mddt.substr(4,2))}if(mddt.length>6){udt.period="D";udt.setUTCDate(mddt.substr(6,2));if(mddt.length>8){udt.setUTCHours(mddt.substr(9,2));udt.setUTCMinutes(mddt.substr(12,2));udt.setUTCSeconds(mddt.substr(15,2))}}}return udt},dateConversionData:function dateConversionData(series){var key=series.sourcekey,jsStart=false,jsEnd=false,period=MashableData.globals.period;if(series.firstdt)jsStart=new Date(parseInt(series.firstdt));if(series.lastdt)jsEnd=new Date(parseInt(series.lastdt));var data=[],altStart;var oneDay=24*60*60*1e3;var today=new Date;var mashableDate=this.mashableDate;switch(key.toUpperCase()){case"DAYSPERMONTH":if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-"+(jsEnd.getUTCMonth()+1)+"-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-12-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-"+(jsStart.getUTCMonth()+1)+"-01 UTC")}else{jsStart=new Date(jsEnd.getTime());jsStart.setUTCMonth(jsStart.getUTCMonth()-119)}while(jsStart<=jsEnd){data.push(mashableDate(jsStart.getTime(),"M")+":"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCMonth(jsStart.getUTCMonth()+1))/oneDay))}break;case"DAYSPERQUARTER":if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-"+(jsEnd.getUTCMonth()+3)+"-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-12-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-"+(jsStart.getUTCMonth()+3)+"-01 UTC")}else{jsStart=new Date(jsEnd.getTime());jsStart.setUTCMonth(jsStart.getUTCMonth()-119)}while(jsStart<=jsEnd){data.push(mashableDate(jsStart.getTime(),"Q")+":"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCMonth(jsStart.getUTCMonth()+3))/oneDay))}break;case"DAYSPERYEAR":if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-01-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-01-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-01-01 UTC")}else{jsStart=new Date(jsEnd.getUTCFullYear()-20+"-01-01 UTC")}while(jsStart<=jsEnd){data.push(mashableDate(jsStart.getTime(),"A")+":"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCFullYear(jsStart.getUTCFullYear()+1))/period.value.D))}break}series.data=data;return data},selectDownshift:function selectDownshift(graph,fdown,plot,callback){var i,asset;var html='<div id="downshiftWizard" style="width:600px;">'+"<h4>Frequency Shifting:</h4>";if(fdown)html+="You have selected to have the plot recalculated as <b></b>"+period.name[fdown]+"</b>.  Please select the method and treatment of missing and null values.<br>";else html+="You have requested to mash series with different frequencies.  This will require first recalculating the series data having a shorter reporting period to a common longer period.  Please confirm by selecting the algorithm and the treatment of missing and null values.<br>";html+="<br>Component series that must be recalculated:"+"<ol>";plot.eachComponent(function(){html+="<li><b>"+this.name()+"</b> ("+this.units+") "+common.period.name[fdown=="A"&&(this.freqset.indexOf(Q)==-1?"Q":"M")]+"</li>"});html+="</ol>"+"<br>Each component series will be individual recalculated as needed to the new frequency by:<br>"+'<label><input type="radio" name="dsw_algor" value="sum"> simple summation</label><br>'+'<label><input type="radio" name="dsw_algor" value="wavg"> day-weighted average</label><br>'+"<br>If some of the values used to calculate a new datum point are are null or missing (e.g. a month is missing when calulating an annual value):<br>"+'<label><input type="radio" name="dsw_missing" value="null"> the computed value for the datum will be null (i.e. all sub-values are required)</label><br>'+'<label><input type="radio" name="dsw_missing" value="zero"> treat as if the value were zero</label><br>'+'<label><input type="radio" name="dsw_missing" value="impute"> estimate value to be the day-weighted average of new period\'s existing component values if at least three-quarters of the component values exist</label><br>'+'<span class="ui-state-error warning-box"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span>WARNING: Change frequencies and use estimates with care.  Summations produce valid results for monthly production quantities, whereas day-weighted averages are statistically correct for rates where the implied denominator is constant.<br><br>For more information, see <a href="/workbench-help/changing-frequency/" traget="_blank" class="link">changing frequencies help</a>.</span>'+'<button id="dsw_ok" class="right">OK</button> <button id="dsw_cancel" class="right">cancel</button>'+"</div>";$.fancybox(html,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var $dsw=$("#downshiftWizard");$("#dsw_ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var downshift={algorithm:$dsw.find("input:radio[name='dsw_algor']:checked").val(),missing:$dsw.find("input:radio[name='dsw_missing']:checked").val()};if(downshift.algorithm&&downshift.missing){callback(downshift);$.fancybox.close()}else{dialogShow("error","All form selections are required.")}});$("#dsw_cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close();callback(false)})},downShiftData:function downShiftData(asset,fdown,algorithm,missing){var period=MashableData.globals.period;if(period.value[fdown]==period.value[asset.period])return asset.data;if(period.value[fdown]<period.value[asset.period]||fdown!="A"&&fdown!="Q"||period.value[asset.period]<period.value["M"])throw"unable to change data frequency from "+period.name[asset.period]+" to "+period.name[fdown];var aData=asset.data.split("|"),newData=[],bin=[],lengthInMonths=fdown=="Q"?3:12,lengthAssetPeriod=asset.period=="M"?1:3,periodsStartDate=false,mdDate,point,pointDate;for(var i=0;i<aData.length;i++){point=aData[i].split(":");pointDate=this.dateFromMdDate(point[0]);if(periodsStartDate===false||pointDate.getUTCMonth()-periodsStartDate.getUTCMonth()>lengthInMonths-1||pointDate.getUTCFullYear()!=periodsStartDate.getUTCFullYear()){if(bin.length!=0){newData.push(downShiftDatum());bin=[]}periodsStartDate=new Date(pointDate.getUTCFullYear()+"-"+(Math.floor(pointDate.getUTCMonth()/lengthInMonths)*lengthInMonths+1)+"-1 UTC")}bin[pointDate.getUTCMonth()]=point[1]}if(bin.length!=0)newData.push(downShiftDatum());return newData;function downShiftDatum(){var subPeriodDays,valueDays=0,missingDays=0,missingPeriods=0,newY=0;mdDate=MashableData.common.mashableDate(periodsStartDate.getTime(),fdown);var startMonth=periodsStartDate.getUTCMonth();for(var j=startMonth;j<startMonth+lengthInMonths;j=j+lengthAssetPeriod){subPeriodDays=-Math.round(periodsStartDate.getTime()-periodsStartDate.setUTCMonth(periodsStartDate.getUTCMonth()+lengthAssetPeriod)/period.value.D);if(typeof bin[j]=="undefined"||bin[j]===null){if(missing=="null"){return mdDate+"|null"}bin[j]=0;if(missing=="impute"){missingPeriods++;missingDays+=subPeriodDays;valueDays-=subPeriodDays}}switch(algorithm){case"wavg":newY+=parseFloat(bin[j])*subPeriodDays;valueDays+=subPeriodDays;break;case"sum":newY+=parseFloat(bin[j]);break;default:throw"unrecognized down frequency conversion algorithm"}}if(missingDays!=0&&newY!="null")newY=newY*(valueDays+missingDays)/valueDays;return mdDate+":"+(algorithm=="wavg"?newY/valueDays:newY)}},rationalize:function rationalize(value){if(Math.log(Math.abs(value))>-13)return Math.round(value*Math.pow(10,10))/Math.pow(10,10);else return value},equivalentRGBA:function equivalentRGBA(hexColor,alpha){var r,g,b;if(hexColor.substr(0,1)=="#")hexColor=hexColor.substr(1);r=gun(parseInt(hexColor.substr(0,2),16),alpha);g=gun(parseInt(hexColor.substr(2,2),16),alpha);b=gun(parseInt(hexColor.substr(4,2),16),alpha);if(r>0&&g>0&&b>0){return"rgba("+r+","+g+","+b+","+alpha+")"}else{return"rgb("+parseInt(hexColor.substr(0,2),16)+","+parseInt(hexColor.substr(2,2),16)+","+parseInt(hexColor.substr(4,2),16)+")"}function gun(desired,alpha){return parseInt(desired/alpha-(1-alpha)*255/alpha)}},addBreaks:function addBreaks(seriesData,freq){var data=seriesData.slice(0);data.sort(function(a,b){return a[0]-b[0]});var oData=[];if(data.length>0)oData.push([data[0][0],data[0][1]]);var interval;switch(freq){case"T":case"N":case"D":case"W":maxInterval=Date.UTC(2e3,0,9)-Date.UTC(2e3,0,1);break;case"M":maxInterval=Date.UTC(2e3,1,2)-Date.UTC(2e3,0,1);break;case"SA":maxInterval=Date.UTC(2e3,7,2)-Date.UTC(2e3,0,1);break;default:maxInterval=Date.UTC(2001,2)-Date.UTC(2e3,1)}for(var i=1;i<data.length;i++){if(data[i-1][1]!=null&&data[i][1]!=null&&data[i][0]-data[i-1][0]>maxInterval){var interDate=new Date(data[i][0]);switch(freq){case"d":case"w":interDate.setDate(interDate.getDate()+7);break;case"4":interDate.setDate(interDate.getDate()+28);break;case"m":interDate.setMonth(interDate.getMonth()+1);break;default:interDate.setMonth(interDate.getMonth()+12)}data.splice(i,0,[parseInt(interDate),null]);i++}}return data},callApi:function callApi(params,callBack){var data,embed=MashableData.globals.isEmbedded,callStartTime=new Date;if(embed){data=$.extend({uid:false,host:window.location.host},params)}else{data=$.extend({uid:getUserId(),version:workbenchVersion,accessToken:account.info.accessToken},params)}if(!embed&&params.modal!="none")mask();$.ajax({type:embed?"GET":"POST",url:embed?"//www.mashabledata.com/global/js/maps":"api.php",encoding:"UTF-8",cache:false,data:data,dataType:"json",success:function(jsoData,textStatus,jqXHR){if(MashableData.globals.isDev)console.info(jsoData);if(jsoData.status=="ok"){if(!embed){globals.totalServerTime+=parseFloat(jsoData.exec_time);if(jsoData.msg)dialogShow("",jsoData.msg);var callEndTime=new Date;console.info(params.command+": "+jsoData.exec_time+" (total server time: "+globals.totalServerTime+"ms); roundtrip: "+(callEndTime.getTime()-callStartTime.getTime())+"ms; "+JSON.stringify(jsoData).length/1e3+"kb")}if(callBack)callBack(jsoData,textStatus,jqXHR);if(params.modal!="persist"&&!embed)unmask()}else{if(embed){return jsoData.status}else{unmask();dialogShow("Connected to server, but the command failed.",jsoData.status+'<br><br>If this is a system error and continues to occur, please email <a href="mailto:support@mashabledata.com">support@mashabledata.com</a>.')}}},error:function(jqXHR,textStatus,errorThrown){console.log(textStatus);console.log(jqXHR);if(embed){return"A system error occurred while trying to connect to the MashableData servers.  Please try again later"}else{unmask();dialogShow(textStatus,"A system error occurred while trying to connect to the server.  Check your internet connectivity and try again later.")}}})},setFactory:function(recordset){var newSets=[];for(var i=0;i<recordset.length;i++){newSets.push(new MashableData.Set(recordset[i]))}return newSets},placeName:function(setName,seriesName){var setWords=setName.split(" "),position;var placeName=" "+seriesName+" ";for(var i=0;i<setWords.length;i++){if(setWords[i].length){while(-1!=(position=placeName.indexOf(" "+setWords[i]+" "))){placeName=placeName.substr(0,position)+placeName.substr(position+setWords[i].length+1)}}}return placeName.trim()}};MashableData.Set=function(SetParams){if(Object.prototype.toString.call(SetParams)=="[object String]"){var nextChar,pos=0,handle=SetParams;this.type=handle[pos++];this.setid=parseInt(handle.substring(pos));pos+=this.setid.toString().length;if(handle.length>pos){nextChar=handle[pos++];if(MashableData.globals.period.name[nextChar]){this.freq=nextChar;if(handle.length>pos)nextChar=handle[pos++];else nextChar=""}if(nextChar=="G"){this.geoid=parseInt(handle.substring(pos));if(handle.length>pos)nextChar=handle[pos++];else nextChar=""}if(nextChar=="L"){this.latlon=handle.substring(pos)}}}else{for(var param in SetParams){if(SetParams.hasOwnProperty(param)){this[param]=SetParams[param]}}}if(this.maps&&typeof this.maps=="string")this.maps=JSON.parse("{"+this.maps+"}");this.parsedData();if(this.freqs&&!Array.isArray(this.freqs))this.freqs=this.freqs.split(",");return this};(function(){var MD=MashableData,globals=MD.globals,grapher=MD.grapher,Set=MD.Set,Graph=MD.Graph;MashableData.Set.prototype.parsedData=function(updatedData){if(updatedData)this.data=updatedData;if(this.data){if(this.isSeries()){if(typeof this.data=="string")this.data=this.data.split("|")}else{for(var key in this.data){if(typeof this.data[key]=="string"){this.data[key]=this.data[key].split("|")}else break}}return this.data}else{return false}};MashableData.Set.prototype.fetchData=function(settings,callBack){var self=this;if(settings){if(settings.f){this.f=MashableData.globals.periodPref=settings.f}if(settings.mapFilter&&settings.mapFilter!="all")this.options.mapFilter=settings.mapFilter;if(typeof settings.geoid!="undefined"){this.geoid=settings.geoid;delete this.options.mapFilter}if(settings.map){}else{var thisHandle=this.handle();var params={command:"GetMashableData",handles:{}};params.handles[thisHandle]={setid:this.setid,freq:this.preferedFreq()};if(this.geoid)params.handles[thisHandle].geoid=this.geoid;if(this.latLon)params.handles[thisHandle].latlon=this.latlon;if(this.options.mapFilter)params.handles[thisHandle].mapFilter=this.options.mapFilter;callApi(params,function(jsoData,textStatus,jqXH){self.parsedData(jsoData.series[thisHandle].data);self.freq=self.preferedFreq();self.notes=jsoData.series[thisHandle].notes;self.geocounts=jsoData.series[thisHandle].geocounts;callBack()})}}};MashableData.Set.prototype.preferedFreq=function(){if(this.freq)return this.freq;if(MashableData.globals.periodPref&&this.freqs.indexOf(MashableData.globals.periodPref)!==-1)return MashableData.globals.periodPref;if(this.freqs.indexOf("M")!==-1)return"M";if(this.freqs.indexOf("A")!==-1)return"A";if(this.freqs.indexOf("Q")!==-1)return"Q";if(this.freqs.indexOf("H")!==-1)return"H";return this.freqs[0]};MashableData.Set.prototype.name=function(){if(!this.isSeries()){return this.setname}else{if(this.seriesname)return this.seriesname}var name=this.setname,elipseCode="&hellip;",pos;if(this.geoname){pos=name.indexOf(elipseCode);if(pos>=0){name.replace(elipseCode,this.geoname)}else name+=": "+this.geoname}return name};MashableData.Set.prototype.handle=function(){var handle=this.settype+this.setid+this.preferedFreq();
if(this.geoid)handle+="G"+this.geoid;if(this.latlon)handle+="L"+this.latlon;return handle};MashableData.Set.prototype.clone=function(){var original=this;var clone=new MashableData.Set(original);return clone};MashableData.Set.prototype.isSeries=function(){return this.freq&&(this.geoid||this.latlon)?true:false};MashableData.Set.prototype.isMapSet=function(){return this.freq&&(!this.geoid&&!this.latlon)&&this.settype=="M"?true:false};MashableData.Set.prototype.isPointSet=function(){return this.freq&&!this.latlon&&this.settype=="X"?true:false};MashableData.Set.prototype.mapList=function(){if(this.maps){var mapCode,mapNames=[],minMappable=this.settype=="X"?0:1;for(mapCode in this.maps){if(this.maps[mapCode]>minMappable&&globals.maps[mapCode])mapNames.push(globals.maps[mapCode].name)}return mapNames.join("; ")}else return""}})();MashableData.Component=function(SetParams,componentOptions){MashableData.Set.call(this,SetParams);this.options=$.extend({k:1,op:"+"},componentOptions||{});return this};MashableData.Component.prototype=Object.create(MashableData.Set.prototype);MashableData.Component.prototype.clone=function(){var thisComp=this;var clone=new MashableData.Component(thisComp,thisComp.options);return clone};MashableData.Plot=function(components,options){this.components=components||[];this.options=options||{};return this};(function(){var MD=MashableData,common=MD.common,globals=MD.globals,grapher=MD.grapher,Plot=MD.Plot;Plot.prototype.removeCompnent=function(components,options){this.components=components||[];this.options=options||{};return this};Plot.prototype.name=function(newName){var handle,comp,c,calcName="";if(typeof newName!="undefined"&&newName!==false){if(newName&&newName.trim()){this.options.name=newName}else{delete this.options.name}}if(this.options.name&&newName!==false){return this.options.name}else{var isDenom=false;for(c=0;c<this.components.length;c++){comp=this.components[c];handle=comp.handle();calcName+=(c!=0&&comp.options.op?comp.options.dn=="d"&&!isDenom?" / ":" "+comp.options.op+" ":" ")+comp.name();isDenom=comp.options.dn=="d"||isDenom}return calcName}};Plot.prototype.freq=function(){return this.options.fdown||this.components[0].freq};Plot.prototype.units=function plotUnits(forceCalculated,formulaObj){var c,i,terms,numUnits="",denomUnits="",graph=this.graph,plot=this;if(plot.components.length==1){return plot.options.units||(plot.components[0].options.op=="/"?"per ":"")+plot.components[0].units||""}if(!plot.options.units||forceCalculated){if(!formulaObj)formulaObj=plot.calculateFormula();var numerUnits=formulaObj.numFormula;var denomFormula=formulaObj.denomFormula;replaceFormula("^(-)?(1)?","");var patKs=/[0-9]+/g;var scalorFlag=patKs.test(numerUnits)||patKs.test(denomFormula);numerUnits=numerUnits.replace(patKs," ");denomFormula=denomFormula.replace(patKs," ");var patRemoveOps=/(\*|\(|\))/g;numerUnits=numerUnits.replace(patRemoveOps," ");denomFormula=denomFormula.replace(patRemoveOps," ");var patPer=/\//g;numerUnits=numerUnits.replace(patPer," per ");denomFormula=denomFormula.replace(patPer," per ");var patMinus=/-/g;numerUnits=numerUnits.replace(patMinus,"+");denomFormula=denomFormula.replace(patMinus,"+");var patWhiteSpace=/[\s]+/g;numerUnits=numerUnits.replace(patWhiteSpace," ");denomFormula=denomFormula.replace(patWhiteSpace," ");replaceFormula("([A-Z]+)","{{$1}}");var patPlus=/\+/g;for(c=0;c<plot.components.length;c++){replaceFormula("{{"+this.compSymbol(c)+"}}",(plot.components[c].units||"").replace(patPlus," "))}var error=false;if(numerUnits!=""){terms=numerUnits.split("+");numerUnits=terms[0].trim();for(i=1;i<terms.length;i++){if(terms[i].trim()!=numerUnits)error=true}}if(denomFormula!=""){terms=denomFormula.split("+");denomUnits=terms[0].trim();for(i=1;i<terms.length;i++){if(terms[i].trim()!=terms[0])error=true}}if(error){return"potentially mismatched units"}else{if(numerUnits==denomUnits&&numerUnits.length>0){return"ratio"}else{return(scalorFlag?"user scaled ":"")+numerUnits+(denomUnits==""?"":" per "+denomUnits)}}}else{return plot.options.units}function replaceFormula(search,replace){var pat=new RegExp(search,"g");numerUnits=numerUnits.replace(pat,replace);denomUnits=denomUnits.replace(pat,replace)}};Plot.prototype.calculateFormula=function plotFormula(){var cmp,variable,isDenom=false,inDivision=false,numFormula="",denomFormula="",term="",formula="";var patMultiterm=/[+-/*]+/;for(var i=0;i<this.components.length;i++){cmp=this.components[i];variable=this.compSymbol(i);if(!isDenom&&cmp.options.dn&&cmp.options.dn=="d"){if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term}numFormula=formula;formula="";isDenom=true}if(formula.length==0){switch(cmp.options.op){case"/":inDivision=true;term=subTerm();formula="1/";break;case"-":formula="-"+subTerm();break;case"+":case"*":default:formula=subTerm()}}else{switch(cmp.options.op){case"+":case"-":if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term+" "+cmp.options.op+" "+subTerm()}else{formula+=" "+cmp.options.op+" "+subTerm()}break;case"*":if(inDivision){term+="*"+subTerm()}else{formula+="*"+subTerm()}break;case"/":if(inDivision){term+="*"+subTerm()}else{inDivision=true;formula+="/";term=subTerm()}}}}if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term}if(isDenom){denomFormula=formula}else{numFormula=formula}if((this.options.k||1)==1){if(isDenom){formula=(numFormula==""?1:patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)+" / "+(patMultiterm.test(denomFormula)?"("+denomFormula+")":denomFormula)}else{formula=numFormula}}else{if(isDenom){formula=this.options.k+" * "+(numFormula=""?"":patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)+" / "+(patMultiterm.test(denomFormula)?"("+denomFormula+")":denomFormula)}else{formula=this.options.k+" * "+(patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)}}this.calculatedFormula={formula:formula,denomFormula:denomFormula,numFormula:numFormula,k:this.options.k||1};return this.calculatedFormula;function subTerm(){return isNaN(cmp.options.k)||cmp.options.k==1?variable:cmp.options.k+"*"+variable}};Plot.prototype.formula=function formula(){if(this.options.userFormula)return this.options.userFormula;if(!this.calculatedFormula)this.calculateFormula();return this.calculatedFormula.formula};Plot.prototype.createHighSeries=function(){console.time("createHighSeries");var valuesObject,y,i,j,highSeries,data,point,plotData=[],dateKey,oComponentData={};var plot=this,components=plot.components;highSeries={name:plot.name(),units:plot.units()};components=plot.components;highSeries.freq=plot.options.fdown||components[0].freq;var formula=plot.formula();var expression="return "+formula.replace(globals.patVariable,"values.$1")+";";var compute=new Function("values",expression);var compSymbols=[],symbol;for(i=0;i<components.length;i++){symbol=plot.compSymbol(i);compSymbols.push(symbol);if(plot.options.fdown&&plot.options.fdown!=components[i].freq){data=common.downShiftData(components[i],plot.options.fdown,plot.options.algorithm,plot.options.missing)}else{data=components[i].parsedData()}for(j=0;j<data.length;j++){point=data[j].split(":");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]}}var required=!plot.options.componentData||plot.options.componentData=="required";var missingAsZero=plot.options.componentData=="missingAsZero";var nullsMissingAsZero=plot.options.componentData=="nullsMissingAsZero";var breakNever=!plot.options.breaks||plot.options.breaks=="never";var breakNulls=plot.options.breaks=="nulls";var breakMissing=plot.options.breaks=="missing";for(dateKey in oComponentData){valuesObject={};y=true;for(i=0;i<compSymbols.length;i++){if(!isNaN(oComponentData[dateKey][compSymbols[i]])){valuesObject[compSymbols[i]]=parseFloat(oComponentData[dateKey][compSymbols[i]])}else{if(oComponentData[dateKey][compSymbols[i]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{if(required){y=null;break}else{valuesObject[compSymbols[i]]=0}}}}if(y){try{y=compute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null||!breakNever){if(y!==null)y=common.rationalize(y);plotData.push([Date.parse(common.dateFromMdDate(dateKey)),y])}}plotData.sort(function(a,b){return a[0]-b[0]});if(breakMissing){plotData=common.addBreaks(plotData,highSeries.freq)}highSeries.data=plotData;console.timeEnd("createHighSeries");return highSeries};Plot.prototype.compSymbol=function compSymbol(compIndex){var symbol="";if(compIndex>25){symbol=String.fromCharCode("A".charCodeAt(0)+parseInt(compIndex/26))}symbol+=String.fromCharCode("A".charCodeAt(0)+compIndex%26);return symbol};Plot.prototype.type=function(){var plotType="S";this.eachComponent(function(){if(this.isPointSet())plotType="X";if(this.isMapSet())plotType="M"});return plotType};Plot.prototype.mapMode=function(){if(!this.type()=="M"||!this.graph){return false}else{return this.options.mapMode||this.graph.mapconfig.mapMode||"heat"}};Plot.prototype.clone=function(callback){var plot=this,components=[];plot.eachComponent(function(){components.push(this.clone())});var clone=new Plot(components,$.extend({},plot.options));return clone};Plot.prototype.eachComponent=function(callback){var plot=this;$.each(plot.components,function(c){callback.call(this,c,plot)})};Plot.prototype.validateUserFormula=function(formalaString){}})();MashableData.Graph=function(properties){properties=properties||{};this.annotations=properties.annotations||[];this.title=properties.title||"";this.type=properties.type||"auto";this.map=properties.map||"";this.assets=properties.assets||{};this.gid=properties.gid||null;this.ghash=properties.ghash||null;this.analysis=properties.analysis||null;this.mapconfig=properties.mapconfig||{};this.start=properties.start||null;this.end=properties.end||null;this.published=properties.published||"N";this.userid=parseInt(properties.userid)||null;if(typeof this.annotations=="string")this.annotations=safeParse(this.annotations,[]);if(typeof this.mapconfig=="string")this.mapconfig=safeParse(this.mapconfig,{});if(properties.allplots){var p,c,comp,plot,handle,components;for(p=0;p<properties.allplots.length;p++){plot=properties.allplots[p];components=[];for(c=0;c<plot.components.length;c++){comp=plot.components[c];handle=comp.settype+comp.setid+comp.freq+(comp.geoid?"G"+comp.geoid:"")+(comp.latlon?"L"+comp.latlon:"");if(properties.assets&&properties.assets[handle]){components.push(new MashableData.Component(properties.assets[handle],safeParse(comp.options,{})))}else return false}this.addPlot(new MashableData.Plot(components,safeParse(plot.options,{})))}this.assets=properties.assets}return this;function safeParse(jsonString,emptyValue){try{return $.parseJSON(jsonString.replace(/u0022/g,'"'))}catch(e){return emptyValue}}};(function(){var MD=MashableData,Graph=MD.Graph,globals=MD.globals,common=MD.common;Graph.prototype.addPlot=function(componentsOrPlot,options){if(Array.isArray(componentsOrPlot)){var plot=new MashableData.Plot(componentsOrPlot,options)}else{plot=componentsOrPlot}plot.graph=this;switch(plot.type()){case"M":if(!this.mapsets)this.mapsets=[];this.mapsets.push(plot);break;case"X":if(!this.pointsets)this.pointsets=[];this.pointsets.push(plot);break;case"S":if(!this.plots)this.plots=[];this.plots.push(plot);break}return plot};Graph.prototype.addMapPlot=function(components,options){var plot=new MashableData.Plot(components,options);plot.graph=this;if(this.mapsets)this.mapsets.push(plot);else this.mapsets=[plot];return plot};Graph.prototype.addPointPlot=function(components,options){var plot=new MashableData.Plot(components,options);plot.graph=this;if(this.pointsets)this.pointsets.push(plot);else this.pointsets=[plot];return plot};Graph.prototype.clone=function(){var thisGraph=this,clone=new Graph;clone.map=thisGraph.map;clone.start=thisGraph.start;clone.end=thisGraph.end;clone.mapconfig=$.extend(true,{},thisGraph.mapconfig);clone.title=thisGraph.title;clone.type=thisGraph.type;clone.cubeid=thisGraph.cubeid;clone.intervals=thisGraph.intervals;clone.analysis=thisGraph.analysis;clone.annotations=$.extend(true,{},{a:thisGraph.annotations}).a;thisGraph.eachPlot(function(){clone.addPlot(this.clone())});return clone};Graph.prototype.destroy=function(){};Graph.prototype.draw=function(){};Graph.prototype.redraw=function(){};Graph.prototype.undraw=function(){};Graph.prototype.fetchAssets=function(callback){var assetsToFetch={series:[],mapSets:[],pointSets:[]},fetchTracker=[];var c,comp,plot,handle,graph=this;this.eachComponent(function(c,plot){var comp=this;if(!comp.data){handle=comp.handle();if((!graph.assets[handle]||!graph.assets[handle].data)&&fetchTracker.indexOf(handle)==-1){if(globals.MySets&&globals.MySets[handle]&&globals.MySets[handle].data){graph.assets[handle]=globals.MySets[handle].clone()}else{if(comp.isSeries())assetsToFetch.series.push({setid:comp.setid,freq:comp.freq,geoid:comp.geoid,latlon:comp.latlon});if(comp.isMapSet())assetsToFetch.mapSets.push({setid:comp.setid,freq:comp.freq});if(comp.isPointSet())assetsToFetch.pointSets.push({setid:comp.setid,freq:comp.freq});fetchTracker.push(handle)}}}});if(assetsToFetch.series.length+assetsToFetch.mapSets.length+assetsToFetch.pointSets.length>0){var params={command:"GetSets",map:graph.map,modal:"persist"};$.extend(true,params,assetsToFetch);common.callApi(params,function(jsoData,textStatus,jqXHR){for(handle in jsoData.assets)graph.assets[handle]=jsoData.assets[handle];callback()})}else callback()};Graph.prototype.fetchMap=function(callback){var graph=this;if(graph.map){if(!graph.mapFile)graph.mapFile=globals.maps[graph.map].redef?graph.map:globals.maps[graph.map].jvectormap;var requiredFile=["/global/js/maps/"+graph.mapFile+".js"];require(requiredFile,function(){if(globals.maps[graph.map].redef)common.makeMap(graph.map);if(callback)callback()})}else if(callback)callback()};Graph.prototype.changeMap=function(mapCode,callback){if(this.map&&this.map!=mapCode){var graph=this,comp;var oldMap=globals.maps[graph.map];var newMap=globals.maps[mapCode];delete graph.mapFile;graph.map=mapCode;graph.fetchMap();var changedAssets={};graph.eachComponent(function(){comp=this;var handle=comp.handle();if(comp.isSeries()){if(this.geoid==oldMap.bunny&&newMap.bunny!=oldMap.bunny&&!this.latlon){changedAssets.series=changedAssets.series||{};changedAssets.series[handle]={setid:this.setid,freq:this.freq,geoid:newMap.bunny};delete comp.data;delete graph.assets[handle]}}else{if(comp.isMapSet()){changedAssets.mapSets=changedAssets.mapSets||{};changedAssets.mapSets[handle]={setid:this.setid,freq:this.freq}}if(comp.isPointSet()){changedAssets.pointSets=changedAssets.pointSets||{};changedAssets.pointSets[handle]={setid:this.setid,freq:this.freq}}delete graph.assets[comp.handle];delete comp.data;delete comp.mappedTo}});common.callApi({command:"ChangeMaps",map:mapCode,sets:changedAssets,fromgeoid:oldMap.bunny,togeoid:newMap.bunny,modal:"persist"},function(jsoData,textStatus,jqXHR){var regex=new RegExp(jsoData.regex);if(jsoData.replacement){if(graph.title)graph.title=graph.title.replace(regex,jsoData.replacement);if(graph.analysis)graph.analysis=graph.analysis.replace(regex,jsoData.replacement)}graph.eachPlot(function(){if(this.options.name)this.options.name=this.options.name.replace(regex,jsoData.replacement);if(jsoData.bunnies){this.eachComponent(function(){var oldBunnyHandle=this.handle();if(jsoData.bunnies[oldBunnyHandle]){this.parseData(jsoData.bunnies[oldBunnyHandle].data);this.geoname=jsoData.replacement;this.geoid=jsoData.bunnies[oldBunnyHandle].geoid}delete graph.assets[oldBunnyHandle]})}});for(var handle in jsoData.assets){graph.assets[handle]=jsoData.assets[handle];graph.assets[handle].mappedTo=mapCode}this.map=newMap;callback()})}};Graph.prototype.save=function saveGraph(callback){var oGraph=this,serieslist=[],now=(new Date).getTime(),mapseriespointplots=[],plotRepresentation;this.eachComponent(function(){serieslist.push(this.name())});this.eachPlot(function(){plotRepresentation={type:this.type(),options:$.stringify(this.options),components:[]};this.eachComponent(function(){plotRepresentation.components.push({setid:this.setid,freq:this.freq,geoid:this.geoid,latlon:this.latlon,options:$.stringify(this.options)})});mapseriespointplots.push(plotRepresentation)});var saveParams={gid:this.gid,command:"ManageMyGraphs",serieslist:serieslist.join("; "),end:this.end,start:this.start,annotations:serializeAnnotations(oGraph),map:this.map,mapconfig:$.stringify(this.mapconfig),modifieddt:now,intervals:this.intervals,cubeid:this.cubeid,type:this.type,title:this.title,analysis:this.analysis,published:this.published||"N",allplots:mapseriespointplots};callApi(saveParams,function(jsoData,textStatus,jqXH){oGraph.gid=jsoData.gid;oGraph.ghash=jsoData.ghash;oGraph.isDirty=false;var seriesList=[],seriesName,objForDataTable=$.extend({from:"",to:"",plottypes:"",serieslist:[]},oGraph);objForDataTable.updatedt=(new Date).getTime();oGraph.eachPlot(function(){objForDataTable.plottypes+=this.type();this.eachComponent(function(){seriesName=this.name();if(seriesList.indexOf(seriesName)==-1)seriesList.push(seriesName)})});objForDataTable.serieslist=seriesList.join("; ");if("G"+oGraph.gid in oMyGraphs){var trMyGraph;trMyGraph=$($dtMyGraphs).find("span.handle[data=G"+oGraph.gid+"]").closest("tr").get(0);$dtMyGraphs.fnUpdate(objForDataTable,trMyGraph)}else{$dtMyGraphs.fnAddData(objForDataTable)}oMyGraphs["G"+oGraph.gid]=objForDataTable;panelGraphs[visiblePanelId()]=oGraph;if(callback)callback()});function serializeAnnotations(mdGraph){var serialized="[";for(var i=0;i<mdGraph.annotations.length;i++){serialized+='{"type":"'+mdGraph.annotations[i].type+'",';if(mdGraph.annotations[i].type=="point")serialized+='"series":"'+mdGraph.annotations[i].series+'",';if(mdGraph.annotations[i].type.substring(0,1)=="h")serialized+='"yAxis":"'+mdGraph.annotations[i].yAxis+'",';serialized+='"color":"'+mdGraph.annotations[i].color+'",';serialized+='"from":"'+mdGraph.annotations[i].from+'",';if(mdGraph.annotations[i].type.indexOf("band")>-1)serialized+='"to":"'+mdGraph.annotations[i].to+'",';serialized+='"text":"'+mdGraph.annotations[i].text+'"}';if(i<mdGraph.annotations.length-1)serialized+=","}return serialized+"]"}};Graph.prototype.saveAs=function(newName,callback){if(typeof newName!="undefined")this.name=newName.trim();delete this.gid;delete this.ghash;this.save(callback)};Graph.prototype.deleteGraph=function(callback){if(this.userid==account.info.userId){common.callApi({command:"DeleteMyGraphs",gids:[this.gid]},callback)}else callback(false)};Graph.prototype.resetHash=function(callBack){callApi({command:"ResetGhash",gid:oGraph.gid},function(oReturn,textStatus,jqXH){this.ghash=oReturn.ghash;callBack()})};Graph.prototype.eachPlot=function eachPlot(callback){var graph=this;if(graph.mapsets)$.each(graph.mapsets,function(p){callback.call(this,p,graph,graph.mapsets)});if(graph.pointsets)$.each(graph.pointsets,function(p){callback.call(this,p,graph,graph.pointsets)});if(graph.plots)$.each(graph.plots,function(p){callback.call(this,p,graph,graph.plots)})};Graph.prototype.eachComponent=function eachComponent(callback){var graph=this;graph.eachPlot(function(){var plot=this;plot.eachComponent(callback)})};Graph.prototype.mapFreq=function(){var mapFreq=false,plotFreq;this.eachPlot(function(){if(this.type()!="S"){plotFreq=this.freq();if(mapFreq&&mapFreq!=plotFreq)return"error";mapFreq=plotFreq}});return mapFreq};Graph.prototype.hasMapViz=function hasMapViz(){if(!this.mapsets||!this.cubeid&&!this.mapconfig.mapViz)return false;if(this.cubeid)return true;switch(this.mapconfig.mapViz){case"scatter":return this.mapsets.length==2;case"line":return true;case"line-bunnies":return true;case"components-bar":case"components-line":return true;case"list-asc":case"list-desc":return true;default:return false}};Graph.prototype.isSummationMap=function isSummationMap(){if(!this.mapsets)return false;for(var ms=0;ms<this.mapsets.length;ms++){if(!this.mapsets[ms].calculatedFormula)this.mapsets[ms].calculateFormula();var formula=this.mapsets[ms].calculatedFormula;if(!/[-+]/.test(formula.numFormula)||/[*/]/.test(formula.numFormula))return false;this.mapsets[ms].eachComponent(function(){if(!this.isMapSet())return false})}return true}})();(function makeMapDiv(){var orderedMapList=[{map:"none",name:"no map filter",level:0},{map:"world",name:"world",geographycount:"172",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:0},{map:"wb_incomes",name:"World Bank income levels",geographycount:"11",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:1,redef:{regions:[{name:"High income: nonOECD",code:"NOC",components:["AD","AG","AW","BH","BB","BM","BN","KY","","HR","CW","CY","GQ","FO","PF","GL","GU","HK","IM","KW","LV","LI","LT","MO","MT","MC","NC","MP","OM","PR","QA","RU","SM","SA","SG","SX","KN","MF","BS","TT","TC","AE","UY","VI"]},{name:"High income: OECD",code:"OEC",components:["AU","AT","BE","CA","CL","CZ","DK","EE","FI","FR","DE","GR","IS","IE","IL","IT","JP","KR","LU","NL","NZ","NO","PL","PT","SK","SI","ES","SE","CH","GB","US"]},{name:"Low income",code:"LIC",components:["AF","BD","BJ","BF","BI","KH","CF","TD","KM","KP","CD","ER","ET","GN","GW","HT","KE","LR","MG","MW","ML","MZ","MM","NP","NE","RW","SL","SO","TJ","TZ","GM","TG","UG","ZW"]},{name:"Lower middle income",code:"LMC",components:["AM","BT","BO","CV","CM","CG","CI","DJ","EG","SV","GE","GH","GT","GY","HN","IN","ID","KI","","KG","LA","LS","MR","FM","MD","MN","MA","NI","NG","PK","PG","PY","PH","WS","ST","SN","SB","SS","LK","SD","SZ","SY","TL","UA","UZ","VU","VN","PS","YE","ZM"]},{name:"Upper middle income",code:"UMC",components:["AL","DZ","AS","AO","AR","AZ","BY","BZ","BA","BW","BR","BG","CN","CO","CR","CU","DM","DO","EC","FJ","GA","GD","HU","IR","IQ","JM","JO","KZ","LB","LY","MK","MY","MV","MH","MU","MX","ME","NA","PW","PA","PE","RO","RS","SC","ZA","LC","VC","SR","TH","TO","TN","TR","TM","TV","VE"]}]}},{map:"wb_regions",name:"World Bank regions",geographycount:"13",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:1,redef:{regions:[{name:"East Asia & Pacific",code:"EAS",components:["BN","PF","GU","HK","MO","NC","MP","SG","AU","JP","KR","NZ","KH","KP","MM","ID","KI","LA","FM","MN","PG","PH","WS","SB","TL","VU","VN","AS","CN","FJ","MY","MH","PW","TH","TO","TV"]},{name:"Europe & Central Asia",code:"ECS",components:["AD","","HR","CY","FO","GL","IM","LV","LI","LT","MC","RU","SM","AT","BE","CZ","DK","EE","FI","FR","DE","GR","IS","IE","IT","LU","NL","NO","PL","PT","SK","SI","ES","SE","CH","GB","TJ","AM","GE","","KG","MD","UA","UZ","AL","AZ","BY","BA","BG","HU","KZ","MK","ME","RO","RS","TR","TM"]},{name:"Latin America & Caribbean",code:"LCN",components:["AG","AW","BB","KY","CW","PR","SX","KN","MF","BS","TT","TC","UY","VI","CL","HT","BO","SV","GT","GY","HN","NI","PY","AR","BZ","BR","CO","CR","CU","DM","DO","EC","GD","JM","MX","PA","PE","LC","VC","SR","VE"]},{name:"Middle East & North Africa",code:"MEA",components:["BH","KW","MT","OM","QA","SA","AE","IL","DJ","EG","MA","SY","PS","YE","DZ","IR","IQ","JO","LB","LY","TN"]},{name:"North America",code:"NAC",components:["BM","CA","US"]},{name:"South Asia",code:"SAS",components:["AF","BD","NP","BT","IN","PK","LK","MV"]},{name:"Sub-Saharan Africa",code:"SSA",components:["GQ","BJ","BF","BI","CF","TD","KM","CD","ER","ET","GN","GW","KE","LR","MG","MW","ML","MZ","NE","RW","SL","SO","TZ","GM","TG","UG","ZW","CV","CM","CG","CI","GH","LS","MR","NG","ST","SN","SS","SD","SZ","ZM","AO","BW","GA","MU","NA","SC","ZA"]}]}},{map:"africa",name:"Africa",geographycount:"57",bunny:"3837",jvectormap:"africa_mill_en",legend:"BL",level:0},{map:"europe_nafrica",name:"Europe and North Africa",geographycount:"53",bunny:null,jvectormap:"europe_nafrica_mill_en",legend:"BL",level:0},{map:"europe",name:"Europe",geographycount:"41",bunny:"3841",jvectormap:"europe_mill_en",legend:"BL",level:0},{map:"eu28",name:"European Union - countries",geographycount:"28",bunny:"307",jvectormap:"eu_mill_en",legend:"BL",level:0},{map:"eu_nuts1",name:"European Union - NUTS1 regions",geographycount:"104",bunny:"307",jvectormap:"eu_nuts1_mill_en",legend:"BL",level:1},{map:"eu_nuts2",name:"European Union - NUTS2 regions",geographycount:"289",bunny:"307",jvectormap:"eu_nuts2_mill_en",legend:"BL",level:1},{map:"eu_nuts3",name:"European Union - NUTS3 regions",geographycount:"1373",bunny:"307",jvectormap:"eu_nuts3_mill_en",legend:"BL",level:1},{map:"at_nuts2",name:"Austria/Österreich NUTS2 regions",geographycount:"9",bunny:"16",jvectormap:"at_nuts2_mill_en",legend:"BR",level:2},{map:"at_nuts3",name:"Austria/Österreich NUTS3 regions",geographycount:"35",bunny:"16",jvectormap:"at_nuts3_mill_en",legend:"BR",level:2},{map:"be_nuts2",name:"Belgium/Belgique-België NUTS2 regions",geographycount:"11",bunny:"19",jvectormap:"be_nuts2_mill_en",legend:"BR",level:2},{map:"be_nuts3",name:"Belgium/Belgique-België NUTS3 regions",geographycount:"44",bunny:"19",jvectormap:"be_nuts3_mill_en",legend:"BR",level:2},{map:"bg_nuts2",name:"Bulgaria NUTS2 regions",geographycount:"6",bunny:"24",jvectormap:"bg_nuts2_mill_en",legend:"BR",level:2},{map:"bg_nuts3",name:"Bulgaria NUTS3 regions",geographycount:"28",bunny:"24",jvectormap:"bg_nuts3_mill_en",legend:"BR",level:2},{map:"ch_nuts2",name:"Switzerland/Suisse-Schweiz NUTS2 regions",geographycount:"7",bunny:"42",jvectormap:"ch_nuts2_mill_en",legend:"BR",level:2},{map:"ch_nuts3",name:"Switzerland/Suisse/Schweiz NUTS3 regions",geographycount:"26",bunny:"42",jvectormap:"ch_nuts3_mill_en",legend:"BR",level:2},{map:"cz_nuts2",name:"Czech/?eská Republika NUTS2 regions",geographycount:"8",bunny:"59",jvectormap:"cz_nuts2_mill_en",legend:"BR",level:2},{map:"cz_nuts3",name:"Czech/?eská Republika NUTS3 regions",geographycount:"14",bunny:"59",jvectormap:"cz_nuts3_mill_en",legend:"BR",level:2},{map:"de_nuts1",name:"Germany/Deutschland  NUTS1 regions",geographycount:"16",bunny:"60",jvectormap:"de_nuts1_mill_en",legend:"BR",level:2},{map:"de_nuts2",name:"Germany/Deutschland NUTS2 regions",geographycount:"37",bunny:"60",jvectormap:"de_nuts2_mill_en",legend:"BR",level:2},{map:"de_nuts3",name:"Germany/Deutschland NUTS3 regions",geographycount:"413",bunny:"60",jvectormap:"de_nuts3_mill_en",legend:"BR",level:2},{map:"dk_nuts2",name:"Denmark/Danmark NUTS2 regions",geographycount:"5",bunny:"63",jvectormap:"dk_nuts2_mill_en",legend:"BR",level:2},{map:"dk_nuts3",name:"Denmark/Danmark NUTS3 regions",geographycount:"11",bunny:"63",jvectormap:"dk_nuts3_mill_en",legend:"BR",level:2},{map:"el_nuts2",name:"Greece/Ellada NUTS2 regions",geographycount:"13",bunny:"90",jvectormap:"el_nuts2_mill_en",legend:"BR",level:2},{map:"el_nuts3",name:"Greece/Ellada NUTS3 regions",geographycount:"51",bunny:"90",jvectormap:"el_nuts3_mill_en",legend:"BR",level:2},{map:"es_nuts2",name:"Spain/España NUTS2 regions",geographycount:"19",bunny:"70",jvectormap:"es_nuts2_mill_en",legend:"BR",level:2},{map:"es_nuts3",name:"Spain/España NUTS3 regions",geographycount:"59",bunny:"70",jvectormap:"es_nuts3_mill_en",legend:"BR",level:2},{map:"fi_nuts2",name:"Finland/Suomi NUTS2 regions",geographycount:"5",bunny:"73",jvectormap:"fi_nuts2_mill_en",legend:"BR",level:2},{map:"fi_nuts3",name:"Finland/Suomi NUTS3 regions",geographycount:"19",bunny:"73",jvectormap:"fi_nuts3_mill_en",legend:"BR",level:2},{map:"fr_nuts2",name:"France NUTS2 regions",geographycount:"26",bunny:"76",jvectormap:"fr_nuts2_mill_en",legend:"BR",level:2},{map:"fr_nuts3",name:"France NUTS3 regions",geographycount:"100",bunny:"76",jvectormap:"fr_nuts3_mill_en",legend:"BR",level:2},{map:"hu_nuts2",name:"Hungary/Magyarország NUTS2 regions",geographycount:"7",bunny:"102",jvectormap:"hu_nuts2_mill_en",legend:"BR",level:2},{map:"hu_nuts3",name:"Hungary/Magyarország NUTS3 regions",geographycount:"20",bunny:"102",jvectormap:"hu_nuts3_mill_en",legend:"BR",level:2},{map:"ie_nuts3",name:"Ireland NUTS3 regions",geographycount:"8",bunny:"107",jvectormap:"ie_nuts3_mill_en",legend:"BR",level:2},{map:"it_nuts2",name:"Italy/Italia NUTS2 regions",geographycount:"21",bunny:"112",jvectormap:"it_nuts2_mill_en",legend:"BR",level:2},{map:"it_nuts3",name:"Italy/Italia NUTS3 regions",geographycount:"110",bunny:"112",jvectormap:"it_nuts3_mill_en",legend:"BR",level:2},{map:"lt_nuts3",name:"Lithuania/Lietuva NUTS3 regions",geographycount:"10",bunny:"113",jvectormap:"lt_nuts3_mill_en",legend:"BR",level:2},{map:"lv_nuts3",name:"Latvia/Latvija NUTS3 regions",geographycount:"6",bunny:"135",jvectormap:"lv_nuts3_mill_en",legend:"BR",level:2},{map:"nl_nuts2",name:"Netherlands/Nederland NUTS2 regions",geographycount:"12",bunny:"167",jvectormap:"nl_nuts2_mill_en",legend:"BR",level:2},{map:"nl_nuts3",name:"Netherlands/Nederland NUTS3 regions",geographycount:"40",bunny:"167",jvectormap:"nl_nuts3_mill_en",legend:"BR",level:2},{map:"no_nuts2",name:"Norway/Norge NUTS2 regions",geographycount:"7",bunny:"168",jvectormap:"no_nuts2_mill_en",legend:"BR",level:2},{map:"no_nuts3",name:"Norway/Norge NUTS3 regions",geographycount:"19",bunny:"168",jvectormap:"no_nuts3_mill_en",legend:"BR",level:2},{map:"pl_nuts2",name:"Poland/Polska NUTS2 regions",geographycount:"16",bunny:"180",jvectormap:"pl_nuts2_mill_en",legend:"BR",level:2},{map:"pl_nuts3",name:"Poland/Polska NUTS3 regions",geographycount:"66",bunny:"180",jvectormap:"pl_nuts3_mill_en",legend:"BR",level:2},{map:"pt_nuts2",name:"Portugal NUTS2 regions",geographycount:"7",bunny:"183",jvectormap:"pt_nuts2_mill_en",legend:"BR",level:2},{map:"pt_nuts3",name:"Portugal NUTS3 regions",geographycount:"30",bunny:"183",jvectormap:"pt_nuts3_mill_en",legend:"BR",level:2},{map:"ro_nuts2",name:"Romania/România NUTS2 regions",geographycount:"8",bunny:"189",jvectormap:"ro_nuts2_mill_en",legend:"BR",level:2},{map:"ro_nuts3",name:"Romania/România NUTS3 regions",geographycount:"42",bunny:"189",jvectormap:"ro_nuts3_mill_en",legend:"BR",level:2},{map:"se_nuts2",name:"Sweden/Sverige NUTS2 regions",geographycount:"8",bunny:"211",jvectormap:"se_nuts2_mill_en",legend:"BR",level:2},{map:"se_nuts3",name:"Sweden/Sverige NUTS3 regions",geographycount:"21",bunny:"211",jvectormap:"se_nuts3_mill_en",legend:"BR",level:2},{map:"si_nuts3",name:"Slovakia/Slovenija NUTS3 regions",geographycount:"12",bunny:"210",jvectormap:"si_nuts3_mill_en",legend:"BR",level:2},{map:"sk_nuts3",name:"Slovenia/Slovensko NUTS3 regions",geographycount:"8",bunny:"209",jvectormap:"sk_nuts3_mill_en",legend:"BR",level:2},{map:"uk_nuts1",name:"United Kingdom NUTS1 regions",geographycount:"12",bunny:"80",jvectormap:"uk_nuts1_mill_en",legend:"BR",level:2},{map:"uk_nuts2",name:"United Kingdom NUTS2 regions",geographycount:"37",bunny:"80",jvectormap:"uk_nuts2_mill_en",legend:"BR",level:2},{map:"uk_nuts3",name:"United Kingdom NUTS3 regions",geographycount:"139",bunny:"80",jvectormap:"uk_nuts3_mill_en",legend:"BR",level:2},{map:"us",name:"USA (states)",geographycount:"51",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:0},{map:"us_counties",name:"US counties",geographycount:"3145",bunny:"235",jvectormap:"us_counties_merc_en",legend:"BL",level:1},{map:"eia_regions",name:"US by EIA statistical regions",geographycount:"10",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"New England",code:"EIA_NE",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT"]},{name:"Middle Atlantic",code:"EIA_MA",components:["US-NJ","US-NY","US-PA"]},{name:"East North Central",code:"EIA_ENC",components:["US-IL","US-IN","US-MI","US-OH","US-WI"]},{name:"West North Central",code:"EIAWNC",components:["US-IA","US-KS","US-MN","US-MO","US-NE","US-ND","US-SD"]},{name:"South Atlantic",code:"EIA_SA",components:["US-DE","US-DC","US-FL","US-GA","US-MD","US-NC","US-SC","US-VA","US-WV"]},{name:"East South Central",code:"EIA_ESC",components:["US-AL","US-KY","US-MS","US-TN"]},{name:"West South Central",code:"EIA_WSC",components:["US-AR","US-LA","US-OK","US-TX"]},{name:"Mountain",code:"EIA_MTN",components:["US-AZ","US-CO","US-ID","US-MT","US-NV","US-NM","US-UT","US-WY"]},{name:"Pacific Contiguous",code:"EIA_PC",components:["US-CA","US-OR","US-WA"]},{name:"Pacific Noncontiguous",code:"EIA_PNC",components:["US-AK","US-HI"]}]}},{map:"padds",name:"US Petroleum Districts",geographycount:"5",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"PADD I (East Coast)",code:"PADD1",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT","US-DE","US-DC","US-MD","US-NJ","US-NY","US-PA","US-FL","US-GA","US-NC","US-SC","US-VA","US-WV"]},{name:"PADD II (Midwest)",code:"PADD2",components:["US-IL","US-IN","US-IA","US-KS","US-KY","US-MI","US-MN","US-MO","US-NE","US-ND","US-SD","US-OH","US-OK","US-TN","US-WI"]},{name:"PADD III (Gulf Coast)",code:"PADD3",components:["US-AL","US-AR","US-LA","US-MS","US-NM","US-TX"]},{name:"PADD IV (Rocky Mountain)",code:"PADD4",components:["US-CO","US-ID","US-MT","US-UT","US-WY"]},{name:"PADD V (West Coast)",code:"PADD5",components:["US-AK","US-AZ","US-CA","US-HI","US-NV","US-OR","US-WA"]}]}},{map:"padds_sub",name:"US Petroleum Districts - detailed",geographycount:"7",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"PADD I, Subdistrict A (New England): Connecticut, Maine, Massachusetts, New Hampshire, Rhode Island, and Vermont.",code:"PADD1a",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT"]},{name:"PADD I, Subdistrict B (Central Atlantic): Delaware, District of Columbia, Maryland, New Jersey, New York, and Pennsylvania.",code:"PADD1b",components:["US-DE","US-DC","US-MD","US-NJ","US-NY","US-PA"]},{name:"PADD I, Subdistrict C (Lower Atlantic): Florida, Georgia, North Carolina, South Carolina, Virginia, and West Virginia.",code:"PADD1c",components:["US-FL","US-GA","US-NC","US-SC","US-VA","US-WV"]},{name:"PADD II (Midwest): Illinois, Indiana, Iowa, Kansas, Kentucky, Michigan, Minnesota, Missouri, Nebraska, North Dakota, South Dakota, Ohio, Oklahoma, Tennessee, and Wisconsin.",code:"PADD2",components:["US-IL","US-IN","US-IA","US-KS","US-KY","US-MI","US-MN","US-MO","US-NE","US-ND","US-SD","US-OH","US-OK","US-TN","US-WI"]},{name:"PADD III (Gulf Coast): Alabama, Arkansas, Louisiana, Mississippi, New Mexico, and Texas",code:"PADD3",components:["US-AL","US-AR","US-LA","US-MS","US-NM","US-TX"]},{name:"PADD IV (Rocky Mountain): Colorado, Idaho, Montana, Utah, and Wyoming.",code:"PADD4",components:["US-CO","US-ID","US-MT","US-UT","US-WY"]},{name:"PADD V (West Coast): Alaska, Arizona, California, Hawaii, Nevada, Oregon, and Washington.",code:"PADD5",components:["US-AK","US-AZ","US-CA","US-HI","US-NV","US-OR","US-WA"]}]}},{map:"us_ak",name:"Alaska",geographycount:"29",bunny:"251",jvectormap:"usak_merc_en",legend:"TR",level:2},{map:"us_al",name:"Alabama",geographycount:"67",bunny:"250",jvectormap:"usal_merc_en",legend:"BR",level:2},{map:"us_ar",name:"Arkansas",geographycount:"75",bunny:"253",jvectormap:"usar_merc_en",legend:"BR",level:2},{map:"us_az",name:"Arizona",geographycount:"15",bunny:"252",jvectormap:"usaz_merc_en",legend:"BR",level:2},{map:"us_ca",name:"California",geographycount:"58",bunny:"254",jvectormap:"usca_merc_en",legend:"TR",level:2},{map:"us_co",name:"Colorado",geographycount:"64",bunny:"255",jvectormap:"usco_merc_en",legend:"BR",level:2},{map:"us_ct",name:"Connecticut",geographycount:"8",bunny:"256",jvectormap:"usct_merc_en",legend:"BR",level:2},{map:"us_dc",name:"District of Columbia",geographycount:"2",bunny:"694",jvectormap:"usdc_merc_en",legend:"BR",level:2},{map:"us_de",name:"Delaware",geographycount:"3",bunny:"257",jvectormap:"usde_merc_en",legend:"TR",level:2},{map:"us_fl",name:"Florida",geographycount:"67",bunny:"258",jvectormap:"usfl_merc_en",legend:"BL",level:2},{map:"us_ga",name:"Georgia",geographycount:"159",bunny:"259",jvectormap:"usga_merc_en",legend:"TR",level:2},{map:"us_hi",name:"Hawaii",geographycount:"5",bunny:"260",jvectormap:"ushi_merc_en",legend:"BL",level:2},{map:"us_ia",name:"Iowa",geographycount:"99",bunny:"264",jvectormap:"usia_merc_en",legend:"BR",level:2},{map:"us_id",name:"Idaho",geographycount:"44",bunny:"261",jvectormap:"usid_merc_en",legend:"TR",level:2},{map:"us_il",name:"Illinois",geographycount:"102",bunny:"262",jvectormap:"usil_merc_en",legend:"BL",level:2},{map:"us_in",name:"Indiana",geographycount:"92",bunny:"263",jvectormap:"usin_merc_en",legend:"BR",level:2},{map:"us_ks",name:"Kansas",geographycount:"105",bunny:"265",jvectormap:"usks_merc_en",legend:"BR",level:2},{map:"us_ky",name:"Kentucky",geographycount:"120",bunny:"266",jvectormap:"usky_merc_en",legend:"TL",level:2},{map:"us_la",name:"Louisiana",geographycount:"64",bunny:"267",jvectormap:"usla_merc_en",legend:"TR",level:2},{map:"us_md",name:"Maryland",geographycount:"24",bunny:"269",jvectormap:"usmd_merc_en",legend:"BL",level:2},{map:"us_me",name:"Maine",geographycount:"16",bunny:"268",jvectormap:"usme_merc_en",legend:"TR",level:2},{map:"us_ma",name:"Massachusetts",geographycount:"14",bunny:"270",jvectormap:"usma_merc_en",legend:"BL",level:2},{map:"us_mi",name:"Michigan",geographycount:"83",bunny:"271",jvectormap:"usmi_merc_en",legend:"BL",level:2},{map:"us_mn",name:"Minnesota",geographycount:"87",bunny:"272",jvectormap:"usmn_merc_en",legend:"BR",level:2},{map:"us_ms",name:"Mississippi",geographycount:"82",bunny:"273",jvectormap:"usms_merc_en",legend:"BR",level:2},{map:"us_mo",name:"Missouri",geographycount:"115",bunny:"274",jvectormap:"usmo_merc_en",legend:"TR",level:2},{map:"us_mt",name:"Montana",geographycount:"56",bunny:"275",jvectormap:"usmt_merc_en",legend:"BR",level:2},{map:"us_nc",name:"North Carolina",geographycount:"100",bunny:"282",jvectormap:"usnc_merc_en",legend:"BR",level:2},{map:"us_nd",name:"North Dakota",geographycount:"53",bunny:"283",jvectormap:"usnd_merc_en",legend:"BR",level:2},{map:"us_ne",name:"Nebraska",geographycount:"93",bunny:"276",jvectormap:"usne_merc_en",legend:"BL",level:2},{map:"us_nh",name:"New Hampshire",geographycount:"10",bunny:"278",jvectormap:"usnh_merc_en",legend:"TR",level:2},{map:"us_nj",name:"New Jersey",geographycount:"21",bunny:"279",jvectormap:"usnj_merc_en",legend:"BR",level:2},{map:"us_nm",name:"New Mexico",geographycount:"33",bunny:"280",jvectormap:"usnm_merc_en",legend:"BR",level:2},{map:"us_nv",name:"Nevada",geographycount:"17",bunny:"277",jvectormap:"usnv_merc_en",legend:"BR",level:2},{map:"us_ny",name:"New York",geographycount:"62",bunny:"281",jvectormap:"usny_merc_en",legend:"TR",level:2},{map:"us_oh",name:"Ohio",geographycount:"88",bunny:"284",jvectormap:"usoh_merc_en",legend:"BR",level:2},{map:"us_ok",name:"Oklahoma",geographycount:"77",bunny:"285",jvectormap:"usok_merc_en",legend:"BR",level:2},{map:"us_or",name:"Oregon",geographycount:"36",bunny:"286",jvectormap:"usor_merc_en",legend:"BR",level:2},{map:"us_pa",name:"Pennsylvania",geographycount:"67",bunny:"287",jvectormap:"uspa_merc_en",legend:"BR",level:2},{map:"us_ri",name:"Rhode Island",geographycount:"5",bunny:"288",jvectormap:"usri_merc_en",legend:"BR",level:2},{map:"us_sc",name:"South Carolina",geographycount:"46",bunny:"289",jvectormap:"ussc_merc_en",legend:"BR",level:2},{map:"us_sd",name:"South Dakota",geographycount:"66",bunny:"290",jvectormap:"ussd_merc_en",legend:"BR",level:2},{map:"us_tn",name:"Tennessee",geographycount:"95",bunny:"291",jvectormap:"ustn_merc_en",legend:"BR",level:2},{map:"us_tx",name:"Texas",geographycount:"254",bunny:"292",jvectormap:"ustx_merc_en",legend:"BL",level:2},{map:"us_ut",name:"Utah",geographycount:"29",bunny:"293",jvectormap:"usut_merc_en",legend:"BR",level:2},{map:"us_va",name:"Virginia",geographycount:"136",bunny:"295",jvectormap:"usva_merc_en",legend:"TL",level:2},{map:"us_vt",name:"Vermont",geographycount:"14",bunny:"294",jvectormap:"usvt_merc_en",legend:"BR",level:2},{map:"us_wa",name:"Washington",geographycount:"39",bunny:"296",jvectormap:"uswa_merc_en",legend:"BR",level:2},{map:"us_wi",name:"Wisconsin",geographycount:"72",bunny:"298",jvectormap:"uswi_merc_en",legend:"BL",level:2},{map:"us_wv",name:"West Virginia",geographycount:"55",bunny:"297",jvectormap:"uswv_merc_en",legend:"BR",level:2},{map:"us_wy",name:"Wyoming",geographycount:"23",bunny:"299",jvectormap:"uswy_merc_en",legend:"BR",level:2},{map:"au",name:"Australia",geographycount:"8",bunny:"15",jvectormap:"au_mill_en",legend:"BR",level:0},{map:"ca",name:"Canada",geographycount:"13",bunny:"40",jvectormap:"ca_mill_en",legend:"BR",level:0},{map:"cn",name:"China",geographycount:"31",bunny:"44",jvectormap:"cn_mill_en",legend:"BR",level:0},{map:"co",name:"Colombia",geographycount:"33",bunny:"50",jvectormap:"co_mill_en",legend:"BR",level:0},{map:"in",name:"India",geographycount:"34",bunny:"105",jvectormap:"in_mill_en",legend:"BR",level:0},{map:"nz",name:"New Zealand",geographycount:"13",bunny:"171",jvectormap:"nz_mill_en",legend:"BR",level:0},{map:"ph",name:"Philippines",geographycount:"17",bunny:"177",jvectormap:"ph_mill_en",legend:"BR",level:0},{map:"pr",name:"Puerto Rico",geographycount:"78",bunny:"181",jvectormap:"pr_merc_en",legend:"BR",level:0},{map:"th",name:"Thailand",geographycount:"76",bunny:"219",jvectormap:"th_mill_en",legend:"BR",level:0},{map:"tr_nuts1",name:"Turkey NUTS1 regions",geographycount:"12",bunny:"227",jvectormap:"tr_nuts1_mill_en",legend:"BL",level:0},{map:"tr_nuts2",name:"Turkey NUTS2 regions",geographycount:"26",bunny:"227",jvectormap:"tr_nuts2_mill_en",legend:"BL",level:0},{map:"tr_nuts3",name:"Turkey NUTS3 regions",geographycount:"81",bunny:"227",jvectormap:"tr_nuts3_mill_en",legend:"BL",level:0},{map:"ve",name:"Venezuela",geographycount:"25",bunny:"239",jvectormap:"ve_mill_en",legend:"BR",level:0},{map:"za",name:"South Africa",geographycount:"9",bunny:"247",jvectormap:"za_mill_en",legend:"BR",level:0}];
MashableData.globals.orderedMapList=orderedMapList;MashableData.globals.maps={};var map,listHtml="";for(var i=0;i<orderedMapList.length;i++){map=orderedMapList[i];listHtml+='<li class="map-list-item map-level'+map.level+'" data="'+map.map+'">'+map.name+"</li>";MashableData.globals.maps[map.map]=map}var mapsUl='<ul class="map-list">'+listHtml+"</ul>";MashableData.common.selectMap=function(event){var initializing=true;var $selector=$(this).blur();var offset=$selector.offset();var divHtml='<div id="select-map" style="left:'+offset.left+"px;top:"+(offset.top+$selector.innerHeight())+'px;">'+mapsUl+"</div>";var $divHtml=$(divHtml).appendTo("body").find('li[data="'+$selector.val()+'"]').addClass("selector-selected").end().css("max-height",$(window).innerHeight()*.8+"px").show();$("body").bind("click",handleMapSelect);function handleMapSelect(event){if(initializing)return initializing=false;var $target=$(event.target);if($target.hasClass("map-list-item")){var selectedMap=$target.attr("data");$("#find-data-map").html('<option value="'+selectedMap+'" selected>'+MashableData.globals.maps[selectedMap].name+"</option>");seriesCloudSearch();$divHtml.remove();return selectedMap}else{$divHtml.remove();$("body").unbind("click",handleMapSelect);return false}}};MashableData.common.makeMap=function(newMap,fromMap,mapDef){if(!jvm.Map.maps[newMap]||mapDef){mapDef=mapDef||MashableData.globals.maps[newMap].redef;fromMap=fromMap||MashableData.globals.maps[newMap].jvectormap;jvm.Map.maps[newMap]=$.extend(true,{},jvm.Map.maps[fromMap]);var newMapObject=jvm.Map.maps[newMap];for(var i=0;i<mapDef.regions.length;i++){var regionDef=mapDef.regions[i];newMapObject.paths[regionDef.code]={name:regionDef.name,path:""};for(var j=0;j<regionDef.components.length;j++){if(newMapObject.paths[regionDef.components[j]]){newMapObject.paths[regionDef.code].path+=(j==0?"":" ")+newMapObject.paths[regionDef.components[j]].path}else{}delete newMapObject.paths[regionDef.components[j]]}}}}})();MashableData.grapher=function(){var MD=MashableData,globals=MD.globals,common=MD.common,mapsList=globals.maps,panelGraphs=globals.panelGraphs,months=globals.months,period=globals.period,patVariable=globals.patVariable,hcColors=globals.hcColors,primeColors=globals.primeColors,MAP_COLORS=globals.MAP_COLORS,DEFAULT_RADIUS_SCALE=globals.DEFAULT_RADIUS_SCALE,DEFAULT_RADIUS_FIXED=globals.DEFAULT_RADIUS_FIXED,dashStyles=globals.dashStyles,op=globals.op,oMyGraphs=globals.MyGraphs,isIE=globals.isIE,graphScriptFiles=globals.graphScriptFiles,dateFromMdDate=common.dateFromMdDate,rationalize=common.rationalize,callApi=common.callApi;var grapher={chartPanel:function chartPanel(panelId){console.time("chartPanel");var oGraph=panelGraphs[panelId];console.time("makeChartOptionsObject");var oChartOptions=makeChartOptionsObject(oGraph);console.timeEnd("makeChartOptionsObject");var $chart=oGraph.controls.$thisPanel.find("div.mashabledata_chart");if(oChartOptions.series.length==0){$chart.hide();return void 0}var chart;if(oGraph.controls&&oGraph.controls.chart){oGraph.controls.chart.destroy();$.contextMenu("destroy","#"+panelId+" div.mashabledata_chart")}oChartOptions.chart.renderTo=$chart.get(0);var annotations=oGraph.controls.annotations;if(globals.isEmbedded){oChartOptions.plotOptions.series.point={events:{click:function(evt){setMapDate(this.x)}}};oChartOptions.chart.events={click:function(e){setMapDate(e.xAxis[0].value)}}}else{oChartOptions.plotOptions.series.point={events:{mouseOver:function(evt){annotations.mouseoverPoint=this;annotations.mouseOverHCPoint(evt,this)},mouseOut:function(evt){delete annotations.mouseoverPoint},click:function(evt){if(annotations.banding){annotations.endBanding(evt)}else{setMapDate(this.x)}}}};oChartOptions.chart.events={click:function(e){if(annotations.banding){annotations.endBanding(e)}else{setMapDate(e.xAxis[0].value)}},selection:function(event){var min;var max;if(event.resetSelection){if(chart.cropButton)chart.cropButton=chart.cropButton.destroy();oGraph.minZoom=oGraph.start===null?oGraph.firstdt:oGraph.start;oGraph.maxZoom=oGraph.end===null?oGraph.lastdt:oGraph.end}else{var btnOptions=$.extend(true,{},chart.options.chart.resetZoomButton);btnOptions.position.y+=30;var box={x:chart.plotLeft,y:chart.plotTop,width:chart.plotWidth,height:chart.plotHeight};chart.cropButton=chart.renderer.button("Crop X-axis",null,null,function(){$("#"+panelId+" button.graph-crop").click()},{zIndex:20},null).attr({align:"right"}).attr({align:btnOptions.position.align,title:"Crop x-axis to current zoom level"}).add().align(btnOptions.position,false,box);var axisMin=event.xAxis[0].min;var axisMax=event.xAxis[0].max;for(var i=0;i<oChartOptions.series.length;i++){var seriesData=oChartOptions.series[i].data;min=closestDate(axisMin,seriesData,min);max=closestDate(axisMax,seriesData,max)}oGraph.minZoom=min;oGraph.maxZoom=max}}}}console.time("highcharts");chart=new Highcharts.Chart(oChartOptions);if(oGraph.controls)oGraph.controls.chart=chart;console.timeEnd("highcharts");annotations.plotAnnotationSeries();if(!globals.isEmbedded){$chart.mouseover(function(e){if(annotations.banding){if(annotations.banding.substr(0,2)=="y-"){var top=$(chart.container).offset().top,left=$(chart.container).offset().left;var x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft,y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){for(var i=0;i<chart.yAxis.length;i++){if(chart.yAxis[i].userOptions.title.text==annotations.banding.substr(2)){var axisValue=chart.yAxis[i].translate(chart.plotHeight-y,true);chart.yAxis[i].removePlotBand("hb"+annotations.bandNo);chart.yAxis[i].addPlotBand({id:"hb"+annotations.bandNo,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:parseFloat(annotations.bandStartPoint),to:axisValue,label:{text:"",zIndex:3}})}}}}}}).keydown(function(e){if(annotations.banding&&e){for(var a=0;a<chart.axes.length;a++){chart.axes[a].removePlotLine(annotations.banding);chart.axes[a].removePlotBand(annotations.banding)}annotations.banding=false}});console.time("contextMenu");$.contextMenu({selector:"#"+panelId+" div.mashabledata_chart",build:function($trigger,e){var i,x,y,top,left;var axisName,axisValue,isRegression,isAverage;var pointSelected=annotations.mouseoverPoint;var onPoint=typeof annotations.mouseoverPoint!="undefined";if(annotations.banding){return annotations.endBanding(e)}else{var mnu={items:{point:{name:"annotate point",disabled:!onPoint,callback:function(key,opt){annotations.addPoint(pointSelected)}},sep0:"---------",vline:{name:"add vertical line",disabled:!onPoint,callback:function(key,opt){annotations.addXLine(pointSelected)}},vband:{name:"start vertical band",disabled:!onPoint,callback:function(key,opt){annotations.startXBand(pointSelected)}},sep1:"---------",hline:{name:"add horizontal line",items:{}},hband:{name:"start horizontal band",items:{}},sep2:"---------",avg:{name:"start average",disabled:!onPoint,callback:function(key,opt){if(!isAverage){annotations.startAnalysisBanding(pointSelected,"AV")}else{annotations.deleteAnalysis(pointSelected)}}},regression:{name:"start linear regression",disabled:!onPoint,callback:function(key,opt){if(!isRegression){annotations.startAnalysisBanding(pointSelected,"LR")}else{annotations.deleteAnalysis(pointSelected)}}},standard:{name:"add standard annotations",items:{}}}};if(onPoint&&pointSelected.series.options.calculatedFrom&&pointSelected.series.options.id.substr(0,2)=="LR"){mnu.items.regression.name="delete linear regression";mnu.items.regression.className="delete-item";isRegression=true;delete mnu.items.avg}if(onPoint&&pointSelected.series.options.calculatedFrom&&pointSelected.series.options.id.substr(0,2)=="AV"){mnu.items.avg.name="delete average";mnu.items.avg.className="delete-item";isAverage=true;delete mnu.items.regression}top=$(chart.container).offset().top;left=$(chart.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft;y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){for(i=0;i<chart.yAxis.length;i++){axisName=chart.yAxis[i].userOptions.title.text;axisValue=parseFloat(parseFloat(chart.yAxis[i].translate(chart.plotHeight-y,true).toPrecision(2)));mnu.items.hline.items["hltext"+i]={name:"<b>"+axisName+":</b>",type:"text",value:axisValue};mnu.items.hline.items["hladd"+i]={name:"<button>add</button>",callback:function(key,opt){var value=parseFloat($.contextMenu.getInputValues(opt)["hltext"+key.substr(5)]);var id="hl"+annotations.lineNo++;chart.yAxis[parseInt(key.substr(5))].addPlotLine({id:id,color:"#FF0000",width:2,value:value});oGraph.annotations.push({id:id,type:"hline",color:"#FF0000",from:value,yAxis:chart.yAxis[parseInt(key.substr(5))].userOptions.title.text,text:""});annotations.build("table-only")}};mnu.items.hband.items["hbtext"+i]={name:"<b>"+axisName+":</b>",type:"text",value:axisValue};mnu.items.hband.items["hbadd"+i]={name:"<button>start</button>",callback:function(key,opt){annotations.bandStartPoint=parseFloat($.contextMenu.getInputValues(opt)["hbtext"+key.substr(5)]);annotations.banding="y-"+chart.yAxis[key.substr(5)].userOptions.title.text;chart.yAxis[parseInt(key.substr(5))].addPlotBand({id:"hb"+annotations.bandNo++,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:annotations.bandStartPoint,to:annotations.bandStartPoint})}};if(i!=0){mnu.items.hline.items["yadd"+i+"sep"]="---------";mnu.items.hband.items["yadd"+i+"sep"]="---------"}}}else{if(!onPoint)return false;mnu.items.hline.disabled=true;mnu.items.hband.disabled=true}for(i=0;i<MD.globals.standardAnnotations.length;i++){mnu.items.standard.items["SA"+MD.globals.standardAnnotations[i].annoid]={name:MD.globals.standardAnnotations[i].name,callback:function(key,opt){annotations.addStandard(parseInt(key.substr(2)))}}}return mnu}}});console.timeEnd("contextMenu");$("#"+panelId+" .highcharts-title").click(function(){graphTitle.show(this)})}console.timeEnd("chartPanel");return chart;function setMapDate(jsDateClicked){var calcData=oGraph.calculatedMapData;if(oGraph.mapsets||oGraph.pointsets){if(calcData.startDateIndex!=calcData.endDateIndex){var jsDate=closestDate(jsDateClicked,calcData.dates);for(var i=0;i<calcData.dates.length;i++){if(calcData.dates[i]["dt"].getTime()==jsDate){oGraph.controls.$thisPanel.find(".mashabledata_map-slider").slider("value",i)}}}}}},intervalStartDt:function intervalStartDt(graph){var dt=new Date(parseInt(graph.lastdt));switch(graph.largestPeriod){case"A":return dt.setUTCFullYear(dt.getUTCFullYear()-(graph.intervals-1));case"SA":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1)*6);case"Q":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1)*3);case"M":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1));case"W":return dt.setUTCDate(dt.getUTCDate()-(graph.intervals-1)*7);default:return dt.setUTCDate(dt.getUTCDate()-(graph.intervals-1))}},setCropSlider:function setCropSlider(panelId){if(globals.isEmbedded)return;var leftIndex,rightIndex,maxIndex,i,bestDelta,thisDelta,chartOptions,oGraph=panelGraphs[panelId];if(oGraph.controls.chart){chartOptions=oGraph.controls.chart.options.chart;if(oGraph.start===null){leftIndex=0}else{i=chartOptions.x.indexOf(oGraph.start.toString());if(i>-1){leftIndex=i}else{bestDelta=null;for(i=0;i<chartOptions.x.length;i++){thisDelta=Math.abs(parseInt(chartOptions.x[i])-parseInt(oGraph.start));if(bestDelta===null||bestDelta>thisDelta){bestDelta=thisDelta;leftIndex=i}}}}if(oGraph.end===null){rightIndex=chartOptions.x.length-1}else{i=chartOptions.x.indexOf(oGraph.end.toString());if(i>-1){rightIndex=i}else{bestDelta=null;for(i=0;i<chartOptions.x.length;i++){thisDelta=Math.abs(parseInt(chartOptions.x[i])-parseInt(oGraph.end));if(bestDelta===null||bestDelta>thisDelta){bestDelta=thisDelta;rightIndex=i}}}}maxIndex=chartOptions.x.length-1}else{leftIndex=oGraph.calculatedMapData.startDateIndex;rightIndex=oGraph.calculatedMapData.endDateIndex;maxIndex=oGraph.calculatedMapData.dates.length-1}$("#"+panelId+" span.interval-crop-period").html(period.units[oGraph.largestPeriod]+"s");$("#"+panelId+" div.crop-slider").slider("option","max",maxIndex).slider("option","values",[leftIndex,rightIndex])},closestDate:function closestDate(nearbyDate,seriesData,closestYet){var x;for(var i=0;i<seriesData.length;i++){if(Array.isArray(seriesData[i])){x=seriesData[i][0]}else{if(seriesData[i].dt){x=seriesData[i].dt.getTime()}else{x=seriesData[i].x}}if(Math.abs(nearbyDate-x)<Math.abs(nearbyDate-closestYet)||closestYet===undefined)closestYet=x}return closestYet},createMyGraph:function createMyGraph(ghash,onComplete){console.time("createMyGraph");callApi({command:globals.isEmbedded?"GetEmbeddedGraph":"GetFullGraph",ghash:ghash},function(oReturn,textStatus,jqXH){for(var ghandle in oReturn.graphs){var graphModel=new MD.Graph(oReturn.graphs[ghandle]);graphModel.fetchMap();createGraph(graphModel)}});function createGraph(graph){var fileAssets=(globals.isEmbedded?[]:graphScriptFiles).concat(graph.mapFile?[(globals.isEmbedded?"//www.mashabledata.com/global/js/maps/":"/global/js/maps/")+graph.mapFile+".js"]:[]);require(fileAssets,function(){buildGraphPanel(graph);if(onComplete)onComplete()})}console.timeEnd("createMyGraph")},makeChartOptionsObject:function makeChartOptionsObject(oGraph){console.time("makeChartOptionsObject");var i,j,dt,allX={},xVals={};var jschart={chart:{animation:false,type:"line",zoomType:"x",x:[]},exporting:{enabled:false},plotOptions:{area:{stacking:"normal"},scatter:{zIndex:20,showInLegend:false},series:{zIndex:10,marker:{enabled:true,radius:5,symbol:"circle",fillColor:"#FFFFFF",states:{hover:{enabled:true}}},shadow:false,states:{hover:{lineWidthPlus:1}},dataLabels:{align:"center",enabled:true,color:"#ffffff",formatter:function(){if(typeof this.point.id!="undefined"){return this.point.id}},y:11,x:-1}}},legend:{enabled:true},credits:{enabled:true,text:"created with MashableData.com",href:"http://www.mashabledata.com"},series:[],title:{text:oGraph.title,style:{cursor:"pointer"}},xAxis:{type:"datetime",min:oGraph.start===null?oGraph.intervals?intervalStartDt(oGraph):null:parseInt(oGraph.start),max:oGraph.end===null?null:parseInt(oGraph.end)},yAxis:[]};if(oGraph.controls)jschart.chart.height=(oGraph.controls.$thisPanel.height()-70-(oGraph.map?70:0))*(oGraph.mapsets||oGraph.pointsets?.4:1);if(oGraph.title.length==0){jschart.title.text="untitled - click to edit";jschart.title.style.color="grey";jschart.title.style.font="italic"}var lineIndex=0;function _firstLast(plotOrGraph,mashableDataDaysPerSeries){plotOrGraph.eachComponent(function(component){if(typeof component.firstdt!="undefined"&&component.src!="MashableData"){mashableDataDaysPerSeries.firstdt=typeof mashableDataDaysPerSeries.firstdt=="undefined"?parseInt(component.firstdt):Math.min(parseInt(component.firstdt),parseInt(mashableDataDaysPerSeries.firstdt));mashableDataDaysPerSeries.lastdt=typeof mashableDataDaysPerSeries.lastdt=="undefined"?parseInt(component.lastdt):Math.max(parseInt(component.lastdt),parseInt(mashableDataDaysPerSeries.lastdt))}})}oGraph.eachPlot(function(){var plot=this;plot.eachComponent(function(component){if(this.src=="MashableData"){var mashableDataDaysPerSeries=this;delete mashableDataDaysPerSeries.firstdt;delete mashableDataDaysPerSeries.lastdt;_firstLast(plot,mashableDataDaysPerSeries);if(typeof mashableDataDaysPerSeries.lastdt=="undefined")_firstLast(oGraph,mashableDataDaysPerSeries);mashableDataDaysPerSeries.data=MashableData.common.dateConversionData(mashableDataDaysPerSeries)}})});oGraph.eachComponent(function(i,plot){if(this.src=="MashableData"){var MashableSeries=this;if(plot.components.length==1){if(!oGraph.firstdt&&!oGraph.lastdt)oGraph.eachComponent(function(){_firstLast(oGraph,oGraph.assets[this.handle()])});this.firstdt=oGraph.firstdt;this.lastdt=oGraph.lastdt}else{delete MashableSeries.firstdt;delete MashableSeries.lastdt;plot.eachComponent(function(){_firstLast(MashableSeries,this)})}}});for(i=0;i<oGraph.plots.length;i++){var oPlot=oGraph.plots[i];var oSerie=oPlot.createHighSeries();if(!oPlot.options.color)oPlot.options.color=nextColor(oGraph.plots);var oDataSeries={name:oSerie.name,marker:{enabled:oGraph.type=="marker"},id:"P"+i,freq:oSerie.freq,color:oPlot.options.color,data:oSerie.data,yAxis:0};if(oPlot.options.type){if(oPlot.options.type!="default")oDataSeries.type=oPlot.options.type}if(oPlot.options.lineWidth){oDataSeries.lineWidth=oPlot.options.lineWidth;oDataSeries.states={hover:{lineWidth:parseInt(oPlot.options.lineWidth)+2}}}if(oPlot.options.lineStyle)oDataSeries.dashStyle=oPlot.options.lineStyle;if(oGraph.type=="area"||oDataSeries.stack=="area"){oDataSeries.stack=oSerie.units}for(j=0;j<oSerie.data.length;j++){allX[oSerie.data[j][0].toString()]=true}var units=oSerie.units;var newAxis={labels:{style:{color:"#333333"}},title:{text:units,style:{color:"#333333"}}};if(jschart.yAxis.length==0){jschart.yAxis.push(newAxis)}else{var bMatch=false;var iAxis;for(iAxis=0;iAxis<jschart.yAxis.length;iAxis++){if(jschart.yAxis[iAxis].title.text==units){oDataSeries.yAxis=iAxis;bMatch=true;break}}if(!bMatch){newAxis.title.style.color=oDataSeries.color;newAxis.labels.style.color=oDataSeries.color;jschart.yAxis[0].title.style.color=jschart.series[0].color;jschart.yAxis[0].labels.style.color=jschart.series[0].color;newAxis.opposite=true;jschart.yAxis.push(newAxis);oDataSeries.yAxis=iAxis}}jschart.series.push(oDataSeries);lineIndex++}for(var key in allX){jschart.chart.x.push(Number(key))}jschart.chart.x.sort(function(a,b){return parseInt(a)-parseInt(b)});for(i=0;i<jschart.yAxis.length;i++){jschart.series.push({type:"scatter",id:"labelsY-"+i,yAxis:i,data:[],doNotShow:true})}switch(oGraph.type){case"pie":var oPieSeries=[{type:"pie",data:[]}];var timePoint=oGraph.end?parseInt(oGraph.end):oGraph.lastdt;for(i=0;i<jschart.series.length;i++){oSerie=jschart.series[i];for(j=oSerie.data.length-1;j>=0;j--){if(oSerie.data[j][0]==timePoint){oPieSeries[0].data.push([oSerie.name,oSerie.data[j][1]]);break}}}jschart.series=oPieSeries;jschart.chart.type=oGraph.type;break;case"stacked-column":jschart.plotOptions.column={stacking:"normal"};for(i=0;i<jschart.series.length;i++){jschart.series[i].stack="stacked"}case"column":jschart.chart.type="column";break;case"area-percent":jschart.yAxis[0].title.text="percent";jschart.plotOptions.area.stacking="percent";case"area":jschart.chart.type="area";break;case"marker":break;case"auto":if(oGraph.smallestPeriod!=oGraph.largestPeriod){for(i=0;i<jschart.series.length;i++){if(oGraph.largestPeriod==jschart.series[i].freq){jschart.series[i].type="column";jschart.series[i].zIndex=8;jschart.series[i].pointRange=period.value[jschart.series[i].freq];jschart.series[i].pointPlacement="between";jschart.series[i].pointPadding=0;jschart.series[i].groupPadding=.05}}}else{var maxCount=0,onscreenCount;for(i=0;i<jschart.series.length;i++){if(jschart.series[i].freq){onscreenCount=0;for(j=0;j<jschart.series[i].data.length;j++){dt=jschart.series[i].data[j][0];if((!jschart.xAxis.min||jschart.xAxis.min<=dt)&&(!jschart.xAxis.max||jschart.xAxis.max>=dt))onscreenCount++}maxCount=Math.max(maxCount,onscreenCount)}}if(maxCount<=5){jschart.chart.type="column";if(maxCount==1&&oGraph.smallestPeriod){if(jschart.xAxis.min)jschart.xAxis.min-=period.value[oGraph.smallestPeriod]/4;if(jschart.xAxis.max)jschart.xAxis.max+=period.value[oGraph.smallestPeriod]/4}}}break;case"logarithmic":for(i=0;i<jschart.yAxis.length;i++){jschart.yAxis[i].type="logarithmic"}break;case"normalized-line":var firstDate;if(oGraph.start){firstDate=oGraph.start}else{firstDate=jschart.series[0].data[0][0]}var matched=false;while(!matched){matched=true;for(i=0;i<jschart.series.length;i++){if(jschart.series[i].sid){while(firstDate>jschart.series[i].data[0][0]){jschart.series[i].data.splice(0,1);if(jschart.series[i].data.length==0){break}if(firstDate<jschart.series[i].data[0][0]){firstDate=jschart.series[i].data[0][0]}}if(jschart.series[i].data.length==0){jschart.title.text="Error:  no common starting point for normalization";for(j=0;j<jschart.series.length;j++){jschart.series[j].data=[]}matched=true;break}matched=matched&&firstDate==jschart.series[i].data[0][0]}}}for(i=0;i<jschart.series.length;i++){for(j=jschart.series[i].data.length-1;j>=0;j--){jschart.series[i].data[j][1]=jschart.series[i].data[j][1]/jschart.series[i].data[0][1]}jschart.seriesyAxis=0}jschart.yAxis=[{title:{text:"Normalized to 1"}}]}if(oGraph.smallestPeriod)jschart.xAxis.minTickInterval=period.value[oGraph.smallestPeriod];console.timeEnd("makeChartOptionsObject");return jschart},buildGraphPanel:function buildGraphPanel(oGraph,panelId){if(globals.isEmbedded){console.time("buildGraphPanelCore");buildGraphPanelCore(oGraph);console.timeEnd("buildGraphPanelCore")}else{mask("drawing the graph"+(window.SVGAngle?"":"<br>Note: Graphs will draw 20 times faster in a modern browser such as Chrome, Firefox, Safari or Internet Exploer 9 or later"));window.setTimeout(function(){buildGraphPanelCore(oGraph,panelId)},20)}function buildGraphPanelCore(oGraph,panelId){var title,calculatedMapData,$thisPanel;var activeMapTab=0,mapMode;var missingAssets=[];oGraph.eachComponent(function(c,plot){if(!this.data&&!oGraph.assets[this.handle()]){missingAssets.push(this.handle());plot.components.splice(c--,1)}});console.time("buildGraphPanel:header");if(oGraph.title.length==0){var key,assetCount=0;for(key in oGraph.assets){assetCount++;if(assetCount>1)break}if(assetCount==1)oGraph.title=oGraph.assets[key].name}title=oGraph.title;var panelHTML,isEmbedded=globals.isEmbedded;if(isEmbedded){panelId="G"+oGraph.ghash;$thisPanel=$("div[data='"+oGraph.ghash+"']:first");if($thisPanel.length==0)return}else{if(!panelId){panelId=addTab(title);$("#graph-tabs li").find("[href='#"+panelId+"']").html(title)}$thisPanel=$("#"+panelId)}if(missingAssets.length>0){var msg="Unable to find data assets ("+missingAssets.join(", ")+") required by this graphs.";if(isEmbedded){$thisPanel.html(msg);return}else{dialogShow("data error",msg)}}if(oGraph.intervals==0)oGraph.intervals=null;var annotations=new MashableData.Annotator(panelId,_makeDirty);oGraph.controls={annotations:annotations,$thisPanel:$thisPanel,provenance:{},redraw:typeof _redraw=="undefined"?null:_redraw};console.timeEnd("buildGraphPanel:header");if(isEmbedded){panelHTML='<div class="mashabledata_chart-map">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<div class="mashabledata_maptabs"></div>'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+"</div>"+"</div>"+'<div class="mashabledata_graph-analysis"></div>'+"</div>"}else{panelHTML='<div class="provenance graph-sources graph-subpanel" style="display: none;"></div>'+'<div class="graph-chart graph-subpanel">'+'<div class="resize">'+"<p>Drag the lower nd right edge of the visualizations' borders to fix the exact dimensions of the maps and graphs.  The default is to expand to fit the container.  Exact sizing ensures that what you see in the workbench is what your website's visitors will see.</p>"+'<button class="size_reset">use default sizing</button><br />'+'<button class="size_set">finished resizing</button>'+"</div>"+'<div class="graph_control_panel" style="font-size: 11px !important;">'+'<div class="configuration" style="border: none;">'+"<fieldset>"+"<legend>&nbsp;Configure&nbsp;</legend>"+'<div class="graph-type">default graph type '+'<select class="graph-type">'+'<option value="auto">auto (line &amp; column)</option>'+'<option value="line">line</option>'+'<option value="marker">line with markers</option>'+'<option value="column">column</option>'+'<option value="stacked-column">stacked column</option>'+'<option value="area-percent">stacked percent</option>'+'<option value="area">stacked area</option>'+'<option value="logarithmic">logarithmic</option>'+'<option value="normalized-line">normalized line</option>'+'<option value="pie">pie</option>'+"</select>"+"</div>"+'<div class="graph-map-mode">default map type '+'<select class="graph-map-mode">'+'<option value="heat">colored heat map of values</option>'+'<option value="abs-change">colored heat map of changes</option>'+'<option value="percent-change">colored heat map of percent changes</option>'+'<option value="bubbles">overlay circles to show values</option>'+'<option value="change-bubbles">overlay circles to show changes</option>'+'<option value="max">shows when max value was reached</option>'+'<option value="min">shows when min value was reached</option>'+'<option value="treemap">abstract values to rectangles</option>'+'<option value="change-treemap">abstract change to rectangles</option>'+"</select>"+"</div>"+'<div class="change-basemap">base map '+'<select class="change-basemap"></select>'+'<div class="mashabledata_legend"><label><input type="checkbox" class="mashabledata_legend" '+(oGraph.mapconfig.showLegend?"checked":"")+">show legend for all maps</label></div>"+'<div class="map-viz-select">map interactive'+'<select class="map-viz-select">'+"</select>"+"</div>"+"</div>"+'<div class="crop-tool"><fieldset><legend>Crop graph</legend>'+"<table>"+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-no-crop" class="rad-no-crop"></td><td><label for="'+panelId+'-rad-no-crop">no cropping (graph will expand as new data is gathered)</label></td></tr>'+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-hard-crop" class="rad-hard-crop"></td><td>'+'<div class="crop-dates"><i>select this option and slide endpoints for a fixed crop</i></div>'+'<div class="crop-slider"></div>'+"</td></tr>"+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-interval-crop" class="rad-interval-crop"></td>'+'<td><label for="'+panelId+'-rad-interval-crop">show latest <input class="interval-crop-count" value="'+(oGraph.intervals||5)+'"> <span class="interval-crop-period"></span></label></td></tr>'+"</table>"+'<button class="graph-crop" style="display: none;">crop</button></fieldset>'+"</div>"+'<button class="provenance">more configurations</button>'+'<button class="resize">set size</button>'+"</fieldset>"+"</div>"+'<div class="annotations"><fieldset><legend>Chart annotations</legend>'+'<table class="annotations"></table>'+"</fieldset>"+"</div>"+'<div class="downloads">'+"<fieldset>"+"<legend>&nbsp;Download&nbsp;</legend>"+'<select class="download-selector"></select> '+"format: "+'<span title="download the graph as a PNG formatted image" class="md-png rico export-chart">PNG</span>'+'<span title="download the graph as a SVG formatted vector graphic"class="md-svg rico export-chart">SVG</span>'+'<span title="download the graph as a PDF document" class="md-pdf rico export-chart">PDF</span>'+'<button class="download-data" title="Download the graph data as an Excel workbook">download data</button>'+"</fieldset>"+"</div>"+'<div class="sharing">'+"<fieldset>"+"<legend>&nbsp;Sharing&nbsp;</legend>"+'<div class="share-links">'+'<a href="#" class="post-facebook"><img src="images/icons/facebook.png" />facebook</a> '+'<a class="graph-email">email </a> '+'<button class="graph-link">link </button>'+'<button class="graph-embed">embed </button>'+"</div>"+'<div class="searchability">'+'<input type="radio" name="'+panelId+'-searchability" id="'+panelId+'-searchable" value="Y" '+(oGraph.published=="Y"?"checked":"")+' /><label for="'+panelId+'-searchable">Public Graphs searchable</label>'+'<input type="radio" name="'+panelId+'-searchability" id="'+panelId+'-private" value="N" '+(oGraph.published=="N"?"checked":"")+' /><label for="'+panelId+'-private">'+(account.info.orgName?"restrict to "+account.info.orgName:"private")+"</label>"+"</div>"+"</fieldset>"+"</div>"+'<br /><button class="graph-save">save</button> <button class="graph-saveas">save as</button> <button class="graph-close">close</button> <button class="graph-delete">delete</button><br />'+"</div>"+'<div class="chart-map-scroll-window">'+'<div class="mashabledata_chart-map" style="width:75%;display:inline;float:left;">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<div class="mashabledata_maptabs"></div>'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="display:none;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<button class="merge group hidden" disabled="disabled">group</button>'+'<button class="merge ungroup hidden" disabled="disabled">ungroup</button>'+"</div>"+"</div>"+"</div>"+'<div height="30px"><textarea style="width:98%;height:50px;margin-left:5px;" class="graph-analysis" maxlength="1000" /></div>'+"</div>"+"</div>"}$thisPanel.html(panelHTML);sizeShowPanels(oGraph);var chart,grid;console.timeEnd("buildGraphPanel:thisPanel");console.time("buildGraphPanel:thisPanel events");if(isEmbedded){$thisPanel.find("div.mashabledata_graph-analysis").html(oGraph.analysis)}else{$thisPanel.find("button.provenance").button().click(function(){provenance.build();$thisPanel.find("div.provenance").show();$thisPanel.find("div.graph-chart").hide()});$thisPanel.find("button.resize").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).click(function(){_makeDirty();if(oGraph.controls.map)oGraph.controls.map.remove();if(oGraph.controls.chart){oGraph.controls.chart.destroy();delete oGraph.controls.chart;$thisPanel.find(".mashabledata_chart").css("background-color","grey")}$thisPanel.find("div.graph_control_panel").hide();$thisPanel.find("div.resize").show();$thisPanel.find(".mashabledata_chart, .mashabledata_cube-viz, .mashabledata_jvmap").resizable({helper:"ui-resizable-helper",resize:function(event,ui){},stop:function(event,ui){var $container,$chart,$viz,viz,$map,map,deltaWidth;$container=$thisPanel.find(".mashabledata_chart-map");$chart=$thisPanel.find(".mashabledata_chart");$viz=$thisPanel.find(".mashabledata_cube-viz");$map=$thisPanel.find(".mashabledata_jvmap");if(ui.originalElement.hasClass("mashabledata_chart")){viz=$viz.is(":visible")?1:0;map=$map.is(":visible")?1:0;deltaWidth=ui.size.width-ui.originalSize.width;if(viz)$viz.width($viz.width()+deltaWidth/(viz+map));if(map)$map.width($map.width()+deltaWidth/(viz+map));$container.width($container.width()+deltaWidth);if(!oGraph.mapconfig.sizes)oGraph.mapconfig.sizes={}}if(ui.originalElement.hasClass("mashabledata_cube-viz")){$container.width($container.width()+ui.size.width-ui.originalSize.width);$thisPanel.find(".mashabledata_jvmap").height(ui.size.height).width($container.width()-ui.size.width-10)}if(ui.originalElement.hasClass("mashabledata_jvmap")){$container.width($container.width()+ui.size.width-ui.originalSize.width);if(oGraph.plots&&oGraph.hasMapViz())$thisPanel.find(".mashabledata_chart").width($container.width());
$thisPanel.find(".mashabledata_jvmap").height(ui.size.height).width(ui.size.width);if(oGraph.hasMapViz())$viz.height(ui.size.height).width($viz.width()-ui.size.width+ui.originalSize.width)}oGraph.mapconfig.sizes={};if($chart.width()&&$chart.height()&&oGraph.plots){oGraph.mapconfig.sizes.chart={height:$chart.height(),width:$chart.width()}}if($map.width()&&$map.height()&&(oGraph.pointsets||oGraph.mapsets)){oGraph.mapconfig.sizes.map={height:$map.height(),width:$map.width()}}if($viz.width()&&$viz.height()&&oGraph.hasMapViz()){oGraph.mapconfig.sizes.viz={height:$viz.height(),width:$viz.width()}}_redraw()}})});$thisPanel.find("button.size_reset").button().click(function(){delete oGraph.mapconfig.sizes;_endResize()});$thisPanel.find("button.size_set").button().click(_endResize);function _endResize(){$(".mashabledata_chart, .mashabledata_cube-viz, .mashabledata_jvmap").resizable("destroy");$thisPanel.find("div.graph_control_panel").show();$thisPanel.find("div.resize").hide();_redraw()}$thisPanel.find("button.download-data").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){downloadGraphData(panelId)});function downloadList(){var table=$thisPanel.find("div.mashabledata_cube-viz table").get(0);var grid=[];for(var r=0;r<table.rows.length;r++){grid.push([table.rows[r].cells[0].innerHTML.replace("<br>",""),table.rows[r].cells[1].innerHTML,table.rows[r].cells[2].innerHTML])}downloadMadeFile({filename:oGraph.title,data:JSON.stringify([{name:"ranked list",grid:grid}]),url:"excel.php"})}$thisPanel.find(".graph-analysis").val(oGraph.analysis);$thisPanel.find("select.download-selector").change(function(){if($(this).val()=="map"){if(!oGraph.mapsets&&!oGraph.pointsets){dialogShow("no map","This graph does not have a map to download.  Maps are added to graphs by finding a series that belongs to a map set or a marker set and mapping the set.");$(this).val("chart")}}else{if(!oGraph.plots){dialogShow("no chart","This graph does not have a chart to download.");$(this).val("map")}}});$thisPanel.find(".export-chart").click(function(){var type,$this=$(this);if($this.hasClass("md-jpg"))type="image/jpeg";if($this.hasClass("md-png"))type="image/png";if($this.hasClass("md-svg"))type="image/svg+xml";if($this.hasClass("md-pdf"))type="application/pdf";_exportChart(type)});$thisPanel.find("a.post-facebook").click(function(){var svg;if(oGraph.mapsets||oGraph.pointsets){svg=cleanMapSVG($map.container.html(),oGraph.mapconfig.mapBackground||globals.mapBackground)}else{annotations.sync();svg=oGraph.controls.chart.getSVG()}$.ajax({type:"POST",url:"export/index.php",dataType:"json",data:{type:"FB",width:"800",svg:svg},success:function(chartInfo,textStatus,jqXH){var body=panelGraphs[panelId].analysis;var caption=panelGraphs[panelId].title;var obj={method:"feed",link:"http://www.mashabledata.com/workbench#/t=g1&graphcode="+panelGraphs[panelId].ghash,picture:chartInfo.imageURL,message:body,name:"MashableData visualization",caption:caption,description:body};function callback(response){alert("Post ID: "+response["post_id"])}FB.ui(obj,callback)},error:function(response,textStatus,jqXH){console.log(textStatus)}})});$thisPanel.find(".graph-email").button({icons:{secondary:"ui-icon-mail-closed"}}).click(function(){if(oGraph.isDirty){dialogShow("graph not saved","Please save the graph first so that links will show the graph as currently displayed.")}});function _setEmailLink(){if(oGraph.ghash){var link="mailto: "+"?subject="+escape(oGraph.title||"link to my MashableData visualization")+"&body="+escape((oGraph.analysis||"Link to my interactive visualization on MashableData.com:")+"<br><br>http://www.mashabledata.com/workbench/#/t=g2&graphcode="+oGraph.ghash);$thisPanel.find(".email-link").attr("href",link);$thisPanel.find(".graph-email").off().attr("href",link)}}_setEmailLink();$thisPanel.find(".graph-embed").button({icons:{secondary:"ui-icon-script"}}).click(function(){if(oGraph.isDirty){dialogShow("graph not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var linkDivHTML='<div id="embed-info">'+'<button class="right" id="embed-info-close">close</button>'+'<b>link code: </b><span id="link-ghash">'+oGraph.ghash+"</span><br><br>"+'<em>To preview the embedded graph and for instructions for embedding it on your website, please visit this <a href="/preview'+(globals.isDev?"dev":"")+"?graphcode="+oGraph.ghash+'" target="_blank">graph\'s preview page</a>. '+'<textarea id="link-html">&lt;div class=&quot;mashabledata_embed&quot; data=&quot;'+oGraph.ghash+"&quot;&gt;&lt;/div&gt;</textarea>"+"</div>";$.fancybox(linkDivHTML,{width:600,height:"auto",showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#embed-info-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})});$thisPanel.find(".graph-link").button({icons:{secondary:"ui-icon-link"}}).click(function(){if(oGraph.isDirty){dialogShow("Graph is not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var offset=$(this).offset();var linkDivHTML='<div id="link-editor">'+'<button class="right" id="link-editor-close">close</button>'+'<button id="ghash-reset" class="ui-state-error right">reset link code</button>'+'<b>link code: </b><span id="link-ghash">'+oGraph.ghash+"</span><br><br>"+"<em>The code below will create a link to your graph</em>"+'<textarea id="link-html">&lt;a href=&quot;http://www.mashabledata.com/workbench/#/t=g2&graphcode='+oGraph.ghash+"&quot;&gt;"+(oGraph.title||"MashableData graph")+"&lt;/a&gt;</textarea>"+"</div>";$.fancybox(linkDivHTML,{width:600,height:100,showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#link-editor-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()});$("#ghash-reset").button({icons:{secondary:"ui-icon-refresh"}}).click(function(){dialogShow("confirm link code reset","If you have emailed a link to this graph or posted it on FaceBook or Twitter, those links will no longer work once the graph's link code is reset. Plese confirm to reset.",[{text:"Confirm",click:function(){$(this).dialog("close");$("#ghash-reset").button("disable");var oldHash=oGraph.ghash;oGraph.resetHash(function(){var $linkHtml=$("#link-html");$linkHtml.html($linkHtml.html().replace(oldHash,oGraph.ghash));$("#link-ghash").html(oGraph.ghash)})}},{text:"Cancel",click:function(){$(this).dialog("close")}}])})});$thisPanel.find(".searchability").buttonset().find("#"+panelId+"-private").button("option","icons",{primary:"ui-icon-locked"}).end().find("#"+panelId+"-searchable").button("option","icons",{primary:"ui-icon-search"}).end().find("input").click(function(){oGraph.published=$(this).val();_makeDirty()});if(oGraph.start&&oGraph.end){$thisPanel.find(".rad-hard-crop").attr("checked",true)}else{if(oGraph.intervals){$thisPanel.find(".rad-interval-crop").attr("checked",true)}else{$thisPanel.find(".rad-no-crop").attr("checked",true)}}var hardCropFromSlider=function(){var values=$thisPanel.find(".crop-slider").slider("values");$thisPanel.find(".rad-hard-crop").attr("checked",true);oGraph.intervals=null;if(oGraph.controls.chart){oGraph.start=oGraph.controls.chart.options.chart.x[values[0]];oGraph.end=oGraph.controls.chart.options.chart.x[values[1]]}else{oGraph.start=oGraph.calculatedMapData.dates[values[0]].dt.getTime();oGraph.end=oGraph.calculatedMapData.dates[values[1]].dt.getTime()}_redraw()};var cropDates=function(slider){var values=$(slider).slider("values");if(oGraph.controls.chart){return formatDateByPeriod(oGraph.controls.chart.options.chart.x[values[0]],oGraph.smallestPeriod)+" - "+formatDateByPeriod(chart.options.chart.x[values[1]],oGraph.smallestPeriod)}else{return formatDateByPeriod(oGraph.calculatedMapData.dates[values[0]].dt.getTime(),oGraph.calculatedMapData.freq)+" - "+formatDateByPeriod(oGraph.calculatedMapData.dates[values[1]].dt.getTime(),oGraph.calculatedMapData.freq)}};$thisPanel.find("div.crop-slider").slider({range:true,stop:function(){hardCropFromSlider()},change:function(){if(oGraph.controls.chart){$thisPanel.find(".crop-dates").html(cropDates(this))}},slide:function(){$thisPanel.find(".crop-dates").html(cropDates(this))}});$("#"+panelId+"-rad-interval-crop").change(function(){if($(this).val()=="on"){var interval=parseInt($thisPanel.find("input.interval-crop-count").val());if(!interval||interval<1){interval=1;$thisPanel.find("input.interval-crop-count").val(interval)}oGraph.intervals=interval;oGraph.start=null;oGraph.end=null;_redraw()}});$("#"+panelId+"-rad-no-crop").change(function(){oGraph.intervals=null;oGraph.start=null;oGraph.end=null;oGraph.minZoom=oGraph.firstdt;oGraph.maxZoom=oGraph.lastdt;_redraw()});$thisPanel.find("input.interval-crop-count").spinner({min:1,incrementalType:false,stop:function(event,ui){oGraph.start=null;oGraph.end=null;if(oGraph.intervals!=parseInt($(this).val())){oGraph.intervals=parseInt($(this).val());_redraw()}}});$thisPanel.find("button.graph-crop").click(function(){var graph=panelGraphs[panelId];graph.start=graph.minZoom>graph.firstdt?graph.minZoom:graph.firstdt;graph.end=graph.maxZoom<graph.lastdt?graph.maxZoom:graph.lastdt;$(this).attr("disabled","disabled");setCropSlider(panelId);$("#"+panelId+"-rad-hard-crop").click()});$thisPanel.find("div.annotations fieldset").height($thisPanel.innerHeight()-$thisPanel.find("div.configuration").outerHeight()-$thisPanel.find("div.downloads").outerHeight()-$thisPanel.find("div.sharing").outerHeight()-50-30);$thisPanel.find("input.graph-publish").change(function(){oGraph.published=this.checked?"Y":"N"});$thisPanel.find("select.graph-type").val(oGraph.type).change(function(){if($(this).val()=="logarithmic"){for(var y=0;y<chart.yAxis.length;y++){if(chart.yAxis[y].getExtremes().dataMin<=0){$thisPanel.find("select.graph-type").val(oGraph.type);dialogShow("Logarithmic scaling not available","Logarithmic Y-axis scaling is not allowed if negative values are present");return false}}}oGraph.type=$(this).val();_redraw()});fillCubeSelector($thisPanel.find("select.map-viz-select"),[],[],oGraph);$thisPanel.find("select.map-viz-select").change(function(){var val=$(this).val();if(!isNaN(val)){if(val!=oGraph.cubeid){oGraph.cubeid=val;delete oGraph.assets.cube;oGraph.cubename=this.options[this.selectedIndex].text;_redraw()}}else{if(val!=oGraph.mapconfig.mapViz||"none"){delete oGraph.cubeid;delete oGraph.cubename;if(val=="none"){delete oGraph.mapconfig.mapViz}else{oGraph.mapconfig.mapViz=val}_redraw()}}});$thisPanel.find("select.graph-map-mode").val(oGraph.mapconfig.mapMode||"default").change(function(){if(this.value=="default"){delete oGraph.mapconfig.mapMode}else{oGraph.mapconfig.mapMode=this.value}_redraw()});$thisPanel.find("select.change-basemap").html(_fillChangeMapSelect()).change(function(){var $mapSelect=$(this);var newGraph=oGraph.clone();var newMapCode=$mapSelect.val();$mapSelect.val(oGraph.map);newGraph.changeMap(newMapCode,function(){buildGraphPanel(newGraph)})});_showChangeSelectors()}var summationMap;if(!isEmbedded){$thisPanel.find(".graph-analysis").keydown(function(){panelGraphs[panelId].analysis=this.value;_makeDirty()})}oGraph.isDirty=!oGraph.gid;if(!isEmbedded){$thisPanel.find("button.graph-save").button({icons:{secondary:"ui-icon-disk"},disabled:!oGraph.isDirty}).click(_saveThisGraph);$thisPanel.find("button.graph-saveas").button({icons:{secondary:"ui-icon-copy"},disabled:oGraph.isDirty}).click(function(){delete oGraph.gid;graphTitle.show(this,_saveThisGraph)});$thisPanel.find("button.graph-close").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){$("ul#graph-tabs a[href=#"+panelId+"]").siblings("span").click()});$thisPanel.find("button.graph-delete").button({icons:{secondary:"ui-icon-trash"},disabled:!oGraph.gid}).addClass("ui-state-error").click(function(){dialogShow("Permanently Delete Graph","Are you sure you want to delete this graph?",[{text:"Delete",id:"btn-dia-enable",click:function(){oGraph.deleteGraph(function(jsoData){if(jsoData){$('#canvas a[href="#'+visiblePanelId()+'"]').closest("li").find("span").click();var $trMyGraph=$dtMyGraphs.find("td.title span.handle[data='G"+oGraph.gid+"']").closest("tr");if($trMyGraph.length==1){$dtMyGraphs.fnDeleteRow($trMyGraph.get(0))}}});$(this).dialog("close")}},{text:"Cancel",id:"btn-dia-disable",click:function(){$(this).dialog("close")}}])})}console.timeEnd("buildGraphPanel:thisPanel events");calcGraphMinMaxZoomPeriod(oGraph);panelGraphs[panelId]=oGraph;if(!isEmbedded){console.time("buildGraphPanel:provController");var provenance=new ProvenanceController(panelId);oGraph.controls.provenance=provenance;console.timeEnd("buildGraphPanel:provController")}if(oGraph.plots){console.time("buildGraphPanel:build annotations");chart=chartPanel(panelId);annotations.build();console.timeEnd("buildGraphPanel:build annotations");$thisPanel.find("div.highcharts-container").mousedown(function(b){if(b.which==3){}})}var $map=null,vectorMapSettings,val,mergablity;console.time("buildGraphPanel:_drawMap");oGraph.fetchMap(function(){_drawMap();console.timeEnd("buildGraphPanel:_drawMap");setCropSlider(panelId);console.timeEnd("buildGraphPanel: "+panelId);if(!isEmbedded){unmask();setPanelHash(oGraph.ghash,$thisPanel.get(0).id)}});function _fillChangeMapSelect(){if(!oGraph.map)return"";var handle,i,map,html='<option value="'+oGraph.map+'">'+globals.maps[oGraph.map].name+"</option>",maps=[];for(handle in oGraph.assets){if(handle[0]=="M"&&oGraph.assets[handle].maps){if(Object.prototype.toString.call(oGraph.assets[handle].maps)=="[object String]")oGraph.assets[handle].maps=JSON.parse("{"+oGraph.assets[handle].maps+"}");for(map in oGraph.assets[handle].maps){if(map!=oGraph.map){maps.push(map)}}}}maps.sort();for(i=0;i<maps.length;i++){html+='<option value="'+maps[i]+'">'+globals.maps[maps[i]].name+"</option>"}return html}function _showChangeSelectors(){if(oGraph.plots){$thisPanel.find("div.graph-type").show()}else{$thisPanel.find("div.graph-type").hide()}if(oGraph.mapsets||oGraph.pointsets){$thisPanel.find("div.change-basemap, div.graph-map-mode, div.map-viz-select").show()}else{$thisPanel.find("div.change-basemap, div.graph-map-mode, div.map-viz-select").hide()}var downloadOptions="";if(oGraph.plots)downloadOptions+='<option value="chart">chart</option>';if(oGraph.mapsets||oGraph.pointsets)downloadOptions+='<option value="map" selected>map</option>';if(oGraph.hasMapViz())downloadOptions+='<option value="cube">supplemental bar chart</option>';$(".download-selector").html(downloadOptions)}function _setMapTabs(){if(oGraph.mapsets&&oGraph.mapsets.length>1){var $maptabs=$thisPanel.find("div.mashabledata_maptabs"),count=oGraph.mapsets.length,maxWidth=parseInt($thisPanel.find(".mashabledata_jvmap").innerWidth()/count),mapTabsHTML="",ms;for(ms=0;ms<count;ms++){mapTabsHTML+='<div class="mashabledata_maptab'+(ms==activeMapTab?" mashabledata_activetab":"")+'" style="max-width: '+maxWidth+'px" data="'+ms+'">'+oGraph.mapsets[ms].name()+"</div>"}$maptabs.html(mapTabsHTML).show().find(".mashabledata_maptab").click(function(){var i=$(this).attr("data");if(i!=activeMapTab){$thisPanel.find("div.mashabledata_activetab").removeClass("mashabledata_activetab");$(this).addClass("mashabledata_activetab");activeMapTab=i;_drawMap()}})}else{$thisPanel.find("div.mashabledata_maptabs").hide()}}function _drawMap(){makeLegend=_drawMap_makeLegend;if(oGraph.map&&(oGraph.mapsets||oGraph.pointsets)){if($map)$map.remove();console.time("buildGraphPanel:_drawMap:_setMapTabs");_setMapTabs();console.timeEnd("buildGraphPanel:_drawMap:_setMapTabs");console.time("buildGraphPanel:_drawMap:_calcMap");calculatedMapData=_calcMap(oGraph,activeMapTab);oGraph.calculatedMapData=calculatedMapData;console.timeEnd("buildGraphPanel:_drawMap:_calcMap");console.time("buildGraphPanel:_drawMap:_calcAttributes");if(oGraph.mapsets){oGraph.mapsets[activeMapTab].calculatedMapData=calculatedMapData;mapMode=oGraph.mapsets[activeMapTab].mapMode();switch(mapMode){case"heat":case"abs-change":case"percent-change":_calcAttributes(oGraph);break;case"min":case"max":_calcMinMax(mapMode);break;case"bubbles":case"change-bubbles":_drawMap_bubbleCalc();break;case"treemap":case"change-treemap":if($map){$map.remove();$map=false}_setStartEndDateIndexes();break}}else{if(oGraph.pointsets)_calcAttributes(oGraph)}console.timeEnd("buildGraphPanel:_drawMap:_calcAttributes");if(mapMode!="treemap"&&mapMode!="change-treemap"){console.time("buildGraphPanel:_drawMap:fillScaling+Scaling");var fillScaling=fillScalingCount(oGraph.pointsets);var areaScaling=areaScalingCount(oGraph.pointsets);console.timeEnd("buildGraphPanel:_drawMap:fillScaling+Scaling");console.time("buildGraphPanel:_drawMap:jvm call");var minScale=/us.._merc_en/.test(oGraph.mapFile)?.9:1;var mapFocus={scale:minScale,x:.5,y:.5};vectorMapSettings={map:oGraph.mapFile,zoomMin:minScale,focusOn:mapFocus,backgroundColor:oGraph.mapconfig.mapBackground||globals.mapBackground,zoomOnScroll:false,zoomAnimate:true,markersSelectable:true,markerStyle:{initial:{r:oGraph.mapconfig.maxRadius||5},selected:{"stroke-width":4,stroke:"yellow"}},regionStyle:{selected:{"stroke-width":2,stroke:"black",fill:"#ffff80"},hover:{"stroke-width":2,stroke:"black","fill-opacity":1}},series:{regions:[{attribute:"fill",scale:[oGraph.mapsets&&oGraph.mapsets[activeMapTab].options.negColor||globals.MAP_COLORS.NEG,globals.MAP_COLORS.MID,oGraph.mapsets&&oGraph.mapsets[activeMapTab].options.posColor||globals.MAP_COLORS.POS],min:calculatedMapData.regionMin,max:calculatedMapData.regionMax}],markers:[{attribute:"r"},{attribute:"fill"},{attribute:"stroke"}]},onViewportChange:function(event,scale){},onRegionOver:function(event,code){_drawMap_updateCubeVizFromMap(code,true)},onRegionOut:function(event,code){_drawMap_updateCubeVizFromMap(code,false)},onRegionTipShow:function(event,label,code){var i,sparkData=[],currentIndex,containingDateData=_getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[val].s);if(calculatedMapData.regionColors){var containingDateColor=_getMapDataByContainingDate(calculatedMapData.regionColors,calculatedMapData.dates[val].s);if(containingDateColor&&typeof containingDateColor[code]!="undefined"){for(i=0;i<calculatedMapData.dates.length;i++){if(calculatedMapData.regionData[calculatedMapData.dates[i].s]&&typeof calculatedMapData.regionData[calculatedMapData.dates[i].s][code]!="undefined"){sparkData.push([calculatedMapData.dates[i].dt.getTime(),calculatedMapData.regionData[calculatedMapData.dates[i].s][code]]);if(i==val)currentIndex=sparkData.length-1}}var y=containingDateData[code];var valueReport,startingDateDate,y0;switch(mapMode){case"heat":valueReport=typeof y=="undefined"?"no data available":common.numberFormat(y,parseInt(y)==y?0:2)+" "+(calculatedMapData.mapUnits||"");break;case"abs-change":startingDateDate=_getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[calculatedMapData.startDateIndex].s);y0=startingDateDate[code];valueReport=typeof y=="undefined"||typeof y0=="undefined"?"no data available":(y-y0>0?"+":"")+common.numberFormat(y-y0,parseInt(y-y0)==y-y0?0:2)+" "+(calculatedMapData.mapUnits||"")+" from "+calculatedMapData.dates[calculatedMapData.startDateIndex].s;break;case"percent-change":startingDateDate=_getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[calculatedMapData.startDateIndex].s);y0=startingDateDate[code];valueReport=typeof y=="undefined"||typeof y0=="undefined"?"no data available":common.numberFormat(100*(y-y0)/y0,1)+"% change from "+calculatedMapData.dates[calculatedMapData.startDateIndex].s;break}label.html("<div><b>"+$map.getRegionName(code)+"</b><br>"+calculatedMapData.title+":<br>"+valueReport+'</div><div class="inlinesparkline" style="height: 30px;width: '+Math.min(400,10*sparkData.length)+'px;margin:0 5px;"></div>').css("z-Index",400);var sparkOptions={grid:{show:false}};var series=[{data:sparkData,color:"#ddddff",lines:{lineWidth:.8,fill:true},shadowSize:0}];if(sparkData.length<10)series.bars={show:true};if(typeof currentIndex!="undefined"){series.push({data:[sparkData[currentIndex]],points:{show:true,radius:1,fillColor:"#ff0000"},color:"#ff0000"})}label.find("div.inlinesparkline").plot(series,sparkOptions)}}},regionsSelectable:typeof oGraph.mapsets!="undefined",markers:calculatedMapData.markers,onMarkerTipShow:function(event,label,code){var i,sparkData=[],currentIndex,dateKey=calculatedMapData.dates[val].s,containingDateData=_getMapDataByContainingDate(calculatedMapData.markerData,dateKey);for(i=0;i<calculatedMapData.dates.length;i++){if(typeof calculatedMapData.markerData[calculatedMapData.dates[i].s]!="undefined"){sparkData.push([calculatedMapData.dates[i].dt.getTime(),calculatedMapData.markerData[calculatedMapData.dates[i].s][code].r||calculatedMapData.markerData[calculatedMapData.dates[i].s][code].f]);if(i==val)currentIndex=sparkData.length-1}}if(containingDateData&&containingDateData[code]){var html,y0,y=containingDateData[code].r;if(_drawMap_isBubble()){var regionNames=[],regionCodes=code.split("+");for(i=0;i<regionCodes.length;i++){regionNames.push($map.getRegionName(regionCodes[i]))}html="<div>"+calculatedMapData.title+"<br><b>"+regionNames.join(" + ")+"</b> "}else{html="<div><b>"+label.html()+":</b><br> "}if(oGraph.mapsets&&mapMode=="change-bubbbles"){var startDateKey=calculatedMapData.dates[calculatedMapData.startDateIndex].s;var startDateData=_getMapDataByContainingDate(calculatedMapData.markerData,startDateKey);y=containingDateData[code].r;y0=startDateData[code].r;html+=(y-y0>0?"+":"")+common.numberFormat(y-y0,parseInt(y-y0)==y-y0?0:2)+" "+(calculatedMapData.radiusUnits||"")+" change from "+startDateKey+" to "+dateKey+"<br>";html+=common.numberFormat(y,parseInt(y)==y?0:2)+" "+(calculatedMapData.radiusUnits||"")+" in "+dateKey+"<br>";html+=common.numberFormat(y0,parseInt(y0)==y0?0:2)+" "+(calculatedMapData.radiusUnits||"")+" in "+startDateKey+"<br>"}else{if(containingDateData[code].r)html+=common.numberFormat(containingDateData[code].r,parseInt(containingDateData[code].r)==containingDateData[code].r?0:2)+" "+(calculatedMapData.radiusUnits||"")+"<br>";if(containingDateData[code].f)html+=common.numberFormat(containingDateData[code].f,parseInt(containingDateData[code].f)==containingDateData[code].f?0:2)+" "+(calculatedMapData.fillUnits||"")+"<br>"}html+='</div><div class="inlinesparkline" style="height: 30px;width: '+Math.min(400,10*sparkData.length).toString()+'px;margin:0 5px;"></div>';label.html(html).css("z-Index",400);var sparkOptions={grid:{show:false}};var series=[{data:sparkData,color:"#ddddff",lines:{lineWidth:.8,fill:true},shadowSize:0}];if(sparkData.length<10)series.bars={show:true};if(typeof currentIndex!="undefined"){series.push({data:[sparkData[currentIndex]],points:{show:true,radius:1,fillColor:"#ff0000"},color:"#ff0000"})}label.find("div.inlinesparkline").plot(series,sparkOptions)}},onRegionClick:function(){},onRegionSelected:function(e,code,isSelected){if(oGraph.hasMapViz()){if(oGraph.cubeid){_drawMap_makeMakeViz(code,isSelected)}else{_drawMap_updateCubeVizFromMap(code,isSelected)}}_drawMap_setMergablity();var selectedMarkers=$map.getSelectedMarkers();if(selectedMarkers.length>0){$thisPanel.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("enable");return}var selectedRegions=$map.getSelectedRegions();if($graphSelected.is(":visible")){for(var i=0;i<selectedRegions.length;i++){if(calculatedMapData.regionColors){for(var dateKey in calculatedMapData.regionColors){if(typeof calculatedMapData.regionColors[dateKey][selectedRegions[i]]!="undefined"){$thisPanel.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("enable");return}break}}}$thisPanel.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("disable")}},onMarkerSelected:function(e,code,isSelected){vectorMapSettings.onRegionSelected(e,code,isSelected)},onZoom:function(e,scale){transferTransform()}};if($map)$map.remove();var $jvmap=$thisPanel.find("div.mashabledata_jvmap");$jvmap.html("").vectorMap(vectorMapSettings);$map=$jvmap.vectorMap("get","mapObject");if(oGraph.mapconfig.showLegend)_drawMap_makeLegend($map)}else{$map=false}console.timeEnd("buildGraphPanel:_drawMap:jvm call");val=calculatedMapData.endDateIndex;console.time("buildGraphPanel:mapControls");oGraph.controls.map=$map;var $mapDateDiv=$('<div class="mashabledata_map-date"></div>').prependTo($thisPanel.find("div.jvectormap-container"));var $g=$thisPanel.find("div.mashabledata_jvmap svg g:first");if(_drawMap_isBubble()){_drawMap_positionBubbles();$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);$thisPanel.find("button.merge").show()}var $mapSlider=$thisPanel.find(".mashabledata_map-slider");if(calculatedMapData.startDateIndex!=calculatedMapData.endDateIndex){if($mapSlider.hasClass("ui-slider"))$mapSlider.slider("destroy");$mapSlider.show().slider({value:calculatedMapData.endDateIndex,min:calculatedMapData.startDateIndex,max:calculatedMapData.endDateIndex,step:1,change:function(event,ui){val=ui.value;_drawMap_setRegionsMarkersAttribute(val)}}).slider("value",calculatedMapData.endDateIndex)}else{$mapSlider.hide();_drawMap_setRegionsMarkersAttribute(calculatedMapData.startDateIndex)}var $graphSelected=$thisPanel.find(".mashabledata_map-graph-selected");$graphSelected.button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var selectedRegions=$map.getSelectedRegions();var selectedMarkers=$map.getSelectedMarkers();var popGraph=new MD.Graph,plt,formula,i,j,c,X,regionCodes,regionNames,pointset,mapComps,comps,newComp,asset,found;popGraph.title="from map of "+oGraph.title;for(i=0;i<selectedMarkers.length;i++){if(_drawMap_isBubble()){plt=$.extend(true,{},oGraph.mapsets[activeMapTab]);delete plt.formula;delete plt.options.calculatedFormula;mapComps=plt.components;plt.components=[];regionCodes=selectedMarkers[i].split("+");regionNames=[];for(j=0;j<regionCodes.length;j++){regionNames.push($map.getRegionName(regionCodes[j]));for(c=0;c<mapComps.length;c++){if(mapComps[c].handle[0]=="M"){asset=$.extend({units:oGraph.assets[mapComps[c].handle()].units,period:oGraph.assets[mapComps[c].handle()].freq},oGraph.assets[mapComps[c].handle()].data[regionCodes[j]]);newComp=$.extend(true,{},mapComps[c]);newComp.handle=asset.handle;popGraph.assets[asset.handle()]=asset;plt.components.push(newComp)}else{plt.components.push($.extend(true,{},mapComps[c]));popGraph.assets[mapComps[c].handle()]=oGraph.assets[mapComps[c].handle()]}}}plt.options.name=oGraph.mapsets[activeMapTab].name()+" for "+regionNames.join("+");popGraph.plots.push(plt)}else{for(X=0;X<oGraph.pointsets.length;X++){pointset=$.extend(true,{},oGraph.pointsets[X]);found=false;comps=pointset.components;for(c=0;c<comps.length;c++){if(comps[c].isPointSet()&&oGraph.assets[comps[c].handle()].data[selectedMarkers[i]]){found=true;var sHandle=oGraph.assets[comps[c].handle()].data[selectedMarkers[i]].handle;popGraph.assets[sHandle]=$.extend({units:oGraph.assets[comps[c].handle()].units,freq:oGraph.assets[comps[c].handle()].freq,freqs:oGraph.assets[comps[c].handle()].freqs},oGraph.assets[comps[c].handle()].data[selectedMarkers[i]]);comps[c].handle=sHandle}else{popGraph.assets[comps[c].handle()]=oGraph.assets[comps[c].handle()]}}if(found)popGraph.plots.push(pointset)}}}if(oGraph.mapsets){var sourceMapPlot,sourceComponent,popComponent,popComponents,mapAsset,regionSeries;for(i=0;i<selectedRegions.length;i++){if(typeof calculatedMapData.regionColors[calculatedMapData.dates[val].s][selectedRegions[i]]!="undefined"){sourceMapPlot=oGraph.mapsets[activeMapTab];popComponents=[];sourceMapPlot.eachComponent(function(){sourceComponent=this;popComponent=sourceComponent.clone();if(sourceComponent.isMapSet()){mapAsset=oGraph.assets[sourceComponent.handle()];regionSeries=mapAsset.data[selectedRegions[i]];popComponent.geoname=regionSeries.geoname;popComponent.geoid=regionSeries.geoid;popComponent.parsedData(regionSeries.data);popComponent.firstdt=regionSeries.firstdt;popComponent.lastdt=regionSeries.lastdt}popComponents.push(popComponent)});popGraph.addPlot(popComponents,{userFormula:sourceMapPlot.userFormula})}}}if(popGraph.plots&&popGraph.plots.length){if(isEmbedded){MD.plugin.popGraph(popGraph)}else{$("#quick-view-select-viz").val("none").hide();quickGraph(popGraph,oGraph.map,true)}}else{$thisPanel.find(".mashabledata_make-map").click()}});var $play=$thisPanel.find(".mashabledata_map-play");if(calculatedMapData.startDateIndex!=calculatedMapData.endDateIndex){$play.off().click(function(){var stepStart,stepEnd,timeToKill,optimalStepTime=Math.min(1e4/calculatedMapData.dates.length,500);if($play.attr("title")=="play"){$play.button({text:false,icons:{primary:"ui-icon-pause"}}).attr("title","pause");advanceSlider()}else{$play.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}function advanceSlider(){if($play.attr("title")=="pause"){stepStart=new Date;var newValue=$mapSlider.slider("value")+1;if(newValue>calculatedMapData.endDateIndex)newValue=calculatedMapData.startDateIndex;$mapSlider.slider("value",newValue);stepEnd=new Date;timeToKill=Math.max(1,optimalStepTime-(stepEnd.getTime()-stepStart.getTime()));if(newValue==calculatedMapData.endDateIndex){$play.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}else{if($play.attr("title")=="pause"){window.setTimeout(advanceSlider,timeToKill)}}}}}).button({text:false,icons:{primary:"ui-icon-play"}});$thisPanel.find(".mashabledata_map-step-backward").off().click(function(){$mapSlider.slider("value",$mapSlider.slider("value")-1)}).button({text:false,icons:{primary:"ui-icon-seek-first"}});$thisPanel.find(".mashabledata_map-step-forward").off().click(function(){$mapSlider.slider("value",$mapSlider.slider("value")+1)}).button({text:false,icons:{primary:"ui-icon-seek-end"}})}else{$play.hide();$thisPanel.find(".mashabledata_map-step-backward, .mashabledata_map-step-forward").hide()}if(!oGraph.plots)$thisPanel.find("h3.mashabledata_map-title").html(oGraph.title).click(function(){if(!isEmbedded)graphTitle.show(this)});var noCubeRedraw=false;$thisPanel.find(".mashabledata_make-map").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"}}).off().click(function(){noCubeRedraw=true;$map.clearSelectedMarkers();$map.clearSelectedRegions();noCubeRedraw=false;if(oGraph.controls.vizChart)oGraph.controls.vizChart.redraw();$thisPanel.find(".mashabledata_map-graph-selected, .mashabledata_make-map.ui-button").button("disable")});if(!isEmbedded){$thisPanel.find("button.group").button({icons:{secondary:"ui-icon-circle-plus"}}).off().click(function(){if(mergablity.newMerge){if(!oGraph.mapsets[activeMapTab].options.merges)oGraph.mapsets[activeMapTab].options.merges=[];oGraph.mapsets[activeMapTab].options.merges.push($map.getSelectedRegions())}if(mergablity.growable){var i,j,newMerge=[];var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){newMerge=newMerge.concat(selectedMarkers[i].split("+"));if(selectedMarkers[i].split("+").length>1){for(j=0;j<oGraph.mapsets[activeMapTab].options.merges.length;j++){if(selectedMarkers[i]==oGraph.mapsets[activeMapTab].options.merges[j].join("+")){oGraph.mapsets[activeMapTab].options.merges.splice(j,1);break}}}}for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets[activeMapTab].options.merges.length;j++){if(oGraph.mapsets[activeMapTab].options.merges[j].indexOf(selectedRegions[i])>-1){newMerge=newMerge.concat(oGraph.mapsets[activeMapTab].options.merges.splice(j,1)[0]);break}}}for(i=0;i<selectedRegions.length;i++){if(newMerge.indexOf(selectedRegions[i])==-1)newMerge.push(selectedRegions[i])}oGraph.mapsets[activeMapTab].options.merges.push(newMerge)}$map.removeAllMarkers();$map.clearSelectedRegions();_drawMap_bubbleCalc();_drawMap_positionBubbles();$map.series.markers[0].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s));
$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);_makeDirty()});$thisPanel.find("button.ungroup").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).off().click(function(){var i,j;var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){if(selectedMarkers[i].split("+").length>1){for(j=0;j<oGraph.mapsets[activeMapTab].options.merges.length;j++){if(selectedMarkers[i]==oGraph.mapsets[activeMapTab].options.merges[j].join("+")){oGraph.mapsets[activeMapTab].options.merges.splice(j,1);break}}}}for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets[activeMapTab].options.merges.length;j++){pos=oGraph.mapsets[activeMapTab].options.merges[j].indexOf(selectedRegions[i]);if(pos!=-1){oGraph.mapsets[activeMapTab].options.merges[j].splice(pos,1);if(oGraph.mapsets[activeMapTab].options.merges[j].length==0){oGraph.mapsets[activeMapTab].options.merges.splice(j,1)}break}}}$map.removeAllMarkers();$map.clearSelectedRegions();_drawMap_bubbleCalc();_drawMap_positionBubbles();$map.series.markers[0].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s));$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);_makeDirty()})}var gLegend=false,makeLegend;$thisPanel.find("input.mashabledata_legend").change(function(){oGraph.mapconfig.showLegend=$(this).prop("checked");_makeDirty();if(oGraph.mapconfig.showLegend){gLegend=makeLegend($map)}else{gLegend.remove()}});console.timeEnd("buildGraphPanel:mapControls")}function _drawMap_setMergablity(){var i,j,markerRegions;mergablity={newMerge:false,growable:false,splinter:false,ungroupable:false};if(!_drawMap_isBubble())return;var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){if(selectedMarkers[i].split("+").length>1){mergablity.ungroupable=true;break}}if(oGraph.mapsets[activeMapTab].options.merges){for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets[activeMapTab].options.merges.length;j++){if(oGraph.mapsets[activeMapTab].options.merges[j].indexOf(selectedRegions[i])>=0){mergablity.ungroupable=true;break}}}}if(selectedMarkers.length>1){mergablity.growable=true}else{if(selectedMarkers.length==1){markerRegions=selectedMarkers[0].split("+");for(i=0;i<selectedRegions.length;i++){if(markerRegions.indexOf(selectedRegions[i])==-1){mergablity.growable=true;break}}}else{if(selectedRegions.length>1){if(mergablity.ungroupable){mergablity.growable=true}else{mergablity["newMerge"]=true}}}}$thisPanel.find("button.group").button(mergablity.newMerge||mergablity.growable?"enable":"disable");$thisPanel.find("button.ungroup").button(mergablity.ungroupable?"enable":"disable")}function _drawMap_makeList(action,code){var list=[],id,units,attr;if(action=="new"){if(oGraph.mapsets){units=calculatedMapData.mapUnits;var regionData=_getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[val].s);for(id in regionData){if(regionData[id]!==null&&$map.mapData.paths[id]){list.push({name:$map.getRegionName(id),value:regionData[id],id:id})}}}else{if(calculatedMapData.fillUnits){units=calculatedMapData.fillUnits;attr="f"}else{units=calculatedMapData.radiusUnits;attr="r"}var markerData=_getMapDataByContainingDate(calculatedMapData.markerData,calculatedMapData.dates[val].s);for(id in markerData){if(markerData[id][attr]!==null){list.push({name:calculatedMapData.markers[id].name,value:markerData[id][attr],id:id})}}}list.sort(function(a,b){return(oGraph.mapconfig.mapViz=="list-desc"?-1:1)*(a.value-b.value)});var html='<div class="mashabledata_map-list"><table><thead><th>Rank <br>'+$thisPanel.find("div.mashabledata_map-date").html()+"</th><th>"+calculatedMapData.title+"</th><th>"+units+"</th></thead><tbody>";for(var i=0;i<list.length;i++){html+='<tr data="'+list[i].id+'"><td>'+(i+1)+"</td><td>"+list[i].name+"</td><td>"+list[i].value+"</td></tr>"}html+="</tbody></table></div>";var vizHeight=$thisPanel.find(".mashabledata_cube-viz").html(html).find("tbody tr").hover(function(){var code=$(this).attr("data");if(code&&code!="undefined"){$map.setSelectedRegions(code)}},function(){var code=$(this).attr("data");if(code&&code!="undefined"){var selection={};selection[code]=false;$map.setSelectedRegions(selection)}}).end().innerHeight();$thisPanel.find(".mashabledata_cube-viz tbody").css("height",vizHeight-$thisPanel.find(".mashabledata_cube-viz thead").height()+"px")}if(code){$thisPanel.find(".mashabledata_cube-viz table tr").removeClass("ui-selected").find("tr[data='"+code+"']").addClass("ui-selected")}}function _drawMap_isBubble(){return oGraph.mapsets&&(mapMode=="bubbles"||mapMode=="change-bubbles")}function _drawMap_bubbleCalc(){var dateKey,markerId,markerTitle,regionColors=primeColors.concat(hcColors);calculatedMapData.regionsColorsForBubbles={};calculatedMapData.markers={};var pnt={x:100,y:100};if(_drawMap_isBubble()){var region,mergedSum,i=0,d,j,allMergedRegions=[];var merge,mergeCode,markerData={},markerAttr={r:{},stroke:{}},bubbleValue,y,y0;_setStartEndDateIndexes();for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){dateKey=calculatedMapData.dates[d].s;markerData[dateKey]={};markerAttr.r[dateKey]={};markerAttr.stroke[dateKey]={}}calculatedMapData.markerDataMin=Number.MAX_VALUE;calculatedMapData.markerDataMax=Number.MIN_VALUE;var mapsetOptions=oGraph.mapsets[activeMapTab].options;var startDateKey=calculatedMapData.dates[calculatedMapData.startDateIndex].s;if(mapsetOptions.merges){for(i=0;i<mapsetOptions.options.merges.length;i++){merge=mapsetOptions.options.merges[i];mergeCode=merge.join("+");markerTitle=calculatedMapData.title+" for "+mergeCode;calculatedMapData.markers[mergeCode]={name:mergeCode,point:pnt,style:{fill:"pink"}};for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){mergedSum=0;for(j=0;j<merge.length;j++){mergedSum+=calculatedMapData.regionData[calculatedMapData.dates[d].s][merge[j]]||0}if(mapMode=="change-bubbles"){bubbleValue=mergedSum-markerData[startDateKey][mergeCode][r]}else{bubbleValue=mergedSum}markerData[calculatedMapData.dates[d].s][mergeCode]={r:mergedSum};if(mergedSum!==null){calculatedMapData.markerDataMin=Math.min(calculatedMapData.markerDataMin,bubbleValue);calculatedMapData.markerDataMax=Math.max(calculatedMapData.markerDataMax,bubbleValue)}}for(j=0;j<merge.length;j++){calculatedMapData.regionsColorsForBubbles[merge[j]]=regionColors[i%regionColors.length]}allMergedRegions=allMergedRegions.concat(merge)}}for(region in calculatedMapData.regionData[calculatedMapData.dates[0].s]){if(allMergedRegions.indexOf(region)==-1&&typeof calculatedMapData.regionData[calculatedMapData.dates[0].s][region]!="undefined"){calculatedMapData.markers[region]={name:region,point:pnt,style:{fill:"pink"}};calculatedMapData.regionsColorsForBubbles[region]=globals.MAP_COLORS.MID;y0=null;for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){dateKey=calculatedMapData.dates[d].s;markerData[dateKey][region]={r:calculatedMapData.regionData[dateKey][region]};if(markerData[dateKey][region].r!==null&&!isNaN(markerData[dateKey][region].r)){if(d==calculatedMapData.startDateIndex)y0=markerData[dateKey][region].r;if(mapMode=="change-bubbles"&&y0!==null&&!isNaN(y0)){calculatedMapData.markerDataMin=Math.min(calculatedMapData.markerDataMin,markerData[dateKey][region].r-y0);calculatedMapData.markerDataMax=Math.max(calculatedMapData.markerDataMax,markerData[dateKey][region].r-y0)}else{calculatedMapData.markerDataMin=Math.min(calculatedMapData.markerDataMin,markerData[dateKey][region].r);calculatedMapData.markerDataMax=Math.max(calculatedMapData.markerDataMax,markerData[dateKey][region].r)}}}}}var rData,rScale=(oGraph.mapconfig.maxRadius||DEFAULT_RADIUS_SCALE)/Math.sqrt(Math.max(Math.abs(calculatedMapData.markerDataMax),Math.abs(calculatedMapData.markerDataMin)));for(dateKey in markerData){for(markerId in markerData[dateKey]){y=markerData[dateKey][markerId].r;if(mapMode=="change-bubbles"){y0=markerData[startDateKey][markerId].r;rData=!isNaN(y)&&!isNaN(y0)&&y!==null&&y0!==null?y-y0:null}else{rData=y||null}markerAttr.r[dateKey][markerId]=rScale*Math.sqrt(Math.abs(rData));markerAttr.stroke[dateKey][markerId]=rData<0?"#ff0000":"#000000"}}calculatedMapData.markerData=markerData;calculatedMapData.markerAttr=markerAttr;calculatedMapData.radiusUnits=calculatedMapData.mapUnits}}function _drawMap_geometricCenter(regions){var bBox,totalArea=0,xArm=0,yArm=0,center,regCenter,latLon;for(var i=0;i<regions.length;i++){latLon=null;$.each(oGraph.mapsets[activeMapTab].components,function(c,comp){if(oGraph.assets[comp.handle()].data[regions[i]]&&comp.handle[0]=="M"&&oGraph.assets[comp.handle()].data[regions[i]].latLon){latLon=oGraph.assets[comp.handle()].data[regions[i]].latLon.split(",")}});bBox=$g.find("path[data-code="+regions[i]+"]").get(0).getBBox();if(latLon){regCenter=$map.latLngToPoint(latLon[0],latLon[1]);xArm+=(regCenter.x-$map.transX)*bBox.width*bBox.height/$map.scale;yArm+=(regCenter.y-$map.transY)*bBox.width*bBox.height/$map.scale}else{xArm+=(bBox.x+bBox.width/2)*bBox.width*bBox.height;yArm+=(bBox.y+bBox.height/2)*bBox.width*bBox.height}totalArea+=bBox.width*bBox.height}center={x:(xArm/totalArea+$map.transX)*$map.scale,y:(yArm/totalArea+$map.transY)*$map.scale};return center}function _drawMap_positionBubbles(){var center,latLng;if(_drawMap_isBubble()){var region,i=0,j,allMergedRegions=[];if(oGraph.mapsets[activeMapTab].options.merges){for(i=0;i<oGraph.mapsets[activeMapTab].options.merges.length;i++){center=_drawMap_geometricCenter(oGraph.mapsets[activeMapTab].options.merges[i]);latLng=$map.pointToLatLng(center.x,center.y);calculatedMapData.markers[oGraph.mapsets[activeMapTab].options.merges[i].join("+")].latLng=[latLng.lat,latLng.lng];allMergedRegions=allMergedRegions.concat(oGraph.mapsets[activeMapTab].options.merges[i])}}$g.find("path[data-code]").each(function(){region=$(this).attr("data-code");if(allMergedRegions.indexOf(region)==-1&&typeof calculatedMapData.regionData[calculatedMapData.dates[0].s][region]!="undefined"){center=_drawMap_geometricCenter([region]);latLng=$map.pointToLatLng(center.x,center.y);calculatedMapData.markers[region].latLng=[latLng.lat,latLng.lng]}});$map.addMarkers(calculatedMapData.markers)}}function _drawMap_updateCubeVizFromMap(code,isSelected){if(oGraph.hasMapViz()&&!oGraph.cubeid){var mapPlot=oGraph.mapsets[activeMapTab],selectedRegions=$map.getSelectedRegions(),index,thisCode;if(code&&isSelected&&selectedRegions.indexOf(code)===-1)selectedRegions.push(code);var vizChartGeos=getVizChartGeos(selectedRegions,oGraph,mapPlot,oGraph.mapconfig.mapViz=="line-bunnies"||oGraph.mapconfig.mapViz=="line-bunnies");switch(oGraph.mapconfig.mapViz){case"scatter":if(vizChartGeos.length){for(i=0;i<vizChartGeos.length;i++){var pointOver=oGraph.controls.vizChart.get(vizChartGeos[i].code);if(pointOver&&pointOver.select)pointOver.select(true,i>0)}}else{var selectedPoints=oGraph.controls.vizChart.getSelectedPoints();for(i=0;i<selectedPoints.length;i++){selectedPoints[i].select(false)}}break;case"line":case"line-bunnies":var geoKey,mapDate=calculatedMapData.dates[val].s,mapCode;var sDate,regionData=oGraph.calculatedMapData.regionData;var i,serie,chartedCodes=[],vizChart=oGraph.controls.vizChart,redrawNeeded=false;for(i=0;i<vizChartGeos.length;i++){thisCode=vizChartGeos[i].code;if(chartedCodes.indexOf(thisCode)===-1){if(!vizChart.get(thisCode)){serie={id:thisCode,name:vizChartGeos[i].geoname,data:[]};for(sDate in regionData){if(typeof regionData[sDate][thisCode]!="undefined")serie.data.push([dateFromMdDate(sDate).getTime(),regionData[sDate][thisCode]])}serie.data.sort(function(a,b){return a[0]-b[0]});vizChart.addSeries(serie,false);redrawNeeded=true}chartedCodes.push(thisCode)}}for(i=0;i<vizChart.series.length;i++){serie=vizChart.series[i];if(chartedCodes.indexOf(serie.userOptions.id)===-1){serie.remove(false);redrawNeeded=true}}if(redrawNeeded)vizChart.redraw();break;case"components-bar":break;case"components-line":break;case"list-asc":case"list-desc":$thisPanel.find("div.mashabledata_map-list tr.mashabledata_map-list-selected").removeClass("mashabledata_map-list-selected");for(i=0;i<vizChartGeos.length;i++){thisCode=vizChartGeos[i].code;$thisPanel.find("div.mashabledata_map-list tr[data='"+thisCode+"']").addClass("mashabledata_map-list-selected")}break}}}function _drawMap_makeMakeViz(code,isSelected){console.time("_drawMap_makeMakeViz");if(!oGraph.hasMapViz())return;if(!oGraph.cubeid&&(oGraph.mapconfig.mapViz=="list-asc"||oGraph.mapconfig.mapViz=="list-desc")){_drawMap_makeList(code?false:"new",code);return}var mapPlot=oGraph.mapsets[activeMapTab];var geoKey,mapDate=calculatedMapData.dates[val].s,mapCode;var selectedRegions=$map.getSelectedRegions();if(code){geoKey=code}else{geoKey=null;if(selectedRegions.length>0){geoKey=selectedRegions[0]}else{var selectedMarkers=$map.getSelectedMarkers();if(selectedMarkers.length>0){geoKey=selectedMarkers[0]}else{geoKey=oGraph.bunny||mapsList[oGraph.map].bunny}}}if(!oGraph.cubeid&&(oGraph.mapconfig.mapViz=="line"||oGraph.mapconfig.mapViz=="line-bunnies")){var flotChartOptions={title:mapPlot.name(),xaxis:"time"};if(code&&isSelected&&selectedRegions.indexOf(code)===-1)selectedRegions.push(code);var vizChart={chart:{type:"line",spacingRight:50,renderTo:oGraph.controls.$thisPanel.find(".mashabledata_cube-viz")[0]},title:{text:mapPlot.name(),style:{fontSize:"12px"}},subtitle:{text:"click on map to compare locations",style:{fontSize:"10px"}},xAxis:{type:"datetime"},yAxis:{title:{text:mapPlot.units()}},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{formatter:function(){return"<b>"+mapPlot.name()+"</b><br/>"+this.id+":<br/>"+common.numberFormat(Math.abs(this.point.y),0)+" "+mapPlot.units()}}};var sDate,regionData=oGraph.calculatedMapData.regionData;var vizChartGeos=getVizChartGeos(selectedRegions,oGraph,mapPlot,oGraph.mapconfig.mapViz=="line-bunnies");var serie,chartedCodes=[],thisCode;for(i=0;i<vizChartGeos.length;i++){thisCode=vizChartGeos[i].code;if(chartedCodes.indexOf(thisCode)===-1){serie={id:thisCode,name:vizChartGeos[i].geoname,data:[]};for(sDate in regionData){if(typeof regionData[sDate][thisCode]!="undefined")serie.data.push([dateFromMdDate(sDate).getTime(),regionData[sDate][thisCode]])}serie.data.sort(function(a,b){return a[0]-b[0]});vizChart.series.push(serie);chartedCodes.push(thisCode)}}if(oGraph.controls.vizChart)oGraph.controls.vizChart.destroy();oGraph.controls.vizChart=new Highcharts.Chart(vizChart)}if(!oGraph.cubeid&&oGraph.mapconfig.mapViz=="scatter"&&oGraph.mapsets.length==2){var mapPlotX=oGraph.mapsets[0],mapPlotY=oGraph.mapsets[1],scatterData=[];if(!mapPlotX.calculatedMapData)_calcMap(oGraph,0);if(!mapPlotY.calculatedMapData)_calcMap(oGraph,1);var xData=_getMapDataByContainingDate(mapPlotX.calculatedMapData.regionData,mapDate),yData=_getMapDataByContainingDate(mapPlotY.calculatedMapData.regionData,mapDate);for(mapCode in xData){if(yData[mapCode]&&jvm.Map.maps[oGraph.mapFile].paths[mapCode]){scatterData.push({id:mapCode,x:xData[mapCode],y:yData[mapCode]})}}function pointMouse(point,active){var regionSel={};regionSel[point.id]=active;$map.setSelectedRegions(regionSel)}var xName=mapPlotX.name(),yName=mapPlotY.name(),xUnits=mapPlotX.units(),yUnits=mapPlotY.units(),highChartOptions={chart:{type:"scatter",spacingRight:50,renderTo:oGraph.controls.$thisPanel.find(".mashabledata_cube-viz").get(0)},title:{text:""},subtitle:{text:"click on map or scatter plot to compare"},series:[{data:scatterData.sort(function(a,b){return a.x-b.x}),name:xName+" vs. "+yName}],exporting:{enabled:false},tooltip:{formatter:function(){return"<b>"+$map.getRegionName(this.point.id)+"</b><br/><br/>"+"<b>"+xName+":</b><br/>"+common.numberFormat(this.point.x,0)+" "+xUnits+"<br/><br/>"+"<b>"+yName+":</b><br/>"+common.numberFormat(this.point.y,0)+" "+yUnits},useHTML:true,style:{"max-width":"200px"}},plotOptions:{series:{point:{events:{mouseOver:function(){pointMouse(this,true)},mouseOut:function(){pointMouse(this,false)}}}}},legend:{enabled:false},xAxis:{title:{text:mapPlotX.name()+"<br>"+mapPlotX.calculatedMapData.mapUnits+""}},yAxis:{title:{x:-20,text:mapPlotY.name()+"<br>"+mapPlotY.calculatedMapData.mapUnits+""}}};oGraph.controls.vizChart=new Highcharts.Chart(highChartOptions)}if(parseInt(oGraph.cubeid)||(oGraph.mapconfig.mapViz=="components-bar"||oGraph.mapconfig.mapViz=="components-line")){if(oGraph.mapconfig.mapViz=="sum"){if(!isNaN(geoKey))geoKey="G"+geoKey;var oFormula=mapPlot.calculatedFormula;var signedNumArray=oFormula.numFormula.replace("-","+-").split("+");var unsignedNumArray=oFormula.numFormula.replace("-","+").split("+");var asset,seriesVal,symbolData={},i,numNamesAsWords=[],symbol,o={},nameTree={};mapPlot.eachComponent(function(c){asset=oGraph.assets[this.handle()];if(this.isMapSet()){symbol=mapPlot.compSymbol(c);symbolData[symbol]=asset.data[geoKey]?asset.data[geoKey].data:null;nameTree[symbol]=asset.name}});for(i=unsignedNumArray.length-1;i>=0;i--){if(unsignedNumArray[i].trim()=="")unsignedNumArray.splice(i,0,1);else numNamesAsWords.unshift(nameTree[unsignedNumArray[i].trim()].split(" "))}var peeledWords=[],peelingFront=true,peelingBack=true;while(peelingFront&&peelingBack){for(i=0;i<numNamesAsWords.length;i++){while(numNamesAsWords[i].length>0&&numNamesAsWords[i][0]=="")numNamesAsWords[i].shift();while(numNamesAsWords[i].length>0&&numNamesAsWords[i][numNamesAsWords[i].length-1]=="")numNamesAsWords[i].pop();if(numNamesAsWords[i].length>0){if(numNamesAsWords[i][0]!=numNamesAsWords[0][0])peelingFront=false;if(numNamesAsWords[i].length>1){if(numNamesAsWords[i][numNamesAsWords[i].length-1]!=numNamesAsWords[0][numNamesAsWords[0].length-1])peelingBack=false}}else{peelingFront=peelingBack=false;break}}if(peelingFront)peeledWords.unshift(numNamesAsWords[0][0]);if(peelingBack)peeledWords.push(numNamesAsWords[0][numNamesAsWords[0].length-1]);for(i=0;i<numNamesAsWords.length;i++){if(peelingFront)numNamesAsWords[i].shift();if(peelingBack)numNamesAsWords[i].pop()}}var categories=[];oGraph.assets.cube={dimensions:[{list:[]}]};var cube=oGraph.assets.cube;cube.theme=peeledWords.join(" ");cube.name="";cube.units=mapPlot.units();cube["G"+geoKey]={facetedData:[]};for(i=0;i<numNamesAsWords.length;i++){cube.dimensions[0].list.push({name:numNamesAsWords[i].join(" ")});cube["G"+geoKey].facetedData[i]=symbolData[unsignedNumArray[i].trim()]}}var action="new";if(summationMap){if(code){action=isSelected?"add":"remove"}else{action="summation"}}vizualizeCube(oGraph,activeMapTab,geoKey,mapDate,action);console.time("vizChart.redraw");if(!noCubeRedraw&&action=="remove")oGraph.controls.vizChart.redraw();console.timeEnd("vizChart.redraw")}$mapDateDiv.html(formatDateByPeriod(calculatedMapData.dates[val].dt.getTime(),calculatedMapData.freq));console.timeEnd("_drawMap_makeMakeViz")}function _drawMap_setRegionsMarkersAttribute(val){if(oGraph.mapsets){switch(mapMode){case"heat":case"abs-change":case"percent-change":case"correlation":$map.series.regions[0].setAttributes(_getMapDataByContainingDate(calculatedMapData.regionColors,calculatedMapData.dates[val].s));break;case"bubbles":case"change-bubbles":$map.series.markers[0].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s));break;case"treemap":if($map){$map.remove();$map=false}makeTreeMap($thisPanel.find("div.mashabledata_jvmap").html(""),oGraph.mapsets[activeMapTab].calculatedMapData,oGraph.mapFile,oGraph.mapsets[activeMapTab].calculatedMapData.dates[val].s);break;case"change-treemap":if($map){$map.remove();$map=false}makeTreeMap($thisPanel.find("div.mashabledata_jvmap").html(""),oGraph.mapsets[activeMapTab].calculatedMapData,oGraph.mapFile,oGraph.mapsets[activeMapTab].calculatedMapData.dates[val].s,oGraph.mapsets[activeMapTab].calculatedMapData.dates[0].s);break}}if(oGraph.pointsets){if(areaScaling){$map.series.markers[0].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s))}if(fillScaling){$map.series.markers[1].setAttributes(_getMapDataByContainingDate(calculatedMapData.markerAttr.fill,calculatedMapData.dates[val].s))}}if(oGraph.plots){var timeAxis=chart.xAxis[0];timeAxis.removePlotLine("timeLine");timeAxis.addPlotLine({value:calculatedMapData.dates[val].dt,color:"red",width:2,id:"timeLine"})}_drawMap_makeMakeViz()}function _drawMap_makeLegend(map){var standardRadius=10,textCenterFudge=5,lineHeight=20,spacer=10,markerLegendWidth,regionLegendWidth,regionHeight=0,markerHeight=0,y=0,i,yOffset,xOffset,MAX_MARKER_LABEL_LENGTH=20;if(oGraph.mapsets&&!_drawMap_isBubble()){if(oGraph.mapsets[activeMapTab].options.scale=="discrete"){regionLegendWidth=185;regionHeight=lineHeight+2*spacer+oGraph.mapsets[activeMapTab].options.discreteColors.length*(spacer+20)}else{regionLegendWidth=100;if(calculatedMapData.regionMin<0&&calculatedMapData.regionMax>0){regionHeight=6*spacer+2*80+4*lineHeight}else{regionHeight=4*spacer+80+3*lineHeight}}}else regionLegendWidth=0;var areaCount=areaScalingCount(oGraph.pointsets),fillCount=fillScalingCount(oGraph.pointsets);if(oGraph.pointsets||_drawMap_isBubble()){markerLegendWidth=185;if(areaCount>1&&fillCount==0){markerHeight+=areaCount*(spacer+2*standardRadius)+(markerHeight==0?spacer:0)}if(areaCount>0||_drawMap_isBubble()){var maxRadius=parseInt(oGraph.mapconfig.maxRadius)||DEFAULT_RADIUS_SCALE;var smallRadius=+maxRadius/Math.sqrt(10);markerHeight+=2*(spacer+Math.max(maxRadius,15)+smallRadius)+(markerHeight==0?spacer:0)}}else markerLegendWidth=0;var gLegend=map.canvas.addGroup();map.canvas.addCircle({cx:0,cy:0},{initial:{r:20,"fill-opacity":0,"stroke-width":0}},gLegend);$thisPanel.append('<div id="dummyLegend" class="hidden"></div>');var hcr=new Highcharts.Renderer($("#dummyLegend")[0],map.width,map.height);hcr.box=gLegend.node;$("#dummyLegend").remove();var legendLocation=oGraph.mapconfig.legendLocation||mapsList[oGraph.map].legend||"TR";switch(legendLocation.substr(0,1)){case"T":yOffset=spacer;break;case"C":yOffset=(map.height-Math.max(markerHeight,regionHeight))/2-spacer;break;case"B":yOffset=map.height-Math.max(markerHeight,regionHeight)-spacer}switch(legendLocation.substr(1,1)){case"L":xOffset=spacer;if(legendLocation.substr(0,1)=="T")xOffset+=30;break;case"C":xOffset=(map.width-regionLegendWidth-markerLegendWidth)/2-spacer;break;case"R":xOffset=map.width-regionLegendWidth-markerLegendWidth-spacer}hcr.rect(xOffset,yOffset,markerLegendWidth+regionLegendWidth,Math.max(markerHeight,regionHeight),5).attr({fill:"white",opacity:.5,"stroke-width":0}).add();var gradientAttributes={opacity:1,"stroke-width":0,"z-index":1e3};if(oGraph.pointsets||_drawMap_isBubble()){if(areaCount>1&&fillCount==0){$.each(oGraph.pointsets,function(i){if(this.options.attribute!="fill"){y=(i+1)*(spacer+2*standardRadius)-standardRadius;hcr.circle(xOffset+spacer+standardRadius,yOffset+y,Math.min(maxRadius,standardRadius)).attr({fill:this.options.color,opacity:1,"fill-opacity":1,stroke:"black","stroke-width":1}).add();hcr.text(oGraph.pointsets[i].name().substring(0,MAX_MARKER_LABEL_LENGTH),xOffset+2*(spacer+standardRadius),yOffset+y).add()}y+=standardRadius})}if(areaCount>0||_drawMap_isBubble()){y+=spacer+(smallRadius||5);var MarkerSizeAttributes={"fill-opacity":0,opacity:1,stroke:"black","stroke-width":1};hcr.circle(xOffset+spacer+maxRadius,yOffset+y,smallRadius).attr(MarkerSizeAttributes).add();hcr.text(formatRationalize((calculatedMapData.radiusScale||calculatedMapData.markerDataMax)/10),xOffset+2*(maxRadius+spacer),yOffset+y).css({fontSize:"12px"}).add();y+=(smallRadius||5)+spacer+maxRadius;hcr.circle(xOffset+spacer+maxRadius,yOffset+y,maxRadius).attr(MarkerSizeAttributes).add();hcr.text(formatRationalize(calculatedMapData.radiusScale||calculatedMapData.markerDataMax),xOffset+2*(maxRadius+spacer),yOffset+y).css({fontSize:"12px"}).add();hcr.text(calculatedMapData.radiusUnits,xOffset+2*(maxRadius+spacer),yOffset+y+2*spacer).css({fontSize:"12px"}).add()}}if(oGraph.mapsets&&!_drawMap_isBubble()){if(oGraph.mapsets[activeMapTab].options.scale!="discrete"&&oGraph.mapsets[activeMapTab].options.logMode=="on")hcr.text("log scale",xOffset+spacer,yOffset+2*lineHeight).css({fontSize:"12px"}).add();if(oGraph.mapsets[activeMapTab].options.scale=="discrete"){for(i=0;i<oGraph.mapsets[activeMapTab].options.discreteColors.length;i++){y=spacer+(oGraph.mapsets[activeMapTab].options.discreteColors.length-i)*(spacer+20);hcr.rect(xOffset+markerLegendWidth+spacer,yOffset+y,lineHeight,lineHeight,0).attr({fill:oGraph.mapsets[activeMapTab].options.discreteColors[i].color,opacity:1,stroke:"black","stroke-width":1}).add();hcr.text((i==oGraph.mapsets[activeMapTab].options.discreteColors.length-1?"&gt; ":" ")+oGraph.mapsets[activeMapTab].options.discreteColors[i].cutoff,xOffset+markerLegendWidth+spacer+lineHeight+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add()}}else{y+=2*lineHeight;hcr.text(formatRationalize(calculatedMapData.regionMax),xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer;if(calculatedMapData.regionMax>0){_makeLegend_gradient(xOffset+markerLegendWidth+spacer,yOffset+y,oGraph.mapsets[activeMapTab].options.posColor||MAP_COLORS.POS,MAP_COLORS.MID);y+=80+spacer;if(calculatedMapData.regionMin<0){hcr.text("0",xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer}}if(calculatedMapData.regionMin<0){_makeLegend_gradient(xOffset+markerLegendWidth+spacer,yOffset+y,MAP_COLORS.MID,oGraph.mapsets[activeMapTab].options.negColor||MAP_COLORS.NEG);y+=80+spacer}hcr.text(formatRationalize(calculatedMapData.regionMin),xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer}}return gLegend;function _makeLegend_gradient(x,y,topColor,bottomColor){var rTop,gTop,bTop,rBot,gBot,bBot,r,g,b;rTop=parseInt(topColor.substr(1,2),16);gTop=parseInt(topColor.substr(3,2),16);bTop=parseInt(topColor.substr(5,2),16);rBot=parseInt(bottomColor.substr(1,2),16);gBot=parseInt(bottomColor.substr(3,2),16);bBot=parseInt(bottomColor.substr(5,2),16);for(var i=0;i<40;i++){r=Math.round(rTop-(rTop-rBot)*i/39).toString(16);g=Math.round(gTop-(gTop-gBot)*i/39).toString(16);b=Math.round(bTop-(bTop-bBot)*i/39).toString(16);hcr.rect(x,y+2*i,20,2,0).attr({fill:"#"+(r.length==1?"0":"")+r+(g.length==1?"0":"")+g+(b.length==1?"0":"")+b,opacity:1,"stroke-width":0,"z-index":1e3}).add()}}}makeLegend=_drawMap_makeLegend}function _redraw(){mask("redrawing");setTimeout(function(){destroyChartMap(panelId);sizeShowPanels(oGraph);if(oGraph.plots){calcGraphMinMaxZoomPeriod(oGraph);chart=chartPanel(panelId);annotations.build()}_showChangeSelectors();if(oGraph.mapsets||oGraph.pointsets){oGraph.fetchMap(_drawMap);if(oGraph.plots)$thisPanel.find("map-title").hide();else $thisPanel.find("map-title").show();$thisPanel.find("select.change-basemap").html(_fillChangeMapSelect())}unmask()},10)}function _makeDirty(){oGraph.isDirty=true;$thisPanel.find(".graph-save").button("enable")}function _makeClean(){oGraph.isDirty=false;$thisPanel.find(".graph-save").button("disable")}function _saveThisGraph(){oGraph.save();$thisPanel.find("button.graph-delete, button.graph-saveas").button("enable");_makeClean()}function _exportChart(type){switch($thisPanel.find("select.download-selector").val()){case"map":downloadMap(panelId,type);break;case"chart":annotations.sync();chart._exportChart({type:type,width:2e3});break;case"cube":oGraph.controls.vizChart._exportChart({type:type,width:2e3});break}}function _calcMap(graph,mapIndex){var mapTitle,mapFreq,mapUnits,mapDates={},aMapDates=[],markers={},dateKey;var markerData={};var regionData={};var mapRegionNames={},c,i,j,point,points,mddt,handle,dateHasData,valuesObject,pointHasData,y;var dataMin,dataMax;var oMapDates={};var expression,compSymbols,geo,geos,components,data,symbol,oComponentData;if(graph.mapsets){var mapset=graph.mapsets[mapIndex];var formula=mapset.formula();expression="return "+formula.replace(patVariable,"values.$1")+";";var mapCompute=new Function("values",expression);compSymbols=[];geos={};components=mapset.components;oComponentData={};var sortedGeoList=[];for(i=0;i<components.length;i++){symbol=mapset.compSymbol(i);compSymbols.push(symbol);if(components[i].isMapSet()){for(geo in graph.assets[components[i].handle()].data){if(!geos[geo]){geos[geo]=true;sortedGeoList.push({geo:geo,name:graph.assets[components[i].handle()].geoname})}data=graph.assets[components[i].handle()].data[geo].data.split("|");for(j=0;j<data.length;j++){point=data[j].split(":");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}if(!oComponentData[point[0].toString()][symbol]){oComponentData[point[0].toString()][symbol]={}}oComponentData[point[0].toString()][symbol][geo]=point[1]===null||point[1]=="null"?null:parseFloat(point[1])}}}else{data=graph.assets[components[i].handle()].data.split("|");for(j=0;j<data.length;j++){point=data[j].split(":");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]===null||point[1]=="null"?null:parseFloat(point[1])}}}var required=!mapset.options.componentData||mapset.options.componentData=="required";var missingAsZero=mapset.options.componentData=="missingAsZero";var nullsMissingAsZero=mapset.options.componentData=="nullsMissingAsZero";var breakNever=!mapset.options.breaks||mapset.options.breaks=="never";var breakNulls=mapset.options.breaks=="nulls";var breakMissing=mapset.options.breaks=="missing";mapTitle=mapset.name();mapFreq=graph.assets[components[0].handle()].freq;mapUnits=mapset.units();for(dateKey in oComponentData){dataMin=Number.MAX_VALUE;dataMax=Number.MIN_VALUE;dateHasData=false;for(geo in geos){valuesObject={};y=true;pointHasData=false;for(i=0;i<compSymbols.length;i++){if(!isNaN(oComponentData[dateKey][compSymbols[i]])){valuesObject[compSymbols[i]]=parseFloat(oComponentData[dateKey][compSymbols[i]])}else{if(oComponentData[dateKey][compSymbols[i]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{if(oComponentData[dateKey][compSymbols[i]]&&!isNaN(oComponentData[dateKey][compSymbols[i]][geo])){if(oComponentData[dateKey][compSymbols[i]][geo]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{valuesObject[compSymbols[i]]=oComponentData[dateKey][compSymbols[i]][geo];pointHasData=true}}else{if(required){y=null;break}else{valuesObject[compSymbols[i]]=0}}}}}if(pointHasData){if(y){try{y=mapCompute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null){y=rationalize(y);if(!regionData[dateKey])regionData[dateKey]={};regionData[dateKey][geo]=y;dateHasData=true;dataMin=Math.min(dataMin||y,y);dataMax=Math.max(dataMax||y,y)}}}if(dateHasData){mapDates[dateKey]={regionMin:dataMin,regionMax:dataMax}}else{delete regionData[dateKey]}}}var fillUnits,radiusUnits;if(graph.pointsets){var latlon,latlons={},Xdata;var index=0,pointset,cmp,k;for(i=0;i<graph.pointsets.length;i++){pointset=graph.pointsets[i];if(!pointset.options.color)pointset.options.color=nextColor(graph.pointsets);expression="return "+pointset.formula().replace(patVariable,"values.$1")+";";var pointsetCompute=new Function("values",expression);compSymbols=[];components=pointset.components;oComponentData={};for(j=0;j<components.length;j++){symbol=pointset.compSymbol(j);
compSymbols.push(symbol);var compHandle=components[j].handle();if(compHandle[0]=="X"){Xdata=graph.assets[compHandle].data;for(latlon in Xdata){if(!latlons[latlon]){latlons[latlon]=true}if(!Xdata[latlon].name){Xdata[latlon].name=Xdata[latlon].seriesname?common.placeName(graph.assets[compHandle].setname,Xdata[latlon].seriesname):latlon}if(markers[latlon]){markers[latlon].name+="<br>"+Xdata[latlon].name}else{markers[latlon]={latLng:latlon.split(","),name:Xdata[latlon].name,style:{fill:pointset.options.color}};markers[latlon].latLng[0]=parseFloat(markers[latlon].latLng[0]);markers[latlon].latLng[1]=parseFloat(markers[latlon].latLng[1])}data=Xdata[latlon].data.split("|");for(k=0;k<data.length;k++){point=data[k].split(":");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}if(!oComponentData[point[0].toString()][symbol]){oComponentData[point[0].toString()][symbol]={}}oComponentData[point[0].toString()][symbol][latlon]=point[1]}}}else{data=graph.assets[compHandle].data.split("|");for(k=0;k<data.length;k++){point=data[k].split(":");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]}}}var required=!pointset.options.componentData||pointset.options.componentData=="required";var missingAsZero=pointset.options.componentData=="missingAsZero";var nullsMissingAsZero=pointset.options.componentData=="nullsMissingAsZero";var breakNever=!pointset.options.breaks||pointset.options.breaks=="never";var breakNulls=pointset.options.breaks=="nulls";var breakMissing=pointset.options.breaks=="missing";mapTitle=mapTitle+pointset.name();mapFreq=graph.assets[compHandle].freq;if(pointset.options.attribute=="fill"){fillUnits=pointset.units()}else{radiusUnits=pointset.units()}for(dateKey in oComponentData){dataMin=Number.MAX_VALUE;dataMax=Number.MIN_VALUE;dateHasData=false;for(latlon in latlons){valuesObject={};y=true;pointHasData=false;for(j=0;j<compSymbols.length;j++){if(!isNaN(oComponentData[dateKey][compSymbols[j]])){valuesObject[compSymbols[j]]=parseFloat(oComponentData[dateKey][compSymbols[j]])}else{if(oComponentData[dateKey][compSymbols[j]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[j]]=0}else{y=null;break}}else{if(oComponentData[dateKey][compSymbols[j]]&&!isNaN(oComponentData[dateKey][compSymbols[j]][latlon])){if(oComponentData[dateKey][compSymbols[j]][latlon]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[j]]=0}else{y=null;break}}else{valuesObject[compSymbols[j]]=oComponentData[dateKey][compSymbols[j]][latlon];pointHasData=true}}else{if(required){y=null;break}else{valuesObject[compSymbols[j]]=0}}}}}if(pointHasData){if(y){try{y=pointsetCompute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null){y=rationalize(y);dateHasData=true;if(!markerData[dateKey])markerData[dateKey]={};if(!markerData[dateKey][latlon])markerData[dateKey][latlon]={};if(pointset.options.attribute=="fill"){markerData[dateKey][latlon].f=y;dataMin=Math.min(dataMin,y);dataMax=Math.max(dataMax,y)}else{markerData[dateKey][latlon].r=y;dataMin=Math.min(dataMin,y);dataMax=Math.max(dataMax,y)}}}}if(dateHasData){if(!mapDates[dateKey])mapDates[dateKey]={};if(pointset.options.attribute=="fill"){mapDates[dateKey].markerFillMin=Math.min(mapDates[dateKey].markerFillMin||dataMin,dataMin);mapDates[dateKey].markerFillMax=Math.max(mapDates[dateKey].markerFillMax||dataMax,dataMax)}else{mapDates[dateKey].markerRadiusMin=Math.min(mapDates[dateKey].markerRadiusMin||dataMin,dataMin);mapDates[dateKey].markerRadiusMax=Math.max(mapDates[dateKey].markerRadiusMax||dataMax,dataMax)}}else{delete markerData[dateKey]}}}for(mddt in markerData){for(latlon in latlons){if(typeof markerData[mddt][latlon]=="undefined")markerData[mddt][latlon]={f:null,r:null}}}}for(dateKey in mapDates){aMapDates.push({s:dateKey,dt:dateFromMdDate(dateKey),regionMin:mapDates[dateKey].regionMin,regionMax:mapDates[dateKey].regionMax,markerRadiusMin:mapDates[dateKey].markerRadiusMin,markerRadiusMax:mapDates[dateKey].markerRadiusMax,markerFillMin:mapDates[dateKey].markerFillMin,markerFillMax:mapDates[dateKey].markerFillMax})}aMapDates.sort(function(a,b){return a.dt-b.dt});var thisMapsCalculatedMapData={title:mapTitle,freq:mapFreq,mapUnits:mapUnits,markers:markers,markerData:markerData,dates:aMapDates,regionData:regionData,fillUnits:fillUnits,radiusUnits:radiusUnits};if(graph.mapsets)graph.mapsets[mapIndex].calculatedMapData=thisMapsCalculatedMapData;return thisMapsCalculatedMapData}function _setStartEndDateIndexes(){if(oGraph.intervals){calculatedMapData.startDateIndex=calculatedMapData.dates.length-parseInt(oGraph.intervals);calculatedMapData.endDateIndex=calculatedMapData.dates.length-1}else{calculatedMapData.startDateIndex=calculatedMapData.dates.length-1;calculatedMapData.endDateIndex=0;for(i=0;i<calculatedMapData.dates.length;i++){if((!oGraph.start||parseInt(oGraph.start)<=calculatedMapData.dates[i].dt.getTime())&&(!oGraph.end||parseInt(oGraph.end)>=calculatedMapData.dates[i].dt.getTime())){if(calculatedMapData.startDateIndex>i)calculatedMapData.startDateIndex=i;if(calculatedMapData.endDateIndex<i)calculatedMapData.endDateIndex=i}}}}function _calcAttributes(graph){var i,y,firstDateKey,dateKey,geo,geos={},min,max,calcData=graph.calculatedMapData;var mapMode=oGraph.mapsets&&oGraph.mapsets[activeMapTab].mapMode();var changeCalc=false;switch(mapMode){case"abs-change":case"change-bubbles":changeCalc=function(a,b){return b-a};break;case"percent-change":changeCalc=function(a,b){return(b-a)/a};break;default:}calcData.regionMin=Number.MAX_VALUE;calcData.regionMax=Number.MIN_VALUE;if(graph.intervals){calcData.startDateIndex=calcData.dates.length-parseInt(graph.intervals);calcData.endDateIndex=calcData.dates.length-1;for(i=calcData.startDateIndex;i<calcData.endDateIndex+1;i++){if(graph.mapsets){if(!changeCalc){calcData.regionMin=Math.min(calcData.dates[i].regionMin,calcData.regionMin);calcData.regionMax=Math.max(calcData.regionMax,calcData.dates[i].regionMax)}else{if(i!=calcData.startDateIndex){for(geo in calcData.regionData[calcData.dates[i].s]){var startValue=calcData.regionData[calcData.dates[calcData.startDateIndex].s][geo];var endValue=calcData.regionData[calcData.dates[i].s][geo];var changeValue=changeCalc(startValue,endValue);if(!isNaN(changeValue)){calcData.regionMin=Math.min(changeValue,calcData.regionMin);calcData.regionMax=Math.max(calcData.regionMax,changeValue)}}}}}}}else{calcData.startDateIndex=calcData.dates.length-1;calcData.endDateIndex=0;for(i=0;i<calcData.dates.length;i++){if((!graph.start||parseInt(graph.start)<=calcData.dates[i].dt.getTime())&&(!graph.end||parseInt(graph.end)>=calcData.dates[i].dt.getTime())){if(calcData.startDateIndex>i)calcData.startDateIndex=i;if(calcData.endDateIndex<i)calcData.endDateIndex=i;if(graph.mapsets){if(!changeCalc){calcData.regionMin=Math.min(calcData.dates[i].regionMin,calcData.regionMin);calcData.regionMax=Math.max(calcData.regionMax,calcData.dates[i].regionMax)}else{if(i!=calcData.startDateIndex){for(geo in calcData.regionData[calcData.dates[i].s]){var startValue=calcData.regionData[calcData.dates[calcData.startDateIndex].s][geo];var endValue=calcData.regionData[calcData.dates[i].s][geo];var changeValue=changeCalc(startValue,endValue);if(!isNaN(changeValue)){calcData.regionMin=Math.min(changeValue,calcData.regionMin);calcData.regionMax=Math.max(calcData.regionMax,changeValue)}}}}}}}}var rgb,continuous,spans,mapOptions,startVal;if(graph.mapsets){var regionFillColors={};mapOptions=graph.mapsets[0].options;continuous=!mapOptions.scale||mapOptions.scale=="continuous";min=calcData.regionMin;max=calcData.regionMax;spans=min<0&&max>0;calcData.regionColors={};if(continuous){rgb={pos:_calcAttributes_makeRGB(mapOptions.posColor||MAP_COLORS.POS),neg:_calcAttributes_makeRGB(mapOptions.negColor||MAP_COLORS.NEG),mid:_calcAttributes_makeRGB(MAP_COLORS.MID)};var posRGB=new RGBColour(rgb.pos.r,rgb.pos.b,rgb.pos.g);var posHSV=posRGB.getHSV();var posMid=new HSVColour(posHSV.h,spans?10:20,spans?90:100);var posMidRGB=posMid.getIntegerRGB();rgb.posMid={r:posMidRGB.r,g:posMidRGB.g,b:posMidRGB.b};var negRGB=new RGBColour(rgb.neg.r,rgb.neg.b,rgb.neg.g);var negHSV=negRGB.getHSV();var negMid=new HSVColour(negHSV.h,spans?10:20,spans?90:100);var negMidRGB=negMid.getIntegerRGB();rgb.negMid={r:negMidRGB.r,g:negMidRGB.g,b:negMidRGB.b}}var startDateKey=calcData.dates[calcData.startDateIndex].s;for(i=calcData.startDateIndex;i<=calcData.endDateIndex;i++){dateKey=calcData.dates[i].s;calcData.regionColors[dateKey]={};if(calcData.regionData[dateKey]){for(geo in calcData.regionData[dateKey]){geos[geo]=true;y=calcData.regionData[dateKey][geo];if(changeCalc){if(calcData.regionData[startDateKey]&&calcData.regionData[startDateKey][geo]){startVal=calcData.regionData[startDateKey][geo];y=changeCalc(startVal,y)}else{y=null}}if(!isNaN(y)&&y!==null){y=parseFloat(y);if(continuous){if(y==0){calcData.regionColors[dateKey][geo]=MAP_COLORS.MID}else{calcData.regionColors[dateKey][geo]=_calcAttributes_colorInRange(y,y<0?min:spans?0:min,y>0?max:spans?0:max,y<0?rgb.neg:rgb.posMid,y<0?rgb.negMid:rgb.pos,mapOptions.logMode=="on"&&!spans&&min!=0&&max!=0)}}else{for(j=0;j<mapOptions.discreteColors.length;j++){if(j!=mapOptions.discreteColors.length-1&&y<=parseFloat(mapOptions.discreteColors[j].cutoff)||j==mapOptions.discreteColors.length-1){calcData.regionColors[dateKey][geo]=mapOptions.discreteColors[j].color;break}}}}else{calcData.regionColors[dateKey][geo]="#ffffff"}}}else{for(firstDateKey in calcData.regionData){for(geo in calcData.regionData[firstDateKey]){calcData.regionColors[dateKey][geo]="#ffffff"}break}}}for(dateKey in calcData.regionColors){for(geo in geos){if(typeof calcData.regionColors[dateKey][geo]=="undefined"){calcData.regionColors[dateKey][geo]="#ffffff"}}}}if(graph.pointsets){mapOptions=graph.mapconfig;continuous=!mapOptions.scale||mapOptions.scale=="continuous";if(continuous){}var markerFillMin=Number.MAX_VALUE,markerFillMax=Number.MIN_VALUE;var markerRadiusMin=Number.MAX_VALUE,markerRadiusMax=Number.MIN_VALUE;for(i=calcData.startDateIndex;i<=calcData.endDateIndex;i++){if(calcData.dates[i].markerRadiusMin){markerRadiusMin=Math.min(calcData.dates[i].markerRadiusMin,markerRadiusMin);markerRadiusMax=Math.max(calcData.dates[i].markerRadiusMax,markerRadiusMax)}if(calcData.dates[i].markerFillMin){markerFillMin=Math.min(calcData.dates[i].markerFillMin,markerFillMin);markerFillMax=Math.max(calcData.dates[i].markerFillMax,markerFillMax)}}var markerRadiusAbs;var hasRadiusScaling=markerRadiusMin!=Number.MAX_VALUE;if(hasRadiusScaling){markerRadiusAbs=Math.max(Math.abs(markerRadiusMin),Math.abs(markerRadiusMax));calcData.radiusScale=markerRadiusAbs}var hasFillShading=markerFillMin!=Number.MAX_VALUE;if(hasFillShading){calcData.markerFillMinValue=markerFillMin;calcData.markerFillMaxValue=markerFillMax;continuous=hasFillShading&&(!graph.mapconfig.scale||mapOptions.scale=="continuous");spans=markerFillMin<0&&markerFillMax>0;if(continuous){rgb={pos:_calcAttributes_makeRGB(mapOptions.posColor||MAP_COLORS.POS),neg:_calcAttributes_makeRGB(mapOptions.negColor||MAP_COLORS.NEG),posMid:{},negMid:{},mid:_calcAttributes_makeRGB(MAP_COLORS.MID)};var posRGB=new RGBColour(rgb.pos.r,rgb.pos.b,rgb.pos.g);var posHSV=posRGB.getHSV();var posMid=new HSVColour(posHSV.h,spans?10:20,spans?90:100);var posMidRGB=posMid.getIntegerRGB();rgb.posMid={r:posMidRGB.r,g:posMidRGB.g,b:posMidRGB.b};var negRGB=new RGBColour(rgb.neg.r,rgb.neg.b,rgb.neg.g);var negHSV=negRGB.getHSV();var negMid=new HSVColour(negHSV.h,spans?10:20,spans?90:100);var negMidRGB=negMid.getIntegerRGB();rgb.negMid={r:negMidRGB.r,g:negMidRGB.g,b:negMidRGB.b}}}var markerId,fillData,rData,markerAttr={r:{},fill:{},stroke:{}};for(dateKey in calcData.markerData){markerAttr.r[dateKey]={};markerAttr.fill[dateKey]={};markerAttr.stroke[dateKey]={};for(markerId in calcData.markers){if(hasRadiusScaling){rData=calcData.markerData[dateKey][markerId].r||null;if(rData<0){markerAttr.stroke[dateKey][markerId]="#ff0000";rData=Math.abs(rData)}else{markerAttr.stroke[dateKey][markerId]="#000000"}markerAttr.r[dateKey][markerId]=(graph.mapconfig.maxRadius||DEFAULT_RADIUS_SCALE)*Math.sqrt(rData)/Math.sqrt(markerRadiusAbs)}if(hasFillShading){fillData=calcData.markerData[dateKey][markerId].f||null;if(isNaN(fillData)||fillData===null){markerAttr.fill[dateKey][markerId]="#ffffff"}else{if(continuous){if(spans){markerAttr.fill[dateKey][markerId]=_calcAttributes_colorInRange(fillData,fillData<0?markerFillMin:spans?0:markerFillMin,fillData>0?markerFillMax:spans?0:markerFillMax,fillData<0?rgb.neg:rgb.posMid,fillData<0?rgb.negMid:rgb.pos)}else{markerAttr.fill[dateKey][markerId]=_calcAttributes_colorInRange(fillData,fillData<0?markerFillMin:spans?0:markerFillMin,fillData>0?markerFillMax:spans?0:markerFillMax,fillData<0?rgb.neg:rgb.mid,fillData<0?rgb.mid:rgb.pos)}}else{for(j=0;j<graph.mapconfig.discreteColors;j++){if(j==0&&parseFloat(graph.mapconfig.discreteColors[j].cutoff)<=fillData||j!=0&&parseFloat(graph.mapconfig.discreteColors[j].cutoff)<fillData){markerAttr.fill[dateKey][markerId]=graph.mapconfig.discreteColors[j].color}else break}}}}else{}}}calcData.markerAttr=markerAttr}function _calcAttributes_makeRGB(color){if(color.substr(0,1)=="#")color=color.substr(1);var r,g,b;r=parseInt(color.substr(0,2),16);g=parseInt(color.substr(2,2),16);b=parseInt(color.substr(4,2),16);return{r:r,g:g,b:b}}function _calcAttributes_colorInRange(y,y1,y2,rgb1,rgb2,logScaling){var r,g,b,yl,yl1,yl2,percent,octet=MD.common.octet;if(logScaling){yl=Math.log(Math.abs(y));yl1=Math.log(Math.min(Math.abs(y1),Math.abs(y2)));yl2=Math.log(Math.max(Math.abs(y1),Math.abs(y2)));percent=(yl-yl1)/(yl2-yl1)}else{percent=(y-y1)/(y2-y1)}r=octet(Math.round(percent*(rgb2.r-rgb1.r)+rgb1.r));g=octet(Math.round(percent*(rgb2.g-rgb1.g)+rgb1.g));b=octet(Math.round(percent*(rgb2.b-rgb1.b)+rgb1.b));return"#"+r+g+b}}function _calcMinMax(mode){var calcData=oGraph.calculatedMapData,extremes={},value;calcData["region"+mode]={};for(dateKey in calcData.regionData){for(geo in calcData.regionData[dateKey]){if(calcData.regionData[dateKey]){value=calcData.regionData[dateKey][geo];if(value!==null){if(typeof extremes[geo]=="undefined"||(mode=="min"?value<extremes[geo]:value>extremes[geo])){extremes[geo]=value;calcData["region"+mode][geo]=dateKey}}}}}calcData["marker"+mode]={};for(dateKey in calcData.markerData){for(geo in calcData.markerData[dateKey]){if(calcData.markerData[dateKey]){value=calcData.markerData[dateKey][geo];if(value!==null){if(typeof extremes[geo]=="undefined"||(mode=="min"?value<extremes[geo]:value>extremes[geo])){extremes[geo]=value;calcData["marker"+mode][geo]=dateKey}}}}}}function _getMapDataByContainingDate(mapData,mdDate){while(mdDate.length>=4){if(mapData[mdDate])return mapData[mdDate];mdDate=mdDate.substr(0,mdDate.length-2)}return false}}},visiblePanelId:function visiblePanelId(){var visPan=$("div.graph-panel:visible");if(visPan.length==1){return visPan.get(0).id}else{return null}},formatDateByPeriod:function formatDateByPeriod(val,period){if(isNaN(val)==false&&val!==null){var dt=new Date(parseInt(val));switch(period){case"A":return dt.getUTCFullYear();case"Q":return"Q"+parseInt((dt.getUTCMonth()+3)/3)+" "+dt.getUTCFullYear();case"SA":case"M":return months[dt.getUTCMonth()]+" "+dt.getUTCFullYear();case"W":case"D":return dt.getUTCDate()+" "+months[dt.getUTCMonth()]+" "+dt.getUTCFullYear();default:return dt.toUTCString().substr(5,20)}}else{return"-"}},fillScalingCount:function fillScalingCount(pointsets){var fill=0;if(pointsets instanceof Array){fill=pointsets.length-areaScalingCount(pointsets)}return fill},areaScalingCount:function areaScalingCount(pointsets){var area=0;if(pointsets instanceof Array){$.each(pointsets,function(){if(this.options.attribute!="fill")area++})}return area}};var chartPanel=grapher.chartPanel,intervalStartDt=grapher.intervalStartDt,setCropSlider=grapher.setCropSlider,closestDate=grapher.closestDate,createMyGraph=grapher.createMyGraph,makeChartOptionsObject=grapher.makeChartOptionsObject,buildGraphPanel=grapher.buildGraphPanel,visiblePanelId=grapher.visiblePanelId,formatDateByPeriod=grapher.formatDateByPeriod,fillScalingCount=grapher.fillScalingCount,areaScalingCount=grapher.areaScalingCount;var graphTitle={template:'<div id="dwrap2">'+'<div id="titleEditor" style="width: 560px">'+'<input type="text" width="300px" name="title" /> '+'<button id="graph-title-change-ok">OK</button> '+'<button id="graph-title-change-cancel">cancel</button>'+"</div>"+"</div>",show:function(oTitle,callback){var self=this;$.fancybox(this.template,{width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none",left:"55px",top:"55px"});$("#fancybox-wrap").stop().css({top:"70px"});$("#graph-title-change-ok").click(self.changeOk);$("#graph-title-change-cancel").click(self.changeCancel);var thisPanelID=$(oTitle).closest("div.graph-panel").get(0).id;$("#titleEditor input").keyup(function(event){if(event.keyCode==13)self.changeOk()}).attr("data",thisPanelID).val(panelGraphs[thisPanelID].title).css("width","450px").focus();this.callback=callback},callBack:false,changeOk:function(){var thisPanelID=$("#titleEditor input").attr("data");var newTitle=$("#titleEditor input").val().trim();var graph=panelGraphs[thisPanelID];if(newTitle!=graph.title){graph.title=newTitle||"untitled";if(graph.plots){if(graph.title.length==0){graph.controls.chart.setTitle({text:"untitled - click to edit",style:{color:"grey",font:"italic"}})}else{graph.controls.chart.setTitle({text:graph.title,style:{color:"black",font:"normal"}})}$("#"+thisPanelID+" .highcharts-title").click(function(){graphTitle.show(this)})}var tabLabel=newTitle||"Graph "+thisPanelID.substr(thisPanelID.indexOf("-")+1);$("#graph-tabs a[href='#"+thisPanelID+"']").attr("title",tabLabel).html(tabLabel);$("#"+thisPanelID+" h3.mashabledata_map-title").html(graph.title);if(graph.title.length==0){if(this.callback)this.callback()}}graphTitle.changeCancel()},changeCancel:function(){$.fancybox.close();this.callBack=false}};return grapher;function calcGraphMinMaxZoomPeriod(oGraph){oGraph.smallestPeriod="A";oGraph.largestPeriod="N";var min,max,jsdt,handle,key;oGraph.eachComponent(function(){if(!this.firstdt&&(this.handle.charAt(0)=="M"||this.handle.charAt(0)=="X")){for(handle in oGraph.assets[this.handle()].data){jsdt=oGraph.assets[this.handle()].data[handle].firstdt;oGraph.assets[this.handle()].firstdt=Math.min(oGraph.assets[this.handle()].firstdt,jsdt)||jsdt;jsdt=oGraph.assets[this.handle()].data[handle].lastdt;oGraph.assets[this.handle()].lastdt=Math.max(oGraph.assets[this.handle()].lastdt,jsdt)||jsdt}}jsdt=this.firstdt;min=Math.min(jsdt,min)||jsdt||min;jsdt=this.lastdt;max=Math.max(jsdt,max)||jsdt||min});oGraph.eachPlot(function(){var thisFreq=this.freq();if(period.value[oGraph.smallestPeriod]>period.value[thisFreq])oGraph.smallestPeriod=thisFreq;if(period.value[oGraph.largestPeriod]<period.value[thisFreq])oGraph.largestPeriod=thisFreq});oGraph.firstdt=min;oGraph.lastdt=max;oGraph.minZoom=oGraph.start||oGraph.firstdt;oGraph.maxZoom=oGraph.end||oGraph.lastdt}function nextColor(aryOptionedObjects){var usedColors=[];$.each(aryOptionedObjects,function(){if(this.options&&this.options.color)usedColors.push(this.options.color)});var allColors=hcColors.concat(primeColors);for(var i=0;i<allColors.length;i++){if(usedColors.indexOf(allColors[i])==-1)return allColors[i]}return allColors[aryOptionedObjects.length%allColors.length]}function formatRationalize(value){if(value==0)return"0";var order=Math.floor(Math.log(Math.abs(value))/Math.LN10);var y=Math.round(value/Math.pow(10,order-2))*Math.pow(10,order-2);return common.numberFormat(y,order>1?0:2-order)}function vizualizeCube(graph,activeMapTab,geoKey,mapDate,action){console.time("vizualizeCube");if(typeof action=="undefined")action="new";var j,k,cubeid=graph.cubeid,mapPlot=graph.mapsets[activeMapTab];if(!graph.assets.cube)graph.assets.cube={data:{},id:cubeid};var cube=graph.assets.cube;if(!cube.data["G"+geoKey]){var $cubViz=graph.controls.$thisPanel.find("div.mashabledata_cube-viz");$cubViz.mask("loading...");callApi({command:"GetCubeSeries",ghash:graph.ghash||"",cubeid:cubeid,geokey:geoKey,freq:mapPlot.freq(),modal:"none"},function(jsoData,textStatus,jqXHR){cube.data["G"+geoKey]=jsoData.series;cube.theme=jsoData.theme;cube.name=jsoData.name;cube.units=jsoData.units;cube.barAxis=jsoData.baraxis;cube.barNames=jsoData.barnames?JSON.parse(jsoData.barnames.replace(/u0022/g,'"')):false;cube.stackAxis=jsoData.stackaxis;cube.stackNames=jsoData.stacknames?JSON.parse(jsoData.stacknames.replace(/u0022/g,'"')):false;cube.sideAxis=jsoData.sideaxis;cube.sideNames=jsoData.sidenames?JSON.parse(jsoData.sidenames.replace(/u0022/g,'"')):false;$cubViz.unmask();makeCubeChart()})}else{makeCubeChart()}function makeCubeChart(){var geoName=null;if(isNaN(geoKey)){graph.eachComponent(function(){if(!geoName){if(this.handle[0]=="M"&&graph.assets[this.handle()].data[geoKey])geoName=graph.assets[this.handle()].data[geoKey].geoname}})}else{geoName=graph.map}var cubeData=cube.data["G"+geoKey],i;cube.hasData=false;for(i=0;i<cubeData.length;i++){if(cubeData[i].data){cube.hasData=true;break}}var title=(graph.mapconfig&&graph.mapconfig.cube&&graph.mapconfig.cube.name||cube.name||cube.theme)+"<br>"+(cube.hasData?geoName||"":"");var vizChart={chart:{type:"bar",spacingRight:50,renderTo:graph.controls.$thisPanel.find(".mashabledata_cube-viz")[0],cubeId:graph.cubeid},title:{text:title,style:{fontSize:"12px"}},subtitle:{text:jvm.Map.maps[graph.mapFile].paths[geoKey]?jvm.Map.maps[graph.mapFile].paths[geoKey].name:"click on map to select location",style:{fontSize:"10px"}},plotOptions:{bar:{dataLabels:{enabled:false,align:"left",formatter:function(){return cube.hasData?this.point.rawY===null?"no data":this.y:""}},borderWidth:0,animation:false,stacking:"normal"}},xAxis:{categories:[],title:{text:null},lineWidth:1,minorGridLineWidth:0,labels:{enabled:true},minorTickLength:0,tickLength:0},yAxis:{title:{text:graph.mapconfig&&graph.mapconfig.cube&&graph.mapconfig.cube.units||cube.units||""},labels:{enabled:false},lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",gridLineColor:"transparent",gridLineWidth:0},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false,type:"image/png",url:"https://www.mashabledata.com/workbench/export/index.php"},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{useHTML:true,formatter:function(){return"<b>"+cube.theme+"</b><br/>"+this.point.name+":<br/>"+common.numberFormat(Math.abs(this.point.y),0)+" "+cube.units}}};var point,y,barOrder,stackOrder,sideOrder,data=[],lastBar=0;var barAxis=cube.barAxis,stackAxis=cube.stackAxis,sideAxis=cube.sideAxis,cubeConfig=graph.mapconfig.cube;for(i=0;i<cubeData.length;i++){barOrder=parseInt(cubeData[i].barorder);sideOrder=parseInt(cubeData[i].sideorder);stackOrder=parseInt(cubeData[i].stackorder);y=seriesValue(cubeData[i].data,mapDate);point={y:(cube.sideAxis&&sideOrder==0?-1:1)*y,rawY:y,name:cubeData[i].name};data.push(point);if(barOrder==cube.barNames.length-1){var serie={data:data,color:cube.stackNames?globals.hcColors[stackOrder]:globals.hcColors[sideOrder]};if(cube.stackNames)serie.name=cubeConfig&&cubeConfig.dims[stackAxis]&&cubeConfig.dims[stackAxis][stackOrder]||cube.stackNames[stackOrder];if(sideOrder==1)serie.linkedTo=":previous";if(sideOrder==1||!cube.stackNames)serie.showInLegend=false;vizChart.series.push(serie);data=[]}}for(i=0;i<cube.barNames.length;i++){vizChart.xAxis.categories.push(cubeConfig&&cubeConfig.dims[barAxis]&&cubeConfig.dims[barAxis][i]||cube.barNames[i])}if(!cube.stackNames){vizChart.plotOptions.bar.dataLabels.enabled=true}if(cube.sideAxis)vizChart.xAxis.lineWidth=0;switch(action){case"add":vizChart.series[0].showInLegend=true;graph.controls.vizChart.addSeries(vizChart.series[0]);break;case"remove":graph.controls.vizChart.get(geoKey).remove(false);break;case"summation":vizChart.series[0].pointWidth=1;vizChart.series[0].pointPadding=0;vizChart.plotOptions.bar.groupPadding=0;default:if(graph.controls.vizChart&&graph.controls.vizChart.options.chart.cubeId!=graph.cubeid){graph.controls.vizChart.destroy()}if(graph.controls.vizChart){graph.controls.vizChart.setTitle(title,geoName,false);while(graph.controls.vizChart.series.length)graph.controls.vizChart.series[0].remove(false);for(i=0;i<vizChart.series.length;i++){graph.controls.vizChart.addSeries(vizChart.series[i],false)}graph.controls.vizChart.redraw()}else{graph.controls.vizChart=new Highcharts.Chart(vizChart)}}}console.timeEnd("vizualizeCube")}function getVizChartGeos(selectedRegions,oGraph,mapPlot,includeBunnies){var vizChartGeos=[],geoInfo,containingGeoInfo;if(includeBunnies){if(mapsList[oGraph.map].bunny){geoInfo=getGeoInfo(mapsList[oGraph.map].bunny,oGraph,mapPlot);if(geoInfo){geoInfo.bunny=true;vizChartGeos.push(geoInfo)}}}for(i=0;i<selectedRegions.length;i++){var regionCode=selectedRegions[i];if(geoInfo=getGeoInfo(regionCode,oGraph,mapPlot)){if(includeBunnies&&geoInfo.c_geoid){containingGeoInfo=getGeoInfo(geoInfo.c_geoid,oGraph,mapPlot);if(containingGeoInfo)vizChartGeos.push(containingGeoInfo)}vizChartGeos.push(geoInfo)}}return vizChartGeos;function getGeoInfo(geoid,oGraph,mapPlot){var info,mapCode;if(isNaN(geoid)){info={code:geoid};mapPlot.eachComponent(function(){if(!info.geoname&&this.isMapSet()){var asset=oGraph.assets[this.handle()];if(asset.data[info.code]){info.geoid=asset.data[info.code].geoid;info.geoname=asset.data[info.code].geoname;info.c_geoid=asset.data[info.code].c_geoid}}})}else{info={geoid:geoid};mapPlot.eachComponent(function(){if(!info.geoname&&this.isMapSet()){var asset=oGraph.assets[this.handle()];for(mapCode in asset.data){if(asset.data[mapCode].geoid==geoid){info.geoname=asset.data[mapCode].geoname;info.code=mapCode;info.c_geoid=asset.data[info.code].c_geoid;break}}}})}return info.geoname?info:false}}function seriesValue(mdData,mdDate){if(!mdData)return null;var point,data=Array.isArray(mdData)?mdData:mdData.split("|");for(var i=0;i<data.length;i++){point=data[i].split(":");if(point[0]==mdDate){if(point[1]=="null"||point[1]===null)return null;else return parseFloat(point[1])}}return null}function sizeShowPanels(graph){if(!graph.controls)return;var hasChart=graph.plots!=null,hasMapViz=graph.hasMapViz(),hasMap=graph.mapsets||graph.pointsets!=null,sizes=graph.mapconfig.sizes,$thisPanel=graph.controls.$thisPanel,$container=$thisPanel.find(".mashabledata_chart-map"),$chart=$thisPanel.find(".mashabledata_chart"),$anno=$thisPanel.find("div.annotations"),$viz=$thisPanel.find(".mashabledata_cube-viz"),$mapTitle=$thisPanel.find("h3.mashabledata_map-title"),$mapAndVizContainer=$thisPanel.find(".mashabledata_map"),$jvmap=$thisPanel.find(".mashabledata_jvmap");if(hasChart){$chart.show();$anno.show();$mapTitle.hide()}else{$chart.hide();$anno.hide();$mapTitle.show();if(graph.controls.chart){graph.controls.chart.destroy();delete graph.controls.chart}}if(hasMap){$jvmap.show()}else{$jvmap.hide()}if(hasMapViz){$viz.show()}else{$viz.hide();if(graph.controls.vizChart){graph.controls.vizChart.destroy();delete graph.controls.vizChart}}if(hasMap||hasMapViz){$mapAndVizContainer.show()}else{$mapAndVizContainer.hide()}if(sizes&&(_xor(sizes.chart,hasChart)||_xor(sizes.map,hasMap)||_xor(sizes.viz,hasMapViz))){sizes=false;delete graph.mapconfig.sizes}if(sizes){if(hasChart)$chart.width(sizes.chart.width).height(sizes.chart.height);if(hasMap)$jvmap.width(sizes.map.width).height(sizes.map.height);if(hasMapViz)$viz.width(sizes.viz.width).height(sizes.viz.height)}else{var mapHeight=($thisPanel.height()-85-(graph.plots?0:55))*(graph.plots?.6:1)+"px";if(hasMapViz){$viz.height(mapHeight);$jvmap.css("width","70%")}else{$jvmap.removeAttr("style")}if(hasMap)$jvmap.height(mapHeight);if(hasChart){var plotHeight=($thisPanel.height()-70-(hasMap&&graph.mapsets&&graph.mapsets.length>1?70:0))*(hasMap||hasMapViz?.4:1)+"px";$chart.removeAttr("style").height(plotHeight)}$thisPanel.find(".graph-subpanel").width($thisPanel.width()-35-2).height($thisPanel.height());$thisPanel.find(".graph-sources").width($thisPanel.width()-35-2-40);$container.width($thisPanel.width()-365)}function _xor(a,b){return a&&!b||!a&&b}}}();this.jStat=function(Math,undefined){var concat=Array.prototype.concat;var slice=Array.prototype.slice;var toString=Object.prototype.toString;function calcRdx(n,m){var val=n>m?n:m;return Math.pow(10,17-~~(Math.log(val>0?val:-val)*Math.LOG10E))}var isArray=Array.isArray||function isArray(arg){return toString.call(arg)==="[object Array]"};function isFunction(arg){return toString.call(arg)==="[object Function]"}function isNumber(arg){return typeof arg==="number"&&arg===arg}function toVector(arr){return concat.apply([],arr)}function jStat(){return new jStat._init(arguments)}jStat.fn=jStat.prototype;jStat._init=function _init(args){var i;if(isArray(args[0])){if(isArray(args[0][0])){if(isFunction(args[1]))args[0]=jStat.map(args[0],args[1]);for(i=0;i<args[0].length;i++)this[i]=args[0][i];this.length=args[0].length}else{this[0]=isFunction(args[1])?jStat.map(args[0],args[1]):args[0];this.length=1}}else if(isNumber(args[0])){this[0]=jStat.seq.apply(null,args);this.length=1}else if(args[0]instanceof jStat){return jStat(args[0].toArray())}else{this[0]=[];this.length=1}return this};jStat._init.prototype=jStat.prototype;jStat._init.constructor=jStat;jStat.utils={calcRdx:calcRdx,isArray:isArray,isFunction:isFunction,isNumber:isNumber,toVector:toVector};jStat.cols=function cols(arr){return arr[0].length||1};return jStat}(Math);(function(jStat,Math){jStat.sum=function sum(arr){var sum=0;var i=arr.length;var tmp;while(--i>=0)sum+=arr[i];return sum};jStat.sumsqerr=function sumsqerr(arr){var mean=jStat.mean(arr);var sum=0;var i=arr.length;var tmp;while(--i>=0){tmp=arr[i]-mean;sum+=tmp*tmp}return sum};jStat.mean=function mean(arr){return jStat.sum(arr)/arr.length};jStat.variance=function variance(arr,flag){return jStat.sumsqerr(arr)/(arr.length-(flag?1:0))};jStat.stdev=function stdev(arr,flag){return Math.sqrt(jStat.variance(arr,flag))};jStat.covariance=function covariance(arr1,arr2){var u=jStat.mean(arr1);var v=jStat.mean(arr2);var arr1Len=arr1.length;var sq_dev=new Array(arr1Len);var i;for(i=0;i<arr1Len;i++)sq_dev[i]=(arr1[i]-u)*(arr2[i]-v);return jStat.sum(sq_dev)/(arr1Len-1)};jStat.corrcoeff=function corrcoeff(arr1,arr2){return jStat.covariance(arr1,arr2)/jStat.stdev(arr1,1)/jStat.stdev(arr2,1)};jStat.skewness=function skewness(arr){return jStat.stanMoment(arr,3)};jStat.kurtosis=function kurtosis(arr){return jStat.stanMoment(arr,4)-3};var jProto=jStat.prototype})(this.jStat,Math);if(typeof console=="undefined")console={};if(typeof console.info=="undefined")console.info=function(m){};if(typeof console.log=="undefined")console.log=function(m){};if(typeof console.time=="undefined")console.time=function(m){};if(typeof console.timeEnd=="undefined")console.timeEnd=function(m){};function addJQueryStringify(){jQuery.extend({stringify:function stringify(obj){if("JSON"in window){return JSON.stringify(obj)}var t=typeof obj;if(t!="object"||obj===null){if(t=="string")obj='"'+obj+'"';return String(obj)}else{var n,v,json=[],arr=obj&&obj.constructor==Array;for(n in obj){v=obj[n];t=typeof v;if(obj.hasOwnProperty(n)){if(t=="string"){v='"'+v+'"'}else if(t=="object"&&v!==null){v=jQuery.stringify(v)}json.push((arr?"":'"'+n+'":')+String(v))}}return(arr?"[":"{")+String(json)+(arr?"]":"}")}}})}Date.prototype.toMDDateString=function(period){var p=period||this.period;if(!p)throw"no period found";var mdDate=this.getUTCFullYear();switch(period){case"M":mdDate+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();break;case"Q":mdDate+="Q"+parseInt((this.getUTCMonth()+3)/3);break;case"SA":mdDate+="H"+parseInt((this.getUTCMonth()+6)/6);break;case"W":case"D":mdDate+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();mdDate+=(this.getUTCDate().toString().length==1?"0":"")+this.getUTCDate();break}return mdDate};if(!("bind"in Function.prototype)){Function.prototype.bind=function(owner){var that=this;
if(arguments.length<=1){return function(){return that.apply(owner,arguments)}}else{var args=Array.prototype.slice.call(arguments,1);return function(){return that.apply(owner,arguments.length===0?args:args.concat(Array.prototype.slice.call(arguments)))}}}}if(!("trim"in String.prototype)){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(find,i){if(i===undefined)i=0;if(i<0)i+=this.length;if(i<0)i=0;for(var n=this.length;i<n;i++)if(i in this&&this[i]===find)return i;return-1}}if(!("lastIndexOf"in Array.prototype)){Array.prototype.lastIndexOf=function(find,i){if(i===undefined)i=this.length-1;if(i<0)i+=this.length;if(i>this.length-1)i=this.length-1;for(i++;i-->0;)if(i in this&&this[i]===find)return i;return-1}}if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(action,that){for(var i=0,n=this.length;i<n;i++)if(i in this)action.call(that,this[i],i,this)}}if(!("map"in Array.prototype)){Array.prototype.map=function(mapper,that){var other=new Array(this.length);for(var i=0,n=this.length;i<n;i++)if(i in this)other[i]=mapper.call(that,this[i],i,this);return other}}if(!("filter"in Array.prototype)){Array.prototype.filter=function(filter,that){var other=[],v;for(var i=0,n=this.length;i<n;i++)if(i in this&&filter.call(that,v=this[i],i,this))other.push(v);return other}}if(!("every"in Array.prototype)){Array.prototype.every=function(tester,that){for(var i=0,n=this.length;i<n;i++)if(i in this&&!tester.call(that,this[i],i,this))return false;return true}}if(!("some"in Array.prototype)){Array.prototype.some=function(tester,that){for(var i=0,n=this.length;i<n;i++)if(i in this&&tester.call(that,this[i],i,this))return true;return false}}if("function"!==typeof Array.prototype.reduce){Array.prototype.reduce=function(callback){"use strict";if(null===this||"undefined"===typeof this){throw new TypeError("Array.prototype.reduce called on null or undefined")}if("function"!==typeof callback){throw new TypeError(callback+" is not a function")}var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length>=2){value=arguments[1]}else{while(k<len&&!k in t)k++;if(k>=len)throw new TypeError("Reduce of empty array with no initial value");value=t[k++]}for(;k<len;k++){if(k in t){value=callback(value,t[k],k,t)}}return value}}MashableData.Annotator=function Annotator(panelId,makeDirty){var MD=MashableData,globals=MD.globals,common=MD.common,grapher=MD.grapher;var BAND_TRANSPARENCY=globals.BAND_TRANSPARENCY;var panelGraphs=globals.panelGraphs;var equivalentRGBA=common.equivalentRGBA;var period=globals.period;var controller={panelId:panelId,bandNo:0,lineNo:0,banding:false,bandStartPoint:void 0,makeDirty:makeDirty,callApi:MD.common.callApi,addStandard:function addStandard(annoid){var self=this;self.callApi({command:"GetAnnotation",annoid:annoid},function(data){standardAnno=jQuery.parseJSON(data.annotation);for(var i=0;i<standardAnno.length;i++){panelGraphs[panelId].annotations.push(standardAnno[i])}self.build("new")})},fetchStandards:function(){if(globals.standardAnnotations.length==0){var self=this;this.callApi({command:"GetAnnotations"},function(results){for(var i=0;i<results.annotations.length;i++)globals.standardAnnotations.push(results.annotations[i])})}},sync:function annoSync(){var thisChart=panelGraphs[this.panelId].controls.chart;var axis=thisChart.options.xAxis,plotLines=axis.plotLines=[],plotBands=axis.plotBands=[];var anno;for(var i=0;i<thisChart.xAxis[0].plotLinesAndBands.length;i++){anno=thisChart.xAxis[0].plotLinesAndBands[i];if(anno.id.substr(0,1)=="xb"){plotBands.push(anno.options)}else{plotLines.push(anno.options)}}},addPoint:function annotatePoint(selectedPoint){var oGraph=panelGraphs[panelId];if(typeof selectedPoint!="undefined"){var point;for(var i=0;i<oGraph.annotations.length;i++){if(oGraph.annotations[i].type=="point"){point=oGraph.controls.chart.get(oGraph.annotations[i].id);if(point){point.update([point.x,point.y],false)}delete oGraph.annotations[i].id}}oGraph.annotations.push({type:"point",text:"",id:null,series:selectedPoint.series.options.id,color:"#000000",from:formatDateByPeriod(selectedPoint.x,selectedPoint.series.options.freq)});this.build("point")}},addXLine:function annotateXLine(selectedPoint){var oGraph=panelGraphs[panelId];oGraph.controls.chart.xAxis[0].addPlotLine({value:selectedPoint.x,color:"#"+colorsPlotBands[0],id:"xl"+this.lineNo,width:2,label:{text:" ",y:0,zIndex:3}});oGraph.annotations.push({type:"line",text:"",id:"xl"+this.lineNo,color:colorsPlotBands[0],from:formatDateByPeriod(selectedPoint.x,selectedPoint.series.options.freq)});this.lineNo++;this.build("table-only")},startXBand:function annotateXBandStart(pointSelected){var oGraph=panelGraphs[panelId];this.bandStartPoint=pointSelected;this.bandColor=equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY);oGraph.controls.chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.bandStartPoint.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});this.banding="x-Time";pointSelected.select(true)},build:function buildAnnotations(redrawAnnoTypes){var y,yOffset,self=this,oGraph=panelGraphs[panelId],$thisPanel=oGraph.controls.$thisPanel,$annotations=$thisPanel.find("div.annotations").show().find("table");if(!globals.isEmbedded&&$annotations&&$annotations.get(0).rows.length!=0){$thisPanel.find(".graph-save").button("enable");oGraph.isDirty=true}if(!redrawAnnoTypes)redrawAnnoTypes="all";var sTable="";var annoLetter="A";var i,anno,point,annoSeries,annoScatter,fromJS,toJS;var scatterData={};for(i=0;i<oGraph.controls.chart.yAxis.length;i++){scatterData["labelsY-"+i]=[]}oGraph.annotations.sort(function(a,b){if(a.type.charAt(0)=="h"&&a.type.charAt(0)=="h")return b.from-a.from;if(a.type.charAt(0)=="h")return-1;if(b.type.charAt(0)=="h")return 1;return self.parseDate(a.from)-self.parseDate(b.from)});for(i=0;i<oGraph.annotations.length;i++){console.time("annotation loop");anno=oGraph.annotations[i];switch(anno.type){case"point":if(redrawAnnoTypes=="point"||redrawAnnoTypes=="all"){annoSeries=oGraph.controls.chart.get(anno.series);if(annoSeries==null){oGraph.annotations.splice(i,1);i--;break}annoScatter=oGraph.controls.chart.get("labelsY-"+annoSeries.options.yAxis);for(var j=0;j<annoSeries.data.length;j++){if(annoSeries.data[j]){if(annoSeries.data[j].x==this.parseDate(anno.from)){point=annoSeries.data[j];scatterData["labelsY-"+annoSeries.options.yAxis].push({x:point.x,y:point.y,id:annoLetter,text:anno.text,marker:{fillColor:anno.color,lineColor:anno.color,radius:8,symbol:"circle",enabled:true,states:{hover:{enabled:true,marker:{enabled:true,fillColor:anno.color,lineColor:anno.color,radius:8}}}}})}}}anno.id=annoLetter}sTable+='<tr data="'+annoLetter+'"><td align="center"><b>'+annoLetter+"</b></td><td>"+anno.from+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';annoLetter=String.fromCharCode(annoLetter.charCodeAt(0)+1);break;case"line":fromJS=this.parseDate(anno.from);if(fromJS>=parseInt(oGraph.start||oGraph.firstdt)&&fromJS<=parseInt(oGraph.end||oGraph.lastdt)){if(redrawAnnoTypes=="line"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="xl"+this.lineNo;this.lineNo++;yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].addPlotLine({color:anno.color,value:this.parseDate(anno.from),id:anno.id,width:2,label:{text:anno.text,y:yOffset,zIndex:3}})}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hline":if(redrawAnnoTypes=="hline"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="hl"+this.lineNo;this.lineNo++;for(y=0;y<oGraph.controls.chart.yAxis.length;y++){if(oGraph.controls.chart.yAxis[y].userOptions.title.text==anno.yAxis){oGraph.controls.chart.yAxis[y].addPlotLine({color:anno.color,value:anno.from,id:anno.id,width:2,label:{text:anno.text,zIndex:3}})}}}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+" "+anno.yAxis+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break;case"band":fromJS=this.parseDate(anno.from);toJS=this.parseDate(anno.to);if(fromJS>=parseInt(oGraph.start||oGraph.firstdt)&&fromJS<=parseInt(oGraph.end||oGraph.lastdt)||toJS>=parseInt(oGraph.start||oGraph.firstdt)&&toJS<=parseInt(oGraph.to||oGraph.lastdt)){if(redrawAnnoTypes=="band"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="xb"+this.bandNo++;yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:fromJS,to:toJS,id:anno.id,label:{text:anno.text,y:yOffset,zIndex:3}})}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+"-"+anno.to+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hband":if(redrawAnnoTypes=="hband"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="hb"+this.bandNo++;for(y=0;y<oGraph.controls.chart.yAxis.length;y++){if(oGraph.controls.chart.yAxis[y].userOptions.title.text==anno.yAxis){oGraph.controls.chart.yAxis[y].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:anno.from,to:anno.to,id:anno.id,label:{text:anno.text,zIndex:3}})}}}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+"-"+anno.to+" "+anno.yAxis+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break}console.timeEnd("annotation loop")}console.time("annotation redraw");if(redrawAnnoTypes=="point"||redrawAnnoTypes=="all"){for(var key in scatterData){oGraph.controls.chart.get(key).setData(scatterData[key],false)}console.info("annotations fired chart redraw");oGraph.controls.chart.redraw()}console.timeEnd("annotation redraw");if(!globals.isEmbedded){console.time("annotation rest");if(oGraph.annotations.length==0)sTable+='<tr><td colspan="3" class="grey-italics">right-click on the chart to annotate a point, band, or event, or to perform a linear regression or average</td></tr>';$annotations.html(sTable).find("input, select").change(function(){self.change(this)});$annotations.find(".annotation-color-picker").colorPicker();$annotations.find(".ui-icon-trash").click(function(){self["delete"](this)});console.timeEnd("annotation rest")}},change:function changeAnno(obj){var i,yOffset,y,id=$(obj).closest("tr").attr("data");panelGraphs[panelId].controls.$thisPanel.find(".graph-save").button("enable");var oGraph=panelGraphs[panelId];var anno;for(i=0;i<oGraph.annotations.length;i++){if(id==oGraph.annotations[i].id){anno=oGraph.annotations[i];break}}anno.text=$(obj).closest("tr").find("input.anno-text").val();anno.color=$(obj).closest("tr").find(".annotation-color-picker").val();switch(id.substr(0,2)){case"xb":yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].removePlotBand(id);oGraph.controls.chart.xAxis[0].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:this.parseDate(anno.from),to:this.parseDate(anno.to),id:anno.id,label:{text:anno.text,y:yOffset,zIndex:3}});break;case"hb":for(i=0;i<oGraph.controls.chart.yAxis.length;i++){if(oGraph.controls.chart.yAxis[i].userOptions.title.text=anno.yAxis){oGraph.controls.chart.yAxis[i].removePlotBand(id);oGraph.controls.chart.yAxis[i].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:parseFloat(anno.from),to:parseFloat(anno.to),id:anno.id,label:{text:anno.text,zIndex:3}})}}break;case"hl":for(i=0;i<oGraph.controls.chart.yAxis.length;i++){if(oGraph.controls.chart.yAxis[i].userOptions.title.text=anno.yAxis){oGraph.controls.chart.yAxis[i].removePlotLine(id);oGraph.controls.chart.yAxis[i].addPlotLine({color:anno.color,value:parseFloat(anno.from),id:anno.id,width:2,label:{text:anno.text,zIndex:3}})}}break;case"xl":yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].removePlotLine(id);oGraph.controls.chart.xAxis[0].addPlotLine({color:anno.color,value:this.parseDate(anno.from),id:anno.id,width:2,label:{text:anno.text,y:yOffset,zIndex:3}})}},"delete":function deleteAnno(deleteAnchor){var idToDelete=$(deleteAnchor).closest("tr").attr("data");var oGraph=panelGraphs[panelId];for(var i=0;i<oGraph.annotations.length;i++){if(idToDelete==oGraph.annotations[i].id){oGraph.annotations.splice(i,1);break}}if(idToDelete[1]=="b"||idToDelete[1]=="l"){for(a=0;a<oGraph.controls.chart.axes.length;a++){oGraph.controls.chart.axes[a].removePlotLine(idToDelete);oGraph.controls.chart.axes[a].removePlotBand(idToDelete)}this.build("none")}else{this.build("point")}},startAnalysisBanding:function(point,analysisType){var seriesColor=point.series.color;var chart=panelGraphs[panelId].controls.chart;r=parseInt(seriesColor.substr(1,2),16);g=parseInt(seriesColor.substr(3,2),16);b=parseInt(seriesColor.substr(5,2),16);this.bandColor="rgba("+r+","+g+","+b+",0.5)";this.banding=analysisType+"-"+point.series.index;this.bandStartPoint=point;chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:point.x,color:this.bandColor,id:analysisType+this.bandNo++,label:{text:" ",y:0,zIndex:3}})},deleteAnalysis:function(pointSelected){var fromX,toX,i,analyses,plotId=pointSelected.series.options.calculatedFrom;var analysisType=pointSelected.series.options.id.substr(0,2);if(plotId){fromX=pointSelected.series.data[0][0];toX=pointSelected.series.data[pointSelected.series.data.length-1][0];pointSelected.series.remove();switch(analysisType){case"LR":analyses=panelGraphs[panelId].plots[parseInt(plotId.substr(1))].options.linRegressions;break;case"AV":analyses=panelGraphs[panelId].plots[parseInt(plotId.substr(1))].options.averages;break}this.makeDirty();for(i=0;i<analyses.length;i++){if(analyses[i][0]==toX&&analyses[i][1]==fromX){analyses.splice(i,1);return true}}return false}},parseDate:function annoDateParse(partialDateString){if(partialDateString.length==4){partialDateString="1 Jan "+partialDateString+" UTC"}else if(partialDateString.length==8){partialDateString="1 "+partialDateString+" UTC"}else{partialDateString+=" UTC"}return Date.parse(partialDateString)},labelOffset:function annotationY(chart,anno){var yStart=10;var yInc=20;var annoMargin=.2;if(anno.text==" "||anno.text==" ")return 0;var plotLinesAndBands=chart.xAxis[0].plotLinesAndBands;var extremes=chart.xAxis[0].getExtremes();var minSeparation=(extremes.max-extremes.min)*annoMargin;var annoCenter;var overlappingAnnos=[];if(anno.to){annoCenter=(this.parseDate(anno.from)+this.parseDate(anno.to))/2}else{annoCenter=this.parseDate(anno.from)}var overlaps=0,thisCenter;for(var i=0;i<plotLinesAndBands.length;i++){if(plotLinesAndBands[i].id!="timeLine"){if(plotLinesAndBands[i].options.to){thisCenter=(plotLinesAndBands[i].options.from+plotLinesAndBands[i].options.to)/2}else{thisCenter=plotLinesAndBands[i].options.from}if(plotLinesAndBands[i].options.label.text.length>0&&Math.abs(thisCenter-annoCenter)<minSeparation){overlaps++;overlappingAnnos.push(plotLinesAndBands[i])}}}var y=yStart;for(var j=0;j<overlappingAnnos.length;j++){if(overlappingAnnos[j].options.label.y==y){y+=yInc;j=-1}}return y},mouseOverHCPoint:function mouseOverHCPoint(e,point){var chart=panelGraphs[panelId].controls.chart;if(!this.banding)return;if(this.banding=="x-Time"){try{chart.xAxis[0].removePlotBand("xb"+this.bandNo)}catch(err){}chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:point.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});return}if(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-"){var analysisType=this.banding.substr(0,2);try{chart.xAxis[0].removePlotBand(analysisType+this.bandNo)}catch(err){}this.endingX=closestDate(point.x,this.bandStartPoint.series.data);chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.endingX,color:this.bandColor,id:analysisType+this.bandNo,label:{text:" ",y:0,zIndex:3}})}},endBanding:function endBanding(e){var axisName,axisValue,userValue;var pointSelected=this.mouseoverPoint;var onPoint=typeof this.mouseoverPoint!="undefined";var oGraph=panelGraphs[panelId];var self=this;if(this.banding=="x-Time"){if(onPoint){var x1,x2;x1=formatDateByPeriod(this.bandStartPoint.x,this.bandStartPoint.series.options.freq);x2=formatDateByPeriod(pointSelected.x,pointSelected.series.options.freq);this.banding=false;oGraph.annotations.push({type:"band",text:"",id:"xb"+this.bandNo,color:"#"+colorsPlotBands[0],from:x1<x2?x1:x2,to:x1<x2?x2:x1});this.build("table-only");return false}else{return{items:{info:{name:"Mouse-over a series before right-clicking to terminate a vertical band.",callback:function(key,opt){}}}}}}if(this.banding&&(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-")){var analysisType=this.banding.substr(0,2);oGraph.controls.chart.xAxis[0].removePlotBand(analysisType+this.bandNo);var fromX=Math.min(this.bandStartPoint.x,this.endingX);var toX=Math.max(this.bandStartPoint.x,this.endingX);if(fromX<toX){switch(analysisType){case"LR":this.plotLinearRegression(this.bandStartPoint.series,fromX,toX,true);var plotOptions=oGraph.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!plotOptions.linRegressions)plotOptions.linRegressions=[];plotOptions.linRegressions.push([fromX,toX]);break;case"AV":this.plotAverage(this.bandStartPoint.series,fromX,toX,true);var plotOptions=oGraph.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!plotOptions.averages)plotOptions.averages=[];plotOptions.averages.push([fromX,toX]);break}self.makeDirty()}else{dialogShow("Error","The starting point and ending points must be different.")}this.banding=false;return}else{var top,left,x,y,i,chart=oGraph.controls.chart;for(i=0;i<chart.yAxis.length;i++){axisName=chart.yAxis[i].userOptions.title.text;if(this.banding=="y-"+axisName){top=$(chart.container).offset().top;left=$(chart.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft;y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){axisValue=parseFloat(parseFloat(chart.yAxis[i].translate(chart.plotHeight-y,true).toPrecision(2)));return{items:{axis:{name:"<b>"+axisName+":</b>",type:"text",value:axisValue},ok:{name:"<button>ok</button>",callback:function(key,opt){userValue=$.contextMenu.getInputValues(opt)["axis"];for(var i=0;i<chart.yAxis.length;i++){if(chart.yAxis[i].userOptions.title.text=self.banding.substr(2)){chart.yAxis[i].removePlotBand("hb"+self.bandNo);var y1,y2;y1=parseFloat(self.bandStartPoint);y2=parseFloat(userValue);chart.yAxis[i].removePlotBand("hb"+self.bandNo);chart.yAxis[i].addPlotBand({id:"hb"+self.bandNo,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:Math.min(y1,y2),to:Math.max(y1,y2),label:{text:"",zIndex:3}});oGraph.annotations.push({id:"hb"+self.bandNo,type:"hband",yAxis:axisName,text:"",color:"#"+colorsPlotBands[0],from:Math.min(self.bandStartPoint,userValue),to:Math.max(self.bandStartPoint,userValue)});self.build("table-only");self.banding=false;self.makeDirty();break}}}},cancel:{name:"<button>cancel</button>",callback:function(key,opt){for(i=0;i<chart.yAxis.length;i++){chart.yAxis[i].removePlotBand("hb"+self.bandNo);self.banding=false}}}}}}else{return false}}}}},plotAnnotationSeries:function(){var p,i,LR,AV;var oGraph=panelGraphs[panelId];var chart=oGraph.controls.chart;var start=oGraph.start||(oGraph.intervals?grapher.intervalStartDt(oGraph):oGraph.firstdt);if(oGraph.plots&&oGraph.plots.length>0){for(p=0;p<oGraph.plots.length;p++){if(oGraph.plots[p].options.linRegressions){for(i=0;i<oGraph.plots[p].options.linRegressions.length;i++){LR=oGraph.plots[p].options.linRegressions[i];if(LR[0]>=start&&LR[0]<=parseInt(oGraph.end||oGraph.lastdt)&&(LR[1]>=start&&LR[1]<=parseInt(oGraph.to||oGraph.lastdt))){this.plotLinearRegression(chart.get("P"+p),LR[0],LR[1])}}}if(oGraph.plots[p].options.averages){for(i=0;i<oGraph.plots[p].options.averages.length;i++){AV=oGraph.plots[p].options.averages[i];if(AV[0]>=start&&AV[0]<=parseInt(oGraph.end||oGraph.lastdt)&&(AV[1]>=start&&AV[1]<=parseInt(oGraph.to||oGraph.lastdt))){this.plotAverage(chart.get("P"+p),AV[0],AV[1])}}}}}chart.redraw()},plotLinearRegression:function(series,start,end,redraw){if(!redraw)redraw=false;var hChart=panelGraphs[panelId].controls.chart;var sumX=0,minX=null,maxX=null;var sumY=0,minY=null,maxY=null;var j,data=[],points=0;if(typeof start=="undefined"||typeof end=="undefined"){data=series.data}else{for(j=0;j<series.data.length;j++){if(series.data[j].x>=start&&series.data[j].x<=end){data.push(series.data[j])}}}for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){sumX+=data[j].x;sumY+=data[j].y;if(minX==null){minX=data[j].x}if(maxX==null){maxX=data[j].x}if(minY==null){minY=data[j].y}if(maxY==null){maxY=data[j].y}if(minX>data[j].x){minX=data[j].x}if(maxX<data[j].x){maxX=data[j].x}if(minY>data[j].y){minY=data[j].y}if(maxY<data[j].y){maxY=data[j].y}points++}}var avgX=sumX/points;var avgY=sumY/points;var num=0;var den=0;for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){num+=(data[j].x-avgX)*(data[j].y-avgY);den+=(data[j].x-avgX)*(data[j].x-avgX)}}var b1=num/den;var b0=avgY-b1*avgX;var m=b1*period.value[series.options.freq];var firstDigit=m.toString().search(/[1-9]/);var decimalLocation=m.toString().indexOf(".");var newSeries={name:"Linear regression of "+series.name+"<BR> (m="+common.numberFormat(m,decimalLocation>5||decimalLocation==-1?0:firstDigit+5-decimalLocation)+" per "+period.units[series.options.freq]+")",dashStyle:"LongDash",freq:series.options.freq,lineWidth:1,color:series.color,data:[],id:"LR"+this.bandNo++,calculatedFrom:series.options.id,shadow:false,marker:{enabled:false}};for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){newSeries.data.push([data[j].x,b1*data[j].x+b0])}}return hChart.addSeries(newSeries,redraw)},plotAverage:function(series,start,end,redraw){if(!redraw)redraw=false;var hChart=panelGraphs[panelId].controls.chart;var sumY=0,pointCount=0;var j,data=[],points=0;if(typeof start=="undefined"||typeof end=="undefined"){data=series.data}else{for(j=0;j<series.data.length;j++){if(series.data[j].x>=start&&series.data[j].x<=end){data.push(series.data[j]);if(series.data[j].y!==null){sumY+=series.data[j].y;pointCount++}}}}var avg=sumY/pointCount;var newSeries={name:"Average of "+series.name,dashStyle:"ShortDash",freq:series.options.freq,lineWidth:1,color:series.color,data:[],id:"AV"+this.bandNo++,calculatedFrom:series.options.id,shadow:false,marker:{enabled:false}};for(j=0;j<data.length;j++){newSeries.data.push([data[j].x,avg])}return hChart.addSeries(newSeries,redraw)}};if(!globals.isEmbedded)controller.fetchStandards();return controller};function makeTreeMap($div,calculatedMapData,mapFile,dateKey,fromDateKey){console.time("makeTreeMap");$div.html("");var renderer=new Highcharts.Renderer($div[0],$div.width(),$div.height());$div.hide();console.time("makeTreeMap calc");var rect=[0,0,$div.width(),$div.height()];if(!dateKey)dateKey=calculatedMapData.dates[calculatedMapData.dates.length-1].s;var sortedCodes=[],i,code,units=calculatedMapData.mapUnits,total=0,sortedValues=[],valueObject;for(code in calculatedMapData.regionData[dateKey]){if(jvm.Map.maps[mapFile].paths[code]){valueObject={code:code};if(fromDateKey){valueObject.fromValue=calculatedMapData.regionData[fromDateKey][code];valueObject.toValue=calculatedMapData.regionData[dateKey][code];valueObject.value=valueObject.toValue-valueObject.fromValue}else{valueObject.value=calculatedMapData.regionData[dateKey][code]}if(!isNaN(valueObject.value)){total+=Math.abs(valueObject.value);sortedCodes.push(valueObject)}}else{console.info(code+" code in fetched mapset is not found in "+mapFile)}}sortedCodes.sort(function(a,b){return b.value-a.value});for(i=0;i<sortedCodes.length;i++){sortedValues.push(Math.abs(sortedCodes[i].value)/total)}var squarified=MashableData.common.squarify(rect,sortedValues);console.timeEnd("makeTreeMap calc");var $statBox=$div.find(".MashableData_statBox");if(!$statBox.length){$div.append('<div class="MashableData_statBox"></div>');$statBox=$div.find(".MashableData_statBox")}for(i=0;i<squarified.length;i++){renderer.rect(squarified[i][0],squarified[i][1],squarified[i][2],squarified[i][3],0).attr({fill:sortedCodes[i].value>0?"#99CCFF":"red",stroke:"black","stroke-width":1}).on("mouseenter",treeOver(i)).on("mousemove",function(evt){$statBox.css("top",evt.pageY).css("left",evt.pageX+5).show()}).add();renderer.text(jvm.Map.maps[mapFile].paths[sortedCodes[i].code].name+"<br>"+Highcharts.numberFormat(sortedCodes[i].value)+(calculatedMapData.fillUnits?" "+calculatedMapData.fillUnits:""),squarified[i][0]+2,squarified[i][1]+10).attr({rotation:0}).css({fontSize:"6pt",color:"black"}).on("mousemove",function(evt){$statBox.css("top",evt.pageY).css("left",evt.pageX+5).show()}).add()}function treeOver(i){return function(evt){var regionName=jvm.Map.maps[mapFile].paths[sortedCodes[i].code].name;$statBox.html(regionName+":<br>"+sortedCodes[i].value+" "+units).css("top",evt.pageY).css("left",evt.pageX+5).show()}}$div.show().off().on("mouseout",function(){$statBox.hide()});console.timeEnd("makeTreeMap")}MashableData.common.sumArray=function(){function add(a,b){return a+b}return function(arr){return arr.reduce(add)}}();MashableData.common.squarify=function(rect,vals){var Subrectangle=function(rect){this.setX=function(x){rect[2]-=x-rect[0];rect[0]=x};this.setY=function(y){rect[3]-=y-rect[1];rect[1]=y};this.getX=function(){return rect[0]};this.getY=function(){return rect[1]};this.getW=function(){return rect[2]};this.getH=function(){return rect[3]};this.getWidth=function(){return Math.min(rect[2],rect[3])}};var worst=function(r,w){var rMax=Math.max.apply(null,r);var rMin=Math.min.apply(null,r);var s=MashableData.common.sumArray(r);var sSqr=s*s;var wSqr=w*w;return Math.max(wSqr*rMax/sSqr,sSqr/(wSqr*rMin))};var layoutrow=function(row){var x=subrect.getX(),y=subrect.getY(),maxX=x+subrect.getW(),maxY=y+subrect.getH(),rowHeight,i,w;if(subrect.getW()<subrect.getH()){rowHeight=MashableData.common.sumArray(row)/subrect.getW();if(y+rowHeight>=maxY){rowHeight=maxY-y}for(i=0;i<row.length;i++){w=row[i]/rowHeight;if(x+w>maxX||i+1===row.length){w=maxX-x}layout.push([x,y,w,rowHeight]);x=x+w}subrect.setY(y+rowHeight)}else{rowHeight=MashableData.common.sumArray(row)/subrect.getH();if(x+rowHeight>=maxX){rowHeight=maxX-x}for(i=0;i<row.length;i++){w=row[i]/rowHeight;if(y+w>maxY||i+1===row.length){w=maxY-y}layout.push([x,y,rowHeight,w]);y=y+w}subrect.setX(x+rowHeight)}};var buildRow=function(children){var row=[];row.push(children.shift());if(children.length===0){return row}var newRow=row.slice();var w=subrect.getWidth();do{newRow.push(children[0]);if(worst(row,w)>worst(newRow,w)){row=newRow.slice();children.shift()}else{break}}while(children.length>0);return row};var nrSquarify=function(children){do{layoutrow(buildRow(children))}while(children.length>0)};var row=[];var layout=[];var newVals=[];var i;if(rect[2]<=0||rect[3]<=0){for(i=0;i<vals.length;i++){layout.push(rect.slice())}}else{newVals=$.map(vals,function(item){return item*(rect[2]*rect[3])});var subrect=new Subrectangle(rect.slice());nrSquarify(newVals)}return layout};(function(jQuery){if(window.XDomainRequest){jQuery.ajaxTransport(function(s){if(s.crossDomain&&s.async){if(s.timeout){s.xdrTimeout=s.timeout;delete s.timeout}var xdr;return{send:function(_,complete){function callback(status,statusText,responses,responseHeaders){xdr.onload=xdr.onerror=xdr.ontimeout=jQuery.noop;xdr=undefined;complete(status,statusText,responses,responseHeaders)}xdr=new window.XDomainRequest;xdr.onload=function(){callback(200,"OK",{text:xdr.responseText},"Content-Type: "+xdr.contentType)};xdr.onerror=function(){callback(404,"Not Found")};xdr.onprogress=function(){};if(s.xdrTimeout){xdr.ontimeout=function(){callback(0,"timeout")};xdr.timeout=s.xdrTimeout}xdr.open(s.type,s.url,true);xdr.send(s.hasContent&&s.data||null)},abort:function(){if(xdr){xdr.onerror=jQuery.noop();xdr.abort()}}}}})}})(jQuery);if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(find,i){if(i===undefined)i=0;if(i<0)i+=this.length;if(i<0)i=0;for(var n=this.length;i<n;i++)if(i in this&&this[i]===find)return i;return-1}}jQuery.fn.sortElements=function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this){throw new Error("You can't sort elements if any one is a descendant of another.")}parentNode.insertBefore(this,nextSibling);parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}}();window.MashableData.plugin=function(){var $=jQuery,MD=MashableData,grapher=MD.grapher;var plugin_obj={version:"0.5",isMashableDefault:true,iframeLoaded:false,iframeRequested:false,aMsg:[],recentsKey:null,bookmarksKey:null,bookmarks:[],recents:[],series:{},seriesXferCount:0,seriesXfered:0,regDQuotes:/"/g,iframe_load:function(){var mdFrame=document.getElementById("mashabledata_secure_xfer").contentWindow;this.iframe_loaded=true;if(window.addEventListener){window.addEventListener("message",this.receiveReply,false)}else if(window.attachEvent){window.attachEvent("message",this.receiveReply)}for(var i=0;i<MD.plugin.aMsg.length;i++){mdFrame.postMessage(MD.plugin.aMsg[i],"https://www.mashabledata.com/secure_xfer.php")}},receiveReply:function(event){if(event.origin.toLowerCase().indexOf(".mashabledata.com")!=-1)MD.plugin.seriesXfered++;if(MD.plugin.seriesXfered==MD.plugin.seriesXferCount&&MD.plugin.OKToNavigate)MD.plugin.navigate()},calcSeriesInfo:function(PointArray){var oSereiesInfo={firstdt:null,lastdt:null,minValue:null,maxValue:null,period:"A"};var dayOfMonth=null;var dayOfWeek=null;var monthOfYear=null;var timeOfDay=null;var xDateTime,thisPoint;for(var pointIndex in PointArray){thisPoint=PointArray[pointIndex];if(oSereiesInfo.firstdt==null||oSereiesInfo.firstdt>thisPoint.x){oSereiesInfo.firstdt=thisPoint.x}if(oSereiesInfo.lastdt==null||oSereiesInfo.lastdt<thisPoint.x){oSereiesInfo.lastdt=thisPoint.x}if(oSereiesInfo.minValue==null||oSereiesInfo.minValue>thisPoint.y){oSereiesInfo.minValue=thisPoint.y}if(oSereiesInfo.maxValue==null||oSereiesInfo.maxValue<thisPoint.x){oSereiesInfo.maxValue=thisPoint.y}xDateTime=new Date(parseInt(thisPoint.x));if(timeOfDay==null){timeOfDay=xDateTime.getUTCHours()+":"+xDateTime.getUTCMinutes()+":"+xDateTime.getUTCSeconds()+"."+xDateTime.getUTCMilliseconds()}else if(timeOfDay!==true&&timeOfDay!=xDateTime.getUTCHours()+":"+xDateTime.getUTCMinutes()+":"+xDateTime.getUTCSeconds()+"."+xDateTime.getUTCMilliseconds()){timeOfDay=true}if(dayOfMonth==null){dayOfMonth=xDateTime.getUTCDate()}else if(dayOfMonth!==true&&dayOfMonth!=xDateTime.getUTCDate()){dayOfMonth=true}if(dayOfWeek==null){dayOfWeek=xDateTime.getUTCDay()}else if(dayOfWeek!==true&&dayOfWeek!=xDateTime.getUTCDay()){dayOfWeek=true}if(monthOfYear==null){monthOfYear=xDateTime.getUTCMonth()}else if(monthOfYear!==true&&monthOfYear!=xDateTime.getUTCMonth()){monthOfYear=true}}if(timeOfDay===true){oSereiesInfo.period="T"}else if(dayOfWeek!==true){oSereiesInfo.period="W"}else if(dayOfMonth===true){oSereiesInfo.period="D"}else if(monthOfYear===true){oSereiesInfo.period="M"}else{oSereiesInfo.period="A"}return oSereiesInfo},storeChartSeries:function(thisChart){if(window.console&&window.console.time)window.console.time("storeChartSeries");
var i,j,thisSerie,serie,lsKey,recents,bookmarks,idxRecent,idxBookmark,oldSerieString,poppedKey,isMashable;var timestamp=(new Date).getTime();if(localStorage.getItem("md_authorized")=="N")return false;var title=thisChart.options.title?thisChart.options.title.text||"":"";recents=JSON.parse(localStorage.md_recents||"[]");bookmarks=JSON.parse(localStorage.md_bookmarks||"[]");for(i=0;i<thisChart.series.length;i++){thisSerie=thisChart.series[i];if(thisSerie.xAxis.options.type=="datetime"){if(typeof thisSerie.options.isMashable!="undefined"){isMashable=thisSerie.options.isMashable}else{if(typeof thisChart.options.isMashable!="undefined"){isMashable=thisChart.options.isMashable}else{isMashable=this.isMashableDefault}}if(isMashable&&(thisSerie.name||thisChart.title&&thisChart.title.text&&thisChart.series.length==1)){serie=MD.plugin.calcSeriesInfo(thisSerie.data);serie.data=[];for(j=0;j<thisSerie.data.length;j++){serie.data.push([thisSerie.data[j].x,thisSerie.data[j].y])}serie.name=thisSerie.fullName||(thisSerie.name?title.length>0&&thisSerie.name.indexOf(title)==-1?title+": "+thisSerie.name:thisSerie.name:title);serie.description=thisSerie.description;serie.skey=thisSerie.skey;serie.graph=thisChart.options.title&&thisChart.options.title.text?thisChart.options.title.text:"";serie.credit=thisChart.options.credits&&thisChart.options.credits.text?thisChart.options.credits.text:null;serie.url=window.location.href;serie.units=thisSerie.units||(thisSerie.yAxis.options.title?thisSerie.yAxis.options.title.text||"":"");serie.savedt=timestamp;lsKey=serie.skey||serie.name+"|"+serie.units+"|"+serie.period;if(!serie.skey)serie.md_key=lsKey;thisSerie.options.md_key=lsKey;idxRecent=recents.indexOf(lsKey);idxBookmark=bookmarks.indexOf(lsKey);if(idxBookmark>0){thisSerie.bookmark=(new Date).getTime();bookmarks.splice(idxBookmark,1);bookmarks.unshift(lsKey)}if(idxRecent>=0)recents.splice(idxRecent,1);recents.unshift(lsKey);if(idxBookmark!=-1){oldSerieString=localStorage.getItem(lsKey);if(oldSerieString){serie.bookmark=JSON.parse(oldSerieString).bookmark}}localStorage.setItem(lsKey,JSON.stringify(serie))}}}while(recents.length>99){poppedKey=recents.pop();if(bookmarks.indexOf(poppedKey)==-1)localStorage.removeItem(poppedKey)}localStorage.md_recents=JSON.stringify(recents);localStorage.md_bookmarks=JSON.stringify(bookmarks);if(window.console&&window.console.time)window.console.timeEnd("storeChartSeries")},postSeries:function(serie){if(!this.iframeRequested){jQuery("body").append('<div id="md_frame_holder" style="display:none"><iframe id="mashabledata_secure_xfer" onload="MashableData.plugin.iframe_load()" src="https://www.mashabledata.com/secure_xfer.php"></iframe></div>');this.iframeRequested=true}if(this.iframe_loaded){var mdFrame=document.getElementById("mashabledata_secure_xfer").contentWindow;mdFrame.postMessage(JSON.stringify(serie),"https://www.mashabledata.com/secure_xfer.php")}else{this.aMsg.push(JSON.stringify(serie))}},navigate:function(){window.location.href="../workbench"},loadAllSeries:function(){var i;if(this.recentsKey!=localStorage.md_recents){this.recentsKey=localStorage.md_recents;this.recents=JSON.parse(this.recentsKey);for(i=0;i<this.recents.length;i++){if(!this.series[this.recents[i]])this.series[this.recents[i]]=JSON.parse(localStorage.getItem(this.recents[i]))}}if(this.bookmarksKey!=localStorage.md_bookmarks){this.bookmarksKey=localStorage.md_bookmarks;this.bookmarks=JSON.parse(this.bookmarksKey);for(i=0;i<this.bookmarks.length;i++){if(!this.series[this.bookmarks[i]]){this.series[this.bookmarks[i]]=JSON.parse(localStorage.getItem(this.bookmarks[i]));this.series[this.bookmarks[i]].name=this.series[this.bookmarks[i]].name.replace(this.regDQuotes,"&quot;");this.series[this.bookmarks[i]].units=this.series[this.bookmarks[i]].units.replace(this.regDQuotes,"&quot;")}}}},bookmarkSeries:function(key){this.series[key].bookmark=(new Date).getTime();this.series[key].isDirty=true;var index=this.bookmarks.indexOf(key);if(index!=-1)this.bookmarks.splice(index,1);this.bookmarks.unshift(key)},unBookmarkSeries:function(key){MD.plugin.bookmarks.splice(MD.plugin.bookmarks.indexOf(key),1);delete this.series[key].bookmark;var index=this.bookmarks.indexOf(key);if(index!=-1)this.bookmarks.splice(index,1);if(this.recents.indexOf(key)==-1){delete this.series[key]}this.series[key].isDirty=true},showPanel:function(chart){jQuery(document).bind("click",closePanel);jQuery("#mashabledata_panel").remove();this.loadAllSeries();this.activeChart=chart;var $panel,self=this,html='<div id="mashabledata_panel">'+"<h3>Charting Toolbox</h3>"+'<span id="mashabledata_cancel" class="mashabledata_close">close</span>'+(chart.options.exporting&&chart.options.exporting.enable!==false?'<span>Download chart as: <a class="mashabledata_png" data="image/png">PNG</a><a class="mashabledata_jpg" data="image/jpeg">JPG</a><a class="mashabledata_svg" data="image/svg+xml">SVG</a><a class="mashabledata_pdf" data="application/pdf">PDF</a><span id="mashabledata_print" class="mashabledata_print">print chart</span></span>':"")+'<div id="mashabledata_tabs">'+'<ol><li class="mashabledata_active mashabledata_recents"><a data="#mashabledata_recents">recent<span class="mashabledata_info">('+this.recents.length+')</span></a></li><li class="mashabledata_bookmarks"><a data="#mashabledata_bookmarks">bookmarks<span class="mashabledata_info">('+this.bookmarks.length+")</span></a></li></ol>"+'<span><input class="mashabledata_inputmsg mashabledata_filter" value="type here to filter series"></span>'+'<div id="mashabledata_recents">'+'<table><tr><th class="mashabledata_cell_bookmark"></th><th class="mashabledata_cell_check"></th><th class="mashabledata_cell_name">name</th><th class="mashabledata_cell_units">units</th><th class="mashabledata_cell_f">f</th><th class="mashabledata_cell_from">from</th><th class="mashabledata_cell_to">to</th><th class="mashabledata_cell_viewed">viewed<span id="mashabledata_desc"></span></th><th class="mashabledata_cell_url">url</th></tr></table>'+'<div class="mashabledata_scroll"><table>'+this.makeRows(this.recents)+"</table></div>"+"</div>"+'<div id="mashabledata_bookmarks">'+'<table><tr><th class="mashabledata_cell_check"></th><th class="mashabledata_cell_bookmark"></th><th class="mashabledata_cell_name">name</th><th class="mashabledata_cell_units">units</th><th class="mashabledata_cell_f">f</th><th class="mashabledata_cell_from">from</th><th class="mashabledata_cell_to">to</th><th class="mashabledata_cell_viewed">viewed<span id="mashabledata_desc"></span></th><th class="mashabledata_cell_url">url</th></tr></table>'+'<div class="mashabledata_scroll"><table>'+this.makeRows(this.bookmarks)+"</table></div>"+"</div>"+'<span class="mashabledata_these">applies to</span> <span id="mashabledata_check_all">uncheck all</span> '+'<button id="mashabledata_update" value="chart" disabled>update chart</button>'+'<button id="mashabledata_export" value="md">send to MashableData.com *</button>'+'<br><span style="font-size: 9px;margin: 1px 10px;float:right;">* MashableData.com curates millions of statistics and provides visualization tools to create and share interactive maps and graphs</span>'+"</div>"+"</div>";$panel=jQuery(html).prependTo(chart.container);$panel.find("").click(function(){chart.print();closePanel()});$panel.find("a.mashableddata-jpg, a.mashableddata-svg, a.mashableddata-pdf, mashableddata-png").click(function(){var type=jQuery(this).attr("data");if(type=="PNG")chart.exportChart();else chart.exportChart({type:type});closePanel()});$panel.find("input.mashabledata_inputmsg").click(function(){if(jQuery(this).hasClass("mashabledata_inputmsg")){jQuery(this).removeClass("mashabledata_inputmsg").val("").focus()}}).keyup(function(){var table,visible,keyWords=jQuery(this).val();table=$panel.find("#mashabledata_recents div.mashabledata_scroll table");visible=self.searchTable(table,keyWords);$panel.find("li.mashabledata_recents span").html("("+visible+(table[0].rows.length==visible?"":" of "+table[0].rows.length)+")");table=$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table");visible=self.searchTable(table,keyWords);$panel.find("li.mashabledata_bookmarks span").html("("+visible+(table[0].rows.length==visible?"":" of "+table[0].rows.length)+")")});$panel.find("div.mashabledata_scroll table").click(function(evt){var $target=jQuery(evt.target);var $td=$target.closest("td");if($td.hasClass("mashabledata_cell_bookmark")){var key=$td.parent().find("input").attr("data");if(self.series[key]){if(self.series[key].bookmark){self.unBookmarkSeries(key);$panel.find("#mashabledata_bookmarks div.mashabledata_scroll input[data='"+key+"']").closest("tr").remove();$panel.find("#mashabledata_recents div.mashabledata_scroll input[data='"+key+"']").closest("tr").find("td.mashabledata_cell_bookmark span").addClass("mashabledata_nostar").removeClass("mashabledata_star")}else{self.bookmarkSeries(key);$td.find("span").addClass("mashabledata_star").removeClass("mashabledata_nostar");$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table").prepend(self.makeRows([key]))}var $table=$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table");var visible=$table.find("tr:visible").length;$panel.find("li.mashabledata_bookmarks span").html("("+visible+($table[0].rows.length==visible?"":" of "+$table[0].rows.length)+")");updateLocalStorage()}}else{if(!$target.is(":checkbox")){$td.parent().find("input:checkbox").click()}jQuery("#mashabledata_update").removeAttr("disabled");if($panel.find("input:checkbox:checked").length==0){$panel.find("#mashabledata_check_all").innerHTML="uncheck all"}else{$panel.find("#mashabledata_check_all").innerHTML="check all"}}});$panel.find("input:checkbox").change(function(){});$panel.find("td.mashabledata_cell_bookmark span").click(function(){});$panel.find("ol a").click(function(){$panel.find("ol li").removeClass("mashabledata_active");$panel.find("#mashabledata_recents, #mashabledata_bookmarks").hide();$panel.find(jQuery(this).closest("li").addClass("mashabledata_active").end().attr("data")).show()});$panel.find("th").attr("title","click to sort on this column").each(function(){var $th=jQuery(this),thIndex=$th.index(),inverse=false;$th.click(function(){var $table=$th.closest("div").find("div.mashabledata_scroll table");$table.find("td").filter(function(){return jQuery(this).index()===thIndex}).sortElements(function(a,b){if(jQuery.text([a])==jQuery.text([b]))return 0;return jQuery.text([a])>jQuery.text([b])?inverse?-1:1:inverse?1:-1},function(){return this.parentNode});$panel.find(".mashabledata_asc, .mashabledata_desc").remove();$th.append('<span class="'+(inverse?"mashabledata_asc":"mashabledata_desc")+'"></span>');inverse=!inverse})});$panel.find("#mashabledata_check_all").click(function(){if(this.innerHTML=="check all"){$panel.find("div>div:visible input:not(:checked)").each(function(){this.checked=true});this.innerHTML="uncheck all"}else{$panel.find("div>div:visible input:checked").each(function(){this.checked=false});this.innerHTML="check all"}});function getCheckKeys(){var checkedKeys=[],key;$panel.find("table input:checked").each(function(){key=jQuery(this).attr("data");if(checkedKeys.indexOf(key)==-1)checkedKeys.push(key)});return checkedKeys}$panel.find("#mashabledata_update").click(function(){var checkedKeys=getCheckKeys(),series,y;for(var i=0;i<chart.series.length;i++){if(chart.series[i].options.md_key&&checkedKeys.indexOf(chart.series[i].options.md_key)==-1){chart.series[i--].remove(false)}}for(i=0;i<checkedKeys.length;i++){if(!self.hasSeries(checkedKeys[i])){series=self.series[checkedKeys[i]];for(y=0;y<chart.yAxis.length;y++){if((series.units||"values")==chart.yAxis[y].options.title.text)break}if(y==chart.yAxis.length){chart.addAxis({title:{text:series.units||"values"}},false,false)}chart.addSeries({name:series.name,data:series.data,mash:true,md_key:checkedKeys[i],yAxis:y},false)}}for(y=chart.yAxis.length-1;y>=0;y--){if(chart.yAxis[y].series.length==0)chart.yAxis[y].remove(false)}chart.redraw();closePanel()});$panel.find("#mashabledata_export").click(function(){var checkedKeys=getCheckKeys();for(i=0;i<checkedKeys.length;i++){self.seriesXferCount++;self.postSeries(self.series[checkedKeys[i]])}if(self.seriesXferCount==self.seriesXfered)self.navigate();else self.OKToNavigate=true;closePanel()});$panel.find("#mashabledata_cancel").click(function(){closePanel()});function closePanel(evt){if(evt&&jQuery(evt.target).closest("#mashabledata_panel").length==1)return;$panel.remove();jQuery(document).unbind("click",closePanel)}jQuery("#mashabledata_recents th.mashabledata_cell_check").click();function updateLocalStorage(){for(var key in self.series){if(self.series[key].isDirty){if(self.bookmarks.indexOf(key)+self.recents.indexOf(key)==-1){localStorage.removeItem(key)}else{delete self.series[key].isDirty;localStorage.setItem(key,JSON.stringify(self.series[key]))}}}localStorage.md_recents=JSON.stringify(self.recents);localStorage.md_bookmarks=JSON.stringify(self.bookmarks)}},makeRows:function(aryKeys){var i,series,rows="",now=new Date,viewed,inChart;for(i=0;i<aryKeys.length;i++){series=this.series[aryKeys[i]];viewed=new Date(parseInt(series.savedt));inChart=this.hasSeries(aryKeys[i]);rows+='<tr><td class="mashabledata_cell_bookmark"><span class="'+(series.bookmark?"mashabledata_star":"mashabledata_nostar")+'"></span></td>'+'<td class="mashabledata_cell_check"><input type="checkbox" data="'+aryKeys[i]+'"'+(inChart?" checked><span>a"+viewed.getTime()+"</span>":"><span>b"+viewed.getTime()+"</span>")+"</td>"+'<td class="mashabledata_cell_name" title="'+series.name+'">'+series.name+"</td>"+'<td class="mashabledata_cell_units" title="'+series.units+'">'+series.units+"</td>"+'<td class="mashabledata_cell_f">'+series.period+"</td>"+'<td class="mashabledata_cell_from" >'+this.formatDateByPeriod(series.firstdt,series.period)+"</td>"+'<td class="mashabledata_cell_to">'+this.formatDateByPeriod(series.lastdt,series.period)+"</td>"+'<td class="mashabledata_cell_viewed" title="'+viewed.toLocaleString()+'">'+(viewed.toLocaleDateString()==now.toLocaleDateString()?localeHM(viewed):viewed.toLocaleDateString())+"</td>"+'<td class="mashabledata_cell_url" title="'+series.url+'">'+(series.url==window.location.href?inChart?"current chart":"current page":series.url.substr(series.url.substr(8).indexOf("/")).anchor(series.url))+"</td></tr>"}return rows;function localeHM(dt){var localeTime=dt.toLocaleTimeString(),pos=localeTime.lastIndexOf(":");return localeTime.substr(0,pos)+localeTime.substr(pos+3)}},hasSeries:function(md_key){for(var i=0;i<this.activeChart.series.length;i++){if(this.activeChart.series[i].options.md_key==md_key)return true}return false},searchTable:function(table,inputVal){var allCells,searchText,found,regExp,visibleCount=0;regExp=new RegExp(inputVal,"i");table.find("tr").each(function(index,row){searchText=row.cells[2].innerHTML+" "+row.cells[3].innerHTML;found=regExp.test(searchText);if(found==true){jQuery(row).show();visibleCount++}else jQuery(row).hide()});return visibleCount},formatDateByPeriod:function(val,period){if(isNaN(val)==false){var dt=new Date(parseInt(val));switch(period){case"A":return dt.getUTCFullYear();case"Q":return"Q"+parseInt((dt.getUTCMonth()+3)/3)+" "+dt.getUTCFullYear();case"SA":case"M":return dt.toUTCString().substr(8,8);case"W":case"D":return dt.toUTCString().substr(5,11);default:return dt.toUTCString().substr(5,20)}}else{return null}},embed:function embed(div){var $div=$(div);if($div.length==1){var graphcode=$div.attr("data");if(graphcode&&graphcode.length==32&&!/[^a-f0-9]/g.test(graphcode))grapher.createMyGraph(graphcode);else $div.html("The data attribute must be a graphcode")}},popGraph:function(quickGraph){var quickChart=false,quickFlot,quickChartOptions=grapher.makeChartOptionsObject(quickGraph);delete quickChartOptions.chart.height;quickChartOptions.chart.borderWidth=2;quickChartOptions.chart.renderTo="mashabledata_quick-graph";$.fancybox('<div id="mashabledata_quick-graph" style="width:'+window.innerWidth*.75+"px;height:"+window.innerHeight*.75+'px;"></div>',{showCloseButton:true,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:true,onCleanup:function(){if(quickChart){quickChart.destroy()}else{quickFlot.shutdown()}}});if(window.Highcharts){quickChart=new Highcharts.Chart(quickChartOptions)}else{$("<h3>"+quickChartOptions.title.text+" ("+quickChartOptions.yAxis[0].title.text+")</h3>").insertBefore("#mashabledata_quick-graph");$.each(quickChartOptions.series,function(){this.label=this.geoname||this.name});var flotOptions={legend:{show:true,noColumns:1,position:"nw"},xaxis:{mode:"time"},grid:{hoverable:true,clickable:true}};if($("#mashabledata_flottip").length==0)$("<div id='mashabledata_flottip'></div>").css({position:"absolute",display:"none",border:"1px solid #fdd",padding:"2px","background-color":"#fee",opacity:.8,"z-index":1200}).appendTo("body");quickFlot=$.plot("#mashabledata_quick-graph",quickChartOptions.series,flotOptions);$("#mashabledata_quick-graph").bind("plothover",function(event,pos,item){if(item){var x=item.datapoint[0].toFixed(2),y=item.datapoint[1].toFixed(2);$("#mashabledata_flottip").html(item.series.label+":<br>"+y+" "+quickChartOptions.yAxis[0].title.text+" in "+grapher.formatDateByPeriod(y,quickChartOptions.series[0].period)).css({top:item.pageY+5,left:item.pageX+5}).fadeIn(200)}else{$("#mashabledata_flottip").hide()}})}}};return plugin_obj}();jQuery(document).ready(function(){jQuery("div.mashabledata_embed").each(function(){var $this=jQuery(this);MashableData.plugin.embed($this)});if(window.Highcharts){var btnHeight=20;var btnsWidth=24;var btnsX=10;var btnsY=10;var currentTheme=Highcharts.setOptions({});var mashableDataHcTheme={chart:{events:{load:function(){window.MashableData.plugin.storeChartSeries(this)}}},exporting:{buttons:{contextButton:{enabled:true,menuItems:null,onclick:function(){window.MashableData.plugin.showPanel(this)},text:"tools",symbol:"gear",symbolSize:20,symbolStrokeWidth:1}}}};var highchartsOptions=Highcharts.setOptions(mashableDataHcTheme);jQuery.extend(Highcharts.Renderer.prototype.symbols,{gear:function(){var innerR=7;var outterR=9;var offset=13;var teeth=7;var i=0;var angle;gearCommands=["M",offset,offset-outterR];for(i=0;i<teeth;i++){angle=2*Math.PI/teeth*i+2*Math.PI/(teeth*4);gearCommands.push("L");gearCommands.push(Math.sin(angle)*outterR+offset);gearCommands.push(offset-Math.cos(angle)*outterR);gearCommands.push("L");gearCommands.push(Math.sin(angle)*innerR+offset);gearCommands.push(offset-Math.cos(angle)*innerR);angle=2*Math.PI/teeth*i+3*(2*Math.PI/(teeth*4));gearCommands.push("L");gearCommands.push(Math.sin(angle)*innerR+offset);gearCommands.push(offset-Math.cos(angle)*innerR);gearCommands.push("L");gearCommands.push(Math.sin(angle)*outterR+offset);gearCommands.push(offset-Math.cos(angle)*outterR)}gearCommands.push("Z");return gearCommands}})}});