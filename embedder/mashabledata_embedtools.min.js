(function(e){var t={set:{colors:1,values:1,backgroundColor:1,scaleColors:1,normalizeFunction:1,focus:1},get:{selectedRegions:1,selectedMarkers:1,mapObject:1,regionName:1}};e.fn.vectorMap=function(e){var n,r,i,n=this.children(".jvectormap-container").data("mapObject");if(e==="addMap")jvm.WorldMap.maps[arguments[1]]=arguments[2];else{if(!(e!=="set"&&e!=="get"||!t[e][arguments[1]]))return r=arguments[1].charAt(0).toUpperCase()+arguments[1].substr(1),n[e+r].apply(n,Array.prototype.slice.call(arguments,2));e=e||{},e.container=this,n=new jvm.WorldMap(e)}return this}})(jQuery),function(e){function r(t){var n=t||window.event,r=[].slice.call(arguments,1),i=0,s=!0,o=0,u=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(i=n.wheelDelta/120),n.detail&&(i=-n.detail/3),u=i,n.axis!==undefined&&n.axis===n.HORIZONTAL_AXIS&&(u=0,o=-1*i),n.wheelDeltaY!==undefined&&(u=n.wheelDeltaY/120),n.wheelDeltaX!==undefined&&(o=-1*n.wheelDeltaX/120),r.unshift(t,i,o,u),(e.event.dispatch||e.event.handle).apply(this,r)}var t=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var n=t.length;n;)e.event.fixHooks[t[--n]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=t.length;e;)this.addEventListener(t[--e],r,!1);else this.onmousewheel=r},teardown:function(){if(this.removeEventListener)for(var e=t.length;e;)this.removeEventListener(t[--e],r,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery);var jvm={inherits:function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.parentClass=t},mixin:function(e,t){var n;for(n in t.prototype)t.prototype.hasOwnProperty(n)&&(e.prototype[n]=t.prototype[n])},min:function(e){var t=Number.MAX_VALUE,n;if(e instanceof Array)for(n=0;n<e.length;n++)e[n]<t&&(t=e[n]);else for(n in e)e[n]<t&&(t=e[n]);return t},max:function(e){var t=Number.MIN_VALUE,n;if(e instanceof Array)for(n=0;n<e.length;n++)e[n]>t&&(t=e[n]);else for(n in e)e[n]>t&&(t=e[n]);return t},keys:function(e){var t=[],n;for(n in e)t.push(n);return t},values:function(e){var t=[],n,r;for(r=0;r<arguments.length;r++){e=arguments[r];for(n in e)t.push(e[n])}return t}};jvm.$=jQuery,jvm.AbstractElement=function(e,t){this.node=this.createElement(e),this.name=e,this.properties={},t&&this.set(t)},jvm.AbstractElement.prototype.set=function(e,t){var n;if(typeof e=="object")for(n in e)this.properties[n]=e[n],this.applyAttr(n,e[n]);else this.properties[e]=t,this.applyAttr(e,t)},jvm.AbstractElement.prototype.get=function(e){return this.properties[e]},jvm.AbstractElement.prototype.applyAttr=function(e,t){this.node.setAttribute(e,t)},jvm.AbstractElement.prototype.remove=function(){jvm.$(this.node).remove()},jvm.AbstractCanvasElement=function(e,t,n){this.container=e,this.setSize(t,n),this.rootElement=new jvm[this.classPrefix+"GroupElement"],this.node.appendChild(this.rootElement.node),this.container.appendChild(this.node)},jvm.AbstractCanvasElement.prototype.add=function(e,t){t=t||this.rootElement,t.add(e),e.canvas=this},jvm.AbstractCanvasElement.prototype.addPath=function(e,t,n){var r=new jvm[this.classPrefix+"PathElement"](e,t);return this.add(r,n),r},jvm.AbstractCanvasElement.prototype.addCircle=function(e,t,n){var r=new jvm[this.classPrefix+"CircleElement"](e,t);return this.add(r,n),r},jvm.AbstractCanvasElement.prototype.addGroup=function(e){var t=new jvm[this.classPrefix+"GroupElement"];return e?e.node.appendChild(t.node):this.node.appendChild(t.node),t.canvas=this,t},jvm.AbstractShapeElement=function(e,t,n){this.style=n||{},this.style.current={},this.isHovered=!1,this.isSelected=!1,this.updateStyle()},jvm.AbstractShapeElement.prototype.setHovered=function(e){this.isHovered!==e&&(this.isHovered=e,this.updateStyle())},jvm.AbstractShapeElement.prototype.setSelected=function(e){this.isSelected!==e&&(this.isSelected=e,this.updateStyle(),jvm.$(this.node).trigger("selected",[e]))},jvm.AbstractShapeElement.prototype.setStyle=function(e,t){var n={};typeof e=="object"?n=e:n[e]=t,jvm.$.extend(this.style.current,n),this.updateStyle()},jvm.AbstractShapeElement.prototype.updateStyle=function(){var e={};jvm.AbstractShapeElement.mergeStyles(e,this.style.initial),jvm.AbstractShapeElement.mergeStyles(e,this.style.current),this.isHovered&&jvm.AbstractShapeElement.mergeStyles(e,this.style.hover),this.isSelected&&(jvm.AbstractShapeElement.mergeStyles(e,this.style.selected),this.isHovered&&jvm.AbstractShapeElement.mergeStyles(e,this.style.selectedHover)),this.set(e)},jvm.AbstractShapeElement.mergeStyles=function(e,t){var n;t=t||{};for(n in t)t[n]===null?delete e[n]:e[n]=t[n]},jvm.SVGElement=function(e,t){jvm.SVGElement.parentClass.apply(this,arguments)},jvm.inherits(jvm.SVGElement,jvm.AbstractElement),jvm.SVGElement.svgns="http://www.w3.org/2000/svg",jvm.SVGElement.prototype.createElement=function(e){return document.createElementNS(jvm.SVGElement.svgns,e)},jvm.SVGElement.prototype.addClass=function(e){this.node.setAttribute("class",e)},jvm.SVGElement.prototype.getElementCtr=function(e){return jvm["SVG"+e]},jvm.SVGElement.prototype.getBBox=function(){return this.node.getBBox()},jvm.SVGGroupElement=function(){jvm.SVGGroupElement.parentClass.call(this,"g")},jvm.inherits(jvm.SVGGroupElement,jvm.SVGElement),jvm.SVGGroupElement.prototype.add=function(e){this.node.appendChild(e.node)},jvm.SVGCanvasElement=function(e,t,n){this.classPrefix="SVG",jvm.SVGCanvasElement.parentClass.call(this,"svg"),jvm.AbstractCanvasElement.apply(this,arguments)},jvm.inherits(jvm.SVGCanvasElement,jvm.SVGElement),jvm.mixin(jvm.SVGCanvasElement,jvm.AbstractCanvasElement),jvm.SVGCanvasElement.prototype.setSize=function(e,t){this.width=e,this.height=t,this.node.setAttribute("width",e),this.node.setAttribute("height",t)},jvm.SVGCanvasElement.prototype.applyTransformParams=function(e,t,n){this.scale=e,this.transX=t,this.transY=n,this.rootElement.node.setAttribute("transform","scale("+e+") translate("+t+", "+n+")")},jvm.SVGShapeElement=function(e,t,n){jvm.SVGShapeElement.parentClass.call(this,e,t),jvm.AbstractShapeElement.apply(this,arguments)},jvm.inherits(jvm.SVGShapeElement,jvm.SVGElement),jvm.mixin(jvm.SVGShapeElement,jvm.AbstractShapeElement),jvm.SVGPathElement=function(e,t){jvm.SVGPathElement.parentClass.call(this,"path",e,t),this.node.setAttribute("fill-rule","evenodd")},jvm.inherits(jvm.SVGPathElement,jvm.SVGShapeElement),jvm.SVGCircleElement=function(e,t){jvm.SVGCircleElement.parentClass.call(this,"circle",e,t)},jvm.inherits(jvm.SVGCircleElement,jvm.SVGShapeElement),jvm.VMLElement=function(e,t){jvm.VMLElement.VMLInitialized||jvm.VMLElement.initializeVML(),jvm.VMLElement.parentClass.apply(this,arguments)},jvm.inherits(jvm.VMLElement,jvm.AbstractElement),jvm.VMLElement.VMLInitialized=!1,jvm.VMLElement.initializeVML=function(){try{document.namespaces.rvml||document.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),jvm.VMLElement.prototype.createElement=function(e){return document.createElement("<rvml:"+e+' class="rvml">')}}catch(e){jvm.VMLElement.prototype.createElement=function(e){return document.createElement("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}document.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)"),jvm.VMLElement.VMLInitialized=!0},jvm.VMLElement.prototype.getElementCtr=function(e){return jvm["VML"+e]},jvm.VMLElement.prototype.addClass=function(e){jvm.$(this.node).addClass(e)},jvm.VMLElement.prototype.applyAttr=function(e,t){this.node[e]=t},jvm.VMLElement.prototype.getBBox=function(){var e=jvm.$(this.node);return{x:e.position().left/this.canvas.scale,y:e.position().top/this.canvas.scale,width:e.width()/this.canvas.scale,height:e.height()/this.canvas.scale}},jvm.VMLGroupElement=function(){jvm.VMLGroupElement.parentClass.call(this,"group"),this.node.style.left="0px",this.node.style.top="0px",this.node.coordorigin="0 0"},jvm.inherits(jvm.VMLGroupElement,jvm.VMLElement),jvm.VMLGroupElement.prototype.add=function(e){this.node.appendChild(e.node)},jvm.VMLCanvasElement=function(e,t,n){this.classPrefix="VML",jvm.VMLCanvasElement.parentClass.call(this,"group"),jvm.AbstractCanvasElement.apply(this,arguments),this.node.style.position="absolute"},jvm.inherits(jvm.VMLCanvasElement,jvm.VMLElement),jvm.mixin(jvm.VMLCanvasElement,jvm.AbstractCanvasElement),jvm.VMLCanvasElement.prototype.setSize=function(e,t){var n,r,i,s;this.width=e,this.height=t,this.node.style.width=e+"px",this.node.style.height=t+"px",this.node.coordsize=e+" "+t,this.node.coordorigin="0 0";if(this.rootElement){n=this.rootElement.node.getElementsByTagName("shape");for(i=0,s=n.length;i<s;i++)n[i].coordsize=e+" "+t,n[i].style.width=e+"px",n[i].style.height=t+"px";r=this.node.getElementsByTagName("group");for(i=0,s=r.length;i<s;i++)r[i].coordsize=e+" "+t,r[i].style.width=e+"px",r[i].style.height=t+"px"}},jvm.VMLCanvasElement.prototype.applyTransformParams=function(e,t,n){this.scale=e,this.transX=t,this.transY=n,this.rootElement.node.coordorigin=this.width-t-this.width/100+","+(this.height-n-this.height/100),this.rootElement.node.coordsize=this.width/e+","+this.height/e},jvm.VMLShapeElement=function(e,t){jvm.VMLShapeElement.parentClass.call(this,e,t),this.fillElement=new jvm.VMLElement("fill"),this.strokeElement=new jvm.VMLElement("stroke"),this.node.appendChild(this.fillElement.node),this.node.appendChild(this.strokeElement.node),this.node.stroked=!1,jvm.AbstractShapeElement.apply(this,arguments)},jvm.inherits(jvm.VMLShapeElement,jvm.VMLElement),jvm.mixin(jvm.VMLShapeElement,jvm.AbstractShapeElement),jvm.VMLShapeElement.prototype.applyAttr=function(e,t){switch(e){case"fill":this.node.fillcolor=t;break;case"fill-opacity":this.fillElement.node.opacity=Math.round(t*100)+"%";break;case"stroke":t==="none"?this.node.stroked=!1:this.node.stroked=!0,this.node.strokecolor=t;break;case"stroke-opacity":this.strokeElement.node.opacity=Math.round(t*100)+"%";break;case"stroke-width":parseInt(t,10)===0?this.node.stroked=!1:this.node.stroked=!0,this.node.strokeweight=t;break;case"d":this.node.path=jvm.VMLPathElement.pathSvgToVml(t);break;default:jvm.VMLShapeElement.parentClass.prototype.applyAttr.apply(this,arguments)}},jvm.VMLPathElement=function(e,t){var n=new jvm.VMLElement("skew");jvm.VMLPathElement.parentClass.call(this,"shape",e,t),this.node.coordorigin="0 0",n.node.on=!0,n.node.matrix="0.01,0,0,0.01,0,0",n.node.offset="0,0",this.node.appendChild(n.node)},jvm.inherits(jvm.VMLPathElement,jvm.VMLShapeElement),jvm.VMLPathElement.prototype.applyAttr=function(e,t){e==="d"?this.node.path=jvm.VMLPathElement.pathSvgToVml(t):jvm.VMLShapeElement.prototype.applyAttr.call(this,e,t)},jvm.VMLPathElement.pathSvgToVml=function(e){var t="",n=0,r=0,i,s;return e=e.replace(/(-?\d+)e(-?\d+)/g,"0"),e.replace(/([MmLlHhVvCcSs])\s*((?:-?\d*(?:\.\d+)?\s*,?\s*)+)/g,function(e,t,o,u){o=o.replace(/(\d)-/g,"$1,-").replace(/^\s+/g,"").replace(/\s+$/g,"").replace(/\s+/g,",").split(","),o[0]||o.shift();for(var a=0,f=o.length;a<f;a++)o[a]=Math.round(100*o[a]);switch(t){case"m":return n+=o[0],r+=o[1],"t"+o.join(",");case"M":return n=o[0],r=o[1],"m"+o.join(",");case"l":return n+=o[0],r+=o[1],"r"+o.join(",");case"L":return n=o[0],r=o[1],"l"+o.join(",");case"h":return n+=o[0],"r"+o[0]+",0";case"H":return n=o[0],"l"+n+","+r;case"v":return r+=o[0],"r0,"+o[0];case"V":return r=o[0],"l"+n+","+r;case"c":return i=n+o[o.length-4],s=r+o[o.length-3],n+=o[o.length-2],r+=o[o.length-1],"v"+o.join(",");case"C":return i=o[o.length-4],s=o[o.length-3],n=o[o.length-2],r=o[o.length-1],"c"+o.join(",");case"s":return o.unshift(r-s),o.unshift(n-i),i=n+o[o.length-4],s=r+o[o.length-3],n+=o[o.length-2],r+=o[o.length-1],"v"+o.join(",");case"S":return o.unshift(r+r-s),o.unshift(n+n-i),i=o[o.length-4],s=o[o.length-3],n=o[o.length-2],r=o[o.length-1],"c"+o.join(",")}return""}).replace(/z/g,"e")},jvm.VMLCircleElement=function(e,t){jvm.VMLCircleElement.parentClass.call(this,"oval",e,t)},jvm.inherits(jvm.VMLCircleElement,jvm.VMLShapeElement),jvm.VMLCircleElement.prototype.applyAttr=function(e,t){switch(e){case"r":this.node.style.width=t*2+"px",this.node.style.height=t*2+"px",this.applyAttr("cx",this.get("cx")||0),this.applyAttr("cy",this.get("cy")||0);break;case"cx":if(!t)return;this.node.style.left=t-(this.get("r")||0)+"px";break;case"cy":if(!t)return;this.node.style.top=t-(this.get("r")||0)+"px";break;default:jvm.VMLCircleElement.parentClass.prototype.applyAttr.call(this,e,t)}},jvm.VectorCanvas=function(e,t,n){return this.mode=window.SVGAngle?"svg":"vml",this.mode=="svg"?this.impl=new jvm.SVGCanvasElement(e,t,n):this.impl=new jvm.VMLCanvasElement(e,t,n),this.impl},jvm.SimpleScale=function(e){this.scale=e},jvm.SimpleScale.prototype.getValue=function(e){return e},jvm.OrdinalScale=function(e){this.scale=e},jvm.OrdinalScale.prototype.getValue=function(e){return this.scale[e]},jvm.NumericScale=function(e,t,n,r){this.scale=[],t=t||"linear",e&&this.setScale(e),t&&this.setNormalizeFunction(t),n&&this.setMin(n),r&&this.setMax(r)},jvm.NumericScale.prototype={setMin:function(e){this.clearMinValue=e,typeof this.normalize=="function"?this.minValue=this.normalize(e):this.minValue=e},setMax:function(e){this.clearMaxValue=e,typeof this.normalize=="function"?this.maxValue=this.normalize(e):this.maxValue=e},setScale:function(e){var t;for(t=0;t<e.length;t++)this.scale[t]=[e[t]]},setNormalizeFunction:function(e){e==="polynomial"?this.normalize=function(e){return Math.pow(e,.2)}:e==="linear"?delete this.normalize:this.normalize=e,this.setMin(this.clearMinValue),this.setMax(this.clearMaxValue)},getValue:function(e){var t=[],n=0,r,i=0,s;typeof this.normalize=="function"&&(e=this.normalize(e));for(i=0;i<this.scale.length-1;i++)r=this.vectorLength(this.vectorSubtract(this.scale[i+1],this.scale[i])),t.push(r),n+=r;s=(this.maxValue-this.minValue)/n;for(i=0;i<t.length;i++)t[i]*=s;i=0,e-=this.minValue;while(e-t[i]>=0)e-=t[i],i++;return i==this.scale.length-1?e=this.vectorToNum(this.scale[i]):e=this.vectorToNum(this.vectorAdd(this.scale[i],this.vectorMult(this.vectorSubtract(this.scale[i+1],this.scale[i]),e/t[i]))),e},vectorToNum:function(e){var t=0,n;for(n=0;n<e.length;n++)t+=Math.round(e[n])*Math.pow(256,e.length-n-1);return t},vectorSubtract:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]-t[r];return n},vectorAdd:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]+t[r];return n},vectorMult:function(e,t){var n=[],r;for(r=0;r<e.length;r++)n[r]=e[r]*t;return n},vectorLength:function(e){var t=0,n;for(n=0;n<e.length;n++)t+=e[n]*e[n];return Math.sqrt(t)}},jvm.ColorScale=function(e,t,n,r){jvm.ColorScale.parentClass.apply(this,arguments)},jvm.inherits(jvm.ColorScale,jvm.NumericScale),jvm.ColorScale.prototype.setScale=function(e){var t;for(t=0;t<e.length;t++)this.scale[t]=jvm.ColorScale.rgbToArray(e[t])},jvm.ColorScale.prototype.getValue=function(e){return jvm.ColorScale.numToRgb(jvm.ColorScale.parentClass.prototype.getValue.call(this,e))},jvm.ColorScale.arrayToRgb=function(e){var t="#",n,r;for(r=0;r<e.length;r++)n=e[r].toString(16),t+=n.length==1?"0"+n:n;return t},jvm.ColorScale.numToRgb=function(e){e=e.toString(16);while(e.length<6)e="0"+e;return"#"+e},jvm.ColorScale.rgbToArray=function(e){return e=e.substr(1),[parseInt(e.substr(0,2),16),parseInt(e.substr(2,2),16),parseInt(e.substr(4,2),16)]},jvm.DataSeries=function(e,t){var n;e=e||{},e.attribute=e.attribute||"fill",this.elements=t,this.params=e,e.attributes&&this.setAttributes(e.attributes),jvm.$.isArray(e.scale)?(n=e.attribute==="fill"||e.attribute==="stroke"?jvm.ColorScale:jvm.NumericScale,this.scale=new n(e.scale,e.normalizeFunction,e.min,e.max)):e.scale?this.scale=new jvm.OrdinalScale(e.scale):this.scale=new jvm.SimpleScale(e.scale),this.values=e.values||{},this.setValues(this.values)},jvm.DataSeries.prototype={setAttributes:function(e,t){var n=e,r;if(typeof e=="string")this.elements[e]&&this.elements[e].setStyle(this.params.attribute,t);else for(r in n)this.elements[r]&&this.elements[r].element.setStyle(this.params.attribute,n[r])},setValues:function(e){var t=Number.MIN_VALUE,n=Number.MAX_VALUE,r,i,s={};if(this.scale instanceof jvm.OrdinalScale||this.scale instanceof jvm.SimpleScale)for(i in e)e[i]?s[i]=this.scale.getValue(e[i]):s[i]=this.elements[i].element.style.initial[this.params.attribute];else{if(!this.params.min||!this.params.max){for(i in e)r=parseFloat(e[i]),r>t&&(t=e[i]),r<n&&(n=r);this.params.min||this.scale.setMin(n),this.params.max||this.scale.setMax(t),this.params.min=n,this.params.max=t}for(i in e)r=parseFloat(e[i]),isNaN(r)?s[i]=this.elements[i].element.style.initial[this.params.attribute]:s[i]=this.scale.getValue(r)}this.setAttributes(s),jvm.$.extend(this.values,e)},clear:function(){var e,t={};for(e in this.values)this.elements[e]&&(t[e]=this.elements[e].element.style.initial[this.params.attribute]);this.setAttributes(t),this.values={}},setScale:function(e){this.scale.setScale(e),this.values&&this.setValues(this.values)},setNormalizeFunction:function(e){this.scale.setNormalizeFunction(e),this.values&&this.setValues(this.values)}},jvm.Proj={degRad:180/Math.PI,radDeg:Math.PI/180,radius:6381372,sgn:function(e){return e>0?1:e<0?-1:e},mill:function(e,t,n){return{x:this.radius*(t-n)*this.radDeg,y:-this.radius*Math.log(Math.tan((45+.4*e)*this.radDeg))/.8}},mill_inv:function(e,t,n){return{lat:(2.5*Math.atan(Math.exp(.8*t/this.radius))-5*Math.PI/8)*this.degRad,lng:(n*this.radDeg+e/this.radius)*this.degRad}},merc:function(e,t,n){return{x:this.radius*(t-n)*this.radDeg,y:-this.radius*Math.log(Math.tan(Math.PI/4+e*Math.PI/360))}},merc_inv:function(e,t,n){return{lat:(2*Math.atan(Math.exp(t/this.radius))-Math.PI/2)*this.degRad,lng:(n*this.radDeg+e/this.radius)*this.degRad}},aea:function(e,t,n){var r=0,i=n*this.radDeg,s=29.5*this.radDeg,o=45.5*this.radDeg,u=e*this.radDeg,a=t*this.radDeg,f=(Math.sin(s)+Math.sin(o))/2,l=Math.cos(s)*Math.cos(s)+2*f*Math.sin(s),c=f*(a-i),h=Math.sqrt(l-2*f*Math.sin(u))/f,p=Math.sqrt(l-2*f*Math.sin(r))/f;return{x:h*Math.sin(c)*this.radius,y:-(p-h*Math.cos(c))*this.radius}},aea_inv:function(e,t,n){var r=e/this.radius,i=t/this.radius,s=0,o=n*this.radDeg,u=29.5*this.radDeg,a=45.5*this.radDeg,f=(Math.sin(u)+Math.sin(a))/2,l=Math.cos(u)*Math.cos(u)+2*f*Math.sin(u),c=Math.sqrt(l-2*f*Math.sin(s))/f,h=Math.sqrt(r*r+(c-i)*(c-i)),p=Math.atan(r/(c-i));return{lat:Math.asin((l-h*h*f*f)/(2*f))*this.degRad,lng:(o+p/f)*this.degRad}},lcc:function(e,t,n){var r=0,i=n*this.radDeg,s=t*this.radDeg,o=33*this.radDeg,u=45*this.radDeg,a=e*this.radDeg,f=Math.log(Math.cos(o)*(1/Math.cos(u)))/Math.log(Math.tan(Math.PI/4+u/2)*(1/Math.tan(Math.PI/4+o/2))),l=Math.cos(o)*Math.pow(Math.tan(Math.PI/4+o/2),f)/f,c=l*Math.pow(1/Math.tan(Math.PI/4+a/2),f),h=l*Math.pow(1/Math.tan(Math.PI/4+r/2),f);return{x:c*Math.sin(f*(s-i))*this.radius,y:-(h-c*Math.cos(f*(s-i)))*this.radius}},lcc_inv:function(e,t,n){var r=e/this.radius,i=t/this.radius,s=0,o=n*this.radDeg,u=33*this.radDeg,a=45*this.radDeg,f=Math.log(Math.cos(u)*(1/Math.cos(a)))/Math.log(Math.tan(Math.PI/4+a/2)*(1/Math.tan(Math.PI/4+u/2))),l=Math.cos(u)*Math.pow(Math.tan(Math.PI/4+u/2),f)/f,c=l*Math.pow(1/Math.tan(Math.PI/4+s/2),f),h=this.sgn(f)*Math.sqrt(r*r+(c-i)*(c-i)),p=Math.atan(r/(c-i));return{lat:(2*Math.atan(Math.pow(l/h,1/f))-Math.PI/2)*this.degRad,lng:(o+p/f)*this.degRad}}},jvm.WorldMap=function(e){var t=this,n;this.params=jvm.$.extend(!0,{},jvm.WorldMap.defaultParams,e);if(!jvm.WorldMap.maps[this.params.map])throw new Error("Attempt to use map which was not loaded: "+this.params.map);this.mapData=jvm.WorldMap.maps[this.params.map],this.markers={},this.regions={},this.regionsColors={},this.regionsData={},this.container=jvm.$("<div>").css({width:"100%",height:"100%"}).addClass("jvectormap-container"),this.params.container.append(this.container),this.container.data("mapObject",this),this.container.css({position:"relative",overflow:"hidden"}),this.defaultWidth=this.mapData.width,this.defaultHeight=this.mapData.height,this.setBackgroundColor(this.params.backgroundColor),this.onResize=function(){t.setSize()},jvm.$(window).resize(this.onResize);for(n in jvm.WorldMap.apiEvents)this.params[n]&&this.container.bind(jvm.WorldMap.apiEvents[n]+".jvectormap",this.params[n]);this.canvas=new jvm.VectorCanvas(this.container[0],this.width,this.height),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?this.params.bindTouchEvents&&this.bindContainerTouchEvents():this.bindContainerEvents(),this.bindElementEvents(),this.createLabel(),this.params.zoomButtons&&this.bindZoomButtons(),this.createRegions(),this.createMarkers(this.params.markers||{}),this.setSize(),this.params.focusOn&&(typeof this.params.focusOn=="object"?this.setFocus.call(this,this.params.focusOn.scale,this.params.focusOn.x,this.params.focusOn.y):this.setFocus.call(this,this.params.focusOn)),this.params.selectedRegions&&this.setSelectedRegions(this.params.selectedRegions),this.params.selectedMarkers&&this.setSelectedMarkers(this.params.selectedMarkers),this.params.series&&this.createSeries()},jvm.WorldMap.prototype={transX:0,transY:0,scale:1,baseTransX:0,baseTransY:0,baseScale:1,width:0,height:0,setBackgroundColor:function(e){this.container.css("background-color",e)},resize:function(){var e=this.baseScale;this.width/this.height>this.defaultWidth/this.defaultHeight?(this.baseScale=this.height/this.defaultHeight,this.baseTransX=Math.abs(this.width-this.defaultWidth*this.baseScale)/(2*this.baseScale)):(this.baseScale=this.width/this.defaultWidth,this.baseTransY=Math.abs(this.height-this.defaultHeight*this.baseScale)/(2*this.baseScale)),this.scale*=this.baseScale/e,this.transX*=this.baseScale/e,this.transY*=this.baseScale/e},setSize:function(){this.width=this.container.width(),this.height=this.container.height(),this.resize(),this.canvas.setSize(this.width,this.height),this.applyTransform()},reset:function(){var e,t;for(e in this.series)for(t=0;t<this.series[e].length;t++)this.series[e][t].clear();this.scale=this.baseScale,this.transX=this.baseTransX,this.transY=this.baseTransY,this.applyTransform()},applyTransform:function(){var e,t,n,r;this.defaultWidth*this.scale<=this.width?(e=(this.width-this.defaultWidth*this.scale)/(2*this.scale),n=(this.width-this.defaultWidth*this.scale)/(2*this.scale)):(e=0,n=(this.width-this.defaultWidth*this.scale)/this.scale),this.defaultHeight*this.scale<=this.height?(t=(this.height-this.defaultHeight*this.scale)/(2*this.scale),r=(this.height-this.defaultHeight*this.scale)/(2*this.scale)):(t=0,r=(this.height-this.defaultHeight*this.scale)/this.scale),this.transY>t?this.transY=t:this.transY<r&&(this.transY=r),this.transX>e?this.transX=e:this.transX<n&&(this.transX=n),this.canvas.applyTransformParams(this.scale,this.transX,this.transY),this.markers&&this.repositionMarkers(),this.container.trigger("viewportChange",[this.scale/this.baseScale,this.transX,this.transY])},bindContainerEvents:function(){var e=!1,t,n,r=this;this.container.mousemove(function(i){return e&&(r.transX-=(t-i.pageX)/r.scale,r.transY-=(n-i.pageY)/r.scale,r.applyTransform(),t=i.pageX,n=i.pageY),!1}).mousedown(function(r){return e=!0,t=r.pageX,n=r.pageY,!1}),jvm.$("body").mouseup(function(){e=!1}),this.params.zoomOnScroll&&this.container.mousewheel(function(e,t,n,i){var s=jvm.$(r.container).offset(),o=e.pageX-s.left,u=e.pageY-s.top,a=Math.pow(1.3,i);r.label.hide(),r.setScale(r.scale*a,o,u),e.preventDefault()})},bindContainerTouchEvents:function(){var e,t,n=this,r,i,s,o,u,a=function(a){var f=a.originalEvent.touches,l,c,h,p;a.type=="touchstart"&&(u=0),f.length==1?(u==1&&(h=n.transX,p=n.transY,n.transX-=(r-f[0].pageX)/n.scale,n.transY-=(i-f[0].pageY)/n.scale,n.applyTransform(),n.label.hide(),(h!=n.transX||p!=n.transY)&&a.preventDefault()),r=f[0].pageX,i=f[0].pageY):f.length==2&&(u==2?(c=Math.sqrt(Math.pow(f[0].pageX-f[1].pageX,2)+Math.pow(f[0].pageY-f[1].pageY,2))/t,n.setScale(e*c,s,o),n.label.hide(),a.preventDefault()):(l=jvm.$(n.container).offset(),f[0].pageX>f[1].pageX?s=f[1].pageX+(f[0].pageX-f[1].pageX)/2:s=f[0].pageX+(f[1].pageX-f[0].pageX)/2,f[0].pageY>f[1].pageY?o=f[1].pageY+(f[0].pageY-f[1].pageY)/2:o=f[0].pageY+(f[1].pageY-f[0].pageY)/2,s-=l.left,o-=l.top,e=n.scale,t=Math.sqrt(Math.pow(f[0].pageX-f[1].pageX,2)+Math.pow(f[0].pageY-f[1].pageY,2)))),u=f.length};jvm.$(this.container).bind("touchstart",a),jvm.$(this.container).bind("touchmove",a)},bindElementEvents:function(){var e=this,t;this.container.mousemove(function(){t=!0}),this.container.delegate("[class~='jvectormap-element']","mouseover mouseout",function(t){var n=this,r=jvm.$(this).attr("class").baseVal?jvm.$(this).attr("class").baseVal:jvm.$(this).attr("class"),i=r.indexOf("jvectormap-region")===-1?"marker":"region",s=i=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),o=i=="region"?e.regions[s].element:e.markers[s].element,u=i=="region"?e.mapData.paths[s].name:e.markers[s].config.name||"",a=jvm.$.Event(i+"LabelShow.jvectormap"),f=jvm.$.Event(i+"Over.jvectormap");t.type=="mouseover"?(e.container.trigger(f,[s]),f.isDefaultPrevented()||o.setHovered(!0),e.label.text(u),e.container.trigger(a,[e.label,s]),a.isDefaultPrevented()||(e.label.show(),e.labelWidth=e.label.width(),e.labelHeight=e.label.height())):(o.setHovered(!1),e.label.hide(),e.container.trigger(i+"Out.jvectormap",[s]))}),this.container.delegate("[class~='jvectormap-element']","mousedown",function(e){t=!1}),this.container.delegate("[class~='jvectormap-element']","mouseup",function(n){var r=this,i=jvm.$(this).attr("class").baseVal?jvm.$(this).attr("class").baseVal:jvm.$(this).attr("class"),s=i.indexOf("jvectormap-region")===-1?"marker":"region",o=s=="region"?jvm.$(this).attr("data-code"):jvm.$(this).attr("data-index"),u=jvm.$.Event(s+"Click.jvectormap"),a=s=="region"?e.regions[o].element:e.markers[o].element;if(!t){e.container.trigger(u,[o]);if(s==="region"&&e.params.regionsSelectable||s==="marker"&&e.params.markersSelectable)u.isDefaultPrevented()||(e.params[s+"sSelectableOne"]&&e.clearSelected(s+"s"),a.setSelected(!a.isSelected))}})},bindZoomButtons:function(){var e=this;jvm.$("<div/>").addClass("jvectormap-zoomin").text("+").appendTo(this.container),jvm.$("<div/>").addClass("jvectormap-zoomout").html("&#x2212;").appendTo(this.container),this.container.find(".jvectormap-zoomin").click(function(){e.setScale(e.scale*e.params.zoomStep,e.width/2,e.height/2)}),this.container.find(".jvectormap-zoomout").click(function(){e.setScale(e.scale/e.params.zoomStep,e.width/2,e.height/2)})},createLabel:function(){var e=this;this.label=jvm.$("<div/>").addClass("jvectormap-label").appendTo(jvm.$("body")),this.container.mousemove(function(t){var n=t.pageX-15-e.labelWidth,r=t.pageY-15-e.labelHeight;n<5&&(n=t.pageX+15),r<5&&(r=t.pageY+15),e.label.is(":visible")&&e.label.css({left:n,top:r})})},setScale:function(e,t,n,r){var i,s=jvm.$.Event("zoom.jvectormap");e>this.params.zoomMax*this.baseScale?e=this.params.zoomMax*this.baseScale:e<this.params.zoomMin*this.baseScale&&(e=this.params.zoomMin*this.baseScale),typeof t!="undefined"&&typeof n!="undefined"&&(i=e/this.scale,r?(this.transX=t+this.defaultWidth*(this.width/(this.defaultWidth*e))/2,this.transY=n+this.defaultHeight*(this.height/(this.defaultHeight*e))/2):(this.transX-=(i-1)/e*t,this.transY-=(i-1)/e*n)),this.scale=e,this.applyTransform(),this.container.trigger(s,[e/this.baseScale])},setFocus:function(e,t,n){var r,i,s,o,u;if(jvm.$.isArray(e)||this.regions[e]){jvm.$.isArray(e)?o=e:o=[e];for(u=0;u<o.length;u++)this.regions[o[u]]&&(i=this.regions[o[u]].element.getBBox(),i&&(typeof r=="undefined"?r=i:(s={x:Math.min(r.x,i.x),y:Math.min(r.y,i.y),width:Math.max(r.x+r.width,i.x+i.width)-Math.min(r.x,i.x),height:Math.max(r.y+r.height,i.y+i.height)-Math.min(r.y,i.y)},r=s)));this.setScale(Math.min(this.width/r.width,this.height/r.height),-(r.x+r.width/2),-(r.y+r.height/2),!0)}else e*=this.baseScale,this.setScale(e,-t*this.defaultWidth,-n*this.defaultHeight,!0)},getSelected:function(e){var t,n=[];for(t in this[e])this[e][t].element.isSelected&&n.push(t);return n},getSelectedRegions:function(){return this.getSelected("regions")},getSelectedMarkers:function(){return this.getSelected("markers")},setSelected:function(e,t){var n;typeof t!="object"&&(t=[t]);if(jvm.$.isArray(t))for(n=0;n<t.length;n++)this[e][t[n]].element.setSelected(!0);else for(n in t)this[e][n].element.setSelected(!!t[n])},setSelectedRegions:function(e){this.setSelected("regions",e)},setSelectedMarkers:function(e){this.setSelected("markers",e)},clearSelected:function(e){var t={},n=this.getSelected(e),r;for(r=0;r<n.length;r++)t[n[r]]=!1;this.setSelected(e,t)},clearSelectedRegions:function(){this.clearSelected("regions")},clearSelectedMarkers:function(){this.clearSelected("markers")},getMapObject:function(){return this},getRegionName:function(e){return this.mapData.paths[e].name},createRegions:function(){var e,t,n=this;for(e in this.mapData.paths)t=this.canvas.addPath({d:this.mapData.paths[e].path,"data-code":e},jvm.$.extend(!0,{},this.params.regionStyle)),jvm.$(t.node).bind("selected",function(e,t){n.container.trigger("regionSelected.jvectormap",[jvm.$(this).attr("data-code"),t,n.getSelectedRegions()])}),t.addClass("jvectormap-region jvectormap-element"),this.regions[e]={element:t,config:this.mapData.paths[e]}},createMarkers:function(e){var t,n,r,i,s,o=this;this.markersGroup=this.markersGroup||this.canvas.addGroup();if(jvm.$.isArray(e)){s=e.slice(),e={};for(t=0;t<s.length;t++)e[t]=s[t]}for(t in e)i=e[t]instanceof Array?{latLng:e[t]}:e[t],r=this.getMarkerPosition(i),r!==!1&&(n=this.canvas.addCircle({"data-index":t,cx:r.x,cy:r.y},jvm.$.extend(!0,{},this.params.markerStyle,{initial:i.style||{}}),this.markersGroup),n.addClass("jvectormap-marker jvectormap-element"),jvm.$(n.node).bind("selected",function(e,t){o.container.trigger("markerSelected.jvectormap",[jvm.$(this).attr("data-index"),t,o.getSelectedMarkers()])}),this.markers[t]&&this.removeMarkers([t]),this.markers[t]={element:n,config:i})},repositionMarkers:function(){var e,t;for(e in this.markers)t=this.getMarkerPosition(this.markers[e].config),t!==!1&&this.markers[e].element.setStyle({cx:t.x,cy:t.y})},getMarkerPosition:function(e){return jvm.WorldMap.maps[this.params.map].projection?this.latLngToPoint.apply(this,e.latLng||[0,0]):{x:e.coords[0]*this.scale+this.transX*this.scale,y:e.coords[1]*this.scale+this.transY*this.scale}},addMarker:function(e,t,n){var r={},i=[],s,o,n=n||[];r[e]=t;for(o=0;o<n.length;o++)s={},s[e]=n[o],i.push(s);this.addMarkers(r,i)},addMarkers:function(e,t){var n;t=t||[],this.createMarkers(e);for(n=0;n<t.length;n++)this.series.markers[n].setValues(t[n]||{})},removeMarkers:function(e){var t;for(t=0;t<e.length;t++)this.markers[e[t]].element.remove(),delete this.markers[e[t]]},removeAllMarkers:function(){var e,t=[];for(e in this.markers)t.push(e);this.removeMarkers(t)},latLngToPoint:function(e,t){var n,r=jvm.WorldMap.maps[this.params.map].projection,i=r.centralMeridian,s=this.width-this.baseTransX*2*this.baseScale,o=this.height-this.baseTransY*2*this.baseScale,u,a,f=this.scale/this.baseScale;return t<-180+i&&(t+=360),n=jvm.Proj[r.type](e,t,i),u=this.getInsetForPoint(n.x,n.y),u?(a=u.bbox,n.x=(n.x-a[0].x)/(a[1].x-a[0].x)*u.width*this.scale,n.y=(n.y-a[0].y)/(a[1].y-a[0].y)*u.height*this.scale,{x:n.x+this.transX*this.scale+u.left*this.scale,y:n.y+this.transY*this.scale+u.top*this.scale}):!1},pointToLatLng:function(e,t){var n=jvm.WorldMap.maps[this.params.map].projection,r=n.centralMeridian,i=jvm.WorldMap.maps[this.params.map].insets,s,o,u,a,f;for(s=0;s<i.length;s++){o=i[s],u=o.bbox,a=e-(this.transX*this.scale+o.left*this.scale),f=t-(this.transY*this.scale+o.top*this.scale),a=a/(o.width*this.scale)*(u[1].x-u[0].x)+u[0].x,f=f/(o.height*this.scale)*(u[1].y-u[0].y)+u[0].y;if(a>u[0].x&&a<u[1].x&&f>u[0].y&&f<u[1].y)return jvm.Proj[n.type+"_inv"](a,-f,r)}return!1},getInsetForPoint:function(e,t){var n=jvm.WorldMap.maps[this.params.map].insets,r,i;for(r=0;r<n.length;r++){i=n[r].bbox;if(e>i[0].x&&e<i[1].x&&t>i[0].y&&t<i[1].y)return n[r]}},createSeries:function(){var e,t;this.series={markers:[],regions:[]};
for(t in this.params.series)for(e=0;e<this.params.series[t].length;e++)this.series[t][e]=new jvm.DataSeries(this.params.series[t][e],this[t])},remove:function(){this.label.remove(),this.container.remove(),jvm.$(window).unbind("resize",this.onResize)}},jvm.WorldMap.maps={},jvm.WorldMap.defaultParams={map:"world_mill_en",backgroundColor:"#505050",zoomButtons:!0,zoomOnScroll:!0,zoomMax:8,zoomMin:1,zoomStep:1.6,regionsSelectable:!1,markersSelectable:!1,bindTouchEvents:!0,regionStyle:{initial:{fill:"white","fill-opacity":1,stroke:"none","stroke-width":0,"stroke-opacity":1},hover:{"fill-opacity":.8},selected:{fill:"yellow"},selectedHover:{}},markerStyle:{initial:{fill:"grey",stroke:"#505050","fill-opacity":1,"stroke-width":1,"stroke-opacity":1,r:5},hover:{stroke:"black","stroke-width":2},selected:{fill:"blue"},selectedHover:{}}},jvm.WorldMap.apiEvents={onRegionLabelShow:"regionLabelShow",onRegionOver:"regionOver",onRegionOut:"regionOut",onRegionClick:"regionClick",onRegionSelected:"regionSelected",onMarkerLabelShow:"markerLabelShow",onMarkerOver:"markerOver",onMarkerOut:"markerOut",onMarkerClick:"markerClick",onMarkerSelected:"markerSelected",onViewportChange:"viewportChange"};(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{factory(jQuery)}})(function($){"use strict";var UNSET_OPTION={},getDefaults,createClass,SPFormat,clipval,quartile,normalizeValue,normalizeValues,remove,isNumber,all,sum,addCSS,ensureArray,formatNumber,RangeMap,MouseHandler,Tooltip,barHighlightMixin,line,bar,tristate,discrete,bullet,pie,box,defaultStyles,initStyles,VShape,VCanvas_base,VCanvas_canvas,VCanvas_vml,pending,shapeCount=0;getDefaults=function(){return{common:{type:"line",lineColor:"#00f",fillColor:"#cdf",defaultPixelsPerValue:3,width:"auto",height:"auto",composite:false,tagValuesAttribute:"values",tagOptionsPrefix:"spark",enableTagOptions:false,enableHighlight:true,highlightLighten:1.4,tooltipSkipNull:true,tooltipPrefix:"",tooltipSuffix:"",disableHiddenCheck:false,numberFormatter:false,numberDigitGroupCount:3,numberDigitGroupSep:",",numberDecimalMark:".",disableTooltips:false,disableInteraction:false},line:{spotColor:"#f80",highlightSpotColor:"#5f5",highlightLineColor:"#f22",spotRadius:1.5,minSpotColor:"#f80",maxSpotColor:"#f80",lineWidth:1,normalRangeMin:undefined,normalRangeMax:undefined,normalRangeColor:"#ccc",drawNormalOnTop:false,chartRangeMin:undefined,chartRangeMax:undefined,chartRangeMinX:undefined,chartRangeMaxX:undefined,tooltipFormat:new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{y}}{{suffix}}')},bar:{barColor:"#3366cc",negBarColor:"#f44",stackedBarColor:["#3366cc","#dc3912","#ff9900","#109618","#66aa00","#dd4477","#0099c6","#990099"],zeroColor:undefined,nullColor:undefined,zeroAxis:true,barWidth:4,barSpacing:1,chartRangeMax:undefined,chartRangeMin:undefined,chartRangeClip:false,colorMap:undefined,tooltipFormat:new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{value}}{{suffix}}')},tristate:{barWidth:4,barSpacing:1,posBarColor:"#6f6",negBarColor:"#f44",zeroBarColor:"#999",colorMap:{},tooltipFormat:new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value:map}}'),tooltipValueLookups:{map:{"-1":"Loss",0:"Draw",1:"Win"}}},discrete:{lineHeight:"auto",thresholdColor:undefined,thresholdValue:0,chartRangeMax:undefined,chartRangeMin:undefined,chartRangeClip:false,tooltipFormat:new SPFormat("{{prefix}}{{value}}{{suffix}}")},bullet:{targetColor:"#f33",targetWidth:3,performanceColor:"#33f",rangeColors:["#d3dafe","#a8b6ff","#7f94ff"],base:undefined,tooltipFormat:new SPFormat("{{fieldkey:fields}} - {{value}}"),tooltipValueLookups:{fields:{r:"Range",p:"Performance",t:"Target"}}},pie:{offset:0,sliceColors:["#3366cc","#dc3912","#ff9900","#109618","#66aa00","#dd4477","#0099c6","#990099"],borderWidth:0,borderColor:"#000",tooltipFormat:new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value}} ({{percent.1}}%)')},box:{raw:false,boxLineColor:"#000",boxFillColor:"#cdf",whiskerColor:"#000",outlierLineColor:"#333",outlierFillColor:"#fff",medianColor:"#f00",showOutliers:true,outlierIQR:1.5,spotRadius:1.5,target:undefined,targetColor:"#4a2",chartRangeMax:undefined,chartRangeMin:undefined,tooltipFormat:new SPFormat("{{field:fields}}: {{value}}"),tooltipFormatFieldlistKey:"field",tooltipValueLookups:{fields:{lq:"Lower Quartile",med:"Median",uq:"Upper Quartile",lo:"Left Outlier",ro:"Right Outlier",lw:"Left Whisker",rw:"Right Whisker"}}}}};defaultStyles=".jqstooltip { "+"position: absolute;"+"left: 0px;"+"top: 0px;"+"visibility: hidden;"+"background: rgb(0, 0, 0) transparent;"+"background-color: rgba(0,0,0,0.6);"+"filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=#99000000, endColorstr=#99000000);"+'-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr=#99000000, endColorstr=#99000000)";'+"color: white;"+"font: 10px arial, san serif;"+"text-align: left;"+"white-space: nowrap;"+"padding: 5px;"+"border: 1px solid white;"+"z-index: 10000;"+"}"+".jqsfield { "+"color: white;"+"font: 10px arial, san serif;"+"text-align: left;"+"}";createClass=function(){var Class,args;Class=function(){this.init.apply(this,arguments)};if(arguments.length>1){if(arguments[0]){Class.prototype=$.extend(new arguments[0],arguments[arguments.length-1]);Class._super=arguments[0].prototype}else{Class.prototype=arguments[arguments.length-1]}if(arguments.length>2){args=Array.prototype.slice.call(arguments,1,-1);args.unshift(Class.prototype);$.extend.apply($,args)}}else{Class.prototype=arguments[0]}Class.prototype.cls=Class;return Class};$.SPFormatClass=SPFormat=createClass({fre:/\{\{([\w.]+?)(:(.+?))?\}\}/g,precre:/(\w+)\.(\d+)/,init:function(format,fclass){this.format=format;this.fclass=fclass},render:function(fieldset,lookups,options){var self=this,fields=fieldset,match,token,lookupkey,fieldvalue,prec;return this.format.replace(this.fre,function(){var lookup;token=arguments[1];lookupkey=arguments[3];match=self.precre.exec(token);if(match){prec=match[2];token=match[1]}else{prec=false}fieldvalue=fields[token];if(fieldvalue===undefined){return""}if(lookupkey&&lookups&&lookups[lookupkey]){lookup=lookups[lookupkey];if(lookup.get){return lookups[lookupkey].get(fieldvalue)||fieldvalue}else{return lookups[lookupkey][fieldvalue]||fieldvalue}}if(isNumber(fieldvalue)){if(options.get("numberFormatter")){fieldvalue=options.get("numberFormatter")(fieldvalue)}else{fieldvalue=formatNumber(fieldvalue,prec,options.get("numberDigitGroupCount"),options.get("numberDigitGroupSep"),options.get("numberDecimalMark"))}}return fieldvalue})}});$.spformat=function(format,fclass){return new SPFormat(format,fclass)};clipval=function(val,min,max){if(val<min){return min}if(val>max){return max}return val};quartile=function(values,q){var vl;if(q===2){vl=Math.floor(values.length/2);return values.length%2?values[vl]:(values[vl-1]+values[vl])/2}else{if(values.length%2){vl=(values.length*q+q)/4;return vl%1?(values[Math.floor(vl)]+values[Math.floor(vl)-1])/2:values[vl-1]}else{vl=(values.length*q+2)/4;return vl%1?(values[Math.floor(vl)]+values[Math.floor(vl)-1])/2:values[vl-1]}}};normalizeValue=function(val){var nf;switch(val){case"undefined":val=undefined;break;case"null":val=null;break;case"true":val=true;break;case"false":val=false;break;default:nf=parseFloat(val);if(val==nf){val=nf}}return val};normalizeValues=function(vals){var i,result=[];for(i=vals.length;i--;){result[i]=normalizeValue(vals[i])}return result};remove=function(vals,filter){var i,vl,result=[];for(i=0,vl=vals.length;i<vl;i++){if(vals[i]!==filter){result.push(vals[i])}}return result};isNumber=function(num){return!isNaN(parseFloat(num))&&isFinite(num)};formatNumber=function(num,prec,groupsize,groupsep,decsep){var p,i;num=(prec===false?parseFloat(num).toString():num.toFixed(prec)).split("");p=(p=$.inArray(".",num))<0?num.length:p;if(p<num.length){num[p]=decsep}for(i=p-groupsize;i>0;i-=groupsize){num.splice(i,0,groupsep)}return num.join("")};all=function(val,arr,ignoreNull){var i;for(i=arr.length;i--;){if(ignoreNull&&arr[i]===null)continue;if(arr[i]!==val){return false}}return true};sum=function(vals){var total=0,i;for(i=vals.length;i--;){total+=typeof vals[i]==="number"?vals[i]:0}return total};ensureArray=function(val){return $.isArray(val)?val:[val]};addCSS=function(css){var tag;if(document.createStyleSheet){document.createStyleSheet().cssText=css}else{tag=document.createElement("style");tag.type="text/css";document.getElementsByTagName("head")[0].appendChild(tag);tag[typeof document.body.style.WebkitAppearance=="string"?"innerText":"innerHTML"]=css}};$.fn.simpledraw=function(width,height,useExisting,interact){var target,mhandler;if(useExisting&&(target=this.data("_jqs_vcanvas"))){return target}if(width===undefined){width=$(this).innerWidth()}if(height===undefined){height=$(this).innerHeight()}if($.browser.hasCanvas){target=new VCanvas_canvas(width,height,this,interact)}else if($.browser.msie){target=new VCanvas_vml(width,height,this)}else{return false}mhandler=$(this).data("_jqs_mhandler");if(mhandler){mhandler.registerCanvas(target)}return target};$.fn.cleardraw=function(){var target=this.data("_jqs_vcanvas");if(target){target.reset()}};$.RangeMapClass=RangeMap=createClass({init:function(map){var key,range,rangelist=[];for(key in map){if(map.hasOwnProperty(key)&&typeof key==="string"&&key.indexOf(":")>-1){range=key.split(":");range[0]=range[0].length===0?-Infinity:parseFloat(range[0]);range[1]=range[1].length===0?Infinity:parseFloat(range[1]);range[2]=map[key];rangelist.push(range)}}this.map=map;this.rangelist=rangelist||false},get:function(value){var rangelist=this.rangelist,i,range,result;if((result=this.map[value])!==undefined){return result}if(rangelist){for(i=rangelist.length;i--;){range=rangelist[i];if(range[0]<=value&&range[1]>=value){return range[2]}}}return undefined}});$.range_map=function(map){return new RangeMap(map)};MouseHandler=createClass({init:function(el,options){var $el=$(el);this.$el=$el;this.options=options;this.currentPageX=0;this.currentPageY=0;this.el=el;this.splist=[];this.tooltip=null;this.over=false;this.displayTooltips=!options.get("disableTooltips");this.highlightEnabled=!options.get("disableHighlight")},registerSparkline:function(sp){this.splist.push(sp);if(this.over){this.updateDisplay()}},registerCanvas:function(canvas){var $canvas=$(canvas.canvas);this.canvas=canvas;this.$canvas=$canvas;$canvas.mouseenter($.proxy(this.mouseenter,this));$canvas.mouseleave($.proxy(this.mouseleave,this));$canvas.click($.proxy(this.mouseclick,this))},reset:function(removeTooltip){this.splist=[];if(this.tooltip&&removeTooltip){this.tooltip.remove();this.tooltip=undefined}},mouseclick:function(e){var clickEvent=$.Event("sparklineClick");clickEvent.originalEvent=e;clickEvent.sparklines=this.splist;this.$el.trigger(clickEvent)},mouseenter:function(e){$(document.body).unbind("mousemove.jqs");$(document.body).bind("mousemove.jqs",$.proxy(this.mousemove,this));this.over=true;this.currentPageX=e.pageX;this.currentPageY=e.pageY;this.currentEl=e.target;if(!this.tooltip&&this.displayTooltips){this.tooltip=new Tooltip(this.options);this.tooltip.updatePosition(e.pageX,e.pageY)}this.updateDisplay()},mouseleave:function(){$(document.body).unbind("mousemove.jqs");var splist=this.splist,spcount=splist.length,needsRefresh=false,sp,i;this.over=false;this.currentEl=null;if(this.tooltip){this.tooltip.remove();this.tooltip=null}for(i=0;i<spcount;i++){sp=splist[i];if(sp.clearRegionHighlight()){needsRefresh=true}}if(needsRefresh){this.canvas.render()}},mousemove:function(e){this.currentPageX=e.pageX;this.currentPageY=e.pageY;this.currentEl=e.target;if(this.tooltip){this.tooltip.updatePosition(e.pageX,e.pageY)}this.updateDisplay()},updateDisplay:function(){var splist=this.splist,spcount=splist.length,needsRefresh=false,offset=this.$canvas.offset(),localX=this.currentPageX-offset.left,localY=this.currentPageY-offset.top,tooltiphtml,sp,i,result,changeEvent;if(!this.over){return}for(i=0;i<spcount;i++){sp=splist[i];result=sp.setRegionHighlight(this.currentEl,localX,localY);if(result){needsRefresh=true}}if(needsRefresh){changeEvent=$.Event("sparklineRegionChange");changeEvent.sparklines=this.splist;this.$el.trigger(changeEvent);if(this.tooltip){tooltiphtml="";for(i=0;i<spcount;i++){sp=splist[i];tooltiphtml+=sp.getCurrentRegionTooltip()}this.tooltip.setContent(tooltiphtml)}if(!this.disableHighlight){this.canvas.render()}}if(result===null){this.mouseleave()}}});Tooltip=createClass({sizeStyle:"position: static !important;"+"display: block !important;"+"visibility: hidden !important;"+"float: left !important;",init:function(options){var tooltipClassname=options.get("tooltipClassname","jqstooltip"),sizetipStyle=this.sizeStyle,offset;this.container=options.get("tooltipContainer")||document.body;this.tooltipOffsetX=options.get("tooltipOffsetX",10);this.tooltipOffsetY=options.get("tooltipOffsetY",12);$("#jqssizetip").remove();$("#jqstooltip").remove();this.sizetip=$("<div/>",{id:"jqssizetip",style:sizetipStyle,"class":tooltipClassname});this.tooltip=$("<div/>",{id:"jqstooltip","class":tooltipClassname}).appendTo(this.container);offset=this.tooltip.offset();this.offsetLeft=offset.left;this.offsetTop=offset.top;this.hidden=true;$(window).unbind("resize.jqs scroll.jqs");$(window).bind("resize.jqs scroll.jqs",$.proxy(this.updateWindowDims,this));this.updateWindowDims()},updateWindowDims:function(){this.scrollTop=$(window).scrollTop();this.scrollLeft=$(window).scrollLeft();this.scrollRight=this.scrollLeft+$(window).width();this.updatePosition()},getSize:function(content){this.sizetip.html(content).appendTo(this.container);this.width=this.sizetip.width()+1;this.height=this.sizetip.height();this.sizetip.remove()},setContent:function(content){if(!content){this.tooltip.css("visibility","hidden");this.hidden=true;return}this.getSize(content);this.tooltip.html(content).css({width:this.width,height:this.height,visibility:"visible"});if(this.hidden){this.hidden=false;this.updatePosition()}},updatePosition:function(x,y){if(x===undefined){if(this.mousex===undefined){return}x=this.mousex-this.offsetLeft;y=this.mousey-this.offsetTop}else{this.mousex=x=x-this.offsetLeft;this.mousey=y=y-this.offsetTop}if(!this.height||!this.width||this.hidden){return}y-=this.height+this.tooltipOffsetY;x+=this.tooltipOffsetX;if(y<this.scrollTop){y=this.scrollTop}if(x<this.scrollLeft){x=this.scrollLeft}else if(x+this.width>this.scrollRight){x=this.scrollRight-this.width}this.tooltip.css({left:x,top:y})},remove:function(){this.tooltip.remove();this.sizetip.remove();this.sizetip=this.tooltip=undefined;$(window).unbind("resize.jqs scroll.jqs")}});initStyles=function(){addCSS(defaultStyles)};$(initStyles);pending=[];$.fn.sparkline=function(userValues,userOptions){return this.each(function(){var options=new $.fn.sparkline.options(this,userOptions),$this=$(this),render,i;render=function(){var values,width,height,tmp,mhandler,sp,vals;if(userValues==="html"||userValues===undefined){vals=this.getAttribute(options.get("tagValuesAttribute"));if(vals===undefined||vals===null){vals=$this.html()}values=vals.replace(/(^\s*<!--)|(-->\s*$)|\s+/g,"").split(",")}else{values=userValues}width=options.get("width")==="auto"?values.length*options.get("defaultPixelsPerValue"):options.get("width");if(options.get("height")==="auto"){if(!options.get("composite")||!$.data(this,"_jqs_vcanvas")){tmp=document.createElement("span");tmp.innerHTML="a";$this.html(tmp);height=$(tmp).innerHeight()||$(tmp).height();$(tmp).remove();tmp=null}}else{height=options.get("height")}if(!options.get("disableInteraction")){mhandler=$.data(this,"_jqs_mhandler");if(!mhandler){mhandler=new MouseHandler(this,options);$.data(this,"_jqs_mhandler",mhandler)}else if(!options.get("composite")){mhandler.reset()}}else{mhandler=false}if(options.get("composite")&&!$.data(this,"_jqs_vcanvas")){if(!$.data(this,"_jqs_errnotify")){alert("Attempted to attach a composite sparkline to an element with no existing sparkline");$.data(this,"_jqs_errnotify",true)}return}sp=new($.fn.sparkline[options.get("type")])(this,values,options,width,height);sp.render();if(mhandler){mhandler.registerSparkline(sp)}};if($(this).html()&&!options.get("disableHiddenCheck")&&$(this).is(":hidden")||$.fn.jquery<"1.3.0"&&$(this).parents().is(":hidden")||!$(this).parents("body").length){if(!options.get("composite")&&$.data(this,"_jqs_pending")){for(i=pending.length;i;i--){if(pending[i-1][0]==this){pending.splice(i-1,1)}}}pending.push([this,render]);$.data(this,"_jqs_pending",true)}else{render.call(this)}})};$.fn.sparkline.defaults=getDefaults();$.sparkline_display_visible=function(){var el,i,pl;var done=[];for(i=0,pl=pending.length;i<pl;i++){el=pending[i][0];if($(el).is(":visible")&&!$(el).parents().is(":hidden")){pending[i][1].call(el);$.data(pending[i][0],"_jqs_pending",false);done.push(i)}else if(!$(el).closest("html").length&&!$.data(el,"_jqs_pending")){$.data(pending[i][0],"_jqs_pending",false);done.push(i)}}for(i=done.length;i;i--){pending.splice(done[i-1],1)}};$.fn.sparkline.options=createClass({init:function(tag,userOptions){var extendedOptions,defaults,base,tagOptionType;this.userOptions=userOptions=userOptions||{};this.tag=tag;this.tagValCache={};defaults=$.fn.sparkline.defaults;base=defaults.common;this.tagOptionsPrefix=userOptions.enableTagOptions&&(userOptions.tagOptionsPrefix||base.tagOptionsPrefix);tagOptionType=this.getTagSetting("type");if(tagOptionType===UNSET_OPTION){extendedOptions=defaults[userOptions.type||base.type]}else{extendedOptions=defaults[tagOptionType]}this.mergedOptions=$.extend({},base,extendedOptions,userOptions)},getTagSetting:function(key){var prefix=this.tagOptionsPrefix,val,i,pairs,keyval;if(prefix===false||prefix===undefined){return UNSET_OPTION}if(this.tagValCache.hasOwnProperty(key)){val=this.tagValCache.key}else{val=this.tag.getAttribute(prefix+key);if(val===undefined||val===null){val=UNSET_OPTION}else if(val.substr(0,1)==="["){val=val.substr(1,val.length-2).split(",");for(i=val.length;i--;){val[i]=normalizeValue(val[i].replace(/(^\s*)|(\s*$)/g,""))}}else if(val.substr(0,1)==="{"){pairs=val.substr(1,val.length-2).split(",");val={};for(i=pairs.length;i--;){keyval=pairs[i].split(":",2);val[keyval[0].replace(/(^\s*)|(\s*$)/g,"")]=normalizeValue(keyval[1].replace(/(^\s*)|(\s*$)/g,""))}}else{val=normalizeValue(val)}this.tagValCache.key=val}return val},get:function(key,defaultval){var tagOption=this.getTagSetting(key),result;if(tagOption!==UNSET_OPTION){return tagOption}return(result=this.mergedOptions[key])===undefined?defaultval:result}});$.fn.sparkline._base=createClass({disabled:false,init:function(el,values,options,width,height){this.el=el;this.$el=$(el);this.values=values;this.options=options;this.width=width;this.height=height;this.currentRegion=undefined},initTarget:function(){var interactive=!this.options.get("disableInteraction");if(!(this.target=this.$el.simpledraw(this.width,this.height,this.options.get("composite"),interactive))){this.disabled=true}else{this.canvasWidth=this.target.pixelWidth;this.canvasHeight=this.target.pixelHeight}},render:function(){if(this.disabled){this.el.innerHTML="";return false}return true},getRegion:function(x,y){},setRegionHighlight:function(el,x,y){var currentRegion=this.currentRegion,highlightEnabled=!this.options.get("disableHighlight"),newRegion;if(x>this.canvasWidth||y>this.canvasHeight||x<0||y<0){return null}newRegion=this.getRegion(el,x,y);if(currentRegion!==newRegion){if(currentRegion!==undefined&&highlightEnabled){this.removeHighlight()}this.currentRegion=newRegion;if(newRegion!==undefined&&highlightEnabled){this.renderHighlight()}return true}return false},clearRegionHighlight:function(){if(this.currentRegion!==undefined){this.removeHighlight();this.currentRegion=undefined;return true}return false},renderHighlight:function(){this.changeHighlight(true)},removeHighlight:function(){this.changeHighlight(false)},changeHighlight:function(highlight){},getCurrentRegionTooltip:function(){var options=this.options,header="",entries=[],fields,formats,formatlen,fclass,text,i,showFields,showFieldsKey,newFields,fv,formatter,format,fieldlen,j;if(this.currentRegion===undefined){return""}fields=this.getCurrentRegionFields();formatter=options.get("tooltipFormatter");if(formatter){return formatter(this,options,fields)}if(options.get("tooltipChartTitle")){header+='<div class="jqs jqstitle">'+options.get("tooltipChartTitle")+"</div>\n"}formats=this.options.get("tooltipFormat");if(!formats){return""}if(!$.isArray(formats)){formats=[formats]}if(!$.isArray(fields)){fields=[fields]}showFields=this.options.get("tooltipFormatFieldlist");showFieldsKey=this.options.get("tooltipFormatFieldlistKey");if(showFields&&showFieldsKey){newFields=[];for(i=fields.length;i--;){fv=fields[i][showFieldsKey];if((j=$.inArray(fv,showFields))!=-1){newFields[j]=fields[i]}}fields=newFields}formatlen=formats.length;fieldlen=fields.length;for(i=0;i<formatlen;i++){format=formats[i];if(typeof format==="string"){format=new SPFormat(format)}fclass=format.fclass||"jqsfield";for(j=0;j<fieldlen;j++){if(!fields[j].isNull||!options.get("tooltipSkipNull")){$.extend(fields[j],{prefix:options.get("tooltipPrefix"),suffix:options.get("tooltipSuffix")});text=format.render(fields[j],options.get("tooltipValueLookups"),options);entries.push('<div class="'+fclass+'">'+text+"</div>")}}}if(entries.length){return header+entries.join("\n")}return""},getCurrentRegionFields:function(){},calcHighlightColor:function(color,options){var highlightColor=options.get("highlightColor"),lighten=options.get("highlightLighten"),parse,mult,rgbnew,i;if(highlightColor){return highlightColor}if(lighten){parse=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(color)||/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(color);if(parse){rgbnew=[];mult=color.length===4?16:1;for(i=0;i<3;i++){rgbnew[i]=clipval(Math.round(parseInt(parse[i+1],16)*mult*lighten),0,255)}return"rgb("+rgbnew.join(",")+")"}}return color}});barHighlightMixin={changeHighlight:function(highlight){var currentRegion=this.currentRegion,target=this.target,shapeids=this.regionShapes[currentRegion],newShapes;if(shapeids){newShapes=this.renderRegion(currentRegion,highlight);if($.isArray(newShapes)||$.isArray(shapeids)){target.replaceWithShapes(shapeids,newShapes);this.regionShapes[currentRegion]=$.map(newShapes,function(newShape){return newShape.id})}else{target.replaceWithShape(shapeids,newShapes);this.regionShapes[currentRegion]=newShapes.id}}},render:function(){var values=this.values,target=this.target,regionShapes=this.regionShapes,shapes,ids,i,j;if(!this.cls._super.render.call(this)){return}for(i=values.length;i--;){shapes=this.renderRegion(i);if(shapes){if($.isArray(shapes)){ids=[];for(j=shapes.length;j--;){shapes[j].append();ids.push(shapes[j].id)}regionShapes[i]=ids}else{shapes.append();regionShapes[i]=shapes.id}}else{regionShapes[i]=null}}target.render()}};$.fn.sparkline.line=line=createClass($.fn.sparkline._base,{type:"line",init:function(el,values,options,width,height){line._super.init.call(this,el,values,options,width,height);this.vertices=[];this.regionMap=[];this.xvalues=[];this.yvalues=[];this.yminmax=[];this.hightlightSpotId=null;this.lastShapeId=null;this.initTarget()},getRegion:function(el,x,y){var i,regionMap=this.regionMap;for(i=regionMap.length;i--;){if(regionMap[i]!==null&&x>=regionMap[i][0]&&x<=regionMap[i][1]){return regionMap[i][2]}}return undefined},getCurrentRegionFields:function(){var currentRegion=this.currentRegion;return{isNull:this.yvalues[currentRegion]===null,x:this.xvalues[currentRegion],y:this.yvalues[currentRegion],color:this.options.get("lineColor"),fillColor:this.options.get("fillColor"),offset:currentRegion}},renderHighlight:function(){var currentRegion=this.currentRegion,target=this.target,vertex=this.vertices[currentRegion],options=this.options,spotRadius=options.get("spotRadius"),highlightSpotColor=options.get("highlightSpotColor"),highlightLineColor=options.get("highlightLineColor"),highlightSpot,highlightLine;if(!vertex){return}if(spotRadius&&highlightSpotColor){highlightSpot=target.drawCircle(vertex[0],vertex[1],spotRadius,undefined,highlightSpotColor);this.highlightSpotId=highlightSpot.id;target.insertAfterShape(this.lastShapeId,highlightSpot)}if(highlightLineColor){highlightLine=target.drawLine(vertex[0],this.canvasTop,vertex[0],this.canvasTop+this.canvasHeight,highlightLineColor);this.highlightLineId=highlightLine.id;target.insertAfterShape(this.lastShapeId,highlightLine)}},removeHighlight:function(){var target=this.target;if(this.highlightSpotId){target.removeShapeId(this.highlightSpotId);this.highlightSpotId=null}if(this.highlightLineId){target.removeShapeId(this.highlightLineId);this.highlightLineId=null}},scanValues:function(){var values=this.values,valcount=values.length,xvalues=this.xvalues,yvalues=this.yvalues,yminmax=this.yminmax,i,val,isStr,isArray,sp;for(i=0;i<valcount;i++){val=values[i];isStr=typeof values[i]==="string";isArray=typeof values[i]==="object"&&values[i]instanceof Array;sp=isStr&&values[i].split(":");if(isStr&&sp.length===2){xvalues.push(Number(sp[0]));yvalues.push(Number(sp[1]));yminmax.push(Number(sp[1]))}else if(isArray){xvalues.push(val[0]);yvalues.push(val[1]);yminmax.push(val[1])}else{xvalues.push(i);if(values[i]===null||values[i]==="null"){yvalues.push(null)}else{yvalues.push(Number(val));yminmax.push(Number(val))}}}if(this.options.get("xvalues")){xvalues=this.options.get("xvalues")}this.maxy=this.maxyorg=Math.max.apply(Math,yminmax);this.miny=this.minyorg=Math.min.apply(Math,yminmax);this.maxx=Math.max.apply(Math,xvalues);this.minx=Math.min.apply(Math,xvalues);this.xvalues=xvalues;this.yvalues=yvalues;this.yminmax=yminmax},processRangeOptions:function(){var options=this.options,normalRangeMin=options.get("normalRangeMin"),normalRangeMax=options.get("normalRangeMax");if(normalRangeMin!==undefined){if(normalRangeMin<this.miny){this.miny=normalRangeMin}if(normalRangeMax>this.maxy){this.maxy=normalRangeMax}}if(options.get("chartRangeMin")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMin")<this.miny)){this.miny=options.get("chartRangeMin")}if(options.get("chartRangeMax")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMax")>this.maxy)){this.maxy=options.get("chartRangeMax")}if(options.get("chartRangeMinX")!==undefined&&(options.get("chartRangeClipX")||options.get("chartRangeMinX")<this.minx)){this.minx=options.get("chartRangeMinX")}if(options.get("chartRangeMaxX")!==undefined&&(options.get("chartRangeClipX")||options.get("chartRangeMaxX")>this.maxx)){this.maxx=options.get("chartRangeMaxX")}},drawNormalRange:function(canvasLeft,canvasTop,canvasHeight,canvasWidth,rangey){var normalRangeMin=this.options.get("normalRangeMin"),normalRangeMax=this.options.get("normalRangeMax"),ytop=canvasTop+Math.round(canvasHeight-canvasHeight*((normalRangeMax-this.miny)/rangey)),height=Math.round(canvasHeight*(normalRangeMax-normalRangeMin)/rangey);this.target.drawRect(canvasLeft,ytop,canvasWidth,height,undefined,this.options.get("normalRangeColor")).append()},render:function(){var options=this.options,target=this.target,canvasWidth=this.canvasWidth,canvasHeight=this.canvasHeight,vertices=this.vertices,spotRadius=options.get("spotRadius"),regionMap=this.regionMap,rangex,rangey,yvallast,canvasTop,canvasLeft,vertex,path,paths,x,y,xnext,xpos,xposnext,last,next,yvalcount,lineShapes,fillShapes,plen,valueSpots,hlSpotsEnabled,color,xvalues,yvalues,i;if(!line._super.render.call(this)){return}this.scanValues();this.processRangeOptions();xvalues=this.xvalues;yvalues=this.yvalues;if(!this.yminmax.length||this.yvalues.length<2){return}canvasTop=canvasLeft=0;rangex=this.maxx-this.minx===0?1:this.maxx-this.minx;rangey=this.maxy-this.miny===0?1:this.maxy-this.miny;yvallast=this.yvalues.length-1;if(spotRadius&&(canvasWidth<spotRadius*4||canvasHeight<spotRadius*4)){spotRadius=0}if(spotRadius){hlSpotsEnabled=options.get("highlightSpotColor")&&!options.get("disableInteraction");if(hlSpotsEnabled||options.get("minSpotColor")||options.get("spotColor")&&yvalues[yvallast]===this.miny){canvasHeight-=Math.ceil(spotRadius)}if(hlSpotsEnabled||options.get("maxSpotColor")||options.get("spotColor")&&yvalues[yvallast]===this.maxy){canvasHeight-=Math.ceil(spotRadius);canvasTop+=Math.ceil(spotRadius)}if(hlSpotsEnabled||(options.get("minSpotColor")||options.get("maxSpotColor"))&&(yvalues[0]===this.miny||yvalues[0]===this.maxy)){canvasLeft+=Math.ceil(spotRadius);canvasWidth-=Math.ceil(spotRadius)}if(hlSpotsEnabled||options.get("spotColor")||(options.get("minSpotColor")||options.get("maxSpotColor")&&(yvalues[yvallast]===this.miny||yvalues[yvallast]===this.maxy))){canvasWidth-=Math.ceil(spotRadius)}}canvasHeight--;if(options.get("normalRangeMin")!==undefined&&!options.get("drawNormalOnTop")){this.drawNormalRange(canvasLeft,canvasTop,canvasHeight,canvasWidth,rangey)}path=[];paths=[path];last=next=null;yvalcount=yvalues.length;for(i=0;i<yvalcount;i++){x=xvalues[i];xnext=xvalues[i+1];y=yvalues[i];xpos=canvasLeft+Math.round((x-this.minx)*(canvasWidth/rangex));xposnext=i<yvalcount-1?canvasLeft+Math.round((xnext-this.minx)*(canvasWidth/rangex)):canvasWidth;next=xpos+(xposnext-xpos)/2;regionMap[i]=[last||0,next,i];last=next;if(y===null){if(i){if(yvalues[i-1]!==null){path=[];paths.push(path)}vertices.push(null)}}else{if(y<this.miny){y=this.miny}if(y>this.maxy){y=this.maxy}if(!path.length){path.push([xpos,canvasTop+canvasHeight])}vertex=[xpos,canvasTop+Math.round(canvasHeight-canvasHeight*((y-this.miny)/rangey))];path.push(vertex);vertices.push(vertex)}}lineShapes=[];fillShapes=[];plen=paths.length;for(i=0;i<plen;i++){path=paths[i];if(path.length){if(options.get("fillColor")){path.push([path[path.length-1][0],canvasTop+canvasHeight]);fillShapes.push(path.slice(0));path.pop()}if(path.length>2){path[0]=[path[0][0],path[1][1]]}lineShapes.push(path)}}plen=fillShapes.length;for(i=0;i<plen;i++){target.drawShape(fillShapes[i],options.get("fillColor"),options.get("fillColor")).append()}if(options.get("normalRangeMin")!==undefined&&options.get("drawNormalOnTop")){this.drawNormalRange(canvasLeft,canvasTop,canvasHeight,canvasWidth,rangey)}plen=lineShapes.length;for(i=0;i<plen;i++){target.drawShape(lineShapes[i],options.get("lineColor"),undefined,options.get("lineWidth")).append()}if(spotRadius&&options.get("valueSpots")){valueSpots=options.get("valueSpots");if(valueSpots.get===undefined){valueSpots=new RangeMap(valueSpots)}for(i=0;i<yvalcount;i++){color=valueSpots.get(yvalues[i]);if(color){target.drawCircle(canvasLeft+Math.round((xvalues[i]-this.minx)*(canvasWidth/rangex)),canvasTop+Math.round(canvasHeight-canvasHeight*((yvalues[i]-this.miny)/rangey)),spotRadius,undefined,color).append()}}}if(spotRadius&&options.get("spotColor")){target.drawCircle(canvasLeft+Math.round((xvalues[xvalues.length-1]-this.minx)*(canvasWidth/rangex)),canvasTop+Math.round(canvasHeight-canvasHeight*((yvalues[yvallast]-this.miny)/rangey)),spotRadius,undefined,options.get("spotColor")).append()}if(this.maxy!==this.minyorg){if(spotRadius&&options.get("minSpotColor")){x=xvalues[$.inArray(this.minyorg,yvalues)];target.drawCircle(canvasLeft+Math.round((x-this.minx)*(canvasWidth/rangex)),canvasTop+Math.round(canvasHeight-canvasHeight*((this.minyorg-this.miny)/rangey)),spotRadius,undefined,options.get("minSpotColor")).append()}if(spotRadius&&options.get("maxSpotColor")){x=xvalues[$.inArray(this.maxyorg,yvalues)];target.drawCircle(canvasLeft+Math.round((x-this.minx)*(canvasWidth/rangex)),canvasTop+Math.round(canvasHeight-canvasHeight*((this.maxyorg-this.miny)/rangey)),spotRadius,undefined,options.get("maxSpotColor")).append()}}this.lastShapeId=target.getLastShapeId();this.canvasTop=canvasTop;target.render()}});$.fn.sparkline.bar=bar=createClass($.fn.sparkline._base,barHighlightMixin,{type:"bar",init:function(el,values,options,width,height){var barWidth=parseInt(options.get("barWidth"),10),barSpacing=parseInt(options.get("barSpacing"),10),chartRangeMin=options.get("chartRangeMin"),chartRangeMax=options.get("chartRangeMax"),chartRangeClip=options.get("chartRangeClip"),stackMin=Infinity,stackMax=-Infinity,isStackString,groupMin,groupMax,stackRanges,numValues,i,vlen,range,zeroAxis,xaxisOffset,min,max,clipMin,clipMax,stacked,vlist,j,slen,svals,val,yoffset,yMaxCalc,canvasHeightEf;
bar._super.init.call(this,el,values,options,width,height);for(i=0,vlen=values.length;i<vlen;i++){val=values[i];isStackString=typeof val==="string"&&val.indexOf(":")>-1;if(isStackString||$.isArray(val)){stacked=true;if(isStackString){val=values[i]=normalizeValues(val.split(":"))}val=remove(val,null);groupMin=Math.min.apply(Math,val);groupMax=Math.max.apply(Math,val);if(groupMin<stackMin){stackMin=groupMin}if(groupMax>stackMax){stackMax=groupMax}}}this.stacked=stacked;this.regionShapes={};this.barWidth=barWidth;this.barSpacing=barSpacing;this.totalBarWidth=barWidth+barSpacing;this.width=width=values.length*barWidth+(values.length-1)*barSpacing;this.initTarget();if(chartRangeClip){clipMin=chartRangeMin===undefined?-Infinity:chartRangeMin;clipMax=chartRangeMax===undefined?Infinity:chartRangeMax}numValues=[];stackRanges=stacked?[]:numValues;var stackTotals=[];var stackRangesNeg=[];for(i=0,vlen=values.length;i<vlen;i++){if(stacked){vlist=values[i];values[i]=svals=[];stackTotals[i]=0;stackRanges[i]=stackRangesNeg[i]=0;for(j=0,slen=vlist.length;j<slen;j++){val=svals[j]=chartRangeClip?clipval(vlist[j],clipMin,clipMax):vlist[j];if(val!==null){if(val>0){stackTotals[i]+=val}if(stackMin<0&&stackMax>0){if(val<0){stackRangesNeg[i]+=Math.abs(val)}else{stackRanges[i]+=val}}else{stackRanges[i]+=Math.abs(val-(val<0?stackMax:stackMin))}numValues.push(val)}}}else{val=chartRangeClip?clipval(values[i],clipMin,clipMax):values[i];val=values[i]=normalizeValue(val);if(val!==null){numValues.push(val)}}}this.max=max=Math.max.apply(Math,numValues);this.min=min=Math.min.apply(Math,numValues);this.stackMax=stackMax=stacked?Math.max.apply(Math,stackTotals):max;this.stackMin=stackMin=stacked?Math.min.apply(Math,numValues):min;if(options.get("chartRangeMin")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMin")<min)){min=options.get("chartRangeMin")}if(options.get("chartRangeMax")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMax")>max)){max=options.get("chartRangeMax")}this.zeroAxis=zeroAxis=options.get("zeroAxis",true);if(min<=0&&max>=0&&zeroAxis){xaxisOffset=0}else if(zeroAxis==false){xaxisOffset=min}else if(min>0){xaxisOffset=min}else{xaxisOffset=max}this.xaxisOffset=xaxisOffset;range=stacked?Math.max.apply(Math,stackRanges)+Math.max.apply(Math,stackRangesNeg):max-min;this.canvasHeightEf=zeroAxis&&min<0?this.canvasHeight-2:this.canvasHeight-1;if(min<xaxisOffset){yMaxCalc=stacked&&max>=0?stackMax:max;yoffset=(yMaxCalc-xaxisOffset)/range*this.canvasHeight;if(yoffset!==Math.ceil(yoffset)){this.canvasHeightEf-=2;yoffset=Math.ceil(yoffset)}}else{yoffset=this.canvasHeight}this.yoffset=yoffset;if($.isArray(options.get("colorMap"))){this.colorMapByIndex=options.get("colorMap");this.colorMapByValue=null}else{this.colorMapByIndex=null;this.colorMapByValue=options.get("colorMap");if(this.colorMapByValue&&this.colorMapByValue.get===undefined){this.colorMapByValue=new RangeMap(this.colorMapByValue)}}this.range=range},getRegion:function(el,x,y){var result=Math.floor(x/this.totalBarWidth);return result<0||result>=this.values.length?undefined:result},getCurrentRegionFields:function(){var currentRegion=this.currentRegion,values=ensureArray(this.values[currentRegion]),result=[],value,i;for(i=values.length;i--;){value=values[i];result.push({isNull:value===null,value:value,color:this.calcColor(i,value,currentRegion),offset:currentRegion})}return result},calcColor:function(stacknum,value,valuenum){var colorMapByIndex=this.colorMapByIndex,colorMapByValue=this.colorMapByValue,options=this.options,color,newColor;if(this.stacked){color=options.get("stackedBarColor")}else{color=value<0?options.get("negBarColor"):options.get("barColor")}if(value===0&&options.get("zeroColor")!==undefined){color=options.get("zeroColor")}if(colorMapByValue&&(newColor=colorMapByValue.get(value))){color=newColor}else if(colorMapByIndex&&colorMapByIndex.length>valuenum){color=colorMapByIndex[valuenum]}return $.isArray(color)?color[stacknum%color.length]:color},renderRegion:function(valuenum,highlight){var vals=this.values[valuenum],options=this.options,xaxisOffset=this.xaxisOffset,result=[],range=this.range,stacked=this.stacked,target=this.target,x=valuenum*this.totalBarWidth,canvasHeightEf=this.canvasHeightEf,yoffset=this.yoffset,y,height,color,isNull,yoffsetNeg,i,valcount,val,minPlotted,allMin;vals=$.isArray(vals)?vals:[vals];valcount=vals.length;val=vals[0];isNull=all(null,vals);allMin=all(xaxisOffset,vals,true);if(isNull){if(options.get("nullColor")){color=highlight?options.get("nullColor"):this.calcHighlightColor(options.get("nullColor"),options);y=yoffset>0?yoffset-1:yoffset;return target.drawRect(x,y,this.barWidth-1,0,color,color)}else{return undefined}}yoffsetNeg=yoffset;for(i=0;i<valcount;i++){val=vals[i];if(stacked&&val===xaxisOffset){if(!allMin||minPlotted){continue}minPlotted=true}if(range>0){height=Math.floor(canvasHeightEf*(Math.abs(val-xaxisOffset)/range))+1}else{height=1}if(val<xaxisOffset||val===xaxisOffset&&yoffset===0){y=yoffsetNeg;yoffsetNeg+=height}else{y=yoffset-height;yoffset-=height}color=this.calcColor(i,val,valuenum);if(highlight){color=this.calcHighlightColor(color,options)}result.push(target.drawRect(x,y,this.barWidth-1,height-1,color,color))}if(result.length===1){return result[0]}return result}});$.fn.sparkline.tristate=tristate=createClass($.fn.sparkline._base,barHighlightMixin,{type:"tristate",init:function(el,values,options,width,height){var barWidth=parseInt(options.get("barWidth"),10),barSpacing=parseInt(options.get("barSpacing"),10);tristate._super.init.call(this,el,values,options,width,height);this.regionShapes={};this.barWidth=barWidth;this.barSpacing=barSpacing;this.totalBarWidth=barWidth+barSpacing;this.values=$.map(values,Number);this.width=width=values.length*barWidth+(values.length-1)*barSpacing;if($.isArray(options.get("colorMap"))){this.colorMapByIndex=options.get("colorMap");this.colorMapByValue=null}else{this.colorMapByIndex=null;this.colorMapByValue=options.get("colorMap");if(this.colorMapByValue&&this.colorMapByValue.get===undefined){this.colorMapByValue=new RangeMap(this.colorMapByValue)}}this.initTarget()},getRegion:function(el,x,y){return Math.floor(x/this.totalBarWidth)},getCurrentRegionFields:function(){var currentRegion=this.currentRegion;return{isNull:this.values[currentRegion]===undefined,value:this.values[currentRegion],color:this.calcColor(this.values[currentRegion],currentRegion),offset:currentRegion}},calcColor:function(value,valuenum){var values=this.values,options=this.options,colorMapByIndex=this.colorMapByIndex,colorMapByValue=this.colorMapByValue,color,newColor;if(colorMapByValue&&(newColor=colorMapByValue.get(value))){color=newColor}else if(colorMapByIndex&&colorMapByIndex.length>valuenum){color=colorMapByIndex[valuenum]}else if(values[valuenum]<0){color=options.get("negBarColor")}else if(values[valuenum]>0){color=options.get("posBarColor")}else{color=options.get("zeroBarColor")}return color},renderRegion:function(valuenum,highlight){var values=this.values,options=this.options,target=this.target,canvasHeight,height,halfHeight,x,y,color;canvasHeight=target.pixelHeight;halfHeight=Math.round(canvasHeight/2);x=valuenum*this.totalBarWidth;if(values[valuenum]<0){y=halfHeight;height=halfHeight-1}else if(values[valuenum]>0){y=0;height=halfHeight-1}else{y=halfHeight-1;height=2}color=this.calcColor(values[valuenum],valuenum);if(color===null){return}if(highlight){color=this.calcHighlightColor(color,options)}return target.drawRect(x,y,this.barWidth-1,height-1,color,color)}});$.fn.sparkline.discrete=discrete=createClass($.fn.sparkline._base,barHighlightMixin,{type:"discrete",init:function(el,values,options,width,height){discrete._super.init.call(this,el,values,options,width,height);this.regionShapes={};this.values=values=$.map(values,Number);this.min=Math.min.apply(Math,values);this.max=Math.max.apply(Math,values);this.range=this.max-this.min;this.width=width=options.get("width")==="auto"?values.length*2:this.width;this.interval=Math.floor(width/values.length);this.itemWidth=width/values.length;if(options.get("chartRangeMin")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMin")<this.min)){this.min=options.get("chartRangeMin")}if(options.get("chartRangeMax")!==undefined&&(options.get("chartRangeClip")||options.get("chartRangeMax")>this.max)){this.max=options.get("chartRangeMax")}this.initTarget();if(this.target){this.lineHeight=options.get("lineHeight")==="auto"?Math.round(this.canvasHeight*.3):options.get("lineHeight")}},getRegion:function(el,x,y){return Math.floor(x/this.itemWidth)},getCurrentRegionFields:function(){var currentRegion=this.currentRegion;return{isNull:this.values[currentRegion]===undefined,value:this.values[currentRegion],offset:currentRegion}},renderRegion:function(valuenum,highlight){var values=this.values,options=this.options,min=this.min,max=this.max,range=this.range,interval=this.interval,target=this.target,canvasHeight=this.canvasHeight,lineHeight=this.lineHeight,pheight=canvasHeight-lineHeight,ytop,val,color,x;val=clipval(values[valuenum],min,max);x=valuenum*interval;ytop=Math.round(pheight-pheight*((val-min)/range));color=options.get("thresholdColor")&&val<options.get("thresholdValue")?options.get("thresholdColor"):options.get("lineColor");if(highlight){color=this.calcHighlightColor(color,options)}return target.drawLine(x,ytop,x,ytop+lineHeight,color)}});$.fn.sparkline.bullet=bullet=createClass($.fn.sparkline._base,{type:"bullet",init:function(el,values,options,width,height){var min,max,vals;bullet._super.init.call(this,el,values,options,width,height);this.values=values=normalizeValues(values);vals=values.slice();vals[0]=vals[0]===null?vals[2]:vals[0];vals[1]=values[1]===null?vals[2]:vals[1];min=Math.min.apply(Math,values);max=Math.max.apply(Math,values);if(options.get("base")===undefined){min=min<0?min:0}else{min=options.get("base")}this.min=min;this.max=max;this.range=max-min;this.shapes={};this.valueShapes={};this.regiondata={};this.width=width=options.get("width")==="auto"?"4.0em":width;this.target=this.$el.simpledraw(width,height,options.get("composite"));if(!values.length){this.disabled=true}this.initTarget()},getRegion:function(el,x,y){var shapeid=this.target.getShapeAt(el,x,y);return shapeid!==undefined&&this.shapes[shapeid]!==undefined?this.shapes[shapeid]:undefined},getCurrentRegionFields:function(){var currentRegion=this.currentRegion;return{fieldkey:currentRegion.substr(0,1),value:this.values[currentRegion.substr(1)],region:currentRegion}},changeHighlight:function(highlight){var currentRegion=this.currentRegion,shapeid=this.valueShapes[currentRegion],shape;delete this.shapes[shapeid];switch(currentRegion.substr(0,1)){case"r":shape=this.renderRange(currentRegion.substr(1),highlight);break;case"p":shape=this.renderPerformance(highlight);break;case"t":shape=this.renderTarget(highlight);break}this.valueShapes[currentRegion]=shape.id;this.shapes[shape.id]=currentRegion;this.target.replaceWithShape(shapeid,shape)},renderRange:function(rn,highlight){var rangeval=this.values[rn],rangewidth=Math.round(this.canvasWidth*((rangeval-this.min)/this.range)),color=this.options.get("rangeColors")[rn-2];if(highlight){color=this.calcHighlightColor(color,this.options)}return this.target.drawRect(0,0,rangewidth-1,this.canvasHeight-1,color,color)},renderPerformance:function(highlight){var perfval=this.values[1],perfwidth=Math.round(this.canvasWidth*((perfval-this.min)/this.range)),color=this.options.get("performanceColor");if(highlight){color=this.calcHighlightColor(color,this.options)}return this.target.drawRect(0,Math.round(this.canvasHeight*.3),perfwidth-1,Math.round(this.canvasHeight*.4)-1,color,color)},renderTarget:function(highlight){var targetval=this.values[0],x=Math.round(this.canvasWidth*((targetval-this.min)/this.range)-this.options.get("targetWidth")/2),targettop=Math.round(this.canvasHeight*.1),targetheight=this.canvasHeight-targettop*2,color=this.options.get("targetColor");if(highlight){color=this.calcHighlightColor(color,this.options)}return this.target.drawRect(x,targettop,this.options.get("targetWidth")-1,targetheight-1,color,color)},render:function(){var vlen=this.values.length,target=this.target,i,shape;if(!bullet._super.render.call(this)){return}for(i=2;i<vlen;i++){shape=this.renderRange(i).append();this.shapes[shape.id]="r"+i;this.valueShapes["r"+i]=shape.id}if(this.values[1]!==null){shape=this.renderPerformance().append();this.shapes[shape.id]="p1";this.valueShapes.p1=shape.id}if(this.values[0]!==null){shape=this.renderTarget().append();this.shapes[shape.id]="t0";this.valueShapes.t0=shape.id}target.render()}});$.fn.sparkline.pie=pie=createClass($.fn.sparkline._base,{type:"pie",init:function(el,values,options,width,height){var total=0,i;pie._super.init.call(this,el,values,options,width,height);this.shapes={};this.valueShapes={};this.values=values=$.map(values,Number);if(options.get("width")==="auto"){this.width=this.height}if(values.length>0){for(i=values.length;i--;){total+=values[i]}}this.total=total;this.initTarget();this.radius=Math.floor(Math.min(this.canvasWidth,this.canvasHeight)/2)},getRegion:function(el,x,y){var shapeid=this.target.getShapeAt(el,x,y);return shapeid!==undefined&&this.shapes[shapeid]!==undefined?this.shapes[shapeid]:undefined},getCurrentRegionFields:function(){var currentRegion=this.currentRegion;return{isNull:this.values[currentRegion]===undefined,value:this.values[currentRegion],percent:this.values[currentRegion]/this.total*100,color:this.options.get("sliceColors")[currentRegion%this.options.get("sliceColors").length],offset:currentRegion}},changeHighlight:function(highlight){var currentRegion=this.currentRegion,newslice=this.renderSlice(currentRegion,highlight),shapeid=this.valueShapes[currentRegion];delete this.shapes[shapeid];this.target.replaceWithShape(shapeid,newslice);this.valueShapes[currentRegion]=newslice.id;this.shapes[newslice.id]=currentRegion},renderSlice:function(valuenum,highlight){var target=this.target,options=this.options,radius=this.radius,borderWidth=options.get("borderWidth"),offset=options.get("offset"),circle=2*Math.PI,values=this.values,total=this.total,next=offset?2*Math.PI*(offset/360):0,start,end,i,vlen,color;vlen=values.length;for(i=0;i<vlen;i++){start=next;end=next;if(total>0){end=next+circle*(values[i]/total)}if(valuenum===i){color=options.get("sliceColors")[i%options.get("sliceColors").length];if(highlight){color=this.calcHighlightColor(color,options)}return target.drawPieSlice(radius,radius,radius-borderWidth,start,end,undefined,color)}next=end}},render:function(){var target=this.target,values=this.values,options=this.options,radius=this.radius,borderWidth=options.get("borderWidth"),shape,i;if(!pie._super.render.call(this)){return}if(borderWidth){target.drawCircle(radius,radius,Math.floor(radius-borderWidth/2),options.get("borderColor"),undefined,borderWidth).append()}for(i=values.length;i--;){if(values[i]){shape=this.renderSlice(i).append();this.valueShapes[i]=shape.id;this.shapes[shape.id]=i}}target.render()}});$.fn.sparkline.box=box=createClass($.fn.sparkline._base,{type:"box",init:function(el,values,options,width,height){box._super.init.call(this,el,values,options,width,height);this.values=$.map(values,Number);this.width=options.get("width")==="auto"?"4.0em":width;this.initTarget();if(!this.values.length){this.disabled=1}},getRegion:function(){return 1},getCurrentRegionFields:function(){var result=[{field:"lq",value:this.quartiles[0]},{field:"med",value:this.quartiles[1]},{field:"uq",value:this.quartiles[2]}];if(this.loutlier!==undefined){result.push({field:"lo",value:this.loutlier})}if(this.routlier!==undefined){result.push({field:"ro",value:this.routlier})}if(this.lwhisker!==undefined){result.push({field:"lw",value:this.lwhisker})}if(this.rwhisker!==undefined){result.push({field:"rw",value:this.rwhisker})}return result},render:function(){var target=this.target,values=this.values,vlen=values.length,options=this.options,canvasWidth=this.canvasWidth,canvasHeight=this.canvasHeight,minValue=options.get("chartRangeMin")===undefined?Math.min.apply(Math,values):options.get("chartRangeMin"),maxValue=options.get("chartRangeMax")===undefined?Math.max.apply(Math,values):options.get("chartRangeMax"),canvasLeft=0,lwhisker,loutlier,iqr,q1,q2,q3,rwhisker,routlier,i,size,unitSize;if(!box._super.render.call(this)){return}if(options.get("raw")){if(options.get("showOutliers")&&values.length>5){loutlier=values[0];lwhisker=values[1];q1=values[2];q2=values[3];q3=values[4];rwhisker=values[5];routlier=values[6]}else{lwhisker=values[0];q1=values[1];q2=values[2];q3=values[3];rwhisker=values[4]}}else{values.sort(function(a,b){return a-b});q1=quartile(values,1);q2=quartile(values,2);q3=quartile(values,3);iqr=q3-q1;if(options.get("showOutliers")){lwhisker=rwhisker=undefined;for(i=0;i<vlen;i++){if(lwhisker===undefined&&values[i]>q1-iqr*options.get("outlierIQR")){lwhisker=values[i]}if(values[i]<q3+iqr*options.get("outlierIQR")){rwhisker=values[i]}}loutlier=values[0];routlier=values[vlen-1]}else{lwhisker=values[0];rwhisker=values[vlen-1]}}this.quartiles=[q1,q2,q3];this.lwhisker=lwhisker;this.rwhisker=rwhisker;this.loutlier=loutlier;this.routlier=routlier;unitSize=canvasWidth/(maxValue-minValue+1);if(options.get("showOutliers")){canvasLeft=Math.ceil(options.get("spotRadius"));canvasWidth-=2*Math.ceil(options.get("spotRadius"));unitSize=canvasWidth/(maxValue-minValue+1);if(loutlier<lwhisker){target.drawCircle((loutlier-minValue)*unitSize+canvasLeft,canvasHeight/2,options.get("spotRadius"),options.get("outlierLineColor"),options.get("outlierFillColor")).append()}if(routlier>rwhisker){target.drawCircle((routlier-minValue)*unitSize+canvasLeft,canvasHeight/2,options.get("spotRadius"),options.get("outlierLineColor"),options.get("outlierFillColor")).append()}}target.drawRect(Math.round((q1-minValue)*unitSize+canvasLeft),Math.round(canvasHeight*.1),Math.round((q3-q1)*unitSize),Math.round(canvasHeight*.8),options.get("boxLineColor"),options.get("boxFillColor")).append();target.drawLine(Math.round((lwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2),Math.round((q1-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2),options.get("lineColor")).append();target.drawLine(Math.round((lwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/4),Math.round((lwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight-canvasHeight/4),options.get("whiskerColor")).append();target.drawLine(Math.round((rwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2),Math.round((q3-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2),options.get("lineColor")).append();target.drawLine(Math.round((rwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/4),Math.round((rwhisker-minValue)*unitSize+canvasLeft),Math.round(canvasHeight-canvasHeight/4),options.get("whiskerColor")).append();target.drawLine(Math.round((q2-minValue)*unitSize+canvasLeft),Math.round(canvasHeight*.1),Math.round((q2-minValue)*unitSize+canvasLeft),Math.round(canvasHeight*.9),options.get("medianColor")).append();if(options.get("target")){size=Math.ceil(options.get("spotRadius"));target.drawLine(Math.round((options.get("target")-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2-size),Math.round((options.get("target")-minValue)*unitSize+canvasLeft),Math.round(canvasHeight/2+size),options.get("targetColor")).append();target.drawLine(Math.round((options.get("target")-minValue)*unitSize+canvasLeft-size),Math.round(canvasHeight/2),Math.round((options.get("target")-minValue)*unitSize+canvasLeft+size),Math.round(canvasHeight/2),options.get("targetColor")).append()}target.render()}});if($.browser.msie&&document.namespaces&&!document.namespaces.v){document.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML")}if($.browser.hasCanvas===undefined){$.browser.hasCanvas=document.createElement("canvas").getContext!==undefined}VShape=createClass({init:function(target,id,type,args){this.target=target;this.id=id;this.type=type;this.args=args},append:function(){this.target.appendShape(this);return this}});VCanvas_base=createClass({_pxregex:/(\d+)(px)?\s*$/i,init:function(width,height,target){if(!width){return}this.width=width;this.height=height;this.target=target;this.lastShapeId=null;if(target[0]){target=target[0]}$.data(target,"_jqs_vcanvas",this)},drawLine:function(x1,y1,x2,y2,lineColor,lineWidth){return this.drawShape([[x1,y1],[x2,y2]],lineColor,lineWidth)},drawShape:function(path,lineColor,fillColor,lineWidth){return this._genShape("Shape",[path,lineColor,fillColor,lineWidth])},drawCircle:function(x,y,radius,lineColor,fillColor,lineWidth){return this._genShape("Circle",[x,y,radius,lineColor,fillColor,lineWidth])},drawPieSlice:function(x,y,radius,startAngle,endAngle,lineColor,fillColor){return this._genShape("PieSlice",[x,y,radius,startAngle,endAngle,lineColor,fillColor])},drawRect:function(x,y,width,height,lineColor,fillColor){return this._genShape("Rect",[x,y,width,height,lineColor,fillColor])},getElement:function(){return this.canvas},getLastShapeId:function(){return this.lastShapeId},reset:function(){alert("reset not implemented")},_insert:function(el,target){$(target).html(el)},_calculatePixelDims:function(width,height,canvas){var match;match=this._pxregex.exec(height);if(match){this.pixelHeight=match[1]}else{this.pixelHeight=$(canvas).height()}match=this._pxregex.exec(width);if(match){this.pixelWidth=match[1]}else{this.pixelWidth=$(canvas).width()}},_genShape:function(shapetype,shapeargs){var id=shapeCount++;shapeargs.unshift(id);return new VShape(this,id,shapetype,shapeargs)},appendShape:function(shape){alert("appendShape not implemented")},replaceWithShape:function(shapeid,shape){alert("replaceWithShape not implemented")},insertAfterShape:function(shapeid,shape){alert("insertAfterShape not implemented")},removeShapeId:function(shapeid){alert("removeShapeId not implemented")},getShapeAt:function(el,x,y){alert("getShapeAt not implemented")},render:function(){alert("render not implemented")}});VCanvas_canvas=createClass(VCanvas_base,{init:function(width,height,target,interact){VCanvas_canvas._super.init.call(this,width,height,target);this.canvas=document.createElement("canvas");if(target[0]){target=target[0]}$.data(target,"_jqs_vcanvas",this);$(this.canvas).css({display:"inline-block",width:width,height:height,verticalAlign:"top"});this._insert(this.canvas,target);this._calculatePixelDims(width,height,this.canvas);this.canvas.width=this.pixelWidth;this.canvas.height=this.pixelHeight;this.interact=interact;this.shapes={};this.shapeseq=[];this.currentTargetShapeId=undefined;$(this.canvas).css({width:this.pixelWidth,height:this.pixelHeight})},_getContext:function(lineColor,fillColor,lineWidth){var context=this.canvas.getContext("2d");if(lineColor!==undefined){context.strokeStyle=lineColor}context.lineWidth=lineWidth===undefined?1:lineWidth;if(fillColor!==undefined){context.fillStyle=fillColor}return context},reset:function(){var context=this._getContext();context.clearRect(0,0,this.pixelWidth,this.pixelHeight);this.shapes={};this.shapeseq=[];this.currentTargetShapeId=undefined},_drawShape:function(shapeid,path,lineColor,fillColor,lineWidth){var context=this._getContext(lineColor,fillColor,lineWidth),i,plen;context.beginPath();context.moveTo(path[0][0]+.5,path[0][1]+.5);for(i=1,plen=path.length;i<plen;i++){context.lineTo(path[i][0]+.5,path[i][1]+.5)}if(lineColor!==undefined){context.stroke()}if(fillColor!==undefined){context.fill()}if(this.targetX!==undefined&&this.targetY!==undefined&&context.isPointInPath(this.targetX,this.targetY)){this.currentTargetShapeId=shapeid}},_drawCircle:function(shapeid,x,y,radius,lineColor,fillColor,lineWidth){var context=this._getContext(lineColor,fillColor,lineWidth);context.beginPath();context.arc(x,y,radius,0,2*Math.PI,false);if(this.targetX!==undefined&&this.targetY!==undefined&&context.isPointInPath(this.targetX,this.targetY)){this.currentTargetShapeId=shapeid}if(lineColor!==undefined){context.stroke()}if(fillColor!==undefined){context.fill()}},_drawPieSlice:function(shapeid,x,y,radius,startAngle,endAngle,lineColor,fillColor){var context=this._getContext(lineColor,fillColor);context.beginPath();context.moveTo(x,y);context.arc(x,y,radius,startAngle,endAngle,false);context.lineTo(x,y);context.closePath();if(lineColor!==undefined){context.stroke()}if(fillColor){context.fill()}if(this.targetX!==undefined&&this.targetY!==undefined&&context.isPointInPath(this.targetX,this.targetY)){this.currentTargetShapeId=shapeid}},_drawRect:function(shapeid,x,y,width,height,lineColor,fillColor){return this._drawShape(shapeid,[[x,y],[x+width,y],[x+width,y+height],[x,y+height],[x,y]],lineColor,fillColor)},appendShape:function(shape){this.shapes[shape.id]=shape;this.shapeseq.push(shape.id);this.lastShapeId=shape.id;return shape.id},replaceWithShape:function(shapeid,shape){var shapeseq=this.shapeseq,i;this.shapes[shape.id]=shape;for(i=shapeseq.length;i--;){if(shapeseq[i]==shapeid){shapeseq[i]=shape.id}}delete this.shapes[shapeid]},replaceWithShapes:function(shapeids,shapes){var shapeseq=this.shapeseq,shapemap={},sid,i,first;for(i=shapeids.length;i--;){shapemap[shapeids[i]]=true}for(i=shapeseq.length;i--;){sid=shapeseq[i];if(shapemap[sid]){shapeseq.splice(i,1);delete this.shapes[sid];first=i}}for(i=shapes.length;i--;){shapeseq.splice(first,0,shapes[i].id);this.shapes[shapes[i].id]=shapes[i]}},insertAfterShape:function(shapeid,shape){var shapeseq=this.shapeseq,i;for(i=shapeseq.length;i--;){if(shapeseq[i]===shapeid){shapeseq.splice(i+1,0,shape.id);this.shapes[shape.id]=shape;return}}},removeShapeId:function(shapeid){var shapeseq=this.shapeseq,i;for(i=shapeseq.length;i--;){if(shapeseq[i]===shapeid){shapeseq.splice(i,1);break}}delete this.shapes[shapeid]},getShapeAt:function(el,x,y){this.targetX=x;this.targetY=y;this.render();return this.currentTargetShapeId},render:function(){var shapeseq=this.shapeseq,shapes=this.shapes,shapeCount=shapeseq.length,context=this._getContext(),shapeid,shape,i;context.clearRect(0,0,this.pixelWidth,this.pixelHeight);for(i=0;i<shapeCount;i++){shapeid=shapeseq[i];shape=shapes[shapeid];this["_draw"+shape.type].apply(this,shape.args)}if(!this.interact){this.shapes={};this.shapeseq=[]}}});VCanvas_vml=createClass(VCanvas_base,{init:function(width,height,target){var groupel;VCanvas_vml._super.init.call(this,width,height,target);if(target[0]){target=target[0]}$.data(target,"_jqs_vcanvas",this);this.canvas=document.createElement("span");$(this.canvas).css({display:"inline-block",position:"relative",overflow:"hidden",width:width,height:height,margin:"0px",padding:"0px",verticalAlign:"top"});this._insert(this.canvas,target);this._calculatePixelDims(width,height,this.canvas);this.canvas.width=this.pixelWidth;this.canvas.height=this.pixelHeight;groupel='<v:group coordorigin="0 0" coordsize="'+this.pixelWidth+" "+this.pixelHeight+'"'+' style="position:absolute;top:0;left:0;width:'+this.pixelWidth+"px;height="+this.pixelHeight+'px;"></v:group>';this.canvas.insertAdjacentHTML("beforeEnd",groupel);this.group=$(this.canvas).children()[0];this.rendered=false;this.prerender=""},_drawShape:function(shapeid,path,lineColor,fillColor,lineWidth){var vpath=[],initial,stroke,fill,closed,vel,plen,i;for(i=0,plen=path.length;i<plen;i++){vpath[i]=""+path[i][0]+","+path[i][1]}initial=vpath.splice(0,1);lineWidth=lineWidth===undefined?1:lineWidth;stroke=lineColor===undefined?' stroked="false" ':' strokeWeight="'+lineWidth+'px" strokeColor="'+lineColor+'" ';fill=fillColor===undefined?' filled="false"':' fillColor="'+fillColor+'" filled="true" ';closed=vpath[0]===vpath[vpath.length-1]?"x ":"";vel='<v:shape coordorigin="0 0" coordsize="'+this.pixelWidth+" "+this.pixelHeight+'" '+' id="jqsshape'+shapeid+'" '+stroke+fill+' style="position:absolute;left:0px;top:0px;height:'+this.pixelHeight+"px;width:"+this.pixelWidth+'px;padding:0px;margin:0px;" '+' path="m '+initial+" l "+vpath.join(", ")+" "+closed+'e">'+" </v:shape>";return vel},_drawCircle:function(shapeid,x,y,radius,lineColor,fillColor,lineWidth){var stroke,fill,vel;x-=radius;y-=radius;stroke=lineColor===undefined?' stroked="false" ':' strokeWeight="'+lineWidth+'px" strokeColor="'+lineColor+'" ';fill=fillColor===undefined?' filled="false"':' fillColor="'+fillColor+'" filled="true" ';vel="<v:oval "+' id="jqsshape'+shapeid+'" '+stroke+fill+' style="position:absolute;top:'+y+"px; left:"+x+"px; width:"+radius*2+"px; height:"+radius*2+'px"></v:oval>';return vel},_drawPieSlice:function(shapeid,x,y,radius,startAngle,endAngle,lineColor,fillColor){var vpath,startx,starty,endx,endy,stroke,fill,vel;if(startAngle===endAngle){return}if(endAngle-startAngle===2*Math.PI){startAngle=0;endAngle=2*Math.PI}startx=x+Math.round(Math.cos(startAngle)*radius);starty=y+Math.round(Math.sin(startAngle)*radius);endx=x+Math.round(Math.cos(endAngle)*radius);endy=y+Math.round(Math.sin(endAngle)*radius);if(startx===endx&&starty===endy&&endAngle-startAngle<Math.PI){return}vpath=[x-radius,y-radius,x+radius,y+radius,startx,starty,endx,endy];stroke=lineColor===undefined?' stroked="false" ':' strokeWeight="1px" strokeColor="'+lineColor+'" ';fill=fillColor===undefined?' filled="false"':' fillColor="'+fillColor+'" filled="true" ';vel='<v:shape coordorigin="0 0" coordsize="'+this.pixelWidth+" "+this.pixelHeight+'" '+' id="jqsshape'+shapeid+'" '+stroke+fill+' style="position:absolute;left:0px;top:0px;height:'+this.pixelHeight+"px;width:"+this.pixelWidth+'px;padding:0px;margin:0px;" '+' path="m '+x+","+y+" wa "+vpath.join(", ")+' x e">'+" </v:shape>";return vel},_drawRect:function(shapeid,x,y,width,height,lineColor,fillColor){return this._drawShape(shapeid,[[x,y],[x,y+height],[x+width,y+height],[x+width,y],[x,y]],lineColor,fillColor)},reset:function(){this.group.innerHTML=""},appendShape:function(shape){var vel=this["_draw"+shape.type].apply(this,shape.args);if(this.rendered){this.group.insertAdjacentHTML("beforeEnd",vel)}else{this.prerender+=vel}this.lastShapeId=shape.id;return shape.id},replaceWithShape:function(shapeid,shape){var existing=$("#jqsshape"+shapeid),vel=this["_draw"+shape.type].apply(this,shape.args);existing[0].outerHTML=vel},replaceWithShapes:function(shapeids,shapes){var existing=$("#jqsshape"+shapeids[0]),replace="",slen=shapes.length,i;for(i=0;i<slen;i++){replace+=this["_draw"+shapes[i].type].apply(this,shapes[i].args)}existing[0].outerHTML=replace;for(i=1;i<shapeids.length;i++){$("#jqsshape"+shapeids[i]).remove()}},insertAfterShape:function(shapeid,shape){var existing=$("#jqsshape"+shapeid),vel=this["_draw"+shape.type].apply(this,shape.args);existing[0].insertAdjacentHTML("afterEnd",vel)},removeShapeId:function(shapeid){var existing=$("#jqsshape"+shapeid);this.group.removeChild(existing[0])},getShapeAt:function(el,x,y){var shapeid=el.id.substr(8);return shapeid},render:function(){if(!this.rendered){this.group.innerHTML=this.prerender;this.rendered=true}}})});var requirejs,require,define;(function(W){function D(b){return M.call(b)==="[object Function]"}function E(b){return M.call(b)==="[object Array]"}function t(b,c){if(b){var d;for(d=0;d<b.length;d+=1)if(b[d]&&c(b[d],d,b))break}}function N(b,c){if(b){var d;for(d=b.length-1;d>-1;d-=1)if(b[d]&&c(b[d],d,b))break}}function A(b,c){for(var d in b)if(b.hasOwnProperty(d)&&c(b[d],d))break}function O(b,c,d,g){c&&A(c,function(c,j){if(d||!F.call(b,j))g&&typeof c!=="string"?(b[j]||(b[j]={}),O(b[j],c,d,g)):b[j]=c});return b}function r(b,c){return function(){return c.apply(b,arguments)}}function X(b){if(!b)return b;var c=W;t(b.split("."),function(b){c=c[b]});return c}function G(b,c,d,g){c=Error(c+"\nhttp://requirejs.org/docs/errors.html#"+b);c.requireType=b;c.requireModules=g;if(d)c.originalError=d;return c}function ba(){if(H&&H.readyState==="interactive")return H;N(document.getElementsByTagName("script"),function(b){if(b.readyState==="interactive")return H=b});return H}var g,s,u,y,q,B,H,I,Y,Z,ca=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,da=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,$=/\.js$/,ea=/^\.\//;s=Object.prototype;
var M=s.toString,F=s.hasOwnProperty,fa=Array.prototype.splice,v=!!(typeof window!=="undefined"&&navigator&&document),aa=!v&&typeof importScripts!=="undefined",ga=v&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,R=typeof opera!=="undefined"&&opera.toString()==="[object Opera]",w={},n={},P=[],J=!1;if(typeof define==="undefined"){if(typeof requirejs!=="undefined"){if(D(requirejs))return;n=requirejs;requirejs=void 0}typeof require!=="undefined"&&!D(require)&&(n=require,require=void 0);g=requirejs=function(b,c,d,p){var i,j="_";!E(b)&&typeof b!=="string"&&(i=b,E(c)?(b=c,c=d,d=p):b=[]);if(i&&i.context)j=i.context;(p=w[j])||(p=w[j]=g.s.newContext(j));i&&p.configure(i);return p.require(b,c,d)};g.config=function(b){return g(b)};g.nextTick=typeof setTimeout!=="undefined"?function(b){setTimeout(b,4)}:function(b){b()};require||(require=g);g.version="2.1.1";g.jsExtRegExp=/^\/|:|\?|\.js$/;g.isBrowser=v;s=g.s={contexts:w,newContext:function(b){function c(a,f,x){var e,m,b,c,d,h,i,g=f&&f.split("/");e=g;var j=k.map,l=j&&j["*"];if(a&&a.charAt(0)===".")if(f){e=k.pkgs[f]?g=[f]:g.slice(0,g.length-1);f=a=e.concat(a.split("/"));for(e=0;f[e];e+=1)if(m=f[e],m===".")f.splice(e,1),e-=1;else if(m==="..")if(e===1&&(f[2]===".."||f[0]===".."))break;else e>0&&(f.splice(e-1,2),e-=2);e=k.pkgs[f=a[0]];a=a.join("/");e&&a===f+"/"+e.main&&(a=f)}else a.indexOf("./")===0&&(a=a.substring(2));if(x&&(g||l)&&j){f=a.split("/");for(e=f.length;e>0;e-=1){b=f.slice(0,e).join("/");if(g)for(m=g.length;m>0;m-=1)if(x=j[g.slice(0,m).join("/")])if(x=x[b]){c=x;d=e;break}if(c)break;!h&&l&&l[b]&&(h=l[b],i=e)}!c&&h&&(c=h,d=i);c&&(f.splice(0,d,c),a=f.join("/"))}return a}function d(a){v&&t(document.getElementsByTagName("script"),function(f){if(f.getAttribute("data-requiremodule")===a&&f.getAttribute("data-requirecontext")===h.contextName)return f.parentNode.removeChild(f),!0})}function p(a){var f=k.paths[a];if(f&&E(f)&&f.length>1)return d(a),f.shift(),h.require.undef(a),h.require([a]),!0}function i(a){var f,b=a?a.indexOf("!"):-1;b>-1&&(f=a.substring(0,b),a=a.substring(b+1,a.length));return[f,a]}function j(a,f,b,e){var m,K,d=null,g=f?f.name:null,j=a,l=!0,k="";a||(l=!1,a="_@r"+(M+=1));a=i(a);d=a[0];a=a[1];d&&(d=c(d,g,e),K=o[d]);a&&(d?k=K&&K.normalize?K.normalize(a,function(a){return c(a,g,e)}):c(a,g,e):(k=c(a,g,e),a=i(k),d=a[0],k=a[1],b=!0,m=h.nameToUrl(k)));b=d&&!K&&!b?"_unnormalized"+(N+=1):"";return{prefix:d,name:k,parentMap:f,unnormalized:!!b,url:m,originalName:j,isDefine:l,id:(d?d+"!"+k:k)+b}}function n(a){var f=a.id,b=l[f];b||(b=l[f]=new h.Module(a));return b}function q(a,f,b){var e=a.id,m=l[e];if(F.call(o,e)&&(!m||m.defineEmitComplete))f==="defined"&&b(o[e]);else n(a).on(f,b)}function z(a,f){var b=a.requireModules,e=!1;if(f)f(a);else if(t(b,function(f){if(f=l[f])f.error=a,f.events.error&&(e=!0,f.emit("error",a))}),!e)g.onError(a)}function s(){P.length&&(fa.apply(C,[C.length-1,0].concat(P)),P=[])}function u(a,f,b){var e=a.map.id;a.error?a.emit("error",a.error):(f[e]=!0,t(a.depMaps,function(e,c){var d=e.id,g=l[d];g&&!a.depMatched[c]&&!b[d]&&(f[d]?(a.defineDep(c,o[d]),a.check()):u(g,f,b))}),b[e]=!0)}function w(){var a,f,b,e,m=(b=k.waitSeconds*1e3)&&h.startTime+b<(new Date).getTime(),c=[],g=[],i=!1,j=!0;if(!S){S=!0;A(l,function(b){a=b.map;f=a.id;if(b.enabled&&(a.isDefine||g.push(b),!b.error))if(!b.inited&&m)p(f)?i=e=!0:(c.push(f),d(f));else if(!b.inited&&b.fetched&&a.isDefine&&(i=!0,!a.prefix))return j=!1});if(m&&c.length)return b=G("timeout","Load timeout for modules: "+c,null,c),b.contextName=h.contextName,z(b);j&&t(g,function(a){u(a,{},{})});if((!m||e)&&i)if((v||aa)&&!T)T=setTimeout(function(){T=0;w()},50);S=!1}}function y(a){n(j(a[0],null,!0)).init(a[1],a[2])}function B(a){var a=a.currentTarget||a.srcElement,b=h.onScriptLoad;a.detachEvent&&!R?a.detachEvent("onreadystatechange",b):a.removeEventListener("load",b,!1);b=h.onScriptError;a.detachEvent&&!R||a.removeEventListener("error",b,!1);return{node:a,id:a&&a.getAttribute("data-requiremodule")}}function I(){var a;for(s();C.length;)if(a=C.shift(),a[0]===null)return z(G("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));else y(a)}var S,U,h,L,T,k={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},shim:{},map:{},config:{}},l={},V={},C=[],o={},Q={},M=1,N=1;L={require:function(a){return a.require?a.require:a.require=h.makeRequire(a.map)},exports:function(a){a.usingExports=!0;if(a.map.isDefine)return a.exports?a.exports:a.exports=o[a.map.id]={}},module:function(a){return a.module?a.module:a.module={id:a.map.id,uri:a.map.url,config:function(){return k.config&&k.config[a.map.id]||{}},exports:o[a.map.id]}}};U=function(a){this.events=V[a.id]||{};this.map=a;this.shim=k.shim[a.id];this.depExports=[];this.depMaps=[];this.depMatched=[];this.pluginMaps={};this.depCount=0};U.prototype={init:function(a,b,c,e){e=e||{};if(!this.inited){this.factory=b;if(c)this.on("error",c);else this.events.error&&(c=r(this,function(a){this.emit("error",a)}));this.depMaps=a&&a.slice(0);this.errback=c;this.inited=!0;this.ignore=e.ignore;e.enabled||this.enabled?this.enable():this.check()}},defineDep:function(a,b){this.depMatched[a]||(this.depMatched[a]=!0,this.depCount-=1,this.depExports[a]=b)},fetch:function(){if(!this.fetched){this.fetched=!0;h.startTime=(new Date).getTime();var a=this.map;if(this.shim)h.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],r(this,function(){return a.prefix?this.callPlugin():this.load()}));else return a.prefix?this.callPlugin():this.load()}},load:function(){var a=this.map.url;Q[a]||(Q[a]=!0,h.load(this.map.id,a))},check:function(){if(this.enabled&&!this.enabling){var a,b,c=this.map.id;b=this.depExports;var e=this.exports,m=this.factory;if(this.inited)if(this.error)this.emit("error",this.error);else{if(!this.defining){this.defining=!0;if(this.depCount<1&&!this.defined){if(D(m)){if(this.events.error)try{e=h.execCb(c,m,b,e)}catch(d){a=d}else e=h.execCb(c,m,b,e);if(this.map.isDefine)if((b=this.module)&&b.exports!==void 0&&b.exports!==this.exports)e=b.exports;else if(e===void 0&&this.usingExports)e=this.exports;if(a)return a.requireMap=this.map,a.requireModules=[this.map.id],a.requireType="define",z(this.error=a)}else e=m;this.exports=e;if(this.map.isDefine&&!this.ignore&&(o[c]=e,g.onResourceLoad))g.onResourceLoad(h,this.map,this.depMaps);delete l[c];this.defined=!0}this.defining=!1;if(this.defined&&!this.defineEmitted)this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0}}else this.fetch()}},callPlugin:function(){var a=this.map,b=a.id,d=j(a.prefix);this.depMaps.push(d);q(d,"defined",r(this,function(e){var m,d;d=this.map.name;var x=this.map.parentMap?this.map.parentMap.name:null,i=h.makeRequire(a.parentMap,{enableBuildCallback:!0,skipMap:!0});if(this.map.unnormalized){if(e.normalize&&(d=e.normalize(d,function(a){return c(a,x,!0)})||""),e=j(a.prefix+"!"+d,this.map.parentMap),q(e,"defined",r(this,function(a){this.init([],function(){return a},null,{enabled:!0,ignore:!0})})),d=l[e.id]){this.depMaps.push(e);if(this.events.error)d.on("error",r(this,function(a){this.emit("error",a)}));d.enable()}}else m=r(this,function(a){this.init([],function(){return a},null,{enabled:!0})}),m.error=r(this,function(a){this.inited=!0;this.error=a;a.requireModules=[b];A(l,function(a){a.map.id.indexOf(b+"_unnormalized")===0&&delete l[a.map.id]});z(a)}),m.fromText=r(this,function(b,e){var f=a.name,c=j(f),d=J;e&&(b=e);d&&(J=!1);n(c);try{g.exec(b)}catch(x){throw Error("fromText eval for "+f+" failed: "+x)}d&&(J=!0);this.depMaps.push(c);h.completeLoad(f);i([f],m)}),e.load(a.name,i,m,k)}));h.enable(d,this);this.pluginMaps[d.id]=d},enable:function(){this.enabling=this.enabled=!0;t(this.depMaps,r(this,function(a,b){var c,e;if(typeof a==="string"){a=j(a,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap);this.depMaps[b]=a;if(c=L[a.id]){this.depExports[b]=c(this);return}this.depCount+=1;q(a,"defined",r(this,function(a){this.defineDep(b,a);this.check()}));this.errback&&q(a,"error",this.errback)}c=a.id;e=l[c];!L[c]&&e&&!e.enabled&&h.enable(a,this)}));A(this.pluginMaps,r(this,function(a){var b=l[a.id];b&&!b.enabled&&h.enable(a,this)}));this.enabling=!1;this.check()},on:function(a,b){var c=this.events[a];c||(c=this.events[a]=[]);c.push(b)},emit:function(a,b){t(this.events[a],function(a){a(b)});a==="error"&&delete this.events[a]}};h={config:k,contextName:b,registry:l,defined:o,urlFetched:Q,defQueue:C,Module:U,makeModuleMap:j,nextTick:g.nextTick,configure:function(a){a.baseUrl&&a.baseUrl.charAt(a.baseUrl.length-1)!=="/"&&(a.baseUrl+="/");var b=k.pkgs,c=k.shim,e={paths:!0,config:!0,map:!0};A(a,function(a,b){e[b]?b==="map"?O(k[b],a,!0,!0):O(k[b],a,!0):k[b]=a});if(a.shim)A(a.shim,function(a,b){E(a)&&(a={deps:a});if(a.exports&&!a.exportsFn)a.exportsFn=h.makeShimExports(a);c[b]=a}),k.shim=c;if(a.packages)t(a.packages,function(a){a=typeof a==="string"?{name:a}:a;b[a.name]={name:a.name,location:a.location||a.name,main:(a.main||"main").replace(ea,"").replace($,"")}}),k.pkgs=b;A(l,function(a,b){if(!a.inited&&!a.map.unnormalized)a.map=j(b)});if(a.deps||a.callback)h.require(a.deps||[],a.callback)},makeShimExports:function(a){return function(){var b;a.init&&(b=a.init.apply(W,arguments));return b||X(a.exports)}},makeRequire:function(a,f){function d(e,c,i){var k,p;if(f.enableBuildCallback&&c&&D(c))c.__requireJsBuild=!0;if(typeof e==="string"){if(D(c))return z(G("requireargs","Invalid require call"),i);if(a&&L[e])return L[e](l[a.id]);if(g.get)return g.get(h,e,a);k=j(e,a,!1,!0);k=k.id;return!F.call(o,k)?z(G("notloaded",'Module name "'+k+'" has not been loaded yet for context: '+b+(a?"":". Use require([])"))):o[k]}I();h.nextTick(function(){I();p=n(j(null,a));p.skipMap=f.skipMap;p.init(e,c,i,{enabled:!0});w()});return d}f=f||{};O(d,{isBrowser:v,toUrl:function(b){var d=b.lastIndexOf("."),f=null;d!==-1&&(f=b.substring(d,b.length),b=b.substring(0,d));return h.nameToUrl(c(b,a&&a.id,!0),f)},defined:function(b){b=j(b,a,!1,!0).id;return F.call(o,b)},specified:function(b){b=j(b,a,!1,!0).id;return F.call(o,b)||F.call(l,b)}});if(!a)d.undef=function(b){s();var c=j(b,a,!0),d=l[b];delete o[b];delete Q[c.url];delete V[b];if(d){if(d.events.defined)V[b]=d.events;delete l[b]}};return d},enable:function(a){l[a.id]&&n(a).enable()},completeLoad:function(a){var b,c,d=k.shim[a]||{},g=d.exports;for(s();C.length;){c=C.shift();if(c[0]===null){c[0]=a;if(b)break;b=!0}else c[0]===a&&(b=!0);y(c)}c=l[a];if(!b&&!o[a]&&c&&!c.inited)if(k.enforceDefine&&(!g||!X(g)))if(p(a))return;else return z(G("nodefine","No define call for "+a,null,[a]));else y([a,d.deps||[],d.exportsFn]);w()},nameToUrl:function(a,b){var c,d,i,h,j,l;if(g.jsExtRegExp.test(a))h=a+(b||"");else{c=k.paths;d=k.pkgs;h=a.split("/");for(j=h.length;j>0;j-=1)if(l=h.slice(0,j).join("/"),i=d[l],l=c[l]){E(l)&&(l=l[0]);h.splice(0,j,l);break}else if(i){c=a===i.name?i.location+"/"+i.main:i.location;h.splice(0,j,c);break}h=h.join("/");h+=b||(/\?/.test(h)?"":".js");h=(h.charAt(0)==="/"||h.match(/^[\w\+\.\-]+:/)?"":k.baseUrl)+h}return k.urlArgs?h+((h.indexOf("?")===-1?"?":"&")+k.urlArgs):h},load:function(a,b){g.load(h,a,b)},execCb:function(a,b,c,d){return b.apply(d,c)},onScriptLoad:function(a){if(a.type==="load"||ga.test((a.currentTarget||a.srcElement).readyState))H=null,a=B(a),h.completeLoad(a.id)},onScriptError:function(a){var b=B(a);if(!p(b.id))return z(G("scripterror","Script error",a,[b.id]))}};h.require=h.makeRequire();return h}};g({});t(["toUrl","undef","defined","specified"],function(b){g[b]=function(){var c=w._;return c.require[b].apply(c,arguments)}});if(v&&(u=s.head=document.getElementsByTagName("head")[0],y=document.getElementsByTagName("base")[0]))u=s.head=y.parentNode;g.onError=function(b){throw b};g.load=function(b,c,d){var g=b&&b.config||{},i;if(v)return i=g.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),i.type=g.scriptType||"text/javascript",i.charset="utf-8",i.async=!0,i.setAttribute("data-requirecontext",b.contextName),i.setAttribute("data-requiremodule",c),i.attachEvent&&!(i.attachEvent.toString&&i.attachEvent.toString().indexOf("[native code")<0)&&!R?(J=!0,i.attachEvent("onreadystatechange",b.onScriptLoad)):(i.addEventListener("load",b.onScriptLoad,!1),i.addEventListener("error",b.onScriptError,!1)),i.src=d,I=i,y?u.insertBefore(i,y):u.appendChild(i),I=null,i;else aa&&(importScripts(d),b.completeLoad(c))};v&&N(document.getElementsByTagName("script"),function(b){if(!u)u=b.parentNode;if(q=b.getAttribute("data-main")){if(!n.baseUrl)B=q.split("/"),Y=B.pop(),Z=B.length?B.join("/")+"/":"./",n.baseUrl=Z,q=Y;q=q.replace($,"");n.deps=n.deps?n.deps.concat(q):[q];return!0}});define=function(b,c,d){var g,i;typeof b!=="string"&&(d=c,c=b,b=null);E(c)||(d=c,c=[]);!c.length&&D(d)&&d.length&&(d.toString().replace(ca,"").replace(da,function(b,d){c.push(d)}),c=(d.length===1?["require"]:["require","exports","module"]).concat(c));if(J&&(g=I||ba()))b||(b=g.getAttribute("data-requiremodule")),i=w[g.getAttribute("data-requirecontext")];(i?i.defQueue:P).push([b,c,d])};define.amd={jQuery:!0};g.exec=function(b){return eval(b)};g(n)}})(this);(function(b){var m,t,u,f,D,j,E,n,z,A,q=0,e={},o=[],p=0,d={},l=[],G=null,v=new Image,J=/\.(jpg|gif|png|bmp|jpeg)(.*)?$/i,W=/[^\.]\.(swf)\s*$/i,K,L=1,y=0,s="",r,i,h=false,B=b.extend(b("<div/>")[0],{prop:0}),M=b.browser.msie&&b.browser.version<7&&!window.XMLHttpRequest,N=function(){t.hide();v.onerror=v.onload=null;G&&G.abort();m.empty()},O=function(){if(false===e.onError(o,q,e)){t.hide();h=false}else{e.titleShow=false;e.width="auto";e.height="auto";m.html('<p id="fancybox-error">The requested content cannot be loaded.<br />Please try again later.</p>');F()}},I=function(){var a=o[q],c,g,k,C,P,w;N();e=b.extend({},b.fn.fancybox.defaults,typeof b(a).data("fancybox")=="undefined"?e:b(a).data("fancybox"));w=e.onStart(o,q,e);if(w===false)h=false;else{if(typeof w=="object")e=b.extend(e,w);k=e.title||(a.nodeName?b(a).attr("title"):a.title)||"";if(a.nodeName&&!e.orig)e.orig=b(a).children("img:first").length?b(a).children("img:first"):b(a);if(k===""&&e.orig&&e.titleFromAlt)k=e.orig.attr("alt");c=e.href||(a.nodeName?b(a).attr("href"):a.href)||null;if(/^(?:javascript)/i.test(c)||c=="#")c=null;if(e.type){g=e.type;if(!c)c=e.content}else if(e.content)g="html";else if(c)g=c.match(J)?"image":c.match(W)?"swf":b(a).hasClass("iframe")?"iframe":c.indexOf("#")===0?"inline":"ajax";if(g){if(g=="inline"){a=c.substr(c.indexOf("#"));g=b(a).length>0?"inline":"ajax"}e.type=g;e.href=c;e.title=k;if(e.autoDimensions)if(e.type=="html"||e.type=="inline"||e.type=="ajax"){e.width="auto";e.height="auto"}else e.autoDimensions=false;if(e.modal){e.overlayShow=true;e.hideOnOverlayClick=false;e.hideOnContentClick=false;e.enableEscapeButton=false;e.showCloseButton=false}e.padding=parseInt(e.padding,10);e.margin=parseInt(e.margin,10);m.css("padding",e.padding+e.margin);b(".fancybox-inline-tmp").unbind("fancybox-cancel").bind("fancybox-change",function(){b(this).replaceWith(j.children())});switch(g){case"html":m.html(e.content);F();break;case"inline":if(b(a).parent().is("#fancybox-content")===true){h=false;break}b('<div class="fancybox-inline-tmp" />').hide().insertBefore(b(a)).bind("fancybox-cleanup",function(){b(this).replaceWith(j.children())}).bind("fancybox-cancel",function(){b(this).replaceWith(m.children())});b(a).appendTo(m);F();break;case"image":h=false;b.fancybox.showActivity();v=new Image;v.onerror=function(){O()};v.onload=function(){h=true;v.onerror=v.onload=null;e.width=v.width;e.height=v.height;b("<img />").attr({id:"fancybox-img",src:v.src,alt:e.title}).appendTo(m);Q()};v.src=c;break;case"swf":e.scrolling="no";C='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+e.width+'" height="'+e.height+'"><param name="movie" value="'+c+'"></param>';P="";b.each(e.swf,function(x,H){C+='<param name="'+x+'" value="'+H+'"></param>';P+=" "+x+'="'+H+'"'});C+='<embed src="'+c+'" type="application/x-shockwave-flash" width="'+e.width+'" height="'+e.height+'"'+P+"></embed></object>";m.html(C);F();break;case"ajax":h=false;b.fancybox.showActivity();e.ajax.win=e.ajax.success;G=b.ajax(b.extend({},e.ajax,{url:c,data:e.ajax.data||{},error:function(x){x.status>0&&O()},success:function(x,H,R){if((typeof R=="object"?R:G).status==200){if(typeof e.ajax.win=="function"){w=e.ajax.win(c,x,H,R);if(w===false){t.hide();return}else if(typeof w=="string"||typeof w=="object")x=w}m.html(x);F()}}}));break;case"iframe":Q()}}else O()}},F=function(){var a=e.width,c=e.height;a=a.toString().indexOf("%")>-1?parseInt((b(window).width()-e.margin*2)*parseFloat(a)/100,10)+"px":a=="auto"?"auto":a+"px";c=c.toString().indexOf("%")>-1?parseInt((b(window).height()-e.margin*2)*parseFloat(c)/100,10)+"px":c=="auto"?"auto":c+"px";m.wrapInner('<div style="width:'+a+";height:"+c+";overflow: "+(e.scrolling=="auto"?"auto":e.scrolling=="yes"?"scroll":"hidden")+';position:relative;"></div>');e.width=m.width();e.height=m.height();Q()},Q=function(){var a,c;t.hide();if(f.is(":visible")&&false===d.onCleanup(l,p,d)){b.event.trigger("fancybox-cancel");h=false}else{h=true;b(j.add(u)).unbind();b(window).unbind("resize.fb scroll.fb");b(document).unbind("keydown.fb");f.is(":visible")&&d.titlePosition!=="outside"&&f.css("height",f.height());l=o;p=q;d=e;if(d.overlayShow){u.css({"background-color":d.overlayColor,opacity:d.overlayOpacity,cursor:d.hideOnOverlayClick?"pointer":"auto",height:b(document).height()});if(!u.is(":visible")){M&&b("select:not(#fancybox-tmp select)").filter(function(){return this.style.visibility!=="hidden"}).css({visibility:"hidden"}).one("fancybox-cleanup",function(){this.style.visibility="inherit"});u.show()}}else u.hide();i=X();s=d.title||"";y=0;n.empty().removeAttr("style").removeClass();if(d.titleShow!==false){if(b.isFunction(d.titleFormat))a=d.titleFormat(s,l,p,d);else a=s&&s.length?d.titlePosition=="float"?'<table id="fancybox-title-float-wrap" cellpadding="0" cellspacing="0"><tr><td id="fancybox-title-float-left"></td><td id="fancybox-title-float-main">'+s+'</td><td id="fancybox-title-float-right"></td></tr></table>':'<div id="fancybox-title-'+d.titlePosition+'">'+s+"</div>":false;s=a;if(!(!s||s==="")){n.addClass("fancybox-title-"+d.titlePosition).html(s).appendTo("body").show();switch(d.titlePosition){case"inside":n.css({width:i.width-d.padding*2,marginLeft:d.padding,marginRight:d.padding});y=n.outerHeight(true);n.appendTo(D);i.height+=y;break;case"over":n.css({marginLeft:d.padding,width:i.width-d.padding*2,bottom:d.padding}).appendTo(D);break;case"float":n.css("left",parseInt((n.width()-i.width-40)/2,10)*-1).appendTo(f);break;default:n.css({width:i.width-d.padding*2,paddingLeft:d.padding,paddingRight:d.padding}).appendTo(f)}}}n.hide();if(f.is(":visible")){b(E.add(z).add(A)).hide();a=f.position();r={top:a.top,left:a.left,width:f.width(),height:f.height()};c=r.width==i.width&&r.height==i.height;j.fadeTo(d.changeFade,.3,function(){var g=function(){j.html(m.contents()).fadeTo(d.changeFade,1,S)};b.event.trigger("fancybox-change");j.empty().removeAttr("filter").css({"border-width":d.padding,width:i.width-d.padding*2,height:e.autoDimensions?"auto":i.height-y-d.padding*2});if(c)g();else{B.prop=0;b(B).animate({prop:1},{duration:d.changeSpeed,easing:d.easingChange,step:T,complete:g})}})}else{f.removeAttr("style");j.css("border-width",d.padding);if(d.transitionIn=="elastic"){r=V();j.html(m.contents());f.show();if(d.opacity)i.opacity=0;B.prop=0;b(B).animate({prop:1},{duration:d.speedIn,easing:d.easingIn,step:T,complete:S})}else{d.titlePosition=="inside"&&y>0&&n.show();j.css({width:i.width-d.padding*2,height:e.autoDimensions?"auto":i.height-y-d.padding*2}).html(m.contents());f.css(i).fadeIn(d.transitionIn=="none"?0:d.speedIn,S)}}}},Y=function(){if(d.enableEscapeButton||d.enableKeyboardNav)b(document).bind("keydown.fb",function(a){if(a.keyCode==27&&d.enableEscapeButton){a.preventDefault();b.fancybox.close()}else if((a.keyCode==37||a.keyCode==39)&&d.enableKeyboardNav&&a.target.tagName!=="INPUT"&&a.target.tagName!=="TEXTAREA"&&a.target.tagName!=="SELECT"){a.preventDefault();b.fancybox[a.keyCode==37?"prev":"next"]()}});if(d.showNavArrows){if(d.cyclic&&l.length>1||p!==0)z.show();if(d.cyclic&&l.length>1||p!=l.length-1)A.show()}else{z.hide();A.hide()}},S=function(){if(!b.support.opacity){j.get(0).style.removeAttribute("filter");f.get(0).style.removeAttribute("filter")}e.autoDimensions&&j.css("height","auto");f.css("height","auto");s&&s.length&&n.show();d.showCloseButton&&E.show();Y();d.hideOnContentClick&&j.bind("click",b.fancybox.close);d.hideOnOverlayClick&&u.bind("click",b.fancybox.close);b(window).bind("resize.fb",b.fancybox.resize);d.centerOnScroll&&b(window).bind("scroll.fb",b.fancybox.center);if(d.type=="iframe")b('<iframe id="fancybox-frame" name="fancybox-frame'+(new Date).getTime()+'" frameborder="0" hspace="0" '+(b.browser.msie?'allowtransparency="true""':"")+' scrolling="'+e.scrolling+'" src="'+d.href+'"></iframe>').appendTo(j);f.show();h=false;b.fancybox.center();d.onComplete(l,p,d);var a,c;if(l.length-1>p){a=l[p+1].href;if(typeof a!=="undefined"&&a.match(J)){c=new Image;c.src=a}}if(p>0){a=l[p-1].href;if(typeof a!=="undefined"&&a.match(J)){c=new Image;c.src=a}}},T=function(a){var c={width:parseInt(r.width+(i.width-r.width)*a,10),height:parseInt(r.height+(i.height-r.height)*a,10),top:parseInt(r.top+(i.top-r.top)*a,10),left:parseInt(r.left+(i.left-r.left)*a,10)};if(typeof i.opacity!=="undefined")c.opacity=a<.5?.5:a;f.css(c);j.css({width:c.width-d.padding*2,height:c.height-y*a-d.padding*2})},U=function(){return[b(window).width()-d.margin*2,b(window).height()-d.margin*2,b(document).scrollLeft()+d.margin,b(document).scrollTop()+d.margin]},X=function(){var a=U(),c={},g=d.autoScale,k=d.padding*2;c.width=d.width.toString().indexOf("%")>-1?parseInt(a[0]*parseFloat(d.width)/100,10):d.width+k;c.height=d.height.toString().indexOf("%")>-1?parseInt(a[1]*parseFloat(d.height)/100,10):d.height+k;if(g&&(c.width>a[0]||c.height>a[1]))if(e.type=="image"||e.type=="swf"){g=d.width/d.height;if(c.width>a[0]){c.width=a[0];c.height=parseInt((c.width-k)/g+k,10)}if(c.height>a[1]){c.height=a[1];c.width=parseInt((c.height-k)*g+k,10)}}else{c.width=Math.min(c.width,a[0]);c.height=Math.min(c.height,a[1])}c.top=parseInt(Math.max(a[3]-20,a[3]+(a[1]-c.height-40)*.5),10);c.left=parseInt(Math.max(a[2]-20,a[2]+(a[0]-c.width-40)*.5),10);return c},V=function(){var a=e.orig?b(e.orig):false,c={};if(a&&a.length){c=a.offset();c.top+=parseInt(a.css("paddingTop"),10)||0;c.left+=parseInt(a.css("paddingLeft"),10)||0;c.top+=parseInt(a.css("border-top-width"),10)||0;c.left+=parseInt(a.css("border-left-width"),10)||0;c.width=a.width();c.height=a.height();c={width:c.width+d.padding*2,height:c.height+d.padding*2,top:c.top-d.padding-20,left:c.left-d.padding-20}}else{a=U();c={width:d.padding*2,height:d.padding*2,top:parseInt(a[3]+a[1]*.5,10),left:parseInt(a[2]+a[0]*.5,10)}}return c},Z=function(){if(t.is(":visible")){b("div",t).css("top",L*-40+"px");L=(L+1)%12}else clearInterval(K)};b.fn.fancybox=function(a){if(!b(this).length)return this;b(this).data("fancybox",b.extend({},a,b.metadata?b(this).metadata():{})).unbind("click.fb").bind("click.fb",function(c){c.preventDefault();if(!h){h=true;b(this).blur();o=[];q=0;c=b(this).attr("rel")||"";if(!c||c==""||c==="nofollow")o.push(this);else{o=b("a[rel="+c+"], area[rel="+c+"]");q=o.index(this)}I()}});return this};b.fancybox=function(a,c){var g;if(!h){h=true;g=typeof c!=="undefined"?c:{};o=[];q=parseInt(g.index,10)||0;if(b.isArray(a)){for(var k=0,C=a.length;k<C;k++)if(typeof a[k]=="object")b(a[k]).data("fancybox",b.extend({},g,a[k]));else a[k]=b({}).data("fancybox",b.extend({content:a[k]},g));o=jQuery.merge(o,a)}else{if(typeof a=="object")b(a).data("fancybox",b.extend({},g,a));else a=b({}).data("fancybox",b.extend({content:a},g));o.push(a)}if(q>o.length||q<0)q=0;I()}};b.fancybox.showActivity=function(){clearInterval(K);t.show();K=setInterval(Z,66)};b.fancybox.hideActivity=function(){t.hide()};b.fancybox.next=function(){return b.fancybox.pos(p+1)};b.fancybox.prev=function(){return b.fancybox.pos(p-1)};b.fancybox.pos=function(a){if(!h){a=parseInt(a);o=l;if(a>-1&&a<l.length){q=a;I()}else if(d.cyclic&&l.length>1){q=a>=l.length?0:l.length-1;I()}}};b.fancybox.cancel=function(){if(!h){h=true;b.event.trigger("fancybox-cancel");N();e.onCancel(o,q,e);h=false}};b.fancybox.close=function(){function a(){u.fadeOut("fast");n.empty().hide();f.hide();b.event.trigger("fancybox-cleanup");j.empty();d.onClosed(l,p,d);l=e=[];p=q=0;d=e={};h=false}if(!(h||f.is(":hidden"))){h=true;if(d&&false===d.onCleanup(l,p,d))h=false;else{N();b(E.add(z).add(A)).hide();b(j.add(u)).unbind();b(window).unbind("resize.fb scroll.fb");b(document).unbind("keydown.fb");j.find("iframe").attr("src",M&&/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank");d.titlePosition!=="inside"&&n.empty();f.stop();if(d.transitionOut=="elastic"){r=V();var c=f.position();i={top:c.top,left:c.left,width:f.width(),height:f.height()};if(d.opacity)i.opacity=1;n.empty().hide();B.prop=1;b(B).animate({prop:0},{duration:d.speedOut,easing:d.easingOut,step:T,complete:a})}else f.fadeOut(d.transitionOut=="none"?0:d.speedOut,a)}}};b.fancybox.resize=function(){u.is(":visible")&&u.css("height",b(document).height());b.fancybox.center(true)};b.fancybox.center=function(a){var c,g;if(!h){g=a===true?1:0;c=U();!g&&(f.width()>c[0]||f.height()>c[1])||f.stop().animate({top:parseInt(Math.max(c[3]-20,c[3]+(c[1]-j.height()-40)*.5-d.padding)),left:parseInt(Math.max(c[2]-20,c[2]+(c[0]-j.width()-40)*.5-d.padding))},typeof a=="number"?a:200)}};b.fancybox.init=function(){if(!b("#fancybox-wrap").length){b("body").append(m=b('<div id="fancybox-tmp"></div>'),t=b('<div id="fancybox-loading"><div></div></div>'),u=b('<div id="fancybox-overlay"></div>'),f=b('<div id="fancybox-wrap"></div>'));D=b('<div id="fancybox-outer"></div>').append('<div class="fancybox-bg" id="fancybox-bg-n"></div><div class="fancybox-bg" id="fancybox-bg-ne"></div><div class="fancybox-bg" id="fancybox-bg-e"></div><div class="fancybox-bg" id="fancybox-bg-se"></div><div class="fancybox-bg" id="fancybox-bg-s"></div><div class="fancybox-bg" id="fancybox-bg-sw"></div><div class="fancybox-bg" id="fancybox-bg-w"></div><div class="fancybox-bg" id="fancybox-bg-nw"></div>').appendTo(f);D.append(j=b('<div id="fancybox-content"></div>'),E=b('<a id="fancybox-close"></a>'),n=b('<div id="fancybox-title"></div>'),z=b('<a href="javascript:;" id="fancybox-left"><span class="fancy-ico" id="fancybox-left-ico"></span></a>'),A=b('<a href="javascript:;" id="fancybox-right"><span class="fancy-ico" id="fancybox-right-ico"></span></a>'));E.click(b.fancybox.close);t.click(b.fancybox.cancel);z.click(function(a){a.preventDefault();b.fancybox.prev()});A.click(function(a){a.preventDefault();b.fancybox.next()});b.fn.mousewheel&&f.bind("mousewheel.fb",function(a,c){if(h)a.preventDefault();else if(b(a.target).get(0).clientHeight==0||b(a.target).get(0).scrollHeight===b(a.target).get(0).clientHeight){a.preventDefault();b.fancybox[c>0?"prev":"next"]()}});b.support.opacity||f.addClass("fancybox-ie");if(M){t.addClass("fancybox-ie6");f.addClass("fancybox-ie6");b('<iframe id="fancybox-hide-sel-frame" src="'+(/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank")+'" scrolling="no" border="0" frameborder="0" tabindex="-1"></iframe>').prependTo(D)}}};b.fn.fancybox.defaults={padding:10,margin:40,opacity:false,modal:false,cyclic:false,scrolling:"auto",width:560,height:340,autoScale:true,autoDimensions:true,centerOnScroll:false,ajax:{},swf:{wmode:"transparent"},hideOnOverlayClick:true,hideOnContentClick:false,overlayShow:true,overlayOpacity:.7,overlayColor:"#777",titleShow:true,titlePosition:"float",titleFormat:null,titleFromAlt:false,transitionIn:"fade",transitionOut:"fade",speedIn:300,speedOut:300,changeSpeed:300,changeFade:"fast",easingIn:"swing",easingOut:"swing",showCloseButton:true,showNavArrows:true,enableEscapeButton:true,enableKeyboardNav:true,onStart:function(){},onCancel:function(){},onComplete:function(){},onCleanup:function(){},onClosed:function(){},onError:function(){}};b(document).ready(function(){b.fancybox.init()})})(jQuery);(function(a){a.fn.mask=function(c,b){a(this).each(function(){if(b!==undefined&&b>0){var d=a(this);d.data("_mask_timeout",setTimeout(function(){a.maskElement(d,c)},b))}else{a.maskElement(a(this),c)}})};a.fn.unmask=function(){a(this).each(function(){a.unmaskElement(a(this))})};a.fn.isMasked=function(){return this.hasClass("masked")};a.maskElement=function(d,c){if(d.data("_mask_timeout")!==undefined){clearTimeout(d.data("_mask_timeout"));d.removeData("_mask_timeout")}if(d.isMasked()){a.unmaskElement(d)}if(d.css("position")=="static"){d.addClass("masked-relative")}d.addClass("masked");var e=a('<div class="loadmask"></div>');if(navigator.userAgent.toLowerCase().indexOf("msie")>-1){e.height(d.height()+parseInt(d.css("padding-top"))+parseInt(d.css("padding-bottom")));e.width(d.width()+parseInt(d.css("padding-left"))+parseInt(d.css("padding-right")))}if(navigator.userAgent.toLowerCase().indexOf("msie 6")>-1){d.find("select").addClass("masked-hidden")}d.append(e);if(c!==undefined){var b=a('<div class="loadmask-msg" style="display:none;"></div>');b.append("<div>"+c+"</div>");d.append(b);b.css("top",Math.round(d.height()/2-(b.height()-parseInt(b.css("padding-top"))-parseInt(b.css("padding-bottom")))/2)+"px");b.css("left",Math.round(d.width()/2-(b.width()-parseInt(b.css("padding-left"))-parseInt(b.css("padding-right")))/2)+"px");b.show()}};a.unmaskElement=function(b){if(b.data("_mask_timeout")!==undefined){clearTimeout(b.data("_mask_timeout"));b.removeData("_mask_timeout")}b.find(".loadmask-msg,.loadmask").remove();b.removeClass("masked");b.removeClass("masked-relative");b.find("select").removeClass("masked-hidden")}})(jQuery);var MashableData={globals:{isEmbedded:window.location.hostname.indexOf("www.mashabledata.com")===-1||window.location.pathname.indexOf("workbench")===-1,BAND_TRANSPARENCY:.5,colorsPlotBands:["aaaaaa","ffaaaa","aaffaa","aaaaff"],standardAnnotations:[],iconsHMTL:{mapset:'<span class="ui-icon ui-icon-mapset" title="series is part of a map set"></span>',pointset:'<span class="ui-icon ui-icon-pointset" title="series is part of a set of markers (defined longitude and latitude)"></span>',hasCubeViz:'<span class="ui-icon ui-icon-cube" title="map has supplemental visualizations"></span>',hasHeatMap:'<span class="ui-icon ui-icon-mapset" title="contains a heat-map"></span>',hasMarkerMap:'<span class="ui-icon ui-icon-pointset" title="contains sets of mapped markers (defined longitude and latitude)."></span>',hasBubbleMap:'<span class="ui-icon ui-icon-bubble" title="bubble map of data aggregated into user-defined regions"></span>'},themeCubes:{},panelGraphs:{},MySeries:{},MyGraphs:{},MAP_COLORS:{POS:"#0071A4",NEG:"#FF0000",MID:"#E5E5E5"},DEFAULT_RADIUS_SCALE:30,DEFAULT_RADIUS_FIXED:10,hcColors:["#2f7ed8","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92","#0d233a"],primeColors:["#008000","#FF0000","#0000FF","#FFFF00","#FF9900","#00FFFF","#FF0000"],dashStyles:["Solid","Short Dash","Short Dot","Short Dash Dot","Short Dash Dot Dot","Dot","Dash","Long Dash","Dash Dot","Long Dash Dot","Long Dash Dot Dot"],period:{value:{N:1e3,D:24*3600*1e3,W:7*24*3600*1e3,M:30*24*3600*1e3,Q:365/4*24*3600*1e3,SA:365/2*24*3600*1e3,A:365*24*3600*1e3},order:["N","D","W","M","Q","SA","A"],name:{N:"non period data",D:"daily",W:"weekly",M:"monthly",Q:"quarterly",SA:"semiannual",A:"annual"},units:{N:"non-periodic data",D:"day",W:"week",M:"month",Q:"quarter",SA:"half-year",A:"year"}},op:{value:{"+":1,"-":2,"*":3,"/":4},cssClass:{"+":"op-addition","-":"op-subtraction","*":"op-multiply","/":"op-divide"}},mapBackground:"#AAAAAA",graphScriptFiles:["/global/js/highcharts/js/modules/exporting.src.js","/global/js/colorpicker/jquery.colorPicker.min.js","/global/js/colour/Colour.js","/global/js/jvectormap/jquery-jvectormap-1.2.2.min.js"],rowPosition:{name:0,units:1,source:2,notes:3,region:4,lat_lon:5,date:6,dataStart:7},vectorPattern:/[SUL]/,handlePattern:/[MXSU]\d+/g,patVariable:/(\b[A-Z]{1,2}\b)/g,isIE:/msie/i.test(navigator.userAgent)&&!window.opera,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}};
if(typeof console=="undefined")console={info:function(m){},log:function(m){}};function Colour(){this.getIntegerRGB=function(){var rgb=this.getRGB();return{r:Math.round(rgb.r),g:Math.round(rgb.g),b:Math.round(rgb.b),a:rgb.a}};this.getPercentageRGB=function(){var rgb=this.getRGB();return{r:100*rgb.r/255,g:100*rgb.g/255,b:100*rgb.b/255,a:rgb.a}};this.getCSSHexadecimalRGB=function(){var rgb=this.getIntegerRGB();var r16=rgb.r.toString(16);var g16=rgb.g.toString(16);var b16=rgb.b.toString(16);return"#"+(r16.length==2?r16:"0"+r16)+(g16.length==2?g16:"0"+g16)+(b16.length==2?b16:"0"+b16)};this.getCSSIntegerRGB=function(){var rgb=this.getIntegerRGB();return"rgb("+rgb.r+","+rgb.g+","+rgb.b+")"};this.getCSSIntegerRGBA=function(){var rgb=this.getIntegerRGB();return"rgb("+rgb.r+","+rgb.g+","+rgb.b+","+rgb.a+")"};this.getCSSPercentageRGB=function(){var rgb=this.getPercentageRGB();return"rgb("+rgb.r+"%,"+rgb.g+"%,"+rgb.b+"%)"};this.getCSSPercentageRGBA=function(){var rgb=this.getPercentageRGB();return"rgb("+rgb.r+"%,"+rgb.g+"%,"+rgb.b+"%,"+rgb.a+")"};this.getCSSHSL=function(){var hsl=this.getHSL();return"hsl("+hsl.h+","+hsl.s+"%,"+hsl.l+"%)"};this.getCSSHSLA=function(){var hsl=this.getHSL();return"hsl("+hsl.h+","+hsl.s+"%,"+hsl.l+"%,"+hsl.a+")"};this.setNodeColour=function(node){node.style.color=this.getCSSHexadecimalRGB()};this.setNodeBackgroundColour=function(node){node.style.backgroundColor=this.getCSSHexadecimalRGB()}}RGBColour.prototype=new Colour;function RGBColour(r,g,b,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var rgb={r:Math.max(0,Math.min(255,r)),g:Math.max(0,Math.min(255,g)),b:Math.max(0,Math.min(255,b))};var hsv=null;var hsl=null;function getHue(maximum,range){if(range==0){var hue=0}else{switch(maximum){case rgb.r:var hue=(rgb.g-rgb.b)/range*60;if(hue<0)hue+=360;break;case rgb.g:var hue=(rgb.b-rgb.r)/range*60+120;break;case rgb.b:var hue=(rgb.r-rgb.g)/range*60+240;break}}return hue}function calculateHSV(){var maximum=Math.max(rgb.r,rgb.g,rgb.b);var range=maximum-Math.min(rgb.r,rgb.g,rgb.b);hsv={h:getHue(maximum,range),s:maximum==0?0:100*range/maximum,v:maximum/2.55}}function calculateHSL(){var maximum=Math.max(rgb.r,rgb.g,rgb.b);var range=maximum-Math.min(rgb.r,rgb.g,rgb.b);var l=maximum/255-range/510;hsl={h:getHue(maximum,range),s:range==0?0:range/2.55/(l<.5?l*2:2-l*2),l:100*l}}this.getRGB=function(){return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){if(hsv==null)calculateHSV();return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){if(hsl==null)calculateHSL();return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}HSVColour.prototype=new Colour;function HSVColour(h,s,v,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var hsv={h:(h%360+360)%360,s:Math.max(0,Math.min(100,s)),v:Math.max(0,Math.min(100,v))};var rgb=null;var hsl=null;function calculateRGB(){if(hsv.s==0){var r=hsv.v;var g=hsv.v;var b=hsv.v}else{var f=hsv.h/60-Math.floor(hsv.h/60);var p=hsv.v*(1-hsv.s/100);var q=hsv.v*(1-hsv.s/100*f);var t=hsv.v*(1-hsv.s/100*(1-f));switch(Math.floor(hsv.h/60)){case 0:var r=hsv.v;var g=t;var b=p;break;case 1:var r=q;var g=hsv.v;var b=p;break;case 2:var r=p;var g=hsv.v;var b=t;break;case 3:var r=p;var g=q;var b=hsv.v;break;case 4:var r=t;var g=p;var b=hsv.v;break;case 5:var r=hsv.v;var g=p;var b=q;break}}rgb={r:r*2.55,g:g*2.55,b:b*2.55}}function calculateHSL(){var l=(2-hsv.s/100)*hsv.v/2;hsl={h:hsv.h,s:hsv.s*hsv.v/(l<50?l*2:200-l*2),l:l};if(isNaN(hsl.s))hsl.s=0}this.getRGB=function(){if(rgb==null)calculateRGB();return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){if(hsl==null)calculateHSL();return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}HSLColour.prototype=new Colour;function HSLColour(h,s,l,a){var alpha=a===undefined?1:Math.max(0,Math.min(1,a));var hsl={h:(h%360+360)%360,s:Math.max(0,Math.min(100,s)),l:Math.max(0,Math.min(100,l))};var rgb=null;var hsv=null;function calculateRGB(){if(hsl.s==0){rgb={r:hsl.l*2.55,g:hsl.l*2.55,b:hsl.l*2.55}}else{var p=hsl.l<50?hsl.l*(1+hsl.s/100):hsl.l+hsl.s-hsl.l*hsl.s/100;var q=2*hsl.l-p;rgb={r:(h+120)/60%6,g:h/60,b:(h+240)/60%6};for(var key in rgb){if(rgb.hasOwnProperty(key)){if(rgb[key]<1){rgb[key]=q+(p-q)*rgb[key]}else if(rgb[key]<3){rgb[key]=p}else if(rgb[key]<4){rgb[key]=q+(p-q)*(4-rgb[key])}else{rgb[key]=q}rgb[key]*=2.55}}}}function calculateHSV(){var t=hsl.s*(hsl.l<50?hsl.l:100-hsl.l)/100;hsv={h:hsl.h,s:200*t/(hsl.l+t),v:t+hsl.l};if(isNaN(hsv.s))hsv.s=0}this.getRGB=function(){if(rgb==null)calculateRGB();return{r:rgb.r,g:rgb.g,b:rgb.b,a:alpha}};this.getHSV=function(){if(hsv==null)calculateHSV();return{h:hsv.h,s:hsv.s,v:hsv.v,a:alpha}};this.getHSL=function(){return{h:hsl.h,s:hsl.s,l:hsl.l,a:alpha}}}MashableData.common={octet:function octet(s){s=s.toString(16);return(s.length==1?0:"")+s},mashableDataString:function mashableDataString(serie){var i,points=[];if(typeof serie.data=="string"){return serie.data}else{for(i=0;i<serie.data.length;i++){points.push(mashableDate(serie.data[i][0],serie.period)+"|"+(isNaN(serie.data[i][1])||serie.data[i][1]===null?"null":serie.data[i][1]))}return points.join("||")}},mashableDate:function mashableDate(jsDate,period){var dt=new Date(parseInt(jsDate));var mdDate=dt.getUTCFullYear();switch(period){case"M":mdDate+=(dt.getUTCMonth().toString().length==1?"0":"")+dt.getUTCMonth();break;case"Q":mdDate+="Q"+parseInt((dt.getUTCMonth()+3)/3);break;case"SA":mdDate+="H"+parseInt((dt.getUTCMonth()+6)/6);break;case"W":case"D":mdDate+=(dt.getUTCMonth().toString().length==1?"0":"")+dt.getUTCMonth();mdDate+=(dt.getUTCDate().toString().length==1?"0":"")+dt.getUTCDate();break}return mdDate},dateFromMdDate:function dateFromMdDate(mddt){var udt;udt=new Date("1/1/"+mddt.substr(0,4)+" UTC");if(mddt.length>4){switch(mddt.substr(4,1)){case"Q":udt.period="Q";udt.setUTCMonth((mddt.substr(5,1)-1)*3);break;case"H":udt.period="H";udt.setUTCMonth((mddt.substr(5,1)-1)*6);break;default:udt.period="M";udt.setUTCMonth(mddt.substr(4,2))}if(mddt.length>6){udt.period="D";udt.setUTCDate(mddt.substr(6,2));if(mddt.length>8){udt.setUTCHours(mddt.substr(9,2));udt.setUTCMinutes(mddt.substr(12,2));udt.setUTCSeconds(mddt.substr(15,2))}}}else{udt.period="A"}udt.s=mddt;return udt},dateConversionData:function dateConversionData(key,jsStart,jsEnd){if(jsStart&&typeof jsStart!="object")jsStart=new Date(parseInt(jsStart));if(jsEnd&&typeof jsEnd!="object")jsEnd=new Date(parseInt(jsEnd));var data="",altStart;var oneDay=24*60*60*1e3;var today=new Date;var mashableDate=this.mashableDate;switch(key.toUpperCase()){case"DAYSPERMONTH":if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-"+(jsEnd.getUTCMonth()+1)+"-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-12-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-"+(jsStart.getUTCMonth()+1)+"-01 UTC")}else{jsStart=new Date(jsEnd.getTime());jsStart.setUTCMonth(jsStart.getUTCMonth()-119)}while(jsStart<=jsEnd){data+=(data?"||":"")+mashableDate(jsStart.getTime(),"M")+"|"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCMonth(jsStart.getUTCMonth()+1))/oneDay)}break;case"DAYSPERQUARTER":if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-"+(jsEnd.getUTCMonth()+3)+"-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-12-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-"+(jsStart.getUTCMonth()+3)+"-01 UTC")}else{jsStart=new Date(jsEnd.getTime());jsStart.setUTCMonth(jsStart.getUTCMonth()-119)}while(jsStart<=jsEnd){data+=(data?"||":"")+mashableDate(jsStart.getTime(),"Q")+"|"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCMonth(jsStart.getUTCMonth()+3))/oneDay)}break;case"DAYSPERYEAR":jsEnd=jsEnd||new Date(today.getUTCFullYear()+"-01-01 UTC");if(jsEnd){jsEnd=new Date(jsEnd.getUTCFullYear()+"-01-01 UTC")}else{jsEnd=new Date(today.getUTCFullYear()+"-01-01 UTC")}if(jsStart&&jsStart<jsEnd){jsStart=new Date(jsStart.getUTCFullYear()+"-01-01 UTC")}else{jsStart=new Date(jsEnd.getUTCFullYear()-20+"-01-01 UTC")}while(jsStart<=jsEnd){data+=(data?"||":"")+mashableDate(jsStart.getTime(),"A")+"|"+Math.round(Math.abs(jsStart.getTime()-jsStart.setUTCFullYear(jsStart.getUTCFullYear()+1))/period.value.D)}break}return data},selectDownshift:function selectDownshift(graph,fdown,plot,callback){var i,asset;var html='<div id="downshiftWizard" style="width:600px;">'+"<h4>Frequency Shifting:</h4>";if(fdown)html+="You have selected to have the plot recalculated as <b></b>"+period.name[fdown]+"</b>.  Please select the method and treatment of missing and null values.<br>";else html+="You have requested to mash series with different frequencies.  This will require first recalculating the series data having a shorter reporting period to a common longer period.  Please confirm by selecting the algorithm and the treatment of missing and null values.<br>";html+="<br>Component series that must be recalculated:"+"<ol>";for(i=0;i<plot.components.length;i++){asset=graph.assets[plot.components[i].handle];html+="<li><b>"+asset.name+"</b> ("+asset.units+") "+period.name[fdown=="A"&&asset.freqset.Q?"Q":"M"]+"</li>"}html+="</ol>"+"<br>Each component series will be individual recalculated as needed to the new frequency by:<br>"+'<label><input type="radio" name="dsw_algor" value="sum"> simple summation</label><br>'+'<label><input type="radio" name="dsw_algor" value="wavg"> day-weighted average</label><br>'+"<br>If some of the values used to calculate a new datum point are are null or missing (e.g. a month is missing when calulating an annual value):<br>"+'<label><input type="radio" name="dsw_missing" value="null"> the computed value for the datum will be null (i.e. all sub-values are required)</label><br>'+'<label><input type="radio" name="dsw_missing" value="zero"> treat as if the value were zero</label><br>'+'<label><input type="radio" name="dsw_missing" value="impute"> estimate value to be the day-weighted average of new period\'s existing component values if at least three-quarters of the component values exist</label><br>'+'<span class="ui-state-error warning-box"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span>WARNING: Change frequencies and use estimates with care.  Summations produce valid results for monthly production quantities, whereas day-weighted averages are statistically correct for rates where the implied denominator is constant.<br><br>For more information, see <a href="/workbench-help/changing-frequency/" traget="_blank" class="link">changing frequencies help</a>.</span>'+'<button id="dsw_ok" class="right">OK</button> <button id="dsw_cancel" class="right">cancel</button>'+"</div>";$.fancybox(html,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var $dsw=$("#downshiftWizard");$("#dsw_ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var downshift={algorithm:$dsw.find("input:radio[name='dsw_algor']:checked").val(),missing:$dsw.find("input:radio[name='dsw_missing']:checked").val()};if(downshift.algorithm&&downshift.missing){callback(downshift);$.fancybox.close()}else{dialogShow("error","All form selections are required.")}});$("#dsw_cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close();callback(false)})},downShiftData:function downShiftData(asset,fdown,algorithm,missing){var period=MashableData.globals.period;if(period.value[fdown]==period.value[asset.period])return asset.data;if(period.value[fdown]<period.value[asset.period]||fdown!="A"&&fdown!="Q"||period.value[asset.period]<period.value["M"])throw"unable to change data frequency from "+period.name[asset.period]+" to "+period.name[fdown];var aData=asset.data.split("||"),newData=[],bin=[],lengthInMonths=fdown=="Q"?3:12,lengthAssetPeriod=asset.period=="M"?1:3,periodsStartDate=false,mdDate,point,pointDate;for(var i=0;i<aData.length;i++){point=aData[i].split("|");pointDate=this.dateFromMdDate(point[0]);if(periodsStartDate===false||pointDate.getUTCMonth()-periodsStartDate.getUTCMonth()>lengthInMonths-1||pointDate.getUTCFullYear()!=periodsStartDate.getUTCFullYear()){if(bin.length!=0){newData.push(downShiftDatum());bin=[]}periodsStartDate=new Date(pointDate.getUTCFullYear()+"-"+(Math.floor(pointDate.getUTCMonth()/lengthInMonths)*lengthInMonths+1)+"-1 UTC")}bin[pointDate.getUTCMonth()]=point[1]}if(bin.length!=0)newData.push(downShiftDatum());return newData;function downShiftDatum(){var subPeriodDays,valueDays=0,missingDays=0,missingPeriods=0,newY=0;mdDate=MashableData.common.mashableDate(periodsStartDate.getTime(),fdown);var startMonth=periodsStartDate.getUTCMonth();for(var j=startMonth;j<startMonth+lengthInMonths;j=j+lengthAssetPeriod){subPeriodDays=-Math.round(periodsStartDate.getTime()-periodsStartDate.setUTCMonth(periodsStartDate.getUTCMonth()+lengthAssetPeriod)/period.value.D);if(typeof bin[j]=="undefined"||bin[j]===null){if(missing=="null"){return mdDate+"|null"}bin[j]=0;if(missing=="impute"){missingPeriods++;missingDays+=subPeriodDays;valueDays-=subPeriodDays}}switch(algorithm){case"wavg":newY+=parseFloat(bin[j])*subPeriodDays;valueDays+=subPeriodDays;break;case"sum":newY+=parseFloat(bin[j]);break;default:throw"unrecognized down frequency conversion algorithm"}}if(missingDays!=0&&newY!="null")newY=newY*(valueDays+missingDays)/valueDays;return mdDate+"|"+(algorithm=="wavg"?newY/valueDays:newY)}},rationalize:function rationalize(value){if(Math.log(Math.abs(value))>-13)return Math.round(value*Math.pow(10,10))/Math.pow(10,10);else return value},equivalentRGBA:function equivalentRGBA(hexColor,alpha){var r,g,b;if(hexColor.substr(0,1)=="#")hexColor=hexColor.substr(1);r=gun(parseInt(hexColor.substr(0,2),16),alpha);g=gun(parseInt(hexColor.substr(2,2),16),alpha);b=gun(parseInt(hexColor.substr(4,2),16),alpha);if(r>0&&g>0&&b>0){return"rgba("+r+","+g+","+b+","+alpha+")"}else{return"rgb("+parseInt(hexColor.substr(0,2),16)+","+parseInt(hexColor.substr(2,2),16)+","+parseInt(hexColor.substr(4,2),16)+")"}function gun(desired,alpha){return parseInt(desired/alpha-(1-alpha)*255/alpha)}},addBreaks:function addBreaks(seriesData,periodicity){var data=seriesData.slice(0);data.sort(function(a,b){return a[0]-b[0]});var oData=[];if(data.length>0)oData.push([data[0][0],data[0][1]]);var interval;switch(periodicity){case"T":case"N":case"D":case"W":maxInterval=Date.UTC(2e3,0,9)-Date.UTC(2e3,0,1);break;case"M":maxInterval=Date.UTC(2e3,1,2)-Date.UTC(2e3,0,1);break;case"SA":maxInterval=Date.UTC(2e3,7,2)-Date.UTC(2e3,0,1);break;default:maxInterval=Date.UTC(2001,2)-Date.UTC(2e3,1)}for(var i=1;i<data.length;i++){if(data[i-1][1]!=null&&data[i][1]!=null&&data[i][0]-data[i-1][0]>maxInterval){var interDate=new Date(data[i][0]);switch(periodicity){case"d":case"w":interDate.setDate(interDate.getDate()+7);break;case"4":interDate.setDate(interDate.getDate()+28);break;case"m":interDate.setMonth(interDate.getMonth()+1);break;default:interDate.setMonth(interDate.getMonth()+12)}data.splice(i,0,[parseInt(interDate),null]);i++}}return data},callApi:function callApi(params,callBack){var data,embed=MashableData.globals.isEmbedded;if(embed){data=$.extend({uid:false,host:window.location.host},params)}else{data=$.extend({uid:getUserId(),version:workbenchVersion,accessToken:account.info.accessToken},params)}if(!embed&&params.modal!="none")mask();$.ajax({type:"POST",url:embed?"http://remote.mashabledata.com/"+(MashableData.globals.embed||""):"api.php",encoding:"UTF-8",data:data,dataType:"json",success:function(jsoData,textStatus,jqXHR){console.info(jsoData);if(jsoData.status=="ok"){if(!embed){totalServerTime+=parseFloat(jsoData.exec_time);if(jsoData.msg)dialogShow("",jsoData.msg);console.info(params.command+": "+jsoData.exec_time+" (total server time: "+totalServerTime+"ms)")}callBack(jsoData,textStatus,jqXHR);if(params.modal!="persist"&&!embed)unmask()}else{if(embed){return jsoData.status}else{unmask();dialogShow("Connected to server, but the command failed.",jsoData.status+'<br><br>If this is a system error and continues to occur, please email <a href="mailto:support@mashabledata.com">support@mashabledata.com</a>.')}}},error:function(jqXHR,textStatus,errorThrown){console.log(textStatus);console.log(jqXHR);if(embed){return"A system error occurred while trying to connect to the MashableData servers.  Please try again later"}else{unmask();dialogShow(textStatus,"A system error occurred while trying to connect to the server.  Check your internet connectivity and try again later.")}}})}};MashableData.Annotator=function Annotator(panelId,makeDirty){var MD=MashableData,globals=MD.globals,common=MD.common,grapher=MD.grapher;var BAND_TRANSPARENCY=globals.BAND_TRANSPARENCY;var panelGraphs=globals.panelGraphs;var equivalentRGBA=common.equivalentRGBA;var period=globals.period;var controller={panelId:panelId,bandNo:0,lineNo:0,banding:false,bandStartPoint:void 0,makeDirty:makeDirty,callApi:MD.common.callApi,addStandard:function addStandard(annoid){var self=this;self.callApi({command:"GetAnnotation",annoid:annoid},function(data){standardAnno=jQuery.parseJSON(data.annotation);for(var i=0;i<standardAnno.length;i++){panelGraphs[panelId].annotations.push(standardAnno[i])}self.build("new")})},fetchStandards:function(){if(globals.standardAnnotations.length==0){var self=this;this.callApi({command:"GetAnnotations"},function(results){for(var i=0;i<results.annotations.length;i++)globals.standardAnnotations.push(results.annotations[i])})}},sync:function annoSync(){var thisChart=panelGraphs[this.panelId].controls.chart;var axis=thisChart.options.xAxis,plotLines=axis.plotLines=[],plotBands=axis.plotBands=[];var anno;for(var i=0;i<thisChart.xAxis[0].plotLinesAndBands.length;i++){anno=thisChart.xAxis[0].plotLinesAndBands[i];if(anno.id.substr(0,1)=="xb"){plotBands.push(anno.options)}else{plotLines.push(anno.options)}}},addPoint:function annotatePoint(selectedPoint){var oGraph=panelGraphs[panelId];if(typeof selectedPoint!="undefined"){var point;for(var i=0;i<oGraph.annotations.length;i++){if(oGraph.annotations[i].type=="point"){point=oGraph.controls.chart.get(oGraph.annotations[i].id);if(point){point.update([point.x,point.y],false)}delete oGraph.annotations[i].id}}oGraph.annotations.push({type:"point",text:"",id:null,series:selectedPoint.series.options.id,color:"#000000",from:formatDateByPeriod(selectedPoint.x,selectedPoint.series.options.period)});this.build("point")}},addXLine:function annotateXLine(selectedPoint){var oGraph=panelGraphs[panelId];oGraph.controls.chart.xAxis[0].addPlotLine({value:selectedPoint.x,color:"#"+colorsPlotBands[0],id:"xl"+this.lineNo,width:2,label:{text:" ",y:0,zIndex:3}});oGraph.annotations.push({type:"line",text:"",id:"xl"+this.lineNo,color:colorsPlotBands[0],from:formatDateByPeriod(selectedPoint.x,selectedPoint.series.options.period)});this.lineNo++;this.build("table-only")},startXBand:function annotateXBandStart(pointSelected){var oGraph=panelGraphs[panelId];this.bandStartPoint=pointSelected;this.bandColor=equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY);oGraph.controls.chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.bandStartPoint.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});this.banding="x-Time";pointSelected.select(true)},build:function buildAnnotations(redrawAnnoTypes){var y,yOffset,self=this,oGraph=panelGraphs[panelId],$thisPanel=oGraph.controls.$thisPanel,$annotations=$thisPanel.find("div.annotations").show().find("table");if($annotations&&$annotations.length!=0){$thisPanel.find(".graph-save").button("enable");oGraph.isDirty=true}if(!redrawAnnoTypes)redrawAnnoTypes="all";var sTable="";var annoLetter="A";var i,anno,point,annoSeries,annoScatter,fromJS,toJS;var scatterData={};for(i=0;i<oGraph.controls.chart.yAxis.length;i++){scatterData["labelsY-"+i]=[]}oGraph.annotations.sort(function(a,b){if(a.type.charAt(0)=="h"&&a.type.charAt(0)=="h")return b.from-a.from;if(a.type.charAt(0)=="h")return-1;if(b.type.charAt(0)=="h")return 1;return self.parseDate(a.from)-self.parseDate(b.from)});for(i=0;i<oGraph.annotations.length;i++){console.time("annotation loop");anno=oGraph.annotations[i];switch(anno.type){case"point":if(redrawAnnoTypes=="point"||redrawAnnoTypes=="all"){annoSeries=oGraph.controls.chart.get(anno.series);if(annoSeries==null){oGraph.annotations.splice(i,1);i--;break}annoScatter=oGraph.controls.chart.get("labelsY-"+annoSeries.options.yAxis);for(var j=0;j<annoSeries.data.length;j++){if(annoSeries.data[j]){if(annoSeries.data[j].x==this.parseDate(anno.from)){point=annoSeries.data[j];scatterData["labelsY-"+annoSeries.options.yAxis].push({x:point.x,y:point.y,id:annoLetter,marker:{fillColor:anno.color,lineColor:anno.color,radius:8,symbol:"circle",enabled:true,states:{hover:{enabled:true,marker:{enabled:true,fillColor:anno.color,lineColor:anno.color,radius:8}}}}})}}}anno.id=annoLetter}sTable+='<tr data="'+annoLetter+'"><td align="center"><b>'+annoLetter+"</b></td><td>"+anno.from+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';annoLetter=String.fromCharCode(annoLetter.charCodeAt(0)+1);break;case"line":fromJS=this.parseDate(anno.from);if(fromJS>=parseInt(oGraph.start||oGraph.firstdt)&&fromJS<=parseInt(oGraph.end||oGraph.lastdt)){if(redrawAnnoTypes=="line"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="xl"+this.lineNo;this.lineNo++;yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].addPlotLine({color:anno.color,value:this.parseDate(anno.from),id:anno.id,width:2,label:{text:anno.text,y:yOffset,zIndex:3}})}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hline":if(redrawAnnoTypes=="hline"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="hl"+this.lineNo;this.lineNo++;for(y=0;y<oGraph.controls.chart.yAxis.length;y++){if(oGraph.controls.chart.yAxis[y].userOptions.title.text==anno.yAxis){oGraph.controls.chart.yAxis[y].addPlotLine({color:anno.color,value:anno.from,id:anno.id,width:2,label:{text:anno.text,zIndex:3}})}}}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+" "+anno.yAxis+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break;case"band":fromJS=this.parseDate(anno.from);toJS=this.parseDate(anno.to);if(fromJS>=parseInt(oGraph.start||oGraph.firstdt)&&fromJS<=parseInt(oGraph.end||oGraph.lastdt)||toJS>=parseInt(oGraph.start||oGraph.firstdt)&&toJS<=parseInt(oGraph.to||oGraph.lastdt)){if(redrawAnnoTypes=="band"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="xb"+this.bandNo++;yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:fromJS,to:toJS,id:anno.id,label:{text:anno.text,y:yOffset,zIndex:3}})}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+"-"+anno.to+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hband":if(redrawAnnoTypes=="hband"||redrawAnnoTypes=="all"||redrawAnnoTypes=="new"&&!anno.id){anno.id="hb"+this.bandNo++;for(y=0;y<oGraph.controls.chart.yAxis.length;y++){if(oGraph.controls.chart.yAxis[y].userOptions.title.text==anno.yAxis){oGraph.controls.chart.yAxis[y].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:anno.from,to:anno.to,id:anno.id,label:{text:anno.text,zIndex:3}})}}}sTable+='<tr data="'+anno.id+'"><td><input class="annotation-color-picker" type="text" value="'+anno.color+'" /></td><td>'+anno.from+"-"+anno.to+" "+anno.yAxis+'</td><td><input class="anno-text" type="text" value="'+anno.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break}console.timeEnd("annotation loop")}console.time("annotation redraw");if(redrawAnnoTypes=="point"||redrawAnnoTypes=="all"){for(var key in scatterData){oGraph.controls.chart.get(key).setData(scatterData[key],false)}console.info("annotations fired chart redraw");oGraph.controls.chart.redraw()}console.timeEnd("annotation redraw");if(!globals.isEmbedded){console.time("annotation rest");if(oGraph.annotations.length==0)sTable+='<tr><td colspan="3" class="grey-italics">right-click on the chart to annotate a point, band, or event, or to perform a linear regression or average</td></tr>';$annotations.html(sTable).find("input, select").change(function(){self.change(this)});$annotations.find(".annotation-color-picker").colorPicker();$annotations.find(".ui-icon-trash").click(function(){self["delete"](this)});console.timeEnd("annotation rest")}},change:function changeAnno(obj){var i,yOffset,y,id=$(obj).closest("tr").attr("data");panelGraphs[panelId].controls.$thisPanel.find(".graph-save").button("enable");var oGraph=panelGraphs[panelId];var anno;for(i=0;i<oGraph.annotations.length;i++){if(id==oGraph.annotations[i].id){anno=oGraph.annotations[i];break}}anno.text=$(obj).closest("tr").find("input.anno-text").val();anno.color=$(obj).closest("tr").find(".annotation-color-picker").val();switch(id.substr(0,2)){case"xb":yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].removePlotBand(id);oGraph.controls.chart.xAxis[0].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:this.parseDate(anno.from),to:this.parseDate(anno.to),id:anno.id,label:{text:anno.text,y:yOffset,zIndex:3}});break;case"hb":for(i=0;i<oGraph.controls.chart.yAxis.length;i++){if(oGraph.controls.chart.yAxis[i].userOptions.title.text=anno.yAxis){oGraph.controls.chart.yAxis[i].removePlotBand(id);oGraph.controls.chart.yAxis[i].addPlotBand({color:equivalentRGBA(anno.color,BAND_TRANSPARENCY),from:parseFloat(anno.from),to:parseFloat(anno.to),id:anno.id,label:{text:anno.text,zIndex:3}})}}break;case"hl":for(i=0;i<oGraph.controls.chart.yAxis.length;i++){if(oGraph.controls.chart.yAxis[i].userOptions.title.text=anno.yAxis){oGraph.controls.chart.yAxis[i].removePlotLine(id);oGraph.controls.chart.yAxis[i].addPlotLine({color:anno.color,value:parseFloat(anno.from),id:anno.id,width:2,label:{text:anno.text,zIndex:3}})}}break;case"xl":yOffset=this.labelOffset(oGraph.controls.chart,anno);oGraph.controls.chart.xAxis[0].removePlotLine(id);oGraph.controls.chart.xAxis[0].addPlotLine({color:anno.color,value:this.parseDate(anno.from),id:anno.id,width:2,label:{text:anno.text,y:yOffset,zIndex:3}})}},"delete":function deleteAnno(deleteAnchor){var idToDelete=$(deleteAnchor).closest("tr").attr("data");var oGraph=panelGraphs[panelId];for(var i=0;i<oGraph.annotations.length;i++){if(idToDelete==oGraph.annotations[i].id){oGraph.annotations.splice(i,1);break}}if(idToDelete[1]=="b"||idToDelete[1]=="l"){for(a=0;a<oGraph.controls.chart.axes.length;a++){oGraph.controls.chart.axes[a].removePlotLine(idToDelete);oGraph.controls.chart.axes[a].removePlotBand(idToDelete)}this.build("none")}else{this.build("point")}},startAnalysisBanding:function(point,analysisType){var seriesColor=point.series.color;var chart=panelGraphs[panelId].controls.chart;r=parseInt(seriesColor.substr(1,2),16);g=parseInt(seriesColor.substr(3,2),16);b=parseInt(seriesColor.substr(5,2),16);this.bandColor="rgba("+r+","+g+","+b+",0.5)";this.banding=analysisType+"-"+point.series.index;this.bandStartPoint=point;chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:point.x,color:this.bandColor,id:analysisType+this.bandNo++,label:{text:" ",y:0,zIndex:3}})},deleteAnalysis:function(pointSelected){var fromX,toX,i,analyses,plotId=pointSelected.series.options.calculatedFrom;var analysisType=pointSelected.series.options.id.substr(0,2);if(plotId){fromX=pointSelected.series.data[0][0];toX=pointSelected.series.data[pointSelected.series.data.length-1][0];pointSelected.series.remove();switch(analysisType){case"LR":analyses=panelGraphs[panelId].plots[parseInt(plotId.substr(1))].options.linRegressions;break;case"AV":analyses=panelGraphs[panelId].plots[parseInt(plotId.substr(1))].options.averages;break}this.makeDirty();for(i=0;i<analyses.length;i++){if(analyses[i][0]==toX&&analyses[i][1]==fromX){analyses.splice(i,1);return true}}return false}},parseDate:function annoDateParse(partialDateString){if(partialDateString.length==4){partialDateString="1 Jan "+partialDateString+" UTC"}else if(partialDateString.length==8){partialDateString="1 "+partialDateString+" UTC"}else{partialDateString+=" UTC"}return Date.parse(partialDateString)},labelOffset:function annotationY(chart,anno){var yStart=10;var yInc=20;var annoMargin=.2;if(anno.text==" "||anno.text==" ")return 0;var plotLinesAndBands=chart.xAxis[0].plotLinesAndBands;var extremes=chart.xAxis[0].getExtremes();var minSeparation=(extremes.max-extremes.min)*annoMargin;var annoCenter;var overlappingAnnos=[];if(anno.to){annoCenter=(this.parseDate(anno.from)+this.parseDate(anno.to))/2}else{annoCenter=this.parseDate(anno.from)}var overlaps=0,thisCenter;for(var i=0;i<plotLinesAndBands.length;i++){if(plotLinesAndBands[i].id!="timeLine"){if(plotLinesAndBands[i].options.to){thisCenter=(plotLinesAndBands[i].options.from+plotLinesAndBands[i].options.to)/2}else{thisCenter=plotLinesAndBands[i].options.from}if(plotLinesAndBands[i].options.label.text.length>0&&Math.abs(thisCenter-annoCenter)<minSeparation){overlaps++;overlappingAnnos.push(plotLinesAndBands[i])}}}var y=yStart;for(var j=0;j<overlappingAnnos.length;j++){if(overlappingAnnos[j].options.label.y==y){y+=yInc;j=-1}}return y},mouseOverHCPoint:function mouseOverHCPoint(e,point){var chart=panelGraphs[panelId].controls.chart;if(!this.banding)return;if(this.banding=="x-Time"){try{chart.xAxis[0].removePlotBand("xb"+this.bandNo)}catch(err){}chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:point.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});return}if(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-"){var analysisType=this.banding.substr(0,2);try{chart.xAxis[0].removePlotBand(analysisType+this.bandNo)}catch(err){}this.endingX=closestDate(point.x,this.bandStartPoint.series.data);chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.endingX,color:this.bandColor,id:analysisType+this.bandNo,label:{text:" ",y:0,zIndex:3}})}},endBanding:function endBanding(e){var axisName,axisValue,userValue;var pointSelected=this.mouseoverPoint;var onPoint=typeof this.mouseoverPoint!="undefined";var oGraph=panelGraphs[panelId];var self=this;if(this.banding=="x-Time"){if(onPoint){var x1,x2;x1=formatDateByPeriod(this.bandStartPoint.x,this.bandStartPoint.series.options.period);x2=formatDateByPeriod(pointSelected.x,pointSelected.series.options.period);this.banding=false;oGraph.annotations.push({type:"band",text:"",id:"xb"+this.bandNo,color:"#"+colorsPlotBands[0],from:x1<x2?x1:x2,to:x1<x2?x2:x1});this.build("table-only");return false}else{return{items:{info:{name:"Mouse-over a series before right-clicking to terminate a vertical band.",callback:function(key,opt){}}}}}}if(this.banding&&(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-")){var analysisType=this.banding.substr(0,2);oGraph.controls.chart.xAxis[0].removePlotBand(analysisType+this.bandNo);var fromX=Math.min(this.bandStartPoint.x,this.endingX);var toX=Math.max(this.bandStartPoint.x,this.endingX);if(fromX<toX){switch(analysisType){case"LR":this.plotLinearRegression(this.bandStartPoint.series,fromX,toX,true);var plotOptions=oGraph.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!plotOptions.linRegressions)plotOptions.linRegressions=[];plotOptions.linRegressions.push([fromX,toX]);break;case"AV":this.plotAverage(this.bandStartPoint.series,fromX,toX,true);var plotOptions=oGraph.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!plotOptions.averages)plotOptions.averages=[];plotOptions.averages.push([fromX,toX]);
break}self.makeDirty()}else{dialogShow("Error","The starting point and ending points must be different.")}this.banding=false;return}else{var top,left,x,y,i,chart=oGraph.controls.chart;for(i=0;i<chart.yAxis.length;i++){axisName=chart.yAxis[i].userOptions.title.text;if(this.banding=="y-"+axisName){top=$(chart.container).offset().top;left=$(chart.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft;y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){axisValue=parseFloat(parseFloat(chart.yAxis[i].translate(chart.plotHeight-y,true).toPrecision(2)));return{items:{axis:{name:"<b>"+axisName+":</b>",type:"text",value:axisValue},ok:{name:"<button>ok</button>",callback:function(key,opt){userValue=$.contextMenu.getInputValues(opt)["axis"];for(var i=0;i<chart.yAxis.length;i++){if(chart.yAxis[i].userOptions.title.text=self.banding.substr(2)){chart.yAxis[i].removePlotBand("hb"+self.bandNo);var y1,y2;y1=parseFloat(self.bandStartPoint);y2=parseFloat(userValue);chart.yAxis[i].removePlotBand("hb"+self.bandNo);chart.yAxis[i].addPlotBand({id:"hb"+self.bandNo,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:Math.min(y1,y2),to:Math.max(y1,y2),label:{text:"",zIndex:3}});oGraph.annotations.push({id:"hb"+self.bandNo,type:"hband",yAxis:axisName,text:"",color:"#"+colorsPlotBands[0],from:Math.min(self.bandStartPoint,userValue),to:Math.max(self.bandStartPoint,userValue)});self.build("table-only");self.banding=false;self.makeDirty();break}}}},cancel:{name:"<button>cancel</button>",callback:function(key,opt){for(i=0;i<chart.yAxis.length;i++){chart.yAxis[i].removePlotBand("hb"+self.bandNo);self.banding=false}}}}}}else{return false}}}}},plotAnnotationSeries:function(){var p,i,LR,AV;var oGraph=panelGraphs[panelId];var chart=oGraph.controls.chart;var start=oGraph.start||(oGraph.intervals?grapher.intervalStartDt(oGraph):oGraph.firstdt);if(oGraph.plots&&oGraph.plots.length>0){for(p=0;p<oGraph.plots.length;p++){if(oGraph.plots[p].options.linRegressions){for(i=0;i<oGraph.plots[p].options.linRegressions.length;i++){LR=oGraph.plots[p].options.linRegressions[i];if(LR[0]>=start&&LR[0]<=parseInt(oGraph.end||oGraph.lastdt)&&(LR[1]>=start&&LR[1]<=parseInt(oGraph.to||oGraph.lastdt))){this.plotLinearRegression(chart.get("P"+p),LR[0],LR[1])}}}if(oGraph.plots[p].options.averages){for(i=0;i<oGraph.plots[p].options.averages.length;i++){AV=oGraph.plots[p].options.averages[i];if(AV[0]>=start&&AV[0]<=parseInt(oGraph.end||oGraph.lastdt)&&(AV[1]>=start&&AV[1]<=parseInt(oGraph.to||oGraph.lastdt))){this.plotAverage(chart.get("P"+p),AV[0],AV[1])}}}}}chart.redraw()},plotLinearRegression:function(series,start,end,redraw){if(!redraw)redraw=false;var hChart=panelGraphs[panelId].controls.chart;var sumX=0,minX=null,maxX=null;var sumY=0,minY=null,maxY=null;var j,data=[],points=0;if(typeof start=="undefined"||typeof end=="undefined"){data=series.data}else{for(j=0;j<series.data.length;j++){if(series.data[j].x>=start&&series.data[j].x<=end){data.push(series.data[j])}}}for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){sumX+=data[j].x;sumY+=data[j].y;if(minX==null){minX=data[j].x}if(maxX==null){maxX=data[j].x}if(minY==null){minY=data[j].y}if(maxY==null){maxY=data[j].y}if(minX>data[j].x){minX=data[j].x}if(maxX<data[j].x){maxX=data[j].x}if(minY>data[j].y){minY=data[j].y}if(maxY<data[j].y){maxY=data[j].y}points++}}var avgX=sumX/points;var avgY=sumY/points;var num=0;var den=0;for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){num+=(data[j].x-avgX)*(data[j].y-avgY);den+=(data[j].x-avgX)*(data[j].x-avgX)}}var b1=num/den;var b0=avgY-b1*avgX;var m=b1*period.value[series.options.period];var firstDigit=m.toString().search(/[1-9]/);var decimalLocation=m.toString().indexOf(".");var newSeries={name:"Linear regression of "+series.name+"<BR> (m="+Highcharts.numberFormat(m,decimalLocation>5||decimalLocation==-1?0:firstDigit+5-decimalLocation)+" per "+period.units[series.options.period]+")",dashStyle:"LongDash",period:series.options.period,lineWidth:1,color:series.color,data:[],id:"LR"+this.bandNo++,calculatedFrom:series.options.id,shadow:false,marker:{enabled:false}};for(j=0;j<data.length;j++){if(data[j].x!=null&&data[j].y!=null){newSeries.data.push([data[j].x,b1*data[j].x+b0])}}return hChart.addSeries(newSeries,redraw)},plotAverage:function(series,start,end,redraw){if(!redraw)redraw=false;var hChart=panelGraphs[panelId].controls.chart;var sumY=0,pointCount=0;var j,data=[],points=0;if(typeof start=="undefined"||typeof end=="undefined"){data=series.data}else{for(j=0;j<series.data.length;j++){if(series.data[j].x>=start&&series.data[j].x<=end){data.push(series.data[j]);if(series.data[j].y!==null){sumY+=series.data[j].y;pointCount++}}}}var avg=sumY/pointCount;var newSeries={name:"Average of "+series.name,dashStyle:"ShortDash",period:series.options.period,lineWidth:1,color:series.color,data:[],id:"AV"+this.bandNo++,calculatedFrom:series.options.id,shadow:false,marker:{enabled:false}};for(j=0;j<data.length;j++){newSeries.data.push([data[j].x,avg])}return hChart.addSeries(newSeries,redraw)}};if(!globals.isEmbedded)controller.fetchStandards();return controller};MashableData.grapher=function(){var MD=MashableData,globals=MD.globals,common=MD.common,panelGraphs=globals.panelGraphs,months=globals.months,period=globals.period,patVariable=globals.patVariable,hcColors=globals.hcColors,primeColors=globals.primeColors,MAP_COLORS=globals.MAP_COLORS,DEFAULT_RADIUS_SCALE=globals.DEFAULT_RADIUS_SCALE,DEFAULT_RADIUS_FIXED=globals.DEFAULT_RADIUS_FIXED,dashStyles=globals.dashStyles,op=globals.op,oMyGraphs=globals.MyGraphs,vectorPattern=globals.vectorPattern,handlePattern=globals.handlePattern,isIE=globals.isIE,mapBackground=globals.mapBackground,graphScriptFiles=globals.graphScriptFiles,dateFromMdDate=common.dateFromMdDate,rationalize=common.rationalize,callApi=common.callApi;var grapher={chartPanel:function chartPanel(panelId){console.time("chartPanel");var oGraph=panelGraphs[panelId];console.time("makeChartOptionsObject");var oChartOptions=makeChartOptionsObject(oGraph);console.timeEnd("makeChartOptionsObject");var $chart=oGraph.controls.$thisPanel.find("div.mashabledata_chart");if(oChartOptions.series.length==0){$chart.hide();return void 0}var chart;if(oGraph.controls&&oGraph.controls.chart){oGraph.controls.chart.destroy();$.contextMenu("destroy","#"+panelId+" div.mashabledata_chart")}$chart.show();oChartOptions.chart.renderTo=$chart.get(0);var annotations=oGraph.controls.annotations;if(globals.isEmbedded){oChartOptions.plotOptions.series.point={events:{click:function(evt){setMapDate(this.x)}}};oChartOptions.chart.events={click:function(e){setMapDate(e.xAxis[0].value)}}}else{oChartOptions.plotOptions.series.point={events:{mouseOver:function(evt){annotations.mouseoverPoint=this;annotations.mouseOverHCPoint(evt,this)},mouseOut:function(evt){delete annotations.mouseoverPoint},click:function(evt){if(annotations.banding){annotations.endBanding(evt)}else{setMapDate(this.x)}}}};oChartOptions.chart.events={click:function(e){if(annotations.banding){annotations.endBanding(e)}else{setMapDate(e.xAxis[0].value)}},selection:function(event){var min;var max;if(event.resetSelection){if(chart.cropButton)chart.cropButton=chart.cropButton.destroy();oGraph.minZoom=oGraph.start===null?oGraph.firstdt:oGraph.start;oGraph.maxZoom=oGraph.end===null?oGraph.lastdt:oGraph.end}else{var btnOptions=$.extend(true,{},chart.options.chart.resetZoomButton);btnOptions.position.y+=30;var box={x:chart.plotLeft,y:chart.plotTop,width:chart.plotWidth,height:chart.plotHeight};chart.cropButton=chart.renderer.button("Crop X-axis",null,null,function(){$("#"+panelId+" button.graph-crop").click()},{zIndex:20},null).attr({align:"right"}).attr({align:btnOptions.position.align,title:"Crop x-axis to current zoom level"}).add().align(btnOptions.position,false,box);var axisMin=event.xAxis[0].min;var axisMax=event.xAxis[0].max;for(var i=0;i<oChartOptions.series.length;i++){var seriesData=oChartOptions.series[i].data;min=closestDate(axisMin,seriesData,min);max=closestDate(axisMax,seriesData,max)}oGraph.minZoom=min;oGraph.maxZoom=max}}}}console.time("highcharts");chart=new Highcharts.Chart(oChartOptions);if(oGraph.controls)oGraph.controls.chart=chart;console.timeEnd("highcharts");annotations.plotAnnotationSeries();if(!globals.isEmbedded){$chart.mouseover(function(e){if(annotations.banding){if(annotations.banding.substr(0,2)=="y-"){var top=$(chart.container).offset().top,left=$(chart.container).offset().left;var x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft,y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){for(var i=0;i<chart.yAxis.length;i++){if(chart.yAxis[i].userOptions.title.text==annotations.banding.substr(2)){var axisValue=chart.yAxis[i].translate(chart.plotHeight-y,true);chart.yAxis[i].removePlotBand("hb"+annotations.bandNo);chart.yAxis[i].addPlotBand({id:"hb"+annotations.bandNo,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:parseFloat(annotations.bandStartPoint),to:axisValue,label:{text:"",zIndex:3}})}}}}}}).keydown(function(e){if(annotations.banding&&e){for(var a=0;a<chart.axes.length;a++){chart.axes[a].removePlotLine(annotations.banding);chart.axes[a].removePlotBand(annotations.banding)}annotations.banding=false}});console.time("contextMenu");$.contextMenu({selector:"#"+panelId+" div.mashabledata_chart",build:function($trigger,e){var i,x,y,top,left;var axisName,axisValue,isRegression,isAverage;var pointSelected=annotations.mouseoverPoint;var onPoint=typeof annotations.mouseoverPoint!="undefined";if(annotations.banding){return annotations.endBanding(e)}else{var mnu={items:{point:{name:"annotate point",disabled:!onPoint,callback:function(key,opt){annotations.addPoint(pointSelected)}},sep0:"---------",vline:{name:"add vertical line",disabled:!onPoint,callback:function(key,opt){annotations.addXLine(pointSelected)}},vband:{name:"start vertical band",disabled:!onPoint,callback:function(key,opt){annotations.startXBand(pointSelected)}},sep1:"---------",hline:{name:"add horizontal line",items:{}},hband:{name:"start horizontal band",items:{}},sep2:"---------",avg:{name:"start average",disabled:!onPoint,callback:function(key,opt){if(!isAverage){annotations.startAnalysisBanding(pointSelected,"AV")}else{annotations.deleteAnalysis(pointSelected)}}},regression:{name:"start linear regression",disabled:!onPoint,callback:function(key,opt){if(!isRegression){annotations.startAnalysisBanding(pointSelected,"LR")}else{annotations.deleteAnalysis(pointSelected)}}},standard:{name:"add standard annotations",items:{}}}};if(onPoint&&pointSelected.series.options.calculatedFrom&&pointSelected.series.options.id.substr(0,2)=="LR"){mnu.items.regression.name="delete linear regression";mnu.items.regression.className="delete-item";isRegression=true;delete mnu.items.avg}if(onPoint&&pointSelected.series.options.calculatedFrom&&pointSelected.series.options.id.substr(0,2)=="AV"){mnu.items.avg.name="delete average";mnu.items.avg.className="delete-item";isAverage=true;delete mnu.items.regression}top=$(chart.container).offset().top;left=$(chart.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-left)-chart.plotLeft;y=(isIE?e.originalEvent.y:e.pageY-top)-chart.plotTop;if(y>=0&&y<=chart.plotSizeY){for(i=0;i<chart.yAxis.length;i++){axisName=chart.yAxis[i].userOptions.title.text;axisValue=parseFloat(parseFloat(chart.yAxis[i].translate(chart.plotHeight-y,true).toPrecision(2)));mnu.items.hline.items["hltext"+i]={name:"<b>"+axisName+":</b>",type:"text",value:axisValue};mnu.items.hline.items["hladd"+i]={name:"<button>add</button>",callback:function(key,opt){var value=parseFloat($.contextMenu.getInputValues(opt)["hltext"+key.substr(5)]);var id="hl"+annotations.lineNo++;chart.yAxis[parseInt(key.substr(5))].addPlotLine({id:id,color:"#FF0000",width:2,value:value});oGraph.annotations.push({id:id,type:"hline",color:"#FF0000",from:value,yAxis:chart.yAxis[parseInt(key.substr(5))].userOptions.title.text,text:""});annotations.build("table-only")}};mnu.items.hband.items["hbtext"+i]={name:"<b>"+axisName+":</b>",type:"text",value:axisValue};mnu.items.hband.items["hbadd"+i]={name:"<button>start</button>",callback:function(key,opt){annotations.bandStartPoint=parseFloat($.contextMenu.getInputValues(opt)["hbtext"+key.substr(5)]);annotations.banding="y-"+chart.yAxis[key.substr(5)].userOptions.title.text;chart.yAxis[parseInt(key.substr(5))].addPlotBand({id:"hb"+annotations.bandNo++,color:equivalentRGBA(colorsPlotBands[0],BAND_TRANSPARENCY),from:annotations.bandStartPoint,to:annotations.bandStartPoint})}};if(i!=0){mnu.items.hline.items["yadd"+i+"sep"]="---------";mnu.items.hband.items["yadd"+i+"sep"]="---------"}}}else{if(!onPoint)return false;mnu.items.hline.disabled=true;mnu.items.hband.disabled=true}for(i=0;i<MD.globals.standardAnnotations.length;i++){mnu.items.standard.items["SA"+MD.globals.standardAnnotations[i].annoid]={name:MD.globals.standardAnnotations[i].name,callback:function(key,opt){annotations.addStandard(parseInt(key.substr(2)))}}}return mnu}}});console.timeEnd("contextMenu");$("#"+panelId+" .highcharts-title").click(function(){graphTitle.show(this)})}console.timeEnd("chartPanel");return chart;function setMapDate(jsDateClicked){var calcData=oGraph.calculatedMapData;if(oGraph.mapsets||oGraph.pointsets){if(calcData.startDateIndex!=calcData.endDateIndex){var jsDate=closestDate(jsDateClicked,calcData.dates);for(var i=0;i<calcData.dates.length;i++){if(calcData.dates[i]["dt"].getTime()==jsDate){oGraph.controls.$thisPanel.find(".mashabledata_map-slider").slider("value",i)}}}}}},intervalStartDt:function intervalStartDt(graph){var dt=new Date(parseInt(graph.lastdt));switch(graph.largestPeriod){case"A":return dt.setUTCFullYear(dt.getUTCFullYear()-(graph.intervals-1));case"SA":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1)*6);case"Q":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1)*3);case"M":return dt.setUTCMonth(dt.getUTCMonth()-(graph.intervals-1));case"W":return dt.setUTCDate(dt.getUTCDate()-(graph.intervals-1)*7);default:return dt.setUTCDate(dt.getUTCDate()-(graph.intervals-1))}},setCropSlider:function setCropSlider(panelId){if(globals.isEmbedded)return;var leftIndex,rightIndex,i,bestDelta,thisDelta;var oGraph=panelGraphs[panelId];var chartOptions=oGraph.controls.chart.options.chart;if(oGraph.start===null){leftIndex=0}else{i=chartOptions.x.indexOf(oGraph.start.toString());if(i>-1){leftIndex=i}else{bestDelta=null;for(i=0;i<chartOptions.x.length;i++){thisDelta=Math.abs(parseInt(chartOptions.x[i])-parseInt(oGraph.start));if(bestDelta===null||bestDelta>thisDelta){bestDelta=thisDelta;leftIndex=i}}}}if(oGraph.end===null){rightIndex=chartOptions.x.length-1}else{i=chartOptions.x.indexOf(oGraph.end.toString());if(i>-1){rightIndex=i}else{bestDelta=null;for(i=0;i<chartOptions.x.length;i++){thisDelta=Math.abs(parseInt(chartOptions.x[i])-parseInt(oGraph.end));if(bestDelta===null||bestDelta>thisDelta){bestDelta=thisDelta;rightIndex=i}}}}$("#"+panelId+" span.interval-crop-period").html(period.units[oGraph.largestPeriod]+"s");$("#"+panelId+" div.crop-slider").slider("option","max",chartOptions.x.length-1).slider("option","values",[leftIndex,rightIndex])},dateFromMdDate:function dateFromMdDate(mddt){var udt;udt=new Date("1/1/"+mddt.substr(0,4)+" UTC");if(mddt.length>4){switch(mddt.substr(4,1)){case"Q":udt.setUTCMonth((mddt.substr(5,1)-1)*3);break;case"H":udt.setUTCMonth((mddt.substr(5,1)-1)*6);break;default:udt.setUTCMonth(mddt.substr(4,2))}if(mddt.length>6){udt.setUTCDate(mddt.substr(6,2));if(mddt.length>8){udt.setUTCHours(mddt.substr(9,2));udt.setUTCMinutes(mddt.substr(12,2));udt.setUTCSeconds(mddt.substr(15,2))}}}return udt},closestDate:function closestDate(nearbyDate,seriesData,closestYet){var x;for(var i=0;i<seriesData.length;i++){if(Array.isArray(seriesData[i])){x=seriesData[i][0]}else{if(seriesData[i].dt){x=seriesData[i].dt.getTime()}else{x=seriesData[i].x}}if(Math.abs(nearbyDate-x)<Math.abs(nearbyDate-closestYet)||closestYet===undefined)closestYet=x}return closestYet},assetNeeded:function assetNeeded(handle,graph,assetsToFetch){graph.assets=graph.assets||{};if(!graph.assets[handle]){if(oMySeries&&oMySeries[handle]&&oMySeries[handle].data){graph.assets[handle]=$.extend(true,{},oMySeries[handle])}else{assetsToFetch[handle.charAt(0)].push(handle.substr(1))}}},getAssets:function getAssets(graph,callBack){var assetsToFetch={S:[],U:[],X:[],M:[]};var p,c,handle;eachComponent(graph,function(){assetNeeded(this.handle,graph,assetsToFetch)});fetchAssets(graph,assetsToFetch,callBack)},fetchAssets:function fetchAssets(graph,assetsToFetch,callBack){if(assetsToFetch.S.length>0||assetsToFetch.U.length>0){callApi({command:"GetMashableData",sids:assetsToFetch.S,usids:assetsToFetch.U,modal:"persist"},function(jsoData,textStatus,jqXHR){for(handle in jsoData.series)graph.assets[handle]=jsoData.series[handle];assetsToFetch.S=[];assetsToFetch.U=[];if(assetsToFetch.M.length+assetsToFetch.X.length+assetsToFetch.U.length+assetsToFetch.S.length==0)callBack()})}if(assetsToFetch.M.length>0){callApi({command:"GetMapSets",mapsetids:assetsToFetch.M,map:graph.map,modal:"persist"},function(jsoData,textStatus,jqXHR){for(handle in jsoData.mapsets)graph.assets[handle]=jsoData.mapsets[handle];assetsToFetch.M=[];if(assetsToFetch.M.length+assetsToFetch.X.length+assetsToFetch.U.length+assetsToFetch.S.length==0)callBack()})}if(assetsToFetch.X.length>0){callApi({command:"GetPointSets",pointsetids:assetsToFetch.X,map:graph.map,modal:"persist"},function(jsoData,textStatus,jqXHR){for(handle in jsoData.pointsets)graph.assets[handle]=jsoData.pointsets[handle];assetsToFetch.X=[];if(assetsToFetch.M.length+assetsToFetch.X.length+assetsToFetch.U.length+assetsToFetch.S.length==0)callBack()})}if(assetsToFetch.M.length+assetsToFetch.X.length+assetsToFetch.U.length+assetsToFetch.S.length==0)callBack()},createMyGraph:function createMyGraph(id,onComplete){var myGraph=oMyGraphs["G"+id];if(myGraph){createGraph($.extend(true,{},myGraph))}else{for(var gid in oMyGraphs){if(oMyGraphs[gid].ghash==id){myGraph=oMyGraphs[gid];break}}if(myGraph){createGraph($.extend(true,{},myGraph))}else{callApi({command:"GetPublicGraph",ghash:id},function(oReturn,textStatus,jqXH){for(var ghandle in oReturn.graphs){grapher.inflateGraph(oReturn.graphs[ghandle]);createGraph(oReturn.graphs[ghandle])}})}}function createGraph(graph){var fileAssets=(globals.isEmbedded?[]:graphScriptFiles).concat(graph.mapFile?[(globals.isEmbedded?"//remote.mashabledata.com/":"/global/js/maps/")+graph.mapFile+".js"]:[]);require(fileAssets);getAssets(graph,function(){require(fileAssets,function(){buildGraphPanel(graph);if(onComplete)onComplete()})})}},inflateGraph:function inflateGraph(graph){if(graph.annotations){graph.annotations=safeParse(graph.annotations,[])}else{graph.annotations=[]}for(var plot in graph.plots){graph.plots[plot].options=safeParse(graph.plots[plot].options,{});for(var comp in graph.plots[plot].components){graph.plots[plot].components[comp].options=safeParse(graph.plots[plot].components[comp].options,{})}}for(var plot in graph.pointsets){graph.pointsets[plot].options=safeParse(graph.pointsets[plot].options,{});for(var comp in graph.pointsets[plot].components){graph.pointsets[plot].components[comp].options=safeParse(graph.pointsets[plot].components[comp].options,{})}}graph.mapconfig=safeParse(graph.mapconfig,{});if(graph.mapsets){graph.mapsets.options=safeParse(graph.mapsets.options,{});for(var comp in graph.mapsets.components){graph.mapsets.components[comp].options=safeParse(graph.mapsets.components[comp].options,{})}}function safeParse(jsonString,emptyValue){try{return JSON.parse(jsonString.replace(/u0022/g,'"'))}catch(e){return emptyValue}}},emptyGraph:function emptyGraph(){return{annotations:[],title:"",type:"auto",map:"",assets:{},analysis:null,mapconfig:{},start:null,end:null,published:"N"}},makeChartOptionsObject:function makeChartOptionsObject(oGraph){console.time("makeChartOptionsObject");var i,j,dt,allX={},xVals={};var jschart={chart:{animation:false,type:"line",zoomType:"x",x:[]},exporting:{enabled:false},plotOptions:{area:{stacking:"normal"},scatter:{zIndex:20,showInLegend:false},series:{zIndex:10,marker:{enabled:true,radius:4,symbol:"circle",states:{hover:{enabled:true}}},shadow:false,dataLabels:{align:"center",enabled:true,color:"#ffffff",formatter:function(){if(typeof this.point.id!="undefined"){return this.point.id}},y:9,x:0}}},legend:{enabled:true},credits:{enabled:true,text:"created with MashableData.com",href:"http://www.mashabledata.com"},series:[],title:{text:oGraph.title,style:{cursor:"pointer"}},xAxis:{type:"datetime",min:oGraph.start===null?oGraph.intervals?intervalStartDt(oGraph):null:parseInt(oGraph.start),max:oGraph.end===null?null:parseInt(oGraph.end)},yAxis:[]};if(oGraph.controls)jschart.chart.height=(oGraph.controls.$thisPanel.height()-70-(oGraph.map?70:0))*(oGraph.mapsets||oGraph.pointsets?.4:1);if(oGraph.title.length==0){jschart.title.text="untitled - click to edit";jschart.title.style.color="grey";jschart.title.style.font="italic"}var lineIndex=0;function firstLast(main,asset){if(typeof asset.firstdt!="undefined"){main.firstdt=typeof main.firstdt=="undefined"?parseInt(asset.firstdt):Math.min(parseInt(asset.firstdt),parseInt(main.firstdt));main.lastdt=typeof main.lastdt=="undefined"?parseInt(asset.lastdt):Math.max(parseInt(asset.lastdt),parseInt(main.lastdt))}else{if(asset.mapsetid||asset.pointsetid){for(location in asset.data){main.firstdt=typeof main.firstdt=="undefined"?parseInt(asset.data[location].firstdt):Math.min(parseInt(asset.data[location].firstdt),parseInt(main.firstdt));main.lastdt=typeof main.lastdt=="undefined"?parseInt(asset.data[location].lastdt):Math.max(parseInt(asset.data[location].lastdt),parseInt(main.lastdt))}}}}eachComponent(oGraph,function(i,plot){var asset=oGraph.assets[this.handle];if(asset.src=="MashableData"){if(plot.components.length==1){if(!oGraph.firstdt&&!oGraph.lastdt)eachComponent(oGraph,function(){firstLast(oGraph,oGraph.assets[this.handle])});asset.firstdt=oGraph.firstdt;asset.lastdt=oGraph.lastdt}else{delete asset.firstdt;delete asset.lastdt;$.each(plot.components,function(){firstLast(asset,oGraph.assets[this.handle])})}asset.data=dateConversionData(asset.skey,asset.firstdt,asset.lastdt)}});for(i=0;i<oGraph.plots.length;i++){var oPlot=oGraph.plots[i];var oSerie=createSerieFromPlot(oGraph,i);if(!oPlot.options.color)oPlot.options.color=nextColor(oGraph.plots);var oDataSeries={name:oSerie.name,marker:{enabled:oGraph.type=="marker"},id:"P"+i,period:oSerie.period,color:oPlot.options.color,data:oSerie.data,yAxis:0};if(oPlot.options.type){if(oPlot.options.type!="default")oDataSeries.type=oPlot.options.type}if(oPlot.options.lineWidth)oDataSeries.lineWidth=oPlot.options.lineWidth;if(oPlot.options.lineStyle)oDataSeries.dashStyle=oPlot.options.lineStyle;if(oGraph.type=="area"||oDataSeries.stack=="area"){oDataSeries.stack=oSerie.units}for(j=0;j<oSerie.data.length;j++){allX[oSerie.data[j][0].toString()]=true}var units=oSerie.units;var newAxis={labels:{style:{color:"#333333"}},title:{text:units,style:{color:"#333333"}}};if(jschart.yAxis.length==0){jschart.yAxis.push(newAxis)}else{var bMatch=false;var iAxis;for(iAxis=0;iAxis<jschart.yAxis.length;iAxis++){if(jschart.yAxis[iAxis].title.text==units){oDataSeries.yAxis=iAxis;bMatch=true;break}}if(!bMatch){newAxis.title.style.color=oDataSeries.color;newAxis.labels.style.color=oDataSeries.color;jschart.yAxis[0].title.style.color=jschart.series[0].color;jschart.yAxis[0].labels.style.color=jschart.series[0].color;newAxis.opposite=true;jschart.yAxis.push(newAxis);oDataSeries.yAxis=iAxis}}jschart.series.push(oDataSeries);lineIndex++}for(var key in allX){jschart.chart.x.push(Number(key))}jschart.chart.x.sort(function(a,b){return parseInt(a)-parseInt(b)});for(i=0;i<jschart.yAxis.length;i++){jschart.series.push({type:"scatter",id:"labelsY-"+i,yAxis:i,data:[],doNotShow:true})}switch(oGraph.type){case"pie":var oPieSeries=[{type:"pie",data:[]}];var timePoint=oGraph.end?parseInt(oGraph.end):oGraph.lastdt;for(i=0;i<jschart.series.length;i++){oSerie=jschart.series[i];for(j=oSerie.data.length-1;j>=0;j--){if(oSerie.data[j][0]==timePoint){oPieSeries[0].data.push([oSerie.name,oSerie.data[j][1]]);break}}}jschart.series=oPieSeries;jschart.chart.type=oGraph.type;break;case"stacked-column":jschart.plotOptions.column={stacking:"normal"};for(i=0;i<jschart.series.length;i++){jschart.series[i].stack="stacked"}case"column":jschart.chart.type="column";break;case"area-percent":jschart.yAxis[0].title.text="percent";jschart.plotOptions.area.stacking="percent";case"area":jschart.chart.type="area";break;case"marker":break;case"auto":if(oGraph.smallestPeriod!=oGraph.largestPeriod){for(i=0;i<jschart.series.length;i++){if(oGraph.largestPeriod==jschart.series[i].period){jschart.series[i].type="column";jschart.series[i].zIndex=8;jschart.series[i].pointRange=period.value[jschart.series[i].period];jschart.series[i].pointPlacement="between";jschart.series[i].pointPadding=0;jschart.series[i].groupPadding=.05}}}else{var maxCount=0,onscreenCount;for(i=0;i<jschart.series.length;i++){if(jschart.series[i].period){onscreenCount=0;for(j=0;j<jschart.series[i].data.length;j++){dt=jschart.series[i].data[j][0];if((!jschart.xAxis.min||jschart.xAxis.min<=dt)&&(!jschart.xAxis.max||jschart.xAxis.max>=dt))onscreenCount++}maxCount=Math.max(maxCount,onscreenCount)}}if(maxCount<=5){jschart.chart.type="column";if(maxCount==1&&oGraph.smallestPeriod){if(jschart.xAxis.min)jschart.xAxis.min-=period.value[oGraph.smallestPeriod]/4;if(jschart.xAxis.max)jschart.xAxis.max+=period.value[oGraph.smallestPeriod]/4}}}break;case"logarithmic":for(i=0;i<jschart.yAxis.length;i++){jschart.yAxis[i].type="logarithmic"}break;case"normalized-line":var firstDate;if(oGraph.start){firstDate=oGraph.start}else{firstDate=jschart.series[0].data[0][0]}var matched=false;while(!matched){matched=true;for(i=0;i<jschart.series.length;i++){if(jschart.series[i].sid){while(firstDate>jschart.series[i].data[0][0]){jschart.series[i].data.splice(0,1);if(jschart.series[i].data.length==0){break}if(firstDate<jschart.series[i].data[0][0]){firstDate=jschart.series[i].data[0][0]}}if(jschart.series[i].data.length==0){jschart.title.text="Error:  no common starting point for normalization";for(j=0;j<jschart.series.length;j++){jschart.series[j].data=[]}matched=true;break}matched=matched&&firstDate==jschart.series[i].data[0][0]}}}for(i=0;i<jschart.series.length;i++){for(j=jschart.series[i].data.length-1;j>=0;j--){jschart.series[i].data[j][1]=jschart.series[i].data[j][1]/jschart.series[i].data[0][1]}jschart.seriesyAxis=0}jschart.yAxis=[{title:{text:"Normalized to 1"}}]}if(oGraph.smallestPeriod)jschart.xAxis.minTickInterval=period.value[oGraph.smallestPeriod];console.timeEnd("makeChartOptionsObject");return jschart},createSerieFromPlot:function createSerieFromPlot(oGraph,plotIndex){console.time("createSerieFromPlot");var valuesObject,y,components,i,j,sHandle,plot,calculatedSeries,data,point,plotData=[],dateKey,oComponentData={};plot=oGraph.plots[plotIndex];calculatedSeries={name:plotName(oGraph,plot),units:plotUnits(oGraph,plot)};components=plot.components;calculatedSeries.period=plot.options.fdown||oGraph.assets[components[0].handle].period;plot.formula=plotFormula(plot);var expression="return "+plot.formula.formula.replace(patVariable,"values.$1")+";";var compute=new Function("values",expression);var compSymbols=[],symbol;for(i=0;i<components.length;i++){symbol=compSymbol(i);compSymbols.push(symbol);if(plot.options.fdown&&plot.options.fdown!=oGraph.assets[components[i].handle].period){data=common.downShiftData(oGraph.assets[components[i].handle],plot.options.fdown,plot.options.algorithm,plot.options.missing)}else{data=oGraph.assets[components[i].handle].data.split("||")}for(j=0;j<data.length;j++){point=data[j].split("|");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]}}var required=!plot.options.componentData||plot.options.componentData=="required";var missingAsZero=plot.options.componentData=="missingAsZero";var nullsMissingAsZero=plot.options.componentData=="nullsMissingAsZero";var breakNever=!plot.options.breaks||plot.options.breaks=="never";var breakNulls=plot.options.breaks=="nulls";var breakMissing=plot.options.breaks=="missing";for(dateKey in oComponentData){valuesObject={};y=true;for(i=0;i<compSymbols.length;i++){if(!isNaN(oComponentData[dateKey][compSymbols[i]])){valuesObject[compSymbols[i]]=parseFloat(oComponentData[dateKey][compSymbols[i]])}else{if(oComponentData[dateKey][compSymbols[i]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{if(required){y=null;break}else{valuesObject[compSymbols[i]]=0}}}}if(y){try{y=compute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null||!breakNever){if(y!==null)y=rationalize(y);plotData.push([Date.parse(dateFromMdDate(dateKey)),y])}}plotData.sort(function(a,b){return a[0]-b[0]});if(breakMissing){plotData=addBreaks(plotData,calculatedSeries.period)}calculatedSeries.data=plotData;console.timeEnd("createSerieFromPlot");return calculatedSeries},plotFormula:function plotFormula(plot){var cmp,variable,isDenom=false,inDivision=false,numFormula="",denomFormula="",term="",formula="";var patMultiterm=/[+-/*]+/;for(var i=0;i<plot.components.length;i++){cmp=plot.components[i];variable=compSymbol(i);if(!isDenom&&cmp.options.dn&&cmp.options.dn=="d"){if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term}numFormula=formula;formula="";isDenom=true}if(formula.length==0){switch(cmp.options.op){case"/":inDivision=true;term=subTerm();formula="1/";break;case"-":formula="-"+subTerm();break;case"+":case"*":default:formula=subTerm()}}else{switch(cmp.options.op){case"+":case"-":if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term+" "+cmp.options.op+" "+subTerm()}else{formula+=" "+cmp.options.op+" "+subTerm()}break;case"*":if(inDivision){term+="*"+subTerm()}else{formula+="*"+subTerm()}break;case"/":if(inDivision){term+="*"+subTerm()}else{inDivision=true;formula+="/";term=subTerm()}}}}if(inDivision){inDivision=false;if(patMultiterm.test(term))term="("+term+")";formula+=term}if(isDenom){denomFormula=formula}else{numFormula=formula}if((plot.options.k||1)==1){if(isDenom){formula=(numFormula==""?1:patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)+" / "+(patMultiterm.test(denomFormula)?"("+denomFormula+")":denomFormula)}else{formula=numFormula}}else{if(isDenom){formula=plot.options.k+" * "+(numFormula=""?"":patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)+" / "+(patMultiterm.test(denomFormula)?"("+denomFormula+")":denomFormula)}else{formula=plot.options.k+" * "+(patMultiterm.test(numFormula)?"("+numFormula+")":numFormula)}}plot.options.calculatedFormula={formula:formula,denomFormula:denomFormula,numFormula:numFormula,k:plot.options.k||1};return plot.options.calculatedFormula;function subTerm(){return isNaN(cmp.options.k)||cmp.options.k==1?variable:cmp.options.k+"*"+variable}},compSymbol:function compSymbol(compIndex){var symbol="";if(compIndex>25){symbol=String.fromCharCode("A".charCodeAt(0)+parseInt(compIndex/26))}symbol+=String.fromCharCode("A".charCodeAt(0)+compIndex%26);return symbol},buildGraphPanel:function buildGraphPanel(oGraph,panelId){if(globals.isEmbedded){buildGraphPanelCore(oGraph)}else{mask("drawing the graph"+(window.SVGAngle?"":"<br>Note: Graphs will draw 20 times faster in a modern browser such as Chrome, Firefox, Safari or Internet Exploer 9 or later"));window.setTimeout(function(){buildGraphPanelCore(oGraph,panelId)},20)}function buildGraphPanelCore(oGraph,panelId){var title,calculatedMapData,$thisPanel;console.time("buildGraphPanel:header");if(oGraph.title.length==0){var key,assetCount=0;for(key in oGraph.assets){assetCount++;if(assetCount>1)break}if(assetCount==1)oGraph.title=oGraph.assets[key].name}title=oGraph.title;var panelHTML,isEmbedded=globals.isEmbedded;
if(isEmbedded){panelId="G"+oGraph.ghash;$thisPanel=$("div[data='"+oGraph.ghash+"']:first");if($thisPanel.length==0)return}else{if(!panelId){panelId=addTab(title);$("#graph-tabs li").find("[href='#"+panelId+"']").html(title)}$thisPanel=$("#"+panelId)}if(oGraph.intervals==0)oGraph.intervals=null;var annotations=new MashableData.Annotator(panelId,makeDirty);oGraph.controls={annotations:annotations,$thisPanel:$thisPanel,provenance:{},redraw:redraw};console.timeEnd("buildGraphPanel:header");if(isEmbedded){panelHTML='<div class="mashabledata_chart-map">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<span class="right"><label><input type="checkbox" class="mashabledata_legend" '+(oGraph.mapconfig.showLegend?"checked":"")+">legend</label></span>"+'<span class="right"><label><input type="checkbox" class="mashabledata_map-list" '+(oGraph.mapconfig.showList?"checked":"")+">list</label></span>"+"</div>"+"</div>"+'<div class="mashabledata_graph-analysis"></div>'+"</div>"}else{panelHTML='<div class="graph-nav">'+'<ol class="graph-nav">'+'<li class="graph-nav-talk" data="graph-talk"></li>'+'<li class="graph-nav-data" data="graph-data"></li>'+'<li class="graph-nav-sources"  data="graph-sources"></li>'+'<li class="graph-nav-active graph-nav-graph" data="graph-chart"></li>'+"</ol>"+"</div>"+'<div class="graph-talk graph-subpanel" style="display: none;"><p>This graph must be saved at least once to enable Facebook comments.</p></div>'+'<div class="graph-data graph-subpanel" style="display: none;">'+'<div class="graph-data-inner">'+"<ul>"+'<li><a href="#data-chart-'+panelId+'">chart data</a></li>'+'<li><a href="#data-region-'+panelId+'">map region data</a></li>'+'<li><a href="#data-marker-'+panelId+'">map marker data</a></li>'+'</ul><button class="download-data ui-state-highlight" title="Download the graph data as an Excel workbook">Download to Excel&nbsp;</button>'+'<div id="data-chart-'+panelId+'" class="graph-data-subpanel" data="chart"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-region-'+panelId+'" class="graph-data-subpanel" data="regions"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-marker-'+panelId+'" class="graph-data-subpanel" data="markers"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+"</div>"+"</div>"+'<div class="provenance graph-sources graph-subpanel" style="display: none;"></div>'+'<div class="graph-chart graph-subpanel">'+'<div class="graph_control_panel" style="font-size: 11px !important;">'+'<div class="change-map">change base map '+'<select class="change-map"></select>'+"</div>"+'<div class="graph-type">default graph type '+'<select class="graph-type">'+'<option value="auto">auto (line &amp; column)</option>'+'<option value="line">line</option>'+'<option value="marker">line with markers</option>'+'<option value="column">column</option>'+'<option value="stacked-column">stacked column</option>'+'<option value="area-percent">stacked percent</option>'+'<option value="area">stacked area</option>'+'<option value="logarithmic">logarithmic</option>'+'<option value="normalized-line">normalized line</option>'+'<option value="pie">pie</option>'+"</select>"+"</div>"+'<div class="crop-tool"><fieldset><legend>Crop graph</legend>'+"<table>"+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-no-crop" class="rad-no-crop"></td><td><label for="'+panelId+'-rad-no-crop">no cropping (graph will expand as new data is gathered)</label></td></tr>'+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-hard-crop" class="rad-hard-crop"></td><td>'+'<div class="crop-dates"><i>select this option and slide endpoints for a fixed crop</i></div>'+'<div class="crop-slider"></div>'+"</td></tr>"+'<tr><td><input type="radio" name="'+panelId+'-rad-crop" id="'+panelId+'-rad-interval-crop" class="rad-interval-crop"></td>'+'<td><label for="'+panelId+'-rad-interval-crop">show latest <input class="interval-crop-count" value="'+(oGraph.intervals||5)+'"> <span class="interval-crop-period"></span></label></td></tr>'+"</table>"+'<button class="graph-crop" style="display: none;">crop</button></fieldset>'+"</div>"+'<div class="annotations"><fieldset><legend>Chart annotations</legend>'+'<table class="annotations"></table>'+"</fieldset></div>"+'<div class="downloads">'+"<fieldset>"+"<legend>&nbsp;Download visualization&nbsp;</legend>"+'<select class="download-selector"></select> '+"format: "+'<span title="download the graph as a PNG formatted image" class="md-png rico export-chart">PNG</span>'+'<span title="download the graph as a SVG formatted vector graphic"class="md-svg rico export-chart">SVG</span>'+'<span title="download the graph as a PDF document" class="md-pdf rico export-chart">PDF</span>'+"</fieldset>"+"</div>"+'<div class="sharing">'+"<fieldset>"+"<legend>&nbsp;Sharing&nbsp;</legend>"+'<div class="share-links">'+'<a href="#" class="post-facebook"><img src="images/icons/facebook.png" />facebook</a> '+'<a class="graph-email">email </a> '+'<button class="graph-link">link </button>'+'</div><div class="searchability">'+'<input type="radio" name="'+panelId+'-searchability" id="'+panelId+'-searchable" value="Y" '+(oGraph.published=="Y"?"checked":"")+' /><label for="'+panelId+'-searchable">public graph</label>'+'<input type="radio" name="'+panelId+'-searchability" id="'+panelId+'-private" value="N" '+(oGraph.published=="N"?"checked":"")+' /><label for="'+panelId+'-private">'+(account.info.orgName?"restrict to "+account.info.orgName:"not searchable")+"</label>"+"</div>"+"</fieldset>"+"</div>"+'<br /><button class="graph-save">save</button> <button class="graph-saveas">save as</button> <button class="graph-close">close</button> <button class="graph-delete">delete</button><br />'+"</div>"+'<div class="mashabledata_chart-map" style="width:70%;display:inline;float:right;">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<button class="merge group hidden" disabled="disabled">group</button>'+'<button class="merge ungroup hidden" disabled="disabled">ungroup</button>'+'<span class="right"><label><input type="checkbox" class="legend" '+(oGraph.mapconfig.showLegend?"checked":"")+">legend</label></span>"+'<span class="right"><label><input type="checkbox" class="map-list" '+(oGraph.mapconfig.showList?"checked":"")+">list</label></span>"+"</div>"+"</div>"+'<div height="75px"><textarea style="width:98%;height:50px;margin-left:5px;" class="graph-analysis" maxlength="1000" /></div>'+"</div>"+"</div>"}$thisPanel.html(panelHTML);var chart,grid;console.timeEnd("buildGraphPanel:thisPanel");console.time("buildGraphPanel:thisPanel events");if(isEmbedded){$thisPanel.find("div.mashabledata_graph-analysis").html(oGraph.analysis)}else{function enableComments(){if(oGraph.ghash)$thisPanel.find(".graph-talk.graph-subpanel").html('<fb:comments href="https://www.mashabledata.com/workbench/#/t=g&graphcode='+oGraph.ghash+'"></fb:comments>')}enableComments();$thisPanel.find("ol.graph-nav").children("li").click(function(){var $this=$(this);$thisPanel.find("ol.graph-nav").children("li").removeClass("graph-nav-active");$thisPanel.find(".graph-subpanel").hide();var $div=$thisPanel.find("."+$this.attr("data")).show();$this.addClass("graph-nav-active");switch($this.attr("data")){case"graph-talk":FB.XFBML.parse($div.get(0),function(){$thisPanel.find("iframe").width($thisPanel.find(".graph-talk.graph-subpanel").width()*.9+"px").css("margin","15px")});break;case"graph-data":provenance.provOk();$thisPanel.find(".graph-data-inner").tabs(oGraph.plots?"enable":"disable",0).tabs(oGraph.mapsets?"enable":"disable",1).tabs(oGraph.pointsets?"enable":"disable",2);var dataTabLink=$thisPanel.find(".graph-data-inner li:not(.ui-state-disabled)").first().find("a").click();if(dataTabLink.html()=="chart data")makeSlickDataGrid(grid,panelId,$(dataTabLink.attr("href")));break;case"graph-sources":provenance.build();break;case"graph-chart":provenance.provOk()}});$thisPanel.find(".graph-data-inner").tabs({activate:function(event,ui){console.timeEnd("complete grid data into table");makeSlickDataGrid(grid,panelId,ui.newPanel);console.timeEnd("complete grid data into table")}});$thisPanel.find("button.download-data").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var grids=[];if(oGraph.plots){var chartDataObject=gridDataForChart(panelId);grids.push({name:"chart",grid:{columns:chartDataObject.columns,data:chartDataObject.rows}})}if(oGraph.mapsets)grids.push({name:"regions",grid:{columns:calculatedMapData.regionGrid.columns,data:calculatedMapData.regionGrid.data}});if(oGraph.pointsets)grids.push({name:"markers",grid:{columns:calculatedMapData.markerGrid.columns,data:calculatedMapData.markerGrid.data}});downloadMadeFile({filename:oGraph.title,data:JSON.stringify(grids),url:"excel.php"})});var innerHeight=$thisPanel.find(".graph-subpanel").width($thisPanel.width()-35-2).height($thisPanel.height()).find(".mashabledata_chart-map").width($thisPanel.width()-40-350).end().innerHeight();$thisPanel.find(".graph-data-subpanel").height($thisPanel.innerHeight()-60);$thisPanel.find(".graph-sources").width($thisPanel.width()-35-2-40);$thisPanel.find(".graph-analysis").val(oGraph.analysis);$thisPanel.find("select.download-selector").change(function(){if($(this).val()=="map"){if(!oGraph.mapsets&&!oGraph.pointsets){dialogShow("no map","This graph does not have a map to download.  Map are adding to graphs by finding a series that belongs to a map set or a marker set and mapping the set.");$(this).val("chart")}}else{if(!oGraph.plots){dialogShow("no chart","This graph does not have a chart to download.");$(this).val("map")}}});$thisPanel.find(".export-chart").click(function(){var type,$this=$(this);if($this.hasClass("md-jpg"))type="image/jpeg";if($this.hasClass("md-png"))type="image/png";if($this.hasClass("md-svg"))type="image/svg+xml";if($this.hasClass("md-pdf"))type="application/pdf";exportChart(type)});$thisPanel.find("a.post-facebook").click(function(){var svg;if(oGraph.mapsets||oGraph.pointsets){svg=cleanMapSVG($map.container.html())}else{annotations.sync();svg=oGraph.controls.chart.getSVG()}$.ajax({type:"POST",url:"export/index.php",dataType:"json",data:{type:"FB",width:"800",svg:svg},success:function(chartInfo,textStatus,jqXH){var body=panelGraphs[panelId].analysis;var caption=panelGraphs[panelId].title;var obj={method:"feed",link:"http://www.mashabledata.com/workbench#/t=g1&graphcode="+panelGraphs[panelId].ghash,picture:chartInfo.imageURL,message:body,name:"MashableData visualization",caption:caption,description:body};function callback(response){alert("Post ID: "+response["post_id"])}FB.ui(obj,callback)},error:function(response,textStatus,jqXH){console.log(textStatus)}})});var link="mailto: "+"?subject="+escape(oGraph.title||"link to my MashableData visualization")+"&body="+escape((oGraph.analysis||"Link to my interactive visualization on MashableData.com:")+"<br><br>http://www.mashabledata.com/workbench/#/t=g2&graphcode="+oGraph.ghash);$thisPanel.find(".graph-email").button({icons:{secondary:"ui-icon-mail-closed"}}).attr("href",link);$thisPanel.find(".email-link").attr("href",link);$thisPanel.find(".graph-link").button({icons:{secondary:"ui-icon-link"}}).click(function(){if(oGraph.isDirty){dialogShow("Graph is not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var offset=$(this).offset();var linkDivHTML='<div id="link-editor">'+'<button class="right" id="link-editor-close">close</button>'+'<button id="ghash-reset" class="ui-state-error right">reset link code</button>'+'<b>link code: </b><span id="link-ghash">'+oGraph.ghash+"</span><br><br>"+"<em>The code below will create a link to your graph</em>"+'<textarea id="link-html">&lt;a href=&quot;http://www.mashabledata.com/workbench/#/t=g2&graphcode='+oGraph.ghash+"&quot;&gt;"+(oGraph.title||"MashableData graph")+"&lt;/a&gt;</textarea>"+"</div>";$.fancybox(linkDivHTML,{width:600,height:100,showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#fancybox-wrap").css({top:parseInt(offset.top+$(this).height()-30)+"px",left:parseInt(offset.left-620+$(this).width())+"px"});$("#link-editor-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()});$("#ghash-reset").button({icons:{secondary:"ui-icon-refresh"}}).click(function(){dialogShow("confirm link code reset","If you have emailed a link to this graph or posted it on FaceBook or Twitter, those links will no longer work once the graph's link code is reset. Plese confirm to reset.",[{text:"Confirm",click:function(){$(this).dialog("close");$("#ghash-reset").button("disable");callApi({command:"resetGhash",gid:oGraph.gid},function(oReturn,textStatus,jqXH){var $linkHtml=$("#link-html");$linkHtml.html($linkHtml.html().replace(oGraph.ghash,oReturn.ghash));oGraph.ghash=oReturn.ghash;$("#link-ghash").html(oGraph.ghash)})}},{text:"Cancel",click:function(){$(this).dialog("close")}}])})});$thisPanel.find(".searchability").buttonset().find("#"+panelId+"-private").button("option","icons",{primary:"ui-icon-locked"}).end().find("#"+panelId+"-searchable").button("option","icons",{primary:"ui-icon-search"}).end().find("input").click(function(){oGraph.published=$(this).val();makeDirty()});if(oGraph.start&&oGraph.end){$thisPanel.find(".rad-hard-crop").attr("checked",true)}else{if(oGraph.intervals){$thisPanel.find(".rad-interval-crop").attr("checked",true)}else{$thisPanel.find(".rad-no-crop").attr("checked",true)}}var hardCropFromSlider=function(){var values=$thisPanel.find(".crop-slider").slider("values");$thisPanel.find(".rad-hard-crop").attr("checked",true);oGraph.intervals=null;oGraph.start=oGraph.controls.chart.options.chart.x[values[0]];oGraph.end=oGraph.controls.chart.options.chart.x[values[1]];redraw()};var cropDates=function(slider){var values=$(slider).slider("values");return formatDateByPeriod(oGraph.controls.chart.options.chart.x[values[0]],oGraph.smallestPeriod)+" - "+formatDateByPeriod(chart.options.chart.x[values[1]],oGraph.smallestPeriod)};$thisPanel.find("div.crop-slider").slider({range:true,stop:function(){hardCropFromSlider()},change:function(){if(oGraph.controls.chart){$thisPanel.find(".crop-dates").html(cropDates(this))}},slide:function(){$thisPanel.find(".crop-dates").html(cropDates(this))}});$("#"+panelId+"-rad-hard-crop").change(function(){hardCropFromSlider()});$("#"+panelId+"-rad-interval-crop").change(function(){if($(this).val()=="on"){var interval=parseInt($thisPanel.find("input.interval-crop-count").val());if(!interval||interval<1){interval=1;$thisPanel.find("input.interval-crop-count").val(interval)}oGraph.intervals=interval;oGraph.start=null;oGraph.end=null;redraw()}});$("#"+panelId+"-rad-no-crop").change(function(){oGraph.intervals=null;oGraph.start=null;oGraph.end=null;oGraph.minZoom=oGraph.firstdt;oGraph.maxZoom=oGraph.lastdt;redraw()});$thisPanel.find("input.interval-crop-count").spinner({min:1,incrementalType:false,stop:function(event,ui){oGraph.start=null;oGraph.end=null;if(oGraph.intervals!=parseInt($(this).val())){oGraph.intervals=parseInt($(this).val());chart=chartPanel(panelId);if(oGraph.plots)annotations.build()}}});$thisPanel.find("button.graph-crop").click(function(){var graph=panelGraphs[panelId];graph.start=graph.minZoom>graph.firstdt?graph.minZoom:graph.firstdt;graph.end=graph.maxZoom<graph.lastdt?graph.maxZoom:graph.lastdt;$(this).attr("disabled","disabled");setCropSlider(panelId);$("#"+panelId+"-rad-hard-crop").click()});$thisPanel.find("div.annotations fieldset").height(innerHeight-$thisPanel.find("div.change-map").height()-$thisPanel.find("div.crop-tool").height()-$thisPanel.find("div.graph-type").height()-$thisPanel.find("div.downloads").height()-$thisPanel.find("div.sharing").height()-50);$thisPanel.find("input.graph-publish").change(function(){oGraph.published=this.checked?"Y":"N"});$thisPanel.find("select.graph-type").val(oGraph.type).change(function(){if($(this).val()=="logarithmic"){for(var y=0;y<chart.yAxis.length;y++){if(chart.yAxis[y].getExtremes().dataMin<=0){$thisPanel.find("select.graph-type").val(oGraph.type);dialogShow("Logarithmic scaling not available","Logarithmic Y-axis scaling is not allowed if negative values are present");return false}}}oGraph.type=$(this).val();redraw()});function fillChangeMapSelect(){var handle,i,map,html="<option>"+oGraph.map+"</option>",maps=[];for(handle in oGraph.assets){if(handle[0]=="M"&&oGraph.assets[handle].maps){for(map in oGraph.assets[handle].maps){if(map!=oGraph.map){maps.push(map)}}}}maps.sort();for(i=0;i<maps.length;i++){html+="<option>"+maps[i]+"</option>"}return html}$thisPanel.find("select.change-map").html(fillChangeMapSelect()).change(function(){var $mapSelect=$(this);var assets=oGraph.assets;delete oGraph.assets;var calculatedMapData=oGraph.calculatedMapData;delete oGraph.calculatedMapData;delete oGraph.assets;var controls=oGraph.controls;delete oGraph.controls;var newGraph=$.extend(true,{},oGraph);oGraph.assets=assets;newGraph.assets={};oGraph.calculatedMapData=calculatedMapData;oGraph.controls=controls;newGraph.map=$(this).val();newGraph.mapFile=mapsList[$(this).val()].jvectormap;var i,oBunnies={};function findBunnies(plot){var asset;for(i=0;i<plot.components.length;i++){if(vectorPattern.test(plot.components[i].handle)){asset=assets[plot.components[i].handle];if(asset.mapsetid&&mapsList[oGraph.map].bunny&&mapsList[oGraph.map].bunny==asset.geoid){oBunnies[asset.handle]={mapsetid:asset.mapsetid,handle:asset.handle}}else{newGraph.assets[asset.handle]=asset}}}}if(newGraph.plots){for(i=0;i<newGraph.plots.length;i++){findBunnies(newGraph.plots[i])}}if(newGraph.pointsets){for(i=0;i<newGraph.pointsets.length;i++){findBunnies(newGraph.plots[i])}}if(newGraph.mapsets){findBunnies(newGraph.mapsets)}var handle;function replaceBunny(plot,oldHandle,bunny,regex,replacment){var i,asset;for(i=0;i<plot.components.length;i++){if(plot.components[i].handle==oldHandle){plot.components[i].handle=bunny.handle;if(plot.options.name)plot.options.name=plot.options.name.replace(regex,replacement)}}}callApi({command:"ChangeMaps",bunnies:oBunnies,fromgeoid:mapsList[oGraph.map].bunny,togeoid:mapsList[newGraph.map].bunny,modal:"persist"},function(jsoData,textStatus,jqXHR){var regex=new RegExp(jsoData.regex);newGraph.title=newGraph.title.replace(regex,jsoData.replacement);for(handle in jsoData.bunnies){newGraph.assets[jsoData.bunnies[handle].handle]=jsoData.bunnies[handle];if(handle){if(newGraph.plots){for(i=0;i<newGraph.plots.length;i++){replaceBunny(newGraph.plots[i],handle,jsoData.bunnies[handle],jsoData.regex,jsoData.replacement)}}if(newGraph.pointsets){for(i=0;i<newGraph.pointsets.length;i++){replaceBunny(newGraph.plots[i],handle,jsoData.bunnies[handle],jsoData.regex,jsoData.replacement)}}if(newGraph.mapsets){replaceBunny(newGraph.mapsets,handle,jsoData.bunnies[handle],jsoData.regex,jsoData.replacement)}}}var fileAssets=["/global/js/maps/"+newGraph.mapFile+".js"];require(fileAssets);getAssets(newGraph,function(){require(fileAssets,function(){buildGraphPanel(newGraph);$mapSelect.val(oGraph.map)})})})});showChangeSelectors();function showChangeSelectors(){if(oGraph.plots){$thisPanel.find("div.graph-type").show()}else{$thisPanel.find("div.graph-type").hide()}if(oGraph.mapsets||oGraph.pointsets){$thisPanel.find("div.change-map").show()}else{$thisPanel.find("div.change-map").hide()}var options="";if(oGraph.plots)options+='<option value="chart">chart</option>';if(oGraph.mapsets||oGraph.pointsets)options+='<option value="map" selected>map</option>';if(summationMap=isSummationMap(oGraph)){if(typeof oGraph.mapconfig.cubeid=="undefined")oGraph.mapconfig.cubeid="sum"}else{if(oGraph.mapconfig.cubeid=="sum")delete oGraph.mapconfig.cubeid}if(oGraph.mapconfig.cubeid)options+='<option value="cube">supplemental bar chart</option>';$(".download-selector").html(options)}function redraw(){mask("redrawing");setTimeout(function(){destroyChartMap(panelId);if(oGraph.plots){calcGraphMinMaxZoomPeriod(oGraph);chart=chartPanel(panelId);annotations.build();$thisPanel.find("div.mashabledata_chart").show()}else{$thisPanel.find("div.mashabledata_chart").hide();$thisPanel.find("div.annotations").hide()}showChangeSelectors();if(oGraph.mapsets||oGraph.pointsets){drawMap();if(oGraph.plots)$thisPanel.find("map-title").hide();else $thisPanel.find("map-title").show();$thisPanel.find("select.change-map").html(fillChangeMapSelect())}else{$thisPanel.find("div.mashabledata_map").hide()}unmask()},10)}}var summationMap;if(!isEmbedded){$thisPanel.find(".graph-analysis").keydown(function(){panelGraphs[panelId].analysis=this.value;makeDirty()})}oGraph.isDirty=!oGraph.gid;function makeDirty(){oGraph.isDirty=true;$thisPanel.find(".graph-save").button("enable")}function makeClean(){oGraph.isDirty=false;$thisPanel.find(".graph-save").button("disable")}function saveThisGraph(){saveGraph(oGraph,enableComments);$thisPanel.find("button.graph-delete, button.graph-saveas").button("enable");makeClean()}function exportChart(type){switch($thisPanel.find("select.download-selector").val()){case"map":downloadMap(panelId,type);break;case"chart":annotations.sync();chart.exportChart({type:type,width:2e3});break;case"cube":oGraph.controls.vizChart.exportChart({type:type,width:2e3});break}}if(!isEmbedded){$thisPanel.find("button.graph-save").button({icons:{secondary:"ui-icon-disk"}}).button(oGraph.userid==account.info.userid&&oGraph.gid?"disable":"enable").click(saveThisGraph);$thisPanel.find("button.graph-saveas").button({icons:{secondary:"ui-icon-copy"},disabled:!oGraph.gid}).click(function(){delete oGraph.gid;graphTitle.show(this,saveThisGraph)});$thisPanel.find("button.graph-close").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){$("ul#graph-tabs a[href=#"+panelId+"]").siblings("span").click()});$thisPanel.find("button.graph-delete").button({icons:{secondary:"ui-icon-trash"},disabled:!oGraph.gid}).addClass("ui-state-error").click(function(){dialogShow("Permanently Delete Graph","Are you sure you want to delete this graph?",[{text:"Delete",id:"btn-dia-enable",click:function(){deleteMyGraph(panelId);$(this).dialog("close")}},{text:"Cancel",id:"btn-dia-disable",click:function(){$(this).dialog("close")}}])})}console.timeEnd("buildGraphPanel:thisPanel events");calcGraphMinMaxZoomPeriod(oGraph);panelGraphs[panelId]=oGraph;if(!isEmbedded){console.time("buildGraphPanel:provController");var provenance=new ProvenanceController(panelId);oGraph.controls.provenance=provenance;console.timeEnd("buildGraphPanel:provController")}if(oGraph.plots){console.time("buildGraphPanel:build annoatations");chart=chartPanel(panelId);annotations.build();setCropSlider(panelId);console.timeEnd("buildGraphPanel:build annoatations");$thisPanel.find("div.highcharts-container").mousedown(function(b){if(b.which==3){}})}else{$thisPanel.find("div.mashabledata_chart").hide();$thisPanel.find("div.annotations").hide()}var $map=null,vectorMapSettings,val,mergablity;console.time("buildGraphPanel:drawMap");drawMap();console.timeEnd("buildGraphPanel:drawMap");function drawMap(){if(oGraph.map&&(oGraph.mapsets||oGraph.pointsets)){if($map)$map.remove();var mapHeight=(oGraph.controls.$thisPanel.height()-85-(oGraph.plots?0:55))*(oGraph.plots?.6:1);if(parseInt(oGraph.mapconfig.cubeid)||oGraph.mapconfig.cubeid=="sum"){$thisPanel.find(".mashabledata_cube-viz").show().height(mapHeight);$thisPanel.find(".mashabledata_jvmap").css("width","70%")}else{if(oGraph.controls.vizChart){oGraph.controls.vizChart.destroy();delete oGraph.controls.vizChart}$thisPanel.find(".mashabledata_cube-viz").hide();$thisPanel.find(".mashabledata_jvmap").removeAttr("style")}calculatedMapData=calcMap(oGraph);calcAttributes(oGraph);if(isBubble())bubbleCalc();var fillScaling=fillScalingCount(oGraph.pointsets);var areaScaling=areaScalingCount(oGraph.pointsets);var minScale=/us.._merc_en/.test(oGraph.mapFile)?.9:1;vectorMapSettings={map:oGraph.mapFile,zoomMin:minScale,focusOn:{scale:minScale,x:.5,y:.5},backgroundColor:mapBackground,zoomOnScroll:true,markersSelectable:true,markerStyle:{initial:{r:5},selected:{"stroke-width":4,stroke:"yellow"}},regionStyle:{selected:{"stroke-width":2,stroke:"black",fill:"#ffff80"},hover:{"stroke-width":2,stroke:"black","fill-opacity":1}},series:{regions:[{attribute:"fill"}],markers:[{attribute:"r"},{attribute:"fill"},{attribute:"stroke"}]},onRegionLabelShow:function(event,label,code){var i,vals=[],containingDateData=getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[val].s);if(calculatedMapData.regionColors){var containingDateColor=getMapDataByContainingDate(calculatedMapData.regionColors,calculatedMapData.dates[val].s);if(containingDateColor&&typeof containingDateColor[code]!="undefined"){for(i=0;i<calculatedMapData.dates.length;i++){if(calculatedMapData.regionData[calculatedMapData.dates[i].s]&&typeof calculatedMapData.regionData[calculatedMapData.dates[i].s][code]!="undefined")vals.push(calculatedMapData.regionData[calculatedMapData.dates[i].s][code])}var y=containingDateData[code];label.html("<div><b>"+calculatedMapData.title+": "+$map.getRegionName(code)+"</b> "+Highcharts.numberFormat(y,parseInt(y)==y?0:2)+" "+(calculatedMapData.mapUnits||"")+'</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>').css("z-Index",400);var sparkOptions={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true,width:Math.min(400,10*vals.length)+"px"};if(vals.length<10)sparkOptions.type="bar";if(typeof y!="undefined"&&y!==null)sparkOptions.valueSpots[y.toString()+":"+y.toString()]="red";if(vals.length>1)$(".inlinesparkline").sparkline(vals,sparkOptions)}}},regionsSelectable:typeof oGraph.mapsets!="undefined",markers:calculatedMapData.markers,onMarkerLabelShow:function(event,label,code){var i,vals=[],containingDateData=getMapDataByContainingDate(calculatedMapData.markerData,calculatedMapData.dates[val].s);for(i=0;i<calculatedMapData.dates.length;i++){if(typeof calculatedMapData.markerData[calculatedMapData.dates[i].s]!="undefined")vals.push(calculatedMapData.markerData[calculatedMapData.dates[i].s][code].r||calculatedMapData.markerData[calculatedMapData.dates[i].s][code].f)}if(containingDateData&&containingDateData[code]){var html,y=containingDateData[code].r;if(isBubble()){var regionNames=[],regionCodes=code.split("+");for(i=0;i<regionCodes.length;i++){regionNames.push($map.getRegionName(regionCodes[i]))}html="<div><b>"+calculatedMapData.title+": "+regionNames.join(" + ")+"</b> "}else{html="<div><b>"+label.html()+":</b> "}if(containingDateData[code].r)html+=Highcharts.numberFormat(containingDateData[code].r,parseInt(containingDateData[code].r)==containingDateData[code].r?0:2)+" "+(calculatedMapData.radiusUnits||"")+"<br>";if(containingDateData[code].f)html+=Highcharts.numberFormat(containingDateData[code].f,parseInt(containingDateData[code].f)==containingDateData[code].f?0:2)+" "+(calculatedMapData.fillUnits||"")+"<br>";html+='</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>';label.html(html).css("z-Index",400);var sparkOptions={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true};sparkOptions.valueSpots[y.toString()+":"+y.toString()]="red";$(".inlinesparkline").sparkline(vals,sparkOptions)}},onRegionClick:function(){if(!$graphSelected.is(":visible"))$map.clearSelectedRegions()},onRegionSelected:function(e,code,isSelected){cubeVizFromMap(code,isSelected);setMergablity();var selectedMarkers=$map.getSelectedMarkers();if(selectedMarkers.length>0){$thisPanel.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("enable");return}var selectedRegions=$map.getSelectedRegions();console.info("onRegionSelected "+selectedRegions.length);if($graphSelected.is(":visible")){for(var i=0;i<selectedRegions.length;i++){if(calculatedMapData.regionColors){for(var dateKey in calculatedMapData.regionColors){if(typeof calculatedMapData.regionColors[dateKey][selectedRegions[i]]!="undefined"){$thisPanel.find(".mashabledata_map-graph-selected, .make-map").button("enable");return}break}}}$thisPanel.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("disable")}},onMarkerSelected:function(e,code,isSelected){vectorMapSettings.onRegionSelected(e,code,isSelected)},onZoom:function(e,scale){transferTransform()}};val=calculatedMapData.endDateIndex;$thisPanel.find("div.mashabledata_map").show();$thisPanel.find("div.mashabledata_jvmap").show().height(mapHeight).vectorMap(vectorMapSettings);$map=$thisPanel.find("div.mashabledata_jvmap").vectorMap("get","mapObject");oGraph.controls.map=$map;var $mapDateDiv=$('<div class="mashabledata_map-date"></div>').prependTo($thisPanel.find("div.jvectormap-container"));var $g=$thisPanel.find("div.mashabledata_jvmap svg g:first");if(isBubble()){positionBubbles();$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);$thisPanel.find("button.merge").show()}var $mapSlider=$thisPanel.find(".mashabledata_map-slider");if(calculatedMapData.startDateIndex!=calculatedMapData.endDateIndex){$mapSlider.show().off().slider({value:calculatedMapData.endDateIndex,min:calculatedMapData.startDateIndex,max:calculatedMapData.endDateIndex,step:1,change:function(event,ui){val=ui.value;setRegionsMarkersAtribute(val)}}).slider("value",calculatedMapData.endDateIndex)}else{$mapSlider.hide();setRegionsMarkersAtribute(calculatedMapData.startDateIndex)}function setRegionsMarkersAtribute(val){if(!isBubble()&&calculatedMapData.regionColors){$map.series.regions[0].setAttributes(getMapDataByContainingDate(calculatedMapData.regionColors,calculatedMapData.dates[val].s))}if(oGraph.pointsets){if(areaScaling){$map.series.markers[0].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s))}if(fillScaling){$map.series.markers[1].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.fill,calculatedMapData.dates[val].s))}}if(isBubble()){$map.series.markers[0].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));
$map.series.markers[2].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s))}if(oGraph.plots){var timeAxis=chart.xAxis[0];timeAxis.removePlotLine("timeLine");timeAxis.addPlotLine({value:calculatedMapData.dates[val].dt,color:"red",width:2,id:"timeLine"})}cubeVizFromMap()}function cubeVizFromMap(code,isSelected){console.time("cubeVizFromMap");if(parseInt(oGraph.mapconfig.cubeid)||oGraph.mapconfig.cubeid=="sum"){var geoKey,mapDate=calculatedMapData.dates[val].s;if(code){geoKey=code}else{geoKey=null;var selectedRegions=$map.getSelectedRegions();if(selectedRegions.length>0){geoKey=selectedRegions[0]}else{var selectedMarkers=$map.getSelectedMarkers();if(selectedMarkers.length>0){geoKey=selectedMarkers[0]}else{geoKey=oGraph.bunny||mapsList[oGraph.map].bunny}}}if(oGraph.mapconfig.cubeid=="sum"){if(!isNaN(geoKey))geoKey="G"+geoKey;var oFormula=oGraph.mapsets.options.calculatedFormula;var signedNumArray=oFormula.numFormula.replace("-","+-").split("+");var unsignedNumArray=oFormula.numFormula.replace("-","+").split("+");var asset,seriesVal,symbolData={},names=[],i,numNamesAsWords=[],symbol,o={},nameTree={};$.each(oGraph.mapsets.components,function(c){asset=oGraph.assets[this.handle];names.push(asset.name);symbol=compSymbol(c);if(this.handle[0]=="M"){symbolData[symbol]=asset.data[geoKey]?asset.data[geoKey].data:null}else{symbolData[symbol]=asset.data}names.push(asset.name);nameTree[symbol]=asset.name});for(i=unsignedNumArray.length-1;i>=0;i--){if(unsignedNumArray[i].trim()=="")unsignedNumArray.splice(i,0,1);else numNamesAsWords.unshift(nameTree[unsignedNumArray[i].trim()].split(" "))}var peeledWords=[],peelingFront=true,peelingBack=true;while(peelingFront&&peelingBack){for(i=0;i<numNamesAsWords.length;i++){while(numNamesAsWords[i].length>0&&numNamesAsWords[i][0]=="")numNamesAsWords[i].shift();while(numNamesAsWords[i].length>0&&numNamesAsWords[i][numNamesAsWords[i].length-1]=="")numNamesAsWords[i].pop();if(numNamesAsWords[i].length>0){if(numNamesAsWords[i][0]!=numNamesAsWords[0][0])peelingFront=false;if(numNamesAsWords[i].length>1){if(numNamesAsWords[i][numNamesAsWords[i].length-1]!=numNamesAsWords[0][numNamesAsWords[0].length-1])peelingBack=false}}else{peelingFront=peelingBack=false;break}}if(peelingFront)peeledWords.unshift(numNamesAsWords[0][0]);if(peelingBack)peeledWords.push(numNamesAsWords[0][numNamesAsWords[0].length-1]);for(i=0;i<numNamesAsWords.length;i++){if(peelingFront)numNamesAsWords[i].shift();if(peelingBack)numNamesAsWords[i].pop()}}var categories=[];oGraph.assets.cube={dimensions:[{list:[]}]};var cube=oGraph.assets.cube;cube.theme=peeledWords.join(" ");cube.name="";cube.units=plotUnits(oGraph,oGraph.mapsets);cube["G"+geoKey]={facetedData:[]};for(i=0;i<numNamesAsWords.length;i++){cube.dimensions[0].list.push({name:numNamesAsWords[i].join(" ")});cube["G"+geoKey].facetedData[i]=symbolData[unsignedNumArray[i].trim()]}}var action="new";if(summationMap){if(code){action=isSelected?"add":"remove"}else{action="summation"}}vizualizeCube(oGraph,geoKey,mapDate,action);console.time("vizChart.redraw");if(!noCubeRedraw&&action=="remove")oGraph.controls.vizChart.redraw();console.timeEnd("vizChart.redraw")}$mapDateDiv.html(formatDateByPeriod(calculatedMapData.dates[val].dt.getTime(),calculatedMapData.period));console.timeEnd("cubeVizFromMap")}if(oGraph.mapconfig.showList){makeList($map)}var $graphSelected=$thisPanel.find(".mashabledata_map-graph-selected");if(Highcharts&&calculatedMapData.dates>1){$graphSelected.button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var selectedRegions=$map.getSelectedRegions();var selectedMarkers=$map.getSelectedMarkers();var grph=emptyGraph(),plt,formula,i,j,c,X,regionCodes,regionNames,pointset,mapComps,comps,newComp,asset,found;grph.plots=[];grph.title="from map of "+oGraph.title;for(i=0;i<selectedMarkers.length;i++){if(isBubble()){plt=$.extend(true,{},oGraph.mapsets);delete plt.formula;delete plt.options.calculatedFormula;mapComps=plt.components;plt.components=[];regionCodes=selectedMarkers[i].split("+");regionNames=[];for(j=0;j<regionCodes.length;j++){regionNames.push($map.getRegionName(regionCodes[j]));for(c=0;c<mapComps.length;c++){if(mapComps[c].handle[0]=="M"){asset=$.extend({units:oGraph.assets[mapComps[c].handle].units,period:oGraph.assets[mapComps[c].handle].period},oGraph.assets[mapComps[c].handle].data[regionCodes[j]]);newComp=$.extend(true,{},mapComps[c]);newComp.handle=asset.handle;grph.assets[asset.handle]=asset;plt.components.push(newComp)}else{plt.components.push($.extend(true,{},mapComps[c]));grph.assets[mapComps[c].handle]=oGraph.assets[mapComps[c].handle]}}}plt.options.name=plotName(oGraph,oGraph.mapsets)+" for "+regionNames.join("+");grph.plots.push(plt)}else{for(X=0;X<oGraph.pointsets.length;X++){pointset=$.extend(true,{},oGraph.pointsets[X]);found=false;comps=pointset.components;for(c=0;c<comps.length;c++){if(comps[c].handle[0]=="X"&&oGraph.assets[comps[c].handle].data[selectedMarkers[i]]){found=true;sHandle=oGraph.assets[comps[c].handle].data[selectedMarkers[i]].handle;grph.assets[sHandle]=$.extend({units:oGraph.assets[comps[c].handle].units,period:oGraph.assets[comps[c].handle].period},oGraph.assets[comps[c].handle].data[selectedMarkers[i]]);comps[c].handle=sHandle}else{grph.assets[comps[c].handle]=oGraph.assets[comps[c].handle]}}if(found)grph.plots.push(pointset)}}}if(oGraph.mapsets&&oGraph.mapsets){for(i=0;i<selectedRegions.length;i++){for(var dateSet in calculatedMapData.regionData){if(typeof calculatedMapData.regionColors[dateSet][selectedRegions[i]]!="undefined"){plt=$.extend(true,{},oGraph.mapsets);for(j=0;j<plt.components.length;j++){if(plt.components[j].handle.substr(0,1)=="M"){var mapAsset=oGraph.assets[plt.components[j].handle];var regionSeries=$.extend(true,{name:mapAsset.geoname,period:mapAsset.period,units:mapAsset.units,mapsetid:plt.components[j].handle.substr(1)},mapAsset.data[selectedRegions[i]]);plt.components[j].handle=regionSeries.handle;grph.assets[regionSeries.handle]=regionSeries}else{grph.assets[plt.components[j].handle]=$.extend(true,{},oGraph.assets[plt.components[j].handle])}}if(plt.name)plt.name+=" - "+$map.getRegionName(selectedRegions[i]);grph.plots.push(plt)}break}}}if(grph.plots.length>0)quickGraph(grph,true)})}else{$graphSelected.hide()}var $play=$thisPanel.find(".mashabledata_map-play");if(calculatedMapData.startDateIndex!=calculatedMapData.endDateIndex){$play.off().click(function(){var stepStart,stepEnd,timeToKill,optimalStepTime=Math.min(1e4/calculatedMapData.dates.length,500);if($play.attr("title")=="play"){$play.button({text:false,icons:{primary:"ui-icon-pause"}}).attr("title","pause");advanceSlider()}else{$play.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}function advanceSlider(){if($play.attr("title")=="pause"){stepStart=new Date;var newValue=$mapSlider.slider("value")+1;if(newValue>calculatedMapData.endDateIndex)newValue=calculatedMapData.startDateIndex;$mapSlider.slider("value",newValue);stepEnd=new Date;timeToKill=Math.max(1,optimalStepTime-(stepEnd.getTime()-stepStart.getTime()));if(newValue==calculatedMapData.endDateIndex){$play.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}else{if($play.attr("title")=="pause"){window.setTimeout(advanceSlider,timeToKill)}}}}}).button({text:false,icons:{primary:"ui-icon-play"}});$thisPanel.find(".mashabledata_map-step-backward").off().click(function(){$mapSlider.slider("value",$mapSlider.slider("value")-1)}).button({text:false,icons:{primary:"ui-icon-seek-first"}});$thisPanel.find(".mashabledata_map-step-forward").off().click(function(){$mapSlider.slider("value",$mapSlider.slider("value")+1)}).button({text:false,icons:{primary:"ui-icon-seek-end"}})}else{$play.hide();$thisPanel.find(".mashabledata_map-step-backward, .mashabledata_map-step-forward").hide()}if(oGraph.plots)$thisPanel.find("h3.mashabledata_map-title").hide();else $thisPanel.find("h3.mashabledata_map-title").html(oGraph.title).click(function(){graphTitle.show(this)});var noCubeRedraw=false;if(Highcharts&&calculatedMapData.startDateIndex!=calculatedMapData.startDateIndex){$thisPanel.find(".mashabledata_make-map").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"}}).off().click(function(){noCubeRedraw=true;$map.clearSelectedMarkers();$map.clearSelectedRegions();noCubeRedraw=false;if(oGraph.controls.vizChart)oGraph.controls.vizChart.redraw();$thisPanel.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("disable")})}else{$thisPanel.find(".mashabledata_make-map").hide()}function setMergablity(){var i,j,markerRegions;mergablity={newMerge:false,growable:false,splinter:false,ungroupable:false};if(!isBubble())return;var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){if(selectedMarkers[i].split("+").length>1){mergablity.ungroupable=true;break}}if(oGraph.mapsets.options.merges){for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets.options.merges.length;j++){if(oGraph.mapsets.options.merges[j].indexOf(selectedRegions[i])>=0){mergablity.ungroupable=true;break}}}}if(selectedMarkers.length>1){mergablity.growable=true}else{if(selectedMarkers.length==1){markerRegions=selectedMarkers[0].split("+");for(i=0;i<selectedRegions.length;i++){if(markerRegions.indexOf(selectedRegions[i])==-1){mergablity.growable=true;break}}}else{if(selectedRegions.length>1){if(mergablity.ungroupable){mergablity.growable=true}else{mergablity["newMerge"]=true}}}}$thisPanel.find("button.group").button(mergablity.newMerge||mergablity.growable?"enable":"disable");$thisPanel.find("button.ungroup").button(mergablity.ungroupable?"enable":"disable")}if(!isEmbedded){$thisPanel.find("button.group").button({icons:{secondary:"ui-icon-circle-plus"}}).off().click(function(){if(mergablity.newMerge){if(!oGraph.mapsets.options.merges)oGraph.mapsets.options.merges=[];oGraph.mapsets.options.merges.push($map.getSelectedRegions())}if(mergablity.growable){var i,j,newMerge=[];var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){newMerge=newMerge.concat(selectedMarkers[i].split("+"));if(selectedMarkers[i].split("+").length>1){for(j=0;j<oGraph.mapsets.options.merges.length;j++){if(selectedMarkers[i]==oGraph.mapsets.options.merges[j].join("+")){oGraph.mapsets.options.merges.splice(j,1);break}}}}for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets.options.merges.length;j++){if(oGraph.mapsets.options.merges[j].indexOf(selectedRegions[i])>-1){newMerge=newMerge.concat(oGraph.mapsets.options.merges.splice(j,1)[0]);break}}}for(i=0;i<selectedRegions.length;i++){if(newMerge.indexOf(selectedRegions[i])==-1)newMerge.push(selectedRegions[i])}oGraph.mapsets.options.merges.push(newMerge)}$map.removeAllMarkers();$map.clearSelectedRegions();bubbleCalc();positionBubbles();$map.series.markers[0].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s));$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);makeDirty()});$thisPanel.find("button.ungroup").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).off().click(function(){var i,j;var selectedMarkers=$map.getSelectedMarkers();var selectedRegions=$map.getSelectedRegions();for(i=0;i<selectedMarkers.length;i++){if(selectedMarkers[i].split("+").length>1){for(j=0;j<oGraph.mapsets.options.merges.length;j++){if(selectedMarkers[i]==oGraph.mapsets.options.merges[j].join("+")){oGraph.mapsets.options.merges.splice(j,1);break}}}}for(i=0;i<selectedRegions.length;i++){for(j=0;j<oGraph.mapsets.options.merges.length;j++){pos=oGraph.mapsets.options.merges[j].indexOf(selectedRegions[i]);if(pos!=-1){oGraph.mapsets.options.merges[j].splice(pos,1);if(oGraph.mapsets.options.merges[j].length==0){oGraph.mapsets.options.merges.splice(j,1)}break}}}$map.removeAllMarkers();$map.clearSelectedRegions();bubbleCalc();positionBubbles();$map.series.markers[0].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.r,calculatedMapData.dates[val].s));$map.series.markers[2].setAttributes(getMapDataByContainingDate(calculatedMapData.markerAttr.stroke,calculatedMapData.dates[val].s));$map.series.regions[0].setAttributes(calculatedMapData.regionsColorsForBubbles);makeDirty()})}var gLegend;if(oGraph.mapconfig.showLegend)gLegend=makeLegend($map);$thisPanel.find(".mashabledata_legend").change(function(){oGraph.mapconfig.showLegend=$(this).prop("checked");makeDirty();if(oGraph.mapconfig.showLegend){gLegend=makeLegend($map)}else{gLegend.remove()}});$thisPanel.find("input.mashabledata_map-list").change(function(){oGraph.mapconfig.showList=$(this).prop("checked");makeDirty();if(oGraph.mapconfig.showList){makeList($map)}else{$thisPanel.find("div.mashabledata_map-list").remove()}});if(oGraph.mapconfig.showList)makeList($map)}function makeList(map){var list=[],id,units,attr;if($thisPanel.find("div.mashabledata_map-list").length==0){$thisPanel.find("div.jvectormap-container").prepend('<div class="mashabledata_map-list">'+'<div class="order">'+'<input type="radio" id="'+panelId+'-map-list-order-asc" name="'+panelId+'-map-list-order" value="asc" '+(oGraph.mapconfig.listOrder!="desc"?"checked":"")+'><label for="'+panelId+'-map-list-order-asc">ascending</label>'+'<input type="radio" id="'+panelId+'-map-list-order-desc" name="'+panelId+'-map-list-order" value="desc" '+(oGraph.mapconfig.listOrder=="desc"?"checked":"")+'><label for="'+panelId+'-map-list-order-desc">descending</label>'+"</div>"+'<button class="download-map-list">download list to Excel</button>'+"</div>").find("div.mashabledata_map-list .download-map-list").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var table=$thisPanel.find("div.mashabledata_map-list table").get(0);var grid=[];for(var r=0;r<table.rows.length;r++){grid.push([table.rows[r].cells[0].innerHTML.replace("<br>",""),table.rows[r].cells[1].innerHTML,table.rows[r].cells[2].innerHTML])}downloadMadeFile({filename:oGraph.title,data:JSON.stringify([{name:"ranked list",grid:grid}]),url:"excel.php"})}).end().find("div.mashabledata_map-list div.order").buttonset().find("input:radio").click(function(){oGraph.mapconfig.listOrder=$(this).val();makeList($map)})}if(oGraph.mapsets){units=calculatedMapData.mapUnits;var regionData=getMapDataByContainingDate(calculatedMapData.regionData,calculatedMapData.dates[val].s);for(id in regionData){if(regionData[id]!==null){list.push({name:$map.getRegionName(id),value:regionData[id]})}}}else{if(calculatedMapData.fillUnits){units=calculatedMapData.fillUnits;attr="f"}else{units=calculatedMapData.radiusUnits;attr="r"}var markerData=getMapDataByContainingDate(calculatedMapData.markerData,calculatedMapData.dates[val].s);for(id in markerData){if(markerData[id][attr]!==null){list.push({name:calculatedMapData.markers[id].name,value:markerData[id][attr]})}}}list.sort(function(a,b){return(oGraph.mapconfig.listOrder=="desc"?-1:1)*(b.value-a.value)});var html="<table><thead><th>Rank <br>"+$thisPanel.find("div.mashabledata_map-date").html()+"</th><th>"+calculatedMapData.title+"</th><th>"+units+"</th></thead><tbody>";for(var i=0;i<list.length;i++){html+="<tr><td>"+(i+1)+"</td><td>"+list[i].name+"</td><td>"+list[i].value+"</td></tr>"}html+="</tbody></table>";$thisPanel.find("div.mashabledata_map-list").find("table").remove().end().append(html).show()}function makeLegend(map){var standardRadius=10,textCenterFudge=5,lineHeight=20,spacer=10,markerLegendWidth,regionLegendWidth,regionHeight=0,markerHeight=0,y=0,i,yOffset,xOffset,MAX_MARKER_LABEL_LENGTH=20;if(oGraph.mapsets&&!isBubble()){if(oGraph.mapsets.options.scale=="discrete"){regionLegendWidth=185;regionHeight=lineHeight+2*spacer+oGraph.mapsets.options.discreteColors.length*(spacer+20)}else{regionLegendWidth=100;if(oGraph.calculatedMapData.regionMin<0&&oGraph.calculatedMapData.regionMax>0){regionHeight=6*spacer+2*80+4*lineHeight}else{regionHeight=4*spacer+80+3*lineHeight}}}else regionLegendWidth=0;var areaCount=areaScalingCount(oGraph.pointsets),fillCount=fillScalingCount(oGraph.pointsets);if(oGraph.pointsets||isBubble()){markerLegendWidth=185;if(areaCount>1&&fillCount==0){markerHeight+=areaCount*(spacer+2*standardRadius)+(markerHeight==0?spacer:0)}if(areaCount>0||isBubble()){var maxRadius=parseInt(oGraph.mapconfig.maxRadius)||DEFAULT_RADIUS_SCALE;var smallRadius=+maxRadius/Math.sqrt(10);markerHeight+=2*(spacer+Math.max(maxRadius,15)+smallRadius)+(markerHeight==0?spacer:0)}}else markerLegendWidth=0;var gLegend=map.canvas.addGroup();map.canvas.addCircle({cx:0,cy:0},{initial:{r:20,"fill-opacity":0,"stroke-width":0}},gLegend);$thisPanel.append('<div id="dummyLegend" class="hidden"></div>');var hcr=new Highcharts.Renderer($("#dummyLegend")[0],map.width,map.height);hcr.box=gLegend.node;$("#dummyLegend").remove();var legendLocation=oGraph.mapconfig.legendLocation||mapsList[oGraph.map].legend||"TR";switch(legendLocation.substr(0,1)){case"T":yOffset=spacer;break;case"C":yOffset=(map.height-Math.max(markerHeight,regionHeight))/2-spacer;break;case"B":yOffset=map.height-Math.max(markerHeight,regionHeight)-spacer}switch(legendLocation.substr(1,1)){case"L":xOffset=spacer;if(legendLocation.substr(0,1)=="T")xOffset+=30;break;case"C":xOffset=(map.width-regionLegendWidth-markerLegendWidth)/2-spacer;break;case"R":xOffset=map.width-regionLegendWidth-markerLegendWidth-spacer}hcr.rect(xOffset,yOffset,markerLegendWidth+regionLegendWidth,Math.max(markerHeight,regionHeight),5).attr({fill:"white",opacity:.5,"stroke-width":0}).add();var gradientAttributes={opacity:1,"stroke-width":0,"z-index":1e3};function gradient(x,y,topColor,bottomColor){var rTop,gTop,bTop,rBot,gBot,bBot,r,g,b;rTop=parseInt(topColor.substr(1,2),16);gTop=parseInt(topColor.substr(3,2),16);bTop=parseInt(topColor.substr(5,2),16);rBot=parseInt(bottomColor.substr(1,2),16);gBot=parseInt(bottomColor.substr(3,2),16);bBot=parseInt(bottomColor.substr(5,2),16);for(var i=0;i<40;i++){r=Math.round(rTop-(rTop-rBot)*i/39).toString(16);g=Math.round(gTop-(gTop-gBot)*i/39).toString(16);b=Math.round(bTop-(bTop-bBot)*i/39).toString(16);hcr.rect(x,y+2*i,20,2,0).attr({fill:"#"+(r.length==1?"0":"")+r+(g.length==1?"0":"")+g+(b.length==1?"0":"")+b,opacity:1,"stroke-width":0,"z-index":1e3}).add()}}if(oGraph.pointsets||isBubble()){if(areaCount>1&&fillCount==0){$.each(oGraph.pointsets,function(i){if(this.options.attribute!="fill"){y=(i+1)*(spacer+2*standardRadius)-standardRadius;hcr.circle(xOffset+spacer+standardRadius,yOffset+y,Math.min(maxRadius,standardRadius)).attr({fill:this.options.color,opacity:1,"fill-opacity":1,stroke:"black","stroke-width":1}).add();hcr.text(plotName(oGraph,oGraph.pointsets[i]).substring(0,MAX_MARKER_LABEL_LENGTH),xOffset+2*(spacer+standardRadius),yOffset+y).add()}y+=standardRadius})}if(areaCount>0||isBubble()){y+=spacer+(smallRadius||5);var MarkerSizeAttributes={"fill-opacity":0,opacity:1,stroke:"black","stroke-width":1};hcr.circle(xOffset+spacer+maxRadius,yOffset+y,smallRadius).attr(MarkerSizeAttributes).add();hcr.text(formatRationalize((oGraph.calculatedMapData.radiusScale||oGraph.calculatedMapData.markerDataMax)/10),xOffset+2*(maxRadius+spacer),yOffset+y).css({fontSize:"12px"}).add();y+=(smallRadius||5)+spacer+maxRadius;hcr.circle(xOffset+spacer+maxRadius,yOffset+y,maxRadius).attr(MarkerSizeAttributes).add();hcr.text(formatRationalize(oGraph.calculatedMapData.radiusScale||oGraph.calculatedMapData.markerDataMax),xOffset+2*(maxRadius+spacer),yOffset+y).css({fontSize:"12px"}).add();hcr.text(oGraph.calculatedMapData.radiusUnits,xOffset+2*(maxRadius+spacer),yOffset+y+2*spacer).css({fontSize:"12px"}).add()}}if(oGraph.mapsets&&!isBubble()){hcr.text(plotUnits(oGraph,oGraph.mapsets).substr(0,25),xOffset+spacer,yOffset+lineHeight+textCenterFudge).css({fontSize:"12px"}).add();if(oGraph.mapsets.options.scale!="discrete"&&oGraph.mapsets.options.logMode=="on")hcr.text("logarymic scale",xOffset+spacer,yOffset+2*lineHeight).css({fontSize:"12px"}).add();if(oGraph.mapsets.options.scale=="discrete"){for(i=0;i<oGraph.mapsets.options.discreteColors.length;i++){y=spacer+(oGraph.mapsets.options.discreteColors.length-i)*(spacer+20);hcr.rect(xOffset+markerLegendWidth+spacer,yOffset+y,lineHeight,lineHeight,0).attr({fill:oGraph.mapsets.options.discreteColors[i].color,opacity:1,stroke:"black","stroke-width":1}).add();hcr.text((i==oGraph.mapsets.options.discreteColors.length-1?"&gt; ":" ")+oGraph.mapsets.options.discreteColors[i].cutoff,xOffset+markerLegendWidth+spacer+lineHeight+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add()}}else{y+=2*lineHeight;hcr.text(formatRationalize(oGraph.calculatedMapData.regionMax),xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer;if(oGraph.calculatedMapData.regionMax>0){gradient(xOffset+markerLegendWidth+spacer,yOffset+y,oGraph.mapsets.options.posColor||MAP_COLORS.POS,MAP_COLORS.MID);y+=80+spacer;if(oGraph.calculatedMapData.regionMin<0){hcr.text("0",xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer}}if(oGraph.calculatedMapData.regionMin<0){gradient(xOffset+markerLegendWidth+spacer,yOffset+y,MAP_COLORS.MID,oGraph.mapsets.options.negColor||MAP_COLORS.NEG);y+=80+spacer}hcr.text(formatRationalize(oGraph.calculatedMapData.regionMin),xOffset+markerLegendWidth+spacer,yOffset+y+lineHeight/2+textCenterFudge).css({fontSize:"12px"}).add();y+=lineHeight+spacer}}return gLegend}function bubbleCalc(){var dateKey,markerId,markerTitle,regionColors=primeColors.concat(hcColors);calculatedMapData.regionsColorsForBubbles={};calculatedMapData.markers={};var pnt={x:100,y:100};if(isBubble()){var region,mergedSum,i=0,d,j,allMergedRegions=[];var merge,mergeCode,markerData={},markerAttr={r:{},stroke:{}};for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){dateKey=calculatedMapData.dates[d].s;markerData[dateKey]={};markerAttr.r[dateKey]={};markerAttr.stroke[dateKey]={}}calculatedMapData.markerDataMin=Number.MAX_VALUE;calculatedMapData.markerDataMax=Number.MIN_VALUE;if(oGraph.mapsets.options.merges){for(i=0;i<oGraph.mapsets.options.merges.length;i++){merge=oGraph.mapsets.options.merges[i];mergeCode=merge.join("+");markerTitle=calculatedMapData.title+" for "+mergeCode;calculatedMapData.markers[mergeCode]={name:mergeCode,point:pnt,style:{fill:"pink"}};for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){mergedSum=0;for(j=0;j<merge.length;j++){mergedSum+=calculatedMapData.regionData[calculatedMapData.dates[d].s][merge[j]]||0}markerData[calculatedMapData.dates[d].s][mergeCode]={r:mergedSum};if(mergedSum!==null){calculatedMapData.markerDataMin=Math.min(calculatedMapData.markerDataMin,mergedSum);calculatedMapData.markerDataMax=Math.max(calculatedMapData.markerDataMax,mergedSum)}}for(j=0;j<merge.length;j++){calculatedMapData.regionsColorsForBubbles[merge[j]]=regionColors[i%regionColors.length]}allMergedRegions=allMergedRegions.concat(merge)}}for(region in calculatedMapData.regionData[calculatedMapData.dates[0].s]){if(allMergedRegions.indexOf(region)==-1&&typeof calculatedMapData.regionData[calculatedMapData.dates[0].s][region]!="undefined"){calculatedMapData.markers[region]={name:region,point:pnt,style:{fill:"pink"}};calculatedMapData.regionsColorsForBubbles[region]=regionColors[i++%regionColors.length];for(d=calculatedMapData.startDateIndex;d<=calculatedMapData.endDateIndex;d++){dateKey=calculatedMapData.dates[d].s;markerData[dateKey][region]={r:calculatedMapData.regionData[dateKey][region]};if(markerData[dateKey][region].r!==null&&!isNaN(markerData[dateKey][region].r)){calculatedMapData.markerDataMin=Math.min(calculatedMapData.markerDataMin,markerData[dateKey][region].r);calculatedMapData.markerDataMax=Math.max(calculatedMapData.markerDataMax,markerData[dateKey][region].r)}}}}var rScale=(oGraph.mapconfig.maxRadius||DEFAULT_RADIUS_SCALE)/Math.sqrt(Math.max(Math.abs(calculatedMapData.markerDataMax),Math.abs(calculatedMapData.markerDataMin)));for(dateKey in markerData){for(markerId in markerData[dateKey]){rData=markerData[dateKey][markerId].r||null;markerAttr.r[dateKey][markerId]=rScale*Math.sqrt(Math.abs(rData));markerAttr.stroke[dateKey][markerId]=rData<0?"#ff0000":"#000000"}}calculatedMapData.markerData=markerData;calculatedMapData.markerAttr=markerAttr;calculatedMapData.radiusUnits=calculatedMapData.mapUnits}}function geometricCenter(regions){var bBox,totalArea=0,xArm=0,yArm=0,center,regCenter,latLon;for(var i=0;i<regions.length;i++){latLon=null;$.each(oGraph.mapsets.components,function(c,comp){if(oGraph.assets[comp.handle].data[regions[i]]&&comp.handle[0]=="M"&&oGraph.assets[comp.handle].data[regions[i]].latLon){latLon=oGraph.assets[comp.handle].data[regions[i]].latLon.split(",")}});bBox=$g.find("path[data-code="+regions[i]+"]").get(0).getBBox();if(latLon){regCenter=$map.latLngToPoint(latLon[0],latLon[1]);xArm+=(regCenter.x-$map.transX)*bBox.width*bBox.height/$map.scale;yArm+=(regCenter.y-$map.transY)*bBox.width*bBox.height/$map.scale}else{xArm+=(bBox.x+bBox.width/2)*bBox.width*bBox.height;yArm+=(bBox.y+bBox.height/2)*bBox.width*bBox.height}totalArea+=bBox.width*bBox.height}center={x:(xArm/totalArea+$map.transX)*$map.scale,y:(yArm/totalArea+$map.transY)*$map.scale};return center}function positionBubbles(){var center,latLng;if(isBubble()){var region,i=0,j,allMergedRegions=[];if(oGraph.mapsets.options.merges){for(i=0;i<oGraph.mapsets.options.merges.length;i++){center=geometricCenter(oGraph.mapsets.options.merges[i]);latLng=$map.pointToLatLng(center.x,center.y);calculatedMapData.markers[oGraph.mapsets.options.merges[i].join("+")].latLng=[latLng.lat,latLng.lng];allMergedRegions=allMergedRegions.concat(oGraph.mapsets.options.merges[i])}}$g.find("path[data-code]").each(function(){region=$(this).attr("data-code");if(allMergedRegions.indexOf(region)==-1&&typeof calculatedMapData.regionData[calculatedMapData.dates[0].s][region]!="undefined"){center=geometricCenter([region]);latLng=$map.pointToLatLng(center.x,center.y);calculatedMapData.markers[region].latLng=[latLng.lat,latLng.lng]}});$map.addMarkers(calculatedMapData.markers)}}}function isBubble(){return oGraph.mapsets&&oGraph.mapsets.options.mode&&oGraph.mapsets.options.mode=="bubble"}console.timeEnd("buildGraphPanel: "+panelId);if(!isEmbedded){unmask();setPanelHash(oGraph.ghash,$thisPanel.get(0).id)}function calcMap(graph){var mapTitle,mapPeriod,mapUnits,mapDates={},aMapDates=[],markers={},dateKey;var markerData={};var regionData={};var mapRegionNames={},c,i,j,point,points,mddt,handle,dateHasData,valuesObject,pointHasData,y;var dataMin,dataMax;var oMapDates={};var expression,compSymbols,geo,geos,components,data,symbol,oComponentData;if(graph.mapsets){var mapset=graph.mapsets;mapset.formula=plotFormula(mapset);expression="return "+mapset.formula.formula.replace(patVariable,"values.$1")+";";var mapCompute=new Function("values",expression);compSymbols=[];geos={};components=mapset.components;oComponentData={};var sortedGeoList=[];for(i=0;i<components.length;i++){symbol=compSymbol(i);compSymbols.push(symbol);if(components[i].handle[0]=="M"){for(geo in graph.assets[components[i].handle].data){if(!geos[geo]){geos[geo]=true;sortedGeoList.push({geo:geo,name:graph.assets[components[i].handle].geoname})}data=graph.assets[components[i].handle].data[geo].data.split("||");for(j=0;j<data.length;j++){point=data[j].split("|");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}if(!oComponentData[point[0].toString()][symbol]){oComponentData[point[0].toString()][symbol]={}}oComponentData[point[0].toString()][symbol][geo]=point[1]===null||point[1]=="null"?null:parseFloat(point[1])}}}else{data=graph.assets[components[i].handle].data.split("||");for(j=0;j<data.length;j++){point=data[j].split("|");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]===null||point[1]=="null"?null:parseFloat(point[1])}}}var required=!mapset.options.componentData||mapset.options.componentData=="required";var missingAsZero=mapset.options.componentData=="missingAsZero";var nullsMissingAsZero=mapset.options.componentData=="nullsMissingAsZero";var breakNever=!mapset.options.breaks||mapset.options.breaks=="never";var breakNulls=mapset.options.breaks=="nulls";var breakMissing=mapset.options.breaks=="missing";mapTitle=plotName(graph,mapset);mapPeriod=graph.assets[components[0].handle].period;mapUnits=plotUnits(graph,mapset);for(dateKey in oComponentData){dataMin=Number.MAX_VALUE;dataMax=Number.MIN_VALUE;dateHasData=false;for(geo in geos){valuesObject={};y=true;pointHasData=false;for(i=0;i<compSymbols.length;i++){if(!isNaN(oComponentData[dateKey][compSymbols[i]])){valuesObject[compSymbols[i]]=parseFloat(oComponentData[dateKey][compSymbols[i]])}else{if(oComponentData[dateKey][compSymbols[i]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{if(oComponentData[dateKey][compSymbols[i]]&&!isNaN(oComponentData[dateKey][compSymbols[i]][geo])){if(oComponentData[dateKey][compSymbols[i]][geo]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[i]]=0}else{y=null;break}}else{valuesObject[compSymbols[i]]=oComponentData[dateKey][compSymbols[i]][geo];pointHasData=true}}else{if(required){y=null;break}else{valuesObject[compSymbols[i]]=0}}}}}if(pointHasData){if(y){try{y=mapCompute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null){y=rationalize(y);if(!regionData[dateKey])regionData[dateKey]={};regionData[dateKey][geo]=y;dateHasData=true;dataMin=Math.min(dataMin||y,y);dataMax=Math.max(dataMax||y,y)}}}if(dateHasData){mapDates[dateKey]={regionMin:dataMin,regionMax:dataMax}}else{delete regionData[dateKey]}}var regionColumns=[{id:"date",width:100,field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];var regionRows=[];var hasCalc=mapset.formula.formula!="A";sortedGeoList.sort(function(a,b){return a.name>b.name});var id,asset,row,firstDateKey=true,jsDateTime,mapsetName=plotName(graph,mapset),mapsetUnits=plotUnits(graph,mapset,false,mapset.formula);for(dateKey in regionData){jsDateTime=dateFromMdDate(dateKey).getTime();row={order:jsDateTime,date:formatDateByPeriod(jsDateTime,graph.assets[components[0].handle].period)};for(i=0;i<sortedGeoList.length;i++){for(j=0;j<compSymbols.length;j++){geo=sortedGeoList[i].geo;id=compSymbols[j]+"_"+i;asset=graph.assets[components[j].handle];if(firstDateKey)regionColumns.push({id:id,field:id,name:"<b>"+(asset.maps&&asset.data[geo]?asset.data[geo].name:asset.name)+"</b><br>"+(asset.maps&&asset.data[geo]?asset.data[geo].geoname:asset.geoname||"")+"<br>"+asset.units+"<br>"+asset.src+"<br>"+(asset.maps&&asset.data[geo]?asset.data[geo].notes:asset.notes||"not available")+(hasCalc?"<br>component "+compSymbols[j]:""),cssClass:"grid-series-column"});if(components[j].handle[0]=="M"){row[id]=oComponentData[dateKey][compSymbols[j]][geo]}else{row[id]=oComponentData[dateKey][compSymbols[j]]}if(typeof row[id]=="undefined")row[id]="-"}if(hasCalc){if(firstDateKey)regionColumns.push({id:geo,field:geo,name:"<b>"+mapsetName+": "+sortedGeoList[i].name+"</b><br>"+mapsetUnits+"<br><br>"+(hasCalc?"<br>value = "+mapset.formula.formula:""),cssClass:"grid-calculated-column"});row[geo]=typeof regionData[dateKey][geo]=="undefined"?"-":regionData[dateKey][geo]}}regionRows.push(row);firstDateKey=false}regionRows.sort(function(a,b){return b.order-a.order})}var fillUnits,radiusUnits;if(graph.pointsets){var latlon,latlons={},Xdata;var index=0,pointset,cmp,k;var markerColumns=[{id:"date",field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];var markerRows=[];for(i=0;i<graph.pointsets.length;i++){var sortedLatlonList=[];pointset=graph.pointsets[i];if(!pointset.options.color)pointset.options.color=nextColor(graph.pointsets);
pointset.formula=plotFormula(pointset);expression="return "+pointset.formula.formula.replace(patVariable,"values.$1")+";";var pointsetCompute=new Function("values",expression);compSymbols=[];components=pointset.components;oComponentData={};for(j=0;j<components.length;j++){symbol=compSymbol(j);compSymbols.push(symbol);if(components[j].handle[0]=="X"){Xdata=graph.assets[components[j].handle].data;for(latlon in Xdata){if(!latlons[latlon]){latlons[latlon]=true;sortedLatlonList.push({latlon:latlon,name:Xdata[latlon].name})}if(markers[latlon]){markers[latlon].name+="<br>"+Xdata[latlon].name}else{markers[latlon]={latLng:latlon.split(","),name:Xdata[latlon].name,style:{fill:pointset.options.color}};markers[latlon].latLng[0]=parseFloat(markers[latlon].latLng[0]);markers[latlon].latLng[1]=parseFloat(markers[latlon].latLng[1])}data=Xdata[latlon].data.split("||");for(k=0;k<data.length;k++){point=data[k].split("|");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}if(!oComponentData[point[0].toString()][symbol]){oComponentData[point[0].toString()][symbol]={}}oComponentData[point[0].toString()][symbol][latlon]=point[1]}}}else{data=graph.assets[components[j].handle].data.split("||");for(k=0;k<data.length;k++){point=data[k].split("|");if(!oComponentData[point[0].toString()]){oComponentData[point[0].toString()]={}}oComponentData[point[0].toString()][symbol]=point[1]}}}var required=!pointset.options.componentData||pointset.options.componentData=="required";var missingAsZero=pointset.options.componentData=="missingAsZero";var nullsMissingAsZero=pointset.options.componentData=="nullsMissingAsZero";var breakNever=!pointset.options.breaks||pointset.options.breaks=="never";var breakNulls=pointset.options.breaks=="nulls";var breakMissing=pointset.options.breaks=="missing";mapTitle=mapTitle+plotName(graph,pointset);mapPeriod=graph.assets[components[0].handle].period;if(pointset.options.attribute=="fill"){fillUnits=plotUnits(graph,pointset)}else{radiusUnits=plotUnits(graph,pointset)}for(dateKey in oComponentData){dataMin=Number.MAX_VALUE;dataMax=Number.MIN_VALUE;dateHasData=false;for(latlon in latlons){valuesObject={};y=true;pointHasData=false;for(j=0;j<compSymbols.length;j++){if(!isNaN(oComponentData[dateKey][compSymbols[j]])){valuesObject[compSymbols[j]]=parseFloat(oComponentData[dateKey][compSymbols[j]])}else{if(oComponentData[dateKey][compSymbols[j]]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[j]]=0}else{y=null;break}}else{if(oComponentData[dateKey][compSymbols[j]]&&!isNaN(oComponentData[dateKey][compSymbols[j]][latlon])){if(oComponentData[dateKey][compSymbols[j]][latlon]=="null"){if(nullsMissingAsZero){valuesObject[compSymbols[j]]=0}else{y=null;break}}else{valuesObject[compSymbols[j]]=oComponentData[dateKey][compSymbols[j]][latlon];pointHasData=true}}else{if(required){y=null;break}else{valuesObject[compSymbols[j]]=0}}}}}if(pointHasData){if(y){try{y=pointsetCompute(valuesObject);if(Math.abs(y)==Infinity||isNaN(y))y=null}catch(err){y=null}}if(y!==null){y=rationalize(y);dateHasData=true;if(!markerData[dateKey])markerData[dateKey]={};if(!markerData[dateKey][latlon])markerData[dateKey][latlon]={};if(pointset.options.attribute=="fill"){markerData[dateKey][latlon].f=y;dataMin=Math.min(dataMin,y);dataMax=Math.max(dataMax,y)}else{markerData[dateKey][latlon].r=y;dataMin=Math.min(dataMin,y);dataMax=Math.max(dataMax,y)}}}}if(dateHasData){if(!mapDates[dateKey])mapDates[dateKey]={};if(pointset.options.attribute=="fill"){mapDates[dateKey].markerFillMin=Math.min(mapDates[dateKey].markerFillMin||dataMin,dataMin);mapDates[dateKey].markerFillMax=Math.max(mapDates[dateKey].markerFillMax||dataMax,dataMax)}else{mapDates[dateKey].markerRadiusMin=Math.min(mapDates[dateKey].markerRadiusMin||dataMin,dataMin);mapDates[dateKey].markerRadiusMax=Math.max(mapDates[dateKey].markerRadiusMax||dataMax,dataMax)}}else{delete markerData[dateKey]}}sortedLatlonList.sort(function(a,b){return a.name>b.name});var pointsetHasCalc=pointset.formula.formula!="A";var id,asset,row,firstDateKey=true,jsDateTime,pointsetName=plotName(graph,pointset),pointsetUnits=plotUnits(graph,pointset,false,pointset.formula);for(dateKey in markerData){jsDateTime=dateFromMdDate(dateKey).getTime();row={id:jsDateTime,date:formatDateByPeriod(jsDateTime,graph.assets[components[0].handle].period)};for(var ll=0;ll<sortedLatlonList.length;ll++){for(j=0;j<compSymbols.length;j++){latlon=sortedLatlonList[ll].latlon;id=compSymbols[j]+"_"+ll;asset=graph.assets[components[j].handle];if(firstDateKey)markerColumns.push({id:id,field:id,name:"<b>"+(asset.coordinates&&asset.data[latlon]?asset.data[latlon].name:asset.name)+"</b>"+"<br>"+(asset.coordinates&&asset.data[latlon]?latlon:asset.geoname||"")+"<br>"+asset.units+"<br>"+asset.src+"<br>"+(asset.maps&&asset.data[latlon]?asset.data[latlon].notes:asset.notes||"")+(hasCalc?"<br>component "+compSymbols[j]:""),cssClass:"grid-series-column"});if(components[j].handle[0]=="X"){row[id]=oComponentData[dateKey][compSymbols[j]][latlon]}else{row[id]=oComponentData[dateKey][compSymbols[j]]}if(typeof row[id]=="undefined")row[id]="-"}if(pointsetHasCalc){if(firstDateKey)markerColumns.push({id:latlon+"-"+i,field:latlon+"-"+i,name:"<b>"+pointsetName+": "+sortedLatlonList[ll].name+"</b><br>"+pointsetUnits+"<br><br>"+(hasCalc?"<br>value = "+pointset.formula.formula:""),cssClass:"grid-calculated-column"});row[latlon+"-"+i]=typeof markerData[dateKey][latlon]=="undefined"?"-":markerData[dateKey][latlon]}}for(var found=false,r=0;r<markerRows.length;r++){if(markerRows[r].id==row.id){$.extend(markerRows[r],row);found=true;break}}if(!found)markerRows.push(row);firstDateKey=false}markerRows.sort(function(a,b){return b.id-a.id})}for(mddt in markerData){for(latlon in latlons){if(typeof markerData[mddt][latlon]=="undefined")markerData[mddt][latlon]={f:null,r:null}}}}for(dateKey in mapDates){aMapDates.push({s:dateKey,dt:dateFromMdDate(dateKey),regionMin:mapDates[dateKey].regionMin,regionMax:mapDates[dateKey].regionMax,markerRadiusMin:mapDates[dateKey].markerRadiusMin,markerRadiusMax:mapDates[dateKey].markerRadiusMax,markerFillMin:mapDates[dateKey].markerFillMin,markerFillMax:mapDates[dateKey].markerFillMax})}aMapDates.sort(function(a,b){return a.dt-b.dt});graph.calculatedMapData={title:mapTitle,period:mapPeriod,mapUnits:mapUnits,markers:markers,markerData:markerData,dates:aMapDates,regionData:regionData,regionGrid:{columns:regionColumns,data:regionRows},markerGrid:{columns:markerColumns,data:markerRows},fillUnits:fillUnits,radiusUnits:radiusUnits};return graph.calculatedMapData}function calcAttributes(graph){var i,y,firstDateKey,dateKey,geo,geos={},min,max,calcData=graph.calculatedMapData;calcData.regionMin=Number.MAX_VALUE;calcData.regionMax=Number.MIN_VALUE;calcData.startDateIndex=calcData.dates.length-1;calcData.endDateIndex=0;for(i=0;i<calcData.dates.length;i++){if((!graph.start||parseInt(graph.start)<=calcData.dates[i].dt.getTime())&&(!graph.end||parseInt(graph.end)>=calcData.dates[i].dt.getTime())){if(calcData.startDateIndex>i)calcData.startDateIndex=i;if(calcData.endDateIndex<i)calcData.endDateIndex=i;if(graph.mapsets){calcData.regionMin=Math.min(calcData.dates[i].regionMin,calcData.regionMin);calcData.regionMax=Math.max(calcData.regionMax,calcData.dates[i].regionMax)}}}var rgb,continuous,spans,mapOptions;if(graph.mapsets){var regionFillColors={};mapOptions=graph.mapsets.options;continuous=!mapOptions.scale||mapOptions.scale=="continuous";min=calcData.regionMin;max=calcData.regionMax;spans=min<0&&max>0;calcData.regionColors={};if(continuous){rgb={pos:makeRGB(mapOptions.posColor||MAP_COLORS.POS),neg:makeRGB(mapOptions.negColor||MAP_COLORS.NEG),mid:makeRGB(MAP_COLORS.MID)};var posRGB=new RGBColour(rgb.pos.r,rgb.pos.b,rgb.pos.g);var posHSV=posRGB.getHSV();var posMid=new HSVColour(posHSV.h,spans?10:20,spans?90:100);var posMidRGB=posMid.getIntegerRGB();rgb.posMid={r:posMidRGB.r,g:posMidRGB.g,b:posMidRGB.b};var negRGB=new RGBColour(rgb.neg.r,rgb.neg.b,rgb.neg.g);var negHSV=negRGB.getHSV();var negMid=new HSVColour(negHSV.h,spans?10:20,spans?90:100);var negMidRGB=negMid.getIntegerRGB();rgb.negMid={r:negMidRGB.r,g:negMidRGB.g,b:negMidRGB.b}}for(i=calcData.startDateIndex;i<=calcData.endDateIndex;i++){dateKey=calcData.dates[i].s;calcData.regionColors[dateKey]={};if(calcData.regionData[dateKey]){for(geo in calcData.regionData[dateKey]){geos[geo]=true;y=calcData.regionData[dateKey][geo];if(!isNaN(y)&&y!==null){y=parseFloat(y);if(continuous){if(y==0){calcData.regionColors[dateKey][geo]=MAP_COLORS.MID}else{calcData.regionColors[dateKey][geo]=colorInRange(y,y<0?min:spans?0:min,y>0?max:spans?0:max,y<0?rgb.neg:rgb.posMid,y<0?rgb.negMid:rgb.pos,mapOptions.logMode=="on"&&!spans&&min!=0&&max!=0)}}else{for(j=0;j<mapOptions.discreteColors.length;j++){if(j!=mapOptions.discreteColors.length-1&&y<=parseFloat(mapOptions.discreteColors[j].cutoff)||j==mapOptions.discreteColors.length-1){calcData.regionColors[dateKey][geo]=mapOptions.discreteColors[j].color;break}}}}else{calcData.regionColors[dateKey][geo]="#ffffff"}}}else{for(firstDateKey in calcData.regionData){for(geo in calcData.regionData[firstDateKey]){calcData.regionColors[dateKey][geo]="#ffffff"}break}}}for(dateKey in calcData.regionColors){for(geo in geos){if(typeof calcData.regionColors[dateKey][geo]=="undefined"){calcData.regionColors[dateKey][geo]="#ffffff"}}}}if(graph.pointsets){mapOptions=graph.mapconfig;continuous=!mapOptions.scale||mapOptions.scale=="continuous";if(continuous){}var markerFillMin=Number.MAX_VALUE,markerFillMax=Number.MIN_VALUE;var markerRadiusMin=Number.MAX_VALUE,markerRadiusMax=Number.MIN_VALUE;for(i=calcData.startDateIndex;i<=calcData.endDateIndex;i++){if(calcData.dates[i].markerRadiusMin){markerRadiusMin=Math.min(calcData.dates[i].markerRadiusMin,markerRadiusMin);markerRadiusMax=Math.max(calcData.dates[i].markerRadiusMax,markerRadiusMax)}if(calcData.dates[i].markerFillMin){markerFillMin=Math.min(calcData.dates[i].markerFillMin,markerFillMin);markerFillMax=Math.max(calcData.dates[i].markerFillMax,markerFillMax)}}var markerRadiusAbs;var hasRadiusScaling=markerRadiusMin!=Number.MAX_VALUE;if(hasRadiusScaling){markerRadiusAbs=Math.max(Math.abs(markerRadiusMin),Math.abs(markerRadiusMax));calcData.radiusScale=markerRadiusAbs}var hasFillShading=markerFillMin!=Number.MAX_VALUE;if(hasFillShading){calcData.markerFillMinValue=markerFillMin;calcData.markerFillMaxValue=markerFillMax;continuous=hasFillShading&&(!graph.mapconfig.scale||mapOptions.scale=="continuous");spans=markerFillMin<0&&markerFillMax>0;if(continuous){rgb={pos:makeRGB(mapOptions.posColor||MAP_COLORS.POS),neg:makeRGB(mapOptions.negColor||MAP_COLORS.NEG),posMid:{},negMid:{},mid:makeRGB(MAP_COLORS.MID)};var posRGB=new RGBColour(rgb.pos.r,rgb.pos.b,rgb.pos.g);var posHSV=posRGB.getHSV();var posMid=new HSVColour(posHSV.h,spans?10:20,spans?90:100);var posMidRGB=posMid.getIntegerRGB();rgb.posMid={r:posMidRGB.r,g:posMidRGB.g,b:posMidRGB.b};var negRGB=new RGBColour(rgb.neg.r,rgb.neg.b,rgb.neg.g);var negHSV=negRGB.getHSV();var negMid=new HSVColour(negHSV.h,spans?10:20,spans?90:100);var negMidRGB=negMid.getIntegerRGB();rgb.negMid={r:negMidRGB.r,g:negMidRGB.g,b:negMidRGB.b}}}var markerId,fillData,rData,markerAttr={r:{},fill:{},stroke:{}};for(dateKey in calcData.markerData){markerAttr.r[dateKey]={};markerAttr.fill[dateKey]={};markerAttr.stroke[dateKey]={};for(markerId in calcData.markers){if(hasRadiusScaling){rData=calcData.markerData[dateKey][markerId].r||null;if(rData<0){markerAttr.stroke[dateKey][markerId]="#ff0000";rData=Math.abs(rData)}else{markerAttr.stroke[dateKey][markerId]="#000000"}markerAttr.r[dateKey][markerId]=(graph.mapconfig.maxRadius||DEFAULT_RADIUS_SCALE)*Math.sqrt(rData)/Math.sqrt(markerRadiusAbs)}if(hasFillShading){fillData=calcData.markerData[dateKey][markerId].f||null;if(isNaN(fillData)||fillData===null){markerAttr.fill[dateKey][markerId]="#ffffff"}else{if(continuous){if(spans){markerAttr.fill[dateKey][markerId]=colorInRange(fillData,fillData<0?markerFillMin:spans?0:markerFillMin,fillData>0?markerFillMax:spans?0:markerFillMax,fillData<0?rgb.neg:rgb.posMid,fillData<0?rgb.negMid:rgb.pos)}else{markerAttr.fill[dateKey][markerId]=colorInRange(fillData,fillData<0?markerFillMin:spans?0:markerFillMin,fillData>0?markerFillMax:spans?0:markerFillMax,fillData<0?rgb.neg:rgb.mid,fillData<0?rgb.mid:rgb.pos)}}else{for(j=0;j<graph.mapconfig.discreteColors;j++){if(j==0&&parseFloat(graph.mapconfig.discreteColors[j].cutoff)<=fillData||j!=0&&parseFloat(graph.mapconfig.discreteColors[j].cutoff)<fillData){markerAttr.fill[dateKey][markerId]=graph.mapconfig.discreteColors[j].color}else break}}}}else{}}}calcData.markerAttr=markerAttr}function makeRGB(color){if(color.substr(0,1)=="#")color=color.substr(1);var r,g,b;r=parseInt(color.substr(0,2),16);g=parseInt(color.substr(2,2),16);b=parseInt(color.substr(4,2),16);return{r:r,g:g,b:b}}function colorInRange(y,y1,y2,rgb1,rgb2,logScaling){var r,g,b,yl,yl1,yl2,percent,octet=MD.common.octet;if(logScaling){yl=Math.log(Math.abs(y));yl1=Math.log(Math.min(Math.abs(y1),Math.abs(y2)));yl2=Math.log(Math.max(Math.abs(y1),Math.abs(y2)));percent=(yl-yl1)/(yl2-yl1)}else{percent=(y-y1)/(y2-y1)}r=octet(Math.round(percent*(rgb2.r-rgb1.r)+rgb1.r));g=octet(Math.round(percent*(rgb2.g-rgb1.g)+rgb1.g));b=octet(Math.round(percent*(rgb2.b-rgb1.b)+rgb1.b));return"#"+r+g+b}}function getMapDataByContainingDate(mapData,mdDate){while(mdDate.length>=4){if(mapData[mdDate])return mapData[mdDate];mdDate=mdDate.substr(0,mdDate.length-2)}return false}}},isSummationMap:function isSummationMap(oGraph){if(!oGraph.mapsets)return false;if(!oGraph.mapsets.options.calculatedFormula)plotFormula(oGraph.mapsets);var formula=oGraph.mapsets.options.calculatedFormula;for(var i=0;i<oGraph.mapsets.components.length;i++){if(oGraph.mapsets.components[i].handle[0]!="M")return false}return/[-+]/.test(formula.numFormula)&&!/[*/]/.test(formula.numFormula)},plotName:function plotName(graph,plot,forceCalculated){var handle,comp,c,calcName="";if(typeof plot.options.name!="undefined"&&plot.options.name!=""&&!forceCalculated){return plot.options.name}else{var isDenom=false;for(c=0;c<plot.components.length;c++){comp=plot.components[c];handle=comp.handle;calcName+=(c!=0&&comp.options.op?comp.options.dn=="d"&&!isDenom?" / ":" "+comp.options.op+" ":" ")+graph.assets[handle].name;isDenom=comp.options.dn=="d"||isDenom}return calcName}},plotUnits:function plotUnits(graph,plot,forceCalculated,formulaObj){var c,i,terms,numUnits="",denomUnits="";if(plot.components.length==1){return plot.options.units||(plot.components[0].op=="/"?"per ":"")+(graph.assets[plot.components[0].handle].units||"")}if(!plot.options.units||forceCalculated){if(!formulaObj)formulaObj=plotFormula(plot);var numerUnits=formulaObj.numFormula;var denomFormula=formulaObj.denomFormula;replaceFormula("^(-)?(1)?","");var patKs=/[0-9]+/g;var scalorFlag=patKs.test(numerUnits)||patKs.test(denomFormula);numerUnits=numerUnits.replace(patKs," ");denomFormula=denomFormula.replace(patKs," ");var patRemoveOps=/(\*|\(|\))/g;numerUnits=numerUnits.replace(patRemoveOps," ");denomFormula=denomFormula.replace(patRemoveOps," ");var patPer=/\//g;numerUnits=numerUnits.replace(patPer," per ");denomFormula=denomFormula.replace(patPer," per ");var patMinus=/-/g;numerUnits=numerUnits.replace(patMinus,"+");denomFormula=denomFormula.replace(patMinus,"+");var patWhiteSpace=/[\s]+/g;numerUnits=numerUnits.replace(patWhiteSpace," ");denomFormula=denomFormula.replace(patWhiteSpace," ");replaceFormula("([A-Z]+)","{{$1}}");var patPlus=/\+/g;for(c=0;c<plot.components.length;c++){replaceFormula("{{"+compSymbol(c)+"}}",(graph.assets[plot.components[c].handle].units||"").replace(patPlus," "))}var error=false;if(numerUnits!=""){terms=numerUnits.split("+");numerUnits=terms[0].trim();for(i=1;i<terms.length;i++){if(terms[i].trim()!=numerUnits)error=true}}if(denomFormula!=""){terms=denomFormula.split("+");denomUnits=terms[0].trim();for(i=1;i<terms.length;i++){if(terms[i].trim()!=terms[0])error=true}}if(error){return"potentially mismatched units"}else{if(numerUnits==denomUnits&&numerUnits.length>0){return"ratio"}else{return(scalorFlag?"user scaled ":"")+numerUnits+(denomUnits==""?"":" per "+denomUnits)}}}else{return plot.options.units}function replaceFormula(search,replace){var pat=new RegExp(search,"g");numerUnits=numerUnits.replace(pat,replace);denomUnits=denomUnits.replace(pat,replace)}},visiblePanelId:function visiblePanelId(){var visPan=$("div.graph-panel:visible");if(visPan.length==1){return visPan.get(0).id}else{return null}},formatDateByPeriod:function formatDateByPeriod(val,period){if(isNaN(val)==false&&val!==null){var dt=new Date(parseInt(val));switch(period){case"A":return dt.getUTCFullYear();case"Q":return"Q"+parseInt((dt.getUTCMonth()+3)/3)+" "+dt.getUTCFullYear();case"SA":case"M":return months[dt.getUTCMonth()]+" "+dt.getUTCFullYear();case"W":case"D":return dt.getUTCDate()+" "+months[dt.getUTCMonth()]+" "+dt.getUTCFullYear();default:return dt.toUTCString().substr(5,20)}}else{return"-"}},eachComponent:function eachComponent(graph,callback){eachPlot(graph,function(){var plot=this;$.each(plot.components,function(c){callback.call(this,c,plot)})})},eachPlot:function eachPlot(graph,callback){if(graph.mapsets)callback.call(graph.mapsets);if(graph.pointsets)$.each(graph.pointsets,function(p){callback.call(this,p,graph.pointsets[p])});if(graph.plots)$.each(graph.plots,function(p){callback.call(this,p,graph.plots[p])})},fillScalingCount:function fillScalingCount(pointsets){var fill=0;if(pointsets instanceof Array){fill=pointsets.length-areaScalingCount(pointsets)}return fill},areaScalingCount:function areaScalingCount(pointsets){var area=0;if(pointsets instanceof Array){$.each(pointsets,function(){if(this.options.attribute!="fill")area++})}return area}};var chartPanel=grapher.chartPanel,intervalStartDt=grapher.intervalStartDt,setCropSlider=grapher.setCropSlider,dateFromMdDate=grapher.dateFromMdDate,closestDate=grapher.closestDate,assetNeeded=grapher.assetNeeded,getAssets=grapher.getAssets,fetchAssets=grapher.fetchAssets,createMyGraph=grapher.createMyGraph,emptyGraph=grapher.emptyGraph,makeChartOptionsObject=grapher.makeChartOptionsObject,createSerieFromPlot=grapher.createSerieFromPlot,plotFormula=grapher.plotFormula,compSymbol=grapher.compSymbol,buildGraphPanel=grapher.buildGraphPanel,isSummationMap=grapher.isSummationMap,plotName=grapher.plotName,plotUnits=grapher.plotUnits,visiblePanelId=grapher.visiblePanelId,formatDateByPeriod=grapher.formatDateByPeriod,eachComponent=grapher.eachComponent,eachPlot=grapher.eachPlot,fillScalingCount=grapher.fillScalingCount,areaScalingCount=grapher.areaScalingCount;var graphTitle={template:'<div id="dwrap2">'+'<div id="titleEditor" style="width: 560px">'+'<input type="text" width="300px" name="title" /> '+'<button id="graph-title-change-ok">OK</button> '+'<button id="graph-title-change-cancel">cancel</button>'+"</div>"+"</div>",show:function(oTitle,callback){var self=this;$.fancybox(this.template,{width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none",left:"55px",top:"55px"});$("#fancybox-wrap").stop().css({top:"70px"});$("#graph-title-change-ok").click(self.changeOk);$("#graph-title-change-cancel").click(self.changeCancel);var thisPanelID=$(oTitle).closest("div.graph-panel").get(0).id;$("#titleEditor input").keyup(function(event){if(event.keyCode==13)self.changeOk()}).attr("data",thisPanelID).val(panelGraphs[thisPanelID].title).css("width","450px").focus();this.callback=callback},callBack:false,changeOk:function(){var thisPanelID=$("#titleEditor input").attr("data");var newTitle=$("#titleEditor input").val().trim();var graph=panelGraphs[thisPanelID];if(newTitle!=graph.title){graph.title=newTitle||"untitled";if(graph.plots){if(graph.title.length==0){graph.controls.chart.setTitle({text:"untitled - click to edit",style:{color:"grey",font:"italic"}})}else{graph.controls.chart.setTitle({text:graph.title,style:{color:"black",font:"normal"}})}$("#"+thisPanelID+" .highcharts-title").click(function(){graphTitle.show(this)})}var tabLabel=newTitle||"Graph "+thisPanelID.substr(thisPanelID.indexOf("-")+1);$("#graph-tabs a[href='#"+thisPanelID+"']").attr("title",tabLabel).html(tabLabel);$("#"+thisPanelID+" h3.mashabledata_map-title").html(graph.title);if(graph.title.length==0){if(this.callback)this.callback()}}this.changeCancel()},changeCancel:function(){$.fancybox.close();this.callBack=false}};return grapher;function calcGraphMinMaxZoomPeriod(oGraph){oGraph.smallestPeriod="A";oGraph.largestPeriod="N";var min,max,jsdt,handle,key;eachComponent(oGraph,function(){if(!oGraph.assets[this.handle].firstdt&&(this.handle.charAt(0)=="M"||this.handle.charAt(0)=="X")){for(handle in oGraph.assets[this.handle].data){jsdt=oGraph.assets[this.handle].data[handle].firstdt;oGraph.assets[this.handle].firstdt=Math.min(oGraph.assets[this.handle].firstdt,jsdt)||jsdt;jsdt=oGraph.assets[this.handle].data[handle].lastdt;oGraph.assets[this.handle].lastdt=Math.max(oGraph.assets[this.handle].lastdt,jsdt)||jsdt}}jsdt=oGraph.assets[this.handle].firstdt;min=Math.min(jsdt,min)||jsdt||min;jsdt=oGraph.assets[this.handle].lastdt;max=Math.max(jsdt,max)||jsdt||min});if(oGraph.plots){$.each(oGraph.plots,function(){var thisPeriod=this.options.fdown||oGraph.assets[this.components[0].handle].period;if(period.value[oGraph.smallestPeriod]>period.value[thisPeriod])oGraph.smallestPeriod=thisPeriod;if(period.value[oGraph.largestPeriod]<period.value[thisPeriod])oGraph.largestPeriod=thisPeriod})}oGraph.firstdt=min;oGraph.lastdt=max;oGraph.minZoom=oGraph.start||oGraph.firstdt;oGraph.maxZoom=oGraph.end||oGraph.lastdt}function nextColor(aryOptionedObjects){var usedColors=[];$.each(aryOptionedObjects,function(){if(this.options&&this.options.color)usedColors.push(this.options.color)});var allColors=hcColors.concat(primeColors);for(var i=0;i<allColors.length;i++){if(usedColors.indexOf(allColors[i])==-1)return allColors[i]}return allColors[aryOptionedObjects.length%allColors.length]}function formatRationalize(value){var order=Math.floor(Math.log(Math.abs(value))/Math.LN10);var y=Math.round(value/Math.pow(10,order-2))*Math.pow(10,order-2);return Highcharts.numberFormat(y,order>1?0:2-order)}function vizualizeCube(graph,geoKey,mapDate,action){if(typeof action=="undefined")action="new";var serie,i,j,k,cubeid=graph.mapconfig.cubeid;if(!graph.assets.cube)graph.assets.cube={};var cube=graph.assets.cube;if(!cube["G"+geoKey]){var $cubViz=graph.controls.$thisPanel.find("div.mashabledata_cube-viz");$cubViz.mask("loading...");callApi({command:"GetCubeSeries",ghash:graph.ghash||"",cubeid:cubeid,geokey:geoKey,modal:"none"},function(jsoData,textStatus,jqXHR){cube["G"+geoKey]={series:jsoData.series};cube.dimensions=jsoData.dimensions;cube.theme=jsoData.theme;cube.name=jsoData.name;cube.units=jsoData.units;$cubViz.unmask();makeCubeChart()})}else{makeCubeChart()}function makeCubeChart(){var dimensions=cube.dimensions;var n=dimensions.length;var geoName=null;if(isNaN(geoKey)){eachComponent(graph,function(){if(!geoName){if(this.handle[0]=="M"&&graph.assets[this.handle].data[geoKey])geoName=graph.assets[this.handle].data[geoKey].geoname}})}else{geoName=graph.map}var cubeData=cube["G"+geoKey];if(cubeData.series){var cubeSeries=cubeData.series;cubeData.facetedData=[];function makeFacetedData(d,facetArray,facetsItem){var i,newFactetsItem;for(i=0;i<dimensions[d].list.length;i++){if(d==n-1){newFactetsItem=facetsItem.slice();newFactetsItem.push(dimensions[d].list[i]);facetArray.push(getCubeSeries(newFactetsItem))}else{var facetSubArray=[];facetArray.push(facetSubArray);newFactetsItem=facetsItem.slice();newFactetsItem.push(dimensions[d].list[i]);makeFacetedData(d+1,facetSubArray,newFactetsItem)}}function getCubeSeries(facetsItem){var s,match,serie;for(s=0;s<cubeSeries.length;s++){match=true;serie=cubeSeries[s];for(var d=0;d<n;d++){if(serie.name.toLowerCase().indexOf(" "+facetsItem[d].name.toLowerCase())===-1){match=false;break}}if(match){cubeSeries.splice(s,1);return serie.data}}return null}}makeFacetedData(0,cubeData.facetedData,[]);delete cubeData.series}var vizChart={chart:{type:"bar",spacingRight:50,renderTo:graph.controls.$thisPanel.find(".mashabledata_cube-viz")[0]},title:{text:cube.theme+"<br>"+(geoName||""),style:{fontSize:"12px"}},subtitle:{text:"click on map to select location",style:{fontSize:"10px"},y:geoName?50:30},plotOptions:{bar:{dataLabels:{enabled:false,align:"left"},borderWidth:0,animation:false,stacking:null}},xAxis:{categories:[],title:{text:null},lineWidth:1,minorGridLineWidth:0,labels:{enabled:true},minorTickLength:0,tickLength:0},yAxis:{title:{text:cube.units||""},labels:{enabled:false},lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",gridLineColor:"transparent",gridLineWidth:0},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false,type:"image/png",url:"https://www.mashabledata.com/workbench/export/index.php"},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{formatter:function(){return"<b>"+cube.theme+"</b><br/>"+this.point.name+":<br/>"+Highcharts.numberFormat(Math.abs(this.point.y),0)+" "+cube.units}}};var facetedData=cubeData.facetedData;var point,varData;switch(n){case 1:barData=[];for(i=0;i<dimensions[0].list.length;i++){point={y:seriesValue(facetedData[i],mapDate),name:dimensions[0].list[i].name};if(dimensions[0].list[i].color)point.color=dimensions[0].list[i].color;barData.push(point);vizChart.xAxis.categories.push(dimensions[0].list[i].short||dimensions[0].list[i].name)}vizChart.series.push({id:geoKey,name:geoName,data:barData,showInLegend:false});vizChart.plotOptions.bar.dataLabels.enabled=true;break;case 2:for(i=0;i<dimensions[0].list.length;i++){barData=[];for(j=0;j<dimensions[1].list.length;j++){if(i==0)vizChart.xAxis.categories.push(dimensions[1].list[j].short||dimensions[1].list[j].name);point={y:seriesValue(facetedData[i][j],mapDate),name:dimensions[0].list[i].name+"<br>and "+dimensions[1].list[j].name};barData.push(point)}serie={name:dimensions[0].list[i].name,data:barData};if(dimensions[0].list[i].color)serie.color=dimensions[0].list[i].color;vizChart.series.push(serie);vizChart.plotOptions.bar.stacking="normal"}break;case 3:for(i=0;i<dimensions[0].list.length;i++){for(k=0;k<dimensions[2].list.length;k++){barData=[];for(j=0;j<dimensions[1].list.length;j++){if(i==0&&k==0)vizChart.xAxis.categories.push(dimensions[1].list[j].short||dimensions[1].list[j].name);point={y:(i==0?-1:1)*seriesValue(facetedData[i][j][k],mapDate),name:dimensions[0].list[i].name+"<br>and "+dimensions[1].list[j].name+"<br>and "+dimensions[2].list[k].name};barData.push(point)}serie={name:dimensions[2].list[k].name,data:barData};if(dimensions[2].list[k].color)serie.color=dimensions[2].list[k].color;vizChart.series.push(serie)}}vizChart.legend.enabled=false;vizChart.plotOptions.bar.stacking="normal";vizChart.xAxis.lineWidth=0;break}switch(action){case"add":vizChart.series[0].showInLegend=true;graph.controls.vizChart.addSeries(vizChart.series[0]);break;case"remove":graph.controls.vizChart.get(geoKey).remove(false);break;case"summation":vizChart.series[0].pointWidth=1;vizChart.series[0].pointPadding=0;vizChart.plotOptions.bar.groupPadding=0;default:if(graph.controls.vizChart)graph.controls.vizChart.destroy();graph.controls.vizChart=new Highcharts.Chart(vizChart)}}}function seriesValue(mdData,mdDate){if(!mdData)return null;var point,data=mdData.split("||");for(var i=0;i<data.length;i++){point=data[i].split("|");if(point[0]==mdDate){if(point[1]=="null")return null;else return parseFloat(point[1])}}return null}}();if(typeof console=="undefined")console={};if(typeof console.info=="undefined")console.info=function(m){};if(typeof console.log=="undefined")console.log=function(m){};if(typeof console.time=="undefined")console.time=function(m){};if(typeof console.timeEnd=="undefined")console.timeEnd=function(m){};function addJQueryStringify(){jQuery.extend({stringify:function stringify(obj){if("JSON"in window){return JSON.stringify(obj)}var t=typeof obj;if(t!="object"||obj===null){if(t=="string")obj='"'+obj+'"';return String(obj)}else{var n,v,json=[],arr=obj&&obj.constructor==Array;for(n in obj){v=obj[n];t=typeof v;if(obj.hasOwnProperty(n)){if(t=="string"){v='"'+v+'"'}else if(t=="object"&&v!==null){v=jQuery.stringify(v)}json.push((arr?"":'"'+n+'":')+String(v))}}return(arr?"[":"{")+String(json)+(arr?"]":"}")}}})}Date.prototype.toMDDateString=function(period){var p=period||this.period;if(!p)throw"no period found";var mdDate=this.getUTCFullYear();switch(period){case"M":mdDate+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();break;case"Q":mdDate+="Q"+parseInt((this.getUTCMonth()+3)/3);break;case"SA":mdDate+="H"+parseInt((this.getUTCMonth()+6)/6);break;case"W":case"D":mdDate+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();mdDate+=(this.getUTCDate().toString().length==1?"0":"")+this.getUTCDate();break}return mdDate};if(!("pushUnique"in Array.prototype)){Array.prototype.pushUnique=function(item){if(this.indexOf(item)===-1){return this.push(item)}else{return false}}}if(!("bind"in Function.prototype)){Function.prototype.bind=function(owner){var that=this;if(arguments.length<=1){return function(){return that.apply(owner,arguments)}}else{var args=Array.prototype.slice.call(arguments,1);return function(){return that.apply(owner,arguments.length===0?args:args.concat(Array.prototype.slice.call(arguments)))}}}}if(!("trim"in String.prototype)){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(find,i){if(i===undefined)i=0;if(i<0)i+=this.length;if(i<0)i=0;for(var n=this.length;i<n;i++)if(i in this&&this[i]===find)return i;return-1}}if(!("lastIndexOf"in Array.prototype)){Array.prototype.lastIndexOf=function(find,i){if(i===undefined)i=this.length-1;if(i<0)i+=this.length;if(i>this.length-1)i=this.length-1;for(i++;i-->0;)if(i in this&&this[i]===find)return i;return-1}}if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(action,that){for(var i=0,n=this.length;i<n;i++)if(i in this)action.call(that,this[i],i,this)}}if(!("map"in Array.prototype)){Array.prototype.map=function(mapper,that){var other=new Array(this.length);for(var i=0,n=this.length;i<n;i++)if(i in this)other[i]=mapper.call(that,this[i],i,this);return other}}if(!("filter"in Array.prototype)){Array.prototype.filter=function(filter,that){var other=[],v;for(var i=0,n=this.length;i<n;i++)if(i in this&&filter.call(that,v=this[i],i,this))other.push(v);return other}}if(!("every"in Array.prototype)){Array.prototype.every=function(tester,that){for(var i=0,n=this.length;i<n;i++)if(i in this&&!tester.call(that,this[i],i,this))return false;return true}}if(!("some"in Array.prototype)){Array.prototype.some=function(tester,that){for(var i=0,n=this.length;i<n;i++)if(i in this&&tester.call(that,this[i],i,this))return true;return false}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(find,i){if(i===undefined)i=0;if(i<0)i+=this.length;if(i<0)i=0;for(var n=this.length;i<n;i++)if(i in this&&this[i]===find)return i;return-1}}jQuery.fn.sortElements=function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this){throw new Error("You can't sort elements if any one is a descendant of another.")}parentNode.insertBefore(this,nextSibling);parentNode.removeChild(nextSibling)}});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this))})}}();window.MashableData.plugin=function(){var $=jQuery,MD=MashableData;var plugin_obj={version:"0.5",isMashableDefault:true,iframeLoaded:false,iframeRequested:false,aMsg:[],recentsKey:null,bookmarksKey:null,bookmarks:[],recents:[],series:{},seriesXferCount:0,seriesXfered:0,regDQuotes:/"/g,iframe_load:function(){var mdFrame=document.getElementById("mashabledata_secure_xfer").contentWindow;
this.iframe_loaded=true;if(window.addEventListener){window.addEventListener("message",this.receiveReply,false)}else if(window.attachEvent){window.attachEvent("message",this.receiveReply)}for(var i=0;i<MD.plugin.aMsg.length;i++){mdFrame.postMessage(MD.plugin.aMsg[i],"https://www.mashabledata.com/secure_xfer.php")}},receiveReply:function(event){if(event.origin.toLowerCase().indexOf(".mashabledata.com")!=-1)MD.plugin.seriesXfered++;if(MD.plugin.seriesXfered==MD.plugin.seriesXferCount&&MD.plugin.OKToNavigate)MD.plugin.navigate()},calcSeriesInfo:function(PointArray){var oSereiesInfo={firstdt:null,lastdt:null,minValue:null,maxValue:null,period:"A"};var dayOfMonth=null;var dayOfWeek=null;var monthOfYear=null;var timeOfDay=null;var xDateTime,thisPoint;for(var pointIndex in PointArray){thisPoint=PointArray[pointIndex];if(oSereiesInfo.firstdt==null||oSereiesInfo.firstdt>thisPoint.x){oSereiesInfo.firstdt=thisPoint.x}if(oSereiesInfo.lastdt==null||oSereiesInfo.lastdt<thisPoint.x){oSereiesInfo.lastdt=thisPoint.x}if(oSereiesInfo.minValue==null||oSereiesInfo.minValue>thisPoint.y){oSereiesInfo.minValue=thisPoint.y}if(oSereiesInfo.maxValue==null||oSereiesInfo.maxValue<thisPoint.x){oSereiesInfo.maxValue=thisPoint.y}xDateTime=new Date(parseInt(thisPoint.x));if(timeOfDay==null){timeOfDay=xDateTime.getUTCHours()+":"+xDateTime.getUTCMinutes()+":"+xDateTime.getUTCSeconds()+"."+xDateTime.getUTCMilliseconds()}else if(timeOfDay!==true&&timeOfDay!=xDateTime.getUTCHours()+":"+xDateTime.getUTCMinutes()+":"+xDateTime.getUTCSeconds()+"."+xDateTime.getUTCMilliseconds()){timeOfDay=true}if(dayOfMonth==null){dayOfMonth=xDateTime.getUTCDate()}else if(dayOfMonth!==true&&dayOfMonth!=xDateTime.getUTCDate()){dayOfMonth=true}if(dayOfWeek==null){dayOfWeek=xDateTime.getUTCDay()}else if(dayOfWeek!==true&&dayOfWeek!=xDateTime.getUTCDay()){dayOfWeek=true}if(monthOfYear==null){monthOfYear=xDateTime.getUTCMonth()}else if(monthOfYear!==true&&monthOfYear!=xDateTime.getUTCMonth()){monthOfYear=true}}if(timeOfDay===true){oSereiesInfo.period="T"}else if(dayOfWeek!==true){oSereiesInfo.period="W"}else if(dayOfMonth===true){oSereiesInfo.period="D"}else if(monthOfYear===true){oSereiesInfo.period="M"}else{oSereiesInfo.period="A"}return oSereiesInfo},storeChartSeries:function(thisChart){if(window.console&&window.console.time)window.console.time("storeChartSeries");var i,j,thisSerie,serie,lsKey,recents,bookmarks,idxRecent,idxBookmark,oldSerieString,poppedKey,isMashable;var timestamp=(new Date).getTime();if(localStorage.getItem("md_authorized")=="N")return false;var title=thisChart.options.title?thisChart.options.title.text||"":"";recents=JSON.parse(localStorage.md_recents||"[]");bookmarks=JSON.parse(localStorage.md_bookmarks||"[]");for(i=0;i<thisChart.series.length;i++){thisSerie=thisChart.series[i];if(thisSerie.xAxis.options.type=="datetime"){if(typeof thisSerie.options.isMashable!="undefined"){isMashable=thisSerie.options.isMashable}else{if(typeof thisChart.options.isMashable!="undefined"){isMashable=thisChart.options.isMashable}else{isMashable=this.isMashableDefault}}if(isMashable&&(thisSerie.name||thisChart.title&&thisChart.title.text&&thisChart.series.length==1)){serie=MD.plugin.calcSeriesInfo(thisSerie.data);serie.data=[];for(j=0;j<thisSerie.data.length;j++){serie.data.push([thisSerie.data[j].x,thisSerie.data[j].y])}serie.name=thisSerie.fullName||(thisSerie.name?title.length>0&&thisSerie.name.indexOf(title)==-1?title+": "+thisSerie.name:thisSerie.name:title);serie.description=thisSerie.description;serie.skey=thisSerie.skey;serie.graph=thisChart.options.title&&thisChart.options.title.text?thisChart.options.title.text:"";serie.credit=thisChart.options.credits&&thisChart.options.credits.text?thisChart.options.credits.text:null;serie.url=window.location.href;serie.units=thisSerie.units||(thisSerie.yAxis.options.title?thisSerie.yAxis.options.title.text||"":"");serie.save_dt=timestamp;lsKey=serie.skey||serie.name+"|"+serie.units+"|"+serie.period;if(!serie.skey)serie.md_key=lsKey;thisSerie.options.md_key=lsKey;idxRecent=recents.indexOf(lsKey);idxBookmark=bookmarks.indexOf(lsKey);if(idxBookmark>0){thisSerie.bookmark=(new Date).getTime();bookmarks.splice(idxBookmark,1);bookmarks.unshift(lsKey)}if(idxRecent>=0)recents.splice(idxRecent,1);recents.unshift(lsKey);if(idxBookmark!=-1){oldSerieString=localStorage.getItem(lsKey);if(oldSerieString){serie.bookmark=JSON.parse(oldSerieString).bookmark}}localStorage.setItem(lsKey,JSON.stringify(serie))}}}while(recents.length>99){poppedKey=recents.pop();if(bookmarks.indexOf(poppedKey)==-1)localStorage.removeItem(poppedKey)}localStorage.md_recents=JSON.stringify(recents);localStorage.md_bookmarks=JSON.stringify(bookmarks);if(window.console&&window.console.time)window.console.timeEnd("storeChartSeries")},postSeries:function(serie){if(!this.iframeRequested){jQuery("body").append('<div id="md_frame_holder" style="display:none"><iframe id="mashabledata_secure_xfer" onload="MashableData.plugin.iframe_load()" src="https://www.mashabledata.com/secure_xfer.php"></iframe></div>');this.iframeRequested=true}if(this.iframe_loaded){var mdFrame=document.getElementById("mashabledata_secure_xfer").contentWindow;mdFrame.postMessage(JSON.stringify(serie),"https://www.mashabledata.com/secure_xfer.php")}else{this.aMsg.push(JSON.stringify(serie))}},navigate:function(){window.location.href="../workbench"},loadAllSeries:function(){var i;if(this.recentsKey!=localStorage.md_recents){this.recentsKey=localStorage.md_recents;this.recents=JSON.parse(this.recentsKey);for(i=0;i<this.recents.length;i++){if(!this.series[this.recents[i]])this.series[this.recents[i]]=JSON.parse(localStorage.getItem(this.recents[i]))}}if(this.bookmarksKey!=localStorage.md_bookmarks){this.bookmarksKey=localStorage.md_bookmarks;this.bookmarks=JSON.parse(this.bookmarksKey);for(i=0;i<this.bookmarks.length;i++){if(!this.series[this.bookmarks[i]]){this.series[this.bookmarks[i]]=JSON.parse(localStorage.getItem(this.bookmarks[i]));this.series[this.bookmarks[i]].name=this.series[this.bookmarks[i]].name.replace(this.regDQuotes,"&quot;");this.series[this.bookmarks[i]].units=this.series[this.bookmarks[i]].units.replace(this.regDQuotes,"&quot;")}}}},bookmarkSeries:function(key){this.series[key].bookmark=(new Date).getTime();this.series[key].isDirty=true;var index=this.bookmarks.indexOf(key);if(index!=-1)this.bookmarks.splice(index,1);this.bookmarks.unshift(key)},unBookmarkSeries:function(key){MD.plugin.bookmarks.splice(MD.plugin.bookmarks.indexOf(key),1);delete this.series[key].bookmark;var index=this.bookmarks.indexOf(key);if(index!=-1)this.bookmarks.splice(index,1);if(this.recents.indexOf(key)==-1){delete this.series[key]}this.series[key].isDirty=true},showPanel:function(chart){jQuery(document).bind("click",closePanel);jQuery("#mashabledata_panel").remove();this.loadAllSeries();this.activeChart=chart;var $panel,self=this,html='<div id="mashabledata_panel">'+"<h3>Charting Toolbox</h3>"+'<span id="mashabledata_cancel" class="mashabledata_close">close</span>'+(chart.options.exporting&&chart.options.exporting.enable!==false?'<span>Download chart as: <a class="mashabledata_png" data="image/png">PNG</a><a class="mashabledata_jpg" data="image/jpeg">JPG</a><a class="mashabledata_svg" data="image/svg+xml">SVG</a><a class="mashabledata_pdf" data="application/pdf">PDF</a><span id="mashabledata_print" class="mashabledata_print">print chart</span></span>':"")+'<div id="mashabledata_tabs">'+'<ol><li class="mashabledata_active mashabledata_recents"><a data="#mashabledata_recents">recent<span class="mashabledata_info">('+this.recents.length+')</span></a></li><li class="mashabledata_bookmarks"><a data="#mashabledata_bookmarks">bookmarks<span class="mashabledata_info">('+this.bookmarks.length+")</span></a></li></ol>"+'<span><input class="mashabledata_inputmsg mashabledata_filter" value="type here to filter series"></span>'+'<div id="mashabledata_recents">'+'<table><tr><th class="mashabledata_cell_bookmark"></th><th class="mashabledata_cell_check"></th><th class="mashabledata_cell_name">name</th><th class="mashabledata_cell_units">units</th><th class="mashabledata_cell_f">f</th><th class="mashabledata_cell_from">from</th><th class="mashabledata_cell_to">to</th><th class="mashabledata_cell_viewed">viewed<span id="mashabledata_desc"></span></th><th class="mashabledata_cell_url">url</th></tr></table>'+'<div class="mashabledata_scroll"><table>'+this.makeRows(this.recents)+"</table></div>"+"</div>"+'<div id="mashabledata_bookmarks">'+'<table><tr><th class="mashabledata_cell_check"></th><th class="mashabledata_cell_bookmark"></th><th class="mashabledata_cell_name">name</th><th class="mashabledata_cell_units">units</th><th class="mashabledata_cell_f">f</th><th class="mashabledata_cell_from">from</th><th class="mashabledata_cell_to">to</th><th class="mashabledata_cell_viewed">viewed<span id="mashabledata_desc"></span></th><th class="mashabledata_cell_url">url</th></tr></table>'+'<div class="mashabledata_scroll"><table>'+this.makeRows(this.bookmarks)+"</table></div>"+"</div>"+'<span class="mashabledata_these">applies to</span> <span id="mashabledata_check_all">uncheck all</span> '+'<button id="mashabledata_update" value="chart" disabled>update chart</button>'+'<button id="mashabledata_export" value="md">send to MashableData.com *</button>'+'<br><span style="font-size: 9px;margin: 1px 10px;float:right;">* MashableData.com curates millions of statistics and provides visualization tools to create and share interactive maps and graphs</span>'+"</div>"+"</div>";$panel=jQuery(html).prependTo(chart.container);$panel.find("").click(function(){chart.print();closePanel()});$panel.find("a.mashableddata-jpg, a.mashableddata-svg, a.mashableddata-pdf, mashableddata-png").click(function(){var type=jQuery(this).attr("data");if(type=="PNG")chart.exportChart();else chart.exportChart({type:type});closePanel()});$panel.find("input.mashabledata_inputmsg").click(function(){if(jQuery(this).hasClass("mashabledata_inputmsg")){jQuery(this).removeClass("mashabledata_inputmsg").val("").focus()}}).keyup(function(){var table,visible,keyWords=jQuery(this).val();table=$panel.find("#mashabledata_recents div.mashabledata_scroll table");visible=self.searchTable(table,keyWords);$panel.find("li.mashabledata_recents span").html("("+visible+(table[0].rows.length==visible?"":" of "+table[0].rows.length)+")");table=$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table");visible=self.searchTable(table,keyWords);$panel.find("li.mashabledata_bookmarks span").html("("+visible+(table[0].rows.length==visible?"":" of "+table[0].rows.length)+")")});$panel.find("div.mashabledata_scroll table").click(function(evt){var $target=jQuery(evt.target);var $td=$target.closest("td");if($td.hasClass("mashabledata_cell_bookmark")){var key=$td.parent().find("input").attr("data");if(self.series[key]){if(self.series[key].bookmark){self.unBookmarkSeries(key);$panel.find("#mashabledata_bookmarks div.mashabledata_scroll input[data='"+key+"']").closest("tr").remove();$panel.find("#mashabledata_recents div.mashabledata_scroll input[data='"+key+"']").closest("tr").find("td.mashabledata_cell_bookmark span").addClass("mashabledata_nostar").removeClass("mashabledata_star")}else{self.bookmarkSeries(key);$td.find("span").addClass("mashabledata_star").removeClass("mashabledata_nostar");$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table").prepend(self.makeRows([key]))}var $table=$panel.find("#mashabledata_bookmarks div.mashabledata_scroll table");var visible=$table.find("tr:visible").length;$panel.find("li.mashabledata_bookmarks span").html("("+visible+($table[0].rows.length==visible?"":" of "+$table[0].rows.length)+")");updateLocalStorage()}}else{if(!$target.is(":checkbox")){$td.parent().find("input:checkbox").click()}jQuery("#mashabledata_update").removeAttr("disabled");if($panel.find("input:checkbox:checked").length==0){$panel.find("#mashabledata_check_all").innerHTML="uncheck all"}else{$panel.find("#mashabledata_check_all").innerHTML="check all"}}});$panel.find("input:checkbox").change(function(){});$panel.find("td.mashabledata_cell_bookmark span").click(function(){});$panel.find("ol a").click(function(){$panel.find("ol li").removeClass("mashabledata_active");$panel.find("#mashabledata_recents, #mashabledata_bookmarks").hide();$panel.find(jQuery(this).closest("li").addClass("mashabledata_active").end().attr("data")).show()});$panel.find("th").attr("title","click to sort on this column").each(function(){var $th=jQuery(this),thIndex=$th.index(),inverse=false;$th.click(function(){var $table=$th.closest("div").find("div.mashabledata_scroll table");$table.find("td").filter(function(){return jQuery(this).index()===thIndex}).sortElements(function(a,b){if(jQuery.text([a])==jQuery.text([b]))return 0;return jQuery.text([a])>jQuery.text([b])?inverse?-1:1:inverse?1:-1},function(){return this.parentNode});$panel.find(".mashabledata_asc, .mashabledata_desc").remove();$th.append('<span class="'+(inverse?"mashabledata_asc":"mashabledata_desc")+'"></span>');inverse=!inverse})});$panel.find("#mashabledata_check_all").click(function(){if(this.innerHTML=="check all"){$panel.find("div>div:visible input:not(:checked)").each(function(){this.checked=true});this.innerHTML="uncheck all"}else{$panel.find("div>div:visible input:checked").each(function(){this.checked=false});this.innerHTML="check all"}});function getCheckKeys(){var checkedKeys=[],key;$panel.find("table input:checked").each(function(){key=jQuery(this).attr("data");if(checkedKeys.indexOf(key)==-1)checkedKeys.push(key)});return checkedKeys}$panel.find("#mashabledata_update").click(function(){var checkedKeys=getCheckKeys(),series,y;for(var i=0;i<chart.series.length;i++){if(chart.series[i].options.md_key&&checkedKeys.indexOf(chart.series[i].options.md_key)==-1){chart.series[i--].remove(false)}}for(i=0;i<checkedKeys.length;i++){if(!self.hasSeries(checkedKeys[i])){series=self.series[checkedKeys[i]];for(y=0;y<chart.yAxis.length;y++){if((series.units||"values")==chart.yAxis[y].options.title.text)break}if(y==chart.yAxis.length){chart.addAxis({title:{text:series.units||"values"}},false,false)}chart.addSeries({name:series.name,data:series.data,mash:true,md_key:checkedKeys[i],yAxis:y},false)}}for(y=chart.yAxis.length-1;y>=0;y--){if(chart.yAxis[y].series.length==0)chart.yAxis[y].remove(false)}chart.redraw();closePanel()});$panel.find("#mashabledata_export").click(function(){var checkedKeys=getCheckKeys();for(i=0;i<checkedKeys.length;i++){self.seriesXferCount++;self.postSeries(self.series[checkedKeys[i]])}if(self.seriesXferCount==self.seriesXfered)self.navigate();else self.OKToNavigate=true;closePanel()});$panel.find("#mashabledata_cancel").click(function(){closePanel()});function closePanel(evt){if(evt&&jQuery(evt.target).closest("#mashabledata_panel").length==1)return;$panel.remove();jQuery(document).unbind("click",closePanel)}jQuery("#mashabledata_recents th.mashabledata_cell_check").click();function updateLocalStorage(){for(var key in self.series){if(self.series[key].isDirty){if(self.bookmarks.indexOf(key)+self.recents.indexOf(key)==-1){localStorage.removeItem(key)}else{delete self.series[key].isDirty;localStorage.setItem(key,JSON.stringify(self.series[key]))}}}localStorage.md_recents=JSON.stringify(self.recents);localStorage.md_bookmarks=JSON.stringify(self.bookmarks)}},makeRows:function(aryKeys){var i,series,rows="",now=new Date,viewed,inChart;for(i=0;i<aryKeys.length;i++){series=this.series[aryKeys[i]];viewed=new Date(parseInt(series.save_dt));inChart=this.hasSeries(aryKeys[i]);rows+='<tr><td class="mashabledata_cell_bookmark"><span class="'+(series.bookmark?"mashabledata_star":"mashabledata_nostar")+'"></span></td>'+'<td class="mashabledata_cell_check"><input type="checkbox" data="'+aryKeys[i]+'"'+(inChart?" checked><span>a"+viewed.getTime()+"</span>":"><span>b"+viewed.getTime()+"</span>")+"</td>"+'<td class="mashabledata_cell_name" title="'+series.name+'">'+series.name+"</td>"+'<td class="mashabledata_cell_units" title="'+series.units+'">'+series.units+"</td>"+'<td class="mashabledata_cell_f">'+series.period+"</td>"+'<td class="mashabledata_cell_from" >'+this.formatDateByPeriod(series.firstdt,series.period)+"</td>"+'<td class="mashabledata_cell_to">'+this.formatDateByPeriod(series.lastdt,series.period)+"</td>"+'<td class="mashabledata_cell_viewed" title="'+viewed.toLocaleString()+'">'+(viewed.toLocaleDateString()==now.toLocaleDateString()?localeHM(viewed):viewed.toLocaleDateString())+"</td>"+'<td class="mashabledata_cell_url" title="'+series.url+'">'+(series.url==window.location.href?inChart?"current chart":"current page":series.url.substr(series.url.substr(8).indexOf("/")).anchor(series.url))+"</td></tr>"}return rows;function localeHM(dt){var localeTime=dt.toLocaleTimeString(),pos=localeTime.lastIndexOf(":");return localeTime.substr(0,pos)+localeTime.substr(pos+3)}},hasSeries:function(md_key){for(var i=0;i<this.activeChart.series.length;i++){if(this.activeChart.series[i].options.md_key==md_key)return true}return false},searchTable:function(table,inputVal){var allCells,searchText,found,regExp,visibleCount=0;regExp=new RegExp(inputVal,"i");table.find("tr").each(function(index,row){searchText=row.cells[2].innerHTML+" "+row.cells[3].innerHTML;found=regExp.test(searchText);if(found==true){jQuery(row).show();visibleCount++}else jQuery(row).hide()});return visibleCount},formatDateByPeriod:function(val,period){if(isNaN(val)==false){var dt=new Date(parseInt(val));switch(period){case"A":return dt.getUTCFullYear();case"Q":return"Q"+parseInt((dt.getUTCMonth()+3)/3)+" "+dt.getUTCFullYear();case"SA":case"M":return dt.toUTCString().substr(8,8);case"W":case"D":return dt.toUTCString().substr(5,11);default:return dt.toUTCString().substr(5,20)}}else{return null}},embed:function embed(div){var $div=$(div);if($div.length==1){var graphcode=$div.attr("data");if(graphcode&&graphcode.length==32&&!/[^a-f0-9]/g.test(graphcode))MD.grapher.createMyGraph(graphcode);else $div.html("The data attribute must be a graphcode")}}};return plugin_obj}();jQuery(document).ready(function(){$("div.mashabledata_embed").each(function(){var $this=$(this);MashableData.plugin.embed($this)});if(Highcharts){var btnHeight=20;var btnsWidth=24;var btnsX=10;var btnsY=10;var currentTheme=Highcharts.setOptions({});var mashableDataHcTheme={chart:{events:{load:function(){window.MashableData.plugin.storeChartSeries(this)}}},exporting:{buttons:{contextButton:{enabled:true,menuItems:null,onclick:function(){window.MashableData.plugin.showPanel(this)},text:"tools",symbol:"gear",symbolSize:20,symbolStrokeWidth:1}}}};var highchartsOptions=Highcharts.setOptions(mashableDataHcTheme);jQuery.extend(Highcharts.Renderer.prototype.symbols,{gear:function(){var innerR=7;var outterR=9;var offset=13;var teeth=7;var i=0;var angle;gearCommands=["M",offset,offset-outterR];for(i=0;i<teeth;i++){angle=2*Math.PI/teeth*i+2*Math.PI/(teeth*4);gearCommands.push("L");gearCommands.push(Math.sin(angle)*outterR+offset);gearCommands.push(offset-Math.cos(angle)*outterR);gearCommands.push("L");gearCommands.push(Math.sin(angle)*innerR+offset);gearCommands.push(offset-Math.cos(angle)*innerR);angle=2*Math.PI/teeth*i+3*(2*Math.PI/(teeth*4));gearCommands.push("L");gearCommands.push(Math.sin(angle)*innerR+offset);gearCommands.push(offset-Math.cos(angle)*innerR);gearCommands.push("L");gearCommands.push(Math.sin(angle)*outterR+offset);gearCommands.push(offset-Math.cos(angle)*outterR)}gearCommands.push("Z");return gearCommands}})}});