var e={globals:{graphBluePrints:{},totalServerTime:0,isEmbedded:window.location.hostname.indexOf("www.mashabledata.com")===-1||window.location.pathname.indexOf("workbench")===-1,isDev:window.location.hostname.indexOf("www.mashabledata.com")!==-1&&window.location.pathname.indexOf("workbenchdev")!==-1,lang:{decimalPoint:".",thousandsSep:","},BAND_TRANSPARENCY:.5,colorsPlotBands:["aaaaaa","ffaaaa","aaffaa","aaaaff"],standardAnnotations:[],iconsHMTL:{mapset:'<span class="ui-icon ui-icon-mapset" title="series is part of a map set"></span>',pointset:'<span class="ui-icon ui-icon-pointset" title="series is part of a set of markers (defined longitude and latitude)"></span>',hasCubeViz:'<span class="ui-icon ui-icon-cube" title="map has supplemental visualizations"></span>',hasHeatMap:'<span class="ui-icon ui-icon-mapset" title="contains a heat-map"></span>',hasMarkerMap:'<span class="ui-icon ui-icon-pointset" title="contains sets of mapped markers (defined longitude and latitude)."></span>',hasBubbleMap:'<span class="ui-icon ui-icon-bubble" title="bubble map of data aggregated into user-defined regions"></span>'},themeCubes:{},panelGraphs:{},MySets:{},MyGraphs:{},MAP_COLORS:{POS:"#0071A4",NEG:"#FF0000",MID:"#E5E5E5"},DEFAULT_RADIUS_SCALE:30,DEFAULT_RADIUS_FIXED:10,hcColors:["#2f7ed8","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92","#0d233a"],primeColors:["#008000","#FF0000","#0000FF","#FFFF00","#FF9900","#00FFFF","#FF0000"],dashStyles:["Solid","Short Dash","Short Dot","Short Dash Dot","Short Dash Dot Dot","Dot","Dash","Long Dash","Dash Dot","Long Dash Dot","Long Dash Dot Dot"],period:{value:{N:1e3,D:24*3600*1e3,W:7*24*3600*1e3,M:30*24*3600*1e3,Q:365/4*24*3600*1e3,SA:365/2*24*3600*1e3,A:365*24*3600*1e3},order:["N","D","W","M","Q","SA","A"],name:{N:"non period data",D:"daily",W:"weekly",M:"monthly",Q:"quarterly",SA:"semiannual",A:"annual"},units:{N:"non-periodic data",D:"day",W:"week",M:"month",Q:"quarter",SA:"half-year",A:"year"}},op:{value:{"+":1,"-":2,"*":3,"/":4},cssClass:{"+":"op-addition","-":"op-subtraction","*":"op-multiply","/":"op-divide"}},mapBackground:"#AAAAAA",graphScriptFiles:["/global/js/highcharts/js/modules/exporting.src.js","/global/js/colorpicker/jquery.colorPicker.min.js","/global/js/colour/Colour.js","/global/js/jvectormap/jquery-jvectormap-2.0.1.min.js"],rowPosition:{name:0,units:1,source:2,notes:3,region:4,lat_lon:5,date:6,dataStart:7},patVariable:/(\b[A-Z]{1,2}\b)/g,isIE:/msie/i.test(navigator.userAgent)&&!window.opera,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],mapModes:{heat:"colored heat map of values","abs-change":"colored heat map of changes","percent-change":"colored heat map of percent changes",bubbles:"overlay circles to show values","change-bubbles":"overlay circles to show changes",correlation:"correlation (requires two maps)",treemap:"abstract values to rectangles","change-treemap":"abstract change to rectangles"}}};if(typeof console=="undefined")console={info:function(e){},log:function(e){}};e.common={numberFormat:function ma(t,a,n,i){var s=e.globals.lang,o=+t||0,r=a===-1?(o.toString().split(".")[1]||"").length:isNaN(a=Math.abs(a))?2:a,l=n===undefined?s.decimalPoint:n,c=i===undefined?s.thousandsSep:i,d=o<0?"-":"",p=String(parseInt(o=Math.abs(o).toFixed(r))),u=p.length>3?p.length%3:0;return d+(u?p.substr(0,u)+c:"")+p.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+c)+(r?l+Math.abs(o-p).toFixed(r).slice(2):"")},octet:function ga(e){e=e.toString(16);return(e.length==1?0:"")+e},mustacheRegex:/{{([^}]+)}}/g,mustache:function(e,t){rep=e.match(this.mustacheRegex);if(t){var a,n;for(a in t){n=new RegExp("{{"+a+"}}","g");e=e.replace(n,t[a])}}return e},mashableDataString:function ba(e){var t,a=[];if(typeof e.data=="string"){return e.data}else{for(t=0;t<e.data.length;t++){a.push(mashableDate(e.data[t][0],e.period)+":"+(isNaN(e.data[t][1])||e.data[t][1]===null?"null":e.data[t][1]))}return a.join("|")}},mashableDate:function va(e,t){var a=new Date(parseInt(e));var n=a.getUTCFullYear();switch(t){case"M":n+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();break;case"Q":n+="Q"+parseInt((a.getUTCMonth()+3)/3);break;case"SA":n+="H"+parseInt((a.getUTCMonth()+6)/6);break;case"W":case"D":n+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();n+=(a.getUTCDate().toString().length==1?"0":"")+a.getUTCDate();break}return n},dateFromMdDate:function ya(e){var t;t=new Date("1/1/"+e.substr(0,4)+" UTC");if(e.length>4){switch(e.substr(4,1)){case"Q":t.period="Q";t.setUTCMonth((e.substr(5,1)-1)*3);break;case"H":t.period="H";t.setUTCMonth((e.substr(5,1)-1)*6);break;default:t.period="M";t.setUTCMonth(e.substr(4,2))}if(e.length>6){t.period="D";t.setUTCDate(e.substr(6,2));if(e.length>8){t.setUTCHours(e.substr(9,2));t.setUTCMinutes(e.substr(12,2));t.setUTCSeconds(e.substr(15,2))}}}return t},dateConversionData:function wa(t){var a=t.sourcekey,n=false,i=false,s=e.globals.period;if(t.firstdt)n=new Date(parseInt(t.firstdt));if(t.lastdt)i=new Date(parseInt(t.lastdt));var o=[],r;var l=24*60*60*1e3;var c=new Date;var d=this.mashableDate;switch(a.toUpperCase()){case"DAYSPERMONTH":if(i){i=new Date(i.getUTCFullYear()+"-"+(i.getUTCMonth()+1)+"-01 UTC")}else{i=new Date(c.getUTCFullYear()+"-12-01 UTC")}if(n&&n<i){n=new Date(n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-01 UTC")}else{n=new Date(i.getTime());n.setUTCMonth(n.getUTCMonth()-119)}while(n<=i){o.push(d(n.getTime(),"M")+":"+Math.round(Math.abs(n.getTime()-n.setUTCMonth(n.getUTCMonth()+1))/l))}break;case"DAYSPERQUARTER":if(i){i=new Date(i.getUTCFullYear()+"-"+(i.getUTCMonth()+3)+"-01 UTC")}else{i=new Date(c.getUTCFullYear()+"-12-01 UTC")}if(n&&n<i){n=new Date(n.getUTCFullYear()+"-"+(n.getUTCMonth()+3)+"-01 UTC")}else{n=new Date(i.getTime());n.setUTCMonth(n.getUTCMonth()-119)}while(n<=i){o.push(d(n.getTime(),"Q")+":"+Math.round(Math.abs(n.getTime()-n.setUTCMonth(n.getUTCMonth()+3))/l))}break;case"DAYSPERYEAR":if(i){i=new Date(i.getUTCFullYear()+"-01-01 UTC")}else{i=new Date(c.getUTCFullYear()+"-01-01 UTC")}if(n&&n<i){n=new Date(n.getUTCFullYear()+"-01-01 UTC")}else{n=new Date(i.getUTCFullYear()-20+"-01-01 UTC")}while(n<=i){o.push(d(n.getTime(),"A")+":"+Math.round(Math.abs(n.getTime()-n.setUTCFullYear(n.getUTCFullYear()+1))/s.value.D))}break}t.data=o;return o},selectDownshift:function ka(e,t,a,n){var i,s;var o='<div id="downshiftWizard" style="width:600px;">'+"<h4>Frequency Shifting:</h4>";if(t)o+="You have selected to have the plot recalculated as <b></b>"+period.name[t]+"</b>.  Please select the method and treatment of missing and null values.<br>";else o+="You have requested to mash series with different frequencies.  This will require first recalculating the series data having a shorter reporting period to a common longer period.  Please confirm by selecting the algorithm and the treatment of missing and null values.<br>";o+="<br>Component series that must be recalculated:"+"<ol>";a.eachComponent(function(){o+="<li><b>"+this.name()+"</b> ("+this.units+") "+l.period.name[t=="A"&&(this.freqset.indexOf(Q)==-1?"Q":"M")]+"</li>"});o+="</ol>"+"<br>Each component series will be individual recalculated as needed to the new frequency by:<br>"+'<label><input type="radio" name="dsw_algor" value="sum"> simple summation</label><br>'+'<label><input type="radio" name="dsw_algor" value="wavg"> day-weighted average</label><br>'+"<br>If some of the values used to calculate a new datum point are are null or missing (e.g. a month is missing when calulating an annual value):<br>"+'<label><input type="radio" name="dsw_missing" value="null"> the computed value for the datum will be null (i.e. all sub-values are required)</label><br>'+'<label><input type="radio" name="dsw_missing" value="zero"> treat as if the value were zero</label><br>'+'<label><input type="radio" name="dsw_missing" value="impute"> estimate value to be the day-weighted average of new period\'s existing component values if at least three-quarters of the component values exist</label><br>'+'<span class="ui-state-error warning-box"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span>WARNING: Change frequencies and use estimates with care.  Summations produce valid results for monthly production quantities, whereas day-weighted averages are statistically correct for rates where the implied denominator is constant.<br><br>For more information, see <a href="/workbench-help/changing-frequency/" traget="_blank" class="link">changing frequencies help</a>.</span>'+'<button id="dsw_ok" class="right">OK</button> <button id="dsw_cancel" class="right">cancel</button>'+"</div>";$.fancybox(o,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var r=$("#downshiftWizard");$("#dsw_ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e={algorithm:r.find("input:radio[name='dsw_algor']:checked").val(),missing:r.find("input:radio[name='dsw_missing']:checked").val()};if(e.algorithm&&e.missing){n(e);$.fancybox.close()}else{vt("error","All form selections are required.")}});$("#dsw_cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close();n(false)})},downShiftData:function xa(t,a,n,i){var s=e.globals.period;if(s.value[a]==s.value[t.period])return t.data;if(s.value[a]<s.value[t.period]||a!="A"&&a!="Q"||s.value[t.period]<s.value["M"])throw"unable to change data frequency from "+s.name[t.period]+" to "+s.name[a];var o=t.data.split("|"),r=[],l=[],c=a=="Q"?3:12,d=t.period=="M"?1:3,p=false,u,h,f;for(var m=0;m<o.length;m++){h=o[m].split(":");f=this.dateFromMdDate(h[0]);if(p===false||f.getUTCMonth()-p.getUTCMonth()>c-1||f.getUTCFullYear()!=p.getUTCFullYear()){if(l.length!=0){r.push(g());l=[]}p=new Date(f.getUTCFullYear()+"-"+(Math.floor(f.getUTCMonth()/c)*c+1)+"-1 UTC")}l[f.getUTCMonth()]=h[1]}if(l.length!=0)r.push(g());return r;function g(){var t,o=0,r=0,h=0,f=0;u=e.common.mashableDate(p.getTime(),a);var m=p.getUTCMonth();for(var g=m;g<m+c;g=g+d){t=-Math.round(p.getTime()-p.setUTCMonth(p.getUTCMonth()+d)/s.value.D);if(typeof l[g]=="undefined"||l[g]===null){if(i=="null"){return u+"|null"}l[g]=0;if(i=="impute"){h++;r+=t;o-=t}}switch(n){case"wavg":f+=parseFloat(l[g])*t;o+=t;break;case"sum":f+=parseFloat(l[g]);break;default:throw"unrecognized down frequency conversion algorithm"}}if(r!=0&&f!="null")f=f*(o+r)/o;return u+":"+(n=="wavg"?f/o:f)}},rationalize:function Sa(e){if(Math.log(Math.abs(e))>-13)return Math.round(e*Math.pow(10,10))/Math.pow(10,10);else return e},equivalentRGBA:function Ma(e,t){var a,n,i;if(e.substr(0,1)=="#")e=e.substr(1);a=s(parseInt(e.substr(0,2),16),t);n=s(parseInt(e.substr(2,2),16),t);i=s(parseInt(e.substr(4,2),16),t);if(a>0&&n>0&&i>0){return"rgba("+a+","+n+","+i+","+t+")"}else{return"rgb("+parseInt(e.substr(0,2),16)+","+parseInt(e.substr(2,2),16)+","+parseInt(e.substr(4,2),16)+")"}function s(e,t){return parseInt(e/t-(1-t)*255/t)}},addBreaks:function Ca(e,t){var a=e.slice(0);a.sort(function(e,t){return e[0]-t[0]});var n=[];if(a.length>0)n.push([a[0][0],a[0][1]]);var i;switch(t){case"T":case"N":case"D":case"W":maxInterval=Date.UTC(2e3,0,9)-Date.UTC(2e3,0,1);break;case"M":maxInterval=Date.UTC(2e3,1,2)-Date.UTC(2e3,0,1);break;case"SA":maxInterval=Date.UTC(2e3,7,2)-Date.UTC(2e3,0,1);break;default:maxInterval=Date.UTC(2001,2)-Date.UTC(2e3,1)}for(var s=1;s<a.length;s++){if(a[s-1][1]!=null&&a[s][1]!=null&&a[s][0]-a[s-1][0]>maxInterval){var o=new Date(a[s][0]);switch(t){case"d":case"w":o.setDate(o.getDate()+7);break;case"4":o.setDate(o.getDate()+28);break;case"m":o.setMonth(o.getMonth()+1);break;default:o.setMonth(o.getMonth()+12)}a.splice(s,0,[parseInt(o),null]);s++}}return a},callApi:function _a(t,a){var n,i=e.globals.isEmbedded,o=new Date;if(i){n=$.extend({uid:false,host:window.location.host},t)}else{n=$.extend({uid:Ft(),version:workbenchVersion,accessToken:account.info.accessToken},t)}if(!i&&t.modal!="none")Qt();$.ajax({type:i?"GET":"POST",url:i?"//www.mashabledata.com/graph_data":"api.php",encoding:"UTF-8",cache:false,data:n,dataType:"json",success:function(n,r,l){if(e.globals.isDev)console.info(n);if(n.status=="ok"){if(!i){s.totalServerTime+=parseFloat(n.exec_time);if(n.msg)vt("",n.msg);var c=new Date;console.info(t.command+": "+n.exec_time+" (total server time: "+s.totalServerTime+"ms); roundtrip: "+(c.getTime()-o.getTime())+"ms; "+JSON.stringify(n).length/1e3+"kb")}if(a)a(n,r,l);if(t.modal!="persist"&&!i)Zt()}else{if(i){return n.status}else{Zt();vt("Connected to server, but the command failed.",n.status+'<br><br>If this is a system error and continues to occur, please email <a href="mailto:support@mashabledata.com">support@mashabledata.com</a>.')}}},error:function(e,t,a){console.log(t);console.log(e);if(i){return"A system error occurred while trying to connect to the MashableData servers.  Please try again later"}else{Zt();vt(t,"A system error occurred while trying to connect to the server.  Check your internet connectivity and try again later.")}}})},setFactory:function(t){var a=[];for(var n=0;n<t.length;n++){a.push(new e.Set(t[n]))}return a},placeName:function(e,t){var a=e.split(" "),n;var i=" "+t+" ";for(var s=0;s<a.length;s++){if(a[s].length){while(-1!=(n=i.indexOf(" "+a[s]+" "))){i=i.substr(0,n)+i.substr(n+a[s].length+1)}}}return i.trim()}};e.Set=function(t){if(Object.prototype.toString.call(t)=="[object String]"){var a,n=0,i=t;this.type=i[n++];this.setid=parseInt(i.substring(n));n+=this.setid.toString().length;if(i.length>n){a=i[n++];if(e.globals.period.name[a]){this.freq=a;if(i.length>n)a=i[n++];else a=""}if(a=="G"){this.geoid=parseInt(i.substring(n));if(i.length>n)a=i[n++];else a=""}if(a=="L"){this.latlon=i.substring(n)}}}else{for(var s in t){if(t.hasOwnProperty(s)){this[s]=t[s]}}}if(this.maps&&typeof this.maps=="string")this.maps=JSON.parse("{"+this.maps+"}");this.parsedData();if(this.freqs&&!Array.isArray(this.freqs))this.freqs=this.freqs.split(",");return this};(function(){var t=e,a=t.globals,n=t.grapher,i=t.Set,s=t.Graph;e.Set.prototype.parsedData=function(e){if(e)this.data=e;if(this.data){if(this.isSeries()){if(typeof this.data=="string")this.data=this.data.split("|")}else{for(var t in this.data){if(typeof this.data[t]=="string"){this.data[t]=this.data[t].split("|")}else break}}return this.data}else{return false}};e.Set.prototype.chartData=function(e){var t,a=this.parsedData(e);for(var n=0;n<a.length;n++){t=a[n].split(":");a[n]=[Date.parse(l.dateFromMdDate(t[0])),t[1]==="null"||t[1]===null?null:parseFloat(t[1])]}return a};e.Set.prototype.fetchData=function(t,a){var n=this;if(t){if(t.f){this.f=e.globals.periodPref=t.f}if(t.mapFilter&&t.mapFilter!="all")this.options.mapFilter=t.mapFilter;if(typeof t.geoid!="undefined"){this.geoid=t.geoid;delete this.options.mapFilter}if(t.map){}else{var i=this.handle();var s={command:"GetMashableData",handles:{}};s.handles[i]={setid:this.setid,freq:this.preferedFreq()};if(this.geoid)s.handles[i].geoid=this.geoid;if(this.latLon)s.handles[i].latlon=this.latlon;if(this.options.mapFilter)s.handles[i].mapFilter=this.options.mapFilter;M(s,function(e,t,s){n.parsedData(e.series[i].data);n.freq=n.preferedFreq();n.notes=e.series[i].notes;n.geocounts=e.series[i].geocounts;a()})}}};e.Set.prototype.preferedFreq=function(){if(this.freq)return this.freq;if(e.globals.periodPref&&this.freqs.indexOf(e.globals.periodPref)!==-1)return e.globals.periodPref;if(this.freqs.indexOf("M")!==-1)return"M";if(this.freqs.indexOf("A")!==-1)return"A";if(this.freqs.indexOf("Q")!==-1)return"Q";if(this.freqs.indexOf("H")!==-1)return"H";return this.freqs[0]};e.Set.prototype.name=function(){if(!this.isSeries()){return this.setname}else{if(this.seriesname)return this.seriesname}var e=this.setname,t="&hellip;",a;if(this.geoname){a=e.indexOf(t);if(a>=0){e.replace(t,this.geoname)}else e+=": "+this.geoname}return e};e.Set.prototype.handle=function(){var e=this.settype+this.setid+this.preferedFreq();if(this.geoid)e+="G"+this.geoid;if(this.latlon)e+="L"+this.latlon;return e};e.Set.prototype.clone=function(){var t=this;var a=new e.Set(t);return a};e.Set.prototype.isSeries=function(){return this.freq&&(this.geoid||this.latlon)?true:false};e.Set.prototype.isMapSet=function(){return this.freq&&(!this.geoid&&!this.latlon)&&this.settype=="M"?true:false};e.Set.prototype.isPointSet=function(){return this.freq&&!this.latlon&&this.settype=="X"?true:false};e.Set.prototype.mapList=function(){if(this.maps){var e,t=[],n=this.settype=="X"?0:1;for(e in this.maps){if(this.maps[e]>n&&a.maps[e])t.push(a.maps[e].name)}return t.join("; ")}else return""}})();e.Component=function(t,a){e.Set.call(this,t);this.options=$.extend({k:1,op:"+"},a||{});return this};e.Component.prototype=Object.create(e.Set.prototype);e.Component.prototype.clone=function(){var t=this;var a=new e.Component(t,t.options);return a};e.Plot=function(e,t){this.components=e||[];this.options=t||{};return this};(function(){var t=e,a=t.common,n=t.globals,i=t.grapher,s=t.Plot;s.prototype.removeCompnent=function(e,t){this.components=e||[];this.options=t||{};return this};s.prototype.name=function(e){var t,a,n,i="";if(typeof e!="undefined"&&e!==false){if(e&&e.trim()){this.options.name=e}else{delete this.options.name}}if(this.options.name&&e!==false){return this.options.name}else{var s=false;for(n=0;n<this.components.length;n++){a=this.components[n];t=a.handle();i+=(n!=0&&a.options.op?a.options.dn=="d"&&!s?" / ":" "+a.options.op+" ":" ")+a.name();s=a.options.dn=="d"||s}return i}};s.prototype.freq=function(){return this.options.fdown||this.components[0].freq};s.prototype.units=function o(e,t){var a,n,i,s="",o="",r=this.graph,l=this;if(l.components.length==1){return l.options.units||(l.components[0].options.op=="/"?"per ":"")+l.components[0].units||""}if(!l.options.units||e){if(!t)t=l.calculateFormula();var c=t.numFormula;var d=t.denomFormula;y("^(-)?(1)?","");var p=/[0-9]+/g;var u=p.test(c)||p.test(d);c=c.replace(p," ");d=d.replace(p," ");var h=/(\*|\(|\))/g;c=c.replace(h," ");d=d.replace(h," ");var f=/\//g;c=c.replace(f," per ");d=d.replace(f," per ");var m=/-/g;c=c.replace(m,"+");d=d.replace(m,"+");var g=/[\s]+/g;c=c.replace(g," ");d=d.replace(g," ");y("([A-Z]+)","{{$1}}");var b=/\+/g;for(a=0;a<l.components.length;a++){y("{{"+this.compSymbol(a)+"}}",(l.components[a].units||"").replace(b," "))}var v=false;if(c!=""){i=c.split("+");c=i[0].trim();for(n=1;n<i.length;n++){if(i[n].trim()!=c)v=true}}if(d!=""){i=d.split("+");o=i[0].trim();for(n=1;n<i.length;n++){if(i[n].trim()!=i[0])v=true}}if(v){return"potentially mismatched units"}else{if(c==o&&c.length>0){return"ratio"}else{return(u?"user scaled ":"")+c+(o==""?"":" per "+o)}}}else{return l.options.units}function y(e,t){var a=new RegExp(e,"g");c=c.replace(a,t);o=o.replace(a,t)}};s.prototype.calculateFormula=function r(){var e,t,a=false,n=false,i="",s="",o="",r="";var l=/[+-/*]+/;for(var c=0;c<this.components.length;c++){e=this.components[c];t=this.compSymbol(c);if(!a&&e.options.dn&&e.options.dn=="d"){if(n){n=false;if(l.test(o))o="("+o+")";r+=o}i=r;r="";a=true}if(r.length==0){switch(e.options.op){case"/":n=true;o=d();r="1/";break;case"-":r="-"+d();break;case"+":case"*":default:r=d()}}else{switch(e.options.op){case"+":case"-":if(n){n=false;if(l.test(o))o="("+o+")";r+=o+" "+e.options.op+" "+d()}else{r+=" "+e.options.op+" "+d()}break;case"*":if(n){o+="*"+d()}else{r+="*"+d()}break;case"/":if(n){o+="*"+d()}else{n=true;r+="/";o=d()}}}}if(n){n=false;if(l.test(o))o="("+o+")";r+=o}if(a){s=r}else{i=r}if((this.options.k||1)==1){if(a){r=(i==""?1:l.test(i)?"("+i+")":i)+" / "+(l.test(s)?"("+s+")":s)}else{r=i}}else{if(a){r=this.options.k+" * "+(i=""?"":l.test(i)?"("+i+")":i)+" / "+(l.test(s)?"("+s+")":s)}else{r=this.options.k+" * "+(l.test(i)?"("+i+")":i)}}this.calculatedFormula={formula:r,denomFormula:s,numFormula:i,k:this.options.k||1};return this.calculatedFormula;function d(){return isNaN(e.options.k)||e.options.k==1?t:e.options.k+"*"+t}};s.prototype.formula=function l(){if(this.options.userFormula)return this.options.userFormula;if(!this.calculatedFormula)this.calculateFormula();return this.calculatedFormula.formula};s.prototype.createHighSeries=function(){console.time("createHighSeries");var e,t,i,s,o,r,l,c=[],d,p={};var u=this,h=u.components;o={name:u.name(),units:u.units()};h=u.components;o.freq=u.options.fdown||h[0].freq;var f=u.formula();var m="return "+f.replace(n.patVariable,"values.$1")+";";var g=new Function("values",m);var b=[],v;for(i=0;i<h.length;i++){v=u.compSymbol(i);b.push(v);if(u.options.fdown&&u.options.fdown!=h[i].freq){r=a.downShiftData(h[i],u.options.fdown,u.options.algorithm,u.options.missing)}else{r=h[i].parsedData()}for(s=0;s<r.length;s++){l=r[s].split(":");if(!p[l[0].toString()]){p[l[0].toString()]={}}p[l[0].toString()][v]=l[1]}}var y=!u.options.componentData||u.options.componentData=="required";var w=u.options.componentData=="missingAsZero";var k=u.options.componentData=="nullsMissingAsZero";var x=!u.options.breaks||u.options.breaks=="never";var S=u.options.breaks=="nulls";var M=u.options.breaks=="missing";for(d in p){e={};t=true;for(i=0;i<b.length;i++){if(!isNaN(p[d][b[i]])){e[b[i]]=parseFloat(p[d][b[i]])}else{if(p[d][b[i]]=="null"){if(k){e[b[i]]=0}else{t=null;break}}else{if(y){t=null;break}else{e[b[i]]=0}}}}if(t){try{t=g(e);if(Math.abs(t)==Infinity||isNaN(t))t=null}catch(C){t=null}}if(t!==null||!x){if(t!==null)t=a.rationalize(t);c.push([Date.parse(a.dateFromMdDate(d)),t])}}c.sort(function(e,t){return e[0]-t[0]});if(M){c=a.addBreaks(c,o.freq)}o.data=c;console.timeEnd("createHighSeries");return o};s.prototype.compSymbol=function c(e){var t="";if(e>25){t=String.fromCharCode("A".charCodeAt(0)+parseInt(e/26))}t+=String.fromCharCode("A".charCodeAt(0)+e%26);return t};s.prototype.type=function(){var e="S";this.eachComponent(function(){if(this.isPointSet())e="X";if(this.isMapSet())e="M"});return e};s.prototype.mapMode=function(){if(!this.type()=="M"||!this.graph){return false}else{return this.options.mapMode||this.graph.mapconfig.mapMode||"heat"}};s.prototype.clone=function(e){var t=this,a=[];t.eachComponent(function(){a.push(this.clone())});var n=new s(a,$.extend({},t.options));return n};s.prototype.eachComponent=function(e){var t=this;$.each(t.components,function(a){e.call(this,a,t)})};s.prototype.validateUserFormula=function(e){}})();e.Graph=function(t){t=t||{};this.annotations=t.annotations||[];this.title=t.title||"";this.type=t.type||"auto";this.map=t.map||"";this.assets=t.assets||{};this.gid=t.gid||null;this.ghash=t.ghash||null;this.analysis=t.analysis||null;this.mapconfig=t.mapconfig||{};this.start=t.start||null;this.end=t.end||null;this.published=t.published||"N";this.userid=parseInt(t.userid)||null;if(typeof this.annotations=="string")this.annotations=l(this.annotations,[]);if(typeof this.mapconfig=="string")this.mapconfig=l(this.mapconfig,{});if(t.allplots){var a,n,i,s,o,r;for(a=0;a<t.allplots.length;a++){s=t.allplots[a];r=[];for(n=0;n<s.components.length;n++){i=s.components[n];o=i.settype+i.setid+i.freq+(i.geoid?"G"+i.geoid:"")+(i.latlon?"L"+i.latlon:"");if(t.assets&&t.assets[o]){r.push(new e.Component(t.assets[o],l(i.options,{})))}else return false}this.addPlot(new e.Plot(r,l(s.options,{})))}this.assets=t.assets}return this;function l(e,t){try{return $.parseJSON(e.replace(/u0022/g,'"'))}catch(a){return t}}};(function(){var t=e,a=t.Graph,n=t.globals,i=t.common;a.prototype.addPlot=function(t,a){if(Array.isArray(t)){var n=new e.Plot(t,a)}else{n=t}n.graph=this;switch(n.type()){case"M":if(!this.mapsets)this.mapsets=[];this.mapsets.push(n);break;case"X":if(!this.pointsets)this.pointsets=[];this.pointsets.push(n);break;case"S":if(!this.plots)this.plots=[];this.plots.push(n);break}return n};a.prototype.addMapPlot=function(t,a){var n=new e.Plot(t,a);n.graph=this;if(this.mapsets)this.mapsets.push(n);else this.mapsets=[n];return n};a.prototype.addPointPlot=function(t,a){var n=new e.Plot(t,a);n.graph=this;if(this.pointsets)this.pointsets.push(n);else this.pointsets=[n];return n};a.prototype.clone=function(){var e=this,t=new a;t.map=e.map;t.start=e.start;t.end=e.end;t.mapconfig=$.extend(true,{},e.mapconfig);t.title=e.title;t.type=e.type;t.cubeid=e.cubeid;t.intervals=e.intervals;t.analysis=e.analysis;t.annotations=$.extend(true,{},{a:e.annotations}).a;e.eachPlot(function(){t.addPlot(this.clone())});return t};a.prototype.destroy=function(){};a.prototype.draw=function(){};a.prototype.redraw=function(){};a.prototype.undraw=function(){};a.prototype.fetchAssets=function(e){var t={series:[],mapSets:[],pointSets:[]},a=[];var s,o,r,l,c=this;this.eachComponent(function(e,i){var s=this;if(!s.data){l=s.handle();if((!c.assets[l]||!c.assets[l].data)&&a.indexOf(l)==-1){if(n.MySets&&n.MySets[l]&&n.MySets[l].data){c.assets[l]=n.MySets[l].clone()}else{if(s.isSeries())t.series.push({setid:s.setid,freq:s.freq,geoid:s.geoid,latlon:s.latlon});if(s.isMapSet())t.mapSets.push({setid:s.setid,freq:s.freq});if(s.isPointSet())t.pointSets.push({setid:s.setid,freq:s.freq});a.push(l)}}}});if(t.series.length+t.mapSets.length+t.pointSets.length>0){var d={command:"GetSets",map:c.map,modal:"persist"};$.extend(true,d,t);i.callApi(d,function(t,a,n){for(l in t.assets)c.assets[l]=t.assets[l];e()})}else e()};a.prototype.fetchMap=function(e){var t=this;if(t.map){if(!t.mapFile)t.mapFile=n.maps[t.map].redef?t.map:n.maps[t.map].jvectormap;var a=["/global/js/maps/"+t.mapFile+".js"];if(!jvm.Map.maps[t.mapFile]){require(a,function(){if(n.maps[t.map].redef)i.makeMap(t.map);if(e)e()})}else if(e)e()}else if(e)e()};a.prototype.changeMap=function(e,t){if(this.map&&this.map!=e){var a=this,s;var o=n.maps[a.map];var r=n.maps[e];delete a.mapFile;a.map=e;a.fetchMap();var l={};a.eachComponent(function(){s=this;var e=s.handle();if(s.isSeries()){if(this.geoid==o.bunny&&r.bunny!=o.bunny&&!this.latlon){l.series=l.series||{};l.series[e]={setid:this.setid,freq:this.freq,geoid:r.bunny};delete s.data;delete a.assets[e]}}else{if(s.isMapSet()){l.mapSets=l.mapSets||{};l.mapSets[e]={setid:this.setid,freq:this.freq}}if(s.isPointSet()){l.pointSets=l.pointSets||{};l.pointSets[e]={setid:this.setid,freq:this.freq}}delete a.assets[s.handle];delete s.data;delete s.mappedTo}});i.callApi({command:"ChangeMaps",map:e,sets:l,fromgeoid:o.bunny,togeoid:r.bunny,modal:"persist"},function(n,i,s){var o=new RegExp(n.regex);if(n.replacement){if(a.title)a.title=a.title.replace(o,n.replacement);if(a.analysis)a.analysis=a.analysis.replace(o,n.replacement)}a.eachPlot(function(){if(this.options.name)this.options.name=this.options.name.replace(o,n.replacement);if(n.bunnies){this.eachComponent(function(){var e=this.handle();if(n.bunnies[e]){this.parseData(n.bunnies[e].data);this.geoname=n.replacement;this.geoid=n.bunnies[e].geoid}delete a.assets[e]})}});for(var l in n.assets){a.assets[l]=n.assets[l];a.assets[l].mappedTo=e}this.map=r;t()})}};a.prototype.save=function s(e){var t=this,a=[],n=(new Date).getTime(),i=[],s;this.eachComponent(function(){a.push(this.name())});this.eachPlot(function(){s={type:this.type(),options:$.stringify(this.options),components:[]};this.eachComponent(function(){s.components.push({setid:this.setid,freq:this.freq,geoid:this.geoid,latlon:this.latlon,options:$.stringify(this.options)})});i.push(s)});var o={gid:this.gid,command:"ManageMyGraphs",serieslist:a.join("; "),end:this.end,start:this.start,annotations:r(t),map:this.map,mapconfig:$.stringify(this.mapconfig),modifieddt:n,intervals:this.intervals,cubeid:this.cubeid,type:this.type,title:this.title,analysis:this.analysis,published:this.published||"N",allplots:i};M(o,function(a,n,i){t.gid=a.gid;t.ghash=a.ghash;t.isDirty=false;var s=[],o,r=$.extend({from:"",to:"",plottypes:"",serieslist:[]},t);r.updatedt=(new Date).getTime();t.eachPlot(function(){r.plottypes+=this.type();this.eachComponent(function(){o=this.name();if(s.indexOf(o)==-1)s.push(o)})});r.serieslist=s.join("; ");if("G"+t.gid in f){var l;l=$(N).find("span.handle[data=G"+t.gid+"]").closest("tr").get(0);N.fnUpdate(r,l)}else{N.fnAddData(r)}f["G"+t.gid]=r;u[k()]=t;if(e)e()});function r(e){var t="[";for(var a=0;a<e.annotations.length;a++){t+='{"type":"'+e.annotations[a].type+'",';if(e.annotations[a].type=="point")t+='"series":"'+e.annotations[a].series+'",';if(e.annotations[a].type.substring(0,1)=="h")t+='"yAxis":"'+e.annotations[a].yAxis+'",';t+='"color":"'+e.annotations[a].color+'",';t+='"from":"'+e.annotations[a].from+'",';if(e.annotations[a].type.indexOf("band")>-1)t+='"to":"'+e.annotations[a].to+'",';t+='"text":"'+e.annotations[a].text+'"}';if(a<e.annotations.length-1)t+=","}return t+"]"}};a.prototype.saveAs=function(e,t){if(typeof e!="undefined")this.name=e.trim();delete this.gid;delete this.ghash;this.save(t)};a.prototype.deleteGraph=function(e){if(this.userid==account.info.userId){i.callApi({command:"DeleteMyGraphs",gids:[this.gid]},e)}else e(false)};a.prototype.resetHash=function(e){M({command:"ResetGhash",gid:oGraph.gid},function(t,a,n){this.ghash=t.ghash;e()})};a.prototype.eachPlot=function o(e){var t=this;if(t.mapsets)$.each(t.mapsets,function(a){e.call(this,a,t,t.mapsets)});if(t.pointsets)$.each(t.pointsets,function(a){e.call(this,a,t,t.pointsets)});if(t.plots)$.each(t.plots,function(a){e.call(this,a,t,t.plots)})};a.prototype.eachComponent=function r(e){var t=this;t.eachPlot(function(){var t=this;t.eachComponent(e)})};a.prototype.mapFreq=function(){var e=false,t;this.eachPlot(function(){if(this.type()!="S"){t=this.freq();if(e&&e!=t)return"error";e=t}});return e};a.prototype.hasMapViz=function l(){if(!this.mapsets||!this.cubeid&&!this.mapconfig.mapViz)return false;if(this.cubeid)return true;switch(this.mapconfig.mapViz){case"scatter":return this.mapsets.length==2;case"line":return true;case"line-bunnies":return true;case"components-bar":case"components-line":return true;case"list-asc":case"list-desc":return true;default:return false}};a.prototype.isSummationMap=function c(){if(!this.mapsets)return false;for(var e=0;e<this.mapsets.length;e++){if(!this.mapsets[e].calculatedFormula)this.mapsets[e].calculateFormula();var t=this.mapsets[e].calculatedFormula;if(!/[-+]/.test(t.numFormula)||/[*/]/.test(t.numFormula))return false;this.mapsets[e].eachComponent(function(){if(!this.isMapSet())return false})}return true}})();(function Da(){var t=[{map:"none",name:"no map filter",level:0},{map:"world",name:"world",geographycount:"172",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:0},{map:"wb_incomes",name:"World Bank income levels",geographycount:"11",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:1,redef:{regions:[{name:"High income: nonOECD",code:"NOC",components:["AD","AG","AW","BH","BB","BM","BN","KY","","HR","CW","CY","GQ","FO","PF","GL","GU","HK","IM","KW","LV","LI","LT","MO","MT","MC","NC","MP","OM","PR","QA","RU","SM","SA","SG","SX","KN","MF","BS","TT","TC","AE","UY","VI"]},{name:"High income: OECD",code:"OEC",components:["AU","AT","BE","CA","CL","CZ","DK","EE","FI","FR","DE","GR","IS","IE","IL","IT","JP","KR","LU","NL","NZ","NO","PL","PT","SK","SI","ES","SE","CH","GB","US"]},{name:"Low income",code:"LIC",components:["AF","BD","BJ","BF","BI","KH","CF","TD","KM","KP","CD","ER","ET","GN","GW","HT","KE","LR","MG","MW","ML","MZ","MM","NP","NE","RW","SL","SO","TJ","TZ","GM","TG","UG","ZW"]},{name:"Lower middle income",code:"LMC",components:["AM","BT","BO","CV","CM","CG","CI","DJ","EG","SV","GE","GH","GT","GY","HN","IN","ID","KI","","KG","LA","LS","MR","FM","MD","MN","MA","NI","NG","PK","PG","PY","PH","WS","ST","SN","SB","SS","LK","SD","SZ","SY","TL","UA","UZ","VU","VN","PS","YE","ZM"]},{name:"Upper middle income",code:"UMC",components:["AL","DZ","AS","AO","AR","AZ","BY","BZ","BA","BW","BR","BG","CN","CO","CR","CU","DM","DO","EC","FJ","GA","GD","HU","IR","IQ","JM","JO","KZ","LB","LY","MK","MY","MV","MH","MU","MX","ME","NA","PW","PA","PE","RO","RS","SC","ZA","LC","VC","SR","TH","TO","TN","TR","TM","TV","VE"]}]}},{map:"wb_regions",name:"World Bank regions",geographycount:"13",bunny:"321",jvectormap:"world_mill_en",legend:"BL",level:1,redef:{regions:[{name:"East Asia & Pacific",code:"EAS",components:["BN","PF","GU","HK","MO","NC","MP","SG","AU","JP","KR","NZ","KH","KP","MM","ID","KI","LA","FM","MN","PG","PH","WS","SB","TL","VU","VN","AS","CN","FJ","MY","MH","PW","TH","TO","TV"]},{name:"Europe & Central Asia",code:"ECS",components:["AD","","HR","CY","FO","GL","IM","LV","LI","LT","MC","RU","SM","AT","BE","CZ","DK","EE","FI","FR","DE","GR","IS","IE","IT","LU","NL","NO","PL","PT","SK","SI","ES","SE","CH","GB","TJ","AM","GE","","KG","MD","UA","UZ","AL","AZ","BY","BA","BG","HU","KZ","MK","ME","RO","RS","TR","TM"]},{name:"Latin America & Caribbean",code:"LCN",components:["AG","AW","BB","KY","CW","PR","SX","KN","MF","BS","TT","TC","UY","VI","CL","HT","BO","SV","GT","GY","HN","NI","PY","AR","BZ","BR","CO","CR","CU","DM","DO","EC","GD","JM","MX","PA","PE","LC","VC","SR","VE"]},{name:"Middle East & North Africa",code:"MEA",components:["BH","KW","MT","OM","QA","SA","AE","IL","DJ","EG","MA","SY","PS","YE","DZ","IR","IQ","JO","LB","LY","TN"]},{name:"North America",code:"NAC",components:["BM","CA","US"]},{name:"South Asia",code:"SAS",components:["AF","BD","NP","BT","IN","PK","LK","MV"]},{name:"Sub-Saharan Africa",code:"SSA",components:["GQ","BJ","BF","BI","CF","TD","KM","CD","ER","ET","GN","GW","KE","LR","MG","MW","ML","MZ","NE","RW","SL","SO","TZ","GM","TG","UG","ZW","CV","CM","CG","CI","GH","LS","MR","NG","ST","SN","SS","SD","SZ","ZM","AO","BW","GA","MU","NA","SC","ZA"]}]}},{map:"africa",name:"Africa",geographycount:"57",bunny:"3837",jvectormap:"africa_mill_en",legend:"BL",level:0},{map:"europe_nafrica",name:"Europe and North Africa",geographycount:"53",bunny:null,jvectormap:"europe_nafrica_mill_en",legend:"BL",level:0},{map:"europe",name:"Europe",geographycount:"41",bunny:"3841",jvectormap:"europe_mill_en",legend:"BL",level:0},{map:"eu28",name:"European Union - countries",geographycount:"28",bunny:"307",jvectormap:"eu_mill_en",legend:"BL",level:0},{map:"eu_nuts1",name:"European Union - NUTS1 regions",geographycount:"104",bunny:"307",jvectormap:"eu_nuts1_mill_en",legend:"BL",level:1},{map:"eu_nuts2",name:"European Union - NUTS2 regions",geographycount:"289",bunny:"307",jvectormap:"eu_nuts2_mill_en",legend:"BL",level:1},{map:"eu_nuts3",name:"European Union - NUTS3 regions",geographycount:"1373",bunny:"307",jvectormap:"eu_nuts3_mill_en",legend:"BL",level:1},{map:"at_nuts2",name:"Austria/Österreich NUTS2 regions",geographycount:"9",bunny:"16",jvectormap:"at_nuts2_mill_en",legend:"BR",level:2},{map:"at_nuts3",name:"Austria/Österreich NUTS3 regions",geographycount:"35",bunny:"16",jvectormap:"at_nuts3_mill_en",legend:"BR",level:2},{map:"be_nuts2",name:"Belgium/Belgique-België NUTS2 regions",geographycount:"11",bunny:"19",jvectormap:"be_nuts2_mill_en",legend:"BR",level:2},{map:"be_nuts3",name:"Belgium/Belgique-België NUTS3 regions",geographycount:"44",bunny:"19",jvectormap:"be_nuts3_mill_en",legend:"BR",level:2},{map:"bg_nuts2",name:"Bulgaria NUTS2 regions",geographycount:"6",bunny:"24",jvectormap:"bg_nuts2_mill_en",legend:"BR",level:2},{map:"bg_nuts3",name:"Bulgaria NUTS3 regions",geographycount:"28",bunny:"24",jvectormap:"bg_nuts3_mill_en",legend:"BR",level:2},{map:"ch_nuts2",name:"Switzerland/Suisse-Schweiz NUTS2 regions",geographycount:"7",bunny:"42",jvectormap:"ch_nuts2_mill_en",legend:"BR",level:2},{map:"ch_nuts3",name:"Switzerland/Suisse/Schweiz NUTS3 regions",geographycount:"26",bunny:"42",jvectormap:"ch_nuts3_mill_en",legend:"BR",level:2},{map:"cz_nuts2",name:"Czech/?eská Republika NUTS2 regions",geographycount:"8",bunny:"59",jvectormap:"cz_nuts2_mill_en",legend:"BR",level:2},{map:"cz_nuts3",name:"Czech/?eská Republika NUTS3 regions",geographycount:"14",bunny:"59",jvectormap:"cz_nuts3_mill_en",legend:"BR",level:2},{map:"de_nuts1",name:"Germany/Deutschland  NUTS1 regions",geographycount:"16",bunny:"60",jvectormap:"de_nuts1_mill_en",legend:"BR",level:2},{map:"de_nuts2",name:"Germany/Deutschland NUTS2 regions",geographycount:"37",bunny:"60",jvectormap:"de_nuts2_mill_en",legend:"BR",level:2},{map:"de_nuts3",name:"Germany/Deutschland NUTS3 regions",geographycount:"413",bunny:"60",jvectormap:"de_nuts3_mill_en",legend:"BR",level:2},{map:"dk_nuts2",name:"Denmark/Danmark NUTS2 regions",geographycount:"5",bunny:"63",jvectormap:"dk_nuts2_mill_en",legend:"BR",level:2},{map:"dk_nuts3",name:"Denmark/Danmark NUTS3 regions",geographycount:"11",bunny:"63",jvectormap:"dk_nuts3_mill_en",legend:"BR",level:2},{map:"el_nuts2",name:"Greece/Ellada NUTS2 regions",geographycount:"13",bunny:"90",jvectormap:"el_nuts2_mill_en",legend:"BR",level:2},{map:"el_nuts3",name:"Greece/Ellada NUTS3 regions",geographycount:"51",bunny:"90",jvectormap:"el_nuts3_mill_en",legend:"BR",level:2},{map:"es_nuts2",name:"Spain/España NUTS2 regions",geographycount:"19",bunny:"70",jvectormap:"es_nuts2_mill_en",legend:"BR",level:2},{map:"es_nuts3",name:"Spain/España NUTS3 regions",geographycount:"59",bunny:"70",jvectormap:"es_nuts3_mill_en",legend:"BR",level:2},{map:"fi_nuts2",name:"Finland/Suomi NUTS2 regions",geographycount:"5",bunny:"73",jvectormap:"fi_nuts2_mill_en",legend:"BR",level:2},{map:"fi_nuts3",name:"Finland/Suomi NUTS3 regions",geographycount:"19",bunny:"73",jvectormap:"fi_nuts3_mill_en",legend:"BR",level:2},{map:"fr_nuts2",name:"France NUTS2 regions",geographycount:"26",bunny:"76",jvectormap:"fr_nuts2_mill_en",legend:"BR",level:2},{map:"fr_nuts3",name:"France NUTS3 regions",geographycount:"100",bunny:"76",jvectormap:"fr_nuts3_mill_en",legend:"BR",level:2},{map:"hu_nuts2",name:"Hungary/Magyarország NUTS2 regions",geographycount:"7",bunny:"102",jvectormap:"hu_nuts2_mill_en",legend:"BR",level:2},{map:"hu_nuts3",name:"Hungary/Magyarország NUTS3 regions",geographycount:"20",bunny:"102",jvectormap:"hu_nuts3_mill_en",legend:"BR",level:2},{map:"ie_nuts3",name:"Ireland NUTS3 regions",geographycount:"8",bunny:"107",jvectormap:"ie_nuts3_mill_en",legend:"BR",level:2},{map:"it_nuts2",name:"Italy/Italia NUTS2 regions",geographycount:"21",bunny:"112",jvectormap:"it_nuts2_mill_en",legend:"BR",level:2},{map:"it_nuts3",name:"Italy/Italia NUTS3 regions",geographycount:"110",bunny:"112",jvectormap:"it_nuts3_mill_en",legend:"BR",level:2},{map:"lt_nuts3",name:"Lithuania/Lietuva NUTS3 regions",geographycount:"10",bunny:"113",jvectormap:"lt_nuts3_mill_en",legend:"BR",level:2},{map:"lv_nuts3",name:"Latvia/Latvija NUTS3 regions",geographycount:"6",bunny:"135",jvectormap:"lv_nuts3_mill_en",legend:"BR",level:2},{map:"nl_nuts2",name:"Netherlands/Nederland NUTS2 regions",geographycount:"12",bunny:"167",jvectormap:"nl_nuts2_mill_en",legend:"BR",level:2},{map:"nl_nuts3",name:"Netherlands/Nederland NUTS3 regions",geographycount:"40",bunny:"167",jvectormap:"nl_nuts3_mill_en",legend:"BR",level:2},{map:"no_nuts2",name:"Norway/Norge NUTS2 regions",geographycount:"7",bunny:"168",jvectormap:"no_nuts2_mill_en",legend:"BR",level:2},{map:"no_nuts3",name:"Norway/Norge NUTS3 regions",geographycount:"19",bunny:"168",jvectormap:"no_nuts3_mill_en",legend:"BR",level:2},{map:"pl_nuts2",name:"Poland/Polska NUTS2 regions",geographycount:"16",bunny:"180",jvectormap:"pl_nuts2_mill_en",legend:"BR",level:2},{map:"pl_nuts3",name:"Poland/Polska NUTS3 regions",geographycount:"66",bunny:"180",jvectormap:"pl_nuts3_mill_en",legend:"BR",level:2},{map:"pt_nuts2",name:"Portugal NUTS2 regions",geographycount:"7",bunny:"183",jvectormap:"pt_nuts2_mill_en",legend:"BR",level:2},{map:"pt_nuts3",name:"Portugal NUTS3 regions",geographycount:"30",bunny:"183",jvectormap:"pt_nuts3_mill_en",legend:"BR",level:2},{map:"ro_nuts2",name:"Romania/România NUTS2 regions",geographycount:"8",bunny:"189",jvectormap:"ro_nuts2_mill_en",legend:"BR",level:2},{map:"ro_nuts3",name:"Romania/România NUTS3 regions",geographycount:"42",bunny:"189",jvectormap:"ro_nuts3_mill_en",legend:"BR",level:2},{map:"se_nuts2",name:"Sweden/Sverige NUTS2 regions",geographycount:"8",bunny:"211",jvectormap:"se_nuts2_mill_en",legend:"BR",level:2},{map:"se_nuts3",name:"Sweden/Sverige NUTS3 regions",geographycount:"21",bunny:"211",jvectormap:"se_nuts3_mill_en",legend:"BR",level:2},{map:"si_nuts3",name:"Slovakia/Slovenija NUTS3 regions",geographycount:"12",bunny:"210",jvectormap:"si_nuts3_mill_en",legend:"BR",level:2},{map:"sk_nuts3",name:"Slovenia/Slovensko NUTS3 regions",geographycount:"8",bunny:"209",jvectormap:"sk_nuts3_mill_en",legend:"BR",level:2},{map:"uk_nuts1",name:"United Kingdom NUTS1 regions",geographycount:"12",bunny:"80",jvectormap:"uk_nuts1_mill_en",legend:"BR",level:2},{map:"uk_nuts2",name:"United Kingdom NUTS2 regions",geographycount:"37",bunny:"80",jvectormap:"uk_nuts2_mill_en",legend:"BR",level:2},{map:"uk_nuts3",name:"United Kingdom NUTS3 regions",geographycount:"139",bunny:"80",jvectormap:"uk_nuts3_mill_en",legend:"BR",level:2},{map:"us",name:"USA (states)",geographycount:"51",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:0},{map:"us_counties",name:"US counties",geographycount:"3145",bunny:"235",jvectormap:"us_counties_merc_en",legend:"BL",level:1},{map:"eia_regions",name:"US by EIA statistical regions",geographycount:"10",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"New England",code:"EIA_NE",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT"]},{name:"Middle Atlantic",code:"EIA_MA",components:["US-NJ","US-NY","US-PA"]},{name:"East North Central",code:"EIA_ENC",components:["US-IL","US-IN","US-MI","US-OH","US-WI"]},{name:"West North Central",code:"EIAWNC",components:["US-IA","US-KS","US-MN","US-MO","US-NE","US-ND","US-SD"]},{name:"South Atlantic",code:"EIA_SA",components:["US-DE","US-DC","US-FL","US-GA","US-MD","US-NC","US-SC","US-VA","US-WV"]},{name:"East South Central",code:"EIA_ESC",components:["US-AL","US-KY","US-MS","US-TN"]},{name:"West South Central",code:"EIA_WSC",components:["US-AR","US-LA","US-OK","US-TX"]},{name:"Mountain",code:"EIA_MTN",components:["US-AZ","US-CO","US-ID","US-MT","US-NV","US-NM","US-UT","US-WY"]},{name:"Pacific Contiguous",code:"EIA_PC",components:["US-CA","US-OR","US-WA"]},{name:"Pacific Noncontiguous",code:"EIA_PNC",components:["US-AK","US-HI"]}]}},{map:"padds",name:"US Petroleum Districts",geographycount:"5",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"PADD I (East Coast)",code:"PADD1",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT","US-DE","US-DC","US-MD","US-NJ","US-NY","US-PA","US-FL","US-GA","US-NC","US-SC","US-VA","US-WV"]},{name:"PADD II (Midwest)",code:"PADD2",components:["US-IL","US-IN","US-IA","US-KS","US-KY","US-MI","US-MN","US-MO","US-NE","US-ND","US-SD","US-OH","US-OK","US-TN","US-WI"]},{name:"PADD III (Gulf Coast)",code:"PADD3",components:["US-AL","US-AR","US-LA","US-MS","US-NM","US-TX"]},{name:"PADD IV (Rocky Mountain)",code:"PADD4",components:["US-CO","US-ID","US-MT","US-UT","US-WY"]},{name:"PADD V (West Coast)",code:"PADD5",components:["US-AK","US-AZ","US-CA","US-HI","US-NV","US-OR","US-WA"]}]}},{map:"padds_sub",name:"US Petroleum Districts - detailed",geographycount:"7",bunny:"235",jvectormap:"us_aea_en",legend:"BL",level:1,redef:{regions:[{name:"PADD I, Subdistrict A (New England): Connecticut, Maine, Massachusetts, New Hampshire, Rhode Island, and Vermont.",code:"PADD1a",components:["US-CT","US-ME","US-MA","US-NH","US-RI","US-VT"]},{name:"PADD I, Subdistrict B (Central Atlantic): Delaware, District of Columbia, Maryland, New Jersey, New York, and Pennsylvania.",code:"PADD1b",components:["US-DE","US-DC","US-MD","US-NJ","US-NY","US-PA"]},{name:"PADD I, Subdistrict C (Lower Atlantic): Florida, Georgia, North Carolina, South Carolina, Virginia, and West Virginia.",code:"PADD1c",components:["US-FL","US-GA","US-NC","US-SC","US-VA","US-WV"]},{name:"PADD II (Midwest): Illinois, Indiana, Iowa, Kansas, Kentucky, Michigan, Minnesota, Missouri, Nebraska, North Dakota, South Dakota, Ohio, Oklahoma, Tennessee, and Wisconsin.",code:"PADD2",components:["US-IL","US-IN","US-IA","US-KS","US-KY","US-MI","US-MN","US-MO","US-NE","US-ND","US-SD","US-OH","US-OK","US-TN","US-WI"]},{name:"PADD III (Gulf Coast): Alabama, Arkansas, Louisiana, Mississippi, New Mexico, and Texas",code:"PADD3",components:["US-AL","US-AR","US-LA","US-MS","US-NM","US-TX"]},{name:"PADD IV (Rocky Mountain): Colorado, Idaho, Montana, Utah, and Wyoming.",code:"PADD4",components:["US-CO","US-ID","US-MT","US-UT","US-WY"]},{name:"PADD V (West Coast): Alaska, Arizona, California, Hawaii, Nevada, Oregon, and Washington.",code:"PADD5",components:["US-AK","US-AZ","US-CA","US-HI","US-NV","US-OR","US-WA"]}]}},{map:"us_ak",name:"Alaska",geographycount:"29",bunny:"251",jvectormap:"usak_merc_en",legend:"TR",level:2},{map:"us_al",name:"Alabama",geographycount:"67",bunny:"250",jvectormap:"usal_merc_en",legend:"BR",level:2},{map:"us_ar",name:"Arkansas",geographycount:"75",bunny:"253",jvectormap:"usar_merc_en",legend:"BR",level:2},{map:"us_az",name:"Arizona",geographycount:"15",bunny:"252",jvectormap:"usaz_merc_en",legend:"BR",level:2},{map:"us_ca",name:"California",geographycount:"58",bunny:"254",jvectormap:"usca_merc_en",legend:"TR",level:2},{map:"us_co",name:"Colorado",geographycount:"64",bunny:"255",jvectormap:"usco_merc_en",legend:"BR",level:2},{map:"us_ct",name:"Connecticut",geographycount:"8",bunny:"256",jvectormap:"usct_merc_en",legend:"BR",level:2},{map:"us_dc",name:"District of Columbia",geographycount:"2",bunny:"694",jvectormap:"usdc_merc_en",legend:"BR",level:2},{map:"us_de",name:"Delaware",geographycount:"3",bunny:"257",jvectormap:"usde_merc_en",legend:"TR",level:2},{map:"us_fl",name:"Florida",geographycount:"67",bunny:"258",jvectormap:"usfl_merc_en",legend:"BL",level:2},{map:"us_ga",name:"Georgia",geographycount:"159",bunny:"259",jvectormap:"usga_merc_en",legend:"TR",level:2},{map:"us_hi",name:"Hawaii",geographycount:"5",bunny:"260",jvectormap:"ushi_merc_en",legend:"BL",level:2},{map:"us_ia",name:"Iowa",geographycount:"99",bunny:"264",jvectormap:"usia_merc_en",legend:"BR",level:2},{map:"us_id",name:"Idaho",geographycount:"44",bunny:"261",jvectormap:"usid_merc_en",legend:"TR",level:2},{map:"us_il",name:"Illinois",geographycount:"102",bunny:"262",jvectormap:"usil_merc_en",legend:"BL",level:2},{map:"us_in",name:"Indiana",geographycount:"92",bunny:"263",jvectormap:"usin_merc_en",legend:"BR",level:2},{map:"us_ks",name:"Kansas",geographycount:"105",bunny:"265",jvectormap:"usks_merc_en",legend:"BR",level:2},{map:"us_ky",name:"Kentucky",geographycount:"120",bunny:"266",jvectormap:"usky_merc_en",legend:"TL",level:2},{map:"us_la",name:"Louisiana",geographycount:"64",bunny:"267",jvectormap:"usla_merc_en",legend:"TR",level:2},{map:"us_md",name:"Maryland",geographycount:"24",bunny:"269",jvectormap:"usmd_merc_en",legend:"BL",level:2},{map:"us_me",name:"Maine",geographycount:"16",bunny:"268",jvectormap:"usme_merc_en",legend:"TR",level:2},{map:"us_ma",name:"Massachusetts",geographycount:"14",bunny:"270",jvectormap:"usma_merc_en",legend:"BL",level:2},{map:"us_mi",name:"Michigan",geographycount:"83",bunny:"271",jvectormap:"usmi_merc_en",legend:"BL",level:2},{map:"us_mn",name:"Minnesota",geographycount:"87",bunny:"272",jvectormap:"usmn_merc_en",legend:"BR",level:2},{map:"us_ms",name:"Mississippi",geographycount:"82",bunny:"273",jvectormap:"usms_merc_en",legend:"BR",level:2},{map:"us_mo",name:"Missouri",geographycount:"115",bunny:"274",jvectormap:"usmo_merc_en",legend:"TR",level:2},{map:"us_mt",name:"Montana",geographycount:"56",bunny:"275",jvectormap:"usmt_merc_en",legend:"BR",level:2},{map:"us_nc",name:"North Carolina",geographycount:"100",bunny:"282",jvectormap:"usnc_merc_en",legend:"BR",level:2},{map:"us_nd",name:"North Dakota",geographycount:"53",bunny:"283",jvectormap:"usnd_merc_en",legend:"BR",level:2},{map:"us_ne",name:"Nebraska",geographycount:"93",bunny:"276",jvectormap:"usne_merc_en",legend:"BL",level:2},{map:"us_nh",name:"New Hampshire",geographycount:"10",bunny:"278",jvectormap:"usnh_merc_en",legend:"TR",level:2},{map:"us_nj",name:"New Jersey",geographycount:"21",bunny:"279",jvectormap:"usnj_merc_en",legend:"BR",level:2},{map:"us_nm",name:"New Mexico",geographycount:"33",bunny:"280",jvectormap:"usnm_merc_en",legend:"BR",level:2},{map:"us_nv",name:"Nevada",geographycount:"17",bunny:"277",jvectormap:"usnv_merc_en",legend:"BR",level:2},{map:"us_ny",name:"New York",geographycount:"62",bunny:"281",jvectormap:"usny_merc_en",legend:"TR",level:2},{map:"us_oh",name:"Ohio",geographycount:"88",bunny:"284",jvectormap:"usoh_merc_en",legend:"BR",level:2},{map:"us_ok",name:"Oklahoma",geographycount:"77",bunny:"285",jvectormap:"usok_merc_en",legend:"BR",level:2},{map:"us_or",name:"Oregon",geographycount:"36",bunny:"286",jvectormap:"usor_merc_en",legend:"BR",level:2},{map:"us_pa",name:"Pennsylvania",geographycount:"67",bunny:"287",jvectormap:"uspa_merc_en",legend:"BR",level:2},{map:"us_ri",name:"Rhode Island",geographycount:"5",bunny:"288",jvectormap:"usri_merc_en",legend:"BR",level:2},{map:"us_sc",name:"South Carolina",geographycount:"46",bunny:"289",jvectormap:"ussc_merc_en",legend:"BR",level:2},{map:"us_sd",name:"South Dakota",geographycount:"66",bunny:"290",jvectormap:"ussd_merc_en",legend:"BR",level:2},{map:"us_tn",name:"Tennessee",geographycount:"95",bunny:"291",jvectormap:"ustn_merc_en",legend:"BR",level:2},{map:"us_tx",name:"Texas",geographycount:"254",bunny:"292",jvectormap:"ustx_merc_en",legend:"BL",level:2},{map:"us_ut",name:"Utah",geographycount:"29",bunny:"293",jvectormap:"usut_merc_en",legend:"BR",level:2},{map:"us_va",name:"Virginia",geographycount:"136",bunny:"295",jvectormap:"usva_merc_en",legend:"TL",level:2},{map:"us_vt",name:"Vermont",geographycount:"14",bunny:"294",jvectormap:"usvt_merc_en",legend:"BR",level:2},{map:"us_wa",name:"Washington",geographycount:"39",bunny:"296",jvectormap:"uswa_merc_en",legend:"BR",level:2},{map:"us_wi",name:"Wisconsin",geographycount:"72",bunny:"298",jvectormap:"uswi_merc_en",legend:"BL",level:2},{map:"us_wv",name:"West Virginia",geographycount:"55",bunny:"297",jvectormap:"uswv_merc_en",legend:"BR",level:2},{map:"us_wy",name:"Wyoming",geographycount:"23",bunny:"299",jvectormap:"uswy_merc_en",legend:"BR",level:2},{map:"au",name:"Australia",geographycount:"8",bunny:"15",jvectormap:"au_mill_en",legend:"BR",level:0},{map:"ca",name:"Canada",geographycount:"13",bunny:"40",jvectormap:"ca_mill_en",legend:"BR",level:0},{map:"cn",name:"China",geographycount:"31",bunny:"44",jvectormap:"cn_mill_en",legend:"BR",level:0},{map:"co",name:"Colombia",geographycount:"33",bunny:"50",jvectormap:"co_mill_en",legend:"BR",level:0},{map:"in",name:"India",geographycount:"34",bunny:"105",jvectormap:"in_mill_en",legend:"BR",level:0},{map:"nz",name:"New Zealand",geographycount:"13",bunny:"171",jvectormap:"nz_mill_en",legend:"BR",level:0},{map:"ph",name:"Philippines",geographycount:"17",bunny:"177",jvectormap:"ph_mill_en",legend:"BR",level:0},{map:"pr",name:"Puerto Rico",geographycount:"78",bunny:"181",jvectormap:"pr_merc_en",legend:"BR",level:0},{map:"th",name:"Thailand",geographycount:"76",bunny:"219",jvectormap:"th_mill_en",legend:"BR",level:0},{map:"tr_nuts1",name:"Turkey NUTS1 regions",geographycount:"12",bunny:"227",jvectormap:"tr_nuts1_mill_en",legend:"BL",level:0},{map:"tr_nuts2",name:"Turkey NUTS2 regions",geographycount:"26",bunny:"227",jvectormap:"tr_nuts2_mill_en",legend:"BL",level:0},{map:"tr_nuts3",name:"Turkey NUTS3 regions",geographycount:"81",bunny:"227",jvectormap:"tr_nuts3_mill_en",legend:"BL",level:0},{map:"ve",name:"Venezuela",geographycount:"25",bunny:"239",jvectormap:"ve_mill_en",legend:"BR",level:0},{map:"za",name:"South Africa",geographycount:"9",bunny:"247",jvectormap:"za_mill_en",legend:"BR",level:0}];
e.globals.orderedMapList=t;e.globals.maps={};var a,n="";for(var i=0;i<t.length;i++){a=t[i];n+='<li class="map-list-item map-level'+a.level+'" data="'+a.map+'">'+a.name+"</li>";e.globals.maps[a.map]=a}var s='<ul class="map-list">'+n+"</ul>";e.common.selectMap=function(t){var a=true;var n=$(this).blur();var i=n.offset();var o='<div id="select-map" style="left:'+i.left+"px;top:"+(i.top+n.innerHeight())+'px;">'+s+"</div>";var r=$(o).appendTo("body").find('li[data="'+n.val()+'"]').addClass("selector-selected").end().css("max-height",$(window).innerHeight()*.8+"px").show();$("body").bind("click",l);function l(t){if(a)return a=false;var n=$(t.target);if(n.hasClass("map-list-item")){var i=n.attr("data");$("#find-data-map").html('<option value="'+i+'" selected>'+e.globals.maps[i].name+"</option>");ct();r.remove();return i}else{r.remove();$("body").unbind("click",l);return false}}};e.common.makeMap=function(t,a,n){if(!jvm.Map.maps[t]||n){n=n||e.globals.maps[t].redef;a=a||e.globals.maps[t].jvectormap;jvm.Map.maps[t]=$.extend(true,{},jvm.Map.maps[a]);var i=jvm.Map.maps[t];for(var s=0;s<n.regions.length;s++){var o=n.regions[s];i.paths[o.code]={name:o.name,path:""};for(var r=0;r<o.components.length;r++){if(i.paths[o.components[r]]){i.paths[o.code].path+=(r==0?"":" ")+i.paths[o.components[r]].path}else{}delete i.paths[o.components[r]]}}}}})();e.grapher=function(){var t=e,a=t.globals,n=t.common,s=a.maps,o=a.panelGraphs,l=a.months,c=a.period,d=a.patVariable,p=a.hcColors,u=a.primeColors,h=a.MAP_COLORS,f=a.DEFAULT_RADIUS_SCALE,m=a.DEFAULT_RADIUS_FIXED,g=a.dashStyles,b=a.op,y=a.MyGraphs,w=a.isIE,k=n.dateFromMdDate,x=n.rationalize,S=n.callApi;var M={chartPanel:function H(e){console.time("chartPanel");var n=o[e];console.time("makeChartOptionsObject");var i=U(n);console.timeEnd("makeChartOptionsObject");var s=n.controls.$thisPanel.find("div.mashabledata_chart");if(i.series.length==0){s.hide();return void 0}var r;if(n.controls&&n.controls.chart){n.controls.chart.destroy();$.contextMenu("destroy","#"+e+" div.mashabledata_chart")}i.chart.renderTo=s.get(0);var l=n.controls.annotations;if(a.isEmbedded){i.plotOptions.series.point={events:{click:function(e){c(this.x)}}};i.chart.events={click:function(e){c(e.xAxis[0].value)}}}else{i.plotOptions.series.point={events:{mouseOver:function(e){l.mouseoverPoint=this;l.mouseOverHCPoint(e,this)},mouseOut:function(e){delete l.mouseoverPoint},click:function(e){if(l.banding){l.endBanding(e)}else{c(this.x)}}}};i.chart.events={click:function(e){if(l.banding){l.endBanding(e)}else{c(e.xAxis[0].value)}},selection:function(t){var a;var s;if(t.resetSelection){if(r.cropButton)r.cropButton=r.cropButton.destroy();n.minZoom=n.start===null?n.firstdt:n.start;n.maxZoom=n.end===null?n.lastdt:n.end}else{var o=$.extend(true,{},r.options.chart.resetZoomButton);o.position.y+=30;var l={x:r.plotLeft,y:r.plotTop,width:r.plotWidth,height:r.plotHeight};r.cropButton=r.renderer.button("Crop X-axis",null,null,function(){$("#"+e+" button.graph-crop").click()},{zIndex:20},null).attr({align:"right"}).attr({align:o.position.align,title:"Crop x-axis to current zoom level"}).add().align(o.position,false,l);var c=t.xAxis[0].min;var d=t.xAxis[0].max;for(var p=0;p<i.series.length;p++){var u=i.series[p].data;a=T(c,u,a);s=T(d,u,s)}n.minZoom=a;n.maxZoom=s}}}}console.time("highcharts");r=new Highcharts.Chart(i);if(n.controls)n.controls.chart=r;console.timeEnd("highcharts");l.plotAnnotationSeries();if(!a.isEmbedded){s.mouseover(function(e){if(l.banding){if(l.banding.substr(0,2)=="y-"){var t=$(r.container).offset().top,a=$(r.container).offset().left;var n=(w?e.originalEvent.x:e.clientX-a)-r.plotLeft,i=(w?e.originalEvent.y:e.pageY-t)-r.plotTop;if(i>=0&&i<=r.plotSizeY){for(var s=0;s<r.yAxis.length;s++){if(r.yAxis[s].userOptions.title.text==l.banding.substr(2)){var o=r.yAxis[s].translate(r.plotHeight-i,true);r.yAxis[s].removePlotBand("hb"+l.bandNo);r.yAxis[s].addPlotBand({id:"hb"+l.bandNo,color:equivalentRGBA(v[0],BAND_TRANSPARENCY),from:parseFloat(l.bandStartPoint),to:o,label:{text:"",zIndex:3}})}}}}}}).keydown(function(e){if(l.banding&&e){for(var t=0;t<r.axes.length;t++){r.axes[t].removePlotLine(l.banding);r.axes[t].removePlotBand(l.banding)}l.banding=false}});console.time("contextMenu");$.contextMenu({selector:"#"+e+" div.mashabledata_chart",build:function(e,a){var i,s,o,c,d;var p,u,h,f;var m=l.mouseoverPoint;var g=typeof l.mouseoverPoint!="undefined";if(l.banding){return l.endBanding(a)}else{var b={items:{point:{name:"annotate point",disabled:!g,callback:function(e,t){l.addPoint(m)}},sep0:"---------",vline:{name:"add vertical line",disabled:!g,callback:function(e,t){l.addXLine(m)}},vband:{name:"start vertical band",disabled:!g,callback:function(e,t){l.startXBand(m)}},sep1:"---------",hline:{name:"add horizontal line",items:{}},hband:{name:"start horizontal band",items:{}},sep2:"---------",avg:{name:"start average",disabled:!g,callback:function(e,t){if(!f){l.startAnalysisBanding(m,"AV")}else{l.deleteAnalysis(m)}}},regression:{name:"start linear regression",disabled:!g,callback:function(e,t){if(!h){l.startAnalysisBanding(m,"LR")}else{l.deleteAnalysis(m)}}},standard:{name:"add standard annotations",items:{}}}};if(g&&m.series.options.calculatedFrom&&m.series.options.id.substr(0,2)=="LR"){b.items.regression.name="delete linear regression";b.items.regression.className="delete-item";h=true;delete b.items.avg}if(g&&m.series.options.calculatedFrom&&m.series.options.id.substr(0,2)=="AV"){b.items.avg.name="delete average";b.items.avg.className="delete-item";f=true;delete b.items.regression}c=$(r.container).offset().top;d=$(r.container).offset().left;s=(w?a.originalEvent.x:a.clientX-d)-r.plotLeft;o=(w?a.originalEvent.y:a.pageY-c)-r.plotTop;if(o>=0&&o<=r.plotSizeY){for(i=0;i<r.yAxis.length;i++){p=r.yAxis[i].userOptions.title.text;u=parseFloat(parseFloat(r.yAxis[i].translate(r.plotHeight-o,true).toPrecision(2)));b.items.hline.items["hltext"+i]={name:"<b>"+p+":</b>",type:"text",value:u};b.items.hline.items["hladd"+i]={name:"<button>add</button>",callback:function(e,t){var a=parseFloat($.contextMenu.getInputValues(t)["hltext"+e.substr(5)]);var i="hl"+l.lineNo++;r.yAxis[parseInt(e.substr(5))].addPlotLine({id:i,color:"#FF0000",width:2,value:a});n.annotations.push({id:i,type:"hline",color:"#FF0000",from:a,yAxis:r.yAxis[parseInt(e.substr(5))].userOptions.title.text,text:""});l.build("table-only")}};b.items.hband.items["hbtext"+i]={name:"<b>"+p+":</b>",type:"text",value:u};b.items.hband.items["hbadd"+i]={name:"<button>start</button>",callback:function(e,t){l.bandStartPoint=parseFloat($.contextMenu.getInputValues(t)["hbtext"+e.substr(5)]);l.banding="y-"+r.yAxis[e.substr(5)].userOptions.title.text;r.yAxis[parseInt(e.substr(5))].addPlotBand({id:"hb"+l.bandNo++,color:equivalentRGBA(v[0],BAND_TRANSPARENCY),from:l.bandStartPoint,to:l.bandStartPoint})}};if(i!=0){b.items.hline.items["yadd"+i+"sep"]="---------";b.items.hband.items["yadd"+i+"sep"]="---------"}}}else{if(!g)return false;b.items.hline.disabled=true;b.items.hband.disabled=true}for(i=0;i<t.globals.standardAnnotations.length;i++){b.items.standard.items["SA"+t.globals.standardAnnotations[i].annoid]={name:t.globals.standardAnnotations[i].name,callback:function(e,t){l.addStandard(parseInt(e.substr(2)))}}}return b}}});console.timeEnd("contextMenu");$("#"+e+" .highcharts-title").click(function(){q.show(this)})}console.timeEnd("chartPanel");return r;function c(e){var t=n.calculatedMapData;if(n.mapsets||n.pointsets){if(t.startDateIndex!=t.endDateIndex){var a=T(e,t.dates);for(var i=0;i<t.dates.length;i++){if(t.dates[i]["dt"].getTime()==a){n.controls.$thisPanel.find(".mashabledata_map-slider").slider("value",i)}}}}}},intervalStartDt:function Y(e){var t=new Date(parseInt(e.lastdt));switch(e.largestPeriod){case"A":return t.setUTCFullYear(t.getUTCFullYear()-(e.intervals-1));case"SA":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*6);case"Q":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*3);case"M":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1));case"W":return t.setUTCDate(t.getUTCDate()-(e.intervals-1)*7);default:return t.setUTCDate(t.getUTCDate()-(e.intervals-1))}},setCropSlider:function X(e){if(a.isEmbedded)return;var t,n,i,s,r,l,d,p=o[e];if(p.controls.chart){d=p.controls.chart.options.chart;if(p.start===null){t=0}else{s=d.x.indexOf(p.start.toString());if(s>-1){t=s}else{r=null;for(s=0;s<d.x.length;s++){l=Math.abs(parseInt(d.x[s])-parseInt(p.start));if(r===null||r>l){r=l;t=s}}}}if(p.end===null){n=d.x.length-1}else{s=d.x.indexOf(p.end.toString());if(s>-1){n=s}else{r=null;for(s=0;s<d.x.length;s++){l=Math.abs(parseInt(d.x[s])-parseInt(p.end));if(r===null||r>l){r=l;n=s}}}}i=d.x.length-1}else{t=p.calculatedMapData.startDateIndex;n=p.calculatedMapData.endDateIndex;i=p.calculatedMapData.dates.length-1}$("#"+e+" span.interval-crop-period").html(c.units[p.largestPeriod]+"s");$("#"+e+" div.crop-slider").slider("option","max",i).slider("option","values",[t,n])},closestDate:function K(e,t,a){var n;for(var i=0;i<t.length;i++){if(Array.isArray(t[i])){n=t[i][0]}else{if(t[i].dt){n=t[i].dt.getTime()}else{n=t[i].x}}if(Math.abs(e-n)<Math.abs(e-a)||a===undefined)a=n}return a},createMyGraph:function Z(n,i){console.time("createMyGraph");if(a.isEmbedded&&e.globals.graphBluePrints[n]){var s=new t.Graph(e.globals.graphBluePrints[n]);s.fetchMap();o(s)}else{S({command:a.isEmbedded?"GetEmbeddedGraph":"GetFullGraph",ghash:n},function(a,i,s){for(var r in a.graphs){var l=new t.Graph(a.graphs[r]);l.fetchMap();e.globals.graphBluePrints[n]=a.graphs[r];if(document.URL.indexOf("mashabledata.com/preview")!==-1){var c='MashableData.globals.graphBluePrints["'+n+'"] = '+JSON.stringify(a.graphs[r]);var d=$("#MashableData_graphData");d.html(d.html()+"&#13;&#10;&#13;&#10;"+c+"&#13;&#10;&#13;&#10;");if(l.mapFile){$.get("/global/js/maps/"+l.mapFile+".js",function(e){d.html(d.html()+e+"&#13;&#10;")})}}}o(l)})}function o(e){var t=(a.isEmbedded?[]:a.graphScriptFilesx).concat(e.mapFile?[(a.isEmbedded?"//www.mashabledata.com/global/js/maps/":"/global/js/maps/")+e.mapFile+".js"]:[]);require(t,function(){I(e);if(i)i()})}console.timeEnd("createMyGraph")},makeChartOptionsObject:function Q(t){console.time("makeChartOptionsObject");var a,n,i,s={},o={};var r={chart:{animation:false,type:"line",zoomType:"x",x:[]},exporting:{enabled:false},plotOptions:{area:{stacking:"normal"},scatter:{zIndex:20,showInLegend:false},series:{zIndex:10,marker:{enabled:true,radius:5,symbol:"circle",fillColor:"#FFFFFF",states:{hover:{enabled:true}}},shadow:false,states:{hover:{lineWidthPlus:1}},dataLabels:{align:"center",enabled:true,color:"#ffffff",formatter:function(){if(typeof this.point.id!="undefined"){return this.point.id}},y:11,x:-1}}},legend:{enabled:true},credits:{enabled:true,text:"created with MashableData.com",href:"http://www.mashabledata.com"},series:[],title:{text:t.title,style:{cursor:"pointer"}},xAxis:{type:"datetime",min:t.start===null?t.intervals?_(t):null:parseInt(t.start),max:t.end===null?null:parseInt(t.end)},yAxis:[]};if(t.controls)r.chart.height=(t.controls.$thisPanel.height()-70-(t.map?70:0))*(t.mapsets||t.pointsets?.4:1);if(t.title.length==0){r.title.text="untitled - click to edit";r.title.style.color="grey";r.title.style.font="italic"}var l=0;function d(e,t){e.eachComponent(function(e){if(typeof e.firstdt!="undefined"&&e.src!="MashableData"){t.firstdt=typeof t.firstdt=="undefined"?parseInt(e.firstdt):Math.min(parseInt(e.firstdt),parseInt(t.firstdt));t.lastdt=typeof t.lastdt=="undefined"?parseInt(e.lastdt):Math.max(parseInt(e.lastdt),parseInt(t.lastdt))}})}t.eachPlot(function(){var a=this;a.eachComponent(function(n){if(this.src=="MashableData"){var i=this;delete i.firstdt;delete i.lastdt;d(a,i);if(typeof i.lastdt=="undefined")d(t,i);i.data=e.common.dateConversionData(i)}})});t.eachComponent(function(e,a){if(this.src=="MashableData"){var n=this;if(a.components.length==1){if(!t.firstdt&&!t.lastdt)t.eachComponent(function(){d(t,t.assets[this.handle()])});this.firstdt=t.firstdt;this.lastdt=t.lastdt}else{delete n.firstdt;delete n.lastdt;a.eachComponent(function(){d(n,this)})}}});for(a=0;a<t.plots.length;a++){var p=t.plots[a];var u=p.createHighSeries();if(!p.options.color)p.options.color=L(t.plots);var h={name:u.name,marker:{enabled:t.type=="marker"},id:"P"+a,freq:u.freq,color:p.options.color,data:u.data,yAxis:0};if(p.options.type){if(p.options.type!="default")h.type=p.options.type}if(p.options.lineWidth){h.lineWidth=p.options.lineWidth;h.states={hover:{lineWidth:parseInt(p.options.lineWidth)+2}}}if(p.options.lineStyle)h.dashStyle=p.options.lineStyle;if(t.type=="area"||h.stack=="area"){h.stack=u.units}for(n=0;n<u.data.length;n++){s[u.data[n][0].toString()]=true}var f=u.units;var m={labels:{style:{color:"#333333"}},title:{text:f,style:{color:"#333333"}}};if(r.yAxis.length==0){r.yAxis.push(m)}else{var g=false;var b;for(b=0;b<r.yAxis.length;b++){if(r.yAxis[b].title.text==f){h.yAxis=b;g=true;break}}if(!g){m.title.style.color=h.color;m.labels.style.color=h.color;r.yAxis[0].title.style.color=r.series[0].color;r.yAxis[0].labels.style.color=r.series[0].color;m.opposite=true;r.yAxis.push(m);h.yAxis=b}}r.series.push(h);l++}for(var v in s){r.chart.x.push(Number(v))}r.chart.x.sort(function(e,t){return parseInt(e)-parseInt(t)});for(a=0;a<r.yAxis.length;a++){r.series.push({type:"scatter",id:"labelsY-"+a,yAxis:a,data:[],doNotShow:true})}switch(t.type){case"pie":var y=[{type:"pie",data:[]}];var w=t.end?parseInt(t.end):t.lastdt;for(a=0;a<r.series.length;a++){u=r.series[a];for(n=u.data.length-1;n>=0;n--){if(u.data[n][0]==w){y[0].data.push([u.name,u.data[n][1]]);break}}}r.series=y;r.chart.type=t.type;break;case"stacked-column":r.plotOptions.column={stacking:"normal"};for(a=0;a<r.series.length;a++){r.series[a].stack="stacked"}case"column":r.chart.type="column";break;case"area-percent":r.yAxis[0].title.text="percent";r.plotOptions.area.stacking="percent";case"area":r.chart.type="area";break;case"marker":break;case"auto":if(t.smallestPeriod!=t.largestPeriod){for(a=0;a<r.series.length;a++){if(t.largestPeriod==r.series[a].freq){r.series[a].type="column";r.series[a].zIndex=8;r.series[a].pointRange=c.value[r.series[a].freq];r.series[a].pointPlacement="between";r.series[a].pointPadding=0;r.series[a].groupPadding=.05}}}else{var k=0,x;for(a=0;a<r.series.length;a++){if(r.series[a].freq){x=0;for(n=0;n<r.series[a].data.length;n++){i=r.series[a].data[n][0];if((!r.xAxis.min||r.xAxis.min<=i)&&(!r.xAxis.max||r.xAxis.max>=i))x++}k=Math.max(k,x)}}if(k<=5){r.chart.type="column";if(k==1&&t.smallestPeriod){if(r.xAxis.min)r.xAxis.min-=c.value[t.smallestPeriod]/4;if(r.xAxis.max)r.xAxis.max+=c.value[t.smallestPeriod]/4}}}break;case"logarithmic":for(a=0;a<r.yAxis.length;a++){r.yAxis[a].type="logarithmic"}break;case"normalized-line":var S;if(t.start){S=t.start}else{S=r.series[0].data[0][0]}var M=false;while(!M){M=true;for(a=0;a<r.series.length;a++){if(r.series[a].sid){while(S>r.series[a].data[0][0]){r.series[a].data.splice(0,1);if(r.series[a].data.length==0){break}if(S<r.series[a].data[0][0]){S=r.series[a].data[0][0]}}if(r.series[a].data.length==0){r.title.text="Error:  no common starting point for normalization";for(n=0;n<r.series.length;n++){r.series[n].data=[]}M=true;break}M=M&&S==r.series[a].data[0][0]}}}for(a=0;a<r.series.length;a++){for(n=r.series[a].data.length-1;n>=0;n--){r.series[a].data[n][1]=r.series[a].data[n][1]/r.series[a].data[0][1]}r.seriesyAxis=0}r.yAxis=[{title:{text:"Normalized to 1"}}]}if(t.smallestPeriod)r.xAxis.minTickInterval=c.value[t.smallestPeriod];console.timeEnd("makeChartOptionsObject");return r},buildGraphPanel:function J(l,c){if(a.isEmbedded){console.time("buildGraphPanelCore");m(l);console.timeEnd("buildGraphPanelCore")}else{Qt("drawing the graph"+(window.SVGAngle?"":"<br>Note: Graphs will draw 20 times faster in a modern browser such as Chrome, Firefox, Safari or Internet Exploer 9 or later"));window.setTimeout(function(){m(l,c)},20)}function m(l,c){var m,g,b;var v=0,y;var w=[];l.eachComponent(function(e,t){if(!this.data&&!l.assets[this.handle()]){w.push(this.handle());t.components.splice(e--,1)}});console.time("buildGraphPanel:header");if(l.title.length==0){var S,M=0;for(S in l.assets){M++;if(M>1)break}if(M==1)l.title=l.assets[S].name}m=l.title;var _,T=a.isEmbedded;if(T){c="G"+l.ghash;b=$("div[data='"+l.ghash+"']:first");if(b.length==0)return}else{if(!c){c=zt(m);$("#graph-tabs li").find("[href='#"+c+"']").html(m)}b=$("#"+c)}if(w.length>0){var A="Unable to find data assets ("+w.join(", ")+") required by this graphs.";if(T){b.html(A);return}else{vt("data error",A)}}if(l.intervals==0)l.intervals=null;var U=new e.Annotator(c,dt);l.controls={annotations:U,$thisPanel:b,provenance:{},redraw:typeof ct=="undefined"?null:ct};console.timeEnd("buildGraphPanel:header");if(T){_='<div class="mashabledata_chart-map">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<div class="mashabledata_maptabs"></div>'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+"</div>"+"</div>"+'<div class="mashabledata_graph-analysis"></div>'+"</div>"}else{_='<div class="provenance graph-sources graph-subpanel" style="display: none;"></div>'+'<div class="graph-chart graph-subpanel">'+'<div class="resize">'+"<p>Drag the lower nd right edge of the visualizations' borders to fix the exact dimensions of the maps and graphs.  The default is to expand to fit the container.  Exact sizing ensures that what you see in the workbench is what your website's visitors will see.</p>"+'<button class="size_reset">use default sizing</button><br />'+'<button class="size_set">finished resizing</button>'+"</div>"+'<div class="graph_control_panel" style="font-size: 11px !important;">'+'<div class="configuration" style="border: none;">'+"<fieldset>"+"<legend>&nbsp;Configure&nbsp;</legend>"+'<div class="graph-type">default graph type '+'<select class="graph-type">'+'<option value="auto">auto (line &amp; column)</option>'+'<option value="line">line</option>'+'<option value="marker">line with markers</option>'+'<option value="column">column</option>'+'<option value="stacked-column">stacked column</option>'+'<option value="area-percent">stacked percent</option>'+'<option value="area">stacked area</option>'+'<option value="logarithmic">logarithmic</option>'+'<option value="normalized-line">normalized line</option>'+'<option value="pie">pie</option>'+"</select>"+"</div>"+'<div class="graph-map-mode">default map type '+'<select class="graph-map-mode">'+'<option value="heat">colored heat map of values</option>'+'<option value="abs-change">colored heat map of changes</option>'+'<option value="percent-change">colored heat map of percent changes</option>'+'<option value="bubbles">overlay circles to show values</option>'+'<option value="change-bubbles">overlay circles to show changes</option>'+'<option value="max">shows when max value was reached</option>'+'<option value="min">shows when min value was reached</option>'+'<option value="treemap">abstract values to rectangles</option>'+'<option value="change-treemap">abstract change to rectangles</option>'+"</select>"+"</div>"+'<div class="change-basemap">base map '+'<select class="change-basemap"></select>'+'<div class="mashabledata_legend"><label><input type="checkbox" class="mashabledata_legend" '+(l.mapconfig.showLegend?"checked":"")+">show legend for all maps</label></div>"+'<div class="map-viz-select">map interactive'+'<select class="map-viz-select">'+"</select>"+"</div>"+"</div>"+'<div class="crop-tool"><fieldset><legend>Crop graph</legend>'+"<table>"+'<tr><td><input type="radio" name="'+c+'-rad-crop" id="'+c+'-rad-no-crop" class="rad-no-crop"></td><td><label for="'+c+'-rad-no-crop">no cropping (graph will expand as new data is gathered)</label></td></tr>'+'<tr><td><input type="radio" name="'+c+'-rad-crop" id="'+c+'-rad-hard-crop" class="rad-hard-crop"></td><td>'+'<div class="crop-dates"><i>select this option and slide endpoints for a fixed crop</i></div>'+'<div class="crop-slider"></div>'+"</td></tr>"+'<tr><td><input type="radio" name="'+c+'-rad-crop" id="'+c+'-rad-interval-crop" class="rad-interval-crop"></td>'+'<td><label for="'+c+'-rad-interval-crop">show latest <input class="interval-crop-count" value="'+(l.intervals||5)+'"> <span class="interval-crop-period"></span></label></td></tr>'+"</table>"+'<button class="graph-crop" style="display: none;">crop</button></fieldset>'+"</div>"+'<button class="provenance">more configurations</button>'+'<button class="resize">set size</button>'+"</fieldset>"+"</div>"+'<div class="annotations"><fieldset><legend>Chart annotations</legend>'+'<table class="annotations"></table>'+"</fieldset>"+"</div>"+'<div class="downloads">'+"<fieldset>"+"<legend>&nbsp;Download&nbsp;</legend>"+'<select class="download-selector"></select> '+"format: "+'<span title="download the graph as a PNG formatted image" class="md-png rico export-chart">PNG</span>'+'<span title="download the graph as a SVG formatted vector graphic"class="md-svg rico export-chart">SVG</span>'+'<span title="download the graph as a PDF document" class="md-pdf rico export-chart">PDF</span>'+'<button class="download-data" title="Download the graph data as an Excel workbook">download data</button>'+"</fieldset>"+"</div>"+'<div class="sharing">'+"<fieldset>"+"<legend>&nbsp;Sharing&nbsp;</legend>"+'<div class="share-links">'+'<a href="#" class="post-facebook"><img src="images/icons/facebook.png" />facebook</a> '+'<a class="graph-email">email </a> '+'<button class="graph-link">link </button>'+'<button class="graph-embed">embed </button>'+"</div>"+'<div class="searchability">'+'<input type="radio" name="'+c+'-searchability" id="'+c+'-searchable" value="Y" '+(l.published=="Y"?"checked":"")+' /><label for="'+c+'-searchable">Public Graphs searchable</label>'+'<input type="radio" name="'+c+'-searchability" id="'+c+'-private" value="N" '+(l.published=="N"?"checked":"")+' /><label for="'+c+'-private">'+(account.info.orgName?"restrict to "+account.info.orgName:"private")+"</label>"+"</div>"+"</fieldset>"+"</div>"+'<br /><button class="graph-save">save</button> <button class="graph-saveas">save as</button> <button class="graph-close">close</button> <button class="graph-delete">delete</button><br />'+"</div>"+'<div class="chart-map-scroll-window">'+'<div class="mashabledata_chart-map" style="width:75%;display:inline;float:left;">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<div class="mashabledata_maptabs"></div>'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="display:none;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<button class="merge group hidden" disabled="disabled">group</button>'+'<button class="merge ungroup hidden" disabled="disabled">ungroup</button>'+"</div>"+"</div>"+"</div>"+'<div height="30px"><textarea style="width:98%;height:50px;margin-left:5px;" class="graph-analysis" maxlength="1000" /></div>'+"</div>"+"</div>"}b.html(_);V(l);var I,W;console.timeEnd("buildGraphPanel:thisPanel");console.time("buildGraphPanel:thisPanel events");if(T){b.find("div.mashabledata_graph-analysis").html(l.analysis)}else{b.find("button.provenance").button().click(function(){et.build();b.find("div.provenance").show();b.find("div.graph-chart").hide()});b.find("button.resize").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).click(function(){dt();if(l.controls.map)l.controls.map.remove();if(l.controls.chart){l.controls.chart.destroy();delete l.controls.chart;b.find(".mashabledata_chart").css("background-color","grey")}b.find("div.graph_control_panel").hide();b.find("div.resize").show();b.find(".mashabledata_chart, .mashabledata_cube-viz, .mashabledata_jvmap").resizable({helper:"ui-resizable-helper",resize:function(e,t){},stop:function(e,t){var a,n,i,s,o,r,c;a=b.find(".mashabledata_chart-map");n=b.find(".mashabledata_chart");i=b.find(".mashabledata_cube-viz");o=b.find(".mashabledata_jvmap");if(t.originalElement.hasClass("mashabledata_chart")){s=i.is(":visible")?1:0;r=o.is(":visible")?1:0;c=t.size.width-t.originalSize.width;if(s)i.width(i.width()+c/(s+r));if(r)o.width(o.width()+c/(s+r));a.width(a.width()+c);if(!l.mapconfig.sizes)l.mapconfig.sizes={}}if(t.originalElement.hasClass("mashabledata_cube-viz")){a.width(a.width()+t.size.width-t.originalSize.width);b.find(".mashabledata_jvmap").height(t.size.height).width(a.width()-t.size.width-10)}if(t.originalElement.hasClass("mashabledata_jvmap")){a.width(a.width()+t.size.width-t.originalSize.width);if(l.plots&&l.hasMapViz())b.find(".mashabledata_chart").width(a.width());b.find(".mashabledata_jvmap").height(t.size.height).width(t.size.width);if(l.hasMapViz())i.height(t.size.height).width(i.width()-t.size.width+t.originalSize.width)}l.mapconfig.sizes={};if(n.width()&&n.height()&&l.plots){l.mapconfig.sizes.chart={height:n.height(),width:n.width()}}if(o.width()&&o.height()&&(l.pointsets||l.mapsets)){l.mapconfig.sizes.map={height:o.height(),width:o.width()}}if(i.width()&&i.height()&&l.hasMapViz()){l.mapconfig.sizes.viz={height:i.height(),width:i.width()}}ct()}})});b.find("button.size_reset").button().click(function(){delete l.mapconfig.sizes;H()});b.find("button.size_set").button().click(H);function H(){$(".mashabledata_chart, .mashabledata_cube-viz, .mashabledata_jvmap").resizable("destroy");b.find("div.graph_control_panel").show();b.find("div.resize").hide();ct()}b.find("button.download-data").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){sa(c)});function Y(){var e=b.find("div.mashabledata_cube-viz table").get(0);var t=[];for(var a=0;a<e.rows.length;a++){t.push([e.rows[a].cells[0].innerHTML.replace("<br>",""),e.rows[a].cells[1].innerHTML,e.rows[a].cells[2].innerHTML])}ia({filename:l.title,data:JSON.stringify([{name:"ranked list",grid:t}]),url:"excel.php"})}b.find(".graph-analysis").val(l.analysis);b.find("select.download-selector").change(function(){if($(this).val()=="map"){if(!l.mapsets&&!l.pointsets){vt("no map","This graph does not have a map to download.  Maps are added to graphs by finding a series that belongs to a map set or a marker set and mapping the set.");$(this).val("chart")}}else{if(!l.plots){vt("no chart","This graph does not have a chart to download.");$(this).val("map")}}});b.find(".export-chart").click(function(){var e,t=$(this);if(t.hasClass("md-jpg"))e="image/jpeg";if(t.hasClass("md-png"))e="image/png";if(t.hasClass("md-svg"))e="image/svg+xml";if(t.hasClass("md-pdf"))e="application/pdf";ht(e)});b.find("a.post-facebook").click(function(){var e;if(l.mapsets||l.pointsets){e=na(tt.container.html(),l.mapconfig.mapBackground||a.mapBackground)}else{U.sync();e=l.controls.chart.getSVG()}$.ajax({type:"POST",url:"export/index.php",dataType:"json",data:{type:"FB",width:"800",svg:e},success:function(e,t,a){var n=o[c].analysis;var i=o[c].title;var s={method:"feed",link:"http://www.mashabledata.com/workbench#/t=g1&graphcode="+o[c].ghash,picture:e.imageURL,message:n,name:"MashableData visualization",caption:i,description:n};function r(e){alert("Post ID: "+e["post_id"])}FB.ui(s,r)},error:function(e,t,a){console.log(t)}})});b.find(".graph-email").button({icons:{secondary:"ui-icon-mail-closed"}}).click(function(){if(l.isDirty){vt("graph not saved","Please save the graph first so that links will show the graph as currently displayed.")}});function X(){if(l.ghash){var e="mailto: "+"?subject="+escape(l.title||"link to my MashableData visualization")+"&body="+escape((l.analysis||"Link to my interactive visualization on MashableData.com:")+"<br><br>http://www.mashabledata.com/workbench/#/t=g2&graphcode="+l.ghash);b.find(".email-link").attr("href",e);b.find(".graph-email").off().attr("href",e)}}X();b.find(".graph-embed").button({icons:{secondary:"ui-icon-script"}}).click(function(){if(l.isDirty){vt("graph not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var e='<div id="embed-info">'+'<button class="right" id="embed-info-close">close</button>'+'<b>link code: </b><span id="link-ghash">'+l.ghash+"</span><br><br>"+'<em>To preview the embedded graph and for instructions for embedding it on your website, please visit this <a href="/preview'+(a.isDev?"dev":"")+"?graphcode="+l.ghash+'" target="_blank">graph\'s preview page</a>. '+'<textarea id="link-html">&lt;div class=&quot;mashabledata_embed&quot; data=&quot;'+l.ghash+"&quot;&gt;&lt;/div&gt;</textarea>"+"</div>";$.fancybox(e,{width:600,height:"auto",showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#embed-info-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})});b.find(".graph-link").button({icons:{secondary:"ui-icon-link"}}).click(function(){if(l.isDirty){vt("Graph is not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var e=$(this).offset();var t='<div id="link-editor">'+'<button class="right" id="link-editor-close">close</button>'+'<button id="ghash-reset" class="ui-state-error right">reset link code</button>'+'<b>link code: </b><span id="link-ghash">'+l.ghash+"</span><br><br>"+"<em>The code below will create a link to your graph</em>"+'<textarea id="link-html">&lt;a href=&quot;http://www.mashabledata.com/workbench/#/t=g2&graphcode='+l.ghash+"&quot;&gt;"+(l.title||"MashableData graph")+"&lt;/a&gt;</textarea>"+"</div>";$.fancybox(t,{width:600,height:100,showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#link-editor-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()});$("#ghash-reset").button({icons:{secondary:"ui-icon-refresh"}}).click(function(){vt("confirm link code reset","If you have emailed a link to this graph or posted it on FaceBook or Twitter, those links will no longer work once the graph's link code is reset. Plese confirm to reset.",[{text:"Confirm",click:function(){$(this).dialog("close");$("#ghash-reset").button("disable");var e=l.ghash;l.resetHash(function(){var t=$("#link-html");t.html(t.html().replace(e,l.ghash));$("#link-ghash").html(l.ghash)})}},{text:"Cancel",click:function(){$(this).dialog("close")}}])})});b.find(".searchability").buttonset().find("#"+c+"-private").button("option","icons",{primary:"ui-icon-locked"}).end().find("#"+c+"-searchable").button("option","icons",{primary:"ui-icon-search"}).end().find("input").click(function(){l.published=$(this).val();dt()});if(l.start&&l.end){b.find(".rad-hard-crop").attr("checked",true)}else{if(l.intervals){b.find(".rad-interval-crop").attr("checked",true)}else{b.find(".rad-no-crop").attr("checked",true)}}var K=function(){var e=b.find(".crop-slider").slider("values");
b.find(".rad-hard-crop").attr("checked",true);l.intervals=null;if(l.controls.chart){l.start=l.controls.chart.options.chart.x[e[0]];l.end=l.controls.chart.options.chart.x[e[1]]}else{l.start=l.calculatedMapData.dates[e[0]].dt.getTime();l.end=l.calculatedMapData.dates[e[1]].dt.getTime()}ct()};var Z=function(e){var t=$(e).slider("values");if(l.controls.chart){return R(l.controls.chart.options.chart.x[t[0]],l.smallestPeriod)+" - "+R(I.options.chart.x[t[1]],l.smallestPeriod)}else{return R(l.calculatedMapData.dates[t[0]].dt.getTime(),l.calculatedMapData.freq)+" - "+R(l.calculatedMapData.dates[t[1]].dt.getTime(),l.calculatedMapData.freq)}};b.find("div.crop-slider").slider({range:true,stop:function(){K()},change:function(){if(l.controls.chart){b.find(".crop-dates").html(Z(this))}},slide:function(){b.find(".crop-dates").html(Z(this))}});$("#"+c+"-rad-interval-crop").change(function(){if($(this).val()=="on"){var e=parseInt(b.find("input.interval-crop-count").val());if(!e||e<1){e=1;b.find("input.interval-crop-count").val(e)}l.intervals=e;l.start=null;l.end=null;ct()}});$("#"+c+"-rad-no-crop").change(function(){l.intervals=null;l.start=null;l.end=null;l.minZoom=l.firstdt;l.maxZoom=l.lastdt;ct()});b.find("input.interval-crop-count").spinner({min:1,incrementalType:false,stop:function(e,t){l.start=null;l.end=null;if(l.intervals!=parseInt($(this).val())){l.intervals=parseInt($(this).val());ct()}}});b.find("button.graph-crop").click(function(){var e=o[c];e.start=e.minZoom>e.firstdt?e.minZoom:e.firstdt;e.end=e.maxZoom<e.lastdt?e.maxZoom:e.lastdt;$(this).attr("disabled","disabled");D(c);$("#"+c+"-rad-hard-crop").click()});b.find("div.annotations fieldset").height(b.innerHeight()-b.find("div.configuration").outerHeight()-b.find("div.downloads").outerHeight()-b.find("div.sharing").outerHeight()-50-30);b.find("input.graph-publish").change(function(){l.published=this.checked?"Y":"N"});b.find("select.graph-type").val(l.type).change(function(){if($(this).val()=="logarithmic"){for(var e=0;e<I.yAxis.length;e++){if(I.yAxis[e].getExtremes().dataMin<=0){b.find("select.graph-type").val(l.type);vt("Logarithmic scaling not available","Logarithmic Y-axis scaling is not allowed if negative values are present");return false}}}l.type=$(this).val();ct()});It(b.find("select.map-viz-select"),[],[],l);b.find("select.map-viz-select").change(function(){var e=$(this).val();if(!isNaN(e)){if(e!=l.cubeid){l.cubeid=e;delete l.assets.cube;l.cubename=this.options[this.selectedIndex].text;ct()}}else{if(e!=l.mapconfig.mapViz||"none"){delete l.cubeid;delete l.cubename;if(e=="none"){delete l.mapconfig.mapViz}else{l.mapconfig.mapViz=e}ct()}}});b.find("select.graph-map-mode").val(l.mapconfig.mapMode||"default").change(function(){if(this.value=="default"){delete l.mapconfig.mapMode}else{l.mapconfig.mapMode=this.value}ct()});b.find("select.change-basemap").html(st()).change(function(){var e=$(this);var t=l.clone();var a=e.val();e.val(l.map);t.changeMap(a,function(){J(t)})});ot()}var Q;if(!T){b.find(".graph-analysis").keydown(function(){o[c].analysis=this.value;dt()})}l.isDirty=!l.gid;if(!T){b.find("button.graph-save").button({icons:{secondary:"ui-icon-disk"},disabled:!l.isDirty}).click(ut);b.find("button.graph-saveas").button({icons:{secondary:"ui-icon-copy"},disabled:l.isDirty}).click(function(){delete l.gid;q.show(this,ut)});b.find("button.graph-close").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){$("ul#graph-tabs a[href=#"+c+"]").siblings("span").click()});b.find("button.graph-delete").button({icons:{secondary:"ui-icon-trash"},disabled:!l.gid}).addClass("ui-state-error").click(function(){vt("Permanently Delete Graph","Are you sure you want to delete this graph?",[{text:"Delete",id:"btn-dia-enable",click:function(){l.deleteGraph(function(e){if(e){$('#canvas a[href="#'+P()+'"]').closest("li").find("span").click();var t=N.find("td.title span.handle[data='G"+l.gid+"']").closest("tr");if(t.length==1){N.fnDeleteRow(t.get(0))}}});$(this).dialog("close")}},{text:"Cancel",id:"btn-dia-disable",click:function(){$(this).dialog("close")}}])})}console.timeEnd("buildGraphPanel:thisPanel events");O(l);o[c]=l;if(!T){console.time("buildGraphPanel:provController");var et=new ha(c);l.controls.provenance=et;console.timeEnd("buildGraphPanel:provController")}if(l.plots){console.time("buildGraphPanel:build annotations");I=C(c);U.build();console.timeEnd("buildGraphPanel:build annotations");b.find("div.highcharts-container").mousedown(function(e){if(e.which==3){}})}var tt=null,at,nt,it;console.time("buildGraphPanel:_drawMap");l.fetchMap(function(){lt();console.timeEnd("buildGraphPanel:_drawMap");D(c);console.timeEnd("buildGraphPanel: "+c);if(!T){Zt();Xt(l.ghash,b.get(0).id)}});function st(){if(!l.map)return"";var e,t,n,i='<option value="'+l.map+'">'+a.maps[l.map].name+"</option>",s=[];for(e in l.assets){if(e[0]=="M"&&l.assets[e].maps){if(Object.prototype.toString.call(l.assets[e].maps)=="[object String]")l.assets[e].maps=JSON.parse("{"+l.assets[e].maps+"}");for(n in l.assets[e].maps){if(n!=l.map){s.push(n)}}}}s.sort();for(t=0;t<s.length;t++){i+='<option value="'+s[t]+'">'+a.maps[s[t]].name+"</option>"}return i}function ot(){if(l.plots){b.find("div.graph-type").show()}else{b.find("div.graph-type").hide()}if(l.mapsets||l.pointsets){b.find("div.change-basemap, div.graph-map-mode, div.map-viz-select").show()}else{b.find("div.change-basemap, div.graph-map-mode, div.map-viz-select").hide()}var e="";if(l.plots)e+='<option value="chart">chart</option>';if(l.mapsets||l.pointsets)e+='<option value="map" selected>map</option>';if(l.hasMapViz())e+='<option value="cube">supplemental bar chart</option>';$(".download-selector").html(e)}function rt(){if(l.mapsets&&l.mapsets.length>1){var e=b.find("div.mashabledata_maptabs"),t=l.mapsets.length,a=parseInt(b.find(".mashabledata_jvmap").innerWidth()/t),n="",i;for(i=0;i<t;i++){n+='<div class="mashabledata_maptab'+(i==v?" mashabledata_activetab":"")+'" style="max-width: '+a+'px" data="'+i+'">'+l.mapsets[i].name()+"</div>"}e.html(n).show().find(".mashabledata_maptab").click(function(){var e=$(this).attr("data");if(e!=v){b.find("div.mashabledata_activetab").removeClass("mashabledata_activetab");$(this).addClass("mashabledata_activetab");v=e;lt()}})}else{b.find("div.mashabledata_maptabs").hide()}}function lt(){A=Y;if(l.map&&(l.mapsets||l.pointsets)){if(tt)tt.remove();console.time("buildGraphPanel:_drawMap:_setMapTabs");rt();console.timeEnd("buildGraphPanel:_drawMap:_setMapTabs");console.time("buildGraphPanel:_drawMap:_calcMap");g=ft(l,v);l.calculatedMapData=g;console.timeEnd("buildGraphPanel:_drawMap:_calcMap");console.time("buildGraphPanel:_drawMap:_calcAttributes");if(l.mapsets){l.mapsets[v].calculatedMapData=g;y=l.mapsets[v].mapMode();switch(y){case"heat":case"abs-change":case"percent-change":gt(l);break;case"min":case"max":bt(y);break;case"bubbles":case"change-bubbles":j();break;case"treemap":case"change-treemap":if(tt){tt.remove();tt=false}mt();break}}else{if(l.pointsets)gt(l)}console.timeEnd("buildGraphPanel:_drawMap:_calcAttributes");if(y!="treemap"&&y!="change-treemap"){console.time("buildGraphPanel:_drawMap:fillScaling+Scaling");var e=F(l.pointsets);var i=B(l.pointsets);console.timeEnd("buildGraphPanel:_drawMap:fillScaling+Scaling");console.time("buildGraphPanel:_drawMap:jvm call");var o=/us.._merc_en/.test(l.mapFile)?.9:1;var c={scale:o,x:.5,y:.5};at={map:l.mapFile,zoomMin:o,focusOn:c,backgroundColor:l.mapconfig.mapBackground||a.mapBackground,zoomOnScroll:false,zoomAnimate:true,markersSelectable:true,markerStyle:{initial:{r:l.mapconfig.maxRadius||5},selected:{"stroke-width":4,stroke:"yellow"}},regionStyle:{selected:{"stroke-width":2,stroke:"black",fill:"#ffff80"},hover:{"stroke-width":2,stroke:"black","fill-opacity":1}},series:{regions:[{attribute:"fill",scale:[l.mapsets&&l.mapsets[v].options.negColor||a.MAP_COLORS.NEG,a.MAP_COLORS.MID,l.mapsets&&l.mapsets[v].options.posColor||a.MAP_COLORS.POS],min:g.regionMin,max:g.regionMax}],markers:[{attribute:"r"},{attribute:"fill"},{attribute:"stroke"}]},onViewportChange:function(e,t){},onRegionOver:function(e,t){W(t,true)},onRegionOut:function(e,t){W(t,false)},onRegionTipShow:function(e,t,a){var i,s=[],o,r=yt(g.regionData,g.dates[nt].s);if(g.regionColors){var l=yt(g.regionColors,g.dates[nt].s);if(l&&typeof l[a]!="undefined"){for(i=0;i<g.dates.length;i++){if(g.regionData[g.dates[i].s]&&typeof g.regionData[g.dates[i].s][a]!="undefined"){s.push([g.dates[i].dt.getTime(),g.regionData[g.dates[i].s][a]]);if(i==nt)o=s.length-1}}var c=r[a];var d,p,u;switch(y){case"heat":d=typeof c=="undefined"?"no data available":n.numberFormat(c,parseInt(c)==c?0:2)+" "+(g.mapUnits||"");break;case"abs-change":p=yt(g.regionData,g.dates[g.startDateIndex].s);u=p[a];d=typeof c=="undefined"||typeof u=="undefined"?"no data available":(c-u>0?"+":"")+n.numberFormat(c-u,parseInt(c-u)==c-u?0:2)+" "+(g.mapUnits||"")+" from "+g.dates[g.startDateIndex].s;break;case"percent-change":p=yt(g.regionData,g.dates[g.startDateIndex].s);u=p[a];d=typeof c=="undefined"||typeof u=="undefined"?"no data available":n.numberFormat(100*(c-u)/u,1)+"% change from "+g.dates[g.startDateIndex].s;break}t.html("<div><b>"+tt.getRegionName(a)+"</b><br>"+g.title+":<br>"+d+'</div><div class="inlinesparkline" style="height: 30px;width: '+Math.min(400,10*s.length)+'px;margin:0 5px;"></div>').css("z-Index",400);var h={grid:{show:false}};var f=[{data:s,color:"#ddddff",lines:{lineWidth:.8,fill:true},shadowSize:0}];if(s.length<10)f.bars={show:true};if(typeof o!="undefined"){f.push({data:[s[o]],points:{show:true,radius:1,fillColor:"#ff0000"},color:"#ff0000"})}t.find("div.inlinesparkline").plot(f,h)}}},regionsSelectable:typeof l.mapsets!="undefined",markers:g.markers,onMarkerTipShow:function(e,t,a){var i,s=[],o,r=g.dates[nt].s,c=yt(g.markerData,r);for(i=0;i<g.dates.length;i++){if(typeof g.markerData[g.dates[i].s]!="undefined"){s.push([g.dates[i].dt.getTime(),g.markerData[g.dates[i].s][a].r||g.markerData[g.dates[i].s][a].f]);if(i==nt)o=s.length-1}}if(c&&c[a]){var d,p,u=c[a].r;if(N()){var h=[],f=a.split("+");for(i=0;i<f.length;i++){h.push(tt.getRegionName(f[i]))}d="<div>"+g.title+"<br><b>"+h.join(" + ")+"</b> "}else{d="<div><b>"+t.html()+":</b><br> "}if(l.mapsets&&y=="change-bubbbles"){var m=g.dates[g.startDateIndex].s;var b=yt(g.markerData,m);u=c[a].r;p=b[a].r;d+=(u-p>0?"+":"")+n.numberFormat(u-p,parseInt(u-p)==u-p?0:2)+" "+(g.radiusUnits||"")+" change from "+m+" to "+r+"<br>";d+=n.numberFormat(u,parseInt(u)==u?0:2)+" "+(g.radiusUnits||"")+" in "+r+"<br>";d+=n.numberFormat(p,parseInt(p)==p?0:2)+" "+(g.radiusUnits||"")+" in "+m+"<br>"}else{if(c[a].r)d+=n.numberFormat(c[a].r,parseInt(c[a].r)==c[a].r?0:2)+" "+(g.radiusUnits||"")+"<br>";if(c[a].f)d+=n.numberFormat(c[a].f,parseInt(c[a].f)==c[a].f?0:2)+" "+(g.fillUnits||"")+"<br>"}d+='</div><div class="inlinesparkline" style="height: 30px;width: '+Math.min(400,10*s.length).toString()+'px;margin:0 5px;"></div>';t.html(d).css("z-Index",400);var v={grid:{show:false}};var w=[{data:s,color:"#ddddff",lines:{lineWidth:.8,fill:true},shadowSize:0}];if(s.length<10)w.bars={show:true};if(typeof o!="undefined"){w.push({data:[s[o]],points:{show:true,radius:1,fillColor:"#ff0000"},color:"#ff0000"})}t.find("div.inlinesparkline").plot(w,v)}},onRegionClick:function(){},onRegionSelected:function(e,t,a){if(l.hasMapViz()){if(l.cubeid){V(t,a)}else{W(t,a)}}U();var n=tt.getSelectedMarkers();if(n.length>0){b.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("enable");return}var i=tt.getSelectedRegions();if(S.is(":visible")){for(var s=0;s<i.length;s++){if(g.regionColors){for(var o in g.regionColors){if(typeof g.regionColors[o][i[s]]!="undefined"){b.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("enable");return}break}}}b.find(".mashabledata_map-graph-selected.ui-button, .mashabledata_make-map.ui-button").button("disable")}},onMarkerSelected:function(e,t,a){at.onRegionSelected(e,t,a)},onZoom:function(e,t){transferTransform()}};if(tt)tt.remove();var d=b.find("div.mashabledata_jvmap");d.html("").vectorMap(at);tt=d.vectorMap("get","mapObject");if(l.mapconfig.showLegend)Y(tt)}else{tt=false}console.timeEnd("buildGraphPanel:_drawMap:jvm call");nt=g.endDateIndex;console.time("buildGraphPanel:mapControls");l.controls.map=tt;var m=$('<div class="mashabledata_map-date"></div>').prependTo(b.find("div.jvectormap-container"));var w=b.find("div.mashabledata_jvmap svg g:first");if(N()){L();tt.series.regions[0].setAttributes(g.regionsColorsForBubbles);b.find("button.merge").show()}var x=b.find(".mashabledata_map-slider");if(g.startDateIndex!=g.endDateIndex){if(x.hasClass("ui-slider"))x.slider("destroy");x.show().slider({value:g.endDateIndex,min:g.startDateIndex,max:g.endDateIndex,step:1,change:function(e,t){nt=t.value;H(nt);if(nt==g.endDateIndex){if(!tt.getSelectedRegions().length)$(".mashabledata_make-map.ui-button").button("disable")}else{$(".mashabledata_make-map.ui-button").button("enable")}}}).slider("value",g.endDateIndex)}else{x.hide();H(g.startDateIndex)}var S=b.find(".mashabledata_map-graph-selected");S.button(b.width()>650?{icons:{secondary:"ui-icon-image"}}:null).off().click(function(){var e=tt.getSelectedRegions();var a=tt.getSelectedMarkers();var n=new t.Graph,i,s,o,r,c,d,p,u,h,f,m,y,w,k;n.title="from map of "+l.title;for(o=0;o<a.length;o++){if(N()){i=$.extend(true,{},l.mapsets[v]);delete i.formula;delete i.options.calculatedFormula;f=i.components;i.components=[];p=a[o].split("+");u=[];for(r=0;r<p.length;r++){u.push(tt.getRegionName(p[r]));for(c=0;c<f.length;c++){if(f[c].handle[0]=="M"){w=$.extend({units:l.assets[f[c].handle()].units,period:l.assets[f[c].handle()].freq},l.assets[f[c].handle()].data[p[r]]);y=$.extend(true,{},f[c]);y.handle=w.handle;n.assets[w.handle()]=w;i.components.push(y)}else{i.components.push($.extend(true,{},f[c]));n.assets[f[c].handle()]=l.assets[f[c].handle()]}}}i.options.name=l.mapsets[v].name()+" for "+u.join("+");n.plots.push(i)}else{for(d=0;d<l.pointsets.length;d++){h=$.extend(true,{},l.pointsets[d]);k=false;m=h.components;for(c=0;c<m.length;c++){if(m[c].isPointSet()&&l.assets[m[c].handle()].data[a[o]]){k=true;var x=l.assets[m[c].handle()].data[a[o]].handle;n.assets[x]=$.extend({units:l.assets[m[c].handle()].units,freq:l.assets[m[c].handle()].freq,freqs:l.assets[m[c].handle()].freqs},l.assets[m[c].handle()].data[a[o]]);m[c].handle=x}else{n.assets[m[c].handle()]=l.assets[m[c].handle()]}}if(k)n.plots.push(h)}}}if(l.mapsets){var S,M,C,_,D,A;for(o=0;o<e.length;o++){if(typeof g.regionColors[g.dates[nt].s][e[o]]!="undefined"){S=l.mapsets[v];_=[];S.eachComponent(function(){M=this;C=M.clone();if(M.isMapSet()){D=l.assets[M.handle()];A=D.data[e[o]];C.geoname=A.geoname;C.geoid=A.geoid;C.parsedData(A.data);C.firstdt=A.firstdt;C.lastdt=A.lastdt}_.push(C)});n.addPlot(_,{userFormula:S.userFormula})}}}if(n.plots&&n.plots.length){if(T){t.plugin.popGraph(n)}else{$("#quick-view-select-viz").val("none").hide();Tt(n,l.map,true)}}else{b.find(".mashabledata_make-map").click()}});var M=b.find(".mashabledata_map-play");if(g.startDateIndex!=g.endDateIndex){M.off().click(function(){var e,t,a,n=Math.min(1e4/g.dates.length,500);if(M.attr("title")=="play"){M.button({text:false,icons:{primary:"ui-icon-pause"}}).attr("title","pause");i()}else{M.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}function i(){if(M.attr("title")=="pause"){e=new Date;var s=x.slider("value")+1;if(s>g.endDateIndex)s=g.startDateIndex;x.slider("value",s);t=new Date;a=Math.max(1,n-(t.getTime()-e.getTime()));if(s==g.endDateIndex){M.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}else{if(M.attr("title")=="pause"){window.setTimeout(i,a)}}}}}).button({text:false,icons:{primary:"ui-icon-play"}});b.find(".mashabledata_map-step-backward").off().click(function(){x.slider("value",x.slider("value")-1)}).button({text:false,icons:{primary:"ui-icon-seek-first"}});b.find(".mashabledata_map-step-forward").off().click(function(){x.slider("value",x.slider("value")+1)}).button({text:false,icons:{primary:"ui-icon-seek-end"}})}else{M.hide();b.find(".mashabledata_map-step-backward, .mashabledata_map-step-forward").hide()}if(!l.plots)b.find("h3.mashabledata_map-title").html(l.title).click(function(){if(!T)q.show(this)});var C=false;b.find(".mashabledata_make-map").button(b.width()>650?{icons:{secondary:"ui-icon-arrowrefresh-1-s"}}:null).off().click(function(){C=true;tt.clearSelectedMarkers();tt.clearSelectedRegions();C=false;if(l.controls.vizChart)l.controls.vizChart.redraw();x.slider("value",g.endDateIndex);b.find(".mashabledata_map-graph-selected, .mashabledata_make-map.ui-button").button("disable")});if(T){var _=Math.max(100,b.find(".mashabledata_map-controls").outerWidth(true)-b.find(".mashabledata_map-step-backward").outerWidth(true)-M.outerWidth(true)-b.find(".mashabledata_map-step-forward").outerWidth(true)-b.find(".mashabledata_map-graph-selected").outerWidth(true)-b.find(".mashabledata_make-map").outerWidth(true)-30);x.width(_)}else{b.find("button.group").button({icons:{secondary:"ui-icon-circle-plus"}}).off().click(function(){if(it.newMerge){if(!l.mapsets[v].options.merges)l.mapsets[v].options.merges=[];l.mapsets[v].options.merges.push(tt.getSelectedRegions())}if(it.growable){var e,t,a=[];var n=tt.getSelectedMarkers();var i=tt.getSelectedRegions();for(e=0;e<n.length;e++){a=a.concat(n[e].split("+"));if(n[e].split("+").length>1){for(t=0;t<l.mapsets[v].options.merges.length;t++){if(n[e]==l.mapsets[v].options.merges[t].join("+")){l.mapsets[v].options.merges.splice(t,1);break}}}}for(e=0;e<i.length;e++){for(t=0;t<l.mapsets[v].options.merges.length;t++){if(l.mapsets[v].options.merges[t].indexOf(i[e])>-1){a=a.concat(l.mapsets[v].options.merges.splice(t,1)[0]);break}}}for(e=0;e<i.length;e++){if(a.indexOf(i[e])==-1)a.push(i[e])}l.mapsets[v].options.merges.push(a)}tt.removeAllMarkers();tt.clearSelectedRegions();j();L();tt.series.markers[0].setAttributes(yt(g.markerAttr.r,g.dates[nt].s));tt.series.markers[2].setAttributes(yt(g.markerAttr.stroke,g.dates[nt].s));tt.series.regions[0].setAttributes(g.regionsColorsForBubbles);dt()});b.find("button.ungroup").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).off().click(function(){var e,t;var a=tt.getSelectedMarkers();var n=tt.getSelectedRegions();for(e=0;e<a.length;e++){if(a[e].split("+").length>1){for(t=0;t<l.mapsets[v].options.merges.length;t++){if(a[e]==l.mapsets[v].options.merges[t].join("+")){l.mapsets[v].options.merges.splice(t,1);break}}}}for(e=0;e<n.length;e++){for(t=0;t<l.mapsets[v].options.merges.length;t++){pos=l.mapsets[v].options.merges[t].indexOf(n[e]);if(pos!=-1){l.mapsets[v].options.merges[t].splice(pos,1);if(l.mapsets[v].options.merges[t].length==0){l.mapsets[v].options.merges.splice(t,1)}break}}}tt.removeAllMarkers();tt.clearSelectedRegions();j();L();tt.series.markers[0].setAttributes(yt(g.markerAttr.r,g.dates[nt].s));tt.series.markers[2].setAttributes(yt(g.markerAttr.stroke,g.dates[nt].s));tt.series.regions[0].setAttributes(g.regionsColorsForBubbles);dt()})}var D=false,A;b.find("input.mashabledata_legend").change(function(){l.mapconfig.showLegend=$(this).prop("checked");dt();if(l.mapconfig.showLegend){D=A(tt)}else{D.remove()}});console.timeEnd("buildGraphPanel:mapControls")}function U(){var e,t,a;it={newMerge:false,growable:false,splinter:false,ungroupable:false};if(!N())return;var n=tt.getSelectedMarkers();var i=tt.getSelectedRegions();for(e=0;e<n.length;e++){if(n[e].split("+").length>1){it.ungroupable=true;break}}if(l.mapsets[v].options.merges){for(e=0;e<i.length;e++){for(t=0;t<l.mapsets[v].options.merges.length;t++){if(l.mapsets[v].options.merges[t].indexOf(i[e])>=0){it.ungroupable=true;break}}}}if(n.length>1){it.growable=true}else{if(n.length==1){a=n[0].split("+");for(e=0;e<i.length;e++){if(a.indexOf(i[e])==-1){it.growable=true;break}}}else{if(i.length>1){if(it.ungroupable){it.growable=true}else{it["newMerge"]=true}}}}b.find("button.group").button(it.newMerge||it.growable?"enable":"disable");b.find("button.ungroup").button(it.ungroupable?"enable":"disable")}function P(e,t){var a=[],n,i,s;if(e=="new"){if(l.mapsets){i=g.mapUnits;var o=yt(g.regionData,g.dates[nt].s);for(n in o){if(o[n]!==null&&tt.mapData.paths[n]){a.push({name:tt.getRegionName(n),value:o[n],id:n})}}}else{if(g.fillUnits){i=g.fillUnits;s="f"}else{i=g.radiusUnits;s="r"}var r=yt(g.markerData,g.dates[nt].s);for(n in r){if(r[n][s]!==null){a.push({name:g.markers[n].name,value:r[n][s],id:n})}}}a.sort(function(e,t){return(l.mapconfig.mapViz=="list-desc"?-1:1)*(e.value-t.value)});var c='<div class="mashabledata_map-list"><table><thead><th>Rank <br>'+m.html()+"</th><th>"+g.title+"</th><th>"+i+"</th></thead><tbody>";for(var d=0;d<a.length;d++){c+='<tr data="'+a[d].id+'"><td>'+(d+1)+"</td><td>"+a[d].name+"</td><td>"+a[d].value+"</td></tr>"}c+="</tbody></table></div>";var p=b.find(".mashabledata_cube-viz").html(c).find("tbody tr").hover(function(){var e=$(this).attr("data");if(e&&e!="undefined"){tt.setSelectedRegions(e)}},function(){var e=$(this).attr("data");if(e&&e!="undefined"){var t={};t[e]=false;tt.setSelectedRegions(t)}}).end().innerHeight();b.find(".mashabledata_cube-viz tbody").css("height",p-b.find(".mashabledata_cube-viz thead").height()+"px")}if(t){b.find(".mashabledata_cube-viz table tr").removeClass("ui-selected").find("tr[data='"+t+"']").addClass("ui-selected")}}function N(){return l.mapsets&&(y=="bubbles"||y=="change-bubbles")}function j(){var e,t,n,i=u.concat(p);g.regionsColorsForBubbles={};g.markers={};var s={x:100,y:100};if(N()){var o,c,d=0,h,m,b=[];var w,k,x={},S={r:{},stroke:{}},M,C,_;mt();for(h=g.startDateIndex;h<=g.endDateIndex;h++){e=g.dates[h].s;x[e]={};S.r[e]={};S.stroke[e]={}}g.markerDataMin=Number.MAX_VALUE;g.markerDataMax=Number.MIN_VALUE;var D=l.mapsets[v].options;var T=g.dates[g.startDateIndex].s;if(D.merges){for(d=0;d<D.options.merges.length;d++){w=D.options.merges[d];k=w.join("+");n=g.title+" for "+k;g.markers[k]={name:k,point:s,style:{fill:"pink"}};for(h=g.startDateIndex;h<=g.endDateIndex;h++){c=0;for(m=0;m<w.length;m++){c+=g.regionData[g.dates[h].s][w[m]]||0}if(y=="change-bubbles"){M=c-x[T][k][r]}else{M=c}x[g.dates[h].s][k]={r:c};if(c!==null){g.markerDataMin=Math.min(g.markerDataMin,M);g.markerDataMax=Math.max(g.markerDataMax,M)}}for(m=0;m<w.length;m++){g.regionsColorsForBubbles[w[m]]=i[d%i.length]}b=b.concat(w)}}for(o in g.regionData[g.dates[0].s]){if(b.indexOf(o)==-1&&typeof g.regionData[g.dates[0].s][o]!="undefined"){g.markers[o]={name:o,point:s,style:{fill:"pink"}};g.regionsColorsForBubbles[o]=a.MAP_COLORS.MID;_=null;for(h=g.startDateIndex;h<=g.endDateIndex;h++){e=g.dates[h].s;x[e][o]={r:g.regionData[e][o]};if(x[e][o].r!==null&&!isNaN(x[e][o].r)){if(h==g.startDateIndex)_=x[e][o].r;if(y=="change-bubbles"&&_!==null&&!isNaN(_)){g.markerDataMin=Math.min(g.markerDataMin,x[e][o].r-_);g.markerDataMax=Math.max(g.markerDataMax,x[e][o].r-_)}else{g.markerDataMin=Math.min(g.markerDataMin,x[e][o].r);g.markerDataMax=Math.max(g.markerDataMax,x[e][o].r)}}}}}var A,U=(l.mapconfig.maxRadius||f)/Math.sqrt(Math.max(Math.abs(g.markerDataMax),Math.abs(g.markerDataMin)));for(e in x){for(t in x[e]){C=x[e][t].r;if(y=="change-bubbles"){_=x[T][t].r;A=!isNaN(C)&&!isNaN(_)&&C!==null&&_!==null?C-_:null}else{A=C||null}S.r[e][t]=U*Math.sqrt(Math.abs(A));S.stroke[e][t]=A<0?"#ff0000":"#000000"}}g.markerData=x;g.markerAttr=S;g.radiusUnits=g.mapUnits}}function O(e){var t,a=0,n=0,i=0,s,o,r;for(var c=0;c<e.length;c++){r=null;$.each(l.mapsets[v].components,function(t,a){if(l.assets[a.handle()].data[e[c]]&&a.handle[0]=="M"&&l.assets[a.handle()].data[e[c]].latLon){r=l.assets[a.handle()].data[e[c]].latLon.split(",")}});t=w.find("path[data-code="+e[c]+"]").get(0).getBBox();if(r){o=tt.latLngToPoint(r[0],r[1]);n+=(o.x-tt.transX)*t.width*t.height/tt.scale;i+=(o.y-tt.transY)*t.width*t.height/tt.scale}else{n+=(t.x+t.width/2)*t.width*t.height;i+=(t.y+t.height/2)*t.width*t.height}a+=t.width*t.height}s={x:(n/a+tt.transX)*tt.scale,y:(i/a+tt.transY)*tt.scale};return s}function L(){var e,t;if(N()){var a,n=0,i,s=[];if(l.mapsets[v].options.merges){for(n=0;n<l.mapsets[v].options.merges.length;n++){e=O(l.mapsets[v].options.merges[n]);t=tt.pointToLatLng(e.x,e.y);g.markers[l.mapsets[v].options.merges[n].join("+")].latLng=[t.lat,t.lng];s=s.concat(l.mapsets[v].options.merges[n])}}w.find("path[data-code]").each(function(){a=$(this).attr("data-code");if(s.indexOf(a)==-1&&typeof g.regionData[g.dates[0].s][a]!="undefined"){e=O([a]);t=tt.pointToLatLng(e.x,e.y);g.markers[a].latLng=[t.lat,t.lng]}});tt.addMarkers(g.markers)}}function W(e,t){if(l.hasMapViz()&&!l.cubeid){var a=l.mapsets[v],n=tt.getSelectedRegions(),i,s;if(e&&t&&n.indexOf(e)===-1)n.push(e);var o=G(n,l,a,l.mapconfig.mapViz=="line-bunnies"||l.mapconfig.mapViz=="line-bunnies");switch(l.mapconfig.mapViz){case"scatter":if(o.length){for(m=0;m<o.length;m++){var r=l.controls.vizChart.get(o[m].code);if(r&&r.select)r.select(true,m>0)}}else{var c=l.controls.vizChart.getSelectedPoints();for(m=0;m<c.length;m++){c[m].select(false)}}break;case"line":case"line-bunnies":var d,p=g.dates[nt].s,u;var h,f=l.calculatedMapData.regionData;var m,y,w=[],x=l.controls.vizChart,S=false;for(m=0;m<o.length;m++){s=o[m].code;if(w.indexOf(s)===-1){if(!x.get(s)){y={id:s,name:o[m].geoname,data:[]};for(h in f){if(typeof f[h][s]!="undefined")y.data.push([k(h).getTime(),f[h][s]])}y.data.sort(function(e,t){return e[0]-t[0]});x.addSeries(y,false);S=true}w.push(s)}}for(m=0;m<x.series.length;m++){y=x.series[m];if(w.indexOf(y.userOptions.id)===-1){y.remove(false);S=true}}if(S)x.redraw();break;case"components-bar":break;case"components-line":break;case"list-asc":case"list-desc":b.find("div.mashabledata_map-list tr.mashabledata_map-list-selected").removeClass("mashabledata_map-list-selected");for(m=0;m<o.length;m++){s=o[m].code;b.find("div.mashabledata_map-list tr[data='"+s+"']").addClass("mashabledata_map-list-selected")}break}}}function V(e,t){console.time("_drawMap_makeMakeViz");if(!l.hasMapViz())return;if(!l.cubeid&&(l.mapconfig.mapViz=="list-asc"||l.mapconfig.mapViz=="list-desc")){P(e?false:"new",e);return}var a=l.mapsets[v];var i,o=g.dates[nt].s,r;var c=tt.getSelectedRegions();if(e){i=e}else{i=null;if(c.length>0){i=c[0]}else{var d=tt.getSelectedMarkers();if(d.length>0){i=d[0]}else{i=l.bunny||s[l.map].bunny}}}if(!l.cubeid&&(l.mapconfig.mapViz=="line"||l.mapconfig.mapViz=="line-bunnies")){var p={title:a.name(),xaxis:"time"};if(e&&t&&c.indexOf(e)===-1)c.push(e);var u={chart:{type:"line",spacingRight:50,renderTo:l.controls.$thisPanel.find(".mashabledata_cube-viz")[0]},title:{text:a.name(),style:{fontSize:"12px"}},subtitle:{text:"click on map to compare locations",style:{fontSize:"10px"}},xAxis:{type:"datetime"},yAxis:{title:{text:a.units()}},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{formatter:function(){return"<b>"+a.name()+"</b><br/>"+this.id+":<br/>"+n.numberFormat(Math.abs(this.point.y),0)+" "+a.units()}}};var h,f=l.calculatedMapData.regionData;var b=G(c,l,a,l.mapconfig.mapViz=="line-bunnies");var y,w=[],x;for(W=0;W<b.length;W++){x=b[W].code;if(w.indexOf(x)===-1){y={id:x,name:b[W].geoname,data:[]};for(h in f){if(typeof f[h][x]!="undefined")y.data.push([k(h).getTime(),f[h][x]])}y.data.sort(function(e,t){return e[0]-t[0]});u.series.push(y);w.push(x)}}if(l.controls.vizChart)l.controls.vizChart.destroy();l.controls.vizChart=new Highcharts.Chart(u)}if(!l.cubeid&&l.mapconfig.mapViz=="scatter"&&l.mapsets.length==2){var S=l.mapsets[0],M=l.mapsets[1],_=[];if(!S.calculatedMapData)ft(l,0);if(!M.calculatedMapData)ft(l,1);var D=yt(S.calculatedMapData.regionData,o),T=yt(M.calculatedMapData.regionData,o);for(r in D){if(T[r]&&jvm.Map.maps[l.mapFile].paths[r]){_.push({id:r,x:D[r],y:T[r]})}}function A(e,t){var a={};a[e.id]=t;tt.setSelectedRegions(a)}var U=S.name(),$=M.name(),I=S.units(),N=M.units(),F={chart:{type:"scatter",spacingRight:50,renderTo:l.controls.$thisPanel.find(".mashabledata_cube-viz").get(0)},title:{text:""},subtitle:{text:"click on map or scatter plot to compare"},series:[{data:_.sort(function(e,t){return e.x-t.x}),name:U+" vs. "+$}],exporting:{enabled:false},tooltip:{formatter:function(){return"<b>"+tt.getRegionName(this.point.id)+"</b><br/><br/>"+"<b>"+U+":</b><br/>"+n.numberFormat(this.point.x,0)+" "+I+"<br/><br/>"+"<b>"+$+":</b><br/>"+n.numberFormat(this.point.y,0)+" "+N},useHTML:true,style:{"max-width":"200px"}},plotOptions:{series:{point:{events:{mouseOver:function(){A(this,true)},mouseOut:function(){A(this,false)}}}}},legend:{enabled:false},xAxis:{title:{text:S.name()+"<br>"+S.calculatedMapData.mapUnits+""}},yAxis:{title:{x:-20,text:M.name()+"<br>"+M.calculatedMapData.mapUnits+""}}};l.controls.vizChart=new Highcharts.Chart(F)}if(parseInt(l.cubeid)||(l.mapconfig.mapViz=="components-bar"||l.mapconfig.mapViz=="components-line")){if(l.mapconfig.mapViz=="sum"){if(!isNaN(i))i="G"+i;var j=a.calculatedFormula;var B=j.numFormula.replace("-","+-").split("+");var q=j.numFormula.replace("-","+").split("+");var O,L,E={},W,V=[],H,Y={},X={};a.eachComponent(function(e){O=l.assets[this.handle()];if(this.isMapSet()){H=a.compSymbol(e);E[H]=O.data[i]?O.data[i].data:null;X[H]=O.name}});for(W=q.length-1;W>=0;W--){if(q[W].trim()=="")q.splice(W,0,1);else V.unshift(X[q[W].trim()].split(" "))}var K=[],Z=true,J=true;while(Z&&J){for(W=0;W<V.length;W++){while(V[W].length>0&&V[W][0]=="")V[W].shift();while(V[W].length>0&&V[W][V[W].length-1]=="")V[W].pop();if(V[W].length>0){if(V[W][0]!=V[0][0])Z=false;if(V[W].length>1){if(V[W][V[W].length-1]!=V[0][V[0].length-1])J=false}}else{Z=J=false;break}}if(Z)K.unshift(V[0][0]);if(J)K.push(V[0][V[0].length-1]);for(W=0;W<V.length;W++){if(Z)V[W].shift();if(J)V[W].pop()}}var et=[];l.assets.cube={dimensions:[{list:[]}]};var at=l.assets.cube;at.theme=K.join(" ");at.name="";at.units=a.units();at["G"+i]={facetedData:[]};for(W=0;W<V.length;W++){at.dimensions[0].list.push({name:V[W].join(" ")});at["G"+i].facetedData[W]=E[q[W].trim()]}}var it="new";if(Q){if(e){it=t?"add":"remove"}else{it="summation"}}z(l,v,i,o,it);console.time("vizChart.redraw");if(!C&&it=="remove")l.controls.vizChart.redraw();console.timeEnd("vizChart.redraw")}m.html(R(g.dates[nt].dt.getTime(),g.freq));console.timeEnd("_drawMap_makeMakeViz")}function H(t){if(l.mapsets){switch(y){case"heat":case"abs-change":case"percent-change":case"correlation":tt.series.regions[0].setAttributes(yt(g.regionColors,g.dates[t].s));break;case"bubbles":case"change-bubbles":tt.series.markers[0].setAttributes(yt(g.markerAttr.r,g.dates[t].s));tt.series.markers[2].setAttributes(yt(g.markerAttr.stroke,g.dates[t].s));break;case"treemap":if(tt){tt.remove();tt=false}fa(b.find("div.mashabledata_jvmap").html(""),l.mapsets[v].calculatedMapData,l.mapFile,l.mapsets[v].calculatedMapData.dates[t].s);break;case"change-treemap":if(tt){tt.remove();tt=false}fa(b.find("div.mashabledata_jvmap").html(""),l.mapsets[v].calculatedMapData,l.mapFile,l.mapsets[v].calculatedMapData.dates[t].s,l.mapsets[v].calculatedMapData.dates[0].s);break}}if(l.pointsets){if(i){tt.series.markers[0].setAttributes(yt(g.markerAttr.r,g.dates[t].s));tt.series.markers[2].setAttributes(yt(g.markerAttr.stroke,g.dates[t].s))}if(e){tt.series.markers[1].setAttributes(yt(g.markerAttr.fill,g.dates[t].s))}}if(l.plots){var a=I.xAxis[0];a.removePlotLine("timeLine");a.addPlotLine({value:g.dates[t].dt,color:"red",width:2,id:"timeLine"})}V()}function Y(e){var t=10,a=5,n=20,i=10,o,r,c=0,d=0,p=0,u,m,y,w=20;if(l.mapsets&&!N()){if(l.mapsets[v].options.scale=="discrete"){r=185;c=n+2*i+l.mapsets[v].options.discreteColors.length*(i+20)}else{r=100;if(g.regionMin<0&&g.regionMax>0){c=6*i+2*80+4*n}else{c=4*i+80+3*n}}}else r=0;var k=B(l.pointsets),x=F(l.pointsets);if(l.pointsets||N()){o=185;if(k>1&&x==0){d+=k*(i+2*t)+(d==0?i:0)}if(k>0||N()){var S=parseInt(l.mapconfig.maxRadius)||f;var M=+S/Math.sqrt(10);d+=2*(i+Math.max(S,15)+M)+(d==0?i:0)}}else o=0;var C=e.canvas.addGroup();e.canvas.addCircle({cx:0,cy:0},{initial:{r:20,"fill-opacity":0,"stroke-width":0}},C);
b.append('<div id="dummyLegend" class="hidden"></div>');var _=new Highcharts.Renderer($("#dummyLegend")[0],e.width,e.height);_.box=C.node;$("#dummyLegend").remove();var D=l.mapconfig.legendLocation||s[l.map].legend||"TR";switch(D.substr(0,1)){case"T":m=i;break;case"C":m=(e.height-Math.max(d,c))/2-i;break;case"B":m=e.height-Math.max(d,c)-i}switch(D.substr(1,1)){case"L":y=i;if(D.substr(0,1)=="T")y+=30;break;case"C":y=(e.width-r-o)/2-i;break;case"R":y=e.width-r-o-i}_.rect(y,m,o+r,Math.max(d,c),5).attr({fill:"white",opacity:.5,"stroke-width":0}).add();var T={opacity:1,"stroke-width":0,"z-index":1e3};if(l.pointsets||N()){if(k>1&&x==0){$.each(l.pointsets,function(e){if(this.options.attribute!="fill"){p=(e+1)*(i+2*t)-t;_.circle(y+i+t,m+p,Math.min(S,t)).attr({fill:this.options.color,opacity:1,"fill-opacity":1,stroke:"black","stroke-width":1}).add();_.text(l.pointsets[e].name().substring(0,w),y+2*(i+t),m+p).add()}p+=t})}if(k>0||N()){p+=i+(M||5);var A={"fill-opacity":0,opacity:1,stroke:"black","stroke-width":1};_.circle(y+i+S,m+p,M).attr(A).add();_.text(E((g.radiusScale||g.markerDataMax)/10),y+2*(S+i),m+p).css({fontSize:"12px"}).add();p+=(M||5)+i+S;_.circle(y+i+S,m+p,S).attr(A).add();_.text(E(g.radiusScale||g.markerDataMax),y+2*(S+i),m+p).css({fontSize:"12px"}).add();_.text(g.radiusUnits,y+2*(S+i),m+p+2*i).css({fontSize:"12px"}).add()}}if(l.mapsets&&!N()){if(l.mapsets[v].options.scale!="discrete"&&l.mapsets[v].options.logMode=="on")_.text("log scale",y+i,m+2*n).css({fontSize:"12px"}).add();if(l.mapsets[v].options.scale=="discrete"){for(u=0;u<l.mapsets[v].options.discreteColors.length;u++){p=i+(l.mapsets[v].options.discreteColors.length-u)*(i+20);_.rect(y+o+i,m+p,n,n,0).attr({fill:l.mapsets[v].options.discreteColors[u].color,opacity:1,stroke:"black","stroke-width":1}).add();_.text((u==l.mapsets[v].options.discreteColors.length-1?"&gt; ":" ")+l.mapsets[v].options.discreteColors[u].cutoff,y+o+i+n+i,m+p+n/2+a).css({fontSize:"12px"}).add()}}else{p+=2*n;_.text(E(g.regionMax),y+o+i,m+p+n/2+a).css({fontSize:"12px"}).add();p+=n+i;if(g.regionMax>0){U(y+o+i,m+p,l.mapsets[v].options.posColor||h.POS,h.MID);p+=80+i;if(g.regionMin<0){_.text("0",y+o+i,m+p+n/2+a).css({fontSize:"12px"}).add();p+=n+i}}if(g.regionMin<0){U(y+o+i,m+p,h.MID,l.mapsets[v].options.negColor||h.NEG);p+=80+i}_.text(E(g.regionMin),y+o+i,m+p+n/2+a).css({fontSize:"12px"}).add();p+=n+i}}return C;function U(e,t,a,n){var i,s,o,r,l,c,d,p,u;i=parseInt(a.substr(1,2),16);s=parseInt(a.substr(3,2),16);o=parseInt(a.substr(5,2),16);r=parseInt(n.substr(1,2),16);l=parseInt(n.substr(3,2),16);c=parseInt(n.substr(5,2),16);for(var h=0;h<40;h++){d=Math.round(i-(i-r)*h/39).toString(16);p=Math.round(s-(s-l)*h/39).toString(16);u=Math.round(o-(o-c)*h/39).toString(16);_.rect(e,t+2*h,20,2,0).attr({fill:"#"+(d.length==1?"0":"")+d+(p.length==1?"0":"")+p+(u.length==1?"0":"")+u,opacity:1,"stroke-width":0,"z-index":1e3}).add()}}}A=Y}function ct(){Qt("redrawing");setTimeout(function(){Wt(c);V(l);if(l.plots){O(l);I=C(c);U.build()}ot();if(l.mapsets||l.pointsets){l.fetchMap(lt);if(l.plots)b.find("map-title").hide();else b.find("map-title").show();b.find("select.change-basemap").html(st())}Zt()},10)}function dt(){l.isDirty=true;b.find(".graph-save").button("enable")}function pt(){l.isDirty=false;b.find(".graph-save").button("disable")}function ut(){l.save();b.find("button.graph-delete, button.graph-saveas").button("enable");pt()}function ht(e){switch(b.find("select.download-selector").val()){case"map":aa(c,e);break;case"chart":U.sync();I._exportChart({type:e,width:2e3});break;case"cube":l.controls.vizChart._exportChart({type:e,width:2e3});break}}function ft(e,t){var a,i,s,o={},r=[],l={},c;var p={};var u={};var h={},f,m,g,b,v,y,w,S,M,C,_;var D,T;var A={};var U,$,I,P,N,R,F,j;if(e.mapsets){var B=e.mapsets[t];var q=B.formula();U="return "+q.replace(d,"values.$1")+";";var O=new Function("values",U);$=[];P={};N=B.components;j={};var E=[];for(m=0;m<N.length;m++){F=B.compSymbol(m);$.push(F);if(N[m].isMapSet()){for(I in e.assets[N[m].handle()].data){if(!P[I]){P[I]=true;E.push({geo:I,name:e.assets[N[m].handle()].geoname})}R=e.assets[N[m].handle()].data[I].data.split("|");for(g=0;g<R.length;g++){b=R[g].split(":");if(!j[b[0].toString()]){j[b[0].toString()]={}}if(!j[b[0].toString()][F]){j[b[0].toString()][F]={}}j[b[0].toString()][F][I]=b[1]===null||b[1]=="null"?null:parseFloat(b[1])}}}else{R=e.assets[N[m].handle()].data.split("|");for(g=0;g<R.length;g++){b=R[g].split(":");if(!j[b[0].toString()]){j[b[0].toString()]={}}j[b[0].toString()][F]=b[1]===null||b[1]=="null"?null:parseFloat(b[1])}}}var z=!B.options.componentData||B.options.componentData=="required";var G=B.options.componentData=="missingAsZero";var W=B.options.componentData=="nullsMissingAsZero";var V=!B.options.breaks||B.options.breaks=="never";var H=B.options.breaks=="nulls";var Y=B.options.breaks=="missing";a=B.name();i=e.assets[N[0].handle()].freq;s=B.units();for(c in j){D=Number.MAX_VALUE;T=Number.MIN_VALUE;S=false;for(I in P){M={};_=true;C=false;for(m=0;m<$.length;m++){if(!isNaN(j[c][$[m]])){M[$[m]]=parseFloat(j[c][$[m]])}else{if(j[c][$[m]]=="null"){if(W){M[$[m]]=0}else{_=null;break}}else{if(j[c][$[m]]&&!isNaN(j[c][$[m]][I])){if(j[c][$[m]][I]=="null"){if(W){M[$[m]]=0}else{_=null;break}}else{M[$[m]]=j[c][$[m]][I];C=true}}else{if(z){_=null;break}else{M[$[m]]=0}}}}}if(C){if(_){try{_=O(M);if(Math.abs(_)==Infinity||isNaN(_))_=null}catch(X){_=null}}if(_!==null){_=x(_);if(!u[c])u[c]={};u[c][I]=_;S=true;D=Math.min(D||_,_);T=Math.max(T||_,_)}}}if(S){o[c]={regionMin:D,regionMax:T}}else{delete u[c]}}}var K,Z;if(e.pointsets){var Q,J={},et;var tt=0,at,nt,it;for(m=0;m<e.pointsets.length;m++){at=e.pointsets[m];if(!at.options.color)at.options.color=L(e.pointsets);U="return "+at.formula().replace(d,"values.$1")+";";var st=new Function("values",U);$=[];N=at.components;j={};for(g=0;g<N.length;g++){F=at.compSymbol(g);$.push(F);var ot=N[g].handle();if(ot[0]=="X"){et=e.assets[ot].data;for(Q in et){if(!J[Q]){J[Q]=true}if(!et[Q].name){et[Q].name=et[Q].seriesname?n.placeName(e.assets[ot].setname,et[Q].seriesname):Q}if(l[Q]){l[Q].name+="<br>"+et[Q].name}else{l[Q]={latLng:Q.split(","),name:et[Q].name,style:{fill:at.options.color}};l[Q].latLng[0]=parseFloat(l[Q].latLng[0]);l[Q].latLng[1]=parseFloat(l[Q].latLng[1])}R=et[Q].data.split("|");for(it=0;it<R.length;it++){b=R[it].split(":");if(!j[b[0].toString()]){j[b[0].toString()]={}}if(!j[b[0].toString()][F]){j[b[0].toString()][F]={}}j[b[0].toString()][F][Q]=b[1]}}}else{R=e.assets[ot].data.split("|");for(it=0;it<R.length;it++){b=R[it].split(":");if(!j[b[0].toString()]){j[b[0].toString()]={}}j[b[0].toString()][F]=b[1]}}}var z=!at.options.componentData||at.options.componentData=="required";var G=at.options.componentData=="missingAsZero";var W=at.options.componentData=="nullsMissingAsZero";var V=!at.options.breaks||at.options.breaks=="never";var H=at.options.breaks=="nulls";var Y=at.options.breaks=="missing";a=a+at.name();i=e.assets[ot].freq;if(at.options.attribute=="fill"){K=at.units()}else{Z=at.units()}for(c in j){D=Number.MAX_VALUE;T=Number.MIN_VALUE;S=false;for(Q in J){M={};_=true;C=false;for(g=0;g<$.length;g++){if(!isNaN(j[c][$[g]])){M[$[g]]=parseFloat(j[c][$[g]])}else{if(j[c][$[g]]=="null"){if(W){M[$[g]]=0}else{_=null;break}}else{if(j[c][$[g]]&&!isNaN(j[c][$[g]][Q])){if(j[c][$[g]][Q]=="null"){if(W){M[$[g]]=0}else{_=null;break}}else{M[$[g]]=j[c][$[g]][Q];C=true}}else{if(z){_=null;break}else{M[$[g]]=0}}}}}if(C){if(_){try{_=st(M);if(Math.abs(_)==Infinity||isNaN(_))_=null}catch(X){_=null}}if(_!==null){_=x(_);S=true;if(!p[c])p[c]={};if(!p[c][Q])p[c][Q]={};if(at.options.attribute=="fill"){p[c][Q].f=_;D=Math.min(D,_);T=Math.max(T,_)}else{p[c][Q].r=_;D=Math.min(D,_);T=Math.max(T,_)}}}}if(S){if(!o[c])o[c]={};if(at.options.attribute=="fill"){o[c].markerFillMin=Math.min(o[c].markerFillMin||D,D);o[c].markerFillMax=Math.max(o[c].markerFillMax||T,T)}else{o[c].markerRadiusMin=Math.min(o[c].markerRadiusMin||D,D);o[c].markerRadiusMax=Math.max(o[c].markerRadiusMax||T,T)}}else{delete p[c]}}}for(y in p){for(Q in J){if(typeof p[y][Q]=="undefined")p[y][Q]={f:null,r:null}}}}for(c in o){r.push({s:c,dt:k(c),regionMin:o[c].regionMin,regionMax:o[c].regionMax,markerRadiusMin:o[c].markerRadiusMin,markerRadiusMax:o[c].markerRadiusMax,markerFillMin:o[c].markerFillMin,markerFillMax:o[c].markerFillMax})}r.sort(function(e,t){return e.dt-t.dt});var rt={title:a,freq:i,mapUnits:s,markers:l,markerData:p,dates:r,regionData:u,fillUnits:K,radiusUnits:Z};if(e.mapsets)e.mapsets[t].calculatedMapData=rt;return rt}function mt(){if(l.intervals){g.startDateIndex=g.dates.length-parseInt(l.intervals);g.endDateIndex=g.dates.length-1}else{g.startDateIndex=g.dates.length-1;g.endDateIndex=0;for(i=0;i<g.dates.length;i++){if((!l.start||parseInt(l.start)<=g.dates[i].dt.getTime())&&(!l.end||parseInt(l.end)>=g.dates[i].dt.getTime())){if(g.startDateIndex>i)g.startDateIndex=i;if(g.endDateIndex<i)g.endDateIndex=i}}}}function gt(e){var a,n,i,s,o,r={},c,d,p=e.calculatedMapData;var u=l.mapsets&&l.mapsets[v].mapMode();var m=false;switch(u){case"abs-change":case"change-bubbles":m=function(e,t){return t-e};break;case"percent-change":m=function(e,t){return(t-e)/e};break;default:}p.regionMin=Number.MAX_VALUE;p.regionMax=Number.MIN_VALUE;if(e.intervals){p.startDateIndex=p.dates.length-parseInt(e.intervals);p.endDateIndex=p.dates.length-1;for(a=p.startDateIndex;a<p.endDateIndex+1;a++){if(e.mapsets){if(!m){p.regionMin=Math.min(p.dates[a].regionMin,p.regionMin);p.regionMax=Math.max(p.regionMax,p.dates[a].regionMax)}else{if(a!=p.startDateIndex){for(o in p.regionData[p.dates[a].s]){var g=p.regionData[p.dates[p.startDateIndex].s][o];var b=p.regionData[p.dates[a].s][o];var y=m(g,b);if(!isNaN(y)){p.regionMin=Math.min(y,p.regionMin);p.regionMax=Math.max(p.regionMax,y)}}}}}}}else{p.startDateIndex=p.dates.length-1;p.endDateIndex=0;for(a=0;a<p.dates.length;a++){if((!e.start||parseInt(e.start)<=p.dates[a].dt.getTime())&&(!e.end||parseInt(e.end)>=p.dates[a].dt.getTime())){if(p.startDateIndex>a)p.startDateIndex=a;if(p.endDateIndex<a)p.endDateIndex=a;if(e.mapsets){if(!m){p.regionMin=Math.min(p.dates[a].regionMin,p.regionMin);p.regionMax=Math.max(p.regionMax,p.dates[a].regionMax)}else{if(a!=p.startDateIndex){for(o in p.regionData[p.dates[a].s]){var g=p.regionData[p.dates[p.startDateIndex].s][o];var b=p.regionData[p.dates[a].s][o];var y=m(g,b);if(!isNaN(y)){p.regionMin=Math.min(y,p.regionMin);p.regionMax=Math.max(p.regionMax,y)}}}}}}}}var w,k,x,S,M;if(e.mapsets){var C={};S=e.mapsets[0].options;k=!S.scale||S.scale=="continuous";c=p.regionMin;d=p.regionMax;x=c<0&&d>0;p.regionColors={};if(k){w={pos:H(S.posColor||h.POS),neg:H(S.negColor||h.NEG),mid:H(h.MID)};var _=new RGBColour(w.pos.r,w.pos.b,w.pos.g);var D=_.getHSV();var T=new HSVColour(D.h,x?10:20,x?90:100);var A=T.getIntegerRGB();w.posMid={r:A.r,g:A.g,b:A.b};var U=new RGBColour(w.neg.r,w.neg.b,w.neg.g);var $=U.getHSV();var I=new HSVColour($.h,x?10:20,x?90:100);var P=I.getIntegerRGB();w.negMid={r:P.r,g:P.g,b:P.b}}var N=p.dates[p.startDateIndex].s;for(a=p.startDateIndex;a<=p.endDateIndex;a++){s=p.dates[a].s;p.regionColors[s]={};if(p.regionData[s]){for(o in p.regionData[s]){r[o]=true;n=p.regionData[s][o];if(m){if(p.regionData[N]&&p.regionData[N][o]){M=p.regionData[N][o];n=m(M,n)}else{n=null}}if(!isNaN(n)&&n!==null){n=parseFloat(n);if(k){if(n==0){p.regionColors[s][o]=h.MID}else{p.regionColors[s][o]=Y(n,n<0?c:x?0:c,n>0?d:x?0:d,n<0?w.neg:w.posMid,n<0?w.negMid:w.pos,S.logMode=="on"&&!x&&c!=0&&d!=0)}}else{for(j=0;j<S.discreteColors.length;j++){if(j!=S.discreteColors.length-1&&n<=parseFloat(S.discreteColors[j].cutoff)||j==S.discreteColors.length-1){p.regionColors[s][o]=S.discreteColors[j].color;break}}}}else{p.regionColors[s][o]="#ffffff"}}}else{for(i in p.regionData){for(o in p.regionData[i]){p.regionColors[s][o]="#ffffff"}break}}}for(s in p.regionColors){for(o in r){if(typeof p.regionColors[s][o]=="undefined"){p.regionColors[s][o]="#ffffff"}}}}if(e.pointsets){S=e.mapconfig;k=!S.scale||S.scale=="continuous";if(k){}var R=Number.MAX_VALUE,F=Number.MIN_VALUE;var B=Number.MAX_VALUE,q=Number.MIN_VALUE;for(a=p.startDateIndex;a<=p.endDateIndex;a++){if(p.dates[a].markerRadiusMin){B=Math.min(p.dates[a].markerRadiusMin,B);q=Math.max(p.dates[a].markerRadiusMax,q)}if(p.dates[a].markerFillMin){R=Math.min(p.dates[a].markerFillMin,R);F=Math.max(p.dates[a].markerFillMax,F)}}var O;var L=B!=Number.MAX_VALUE;if(L){O=Math.max(Math.abs(B),Math.abs(q));p.radiusScale=O}var E=R!=Number.MAX_VALUE;if(E){p.markerFillMinValue=R;p.markerFillMaxValue=F;k=E&&(!e.mapconfig.scale||S.scale=="continuous");x=R<0&&F>0;if(k){w={pos:H(S.posColor||h.POS),neg:H(S.negColor||h.NEG),posMid:{},negMid:{},mid:H(h.MID)};var _=new RGBColour(w.pos.r,w.pos.b,w.pos.g);var D=_.getHSV();var T=new HSVColour(D.h,x?10:20,x?90:100);var A=T.getIntegerRGB();w.posMid={r:A.r,g:A.g,b:A.b};var U=new RGBColour(w.neg.r,w.neg.b,w.neg.g);var $=U.getHSV();var I=new HSVColour($.h,x?10:20,x?90:100);var P=I.getIntegerRGB();w.negMid={r:P.r,g:P.g,b:P.b}}}var z,G,W,V={r:{},fill:{},stroke:{}};for(s in p.markerData){V.r[s]={};V.fill[s]={};V.stroke[s]={};for(z in p.markers){if(L){W=p.markerData[s][z].r||null;if(W<0){V.stroke[s][z]="#ff0000";W=Math.abs(W)}else{V.stroke[s][z]="#000000"}V.r[s][z]=(e.mapconfig.maxRadius||f)*Math.sqrt(W)/Math.sqrt(O)}if(E){G=p.markerData[s][z].f||null;if(isNaN(G)||G===null){V.fill[s][z]="#ffffff"}else{if(k){if(x){V.fill[s][z]=Y(G,G<0?R:x?0:R,G>0?F:x?0:F,G<0?w.neg:w.posMid,G<0?w.negMid:w.pos)}else{V.fill[s][z]=Y(G,G<0?R:x?0:R,G>0?F:x?0:F,G<0?w.neg:w.mid,G<0?w.mid:w.pos)}}else{for(j=0;j<e.mapconfig.discreteColors;j++){if(j==0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<=G||j!=0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<G){V.fill[s][z]=e.mapconfig.discreteColors[j].color}else break}}}}else{}}}p.markerAttr=V}function H(e){if(e.substr(0,1)=="#")e=e.substr(1);var t,a,n;t=parseInt(e.substr(0,2),16);a=parseInt(e.substr(2,2),16);n=parseInt(e.substr(4,2),16);return{r:t,g:a,b:n}}function Y(e,a,n,i,s,o){var r,l,c,d,p,u,h,f=t.common.octet;if(o){d=Math.log(Math.abs(e));p=Math.log(Math.min(Math.abs(a),Math.abs(n)));u=Math.log(Math.max(Math.abs(a),Math.abs(n)));h=(d-p)/(u-p)}else{h=(e-a)/(n-a)}r=f(Math.round(h*(s.r-i.r)+i.r));l=f(Math.round(h*(s.g-i.g)+i.g));c=f(Math.round(h*(s.b-i.b)+i.b));return"#"+r+l+c}}function bt(e){var t=l.calculatedMapData,a={},n;t["region"+e]={};for(dateKey in t.regionData){for(geo in t.regionData[dateKey]){if(t.regionData[dateKey]){n=t.regionData[dateKey][geo];if(n!==null){if(typeof a[geo]=="undefined"||(e=="min"?n<a[geo]:n>a[geo])){a[geo]=n;t["region"+e][geo]=dateKey}}}}}t["marker"+e]={};for(dateKey in t.markerData){for(geo in t.markerData[dateKey]){if(t.markerData[dateKey]){n=t.markerData[dateKey][geo];if(n!==null){if(typeof a[geo]=="undefined"||(e=="min"?n<a[geo]:n>a[geo])){a[geo]=n;t["marker"+e][geo]=dateKey}}}}}}function yt(e,t){while(t.length>=4){if(e[t])return e[t];t=t.substr(0,t.length-2)}return false}}},visiblePanelId:function et(){var e=$("div.graph-panel:visible");if(e.length==1){return e.get(0).id}else{return null}},formatDateByPeriod:function tt(e,t){if(isNaN(e)==false&&e!==null){var a=new Date(parseInt(e));switch(t){case"A":return a.getUTCFullYear();case"Q":return"Q"+parseInt((a.getUTCMonth()+3)/3)+" "+a.getUTCFullYear();case"SA":case"M":return l[a.getUTCMonth()]+" "+a.getUTCFullYear();case"W":case"D":return a.getUTCDate()+" "+l[a.getUTCMonth()]+" "+a.getUTCFullYear();default:return a.toUTCString().substr(5,20)}}else{return"-"}},fillScalingCount:function at(e){var t=0;if(e instanceof Array){t=e.length-B(e)}return t},areaScalingCount:function nt(e){var t=0;if(e instanceof Array){$.each(e,function(){if(this.options.attribute!="fill")t++})}return t}};var C=M.chartPanel,_=M.intervalStartDt,D=M.setCropSlider,T=M.closestDate,A=M.createMyGraph,U=M.makeChartOptionsObject,I=M.buildGraphPanel,P=M.visiblePanelId,R=M.formatDateByPeriod,F=M.fillScalingCount,B=M.areaScalingCount;var q={template:'<div id="dwrap2">'+'<div id="titleEditor" style="width: 560px">'+'<input type="text" width="300px" name="title" /> '+'<button id="graph-title-change-ok">OK</button> '+'<button id="graph-title-change-cancel">cancel</button>'+"</div>"+"</div>",show:function(e,t){var a=this;$.fancybox(this.template,{width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none",left:"55px",top:"55px"});$("#fancybox-wrap").stop().css({top:"70px"});$("#graph-title-change-ok").click(a.changeOk);$("#graph-title-change-cancel").click(a.changeCancel);var n=$(e).closest("div.graph-panel").get(0).id;$("#titleEditor input").keyup(function(e){if(e.keyCode==13)a.changeOk()}).attr("data",n).val(o[n].title).css("width","450px").focus();this.callback=t},callBack:false,changeOk:function(){var e=$("#titleEditor input").attr("data");var t=$("#titleEditor input").val().trim();var a=o[e];if(t!=a.title){a.title=t||"untitled";if(a.plots){if(a.title.length==0){a.controls.chart.setTitle({text:"untitled - click to edit",style:{color:"grey",font:"italic"}})}else{a.controls.chart.setTitle({text:a.title,style:{color:"black",font:"normal"}})}$("#"+e+" .highcharts-title").click(function(){q.show(this)})}var n=t||"Graph "+e.substr(e.indexOf("-")+1);$("#graph-tabs a[href='#"+e+"']").attr("title",n).html(n);$("#"+e+" h3.mashabledata_map-title").html(a.title);if(a.title.length==0){if(this.callback)this.callback()}}q.changeCancel()},changeCancel:function(){$.fancybox.close();this.callBack=false}};return M;function O(e){e.smallestPeriod="A";e.largestPeriod="N";var t,a,n,i,s;e.eachComponent(function(){if(!this.firstdt&&(this.handle.charAt(0)=="M"||this.handle.charAt(0)=="X")){for(i in e.assets[this.handle()].data){n=e.assets[this.handle()].data[i].firstdt;e.assets[this.handle()].firstdt=Math.min(e.assets[this.handle()].firstdt,n)||n;n=e.assets[this.handle()].data[i].lastdt;e.assets[this.handle()].lastdt=Math.max(e.assets[this.handle()].lastdt,n)||n}}n=this.firstdt;t=Math.min(n,t)||n||t;n=this.lastdt;a=Math.max(n,a)||n||t});e.eachPlot(function(){var t=this.freq();if(c.value[e.smallestPeriod]>c.value[t])e.smallestPeriod=t;if(c.value[e.largestPeriod]<c.value[t])e.largestPeriod=t});e.firstdt=t;e.lastdt=a;e.minZoom=e.start||e.firstdt;e.maxZoom=e.end||e.lastdt}function L(e){var t=[];$.each(e,function(){if(this.options&&this.options.color)t.push(this.options.color)});var a=p.concat(u);for(var n=0;n<a.length;n++){if(t.indexOf(a[n])==-1)return a[n]}return a[e.length%a.length]}function E(e){if(e==0)return"0";var t=Math.floor(Math.log(Math.abs(e))/Math.LN10);var a=Math.round(e/Math.pow(10,t-2))*Math.pow(10,t-2);return n.numberFormat(a,t>1?0:2-t)}function z(e,t,i,s,o){console.time("vizualizeCube");if(typeof o=="undefined")o="new";var r,l,c=e.cubeid,d=e.mapsets[t];if(!e.assets.cube)e.assets.cube={data:{},id:c};var p=e.assets.cube;if(!p.data["G"+i]){var u=e.controls.$thisPanel.find("div.mashabledata_cube-viz");u.mask("loading...");S({command:"GetCubeSeries",ghash:e.ghash||"",cubeid:c,geokey:i,freq:d.freq(),modal:"none"},function(e,t,a){p.data["G"+i]=e.series;p.theme=e.theme;p.name=e.name;p.units=e.units;p.barAxis=e.baraxis;p.barNames=e.barnames?JSON.parse(e.barnames.replace(/u0022/g,'"')):false;p.stackAxis=e.stackaxis;p.stackNames=e.stacknames?JSON.parse(e.stacknames.replace(/u0022/g,'"')):false;p.sideAxis=e.sideaxis;p.sideNames=e.sidenames?JSON.parse(e.sidenames.replace(/u0022/g,'"')):false;u.unmask();h()})}else{h()}function h(){var t=null;if(isNaN(i)){e.eachComponent(function(){if(!t){if(this.handle[0]=="M"&&e.assets[this.handle()].data[i])t=e.assets[this.handle()].data[i].geoname}})}else{t=e.map}var r=p.data["G"+i],l;p.hasData=false;for(l=0;l<r.length;l++){if(r[l].data){p.hasData=true;break}}var c=(e.mapconfig&&e.mapconfig.cube&&e.mapconfig.cube.name||p.name||p.theme)+"<br>"+(p.hasData?t||"":"");var d={chart:{type:"bar",spacingRight:50,renderTo:e.controls.$thisPanel.find(".mashabledata_cube-viz")[0],cubeId:e.cubeid},title:{text:c,style:{fontSize:"12px"}},subtitle:{text:jvm.Map.maps[e.mapFile].paths[i]?jvm.Map.maps[e.mapFile].paths[i].name:"click on map to select location",style:{fontSize:"10px"}},plotOptions:{bar:{dataLabels:{enabled:false,align:"left",formatter:function(){return p.hasData?this.point.rawY===null?"no data":this.y:""}},borderWidth:0,animation:false,stacking:"normal"}},xAxis:{categories:[],title:{text:null},lineWidth:1,minorGridLineWidth:0,labels:{enabled:true},minorTickLength:0,tickLength:0},yAxis:{title:{text:e.mapconfig&&e.mapconfig.cube&&e.mapconfig.cube.units||p.units||""},labels:{enabled:false},lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",gridLineColor:"transparent",gridLineWidth:0},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false,type:"image/png",url:"https://www.mashabledata.com/workbench/export/index.php"},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{useHTML:true,formatter:function(){return"<b>"+p.theme+"</b><br/>"+this.point.name+":<br/>"+n.numberFormat(Math.abs(this.point.y),0)+" "+p.units}}};var u,h,f,m,g,b=[],v=0;var y=p.barAxis,w=p.stackAxis,k=p.sideAxis,x=e.mapconfig.cube;for(l=0;l<r.length;l++){f=parseInt(r[l].barorder);g=parseInt(r[l].sideorder);m=parseInt(r[l].stackorder);h=W(r[l].data,s);u={y:(p.sideAxis&&g==0?-1:1)*h,rawY:h,name:r[l].name};b.push(u);if(f==p.barNames.length-1){var S={data:b,color:p.stackNames?a.hcColors[m]:a.hcColors[g]};if(p.stackNames)S.name=x&&x.dims[w]&&x.dims[w][m]||p.stackNames[m];if(g==1)S.linkedTo=":previous";if(g==1||!p.stackNames)S.showInLegend=false;d.series.push(S);b=[]}}for(l=0;l<p.barNames.length;l++){d.xAxis.categories.push(x&&x.dims[y]&&x.dims[y][l]||p.barNames[l])}if(!p.stackNames){d.plotOptions.bar.dataLabels.enabled=true}if(p.sideAxis)d.xAxis.lineWidth=0;switch(o){case"add":d.series[0].showInLegend=true;e.controls.vizChart.addSeries(d.series[0]);break;case"remove":e.controls.vizChart.get(i).remove(false);break;case"summation":d.series[0].pointWidth=1;d.series[0].pointPadding=0;d.plotOptions.bar.groupPadding=0;default:if(e.controls.vizChart&&e.controls.vizChart.options.chart.cubeId!=e.cubeid){e.controls.vizChart.destroy()}if(e.controls.vizChart){e.controls.vizChart.setTitle(c,t,false);while(e.controls.vizChart.series.length)e.controls.vizChart.series[0].remove(false);for(l=0;l<d.series.length;l++){e.controls.vizChart.addSeries(d.series[l],false)}e.controls.vizChart.redraw()}else{e.controls.vizChart=new Highcharts.Chart(d)}}}console.timeEnd("vizualizeCube")}function G(e,t,a,n){var o=[],r,l;if(n){if(s[t.map].bunny){r=d(s[t.map].bunny,t,a);if(r){r.bunny=true;o.push(r)}}}for(i=0;i<e.length;i++){var c=e[i];if(r=d(c,t,a)){if(n&&r.c_geoid){l=d(r.c_geoid,t,a);if(l)o.push(l)}o.push(r)}}return o;function d(e,t,a){var n,i;if(isNaN(e)){n={code:e};a.eachComponent(function(){if(!n.geoname&&this.isMapSet()){var e=t.assets[this.handle()];if(e.data[n.code]){n.geoid=e.data[n.code].geoid;n.geoname=e.data[n.code].geoname;n.c_geoid=e.data[n.code].c_geoid}}})}else{n={geoid:e};a.eachComponent(function(){if(!n.geoname&&this.isMapSet()){var a=t.assets[this.handle()];for(i in a.data){if(a.data[i].geoid==e){n.geoname=a.data[i].geoname;n.code=i;n.c_geoid=a.data[n.code].c_geoid;break}}}})}return n.geoname?n:false}}function W(e,t){if(!e)return null;var a,n=Array.isArray(e)?e:e.split("|");for(var i=0;i<n.length;i++){a=n[i].split(":");if(a[0]==t){if(a[1]=="null"||a[1]===null)return null;else return parseFloat(a[1])}}return null}function V(e){if(!e.controls)return;var t=e.plots!=null,a=e.hasMapViz(),n=e.mapsets||e.pointsets!=null,i=e.mapconfig.sizes,s=e.controls.$thisPanel,o=s.find(".mashabledata_chart-map"),r=s.find(".mashabledata_chart"),l=s.find("div.annotations"),c=s.find(".mashabledata_cube-viz"),d=s.find("h3.mashabledata_map-title"),p=s.find(".mashabledata_map"),u=s.find(".mashabledata_jvmap");if(t){r.show();l.show();d.hide()}else{r.hide();l.hide();d.show();if(e.controls.chart){e.controls.chart.destroy();delete e.controls.chart}}if(n){u.show()}else{u.hide()}if(a){c.show()}else{c.hide();if(e.controls.vizChart){e.controls.vizChart.destroy();delete e.controls.vizChart}}if(n||a){p.show()}else{p.hide()}if(i&&(m(i.chart,t)||m(i.map,n)||m(i.viz,a))){i=false;delete e.mapconfig.sizes}if(i){if(t)r.width(i.chart.width).height(i.chart.height);if(n)u.width(i.map.width).height(i.map.height);if(a)c.width(i.viz.width).height(i.viz.height)}else{var h=(s.height()-85-(e.plots?0:55))*(e.plots?.6:1)+"px";if(a){c.height(h);u.css("width","70%")}else{u.removeAttr("style")}if(n)u.height(h);if(t){var f=(s.height()-70-(n&&e.mapsets&&e.mapsets.length>1?70:0))*(n||a?.4:1)+"px";r.removeAttr("style").height(f)}s.find(".graph-subpanel").width(s.width()-35-2).height(s.height());s.find(".graph-sources").width(s.width()-35-2-40);o.width(s.width()-365)}function m(e,t){return e&&!t||!e&&t}}}();this.jStat=function(e,t){var a=Array.prototype.concat;var n=Array.prototype.slice;var i=Object.prototype.toString;function s(t,a){var n=t>a?t:a;return e.pow(10,17-~~(e.log(n>0?n:-n)*e.LOG10E))}var o=Array.isArray||function p(e){return i.call(e)==="[object Array]"};function r(e){return i.call(e)==="[object Function]"}function l(e){return typeof e==="number"&&e===e}function c(e){return a.apply([],e)}function d(){return new d._init(arguments)}d.fn=d.prototype;d._init=function u(e){var t;if(o(e[0])){if(o(e[0][0])){if(r(e[1]))e[0]=d.map(e[0],e[1]);for(t=0;t<e[0].length;t++)this[t]=e[0][t];this.length=e[0].length}else{this[0]=r(e[1])?d.map(e[0],e[1]):e[0];this.length=1}}else if(l(e[0])){this[0]=d.seq.apply(null,e);this.length=1}else if(e[0]instanceof d){return d(e[0].toArray())}else{this[0]=[];this.length=1}return this};d._init.prototype=d.prototype;d._init.constructor=d;d.utils={calcRdx:s,isArray:o,isFunction:r,isNumber:l,toVector:c};d.cols=function h(e){return e[0].length||1};return d}(Math);(function(e,t){e.sum=function n(e){var n=0;var t=e.length;var a;while(--t>=0)n+=e[t];return n};e.sumsqerr=function i(t){var a=e.mean(t);var n=0;var i=t.length;var s;while(--i>=0){s=t[i]-a;n+=s*s}return n};e.mean=function s(t){return e.sum(t)/t.length};e.variance=function o(t,a){return e.sumsqerr(t)/(t.length-(a?1:0))};e.stdev=function r(a,n){return t.sqrt(e.variance(a,n))};e.covariance=function l(t,a){var n=e.mean(t);var i=e.mean(a);var s=t.length;var o=new Array(s);var r;for(r=0;r<s;r++)o[r]=(t[r]-n)*(a[r]-i);return e.sum(o)/(s-1)};e.corrcoeff=function c(t,a){return e.covariance(t,a)/e.stdev(t,1)/e.stdev(a,1)};e.skewness=function d(t){return e.stanMoment(t,3)};e.kurtosis=function p(t){return e.stanMoment(t,4)-3};var a=e.prototype})(this.jStat,Math);if(typeof console=="undefined")console={};if(typeof console.info=="undefined")console.info=function(e){};if(typeof console.log=="undefined")console.log=function(e){};if(typeof console.time=="undefined")console.time=function(e){};if(typeof console.timeEnd=="undefined")console.timeEnd=function(e){};function t(){jQuery.extend({stringify:function e(t){if("JSON"in window){return JSON.stringify(t)}var a=typeof t;if(a!="object"||t===null){if(a=="string")t='"'+t+'"';return String(t)}else{var n,i,s=[],o=t&&t.constructor==Array;for(n in t){i=t[n];a=typeof i;if(t.hasOwnProperty(n)){if(a=="string"){i='"'+i+'"'}else if(a=="object"&&i!==null){i=jQuery.stringify(i)}s.push((o?"":'"'+n+'":')+String(i))}}return(o?"[":"{")+String(s)+(o?"]":"}")}}})}Date.prototype.toMDDateString=function(e){var t=e||this.period;if(!t)throw"no period found";var a=this.getUTCFullYear();switch(e){case"M":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();break;case"Q":a+="Q"+parseInt((this.getUTCMonth()+3)/3);break;case"SA":a+="H"+parseInt((this.getUTCMonth()+6)/6);break;case"W":case"D":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();a+=(this.getUTCDate().toString().length==1?"0":"")+this.getUTCDate();break}return a};if(!("bind"in Function.prototype)){Function.prototype.bind=function(e){var t=this;if(arguments.length<=1){return function(){return t.apply(e,arguments)}}else{var a=Array.prototype.slice.call(arguments,1);return function(){return t.apply(e,arguments.length===0?a:a.concat(Array.prototype.slice.call(arguments)))}}}}if(!("trim"in String.prototype)){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(e,t){if(t===undefined)t=0;if(t<0)t+=this.length;if(t<0)t=0;for(var a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1}}if(!("lastIndexOf"in Array.prototype)){Array.prototype.lastIndexOf=function(e,t){if(t===undefined)t=this.length-1;if(t<0)t+=this.length;if(t>this.length-1)t=this.length-1;for(t++;t-->0;)if(t in this&&this[t]===e)return t;return-1}}if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(e,t){for(var a=0,n=this.length;a<n;a++)if(a in this)e.call(t,this[a],a,this)}}if(!("map"in Array.prototype)){Array.prototype.map=function(e,t){var a=new Array(this.length);for(var n=0,i=this.length;n<i;n++)if(n in this)a[n]=e.call(t,this[n],n,this);return a}}if(!("filter"in Array.prototype)){Array.prototype.filter=function(e,t){var a=[],n;for(var i=0,s=this.length;i<s;i++)if(i in this&&e.call(t,n=this[i],i,this))a.push(n);return a}}if(!("every"in Array.prototype)){Array.prototype.every=function(e,t){for(var a=0,n=this.length;a<n;a++)if(a in this&&!e.call(t,this[a],a,this))return false;return true}}if(!("some"in Array.prototype)){Array.prototype.some=function(e,t){for(var a=0,n=this.length;a<n;a++)if(a in this&&e.call(t,this[a],a,this))return true;return false}}if("function"!==typeof Array.prototype.reduce){Array.prototype.reduce=function(e){"use strict";if(null===this||"undefined"===typeof this){throw new TypeError("Array.prototype.reduce called on null or undefined")}if("function"!==typeof e){throw new TypeError(e+" is not a function")}var t=Object(this),a=t.length>>>0,n=0,i;if(arguments.length>=2){i=arguments[1]}else{while(n<a&&!n in t)n++;if(n>=a)throw new TypeError("Reduce of empty array with no initial value");i=t[n++]}for(;n<a;n++){if(n in t){i=e(i,t[n],n,t)}}return i}}var n=e,s=n.globals,o=n.grapher,l=n.common;var c=o.buildGraphPanel,d=s.themeCubes,p=s.iconsHMTL,u=s.panelGraphs,h=s.MySets,f=s.MyGraphs,m=s.hcColors,v=s.colorsPlotBands;var y=o.createMyGraph,w=o.formatDateByPeriod,k=o.visiblePanelId,x=o.compSymbol;var S=l.dateFromMdDate,M=l.callApi;var C={plot:'<li class="plot ui-state-highlight" data="{{order}}">'+'<a class="edit-plot link" style="float:right;">edit <span class="ui-icon ui-icon-arrowthickstop-1-s" style="display: inline-block;"> edit</span></a>'+'<div class="line-sample" style="padding:0;margin:0 10px 10px 0;display:inline-block;border-width:0;background-color:{{color}};height:{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px;width:38px;">'+'<img src="images/{{options.lineStyle}}.png" height="{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px" width="{{imageWidth}}px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">{{name}}</span> in {{plotUnits}} {{plotPeriodicity}}</div>'+'<ul class="series" style="list-style-type: none;" data="{{order}}">'+'{{#component}}<li class="serie ui-state-default" data="{{handle}}" plot="{{order}}"><span class="plot-op ui-icon {{opUI}}">operation</span> '+'{{seriesname}}<button class="edit-comp">edit</button></li>{{/component}}'};var _={noMySeries:'Your My Series folder is empty.  Please search for Public Series, which can be graphed and added to your My Series folder for future quick reference.<br><br>You can also use the <button id="new-series" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">new series</span></button> feature to enter or upload your own data.',noSeriesSelected:"Click on one or more series below to select them before previewing.<br><br>Alternatively, you can double-click on a series to quickly preview it.",editLimit:"Only one series or set can be edited at a time.",noGraphSelected:"Click on a row in the table below to select a graph first.<br><br>As a shortcut, you can double-click on a graph to select and open it.",noMyGraphs:"You have no My Graphs.  Graphs are built by searching for public series or upload your own data and building a graph. Saving graphs you build adds to them to your My Graphs folder.<br><br>You can also view a public graph and make a personal copy.<br><br>See the help (upper right after you close this dialogue) to learn more.",noPublicGraphs:"First search for public graphs.  Note that a search with no keywords will return the most recent published graphs.",deleteMySeries:"This action will remove the series from your My Series favorites. Public series will still be available through the Public Series finder.  Any uploads or edits will be lost.  Please confirm to delete.",signInRequired:"You must be signed in to do this edit and create your own series.  Please use the sign in button to use your Facebook account."};
var D={quickView:50,views:55,checkbox:25,save:25,shortDate:74,mmmyyyy:62,longDate:125,deleteIcon:35,map:125,freq:45,linkIcon:30,src:150,drillIcon:35,count:60,scrollbarWidth:35,padding:9};var T={heights:{graphTabsGap:null,tableControls:42,innerDataTable:null,scrollHeads:null,windowMinimum:580},widths:{windowMinimum:750,mySeriesTable:{columns:{}},publicSeriesTable:{columns:{}},myGraphsTable:{columns:{}},publicGraphTable:{columns:{}}}};var A=7;var U=/\S/;var I;var P;var N;var R;var F=0;var B=false;var q="",O="";var L=null;var E=null;var z=false;var G;var W=1;var V=0;var H;var Y;var X;var K=false;window.fbAsyncInit=function(){FB.init({appId:"209270205811334",channelURL:"//www.mashabledata.com/fb_channel.php",status:true,cookie:true,oauth:true,xfbml:true});FB.getLoginStatus(function(e){account.signInFB(e);FB.Event.subscribe("auth.login",function(e){account.signInFB(e)})})};function Z(){var e,t="facebook-jssdk";if(document.getElementById(t)){return}e=document.createElement("script");e.id=t;e.async=true;e.src="//connect.facebook.net/en_US/all.js";document.getElementsByTagName("head")[0].appendChild(e)}$(document).ready(function(){try{var e=window.localStorage.getItem("dummy")}catch(a){$("#dialog-top").html("MashableData Workbench requires a HTML 5 compliant browser.  The latest version of Internet Explorer, Chrome, Safari or Firefox are recommended.  Internet Explorer 8 users may experience slow rendering.<br><br>");gt=$("#dialog").dialog({modal:true,title:"Incompatible browser",width:500});$(".ui-dialog-titlebar-close").remove();return false}$(document).mouse({distance:10});requirejs.config({waitSeconds:15});require(["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"]);t();$("#edit-my-series").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){Nt(H)});$("#quick-view-to-series").button({icons:{secondary:"ui-icon-person"}}).click(function(){At(this)});$("#quick-view-delete-series").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){Et(this)});$("#quick-view-chart-or-map").buttonset();$("#quick-view-map").button({icons:{secondary:"ui-icon-flag"}});$("#quick-view-chart").button({icons:{secondary:"ui-icon-image"}});$("#quick-view-add-to-graph").button().click($t);$quickViewChangeGeo=$("#quick-view-change-geo").button().click(Ut);$("#quick-view-close").button({icons:{secondary:"ui-icon-close"}}).click(Pt);$(".show-graph-link").fancybox({width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none"});jQuery.fancybox.center=function(){};$("#show-hide-pickers").button({icons:{secondary:"browse-rollup"}});$("#menu-account").button({icons:{secondary:"ui-icon-triangle-1-s"}}).click(function(){account.showSignInOut()});$("#menu-help").button({icons:{secondary:"ui-icon-help"}}).click(function(){$helpMenu=account.showPanel('<div style="width:400px;height:300px;">'+"<ul>"+'<li><a target="help" title="Features" href="http://www.mashabledata.com/features/">Features and tour</a></li>'+'<li><a target="help" title="Searching and browsing for data" href="http://www.mashabledata.com/searching-and-browsing-for-data/">Searching and browsing for data</a></li>'+'<li><a target="help" title="Using series math to answer complex questions" href="http://www.mashabledata.com/using-series-math-to-answer-complex-questions/">Using series math to answer complex questions</a> (corn v. wheat)</li>'+'<li><a target="help" title="My Series &amp; Graphs" href="http://www.mashabledata.com/my-series-graphs/">My Series &amp; Graphs</a></li>'+'<li><a target="help" title="What are map sets and point sets?" href="http://www.mashabledata.com/what-are-map-sets-and-point-sets/">What are map sets and point sets?</a></li>'+'<li><a target="help" title="Creating maps" href="http://www.mashabledata.com/creating-maps/">Creating maps</a>'+"<ul>"+'<li><a target="help" title="Maps: Comparing against a regional average" href="http://www.mashabledata.com/creating-maps/maps-comparing-against-a-regional-average/">Comparing against a regional average</a> (Unemployment by state)</li>'+'<li><a target="help" title="Changing base maps" href="http://www.mashabledata.com/creating-maps/changing-base-maps/">Changing base maps</a></li>'+'<li><a target="help" title="Map colors (continuous, discrete and logarithmic)" href="http://www.mashabledata.com/workbench-help/creating-maps/map-colors-continuous-discrete-and-logarithmic/">Map colors (continuous, discrete and logarithmic)</a></li>'+'<li><a target="help" title="Bubble maps and user defined regions" href="http://www.mashabledata.com/workbench-help/creating-maps/bubble-maps-and-user-defined-regions/">Bubble maps and user defined regions</a></li>'+"</ul>"+"</li>"+'<li><a target="help" title="User series and the Highcharts plugin" href="http://www.mashabledata.com/workbench-help/user-series-and-the-highcharts-plugin/">User series and the Highcharts plugin</a></li>'+'<li><a target="help" title="Accounts: free, individual and corporate" href="http://www.mashabledata.com/workbench-help/accounts-free-individual-and-corporate/">Accounts: free, individual and corporate</a></li>'+'<li><a target="help" title="Publishing graphs and fair use" href="http://www.mashabledata.com/workbench-help/publishing-graphs-and-fair-use/">Publishing graphs and fair use</a></li>'+"</ul>"+"</div>",$("#menu-help"))});X=$("#series-tabs li a").click(function(){Ht(this)}).filter("[data='#local-series']").get(0);T.heights.scrollHeads=$("div#local-series div.dataTables_scrollHead").height();tt();at();yt();it();$("#series-table_filter input, #my_graphs_table_filter input").change(function(){Xt()});G=$("#canvas").tabs({tabTemplate:'<li class="graph-tab"><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>',add:function(e,t){var a="Loading graph.  Please wait.";$("#canvas li.graph-tab span.ui-icon-close").off().click(Gt);return $(t.panel).append("<p>"+a+"</p>")},activate:function(e,t){Xt()}});if(document.URL.indexOf("localhost")>=0){account.info.userId=2;account.info.accessToken="paste token here";jt()}else{Z()}$(window).bind("resize load",tt()).bind("focus",function(e){if(z){if(yt()>0){I.fnFilter("");I.fnSort([[A,"asc"]])}}e.bubbles=true;return true});nt();st();$("#tblPublicSeries_processing, #tblPublicGraphs_processing").html("searching the MashableData servers...");$("div.dataTables_scrollBody").height(T.heights.innerDataTable);$("#series-search-button, #graphs-search-button").addClass("ui-state-active").button({icons:{secondary:"ui-icon-search"}});Zt();$("ul#series-tabs").click(function(){xt()});hasher.changed.add(J);hasher.initialized.add(J);hasher.init();$("body").resize(tt);$("#series-search-button").click(ct);$("#show-hide-pickers").click(function(){kt();Xt()});require(s.graphScriptFiles,function(){$.fn.colorPicker.defaults.colors.splice(-1,0,m,v);Highcharts.setOptions({tooltip:{formatter:function(){return"<b>"+this.series.name.trim()+"</b><br>"+w(this.point.x,this.series.options.freq)+":"+Highcharts.numberFormat(this.y,parseInt(this.y)==this.y?0:3,".",",")+" "+this.series.yAxis.options.title.text+(this.point.id&&this.point.options.text?"<br><br>"+this.point.options.text:"")}}})});(function(){if(window.location.href.indexOf("workbenchdev")<0&&window.location.href.indexOf("nolog")<0&&!window.localStorage.getItem("nolog")){var e=jQuery.event.dispatch;jQuery.event.dispatch=function(){try{e.apply(this,arguments)}catch(t){Zt();var a=window.nagivator?navigator.appName+" - "+navigator.appCodeName+" - "+navigator.appVersion:"undefined";$.ajax({type:"POST",url:"api.php",data:{command:"LogError",browser:a,url:window.location.href,message:t.message,stack:t.stack,uid:account.info.userId,lang:navigator.language,platform:navigator.platform,version:workbenchVersion},dataType:"json"});vt("error","A error has occurred.  MashableData servers have logged the error and our technician have been alerted.")}}}})()});function J(t,a){K=true;var n,i={},s,o=t.split("&");for(var r=0;r<o.length;r++){s=o[r].split("=");i[s[0]]=s[1]}if(i.t){switch(i.t.toLowerCase()){case"ms":$("#series-tabs").find("li.local-series a").click();n=$("#series-table_filter").find("input");if(i.s&&decodeURI(i.s)!=n.val()){n.click().val(decodeURI(i.s)).keyup()}if(G.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cs":$("#series-tabs").find("li.cloud-series a").click();n=$("#series_search_text");F==i.cat||0;$("#series_search_freq").val(i.f||"all");$("#series_search_source").val(i.api||"all");var l=i.map||"none";$("#find-data-map").html('<option value="'+l+'" selected>'+e.globals.maps[l].name+"</option>");$("#public-settype-radio").find("input[value="+(i.sets||"all")+"]").click();if(F!=0){n.val("category"+(B?": "+B:""));ct()}else{if(decodeURI(i.s)!=n.val()){if(i.s)n.click().val(decodeURI(i.s));ct()}}if(G.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"mg":$("#series-tabs").find("li.my-graphs a").click();n=$("#my_graphs_table_filter").find("input");if(i.s&&decodeURI(i.s)!=n.val()){n.click().val(decodeURI(i.s)).keyup()}if(G.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cg":$("#series-tabs").find("li.public-graphs a").click();n=$("#public_graphs_search").find("input");if(i.s&&decodeURI(i.s)!=n.val()){n.click().val(decodeURI(i.s));ct(true)}if(G.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;default:var c=$("#graph-tabs").find("a[href=#graphTab"+i.t.substr(1)+"]");if(c.length==1){c.click()}else{if(i.graphcode){for(var d in u){if(u[d].ghash==i.graphcode){var p=$("#graph-tabs a[href='#"+d+"']");if(p.length==1){var h=true;p.click();break}}}if(!h){mt(i.graphcode)}}}$("#show-hide-pickers").hide()}}K=false}function et(e){if(!K){hasher.changed.active=false;hasher.setHash(e);hasher.changed.active=true}}function tt(){var e=Math.max($(window).innerHeight()-10,T.heights.windowMinimum);var t=Math.max($(window).innerWidth()-10,T.widths.windowMinimum);$("div#wrapper").height(e).width(t);T.heights.menuBar=$("#title-bar").outerHeight(true);T.heights.canvas=e-T.heights.menuBar-2;T.heights.graphTabs=$("#graph-tabs").outerHeight();$("div#canvas").height(T.heights.canvas);$("div.graph-panel").height(T.heights.canvas-T.heights.graphTabs).width(t).css("margin","0").css("padding","0");T.heights.pickers=T.heights.canvas;$("div.picker").height(T.heights.pickers);T.heights.innerDataTable=T.heights.pickers-T.heights.tableControls-T.heights.scrollHeads-40;$("div.dataTables_scrollBody").height(T.heights.innerDataTable);T.widths.canvas=$("#canvas").innerWidth();T.widths.mySeriesTable.table=T.widths.canvas-8*D.padding-D.scrollbarWidth;var a=T.widths.mySeriesTable.table-(D.freq+2*D.shortDate+D.src+D.shortDate);T.widths.mySeriesTable.columns.units=parseInt(a*.15);T.widths.mySeriesTable.columns.maps=parseInt(a*.1);T.widths.mySeriesTable.columns.series=parseInt(a*.55);T.widths.mySeriesTable.columns.category=parseInt(a*.2);$("#series-table_wrapper").find("thead").find("th.title").width(T.widths.mySeriesTable.columns.series+"px").end().find("th.units").width(T.widths.mySeriesTable.columns.units+"px").end().find("th.cat").width(T.widths.mySeriesTable.columns.category+"px");T.widths.publicSeriesTable.table=T.widths.canvas-9*D.padding-D.scrollbarWidth;a=T.widths.publicSeriesTable.table-(D.map+D.freq+D.src+3*D.mmmyyyy);T.widths.publicSeriesTable.columns.series=a*.5;T.widths.publicSeriesTable.columns.units=a*.25;T.widths.publicSeriesTable.columns.category=a*.25;$("#tblPublicSeries_wrapper").find("thead").find("th.title").width(T.widths.publicSeriesTable.columns.series+"px").end().find("th.units").width(T.widths.publicSeriesTable.columns.units+"px").end().find("th.cat").width(T.widths.publicSeriesTable.columns.category+"px");T.widths.myGraphsTable.table=T.widths.canvas-6*D.padding-D.scrollbarWidth;a=T.widths.myGraphsTable.table-(D.quickView+D.shortDate+D.map);T.widths.myGraphsTable.columns.title=a*.25;T.widths.myGraphsTable.columns.analysis=a*.5;T.widths.myGraphsTable.columns.series=a*.25;$("#my_graphs_table_wrapper").find("thead").find("th.title").width(T.widths.myGraphsTable.columns.title+"px").end().find("th.analysis").width(T.widths.myGraphsTable.columns.analysis+"px").end().find("th.series").width(T.widths.myGraphsTable.columns.series+"px");T.widths.publicGraphTable.table=T.widths.canvas-6*D.padding-D.scrollbarWidth;a=T.widths.publicGraphTable.table-(D.quickView+D.shortDate+D.map);T.widths.publicGraphTable.columns.title=a*.4;T.widths.publicGraphTable.columns.analysis=a*.35;T.widths.publicGraphTable.columns.series=a*.25;$("#tblPublicGraphs_wrapper").find("thead").find("th.title").width(T.widths.publicGraphTable.columns.title+"px").end().find("th.analysis").width(T.widths.publicGraphTable.columns.analysis+"px").end().find("th.series").width(T.widths.publicGraphTable.columns.series+"px")}function at(){I=$("#series-table").html("").dataTable({bProcessing:true,sDom:"frti",bPaginate:false,bFilter:true,bAutoWidth:false,fnInfoCallback:function(e,t,a,n,i,s){return"showing "+(n==i?"":i+" of ")+n+" series"},oLanguage:{sSearch:""},sScrollY:T.heights.innerDataTable-140+"px",aaSorting:[[A,"desc"]],aoColumns:[{mData:"name",sTitle:"Set Name<span></span>",sClass:"title",bSortable:true,sWidth:T.widths.mySeriesTable.columns.series+"px",mRender:function(e,t,a){return(a.settype=="M"?p.mapset:"")+(a.settype=="X"?p.pointset:"")+(a.themeid?p.hasCubeViz:"")+e+'<span class="handle">'+a.handle+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",bSortable:true,sWidth:T.widths.mySeriesTable.columns.units+"px",mRender:function(e,t,a){return e}},{mData:"maps",sTitle:"Maps to<span></span>",sClass:"maps-to",bSortable:true,sWidth:T.widths.mySeriesTable.columns.maps+"px",mRender:function(e,t,a){return ht(a.mapList())}},{mData:"freqs",sTitle:"f<span></span>",sClass:"dt-freq",bSortable:true,sWidth:D.freq+"px",mRender:function(e,t,a){return ut(a.freqs.join(" "))}},{mData:"firstsetdt",sTitle:"from<span></span>",sClass:"dte",sWidth:D.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return w(e,a.period)}},{mData:"lastsetdt",sTitle:"to<span></span>",sClass:"dte",sWidth:D.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return w(e,a.period)}},{mData:"categories",sTitle:"Category<span></span>",sClass:"cat",bSortable:true,sWidth:T.widths.mySeriesTable.columns.category+"px",mRender:function(e,t,a){return e}},{mData:null,sTitle:"Source<span></span>",sClass:"dt-source",bSortable:false,sWidth:D.src+"px",resize:false,mRender:function(e,t,a){if(a.url){return ft(a.url,a.src)}else{return'<span class=" ui-icon ui-icon-person" title="user sets"></span> '+a.username||""}}},{mData:"savedt",sTitle:"added<span></span>",bSortable:true,sType:"numeric",sWidth:D.shortDate+"px",resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){I.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");Ct()}});$("#series-table_filter").appendTo("#series-bar-controls").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#series-table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("enter key phrase to filter").addClass("grey-italics").on("click keydown",function(){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ot);$(".new-data").button().click(function(){Rt()});$("#series-table_info").appendTo("#local-series-header")}function nt(){P=$("#tblPublicSeries").html("").dataTable({sDom:"frti",bServerSide:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public data"},fnServerData:function(e,t,a){var n=$("#tblPublicSeries_filter input").val();t.push({name:"command",value:"NewSearchSeries"});t.push({name:"uid",value:Ft()});t.push({name:"accessToken",value:account.info.accessToken});t.push({name:"mapfilter",value:$("#find-data-map").val()});t.push({name:"freq",value:$("#series_search_freq").val()});t.push({name:"apiid",value:$("#series_search_source").val()});t.push({name:"settype",value:$("#public-settype-radio input:checked").val()});t.push({name:"catid",value:F});t.push({name:"lastSearch",value:q});t.push({name:"search",value:n});if(q!=n){q=n;P.fnSort([]);return}var i=new Date;$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,n){var s=new Date;console.log(e.command+" ("+e.search+"): "+e.exec_time+" ("+(s.getTime()-i.getTime())+"ms)");if(e.status=="ok"){e.aaData=l.setFactory(e.aaData);a(e,t,n)}else vt("server error",e.status)},error:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,n,i,s){return i+" series"},bAutoWidth:false,bProcessing:true,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bDestroy:true,sScrollX:$("#canvas").width()-55+"px",aaSorting:[],iDeferLoading:0,aoColumns:[{mData:"name",sTitle:"Set Name<span></span>",bSortable:true,sWidth:T.widths.publicSeriesTable.columns.series+"px",sClass:"title",mRender:function(e,t,a){return(a.settype=="M"?p.mapset:"")+(a.settype=="X"?p.pointset:"")+(a.themeid?p.hasCubeViz:"")+ht(e)+'<span class="handle">'+a.handle()+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",sWidth:T.widths.publicSeriesTable.columns.units+"px",bSortable:true,mRender:function(e,t,a){return ht(e)}},{mData:"elements",sTitle:"Set size<span></span>",sClass:"set-size",sWidth:D.mmmyyyy+"px",bSortable:true,mRender:function(e,t,a){return e==0?"":e}},{mData:"maps",sTitle:"Maps to<span></span>",sClass:"maps-to",bSortable:false,sWidth:T.widths.mySeriesTable.columns.maps+"px",mRender:function(e,t,a){return ht(a.mapList())}},{mData:null,sTitle:"f<span></span>",sWidth:D.freq+"px",bSortable:false,sClass:"dt-freq",mRender:function(e,t,a){return ut(a.freqs)}},{mData:"firstdt",sTitle:"from<span></span>",sClass:"dte",sWidth:D.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],mRender:function(e,t,a){return parseInt(a.firstdt)&&parseInt(a.lastdt)?ht(w(e,a.freqs[0])):""}},{mData:"lastdt",sTitle:"to<span></span>",sClass:"dte",sWidth:D.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){return parseInt(a.firstdt)&&parseInt(a.lastdt)?ht(w(e,a.freqs[0])):""}},{mData:"titles",sTitle:"Category (click to browse)<span></span>",sClass:"cat",sWidth:T.widths.publicSeriesTable.columns.category+"px",bSortable:true,mRender:function(e,t,a){if(a.apiid!=null&&a.title!=null){return'<span class="ui-icon browse-right">browse similar series</span> '+ht(e)}else{return ht(e)}}},{mData:null,sTitle:"Source<span></span>",bSortable:false,sClass:"url",sWidth:D.src+"px",resize:false,mRender:function(e,t,a){return ft(a.url,a.src)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){P.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");_t()}if(t.hasClass("cat")){var a=t.closest("tr").find("span.handle").html();if(a)la(a.substr(1))}});$("#tblPublicSeries_info").html("").appendTo("#cloud-series-search");$("#tblPublicSeries_filter").hide();$("#public-settype-radio").buttonset().find("input").change(ct);$("#find-data-map").click(l.selectMap);$("#series_search_freq").change(ct);$("#series_search_source").change(ct);$("#series_search_text").val("enter search keywords (-keyword to exclude)").keyup(function(e){lt(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")});$("#cloud-series-browse").button({icons:{secondary:"ui-icon-circle-triangle-e"}}).click(function(){la()})}function it(){N=$("#my_graphs_table").html(" ").dataTable({sDom:"frti",bFilter:true,bPaginate:false,bAutoWidth:false,bProcessing:true,bDestroy:true,fnInfoCallback:function(e,t,a,n,i,s){return(n==i?"":"found "+i+" of ")+n+" graphs"+(i>0?" <b>Click on a title to open</b>":"")},oLanguage:{sSearch:""},oColReorder:{iFixedColumns:2},sScrollY:T.heights.innerDataTable-120+"px",sScrollX:T.widths.myGraphsTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"wrap title",sWidth:T.widths.myGraphsTable.columns.title+"px",mRender:function(e,t,a){return e.trim()+'<span class="handle" data="G'+a.gid+'">G'+a.gid+"</span> "}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:D.map+"px",mRender:function(e,t,a){return(a.plottypes.indexOf("M")!=-1?p.hasBubbleMap:p.hasHeatMap)+(a.plottypes.indexOf("X")!=-1?p.hasMarkerMap:"")+(a.cubeid?p.hasCubeViz:"")+ht(s.maps[e].name)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:true,sClass:"analysis",sWidth:T.widths.myGraphsTable.columns.analysis+"px",mRender:function(e,t,a){return ht((e||"").trim())}},{mData:"serieslist",sTitle:"Series ploted or mapped<span></span>",bSortable:true,sClass:"series",sWidth:T.widths.myGraphsTable.columns.series+"px",mRender:function(e,t,a){return ht(e)}},{mData:null,sTitle:"Views<span></span>",bSortable:true,sClass:"dt-count",sWidth:D.views+"px",mRender:function(e,t,a){if(a.published=="N"){return'<span class=" ui-icon ui-icon-locked" title="This graph has not been published.  You must publish your graphs from the graph editor">locked</span>'}else{return a.views}}},{mData:"updatedt",sTitle:"Created<span></span>",asSorting:["desc","asc"],sType:"numeric",sClass:"dte",sWidth:D.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");N.find("tr.ui-selected").removeClass("ui-selected");var a=N.fnGetData(t.closest("tr").addClass("ui-selected").get(0));mt(a.ghash)});$("#my_graphs_table_filter").prependTo("#myGraphsHeader").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#my_graphs_table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("search my graphs").addClass("grey-italics").on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ot);$("#my_graphs_table_info").appendTo("#myGraphsHeader")}function st(){R=$("#tblPublicGraphs").dataTable({sDom:"frti",bPaginate:false,bDestroy:true,bAutoWidth:false,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bProcessing:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public graphs"},bServerSide:true,fnServerData:function(e,t,a){t.push({name:"command",value:"SearchGraphs"});t.push({name:"search",value:$("#tblPublicGraphs_filter input").val()});$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,n){if(e.status=="ok")a(e,t,n);else vt("server error",e.status)},complete:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,n,i,s){return i+" graph"+(i==1?"s":"")+(i>0?" <b>click on title to view</b>":"")},iDeferLoading:0,oColReorder:{iFixedColumns:2},sScrollX:T.widths.publicGraphTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"title",sWidth:T.widths.publicGraphTable.columns.title+"px",mRender:function(e,t,a){return e+'<span class="handle">G'+a.graphid+"</span>"}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:D.map+"px",mRender:function(e,t,a){return(a.mapsets?p.hasHeatMap:"")+(a.pointsets?p.hasMarkerMap:"")+(a.themeid?p.hasCubeViz:"")+ht(e)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:false,sWidth:T.widths.publicGraphTable.columns.analysis+"px"},{mData:"serieslist",sTitle:"Series<span></span>",bSortable:false,sClass:"series",sWidth:T.widths.publicGraphTable.columns.series+"px"},{mData:"views",sTitle:"Views<span></span>",bSortable:true,sClass:"count",sWidth:D.views+"px"},{mData:"modified",sTitle:"Modified<span></span>",bSortable:true,sType:"numeric",asSorting:["desc","asc"],sClass:"dte",sWidth:D.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");R.find("tr.ui-selected").removeClass("ui-selected");var a=R.fnGetData(t.closest("tr").addClass("ui-selected").get(0));var n=R.find("tr.ui-selected");if(n.length==1){var a=R.fnGetData(n.get(0));if(a){hasher.setHash(encodeURI("t=g&graphcode="+a.ghash))}else{vt("search for public graphs",_.noPublicGraphs)}}});$("#tblPublicGraphs_info").appendTo("#public_graphs_search");$("#tblPublicGraphs_filter").hide();$("#graphs_search_text").val("enter search terms or leave blank for latest graphs").keyup(function(e){pt(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")});$("#graphs-search-button").click(pt)}function ot(){var e=$(this);var t=e.closest("div").find("span.filterReset");if(e.val().length==0){t.removeClass("ui-icon-circle-close").addClass("ui-icon-circle-close-inactive")}else{t.removeClass("ui-icon-circle-close-inactive").addClass("ui-icon-circle-close")}}function rt(e){var t=new Date;var a=t.toDateString();if(isNaN(e)){t.setTime(Date.parse(e))}else{t.setTime(e)}if(t.toDateString()==a){return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(16,5)+"</span>"}else{return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(4,11)+"</span>"}}function lt(e){var t="which"in e?e.which:e.keyCode;if(F){var a=$("#series_search_text");a.val(a.val().replace("category: ",""));F=0}if(t==13&&e.target.id=="series_search_text"||e.target.id!="series_search_text"){ct();e.preventDefault()}}function ct(e){ua();var t=$("#series_search_text");if(F&&$("#series_search_source").val()!="ALL"){t.val(t.val().replace("category: ",""));F=0}var a=t.hasClass("grey-italics")?"":t.val();if(a.match(/(title|name|skey):"[^"]+"/i)==null){a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/\s+/g," +");a=a.replace("+-","-")}$("#tblPublicSeries_filter input").val(a);P.fnFilter(a);if(!e)Xt()}function dt(e){var t='title:"'+$(e).text()+'"';$("#series_search_text").val(t);ct()}function pt(e){var t="which"in e?e.which:e.keyCode;if(t==13&&e.target.id=="graphs_search_text"||e.target.innerHTML=="search"){var a=$("#graphs_search_text").hasClass("grey-italics")?"":$("#graphs_search_text").val();a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/ /g," +");$("#tblPublicGraphs_filter input").val(a);R.fnFilter(a);Xt()}}function ut(e){switch(e){case"D":return'<span title="Daily data">D</span>';case"W":return'<span title="Weekly data">W</span>';case"M":return'<span title="Monthly data">M</span>';case"Q":return'<span title="Quarterly data">Q</span>';case"SA":return'<span title="Semi-annual data">SA</span>';case"A":return'<span title="Annual data">A</span>';default:return e}}function ht(e){return'<span title="'+(e==null?" ":e)+'">'+(e==null?" ":e)+"</span>"}function ft(e,t){if(!e)return t||"";t=t||e.replace(/\b(http(s)*:\/\/)*(www.)*/gi,"").replace("/"," /");return'<a href="'+e+'" target="_blank" title="'+e+'"><span class=" ui-icon ui-icon-extlink">'+e+"</span>"+t+"</a>"}function mt(e){y(e);St()}var gt;function bt(){vt("User Agreement","<span id=\"dialog-top\">MashableData is a free workbench to analyze and graph data series.  Data series viewed using our plugin have been securely cached in your browser's local storage.  To power the workbench, the data series must be shared with our servers.  Once sharing is enabled, you will be able to search and view series and public graphs on MashableData.com's servers.<br /><br />"+'<span id="dialog-learn"><i>To learn more, please read <a href="/" target="help">how MashableData works</a> and our <a href="/" target="help">privacy policy</a>.</i></span>'+"<br /><br />Ok to anonymously share the datasets you have browsed?</span>",[{text:"Enable",id:"btn-dia-enable",click:function(){var e=new Date;window.localStorage.setItem("authorized",e);Z();$(this).dialog("close")}},{text:"Disable",id:"btn-dia-disable",click:function(){window.localStorage.clear();window.localStorage.setItem("authorized","no");$(this).dialog("close");window.location="."}}])}function vt(e,t,a){$("#dialog").html("<br><br>"+t+"<br><br>");if(!a){a=[{text:"OK",id:"btn-OK",click:function(){$(this).dialog("close")}}]}gt=$("#dialog").dialog({modal:true,title:e,width:500,buttons:a,open:function(){$("#btn-dia-enable").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}function yt(){var e,t=0,a={},i=window.localStorage.getItem("newSeries");if(i!=null){window.localStorage.removeItem("newSeries");var s=JSON.parse(i);var o=new Date;var r={command:"UploadMyMashableData",adddt:o.getTime(),series:[]};for(var l=0;l<s.length;l++){t++;e=JSON.parse(localStorage.getItem(s[l]));localStorage.removeItem(s[l]);e.handle="L"+V++;e.data=n.common.mashableDataString(e);if(account.loggedIn()){r.series.push(e);a[e.handle]=e}else{h[e.handle]=e;Ot($.extend({},e))}}if(account.loggedIn()){M(r,function(t,n,i){var s;for(var o in t.handles){s=t.handles[o];a[o].handle=s;e.usid=s.substr(1);Ot($.extend({},a[o]))}})}}z=true;return t}function wt(e,t){var a=window.localStorage.getItem(t);var n=false;if(a==null){}else{var i=a.split("|");for(var s=0;s<i.length;s++){if(i[s]==e){i.splice(s,1);n=true}}if(i.length==0){window.localStorage.removeItem(t)}else{window.localStorage.setItem(t,i.join("|"))}}return n}function kt(){var e=$("div.picker:visible").length;if(e==1){$(".show-hide").slideToggle(function(){var e=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");$(e).hide()});$("#show-hide-pickers").hide({complete:Xt})}else{$(".show-hide").slideToggle(function(){});if(G.find("li.graph-tab").length>0)$("#show-hide-pickers").show()}}function xt(){if($("div.picker:visible").length==0)kt()}function St(){if($("div.picker:visible").length==1)kt()}function Mt(e){var t=$(e).closest("div.graph-panel").get(0).id;u[t].controls.chart.setTitle({text:e.value});u[t].title=e.value;if(e.value.length==0){var a="Graph"+t.substring(t.indexOf("-")+1);$("a[href=#"+t+"]").html(a).attr("title",a)}else{$("a[href=#"+t+"]").html(e.value).attr("title",e.value)}u[t].controls.chart.redraw()}function Ct(){var e=[],t=false;$("#local-series-header input").focus();L=I.find("tr.ui-selected").each(function(){e.push(I.fnGetData(this))});if(e.length==0){for(var a in h){t=true;break}if(t)vt("no series selected",_.noSeriesSelected);else vt("no series selected",_.noMySeries)}else{Dt(e,false,false)}}function _t(){var e=[],t=false,a;$("#series_search_text").focus();P.find("tr.ui-selected").each(function(){e.push(P.fnGetData(this))});if(e.length==0){vt("selection required",_.noSeriesSelected)}else{var n=$("#find-data-map").val();if(n=="none")n=false;Dt(e,n,true)}}function Dt(e,t,a){var i=false,o={},r,l,c;for(c=0;c<e.length;c++){r=e[c];if(!r.data){l=r.handle();o[l]={setid:r.mastersetid||r.setid,freq:r.preferedFreq(),geoid:r.geoid,latlon:r.latlon};i=true}}if(i){M({command:"GetSeries",series:o,map:t?{code:t,bunny:s.maps[t].bunny}:false},function(i,s,o){for(c=0;c<e.length;c++){l=e[c].handle();if(i.series[l]){var r=new n.Set(i.series[l]);if(t)r.preferredMap=t}if(h[r.handle()]){h[l]=r}e.splice(c,1,r)}Tt(e,t,a)})}else{Tt(e,t,a)}}function Tt(e,t,a){var i,r,l,c,d=[],p=[],h=[],f=[];var m=[],g=[];var b=$("#quick-view-maps");$("#quick-view-geo-select").hide().html("").off().change(function(){console.log($(this).val())});if(e.plots){i=e;H=e;var v=$("#quick-view-change-freq").hide();if(v.selectmenu)v.selectmenu("destroy");$quickViewChangeGeo.hide()}else{if(e instanceof Array)r=e;else r=[e];H=r;$("#quick-view-geo-select").hide();if(r.length==1&&r[0].settype!="S"){$quickViewChangeGeo.show();
$("#outer-show-graph-div .ui-autocomplete").remove()}else{$("#quick-view-change-freq").hide().selectmenu("destroy");$quickViewChangeGeo.hide()}i=new n.Graph;var y=[],w=[];for(l=0;l<r.length;l++){i.addPlot([new n.Component(r[l])]);if(w.indexOf(r[l].freq)===-1)w.push(r[l].freq);if(y.indexOf(r[l].freqs.toString())===-1)y.push(r[l].freqs.toString())}if(y.length==1&&w.length==1){var x="";$.each(r[0].freqs,function(e,t){x+='<option value="'+t+'" '+(t==r[0].freq?"selected":"")+">"+s.period.name[t]+"</option>"});$("#quick-view-change-freq").html(x).off().change(function(){var e=this.value;$.each(r,function(){this.freq=e;delete this.data}).selectmenu();Dt(r,t,a)})}else{$("#quick-view-change-freq").hide().selectmenu("destroy")}}var S=o.makeChartOptionsObject(i);i.eachComponent(function(){if(s.MySets[this.handle()])p.push(s.MySets[this.handle()]);if(!s.MySets[this.handle()])d.push(i.assets[this.handle()])});delete S.chart.height;if(r instanceof Array){if(r.length==1){S.title={text:r[0].name()};S.legend={enabled:false}}else{delete S.title}for(l=0;l<r.length;l++){if(r[l].themeid){h.push(r[l].themeid);if(f.indexOf(r[l].setid)===-1)f.push(r[l].setid)}}}S.chart.borderWidth=2;S.chart.renderTo="highcharts-div";Y=new Highcharts.Chart(S);var M,C="";if(!e.plots){if(r.length==1){M=r[0];if(M.setmetadata)C+="<tr><td>Set notes:</td><td>"+M.setmetadata+"</td></tr>";if(M.seriesmetadata)C+="<tr><td>Series notes:</td><td>"+M.seriesmetadata+"</td></tr>";if(M.categories)C+="<tr><td>Categories:</td><td>"+M.categories+"</td></tr>";if(M.src)C+='<tr><td>API Source:</td><td><a href="'+M.url+'" target="_blank">'+M.src+(M.sourcekey?" (source key: "+M.sourcekey+") ":"")+"</a></td></tr>";if(C)C="<table>"+C+"</table>";C='<span class="right">'+M.setid+"</span>"+C}var _=s.orderedMapList,D=s.maps,T=M.settype=="X"?0:1;if(M.maps){for(l=0;l<_.length;l++){for(c=0;c<r.length;c++){M=r[c];if(M.maps[_[l].map]>T){m.push('<option value="'+_[l].map+'"'+(M.preferredMap=_[l].map?" selected":"")+'">'+_[l].name+" ("+M.maps[_[l].map]+(M.settype=="X"?" points":"%")+")</option>");break}}}}}$("#qv-info").html(C);if(m.length){$("#quick-view-chart-or-map").show().find("input").off().click(P);t=b.html(m.join("")).val(t).val();P()}else{b.hide();$("#quick-view-chart-or-map").hide()}if(a&&d){$("#quick-view-to-series").show()}else{$("#quick-view-to-series").hide()}if(p.length>0){$("#quick-view-delete-series").show()}else{$("#quick-view-delete-series").hide()}var A=k(),U='<option value="new">new graph</option>';$("div.graph-panel").each(function(){var e=$("ul#graph-tabs li a[href='#"+this.id+"']");U+='<option value="'+this.id+'">'+e.html()+"</option>"});It($("#quick-view-select-viz"),f,h);var I=A&&u[A].map&&t&&u[A].map==t?A:"new";$("#quick-view-to-graphs").html(U).val(I).off().click(function(){$("#quick-view-add-to-graph").find(".ui-button-text").html($(this).val()=="new"?"create graph":"add to graph")}).click();$(".show-graph-link").click();function P(){var e=$("#quick-view-chart-or-map input:checked").val()!="chart";var t=b.css("display")!="none";if(e&&!t||!e&&t)b.animate({width:"toggle"})}}function At(e){$(e).button("disable");for(var t=0;t<H.length;t++){H[t].savedt=(new Date).getTime();var a=Ot(H[t]);qt(H[t])}vt("My Series","series added.",[]);$("#dialog").closest(".ui-dialog").fadeOut(1e3,function(){$("#dialog").dialog("close")})}function Ut(){if(H.length==1&&H[0].geoid&&H[0].geoid>0){var e=H[0],t={command:"GetSetGeographies"},a="",n,i;if(e.settype=="X")t.mastersetid=e.setid||e.mastersetid;if(e.settype=="M")t.setid=e.setid;M(t,function(t){for(var s=0;s<t.geographies.length;s++){n=t.geographies[s];if(t.mastersetid){i=n.latlon==e.latlon;a+='<option value="'+n.latlon+'" '+(i?"selected":"")+">"+n.name+"</option>"}else{i=n.geoid==e.geoid;a+='<option value="'+n.geoid+'" '+(i?"selected":"")+">"+n.name+"</option>"}}$quickViewChangeGeo.slideUp();var o=$("#quick-view-geo-select").html(a).off().slideDown().change(function(){console.log($(this).val())});o.combobox()})}else{vt("change geography","Expecting to change geography of a single series in geoset. Problems encountered.")}}(function(e){e.widget("custom.combobox",{_create:function(){this.wrapper=e("<span>").addClass("custom-combobox").insertAfter(this.element);this.element.hide();this._createAutocomplete();this._createShowAllButton()},_createAutocomplete:function(){var t=this.element.children(":selected"),a=t.val()?t.text():"";var n=this;this.input=e("<input>").appendTo(this.wrapper).val(a).attr("title","").focus(function(){e(this).select()}).keyup(function(e){var t="which"in e?e.which:e.keyCode;if(t==13||t==9){}}).addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left").autocomplete({delay:0,position:{my:"right bottom",at:"right top",within:"#fancybox-content"},minLength:0,source:e.proxy(this,"_source")}).tooltip({tooltipClass:"ui-state-highlight",content:"search or select from list"});this._on(this.input,{autocompleteselect:function(e,t){t.item.option.selected=true;this._trigger("select",e,{item:t.item.option})},autocompletechange:"_removeIfInvalid"})},_createShowAllButton:function(){var t=this.input,a=false;e("<a>").attr("tabIndex",-1).attr("title","Show All Items").tooltip().appendTo(this.wrapper).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").mousedown(function(){a=t.autocomplete("widget").is(":visible")}).click(function(){t.focus();if(a){return}t.autocomplete("search","")})},_source:function(t,a){var n=new RegExp(e.ui.autocomplete.escapeRegex(t.term),"i");a(this.element.children("option").map(function(){var a=e(this).text();if(this.value&&(!t.term||n.test(a)))return{label:a,value:a,option:this}}))},_removeIfInvalid:function(t,a){if(a.item){c(e(a.item.option).val());return}var i=this.input.val(),o=i.toLowerCase(),r=false,l;this.element.children("option").each(function(){if(e(this).text().toLowerCase()===o){this.selected=r=true;l=e(this).val();c(l);return false}});if(r){return}this.input.val("").attr("title",i+" didn't match any item").tooltip("open");this.element.val("");this._delay(function(){this.input.tooltip("close").attr("title","")},2500);this.input.autocomplete("instance").term="";function c(e){if(H.length==1&&H[0].geoid!=l){var t=H[0];M({command:"GetSeries",series:{newgeo:{setid:t.mastersetid||t.setid,freq:t.freq,geoid:e,latlon:t.latlon}}},function(e,t,a){var i=new n.Set(e.series["newgeo"]);if(H[0].preferredMap)i.preferredMap=H[0].preferredMap;H[0]=i;Y.get("P0").remove();Y.addSeries({color:s.hcColors[0],dashStyle:"solid",data:i.chartData(),name:i.name(),freq:i.freq,id:"P0"});Y.setTitle({text:i.name()})})}}},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);function $t(){var e=$("#quick-view-to-graphs").val();var t=false,a=false;if($("#quick-view-chart-or-map:visible").length){switch($("#quick-view-chart-or-map input:radio:checked").val()){case"map":t=true;break;case"chart-and-map":t=a=true;break;default:a=true}}else{a=true}if(t){var i=$("#quick-view-maps").val();if(u[e]&&u[e].map&&(u[e].map!=i||u[e].mapFreq()!=H[0].freq)){vt("Map Error","This graph already has a "+u[e].map+" map.  Additional maps and map data can be added, but must use the same base map and frequency.");return null}if(i=="other"){vt("selection required","Please select a base map to graph this set.");return null}}var o;if(e=="new"){o=new n.Graph}else{o=u[e];o.controls.provenance.commitChanges(false)}if(t){o.map=i;o.mapconfig.legendLocation=s.maps[i].legend;o.fetchMap()}var r=[],l=[];if(H.plots){if(a){if(!o.plots)o.plots=[];for(var d=0;d<H.plots.length;d++){o.plots.push(H.plots[d])}}}else{for(var p=0;p<H.length;p++){var h=H[p],f=new n.Component(h);if(a)o.addPlot([f]);if(t){if(h.maps&&h.maps[i]){var m=new n.Component(h);delete m.geoid;delete m.geoname;delete m.latlon;delete m.data;if(m.themeid){r.push(m.themeid);l.push(m.setid)}if(m.isMapSet()){o.addMapPlot([m])}if(m.isPointSet()){o.addPointPlot([m])}}}}}var g=$("#quick-view-select-viz").val();if(g!=""){if(isNaN(g)){o.mapconfig.mapViz=g}else{o.cubeid=g}}o.fetchAssets(function(){o.fetchMap(function(){o.title=o.title||(o.mapsets?o.mapsets[0].name():o.pointsets?o.pointsets[0].name():o.plots[0].name());if(e=="new"){c(o)}else{$("ul#graph-tabs li a[href='#"+e+"']").click();o.controls.redraw()}Qt("drawing");Xt()})});St();Pt()}function It(e,t,a,n){if(!a.length&&n){t=[];n.eachComponent(function(){if((this.isMapSet()||this.isPointSet())&&this.themeid){if(t.indexOf(this.setid)===-1)t.push(this.setid);if(a.indexOf(this.themeid)===-1)a.push(this.themeid)}});t.sort()}var i=n?n.possibleCubes:false;if(t.length>0&&!(i&&i.setsids==t.join())){M({command:"GetCubeList",setids:t,themeids:a},function(e,a,o){i={setsids:t.join(),cubes:e.cubes};if(n)n.possibleCubes=i;s()})}else s();function s(){var t='<option value="none">select a data cube or map interaction</option>'+'<optgroup class="non-cube-vizes"  label="visualizations with mouseover interactions">'+'<option value="scatter">scatter plot of maps with linear regression and correlation coefficient</option>'+'<option value="line">line chart of highlighted geographies</option>'+'<option value="line-bunnies">line chart with national data of highlighted geographies</option>'+'<option value="components-bar">bar chart of map components of highlighted geographies</option>'+'<option value="components-line">line chart of summed map components of highlighted geographies</option>'+'<option value="list-asc">ordered list (ascending)</option>'+'<option value="list-desc">ordered list (descending)</option>'+"</optgroup>";var a,s=false,o,r=false;if(i&&i.cubes.length){for(a=0;a<i.cubes.length;a++){o=i.cubes[a];if(r!=o.type){t+=(r?"</optgroup>":"")+'<optgroup class="cubes" label="show supplementary data '+o.type+' on geography click">';r=o.type}t+='<option value="'+o.cubeid+'"'+(n&&o.cubeid==n.cubeid?" selected":"")+">"+o.name+"</option>";if(n&&o.cubeid==n.cubeid)s=true}t+="</optgroup>"}if(!s&&n&&n.cubeid)t='<select value="'+n.cubeid+'" selected>'+n.cubename||"data cube"+"</select>"+t;e.html(t)}return i}function Pt(){Y.destroy();delete L;$("#fancybox-close").click()}function Nt(e){if($("#outer-show-graph-div:visible").length==1)Pt();if(e.length==1){var t=e[0];if(t.mapsetid||t.pointsetid){var a='<div id="seriesOrSet" style="width:330px;">'+"<h4>This series is part of a set</h4>"+'<label><input type="radio" name="editSeriesOrSet" value="series" checked> edit just this series </label><br>'+'<label><input type="radio" name="editSeriesOrSet" value="set"> view and edit the set\'s series for the map:<br>'+'<select class="hidden" style="margin-top: 8px;margin-left: 25px"></select></label><br><br>'+'<button class="right" id="seriesOrSetCancel">cancel</button> <button class="right" id="seriesOrSetOk">OK</button>'+"</div>";$.fancybox(a,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var n=$("#seriesOrSet");var i,s="",o=n.find("select").html("").show().click(function(){n.find("input:radio").removeAttr("checked").filter('[value="set"]').attr("checked","checked")});if(t.geocounts){for(i in t.geocounts){s+='<option value="'+i+":"+mapsList[i].jvectormap+'">'+i+" ("+t.geocounts[i].set+")</option>"}o.html(s)}else{M({command:"GetAvailableMaps",mapsetid:t.mapsetid,pointsetid:t.pointsetid,geoid:t.geoid},function(e,t,a){for(var n=0;n<e.maps.length;n++){s+='<option value="'+e.maps[n].name+":"+e.maps[n].file+'">'+e.maps[n].name+" ("+e.maps[n].count+")</option>"}o.html(s)})}$("#seriesOrSetOk").button({icons:{secondary:"ui-icon-check"}}).click(function(){if($("input:radio[name='editSeriesOrSet']:checked").val()=="series"){Rt(e)}else{if(t.pointsetid)Rt("X"+t.pointsetid,o.val());if(t.mapsetid)Rt("M"+t.mapsetid,o.val())}$.fancybox.close()});$("#seriesOrSetCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}else Rt(e)}else Rt(e)}function Rt(e,t){if(!account.loggedIn()){vt("account required",_.signInRequired);return}var a;var n=false;var i=false;var o=2;var r="U";$("#series-tabs").find("li.local-series a").click();var l=["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"];var c=null,d={U:{name:0,units:1,notes:2,handle:3,header:4},M:{name:0,units:1,notes:2,geoid:3,handle:4,header:5},X:{name:0,units:1,notes:2,geoid:3,handle:4,lat:5,lon:6,header:7}};if(e&&!Array.isArray(e)){require(l);if(e[0]=="M"){r=e;M({command:"GetSet",mapsetid:parseInt(r.substr(1)),map:t.split(":")[0],modal:"persist"},function(e,t,a){require(l,function(){p(e.setData)})});function p(e){f();var t,a,n,i,s,l=[["map set",e.name],["units",e.units],["notes",""],["geoid"],[r],["date"]];for(n=0;n<e.geographies.length;n++){l[d.M.geoid].push(e.geographies[n].geoid);console.info("trying to set mapset's series handles");l[d.M.handle].push(e.geographies[n].handle);l[d.M.header].push(e.geographies[n].geoname);s=d.M.header+1;if(e.geographies[n].data){t=e.geographies[n].data.split("|");t.sort();for(i=0;i<t.length;i++){a=t[i].split(":");while(s<l.length&&l[s][0]<a[0])l[s++].push("");if(s==l.length){l.push(c())}else{if(l[s][0]==a[0])l[s].push(a[1]);if(l[s][0]<a[0])l.splice(s,0,c())}s++}}while(s<l.length)l[s++].push("");function c(){var e,t=[a[0]];for(e=1;e<l[4].length-1;e++)t.push("");t.push(a[1]);return t}}o=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:o}).find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();Zt()}}if(e[0]=="X"){r=e;M({command:"GetPointSets",pointsetids:[parseInt(r.substr(1))],map:t.split(":")[0],modal:"persist"},function(e,t,a){require(l,function(){u(e.pointsets[r])})});function u(e){f();var t,a,n,i,s,l=[["marker set",e.name],["units",e.units],["notes",""],["geoid"],["lat"],["lon"],[r],["date"]];for(var c in e.data){l[d.X.geoid].push(e.data[c].geoid);l[d.X.handle].push(e.data[c].handle);l[d.X.lat].push(e.data[c].lat);l[d.X.lon].push(e.data[c].lon);l[d.X.handle].push(e.data[c].handle);l[d.X.header].push(e.data[c].name.replace(e.name,"").trim());s=d.X.header+1;if(e.data[c].data){t=e.data[c].data.split("|");t.sort();for(i=0;i<t.length;i++){a=t[i].split(":");while(s<l.length&&l[s][0]<a[0])l[s++].push("");if(s==l.length){l.push(p())}else{if(l[s][0]==a[0])l[s].push(a[1]);if(l[s][0]<a[0])l.splice(s,0,p())}s++}}while(s<l.length)l[s++].push("");function p(){var e,t=[a[0]];for(e=1;e<l[d.X.header].length-1;e++)t.push("");t.push(a[1]);return t}}o=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:o}).find("table.htCore tr").show().filter(":eq("+d.X.handle+")").hide().end().filter(":eq("+d.X.geoid+")").hide();Zt()}}}else{require(l,function(){g(e)})}function f(){o=2;var e=0,t=0;var s=$("div#edit-user-series").height($("div#local-series").height()).fadeIn();a=$("#data-editor").height($("div#local-series").height()-50).html("");s.find("button.series-edit-save").button({icons:{secondary:"ui-icon-disk"}}).off().click(function(){y()});s.find("button.series-edit-cancel").button({icons:{secondary:"ui-icon-close"}}).off().click(function(){k()});s.find("button.series-edit-preview").button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var e=v();if(e)Tt(e,false,false)});s.find("button.series-edit-geoset").button({icons:{secondary:"ui-icon-flag"}}).show().off().click(function(){b()});s.find("button.series-edit-save-as").button({icons:{secondary:"ui-icon-copy"}});a.handsontable({minCols:2,minSpareCols:-1,minSpareRows:1,autoWrapRow:true,contextMenu:["row_above","row_below","col_right"],fillHandle:false,cells:function(e,t,a){var n={};if(e<d[r[0]].header&&t==0||e==d[r[0]].header){n.readOnly=true}n.type={renderer:m};return n},onSelection:function(n,s,o,r){if(n==o&&s==r){var l=$(a.handsontable("getCell",n,s)).css("background-color").toUpperCase();if(l=="RGB(224, 255, 255)"||l=="#E0FFFF")a.handsontable("selectCell",n,s+1);if(l=="RGB(128, 128, 128)"||l=="#808080"){a.handsontable("selectCell",n+(t==s&&e-n==1?-1:1),s)}e=n;t=s;if(n>4){var c=a.handsontable("getDataAtCell",n,0);if(c==""||c==null){var d=(a.handsontable("getDataAtCell",n-1,0)||"").toString();if(d.length>3){var p=ea(d);if(p){i=Jt(d);if(i){a.handsontable("setDataAtCell",n,0,w(ta(p,i),i))}}}}}}},onBeforeChange:function(e){var t=0;for(var a=0;a<e.length;a++){if(e[a][1]>t)t=e[a][1]}if(t>=o){o=t+1;$("#data-editor").handsontable("updateSettings",{cols:o});for(a=2;a<o;a++)$("#data-editor").handsontable("getCell",3,a).innerHTML="value"}},onChange:function(e,t){if(t=="edit"||t=="empty"){try{var n=a.handsontable("getDataReference");for(var i=n[0].length-1;i>1;i--){var s="";for(var o=0;o<n.length;o++){if(o!=3)s+=n[o][i];if(U.test(s))break}if(U.test(s))break;a.handsontable("alter","remove_col",i,i+1)}n=a.handsontable("getDataReference");for(var o=n.length-1;o>5;o--){var s="";for(var i=0;i<n[0].length;i++){if(o!=3)s+=n[o][i]}if(U.test(s))break;if(o<n.length-1)a.handsontable("alter","remove_row",o)}}catch(r){console.log(r)}}}});n=true}function m(e,t,a,n,i,s,l){switch(r[0]){case"U":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.U.header&&n==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}if(a==d.U.header){t.style.background="#808080";t.style.fontWeight="bold"}break;case"M":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.M.header){if(n==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}else{if(n==1){t.colSpan=Math.min(5,o-1)}else{$(t).addClass("hidden")}}}if(a==d.M.header){t.style.background="#808080";t.style.fontWeight="bold"}}}function g(e){if(!n)f();var t,a,s=$("#data-editor");$("button#series-edit-save").attr("disabled","disabled");if(e){var o=e[0],r=o.handle;var l=r[0];switch(l){case"U":$("button#series-edit-save").removeAttr("disabled");case"S":i=o.period;if(o.data){t=o.data.split("|").sort();for(a=0;a<t.length;a++){t[a]=t[a].split(":");t[a][0]=w(S(t[a][0]).getTime(),o.period)}t.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);s.attr("data",r).handsontable("loadData",t);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()}else{var c=[],p=[];if(r.charAt(0)=="U")p.push(parseInt(r.substr(1)));else c.push(parseInt(r.substr(1)));M({command:"GetMashableData",sids:c,usids:p},function(e,t,a){o.data=e.series[r].data;o.notes=e.series[r].notes;var n=e.series[r].data.split("|").sort();for(var i=0;i<n.length;i++){n[i]=n[i].split(":");n[i][0]=w(S(n[i][0]).getTime(),o.period)}n.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);s.attr("data",r).handsontable("loadData",n);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()})}break;default:vt("series editor","This option is not yet supported");return}}else{s.handsontable("loadData",[["name",""],["units",""],["notes",""],["handle","new"],["date","value"]]);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide();i=false}$("div#edit-user-series").slideDown()}function b(){e();function e(){var e,a="",n;for(var i in s.maps){a+='<option value="'+i+'">'+s.maps[i].name+"</option>"}var o='<div id="setsWizard" style="width:330px;">'+"<h4>Create a set of series that can be mapped:</h4>"+'<label><input name="setsWizardType" type="radio" value="M" checked /> as regions</label><br />'+'<label><input name="setsWizardType" type="radio" value="X" /> as points (requires latitudes and longitudes)</label><br /><br />'+'<select id="setsWizardMap" style="width: 300px;">'+'<option value="nomap" class="nomap">select map</option>'+a+"</select><br><br>"+'<button class="right" id="setsWizardCancel">cancel</button><button class="right" id="setsWizardOk">OK</button>'+"</div>";$.fancybox(o,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});$("#setsWizardMap").change(function(){if($(this).val()!="nomap"){$("#setsWizardOk").button("option","disabled",false);$(this).find("option[value='nomap']").remove()}});$("#setsWizardOk").button({icons:{secondary:"ui-icon-check"},disabled:true}).click(function(){t($("#setsWizardMap").val(),$("#setsWizardMap").text(),$("input:radio[name='setsWizardType']:checked").val());$.fancybox.close()});$("#setsWizardCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}function t(e,t,i){r=i;if(i=="M")M({command:"GetMapGeographies",map:e},n);else{var s=[["point set"],["units"],["notes"],["geoid"],["handle"],["date"]];for(var l=0;l<jsoData.geographies.length;l++){s[d.M.geoid].push(jsoData.geographies[l].geoid);s[d.M.name].push(jsoData.geographies[l].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();o=jsoData.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:s,minCols:o})}}function n(e,t,n){var i=[["map set"],["units"],["notes"],["geoid"],["handle"],["date"]];for(var s=0;s<e.geographies.length;s++){i[d.M.geoid].push(e.geographies[s].geoid);i[d.M.header].push(e.geographies[s].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();o=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:i,minCols:o})}}function v(){var e=$("#data-editor");e.handsontable("destroyEditor",false);var t=e.data("handsontable").getData();var a=1,n=[];var i,s,o,l,c=d[r];var p,u,h,f,m,g;for(p=1;p<t[0].length;p++){g=false;for(u=d[r[0]].header+1;u<t.length;u++){if(t[u][p]!==null&&U.test(t[u][p])){if(r=="U"&&(!U.test(t[d.U.name][p])||t[d.U.name][p]===null||!U.test(t[d.U.units][p])||t[d.U.units][p]===null)){vt("Invalid Series","Name and units are required fields.");return false}g=true;break}}var b;if(g){switch(r[0]){case"M":i={handle:t[d.M.handle][p],name:t[d.M.name][1]+" - "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.M.units][1],notes:t[d.M.geoid][p],geoid:t[d.M.geoid][p],savedt:(new Date).getTime()};b=d.M.header;break;case"X":i={handle:t[d.X.handle][p],name:t[d.X.name][1]+" "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.X.units][1],notes:t[d.X.notes][1],geoid:t[d.X.geoid][p],lat:t[d.X.lon][p],lon:t[d.X.lat][p],savedt:(new Date).getTime()};b=d.X.header;break;default:i={handle:t[d.U.handle][p],name:t[d.U.name][p],units:t[d.U.units][p],notes:t[d.U.notes][p],savedt:(new Date).getTime()};b=d.U.header;break}if(!i.handle){i.handle="L"+a++}if(i.name.length==0||i.units.length==0){vt("Invalid Series","Name and units are required fields.");return false}s=[];l="";for(u=b+1;u<t.length;u++){if(t[u][p]!==null&&t[u][p].length>0){if(isNaN(t[u][p])&&t[u][p].toLowerCase()!="null"){vt("Unreadable Values","Value cells must be numbers, 'null', or blank.");return false}m=ea(t[u][0]);if(!m){vt("Invalid Date Formats","Valid date formats are required in the left column for non-empty values.");return false}s.push({x:m.getTime(),y:parseFloat(t[u][p])})}}o=Lt(s);s.sort(function(e,t){return e.x-t.x});for(var v in s){var y=new Date(s[v].x);switch(o.period){case"A":l+="|"+y.getUTCFullYear()+":"+s[v].y;break;case"W":case"D":l+="|"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+":"+s[v].y;break;case"M":case"Q":case"SA":l+="|"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+":"+s[v].y;break;case"N":l+="|"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+" "+y.getUTCHours()+":"+y.getUTCHours()+":"+y.getUTCMinutes()+":"+s[v].y;break}}i.data=l.substr(2);i.period=o.period;if(i.data.trim().length>0){n.push(i);$.extend(i,o)}}}if(n.length==0){vt("No data","No date-value pairs found.");return false}return n}function y(){var e,t=v();if(t){M({command:"SaveUserSeries",series:t,set:r,setname:t[0].setname},function(a,n,i){for(e=0;e<t.length;e++){if(t[e].handle.substr(0,1)=="U"&&t[e].handle.substr(0,1)=="U"){I.find("span.handle:contains("+t[e].handle+")").each(function(){if($(this).html()==t[e].handle)I.fnDeleteRow($(this).closest("tr").get(0))})}t[e].handle="U"+a.series[e].usid;t[e].usid=a.series[e].usid;t[e].mapsetid=a.series[e].mapsetid;t[e].pointsetid=a.series[e].pointsetid;t[e].graph="";t[e].url="";t[e].username=account.info.name||"user";t[e].userid=account.info.userId||null;I.fnAddData(t[e]);h[t[e].handle]=t[e]}});k()}Zt()}function k(){var e=$("#data-editor");e.handsontable("destroy");e.attr("style","overflow:scroll;");$("div#edit-user-series").fadeOut()}}function Ft(){if(account.loggedIn())return account.info.userId;if(account.fb_user){var e={command:"GetUserId",authmode:"FB",username:account.fb_user.id,name:account.fb_user.name,email:account.fb_user.email,company:"",accesstoken:account.fb_user.accessToken};$.ajax({type:"POST",url:"api.php",data:e,dataType:"json",success:function(e,t,a){if(e.status=="ok"){console.info("GetUserId success");$.extend(account.info,account.fb_user,e);if(account.info.orgId&&account.info.orgName){$("#series_search_source").append('<option value="org">'+account.info.orgName+"</option>")}$("#menu-account").find(".ui-button-text").html(account.info.name);jt();if(account.subscribing)account.showSubscribe()}else{console.log(e);vt("Login Status",e.status)}},error:function(e,t,a){console.log(e)}});return false}return null}function jt(){var e,t,a,n;var i=new Date;var s={command:"UploadMyMashableData",adddt:i.getTime(),series:[]};for(e in h){if(e[0]=="L"){s.series.push(h[e])}}if(s.series.length>0){M(s,function(e,i,s){for(t in e.handles){a=e.handles[t];n=h[t];n.handle=a;n.sid=a.substr(1);delete h[t];h[a]=n;for(tab in u){o(u[tab],t,n)}for(var r in f){o(f[r],t,n)}}Bt()})}else{Bt()}function o(e,t,a){var n;if(e.assets){if(e.assets[t]){delete e.assets[t];e.assets[a.handle]=a}else{return}}e.eachComponent(function(){if(this.handle==t)this.handle=a.handle})}console.info("syncMyAccount run");M({command:"GetMyGraphs"},function(e,t,a){for(var n in e.graphs){f[n]=e.graphs[n];N.fnAddData(f[n])}})}function Bt(){M({command:"GetMySets",modal:"persist"},function(e,t,a){var i=[],s;for(var o in e.sets){e.sets[o].savedt=parseInt(e.sets[o].savedt);s=new n.Set(e.sets[o]);h[o]=s;i.push(s)}I.fnClearTable();I.fnAddData(i)})}function qt(e){if(Kt())return false;M({command:"ManageMySeries",modal:"none",jsts:e.savedt,handle:e.handle,to:e.save},function(e,t,a){})}function Ot(e){if(e.handle){if(e.savedt)e.savedt=parseInt(e.savedt);if(h[e.handle]){var t=I.find("button[data='"+e.handle+"']").closest("tr");if(t.length==1){I.fnDeleteRow(t.get(0))}}I.fnAddData(e);h[e.handle]=e}else{console.log("Error loading series object: invalid series handle.")}return e.handle}function Lt(e){var t={firstdt:null,lastdt:null,minValue:null,maxValue:null,period:"A",points:e.length};var a=null;var n=null;var i=null;var s=null;var o;if(t.points==1){o=new Date(e[0].x);if(o.getUTCMonth()!=0)t.period="M";if(o.getUTCDate()!=1)t.period="D";if(o.getUTCHours()+o.getUTCMinutes()+o.getUTCSeconds()!=0)t.period="T"}else{for(var r=0;r<t.points;r++){var l=e[r];if(t.firstdt==null||t.firstdt>l.x)t.firstdt=l.x;if(t.lastdt==null||t.lastdt<l.x)t.lastdt=l.x;if(t.minValue==null||t.minValue>l.y)t.minValue=l.y;if(t.maxValue==null||t.maxValue<l.x)t.maxValue=l.y;o=new Date(l.x);if(s==null){s=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()}else if(s!==true&&s!=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()){s=true}if(a==null){a=o.getUTCDate()}else if(a!==true&&a!=o.getUTCDate()){a=true}if(n==null){n=o.getUTCDay()}else if(n!==true&&n!=o.getUTCDay()){n=true}if(i==null){i=o.getUTCMonth()}else if(i!==true&&i!=o.getUTCMonth()){i=true}}if(s===true){t.period="T"}else if(n!==true){t.period="W"}else if(a===true){t.period="D"}else if(i===true){t.period="M"}else{t.period="A"}}return t}function Et(){var e;vt("confirm deletion",_.deleteMySeries,[{text:"delete",id:"btn-delete",click:function(){for(var t=0;t<L.length;t++){e=I.fnGetData(L.get(t));if(account.loggedIn()){e.save=null;qt(e)}delete h[e.handle];I.fnDeleteRow(L.get(t))}$(this).dialog("close");Pt()}},{text:"cancel",id:"btn-cancel",click:function(){$(this).dialog("close")}}])}function zt(e){var t=e.length==0?"Graph "+W:e;var a="graphTab"+W++;var n=G.tabs("add","#"+a,t);$("#"+a).addClass("graph-panel");$("#canvas").tabs().find(".ui-tabs-nav").sortable({axis:"x",distance:10});G.tabs("select",G.tabs("length")-1);$(".ui-tabs-selected a").each(function(){$(this).attr("title",$(this).html())});tt();$("#btnEditGraphTop").removeAttr("disabled");if($("#delete-my-series").attr("disabled")!="disabled"){$("button.add-to-graph").removeAttr("disabled")}$("#graph-tabs a:last").click(function(){St()});return a}function Gt(e){var t=$(e.target);var a=t.parent().children("a").attr("href");var n=a.substr(1);Wt(n);$(a).remove();t.parent().remove();delete u[n];G.tabs("refresh");if(G.find("li").length==0){E=null;$("#btnEditGraphTop").attr("disabled","disabled");$("button.add-to-graph").attr("disabled","disabled");X.click()}else{$("#graph-tabs a:last").click()}$("#graph_title").attr("value","")}function Wt(e){if(u[e]&&u[e].controls){var t=u[e].controls;if(t.chart){t.chart.destroy();delete t.chart;$.contextMenu("destroy","#"+e+" div.chart")}if(t.map){t.map.remove();delete t.map}if(t.vizChart){t.vizChart.destroy();delete t.vizChart}}}function Vt(e){var t=[];if(e.length==1){return e[0]}if(e.length==0){return""}firstTitleWords=e[0].split(" ");for(var a=0;a<firstTitleWords.length;a++){var n=true;for(var i=1;i<e.length;i++){var s=" "+e[i]+" ";if(s.indexOf(" "+firstTitleWords[a]+" ")==-1){n=false;break}}if(n){t.push(firstTitleWords[a])}}return t.join(" ")}function Ht(e){X=e;var t=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");var a=$(e).attr("data");$(e).parent().addClass("ui-tabs-selected ui-state-active");$(t).hide();$(a).show().find(".dataTables_filter input,#series_search_text,#graphs_search_text").get(0).focus();Xt();return false}function Yt(){var e,t=$("#series-tabs li.ui-tabs-selected a").attr("data"),a="grey-italics";switch(t){case"#local-series":e=$("#series-table_filter input");return encodeURI("t=ms"+(e.hasClass(a)?"":"&s="+e.val()));case"#cloud-series":if(F!=0){return encodeURI("t=cs&cat="+F)}else{e=$("#series_search_text");return encodeURI("t=cs"+(e.hasClass(a)?"":"&s="+e.val()+"&f="+$("#series_search_freq").val())+"&api="+$("#series_search_source").val()+"&sets="+$("#public-settype-radio").find("input:checked").val()+"&map="+$("#find-data-map").val())}case"#myGraphs":e=$("#my_graphs_table_filter input");return encodeURI("t=mg"+(e.hasClass(a)?"":"&s="+e.val()));case"#publicGraphs":e=$("#public_graphs_search input");return encodeURI("t=cg"+(e.hasClass(a)?"":"&s="+e.val()));default:var n=k();if(n&&u[n]){return encodeURI("t=g"+n.substr(8)+(u[n].ghash?"&graphcode="+u[n].ghash:""))}}}function Xt(e,t){if(e){a="t=g"+t.replace("graphTab","")+"&graphcode="+e}else{var a=Yt()}if(a&&hasher.getHash()!=a){if(hasher.getHash().search("t=g&graphcode=")==-1){et(a)}else{hasher.replaceHash(a)}}}function Kt(){if(!account.loggedIn()){$("#dialog").html("<span><p>You must be signed in to use this function.  You can sign into MashableData.com with your Facebook account.  (Google+ account federation coming soon!)</p>"+"<p>Logging in does <em>not</em> grant MashableData automatic access to your email or to post to your account.</p>"+"</span><br>");gt=$("#dialog").dialog({modal:true,title:"Sign in required",width:500,buttons:[{text:"Close",id:"btn-dia-close",click:function(){$(this).dialog("close")}}],open:function(){$("#btn-dia-close").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}return!account.loggedIn()}function Zt(){$("#wrapper").unmask()}function Qt(e){$("#wrapper").mask(e||"Loading...")}function Jt(e){var t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"A";t=/^\s*[0-9]{4}[ -]{1}[0-2]{0-1}[0-9]{1-2}\s*$/i;if(t.test(e))return"M";t=/^\s*(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[ -]{1}[0-9]{4}\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}[ -]{1}(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"D";
t=/^\s*W[0-5]{0-1}[0-9]{1} [0-9]{4}\s*$/i;if(t.test(e))return"W";t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e))return"Q";t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e))return"H";return false}function ea(e){var t,a=new Date(e+" UTC");if(a.toString()!="NaN")return a;t=/^W[0-5]{0-1}[0-9]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*6)}return false}function ta(e,t){switch(t){case"A":return e.setUTCFullYear(e.getUTCFullYear()+1);case"Q":return e.setUTCMonth(e.getUTCMonth()+3);case"SA":return e.setUTCMonth(e.getUTCMonth()+6);case"M":return e.setUTCMonth(e.getUTCMonth()+1);case"W":return e.setUTCDate(e.getUTCDate()+6);case"D":return e.setUTCDate(e.getUTCDate()+1);default:return null}}function aa(e,t){var a=$("#"+e+" div.mashabledata_jvmap div").html();var n=u[e].mapconfig.mapBackground||s.mapBackground;a=na(a,n);ia({type:t,filename:"MashableDataMap",width:2e3,svg:a,url:"https://www.mashabledata.com/workbench/export/index.php"})}function na(e,t){e=e.replace(/<div[^<]+<\/div>/gi,"");e=e.replace(/<svg /gi,'<svg xmlns="http://www.w3.org/2000/svg"  version="1.1" ');e=e.replace(/<g><\/g>/gi,"");e=e.replace(/<g/,'<rect x="0" y="0" width="100%" height="100%" fill="'+t+'"></rect><g');e=e.replace(/zIndex="[^"]+"/g,"").replace(/isShadow="[^"]+"/g,"").replace(/symbolName="[^"]+"/g,"").replace(/jQuery[0-9]+="[^"]+"/g,"").replace(/isTracker="[^"]+"/g,"").replace(/url\([^#]+#/g,"url(#").replace(/&nbsp;/g," ").replace(/&shy;/g,"­").replace(/id=([^" >]+)/g,'id="$1"').replace(/class=([^" ]+)/g,'class="$1"').replace(/ transform /g," ").replace(/:(path|rect)/g,"$1").replace(/style="([^"]+)"/g,function(e){return e.toLowerCase()});e=e.replace(/(url\(#highcharts-[0-9]+)&quot;/g,"$1").replace(/&quot;/g,"'");if(e.match(/ xmlns="/g)&&e.match(/ xmlns="/g).length===2){e=e.replace(/xmlns="[^"]+"/,"")}return e}function ia(e){var t=Highcharts.createElement;var a=t("form",{method:"post",action:e.url},{display:"none"},document.body);for(var n in e){t("input",{type:"hidden",name:n,value:e[n]},null,a)}a.submit();Highcharts.discardElement(a)}function sa(e){var t=[],a=u[e];if(a.plots)t.push({name:"chart",grid:oa(e,"chart",a.calculatedMapData)});if(a.mapsets)t.push({name:"regions",grid:oa(e,"regions",a.calculatedMapData)});if(a.pointsets)t.push({name:"markers",grid:oa(e,"markers",a.calculatedMapData)});console.info(t);ia({filename:a.title,data:JSON.stringify(t),url:"excel.php"})}function oa(e,t,a){var n,i,o,r,l,c,d,p,h,f,m,g,b,v,y,k;var x=u[e];var M=x.assets;var C=s.rowPosition;var _,D,T,A=[],U;if(x.plots){var I=x.controls.chart;i=true}else{i=false}if(x.map){n=true;var P=$("#"+e+" .mashabledata_jvmap").vectorMap("get","mapObject")}else{n=false}var N=[["name:"],["units:"],["source:"],["notes:"],["region code:"],["lat, lon:"],["date:"]];switch(t){case"chart":for(c=0;c<x.plots.length;c++){p=x.plots[c];b=I.get("P"+c);var R=p.components.length>1||p.formula().length>1||p.options.units||p.options.name;for(d=0;d<p.components.length;d++){h=p.components[d];N[C.name].push((R?"":"<b>")+h.name()+(R?"":"</b>"));N[C.units].push(h.units);N[C.source].push('<a href="'+h.url+'">'+h.src+"</a>");N[C.notes].push(h.notes);N[C.region].push(h.geoname?h.geoname:"");N[C.lat_lon].push(h.latlon);N[C.date].push(R?p.compSymbol(d):"values");G();g=h.data;for(f=0;f<g.length;f++){y=g[f].split(":");v=S(y[0],h.freq);k=w(v.getTime(),b.options.freq);if((!x.start||x.start<=v)&&(!x.end||x.end>=v)){for(m=C.dataStart;m<N.length;m++){if(N[m][0].dt.getTime()==v.getTime()){break}if(N[m][0].dt.getTime()>v.getTime()){N.splice(m,0,new Array(N[0].length));N[m][0]={dt:v,s:k};break}}if(m==N.length){N.push(new Array(N[0].length));N[m][0]={dt:v,s:k}}if(N[m][0].s.length<k.length)N[m][0].s=k;N[m][N[0].length-1]=y[1]}}}if(R){N[C.name].push("<b>"+b.name+"</b>");N[C.units].push(b.yAxis.axisTitle.text);N[C.source].push("calculated");N[C.notes].push("");N[C.region].push("");N[C.lat_lon].push("");N[C.date].push(p.formula());G();for(f=0;f<b.data.length;f++){k=w(b.data[f].x,b.options.freq);if((!x.start||x.start<=b.data[f].x)&&(!x.end||x.end>=b.data[f].x)){for(m=C.dataStart;m<N.length;m++){if(N[m][0].dt.getTime()==b.data[f].x)break;if(N[m][0].dt.getTime()>b.data[f].x){N.splice(m,0,new Array(N[0].length));N[m][0]={dt:b.data[f].x,s:k};break}}if(m==N.length){N.push(new Array(N[0].length));N[m][0]={dt:b.data[f].x,s:k}}if(N[m][0].s.length<k.length)N[m][0].s=k;N[m][N[0].length-1]=b.data[f].y}}}}break;case"regions":U=a.freq;var F=x.mapsets[0];for(T in a.regionData){for(_ in a.regionData[T]){A.push({regionCode:_,name:P.getRegionName(_)})}A.sort(function(e,t){return e.name>t.name?1:-1});break}console.info(A);var j=F.components.length>1||F.formula().length>1||F.options.units;for(r in A){D=A[r];for(d=0;d<F.components.length;d++){h=F.components[d];if(h.isMapSet()){U=M[h.handle()].freq;var B=M[h.handle()].data[D.regionCode];if(B){N[C.units].push(M[h.handle()].units);N[C.source].push("");N[C.notes].push("");N[C.region].push(D.regionCode)}}else{B=M[h.handle()];U=B.freq;N[C.units].push(B.units);N[C.source].push('<a href="'+B.url+'">'+B.src+"</a>");N[C.notes].push(B.notes);N[C.region].push(B.iso1366?B.iso1366:"")}if(B){G();N[C.name].push((j?"":"<b>")+h.setname);N[C.date].push(j?String.fromCharCode("a".charCodeAt(0)+d):"values");g=B.data.split("|");for(f=0;f<g.length;f++){y=g[f].split(":");v=S(y[0],U);k=w(v.getTime(),U);for(m=C.dataStart;m<N.length;m++){if(N[m][0].dt.getTime()==v.getTime())break;if(N[m][0].dt.getTime()>v.getTime()){N.splice(m,0,new Array(N[0].length));N[m][0]={dt:v,s:k};break}}if(m==N.length){N.push(new Array(N[0].length));N[m][0]={dt:v,s:k}}if(N[m][0].s.length<k.length)N[m][0].s=k;N[m][N[0].length-1]=y[1]}}}if(j){N[C.units].push(F.options.units||M[F.components[0].handle].units);N[C.source].push("calculated");N[C.notes].push("");N[C.region].push(D.regionCode);N[C.lat_lon].push("");N[C.name].push("<b>"+"calculated"+"</b>");N[C.date].push(F.formula()||"y = a");G();for(l=0;l<a.dates.length;l++){if(a.regionData[a.dates[l].s]){v=a.dates[l].dt;k=a.dates[l].s;for(m=C.dataStart;m<N.length;r++){if(N[m][0].dt.getTime()==v.getTime())break;if(N[m][0].dt.getTime()>v.getTime()){N.splice(m,0,new Array(N[0].length));N[m][0]={dt:v,s:k};break}}if(m==N.length){N.push(new Array(N[0].length));N[m][0]={dt:v,s:k}}if(N[m][0].s.length<k.length)N[m][0].s=k;N[m][N[0].length-1]=a.regionData[a.dates[l].s][D.regionCode]}}}}break;case"markers":U=a.freq;var q=[];for(c=0;c<x.pointsets.length;c++){for(d=0;d<x.pointsets[c].components.length;d++){if(vectorPattern.test(x.pointsets[c].components[d].handle))q.push(x.pointsets[c].components[d].handle)}}for(var O=0;O<q.length;O++){B=x.assets[q[O]];N[C.name].push(B.geoid);N[C.units].push(B.units);N[C.source].push(B.source);N[C.notes].push(B.notes);N[C.region].push(B.geoname);N[C.lat_lon].push(B.lat?B.lat+", "+B.lon:"");N[C.date].push(q[O]);z(B.data,B.freq)}var L=[];for(o in a.markers){L.push({marker:o,lon:a.markers[o].latLng[1]})}L.sort(function(e,t){return e.lon-t.lon});for(o=0;o<L.length;o++){markerKey=L[o].marker;handles=markerKey.match(handlePattern);for(l=0;l<handles.length;l++){if(q.indexOf(handles[l])==-1){for(var E in x.assets){if(E[0]=="X"){if(x.assets[E].data[handles[l]]){N[C.name].push(x.assets[E].data[handles[l]].name);N[C.units].push(x.assets[E].units);N[C.source].push("");N[C.notes].push("");N[C.region].push("");N[C.lat_lon].push(x.assets[E].coordinates[handles[l]].latLng?x.assets[E].coordinates[handles[l]].latLng[0]+", "+x.assets[E].coordinates[handles[l]].latLng[1]:"");N[C.date].push("values");z(x.assets[E].data[handles[l]].data,x.assets[E].freq);break}}if(E[0]=="M"){}}}}if(handles.length>1||markerKey!=handles[0]){N[C.name].push(a.markers[markerKey].name);N[C.source].push("");N[C.notes].push("");N[C.region].push("");N[C.lat_lon].push(a.markers[markerKey].latLng[0]+", "+a.markers[markerKey].latLng[1]);N[C.date].push(markerKey);G();for(date in a.markerData){W(date+"|"+a.markerData[date][markerKey],a.freq)}}}break}for(m=C.dataStart;m<N.length;m++){N[m][0]=N[m][0].s}return N;function z(e,t){G();var a,n,i,s,o;var r=e.split("|");for(a=0;a<r.length;a++){W(gdataArray[a],t)}}function G(){var e=N[0].length;for(var t=1;t<N.length;t++){if(N[t].length<e)N[t].push("")}}function W(e,t){var a,n,i;y=e.split(":");a=S(y[0],t);n=w(a.getTime(),t);for(i=C.dataStart;i<N.length;i++){if(N[i][0].dt.getTime()==a.getTime())break;if(N[i][0].dt.getTime()>a.getTime()){N.splice(i,0,new Array(N[0].length));N[i][0]={dt:a,s:n};break}}if(i==N.length){N.push(new Array(N[0].length));N[i][0]={dt:a,s:n}}if(N[i][0].s.length<n.length)N[i][0].s=n;N[i][N[0].length-1]=y[1]}}var ra={innerItem:'<li class="cat-item {{liClass}}" data="{{catid}}">{{name}}{{icon}}</li>',outerItem:'<li class="cat-level" data="{{parentid}}">'+'<div class="cat-div">'+'<ul class="cat-level" data="{{parentid}}">'+"{{listHtml}}"+"</ul></div></li>",folderIcon:'<span class="cat-show-children"><span class="ui-icon ui-icon-folder-collapsed">show children</span></span>',pathIcon:'<span class="cat-open-indicator"><span class="ui-icon ui-icon-play">children shown</span></span>'};function la(e){M({command:"GetCatChain",setid:e||0},function(e){var t="",a;for(var n=0;n<e.chain.length;n++){a=e.chain[n];t+=ca(a,n==e.chain.length-1);if($("#cloud-series:visible").length==1){$("div#browse-api").height($("#cloud-series").height()).width($("#cloud-series").width())}var i=$("div#browse-api").empty().prepend('<div><span style="padding:5px;">Click below to expand sibling and child categories.  Categories containing series are shown as links.  Note that a series can be in more than one category.</span></div>'+'<button id="browse-close" class="right">close</button>'+'<ol id="cat-browser"><div></div></ol>');$("#cat-browser").html(t).click(da);$("#browse-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){ua()});i.fadeIn()}})}function ca(e,t){var a="";for(var n=0;n<e.children.length;n++){var i=e.children[n];if(parseInt(i.scount)>0){i.name+=" ("+i.scount+")";i.liClass="cat-has-sets"}else{i.liClass=""}if(parseInt(i.children)>0){i.icon=ra.folderIcon}else{i.icon=""}if(i["in-path"]){i.liClass+=" in-path";if(t){}else{i.icon=ra.pathIcon}}a+=l.mustache(ra.innerItem,i)}return l.mustache(ra.outerItem,{parentid:e.catid,listHtml:a})}function da(e){var t=$(e.target),a=t.closest("li.cat-item"),n=t.closest("li.cat-level"),i=$("ol#cat-browser"),s=false,o=false;if(t.hasClass("ui-icon-folder-collapsed")||t.hasClass("cat-show-children")){var r=i.find("li.cat-level").index(n),l=i.find("li.cat-level:gt("+r+")");if(l.length==0){o=true}else{l.fadeOut(400,function(){l.remove();if(s){c()}else{o=true}})}M({command:"GetCatChildren",catid:a.attr("data")},function(e){s=e;if(o)c()});function c(){n.find(".in-path").removeClass("in-path").find("span.cat-open-indicator").closest("li").append(ra.folderIcon).find("span.cat-open-indicator").remove();a.find("span").remove();a.addClass("in-path").append(ra.pathIcon);i.append(ca(s,true));s=false}}if(t.hasClass("cat-has-sets")){F=a.attr("data");a.find("span").remove();var d=a.html();for(var p=d.length-1;p>0;p--){if(d[p]=="(")break}B=d.substr(0,p-1);hasher.replaceHash(Yt())}if(a.hasClass("cat-item")){}}function pa(e){F=e;hasher.replaceHash(Yt())}function ua(){$("div#browse-api").fadeOut(function(){$(this).empty()})}account={info:{username:null,userid:null,auth:null,email:null,fbemail:null,fbid:null,admin:null,ccName:null,ccadresss:null,cccity:null,ccstateprov:null,ccpostal:null,cccountry:null,ccType:null,ccLast4:null,ccExpMMYY:null,subscription:null,expire:null,orgid:null,organization:null,accesstoken:null,md:null},htmls:{subscription:'<div id="account-screen">'+"<h2>Account Management</h2>"+'<div class="account-auth">'+'<input type="radio" name="auth" id="authfb" value="fb" /><label for="authfb"><strong>use Facebook to authenticate me.</strong>  You don\'t have to remember another password.  Everybody wins!</label><br />'+'<input type="radio" name="auth" id="authmd" value="md" /><label for="authmd"><strong>create a separate MashableData password.</strong>  Your personal information will be hashed or encrypted.</label>'+"</div>"+"<h3>Basic information:</h3>"+'<span class="over">display name:</span><input class="req uname medium" data="user name" type="text" /><br />'+'<span class="over">main email:</span><input class="req email medium" data="email" type="text" /><br />'+'<div class="account-pwd hidden blue-inset">'+'<span class="over">MashableData password:</span><input class="req medium pwd" data="pwd" type="password" /><br />'+'<span class="over">confirm password:</span><input class="req medium pwdConfirm" data="pwdConfirm" type="password" />'+"</div>"+"<div>"+"<h3>Subscription type:</h3>"+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-trial" value="T" /><strong>free trial</strong> <em>Access to all features for a limited number of requests.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-ind" value="I" /><strong>individual</strong> <em>Unlimited graphs, custom series, searches and downloads for US$10 every 6 months.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-member" value="C" /><strong>join my organization\'s corporate account</strong> </label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-admin" value="A" /><strong>create a corporate account</strong> <em>Members will get unlimited usage plus confidential sharing of data and visualizations amoung members.  All billing and membership will be managed through this account, so only a single credit card is required.  Select this option to create and administer a new corporate account.</em></label><br />'+'<div class="validation blue-inset hidden">'+'Email validation code (required): <input class="req valcode" data="valcode" type="text" /><br />'+"<em>You email validation code is in an email sent moments ago from admin@mashabledata.com.</em>"+"</div>"+'<div class="regcode blue-inset hidden">'+'Registration code (required): <input class="req regcode" data="regcode" type="text" /><br />'+"<em>Your code is included in your invitation email sent by your organization's administrator.</em>"+"</div>"+'<div class="joinmode blue-inset hidden">'+'Company / organization name: <input data="orgName" id="account-org-name" class="long" /><br />'+"How will users join your organization?<br />"+'<label><input type="radio" name="account-join" id="account-inviteonly" value="inviteonly" /><strong>by invitation only</strong></label><br />'+'<label><input type="radio" name="account-join" id="account-emailorinvite" value="emailorinvite" /><strong>by invitation OR anyone able to receive email through an @<span class="italics account-main-email-domain"></span> account</strong></label>'+"<br /><br />"+"<em>You will be able to add email addresses of new members via the administration panel after your credit card is accepted. MashableData will then email an invitation with a unique registration code and instructions to each new member.</em><br />"+"</div>"+"</div>"+'<h3 class="payments hidden">Payment method:</h3>'+'<div class="payments hidden">'+'<span class="llabel">credit card number:</span><input class="cardNum" data="ccnum" type="text" />'+'<span class="mlabel">CCV:</span><input class="cardCCV tiny" data="ccv" data="optional" type="text" />'+'<span class="right"><span class="mlabel">Expiration:</span>'+'<select class="cardMonth"><option val="1">Jan</option><option val="2">Feb</option><option val="3">Mar</option><option val="4">Apr</option><option val="5">May</option><option val="6">Jun</option><option val="7">Jul</option><option val="8">Aug</option><option val="9">Sep</option><option val="10">Oct</option><option val="11">Nov</option><option val="12">Dec</option></select>'+'<select class="cardYear"></select></span>'+'<br /><span class="llabel">name on card:</span><input type="text" data="ccname" class="cardName medium" /><br />'+'<span class="llabel">address:</span><input type="text" data="ccaddress" class="cardAddress long" /><br />'+'<span class="llabel">city:</span><input type="text" data="cccity" class="cardCity medium" /><span class="cardStateProv mlabel">state:</span><input type="text" data="ccstateprov" class="cardStateProv short" /><span class="cardPostal mlabel">ZIP code:</span><input type="text" class="cardPostal tiny" data="ccpostal"  /><span class="mlabel">country:</span><select class="cardCountry"></select>'+"</div>"+'<button class="ok">ok</button> <button class="cancel">cancel</button>'+"</div>",signIn:'<div id="signin-md">Email:<br><input id="signin-email"><br>Password:<br><input id="signin-pwd"><br><button id="signin-signin">Sign in</button> <input id="signin-stay" type="checkbox" /> stay signed in<br><br>New to MashableData? Create an <a id="create-account" href="javascript:void(0)">account</a></div> '+'<div id="signin-or">~ OR ~</div>'+'<div id="signin-fb"> <fb:login-button></fb:login-button><br /><br />Use your FaceBook account to log in.<br /><br />(No spam or posting without your consent.  We promise and Facebook enforces our promise.)</div>'+'<div style="text-align: center;"><a id="license-link" href="license.html">MashableData Workbench Term of Service</a></div>',signedIn:'<div id="signedin-md"><button id="signedin-signout">Sign out</button><br><br><a id="signedin-subscribe" href="javascript:void(0);">Account &amp; Subscription</a><span id="signedin-admin" style="display:none;"><br><br><a href="admin_users.php" target="_blank">User Management & Billing</a> (Administrator only)</span></div>',verify:'<div id="verify-email">The following email needs verification.  Please enter the verification code emailed to the following email account:  <span class="email"></span><br />'+'<br /><input class="email" type="test" /> <br /><button class="verify">Verify</button> <button class="cancel">Cancel</button> <button class="cancel">Send New Verifcation Code</button></div>'},showPanel:function(e,t){$.fancybox(e,{showCloseButton:false,autoScale:true,overlayOpacity:t?0:.5,hideOnOverlayClick:t?true:false});var a=$("#fancybox-wrap");if(t){var n=t.offset();a.css({top:parseInt(n.top+t.height()-15)+"px",left:parseInt(n.left-a.width()-18+t.width())+"px"})}return a},showSignInOut:function(){var e=$("#menu-account");if(this.loggedIn()){account.showPanel(account.htmls.signedIn,e);if(account.info.subscription==="A")$("#signedin-admin").show();$("#signedin-signout").button().addClass("ui-state-error").click(function(){account.signOut()})}else{account.showPanel(account.htmls.signIn,e);$("#license-link").fancybox();FB.XFBML.parse(document.getElementById("signin-fb"))}$("#create-account,#signedin-subscribe").click(function(){account.showSubscribe()})},showSubscribe:function(){var e=account.showPanel(account.htmls.subscription);var t=$("#account-screen"),a="",n="";var i=false;var s=false;var o;account.subscribing=true;t.find("[data]").each(function(){o=$(this).attr("data");$(this).val(account.info[o])});t.find("input.account-level[value='"+(account.info.subscription||"T")+"']").click();if(account.info.subscription=="C"||account.info.subscription=="A"){t.find("input.account-level").attr("disabled",true);t.find("div.validation").html("You are a member of the corporate account of "+account.info.orgName+".<br><br>This account can only be changed or cancelled in the "+(account.info.subscription=="A"?'<a href="admin_users.php" target="_blank">':"")+"account administrator's panel"+(account.info.subscription=="A"?"</>":"")+".").show()}t.find("input.email").val(account.info.email).change(function(){if(account.isValidEmail(this.value)){$(".account-main-email-domain").html(this.value.split("@")[1].trim());M({command:"CheckEmailForOrgInv",email:this.value.trim(),modal:"none"},function(e,t,a){s=e.invited;i=e.eligible;if(e.invited){vt("Corporate membership found","Our records show that a registration code to join the corporate account of "+e.orgname+" was originally sent to "+this.value+" on "+e.date+". The registration email was just resent.  Please copy the registration code from either email into the form to complete your registration.");$("#account-lvl-member").click()}if(e.eligible){vt("Corporate membership found",'Based on your email, you are eligible to join the corporate account of "'+e.orgname+'".  However, you must first validate your email address.  A registration code was just sent to '+this.value+". Please copy the validation code from the email into the registration form to complete your registration.");$("#account-lvl-member").click()}});if(!account.loggedIn()||this.value!=account.info.email){account.sendVerificationCode(this.value.trim())}}else{$(".account-main-email-domain").html("*no domain detected*")}}).change();t.find("input.uname").val(account.info.name);t.find("span.account-main-email").html(account.info.email);t.find("button.cancel").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){account.subscribing=false;$.fancybox.close()});if(this.loggedIn()){t.find("#"+(account.info.authmode=="Facebook"?"authfb":"authmd")).attr("checked",true);t.find(".email").attr("disabled",true);t.find("input:radio[name='auth']").attr("disabled",true)}M({command:"CardSelects",modal:"none"},function(e,a,n){var i,s=t.find("select.cardYear"),o=t.find("select.cardCountry");for(i=0;i<e.countries.length;i++){o.append("<option>"+e.countries[i].name+"</option>")}o.val(account.info.ccountry||"United States");for(i=0;i<e.years.length;i++){s.append("<option>"+e.years[i]+"</option>")}if(account.info.ccexpiration){var r=account.info.ccexpiration.split("/");if(r.length==2){s.val(r[1]);t.find(".cardMonth").val(r[0])}}});t.find("input:radio[name=auth]").click(function(){if(this.id=="authmd"){t.find(".email").removeAttr("disabled");t.find("div.account-pwd").slideDown();r()}else{t.find("div.account-pwd").slideUp();if(account.loggedIn()&&account.info.authmode=="Facebook"){t.find(".email").attr("disabled",true)}else{account.loginout()}}});t.find("input:radio[name=account-level]").click(function(){if(this.id=="account-lvl-admin"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp();if(this.id=="account-lvl-admin"||this.id=="account-lvl-ind"){t.find(".payments").slideDown();r()}else t.find(".payments").slideUp();if(this.id=="account-lvl-member"){if(i){t.find("div.valcode").slideDown()}else{t.find("div.regcode").slideDown()}if(!s&&!i){vt("No corporate account available","Our records do not show a corporate membership available to the email entered above.  Please contact the administrator of your organization's MashableData account to be added.")}r()}else{t.find("div.regcode,div.valcode").slideUp()}});t.find("input:radio[name=account-auth]").click(function(){if(this.id=="account-org-create"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp()});t.find("button.ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e="";if(t.find("input.uname").val().trim().length<5)e+="<li>Your display name must be least 5 characters</li>";if(!account.isValidEmail(t.find("input.email").val().trim()))e+="<li>Your main email is not a valid email address</li>";if(!t.find("input[name=auth]:checked"))e+="<li>Please indicate how you wish to be authenticated</li>";if(t.find("input[name=auth]:checked").val()=="md"&&(t.find(".pwd").val().trim().length<8||t.find(".pwd").val().trim()!=t.find(".pwdConfirm").val().trim())){e+="<li>Your passwords must match and be at 8 characters long</li>";t.find(".pwd").val("");t.find(".pwdConfirm").val("")}var a=t.find("input[name=account-level]:checked").val();if(!a)e+="<li>You must select a subscription level</li>";if(a=="admin"&&!t.find("input[name=account-join]:checked").val())e+="<li>You must indicate how users will be allowed to join your organization.</li>";if(a=="admin"||a=="indiv"){}if(e.length>0){vt("Invalid responses","The following problems were detected:<br><ol>"+e+"</ol>Please correct these issues and resubmit.")}else{var n={command:"Subscribe",name:t.find("input.uname").val().trim(),email:t.find("input.email").val().trim(),auth:t.find("input[name=auth]:checked").val(),pwd:t.find("input.pwd").val().trim(),fbemail:t.find("input[name=account-fb]:checked").val()=="fbdiff"?t.find("input#account-fbemail").val().trim():t.find("input.email").val().trim(),twitemail:t.find("input[name=account-twit]:checked").val()=="twitdiff"?t.find("input#account-twitemail").val().trim():t.find("input.email").val().trim(),accountLevel:a,regCode:t.find("input.regcode").val(),accountJoinMode:t.find("input[name=account-join]:checked").val(),cardNum:t.find("input.cardNum").val(),cardMonth:t.find("input.cardMonth").val(),cardYear:t.find("input.cardYear").val(),cardCCV:t.find("input.cardCCV").val(),cardName:t.find("input.cardName").val(),cardAddress:t.find("input.cardAddress").val(),cardCity:t.find("input.cardCity").val(),cardStateProv:t.find("input.cardStateProv").val(),cardPostal:t.find("input.cardPostal").val(),cardCountry:t.find("input.cardCountry").val()};M(n,function(e,t,a){if(e.status=="OK"){$.fancybox().close();account.info.name=n.name;account.info.email=n.email;account.info.fbemail=n.fbemail}vt("Account and subscription managment",oRetrun.msg)})}});function r(){e.animate({top:50})}},isValidEmail:function(e){return e.split("@").length==2&&e.split("@")[1].split(".").length>0&&!/[\s]/.test(e)},showVerify:function(e){account.showPanel(account.htmls.verify);var t=$("#verify-email");t.find("span.email").html(e);t.find(".cancel").button({icons:{secondary:"ui-icon-closethick"}}).addClass("ui-state-error").click(function(){account.showSubscribe()});t.find(".cancel").button({icons:{secondary:"ui-icon-check"}}).click(function(){account.verified(e,t.find("input.email").val())})},signIn:function(e,t,a){},signInFB:function(e){if(e.authResponse){if(this.signingIn)return;this.signingIn=true;account.info.authmode="Facebook";var t=e.authResponse.accessToken;expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){account.info.fbid=e.id;account.fb_user=e;account.fb_user.accessToken=t;account.info.accesstoken=t;account.info.name=e.name;account.info.email=e.email;if(e.email){Ft();this.signingIn=false}else{FB.login();vt("Email required","You must authorize Facebook to share your email with MashableData.  Mashdata requires a single validated email address and will remain confidential");this.signingIn=false}});$.fancybox.close()}},subscribe:function(e,t){},signOut:function(){FB.logout(function(e){localStorage.removeItem("token");localStorage.removeItem("mdtoken");window.onbeforeunload=false;window.location.reload()})},loginout:function(){if(account.loggedIn()){account.signOut()}else{FB.login(function(e){if(e.authResponse){loggedIn="facebook";accessToken=e.authResponse.accessToken;localStorage.setItem("fbtoken",accessToken);expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){fb_user=e;Ft()})}})}},loggedIn:function(){return this.info.userId!=null},sendVerificationCode:function(e){M({command:"EmailVerify",email:e,verification:"x"},function(t,a,n){vt("email verification code","A verification code was sent to "+e+".  Please check this email account and enter the code where directed. ")})}};e.Annotator=function Ta(t,n){var i=e,s=i.globals,o=i.common,l=i.grapher;var c=s.BAND_TRANSPARENCY;var d=s.panelGraphs;var p=o.equivalentRGBA;var u=s.period;var h={panelId:t,bandNo:0,lineNo:0,banding:false,bandStartPoint:void 0,makeDirty:n,callApi:i.common.callApi,addStandard:function f(e){var a=this;a.callApi({command:"GetAnnotation",annoid:e},function(e){standardAnno=jQuery.parseJSON(e.annotation);for(var n=0;n<standardAnno.length;n++){d[t].annotations.push(standardAnno[n])}a.build("new")})},fetchStandards:function(){if(s.standardAnnotations.length==0){var e=this;this.callApi({command:"GetAnnotations"},function(e){for(var t=0;t<e.annotations.length;t++)s.standardAnnotations.push(e.annotations[t])})}},sync:function m(){var e=d[this.panelId].controls.chart;var t=e.options.xAxis,a=t.plotLines=[],n=t.plotBands=[];var i;for(var s=0;s<e.xAxis[0].plotLinesAndBands.length;s++){i=e.xAxis[0].plotLinesAndBands[s];if(i.id.substr(0,1)=="xb"){n.push(i.options)}else{a.push(i.options)}}},addPoint:function y(e){var a=d[t];if(typeof e!="undefined"){var n;for(var i=0;i<a.annotations.length;i++){if(a.annotations[i].type=="point"){n=a.controls.chart.get(a.annotations[i].id);if(n){n.update([n.x,n.y],false)}delete a.annotations[i].id}}a.annotations.push({type:"point",text:"",id:null,series:e.series.options.id,color:"#000000",from:w(e.x,e.series.options.freq)});this.build("point")}},addXLine:function k(e){var a=d[t];a.controls.chart.xAxis[0].addPlotLine({value:e.x,color:"#"+v[0],id:"xl"+this.lineNo,width:2,label:{text:" ",y:0,zIndex:3}});a.annotations.push({type:"line",text:"",id:"xl"+this.lineNo,color:v[0],from:w(e.x,e.series.options.freq)});this.lineNo++;this.build("table-only")},startXBand:function x(e){var a=d[t];this.bandStartPoint=e;this.bandColor=p(v[0],c);a.controls.chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.bandStartPoint.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});this.banding="x-Time";e.select(true)},build:function S(e){var a,n,i=this,o=d[t],r=o.controls.$thisPanel,l=r.find("div.annotations").show().find("table");if(!s.isEmbedded&&l&&l.get(0).rows.length!=0){r.find(".graph-save").button("enable");o.isDirty=true}if(!e)e="all";var u="";var h="A";var f,m,g,b,v,y,w;var k={};for(f=0;f<o.controls.chart.yAxis.length;f++){k["labelsY-"+f]=[]}o.annotations.sort(function(e,t){if(e.type.charAt(0)=="h"&&e.type.charAt(0)=="h")return t.from-e.from;if(e.type.charAt(0)=="h")return-1;if(t.type.charAt(0)=="h")return 1;return i.parseDate(e.from)-i.parseDate(t.from)});for(f=0;f<o.annotations.length;f++){console.time("annotation loop");m=o.annotations[f];switch(m.type){case"point":if(e=="point"||e=="all"){b=o.controls.chart.get(m.series);if(b==null){o.annotations.splice(f,1);f--;break}v=o.controls.chart.get("labelsY-"+b.options.yAxis);for(var x=0;x<b.data.length;x++){if(b.data[x]){if(b.data[x].x==this.parseDate(m.from)){g=b.data[x];k["labelsY-"+b.options.yAxis].push({x:g.x,y:g.y,id:h,text:m.text,marker:{fillColor:m.color,lineColor:m.color,radius:8,symbol:"circle",enabled:true,states:{hover:{enabled:true,marker:{enabled:true,fillColor:m.color,lineColor:m.color,radius:8}}}}})}}}m.id=h}u+='<tr data="'+h+'"><td align="center"><b>'+h+"</b></td><td>"+m.from+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';h=String.fromCharCode(h.charCodeAt(0)+1);break;case"line":y=this.parseDate(m.from);if(y>=parseInt(o.start||o.firstdt)&&y<=parseInt(o.end||o.lastdt)){if(e=="line"||e=="all"||e=="new"&&!m.id){m.id="xl"+this.lineNo;this.lineNo++;n=this.labelOffset(o.controls.chart,m);o.controls.chart.xAxis[0].addPlotLine({color:m.color,value:this.parseDate(m.from),id:m.id,width:2,label:{text:m.text,y:n,zIndex:3}})}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hline":if(e=="hline"||e=="all"||e=="new"&&!m.id){m.id="hl"+this.lineNo;this.lineNo++;for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text==m.yAxis){o.controls.chart.yAxis[a].addPlotLine({color:m.color,value:m.from,id:m.id,width:2,label:{text:m.text,zIndex:3}})}}}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+" "+m.yAxis+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';
break;case"band":y=this.parseDate(m.from);w=this.parseDate(m.to);if(y>=parseInt(o.start||o.firstdt)&&y<=parseInt(o.end||o.lastdt)||w>=parseInt(o.start||o.firstdt)&&w<=parseInt(o.to||o.lastdt)){if(e=="band"||e=="all"||e=="new"&&!m.id){m.id="xb"+this.bandNo++;n=this.labelOffset(o.controls.chart,m);o.controls.chart.xAxis[0].addPlotBand({color:p(m.color,c),from:y,to:w,id:m.id,label:{text:m.text,y:n,zIndex:3}})}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+"-"+m.to+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hband":if(e=="hband"||e=="all"||e=="new"&&!m.id){m.id="hb"+this.bandNo++;for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text==m.yAxis){o.controls.chart.yAxis[a].addPlotBand({color:p(m.color,c),from:m.from,to:m.to,id:m.id,label:{text:m.text,zIndex:3}})}}}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+"-"+m.to+" "+m.yAxis+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break}console.timeEnd("annotation loop")}console.time("annotation redraw");if(e=="point"||e=="all"){for(var S in k){o.controls.chart.get(S).setData(k[S],false)}console.info("annotations fired chart redraw");o.controls.chart.redraw()}console.timeEnd("annotation redraw");if(!s.isEmbedded){console.time("annotation rest");if(o.annotations.length==0)u+='<tr><td colspan="3" class="grey-italics">right-click on the chart to annotate a point, band, or event, or to perform a linear regression or average</td></tr>';l.html(u).find("input, select").change(function(){i.change(this)});l.find(".annotation-color-picker").colorPicker();l.find(".ui-icon-trash").click(function(){i["delete"](this)});console.timeEnd("annotation rest")}},change:function M(e){var a,n,i,s=$(e).closest("tr").attr("data");d[t].controls.$thisPanel.find(".graph-save").button("enable");var o=d[t];var r;for(a=0;a<o.annotations.length;a++){if(s==o.annotations[a].id){r=o.annotations[a];break}}r.text=$(e).closest("tr").find("input.anno-text").val();r.color=$(e).closest("tr").find(".annotation-color-picker").val();switch(s.substr(0,2)){case"xb":n=this.labelOffset(o.controls.chart,r);o.controls.chart.xAxis[0].removePlotBand(s);o.controls.chart.xAxis[0].addPlotBand({color:p(r.color,c),from:this.parseDate(r.from),to:this.parseDate(r.to),id:r.id,label:{text:r.text,y:n,zIndex:3}});break;case"hb":for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text=r.yAxis){o.controls.chart.yAxis[a].removePlotBand(s);o.controls.chart.yAxis[a].addPlotBand({color:p(r.color,c),from:parseFloat(r.from),to:parseFloat(r.to),id:r.id,label:{text:r.text,zIndex:3}})}}break;case"hl":for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text=r.yAxis){o.controls.chart.yAxis[a].removePlotLine(s);o.controls.chart.yAxis[a].addPlotLine({color:r.color,value:parseFloat(r.from),id:r.id,width:2,label:{text:r.text,zIndex:3}})}}break;case"xl":n=this.labelOffset(o.controls.chart,r);o.controls.chart.xAxis[0].removePlotLine(s);o.controls.chart.xAxis[0].addPlotLine({color:r.color,value:this.parseDate(r.from),id:r.id,width:2,label:{text:r.text,y:n,zIndex:3}})}},"delete":function C(e){var n=$(e).closest("tr").attr("data");var i=d[t];for(var s=0;s<i.annotations.length;s++){if(n==i.annotations[s].id){i.annotations.splice(s,1);break}}if(n[1]=="b"||n[1]=="l"){for(a=0;a<i.controls.chart.axes.length;a++){i.controls.chart.axes[a].removePlotLine(n);i.controls.chart.axes[a].removePlotBand(n)}this.build("none")}else{this.build("point")}},startAnalysisBanding:function(e,a){var n=e.series.color;var i=d[t].controls.chart;r=parseInt(n.substr(1,2),16);g=parseInt(n.substr(3,2),16);b=parseInt(n.substr(5,2),16);this.bandColor="rgba("+r+","+g+","+b+",0.5)";this.banding=a+"-"+e.series.index;this.bandStartPoint=e;i.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:e.x,color:this.bandColor,id:a+this.bandNo++,label:{text:" ",y:0,zIndex:3}})},deleteAnalysis:function(e){var a,n,i,s,o=e.series.options.calculatedFrom;var r=e.series.options.id.substr(0,2);if(o){a=e.series.data[0][0];n=e.series.data[e.series.data.length-1][0];e.series.remove();switch(r){case"LR":s=d[t].plots[parseInt(o.substr(1))].options.linRegressions;break;case"AV":s=d[t].plots[parseInt(o.substr(1))].options.averages;break}this.makeDirty();for(i=0;i<s.length;i++){if(s[i][0]==n&&s[i][1]==a){s.splice(i,1);return true}}return false}},parseDate:function _(e){if(e.length==4){e="1 Jan "+e+" UTC"}else if(e.length==8){e="1 "+e+" UTC"}else{e+=" UTC"}return Date.parse(e)},labelOffset:function D(e,t){var a=10;var n=20;var i=.2;if(t.text==" "||t.text==" ")return 0;var s=e.xAxis[0].plotLinesAndBands;var o=e.xAxis[0].getExtremes();var r=(o.max-o.min)*i;var l;var c=[];if(t.to){l=(this.parseDate(t.from)+this.parseDate(t.to))/2}else{l=this.parseDate(t.from)}var d=0,p;for(var u=0;u<s.length;u++){if(s[u].id!="timeLine"){if(s[u].options.to){p=(s[u].options.from+s[u].options.to)/2}else{p=s[u].options.from}if(s[u].options.label.text.length>0&&Math.abs(p-l)<r){d++;c.push(s[u])}}}var h=a;for(var f=0;f<c.length;f++){if(c[f].options.label.y==h){h+=n;f=-1}}return h},mouseOverHCPoint:function T(e,a){var n=d[t].controls.chart;if(!this.banding)return;if(this.banding=="x-Time"){try{n.xAxis[0].removePlotBand("xb"+this.bandNo)}catch(i){}n.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:a.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});return}if(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-"){var s=this.banding.substr(0,2);try{n.xAxis[0].removePlotBand(s+this.bandNo)}catch(i){}this.endingX=closestDate(a.x,this.bandStartPoint.series.data);n.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.endingX,color:this.bandColor,id:s+this.bandNo,label:{text:" ",y:0,zIndex:3}})}},endBanding:function A(e){var a,n,i;var s=this.mouseoverPoint;var o=typeof this.mouseoverPoint!="undefined";var r=d[t];var l=this;if(this.banding=="x-Time"){if(o){var u,h;u=w(this.bandStartPoint.x,this.bandStartPoint.series.options.freq);h=w(s.x,s.series.options.freq);this.banding=false;r.annotations.push({type:"band",text:"",id:"xb"+this.bandNo,color:"#"+v[0],from:u<h?u:h,to:u<h?h:u});this.build("table-only");return false}else{return{items:{info:{name:"Mouse-over a series before right-clicking to terminate a vertical band.",callback:function(e,t){}}}}}}if(this.banding&&(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-")){var f=this.banding.substr(0,2);r.controls.chart.xAxis[0].removePlotBand(f+this.bandNo);var m=Math.min(this.bandStartPoint.x,this.endingX);var g=Math.max(this.bandStartPoint.x,this.endingX);if(m<g){switch(f){case"LR":this.plotLinearRegression(this.bandStartPoint.series,m,g,true);var b=r.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!b.linRegressions)b.linRegressions=[];b.linRegressions.push([m,g]);break;case"AV":this.plotAverage(this.bandStartPoint.series,m,g,true);var b=r.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!b.averages)b.averages=[];b.averages.push([m,g]);break}l.makeDirty()}else{vt("Error","The starting point and ending points must be different.")}this.banding=false;return}else{var y,k,x,S,M,C=r.controls.chart;for(M=0;M<C.yAxis.length;M++){a=C.yAxis[M].userOptions.title.text;if(this.banding=="y-"+a){y=$(C.container).offset().top;k=$(C.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-k)-C.plotLeft;S=(isIE?e.originalEvent.y:e.pageY-y)-C.plotTop;if(S>=0&&S<=C.plotSizeY){n=parseFloat(parseFloat(C.yAxis[M].translate(C.plotHeight-S,true).toPrecision(2)));return{items:{axis:{name:"<b>"+a+":</b>",type:"text",value:n},ok:{name:"<button>ok</button>",callback:function(e,t){i=$.contextMenu.getInputValues(t)["axis"];for(var n=0;n<C.yAxis.length;n++){if(C.yAxis[n].userOptions.title.text=l.banding.substr(2)){C.yAxis[n].removePlotBand("hb"+l.bandNo);var s,o;s=parseFloat(l.bandStartPoint);o=parseFloat(i);C.yAxis[n].removePlotBand("hb"+l.bandNo);C.yAxis[n].addPlotBand({id:"hb"+l.bandNo,color:p(v[0],c),from:Math.min(s,o),to:Math.max(s,o),label:{text:"",zIndex:3}});r.annotations.push({id:"hb"+l.bandNo,type:"hband",yAxis:a,text:"",color:"#"+v[0],from:Math.min(l.bandStartPoint,i),to:Math.max(l.bandStartPoint,i)});l.build("table-only");l.banding=false;l.makeDirty();break}}}},cancel:{name:"<button>cancel</button>",callback:function(e,t){for(M=0;M<C.yAxis.length;M++){C.yAxis[M].removePlotBand("hb"+l.bandNo);l.banding=false}}}}}}else{return false}}}}},plotAnnotationSeries:function(){var e,a,n,i;var s=d[t];var o=s.controls.chart;var r=s.start||(s.intervals?l.intervalStartDt(s):s.firstdt);if(s.plots&&s.plots.length>0){for(e=0;e<s.plots.length;e++){if(s.plots[e].options.linRegressions){for(a=0;a<s.plots[e].options.linRegressions.length;a++){n=s.plots[e].options.linRegressions[a];if(n[0]>=r&&n[0]<=parseInt(s.end||s.lastdt)&&(n[1]>=r&&n[1]<=parseInt(s.to||s.lastdt))){this.plotLinearRegression(o.get("P"+e),n[0],n[1])}}}if(s.plots[e].options.averages){for(a=0;a<s.plots[e].options.averages.length;a++){i=s.plots[e].options.averages[a];if(i[0]>=r&&i[0]<=parseInt(s.end||s.lastdt)&&(i[1]>=r&&i[1]<=parseInt(s.to||s.lastdt))){this.plotAverage(o.get("P"+e),i[0],i[1])}}}}}o.redraw()},plotLinearRegression:function(e,a,n,i){if(!i)i=false;var s=d[t].controls.chart;var r=0,l=null,c=null;var p=0,h=null,f=null;var m,g=[],b=0;if(typeof a=="undefined"||typeof n=="undefined"){g=e.data}else{for(m=0;m<e.data.length;m++){if(e.data[m].x>=a&&e.data[m].x<=n){g.push(e.data[m])}}}for(m=0;m<g.length;m++){if(g[m].x!=null&&g[m].y!=null){r+=g[m].x;p+=g[m].y;if(l==null){l=g[m].x}if(c==null){c=g[m].x}if(h==null){h=g[m].y}if(f==null){f=g[m].y}if(l>g[m].x){l=g[m].x}if(c<g[m].x){c=g[m].x}if(h>g[m].y){h=g[m].y}if(f<g[m].y){f=g[m].y}b++}}var v=r/b;var y=p/b;var w=0;var k=0;for(m=0;m<g.length;m++){if(g[m].x!=null&&g[m].y!=null){w+=(g[m].x-v)*(g[m].y-y);k+=(g[m].x-v)*(g[m].x-v)}}var x=w/k;var S=y-x*v;var M=x*u.value[e.options.freq];var C=M.toString().search(/[1-9]/);var _=M.toString().indexOf(".");var D={name:"Linear regression of "+e.name+"<BR> (m="+o.numberFormat(M,_>5||_==-1?0:C+5-_)+" per "+u.units[e.options.freq]+")",dashStyle:"LongDash",freq:e.options.freq,lineWidth:1,color:e.color,data:[],id:"LR"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(m=0;m<g.length;m++){if(g[m].x!=null&&g[m].y!=null){D.data.push([g[m].x,x*g[m].x+S])}}return s.addSeries(D,i)},plotAverage:function(e,a,n,i){if(!i)i=false;var s=d[t].controls.chart;var o=0,r=0;var l,c=[],p=0;if(typeof a=="undefined"||typeof n=="undefined"){c=e.data}else{for(l=0;l<e.data.length;l++){if(e.data[l].x>=a&&e.data[l].x<=n){c.push(e.data[l]);if(e.data[l].y!==null){o+=e.data[l].y;r++}}}}var u=o/r;var h={name:"Average of "+e.name,dashStyle:"ShortDash",freq:e.options.freq,lineWidth:1,color:e.color,data:[],id:"AV"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(l=0;l<c.length;l++){h.data.push([c[l].x,u])}return s.addSeries(h,i)}};if(!s.isEmbedded)h.fetchStandards();return h};function ha(t){var a,n=e,i=n.globals,s=n.grapher,o=n.common,r=o.mustache,l=i.dashStyles,c=i.DEFAULT_RADIUS_FIXED,u=i.DEFAULT_RADIUS_SCALE,h=i.hcColors,f=i.period,m=i.op,g=i.MAP_COLORS,b=i.patVariable,v=s.fillScalingCount;var y,w,k,x,S,C,_,D,T,A=1,U={compMathDiv:'<div class="edit-block">'+'<div class="edit-math">'+'<input type="radio" id="required-'+t+'" name="comp-math-'+t+'" data="compMath"  value="required"/><label for="required-'+t+'">all values required else null</label>'+'<input type="radio" id="missingAsZero-'+t+'" name="comp-math-'+t+'" data="compMath"  value="missingAsZero"/><label for="missingAsZero-'+t+'">use zero for missing values</label>'+'<input type="radio" id="nullsMissingAsZero-'+t+'" name="comp-math-'+t+'" data="compMath" value="nullsMissingAsZero"/><label for="nullsMissingAsZero-'+t+'">use zero for missing and null values</label>'+"</div>"+"</div>"},I={continuousColorScale:'<div class="continuous-strip-neg">{{negStrip}}</div>0<div class="continuous-strip-pos">{{posStrip}}</div>',continuousColorStrip:'<span class="map_legend_gradient" style="-ms-filter: progid:DXImageTransform.Microsoft.gradient(startColorstr={{a}}, endColorstr={{b}}, gradientType=1);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr={{a}}, endColorstr={{b}}, gradientType=1)background-image: -webkit-gradient(linear, left bottom, right bottom, from({{a}}), to({{b}}));background-image: -webkit-linear-gradient(left, {{a}}, {{b}});background-image: -moz-linear-gradient(left, {{a}}, {{b}});background-image:  -o-linear-gradient(left, {{a}}, {{b}};background-image: linear-gradient(to left, {{a}},{{b}});"></span>',discreteLegendShell:'<div class="edit-block"><div class="edit-block discrete-legend"></div>'+'<button class="inc-discrete">+</button>'+'<button class="dec-discrete">-</button>'+'<button class="reset-discrete">calculate colors</button>'+"</div>",legendEditor:'<div class="edit-block">'+'<div class="map-mode edit-block">'+"{{mapModeSelector}}"+'</div><span class="merge-formula ital">merge formula = &#931; numerator / &#931; denominator</span>'+'<div class="radius"  style="display: none;">'+'<span class="edit-label radius-label">maximum {{markerType}} radius (pixels): </span><input class="radius-spinner" value="{{maxRadius}}" />'+"</div>"+'<div class="edit-block color-scale" style="display: none;">'+'<div class="legend-scale"><span class="edit-label">Color scale:</span>'+'<input type="radio" id="legend-continuous-'+t+'-{{id}}" name="legend-type-'+t+'-{{id}}" data="scale" value="continuous" /><label for="legend-continuous-'+t+'-{{id}}">continous</label>'+'<input type="radio" id="legend-discrete-'+t+'-{{id}}" name="legend-type-'+t+'-{{id}}" data="scale" value="discrete"/><label for="legend-discrete-'+t+'-{{id}}">discrete</label>'+"</div>"+'<div class="lin-log-scaling"><span class="edit-label">Color mode:</span>'+'<input type="radio" id="lin-scaling-'+t+'-{{id}}" name="color-mode-'+t+'-{{id}}" data="logMode" value="off" /><label for="lin-scaling-'+t+'-{{id}}">linear</label>'+'<input type="radio" id="log-scaling-'+t+'-{{id}}" name="color-mode-'+t+'-{{id}}" data="logMode" value="on"/><label for="log-scaling-'+t+'-{{id}}">enhanced color</label>'+"</div>"+'<div class="edit-block legend-continuous" style="display: none;">'+'-<div class="continuous-color"><input class="neg color-picker" type="text" data="negColor" value="{{negColor}}" /></div>{{continuousColorScale}}<div class="continuous-color"><input class="pos color-picker" type="text" data="posColor" value="{{posColor}}" /></div>+'+"</div>"+'<div class="edit-block legend-discrete" style="display: none;"></div>'+"</div>",mergeFormula:'<span class="merge-formula">merge formula = &#931; numerator / &#931; denominator</span>',seriesPlots:'<div class="chart-plots"><H4>Chart</H4><ol class="plots">'+"{{seriesPlots}}"+"</ol>",seriesPlot:'<li class="plot">'+'<button class="edit-plot">configure</button>'+'<div class="line-sample" style="background-color:{{plotColor}};height:{{lineHeight}}px;" data="{{plotColor}}"><img src="images/{{lineStyle}}.png" height="{{lineHeight}}px" width="{{lineWidth}}px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">{{name}}</span> ({{plotPeriodicity}}) in <span class="plot-units">{{units}}</span></div>'+'<span class="plot-formula">= {{formula}}</span><br>'+"{{components}}"+"</li>",landing:'<ol class="components landing" style="list-style-type: none;"><li class="not-sortable">Drag plot to reorder them.  Drag multiple data series into a single plot to create sums and ratios. Drag a data series here to create a new plot line.</i></li></ol></div>',mapProv:'<div class="map-prov"><h3>Map of {{map}}</h3>'+'<div class="map-background right">Map background color: <input class="map-background" type="text" data="color" value="{{mapBackground}}" /></div>'+"{{mapPlots}}{{pointPlots}}"+"</div>",pointPlots:'<div class="pointsets"><h4>'+p.pointset+" mapped set of markers (defined latitude and longitude)</h4>"+'<div class="map-mode-conflict ui-state-error">Point markers will not be shown on maps with region displayed as: bubble, change bubble, treemap, period of minimum, or period of maximum.</div>'+'<div class="pointsets-colors" style="margin-bottom:5px;"></div>'+'<ol class="pointsets">{{pointPlotsHTML}}</ol></div>',pointPlot:'<li class="pointplot">'+'<button class="edit-pointPlot right">configure</button>'+'<div class="plot-info" style="display:inline-block;">'+'<div class="marker" style="background-color: {{color}}"></div>'+'<span class="plot-title">{{name}}</span> ({{readableFrequency}}) in <span class="plot-units">{{units}}</span>'+'<span class="plot-formula">= {{formula}}</span></div>'+"{{components}}"+"</li>",mapModeSelector:'<select class="map-mode">'+'<option value="default">graph default ({{graphMapMode}})</option>'+'<option value="heat">'+i.mapModes.heat+"</option>"+'<option value="abs-change">'+i.mapModes["abs-change"]+"</option>"+'<option value="percent-change">'+i.mapModes["percent-change"]+"</option>"+'<option value="bubbles">'+i.mapModes.bubbles+"</option>"+'<option value="change-bubbles">'+i.mapModes["change-bubbles"]+"</option>"+'<option value="correlation">'+i.mapModes.correlation+"</option>"+'<option value="treemap">'+i.mapModes.treemap+"</option>"+'<option value="change-treemap">'+i.mapModes["change-treemap"]+"</option>"+"</select>",mapPlots:'<div class="mapplots">'+"<h4>"+p.mapset+" Mapped set of geographical regions</h4>"+'<ol class="mapplots">{{mapPlots}}</ol></div>'+"</div>",mapPlot:'<li class="mapplot">'+'<div class="mapplot-colors" style="margin-bottom:5px;"></div>'+'<div class="plot-info">'+'<button class="edit-mapplot right">configure</button>'+'<div class="edit-block">'+'<span class="plot-title">{{name}}</span> ({{readableFrequency}}) in <span class="plot-units">{{units}}</span>'+"</div>"+'<div class="editor"></div>'+"</div>"+'<span class="plot-formula">= {{formula}}</span><br>'+"{{components}}"+"</li>",seriesPlotEditor:'<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete plot</button>'+'<fieldset class="edit-line" style="padding: 0 5px;display:inline-block;"><legend>color, thickness, &amp; style</legend>'+'<div class="edit-block"><input class="plot-color" type="text" data="color" value="{{color}}" /></div>'+"{{selectStyle}}{{selectThickness}}"+"</fieldset>"+'<div class="edit-block">Name: <input class="plot-name" type="text" data="name" /></div>'+'<div class="edit-block"><span class="edit-label">display as:</span><select class="plot-type" data="type"><option value="">graph default</option><option value="line">line</option><option value="column">column</option><option value="area">stacked area</option></select></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text" /><span class="plot-edit-k edit-label">scalor:<input class="short" value="{{k}}"></span> '+'<span class="edit-label">frequency:</span><select class="dshift">{{fOptions}}</select></div><br>'+'<span class="edit-label">Point calculations:</span>'+U.compMathDiv+'<div class="edit-block"><span class="edit-label">Break line</span><div class="edit-breaks">'+'<input type="radio" id="never-'+t+'" name="line-break-'+t+'" data="breaks" value="never" /><label for="never-'+t+'">never</label>'+'<input type="radio" id="nulls-'+t+'" name="line-break-'+t+'" data="breaks" value="nulls" /><label for="nulls-'+t+'">on nulls</label>'+'<input type="radio" id="missing-'+t+'" name="line-break-'+t+'" data="breaks" value="missing" /><label for="missing-'+t+'">on missing value and nulls</label></div>'+"</div>"+"</div>",pointPlotEditor:'<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<div class="edit-block marker-color"><input class="marker-color" type="text" data="color" value="{{color}}" /></div>'+'<div class="edit-block">name: </span><input class="plot-name" type="text"  /></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" type="text" /><span class="plot-edit-k"><input class="short" value="{{k}}"> </div><br>'+'<span class="edit-label">Point calculations:</span>'+U.compMathDiv+'<span class="edit-label attribute">Calculated value modifies each marker&rsquo;s </span>'+'<div class="attribute">'+'<input type="radio" name="attribute-'+t+'" id="attribute-r-'+t+'" data="attribute" value="r"/><label for="attribute-r-'+t+'">area by value</label>'+'<input type="radio" name="attribute-'+t+'" id="attribute-r-change-'+t+'" data="attribute" value="r-change"/><label for="attribute-r-change-'+t+'">area by the changes over time</label>'+'<input type="radio" name="attribute-'+t+'" id="attribute-fill-'+t+'" data="attribute" value="fill" /><label for="attribute-fill-'+t+'">color by value</label>'+"</div>",mapPlotEditor:'<div class="plot-editor" style="display: none;">{{mergeFormula}}'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete map set</button>'+'<button class="plot-delete prov-float-btn">delete heat map</button>'+'<div class="edit-block">name: </span><input class="plot-name" type="text" data="name"/></div><br>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text"/><span class="plot-edit-k"> scalor: <input class="short" value="{{k}}"></div><br>'+'<span class="edit-label">Point calculations:</span>'+U.compMathDiv+'<div class="edit-block add-bunny"><button  class="add-bunny">add regional tracking plot</button></span></div> '+"</div>",components:'<ol class="components {{plotType}}-comp">{{components}}</ol>',component:'<li class="component ui-state-default" data="{{handle}}">'+'<span class="plot-op ui-icon {{opClass}}" style="{{opStyle}}">operation</span> '+'<span class="comp-edit-k" style="display:none;"><input class="short" value="{{k}}"> * </span>'+"{{icon}}{{name}} ({{freq}}) in {{units}} {{source}}"+"</li>",cube:'<div class="cube">'+'<button class="edit right">edit</button>'+'<button class="close cube-edit right hidden">close</button>'+'<button class="reset cube-edit right hidden">reset</button>'+"<h5>Data cube visualization labels</h5>"+'<div class="name">title: <span class="cube value-label">{{editedName}}</span>'+'<input class="cube-edit" value="{{escapedName}}">'+'<span class="reset-label {{nameResetClass}}">reset value: <span class="cube reset-value">{{resetName}}</span></span></div>'+'<div class="units">units: <span class="cube value-label">{{editedUnits}}</span>'+'<input class="cube-edit" value="{{escapedUnits}}">'+'<span class="reset-label {{unitsResetClass}}">reset value: <span class="cube reset-value">{{resetUnits}}</span></span></div>'+"{{dimensions}}"+"</div>",cubeDimension:'<div class="dimension" data="{{name}}">'+'<span class="dimension"><b>{{name}}</b> dimension:</span>'+"<ol>"+"{{facets}}"+"</ol>"+"</div>",cubeFacet:'<li class="facet">'+'<span class="value-label">{{editedName}}</span>'+'<input class="cube-edit" value="{{escapedName}}" data="{{index}}">'+'<span class="reset-label {{editedClass}}">reset value: <span class="cube reset-value">{{resetName}}</span>'+"</li>",okcancel:'<button class="config-cancel">cancel edits</button><button class="right config-ok">ok</button>'},P={build:function B(e){var n,s="",o,l;if(typeof e!="undefined"){if(k.find(".chart-plots").length==0)k.find(".config-ok").after('<div class="chart-plots"><H4>Chart</H4><ol class="plots"></ol></div');k.find("ol.plots").append(P.seriesPlotHTML(e))}else{w=$("#"+t);k=w.find("div.provenance").show();y=i.panelGraphs[t];P.isDirty=false;x=y.clone();C=x.plots||false;S=x.mapsets||false;_=x.pointsets||false;D=x.annotations;T=x.mapconfig;if(C){var c="";for(n=0;n<C.length;n++){c+=P.seriesPlotHTML(n)}s=r(I.seriesPlots,{seriesPlots:c})}o=P.provenanceOfMap();k.html(I.okcancel+s+I.landing+o);mapPlotLegends=[];k.find(".mapplot-colors").each(function(e){mapPlotLegends.push(P.legendEditor($(this),S[e],"M"))});if(_){a=this.legendEditor(k.find(".pointsets-colors"),T,"X");if(T.markerScaling)k.find("div.pointsets div.color-scale").slideDown()}k.find("button.config-cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){P.provClose()});k.find("button.config-ok").button({disabled:true,icons:{secondary:"ui-icon-check"}}).click(function(){P.commitChanges()});k.find("input.map-background").colorPicker().change(function(){T.mapBackground=$(this).val();N()});P.cubeEditor()}k.find("li.plot").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});k.find("li.component").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});k.find(".edit-plot").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("li.component").each(function(){P.showComponentEditor(this,"plot")});P.showSeriesPlotEditor(e)});k.find("button.edit-mapplot").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("ol li.component").each(function(){P.showComponentEditor(this,"mapPlot")});P.showMapPlotEditor(e)});k.find(".edit-pointPlot").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("ol li.component").each(function(){P.showComponentEditor(this,"pointplot")});P.showPointPlotEditor(e)});R();P.sortableOn()},seriesPlotHTML:function q(e){var t=C[e];return r(I.seriesPlot,{i:e,plotColor:t.options.color||(y.chart&&y.chart.get("P"+e)?y.chart.get("P"+e).color:h[e%h.length]),lineWidth:38*(t.options.lineWidth||2),lineHeight:t.options.lineWidth||2,lineStyle:t.options.lineStyle||"Solid",name:t.name(),plotPeriodicity:P.plotPeriodicity(t),units:t.units(),formula:t.formula(),plotType:t.type(),components:P.componentsHTML(t)})},componentsHTML:function(e){var t="",a,n="";var i={sum:"summing",wavg:"day-weighted averaging of"};for(var s=0;s<e.components.length;s++){a=e.components[s];if(e.components[s].options.op==null)e.components[s].options.op="+";t+=r(I.component,{handle:a.handle(),opClass:m.cssClass[e.components[s].options.op],opStyle:e.options.userFormula?"display:none;":"",k:a.options.k||1,icon:a.isPointSet()?p.pointset:a.isMapSet()?p.mapset:"",name:a.name(),freq:e.options.fdown!=a.freq&&e.options.algorithm?f.name[a.freq]+' created by <a href="/workbench-help/changing-frequency/" traget="_blank">'+i[e.options.algorithm]+"</a> "+f.name[a.freq]+" data":f.name[a.freq],units:a.units,source:a.isSeries()?' <a class="link comp-view">view source data</a>':""})}return r(I.components,{plotType:e.type(),components:t})},plotPeriodicity:function O(e){return'<span class="plot-freq">'+f.name[e.freq()]+(e.options.fdown?synthesized:"")+"</span>"},sortableOff:function(){k.find("ol.plots").sortable("disable").enableSelection();k.find("ol.pointplots").sortable("disable").enableSelection();k.find("ol.mapplots").sortable("disable").enableSelection();k.find("ol.components").sortable("disable").enableSelection()},sortableOn:function(){k.find("ol.components").sortable({containment:k.get(0),connectWith:".components",helper:"clone",placeholder:"ui-state-highlight",forcePlaceholderSize:true,disabled:false,cancel:".landing, .not-sortable",axis:"y",delay:150,start:function(e,t){var a,n,i,s;if(t.item.parent().hasClass("M-comp"))i="map";if(t.item.parent().hasClass("S-comp"))i="plot";if(t.item.parent().hasClass("X-comp"))i="point";var o=P.getModel(t.item);P.dragging={type:i,plotIndex:o.plotIndex,compIndex:o.compIndex,component:o.component,obj:o.plot,$ol:t.item.parent()}},update:function(e,t){console.info("updated");P.componentMoved(t)}}).disableSelection();k.find("ol.plots").sortable({axis:"y",dropOnEmpty:false,connectWith:".plots",disabled:false,start:function(e,t){P.dragging={type:"plot",plotIndex:t.item.index(),compIndex:null,$ol:t.item.parent()}},update:function(e,t){var a,n;var i=C.splice(P.dragging.plotIndex,1)[0];C.splice(t.item.index(),0,i);var s=t.item.index()>P.dragging.plotIndex?-1:1;for(a=0;a<D.length;a++){if(D[a].type=="point"){n=parseInt(D[a].series.substr(1));if(n==P.dragging.plotIndex){D[a].series="P"+t.item.index()}else{D[a].series="P"+(n+s).toString()}}}N()}}).disableSelection();k.find("ol.mapplots").sortable({axis:"y",dropOnEmpty:false,connectWith:".mapplots",disabled:false,start:function(e,t){P.dragging={type:"mapplot",plotIndex:t.item.index(),compIndex:null,$ol:t.item.parent(),obj:_[t.item.index()]}},update:function(e,t){if(t.sender==null)return;var a=S.splice(P.dragging.plotIndex,1);S.splice(t.item.index(),0,a);N()}}).disableSelection();k.find("ol.pointplots").sortable({axis:"y",dropOnEmpty:false,connectWith:".pointplots",disabled:false,start:function(e,t){P.dragging={type:"pointplot",plotIndex:t.item.index(),compIndex:null,$ol:t.item.parent(),obj:_[t.item.index()]}},update:function(e,t){if(t.sender==null)return;var a=_.splice(P.dragging.plotIndex,1);_.splice(t.item.index(),0,a);N()}}).disableSelection();k.find("a.comp-view").off().click(function(){var e=$(this).closest("li").attr("data");if(e){Dt(y.assets[e])}})},componentMoved:function L(e){var t,a,n,i,s,o,r;if(e.sender==null&&e.item.closest("ol")[0]!=P.dragging.$ol[0])return;s=e.item.closest(".plot, .mapplot, .pointplot").index();var l=e.item.parent().hasClass("blank-plot");if(e.item.parent().hasClass("M-comp")){o="map";if(!l)r=S[s]}if(e.item.parent().hasClass("S-comp")){o="plot";if(!l)r=C[s]}if(e.item.parent().hasClass("X-comp")){o="point";if(!l)r=_[s]}if(P.dragging.component.isMapSet()&&o!="map"){k.find("ol.components").sortable("cancel");vt("mapset restrictions","A mapset is a grouping of series, each correspond to an area on a map, such as a state or country.  Mapsets cannot be mixed with marker sets or displayed on a line graph.<br><br>Note that from from the map, you can easily select and chart any of this mapsets' component series.");return}if(P.dragging.component.isPointSet()&&o!="point"){k.find("ol.components").sortable("cancel");vt("pointset restrictions","A pointset is a grouping of series, each correspond to a precise location determined by longitude and latitude values.  Pointsets cannot be mixed with area mapsets or displayed a line graph.<br><br>Note that from from the map, you can easily select and chart any of this pointsets' component series.");return}a=e.item.attr("data");if(s!=P.dragging.plotIndex&&P.dragging.type==o&&e.item.closest("ol")[0]!=P.dragging.$ol[0]){for(t=0;t<r.components.length;t++){if(r.components[t].handle()==a){k.find("ol.components").sortable("cancel");vt("duplicate series",'This series is already a component of the target plot.<br><br>If you want to use a series multiple times in the plot formula, use <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> of the formula from with the <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> plot instead.');return}}}if(s!=P.dragging.plotIndex&&P.dragging.type==o&&!l){for(t=0;t<r.components.length;t++){if(P.dragging.component.freq!=r.components[t].freq){k.find("ol.components").sortable("cancel");vt("frequency discrepancy","When performing array math, the sample frequency of all component series must be the same.");
return}}}e.item.parent().find(".component-landing").remove();var c=P.dragging.obj.components.splice(P.dragging.compIndex,1)[0];i=e.item.index();if(l){r={options:{},components:[c]};C.push(r);k.find("ol.plots").append(P.seriesPlotHTML(C.length-1))}else{r.components.splice(i,0,c)}P.setFormula(r,e.item.closest(".plot, .mapplot, .pointplot"));if(P.dragging.obj.components.length==0){if(P.dragging.type=="plot"){C.splice(P.dragging.plotIndex,1);k.find("ol.plots li.plot")[P.dragging.plotIndex].remove();var d;for(t=0;t<D.length;t++){if(D[t].type=="point"){d=parseInt(D[t].series.substr(1));if(d==P.dragging.plotIndex){D.splice(t,1);t--}if(d>P.dragging.plotIndex){D[t].series="P"+--d}}}}if(P.dragging.type=="point"){_.splice(P.dragging.plotIndex,1);k.find("ol.pointplots li.pointplot")[P.dragging.plotIndex].remove()}if(P.dragging.type=="map"){S.splice(P.dragging.plotIndex,1);k.find("ol.mapplots li.mapplot")[P.dragging.plotIndex].remove()}}else{P.setFormula(P.dragging.obj,P.dragging.$ol.parent())}if(l){e.item.remove();P.sortableOn()}N()},cubeEditor:function(){if(!y.cubeid||!y.assets||!y.assets.cube)return;var e=y.assets.cube;var t=T.cube&&T.cube.name||e.name;var a=T.cube&&T.cube.units||e.units;var n="";if(e.barAxis||e.barNames)n=s(e.barAxis,e.barNames);if(e.stackAxis||e.stackNames)n+=s(e.stackAxis,e.stackNames);if(e.sideAxis||e.sideNames)n+=s(e.sideAxis,e.sideNames);var i=o.mustache(I.cube,{editedName:t,escapedName:t.replace('"',"&quot;"),resetName:e.name,nameResetClass:t==e.name?"hidden":"show",units:a,editedUnits:a.replace('"',"&quot;"),escapedUnits:a.replace('"',"&quot;"),resetUnits:e.units||"",unitsResetClass:e.units==a?"hidden":"show",dimensions:n});k.append(i);k.find(".cube button.edit").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){k.find(".cube .cube-edit").show();if(T.cube)k.find(".cube button.reset").show();k.find(".cube .edit, .cube .value-label").hide()});k.find(".cube button.close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){k.find(".cube .cube-edit").hide();k.find(".cube button.edit, .cube span.value-label").show()});k.find(".cube button.reset").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"},disabled:typeof T.cube=="undefined"}).click(function(){delete T.cube;k.find(".cube").remove();P.cubeEditor();N()});k.find(".cube input").hide().change(function(){var e=$(this);var t=e.closest("div, li");var a=e.attr("data");t.find("span.value-label").html(e.val());if(!T.cube)T.cube={dims:{}};if(t.hasClass("facet")){var n=t.closest("div.dimension").attr("data");if(!T.cube.dims[n])T.cube.dims[n]=[];T.cube.dims[n][parseInt(e.attr("data"))]=e.val()}if(t.hasClass("name")){T.cube.name=e.val()}if(t.hasClass("units")){T.cube.units=e.val()}t.find("span.reset-label").addClass("show").removeClass("hidden");k.find(".cube button.reset").button("enable");N()});function s(e,t){var a,n,i,s="";for(a=0;a<t.length;a++){n=t[a];i=T.cube&&T.cube.dims&&T.cube.dims[e]?T.cube.dims[e][a]||n:n;s+=o.mustache(I.cubeFacet,{editedName:i,escapedName:i.replace('"',"&quot;"),resetName:n,index:a,editedClass:n==i?"hidden":"show"})}return o.mustache(I.cubeDimension,{name:e,facets:s})}},commitChanges:function E(e){if(P.isDirty&&(C||S||_)){if(C&&C.length>0)y.plots=C;else delete y.plots;y.annotations=D;if(S&&S.length>0)y.mapsets=S;else delete y.mapsets;if(_&&_.length>0)y.pointsets=_;else delete y.pointsets;y.mapconfig=T;if(!y.mapsets&&!y.pointsets)y.map="";y.eachPlot(function(e){delete e.calculatedFormula});this.provClose();y.fetchAssets(function(){if(!e)$("#"+t).find(".graph-type").change()})}},provClose:function z(){delete C;delete D;delete S;delete _;delete T;delete x;k.html("").hide();P.isDirty=false;w.find(".graph-chart").show()},compIndex:function(e){var t=$(e);var a=t.index();return a},getModel:function(e){var t=$(e),a,n,i,s,o=t.hasClass("component"),r,l=false;if(o){a=t;n=t.closest("li.plot, li.mapplot, li.pointplot");l=a.index()}else{a=false;n=t}s=n.index();if(n.hasClass("plot"))i=C[s];if(n.hasClass("mapplot"))i=S[s];if(n.hasClass("pointplot"))i=_[s];if(o){l=a.index();r=i.components[l]}return{plot:i,plotIndex:s,component:r,compIndex:l}},showComponentEditor:function G(e,t){var a=$(e);var n=P.getModel(e);var i=n.component;var s=i.handle();var o=(i.isSeries()?'<button class="comp-copy prov-float-btn">make copy</button>':"")+'<button class="comp-delete prov-float-btn">remove series</button>';var r=$(o);a.find(".plot-op").hide().after('<div class="op">'+'<input type="radio" data="+"  id="op-addition'+s+'" value="+" name="op-radio'+s+'" /><label for="op-addition'+s+'">+</label>'+'<input type="radio" data="-"  id="op-subtraction'+s+'" value="-" name="op-radio'+s+'" /><label for="op-subtraction'+s+'">-</label>'+'<input type="radio" data="*"  id="op-multiply'+s+'" value="*" name="op-radio'+s+'" /><label for="op-multiply'+s+'">*</label>'+'<input type="radio" data="/"  id="op-divide'+s+'" value="/" name="op-radio'+s+'" /><label for="op-divide'+s+'">/</label>'+"</div>");a.find("div.op").find("input[data='"+i.options.op+"']").attr("checked","checked").end().buttonset().find("input:radio").change(function(){P.set(n.component.options,"op",$(this).val());P.setFormula(n.plot,a.closest(".plot, .mapplot, .pointplot"));a.find(".plot-op").attr("class","plot-op ui-icon "+m.cssClass[n.plot.components[n.compIndex].options.op])});r.appendTo(a).slideDown();a.find(".comp-edit-k").show().find("input").change(function(){if(!isNaN(parseFloat(this.value))){i.options.k=Math.abs(parseFloat(this.value));if(i.options.k==0)i.options.k=1;N();P.setFormula(n.plot,a.closest("ol").parent())}else{vt("Error","Scalors must be numerical")}$(this).val(i.options.k)});a.find(".comp-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){if(n.plot.components.length==1){a.closest("li.plot").find(".plot-delete").click()}else{n.plot.components.splice(n.compIndex,1);a.remove();N()}});a.find(".comp-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){var e={options:{},components:[$.extend(true,{},i,{options:{op:"+"}})]};C.push(e);k.find("ol.plots").append(P.componentsHTML(e))})},showSeriesPlotEditor:function W(e){P.sortableOff();var a=$(e);var n=a.index();var i=C[n];var s=i.options;var o=i.options.color||a.find("div.line-sample").attr("data");a.find(".edit-plot, .plot-info").hide();var c='<select class="plot-thickness" data="lineWidth">';for(var d=1;d<=5;d++)c+='<option value="'+d+'">'+d+"px</option>";c+="</select>";var p='<select class="plot-linestyle" data="lineStyle">';for(var u=0;u<l.length;u++)p+='<option value="'+l[u].replace(/ /g,"")+'">'+l[u].toLowerCase()+"</option>";p+="</select>";var h=i.freq();var f=this.freqOptions(i);k.find("button.plot-close").click();var m=$(r(I.seriesPlotEditor,{color:o,selectThickness:c,selectStyle:p,k:i.options.k||1,fOptions:f,name:i.name(),units:i.units()}));m.find("input.plot-name").val(i.name()).on("change",function(){$(this).val(i.name(i.name(false)!=$(this).val().trim()?$(this).val().trim():""));N()}).on("keydown",N);m.find("input.plot-units").val(i.units()).on("change",function(){if(i.units(true)!=$(this).val()&&$(this).val().trim()!=""){i.options.units=$(this).val()}else{delete i.options.units}a.find("span.plot-units").html(i.units());N()}).on("keydown",N);m.find("select.dshift").val(h).change(function(){var e=$(this).val();var t=m.find("select.dshift option:selected").attr("data");if(e!=t){selectDownshift(y,e,i,function(t){if(t){s.fdown=e;s.algorithm=t.algorithm;s.missing=t.missing;$.each(i.components,function(){var t=y.assets[this.handle];if(t.freqset[e]){this.handle=t.freqset[e]}else{this.handle=t.freqset[e=="A"&&t.freqset.Q?"Q":"M"]}});h=e;N()}else{m.find("select.dshift").val(h)}})}else{delete s.fdown;delete s.algorithm;delete s.missing;$.each(i.components,function(){this.handle=y.assets[this.handle].freqset[e]});h=e;N()}});if(!i.options.componentData)i.options.componentData="required";m.find("div.edit-math").find("input[id='"+i.options.componentData+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){i.options.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];N()});if(!i.options.breaks)i.options.breaks="nulls";m.find("div.edit-breaks").find("input[id='"+i.options.breaks+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){P.set(i.options,$(this))});m.find(".edit-line legend").after(a.find(".line-sample").hide().clone().css("display","inline-block").show());m.find("input.plot-color").colorPicker().change(function(){P.set(i.options,$(this));a.find("div.line-sample").css("background-color",i.options.color)});m.find("select.plot-thickness").val(i.options.lineWidth||2).change(function(){P.set(i.options,$(this));a.find("div.line-sample").css("height",i.options.lineWidth||2).find("img").css("height",i.options.lineWidth||2).css("width",parseInt((i.options.lineWidth||2)*38)+"px")});m.find("select.plot-linestyle").val(i.options.lineStyle).change(function(){P.set(i.options,$(this));a.find("div.line-sample img").attr("src","images/"+i.options.lineStyle+".png")});m.find("select.plot-type").val(i.options.type).change(function(){P.set(i.options,$(this))});m.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){i.options.k=Math.abs(parseFloat(this.value));if(i.options.k==0)i.options.k=1;P.setFormula(i,a);N()}else{vt("Error","Scalors must be numerical")}$(this).val(i.options.k||1)});m.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){C.splice(a.index(),1);a.remove();N()});m.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){C.push($.extend(true,{},i));P.build(n)});m.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var e;a.find(".edit-plot, .plot-info, .line-sample, span.plot-formula").show();a.find(".plot-editor").slideUp("default",function(){a.find(".op.ui-buttonset").remove();if(!s.userFormula)a.find(".plot-op").show();a.find(".plot-editor, button.manual, button.guided, input.plot-formula").remove();a.find("li button").remove();m.remove()});a.find(".comp-edit-k").hide();k.find(".landing").slideDown();a.find(".comp-editor").slideUp("default",function(){$(this).remove()});a.find(".edit-plot").show();P.sortableOn()});m.prependTo(a);this.editPlotFormula(i,a);m.slideDown();k.find(".landing").slideUp()},freqOptions:function(e){var t,a,n,i,s="",o={},r;for(t=0;t<f.order.length;t++){n=true;r=f.order[t];e.eachComponent(function(){if(!this.freqs||this.freqs.indexOf(r)!==-1)n=false});if(n){s+='<option value="'+r+'" data="'+r+'">'+f.name[r]+" using official data</option>";o[r]=true}}if(!o["Q"]&&o["M"])s+='<option value="Q" data="M">'+f.name.Q+" calculated from monthly data</option>";if(!o["A"]&&(o["M"]||o["Q"]))s+='<option value="A" data="'+(o["Q"]?"Q":"M")+'">'+f.name.A+" calculated from "+(o["Q"]?f.name.Q:f.name.M)+" data</option>";return s},showPointPlotEditor:function(e){P.sortableOff();var n=_[e.index()];var i=n.options;e.find(".edit-plot, .plot-info").hide();k.find("button.plot-close").click();var s=$(r(I.pointPlotEditor,{color:i.color,k:i.k||1}));s.find("input.plot-name").val(n.name()).on("change",function(){if(n.name()!=$(this).val().trim())$(this).val(n.name($(this).val()));N()}).on("keydown",N);s.find("input.plot-units").val(n.units()).on("change",function(){if(n.units(true)!=$(this).val()&&$(this).val().trim()!="")i.units=$(this).val();else delete i.units;N()}).on("keydown",N);s.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){i.k=Math.abs(parseFloat(this.value));if(i.k==0)i.k=1;P.setFormula(n,e)}else{vt("Error","Scalors must be numerical")}$(this).val(i.k||1)});s.find("input.marker-color").colorPicker().change(function(){P.set(i,$(this));s.find("div.marker").css("background-color",$(this).val())});function o(){for(var e=0;e<_.length;e++){if(_[e].options.attribute=="fill"){s.find("div.marker-color").hide();return}}s.find("div.marker-color").show()}o();s.find("div.attribute").find("[value='"+(i.attribute||"r")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){P.set(i,$(this));a.setRadLabel();a.legendOptionsShowHide();o()});if(!i.componentData)i.componentData="required";s.find("div.edit-math").find("input[id='"+i.componentData+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){i.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];N()});s.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){C.splice(e.index(),1);e.remove();N()});s.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){C.push($.extend(true,{},n));P.build(plotIndex)});s.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var t;e.find(".edit-plot, .plot-info, .line-sample").show();e.find(".plot-editor").slideUp("default",function(){e.find(".op.ui-buttonset").remove();if(!i.userFormula)e.find(".plot-op").show();e.find(".guided, .manual, input.plot-formula, .plot-editor, li button").remove();s.remove()});e.find(".comp-edit-k").hide();k.find(".landing").slideDown();e.find(".comp-editor").slideUp("default",function(){$(this).remove()});e.find(".edit-plot").show();P.sortableOn()});s.prependTo(e);this.editPlotFormula(n,e);s.slideDown();k.find(".landing").slideUp();e.find(".edit-pointPlot").hide()},provenanceOfMap:function V(){var e="",t="",a="",n,s,o,l,c=y.isSummationMap();if(y.map&&(S||_)){if(S){var p="";for(o=0;o<S.length;o++){l=S[o];p+=r(I.mapPlot,{color:l.options.color||"#000000",name:l.name(),units:l.units(),readableFrequency:P.plotPeriodicity(l),formula:l.formula(),components:P.componentsHTML(l)})}t=r(I.mapPlots,{mapPlots:p})}if(_){var u="";for(n=0;n<_.length;n++){s=_[n];u+=r(I.pointPlot,{color:s.options.color||"#000000",name:s.name(),units:s.units(),readableFrequency:P.plotPeriodicity(s),formula:s.calculateFormula().formula,components:P.componentsHTML(_[n])})}a=r(I.pointPlots,{pointPlotsHTML:u})}e=r(I.mapProv,{mapBackground:T.mapBackground||i.mapBackground,map:i.maps[y.map].name,mapPlots:t,pointPlots:a})}return e;function h(){var e,t,a,n='<option value="0">none</option>';if(c)n+='<option value="sum" '+(T.cubeid=="sum"?"selected":"")+">bar graph of components</option>";for(e=0;e<themes.length;e++){a=d["T"+themes[e]];if(a){for(t=0;t<a.cubes.length;t++){n+='<option value="'+a.cubes[t].cubeid+'" '+(T.cubeid==a.cubes[t].cubeid?"selected":"")+">"+a.name+": "+a.cubes[t].name+"</option>"}}}return n}},editPlotFormula:function(e,t){if(e.options.userFormula){a()}else{n()}function a(){t.find("div.op, span.comp-edit-k").hide();t.find("button.manual").remove();t.find("span.plot-formula").hide().after('<button class="guided">guided editing</button>').after('<input class="plot-formula">');t.find("input.plot-formula").val(e.formula()).keyup(function(){N();try{var a=$(this).val();if(a.indexOf(";")>=0)throw"invalid mathematical syntax";var n="return "+a.replace(b,"values.$1")+";";var i=new Function("values",n);var s={},o;$.each(e.components,function(t){o=e.compSymbol(t);if(a.indexOf(o)===-1)throw"all symbols must be used";s[e.compSymbol(t)]=t});var r=i(s);$(this).removeClass("ui-state-error");e.options.userFormula=a;t.find("span.plot-formula").html("= "+e.options.userFormula)}catch(l){$(this).addClass("ui-state-error");delete e.options.userFormula}});t.find("button.guided").button({icons:{secondary:"ui-icon-star"}}).click(function(){n();N()})}function n(){t.find("div.op, span.comp-edit-k").show();t.find("input.plot-formula, button.guided").remove();t.find("span.plot-formula").html("= "+e.formula()).show().after('<button class="manual">manual editing</button>');delete e.options.userFormula;t.find("button.manual").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){N();a()})}},showMapPlotEditor:function(e){var t=S[e.index()];var a=t.options;P.sortableOff();e.find(".edit-plot, .plot-info").hide();k.find("button.plot-close").click();k.find("button.plot-close").click();e.find("button.edit-mapplot").hide();var s=$(r(I.mapPlotEditor,{mergeFormula:a.mode=="bubble"?I.mergeFormula:"",k:a.k||1}));P.editPlotFormula(t,e);s.find("button.add-bunny").button({icons:{secondary:"ui-icon-plus"}}).click(function(){var s="add";if(s=="add"){var o,r,l=[];t.eachComponent(function(){if(this.isMapSet())l.push(this.setid)});M({command:"GetBunnySeries",setids:l,freq:t.freq(),geoid:parseInt(i.maps[y.map].bunny),map:y.map},function(e,a,i){if(e.allfound){for(r in e.assets){y.assets[e.assets[r].handle]=e.assets[r]}var s={options:{k:t.options.k||1,units:t.options.units},components:[]};for(o=0;o<t.components.length;o++){if(t.components[o].isMapSet()){s.components.push(new n.Component(e.assets["M"+t.components[o].setid],{k:t.components[o].k||1,op:t.components[o].op||"+"}))}else{s.components.push(t.components[o].clone())}}var l,c=C,d=false;if(c){for(l=0;l<c.length;l++){if(s.options.k!=c[l].options.k||1){for(o=0;o<c[l].components.length;o++){if(c[l].components[o].handle!=s.components[o].handle||c[l].components[o].options.k||1!=s.components[o].options.k||c[l].components[o].options.op||"+"!=s.components[o].options.op)break}if(o==c[l].components.length){d=true;$(this).val(l);break}}}}if(!d){if(!C)C=[];C.push(new n.Plot(s.components,s.options));P.build(C.length-1);N()}}else{vt("unable to automatically create tracking plot","One or more of the component map sets does not have series for "+y.map+" level of aggregation.")}})}else{if(s=="-1"){delete a.bunny}else{a.bunny=parseInt(s)}}P.setFormula(t,e);N()});s.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){a.k=Math.abs(parseFloat(this.value));if(a.k==0)a.k=1;P.setFormula(t,e);N()}else{vt("Error","Scalors must be numerical")}$(this).val(a.k||1)});s.find("div.edit-math").find("[value='"+(a.compMath||"required")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){P.set(a,$(this))});s.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){C.splice($liPlot.index(),1);t.destroy();e.remove();if(!_)k.find("map-prov").remove();N()});s.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){e.find("button.edit-mapplot, .plot-info").show();e.find(".plot-editor").slideUp("default",function(){e.find(".op.ui-buttonset, .comp-delete").remove();$(this).remove();if(!t.options.userFormula)e.find(".plot-op").show()});e.find(".guided, .manual, input.plot-formula, span.comp-edit-k").remove();e.find(".ehide").show();k.find(".landing").slideDown();e.find(".comp-editor").slideUp("default",function(){$(this).remove()});P.sortableOn()});s.find("input.plot-name").val(t.name()).on("change",function(){P.set(t.options,$(this));e.find("span.plot-title").html(t.name())}).on("keydown",N);s.find("input.plot-units").val(t.units()).on("change",function(){P.set(t.options,$(this));e.find("span.plot-units").html(t.units())}).on("keydown",N);e.find(".ehide").hide();e.find(".plot-info").after(s);s.show();k.find(".landing").hide()},setFormula:function(e,t){var a=e.calculateFormula();if(t){t.find("span.plot-formula").html("= "+a.formula);if(!e.options.units)t.find("input.plot-units").val(e.units());if(!e.options.name)t.find("input.plot-name").val(e.name())}},legendEditor:function(e,t,a){var n=a=="M"?t.options:t;var s,o=k.find(".map-prov");var l=$(r(I.legendEditor,{id:A++,mapModeSelector:a=="X"?"":r(I.mapModeSelector,{graphMapMode:i.mapModes[T.mapMode||"heat"]}),markerType:a=="X"?"marker":"bubble",maxRadius:n.attribute=="fill"?T.fixedRadius||c:T.maxRadius||u,negColor:n.negColor||g.NEG,continuousColorScale:j(n),posColor:n.posColor||g.POS}));l.find("select.map-mode").val(n.mapMode||"default").change(function(){if(this.value=="default")delete n.mapMode;else n.mapMode=this.value;if(n.mapMode=="bubble")n.merges=n.merges||[];d();R();N()});d();function d(){if(n.mode=="bubble")l.find(".merge-formula").show();else l.find(".merge-formula").hide();f()}l.find("div.legend-scale").find("[value='"+(n.scale||"continuous")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){P.set(n,$(this));p()});function p(){if(n.scale=="discrete"){l.find(".legend-discrete").removeAttr("style");l.find(".lin-log-scaling").hide();l.find(".legend-continuous").hide()}else{l.find(".legend-discrete").hide();l.find(".lin-log-scaling").removeAttr("style");l.find(".legend-continuous").removeAttr("style")}}p();l.find(".lin-log-scaling").find("[value='"+(n.logMode||"off")+"']").attr("checked",true).end().buttonset().find("input").change(function(){P.set(n,$(this))});l.find(".radius-spinner").spinner({min:2,max:200,spin:h,change:h});function h(e,t){if(a=="M"||n.attribute!="fill"){T.maxRadius=$(this).val()}else{T.fixedRadius=$(this).val()}N()}l.find(".color-picker.pos").colorPicker().change(function(){P.set(n,$(this));l.find(".continuous-strip-pos").html(F("#CCCCCC",n.posColor));o.find(".map-legend").html("-"+j(n)+"+")});l.find(".color-picker.neg").colorPicker().change(function(){P.set(n,$(this));l.find(".continuous-strip-neg").html(F(n.negColor,"#CCCCCC"));o.find(".map-legend").html("-"+j(n)+"+")});l.find(".legend-discrete").append(P.discreteLegend(e,t,a));f();e.append(l);return{legendOptionsShowHide:f,setRadLabel:m};function f(){if(a=="X"||a=="M"&&n.mode=="bubble"){l.find("div.radius").slideDown()}else{l.find("div.radius").slideUp()}if(a=="M"&&(n.mode||"fill"=="fill")||a=="X"&&T.markerScaling!="none"&&v(_)>0){l.find("div.color-scale").slideDown();if(n.scale=="discrete"){l.find("div.legend-continuous").hide();l.find("div.legend-discrete").removeAttr("style")}else{l.find("div.legend-continuous").removeAttr("style");l.find("div.legend-discrete").hide()}}else{l.find("div.color-scale").slideUp()}}function m(){}},discreteLegend:function(e,t,a){var i,s,o,r;var l=a=="X"?T:t.options;if(!Array.isArray(l.discreteColors)||l.discreteColors.length==1)l.discreteColors=d(5);i=$(I.discreteLegendShell);c();i.find("button.inc-discrete").button({disabled:l.discreteColors.length>9}).click(function(){i.find("button.inc-discrete").button("enable");l.discreteColors=d(l.discreteColors.length+1);if(l.discreteColors.length>9)$(this).button("disable");c();N()});i.find("button.dec-discrete").button({disabled:l.discreteColors.length<2}).click(function(){i.find("button.inc-discrete").button("enable");l.discreteColors=d(l.discreteColors.length-1);if(l.discreteColors.length<2)$(this).button("disable");c();N()});i.find("button.reset-discrete").button().click(function(){l.discreteColors=d(l.discreteColors.length);c();N()});return i;function c(){var e="";for(s=0;s<l.discreteColors.length;s++){e+='<div class="discrete-color"><input class="color" data="'+s+'" value="'+l.discreteColors[s].color+'" /></div>';if(s!=l.discreteColors.length-1){e+=' &#8804; <input class="cutoff" data="'+s+'" value="'+l.discreteColors[s].cutoff+'" />'}}i.find(".discrete-legend").html(e);i.find(".color").colorPicker().change(function(){o=parseInt($(this).attr("data"));l.discreteColors[o].color=$(this).val();N()});i.find(".cutoff").change(function(){o=parseInt($(this).attr("data"));r=$(this).val();if(isNaN(r)){for(s=0;s<l.discreteColors.length;s++){if(s<o)l.discreteColors[s].cutoff=Math.min(l.discreteColors[s].cutoff,r);if(s==o)l.discreteColors[s].cutoff=r;if(s>o)l.discreteColors[s].cutoff=Math.max(l.discreteColors[s].cutoff,r)}}N()})}function d(e){var i,s,o,r=[],c=[],d;if(a=="X")d=y.calculatedMapData.markerData;if(a=="M")d=t.calculatedMapData?t.calculatedMapData.regionData:y.calculatedMapData.regionData;for(s in d){for(o in d[s]){if(d[s][o]!=null)r.push(d[s][o])}}r.sort(function(e,t){return e-t});var p=0,u=0;for(i=0;i<e;i++){if(r[parseInt(r.length/(e/(i+1)))]<0)p++}var h=r[0]<0&&r[r.length-1]>0;if(h){for(u=0;u<r.length;u++){if(r[u]>=0)break}if(h){if(p==0){p++}else{var f=(u/r.length-p/e)*e;if(f<-.5)p++;if(f>.5&&p>1)p--}}}var m=e-p;var b=l.negColor||g.NEG;if(b.substr(0,1)=="#")b=b.substr(1);var v,w,k,x,S,M,C;x=parseInt(b.substr(0,2),16);S=parseInt(b.substr(2,2),16);M=parseInt(b.substr(4,2),16);for(i=0;i<p;i++){v=parseInt(x+(255-x)*(p-i-1)/p);w=parseInt(S+(255-S)*(p-i-1)/p);k=parseInt(M+(255-M)*(p-i-1)/p);C="#"+v.toString(16)+w.toString(16)+k.toString(16);c.push({color:C,cutoff:i+1==p&&h?0:r[Math.round((r.length-1)*(i+1)/e)]})}var _,D=0,T=l.posColor||g.POS,A=n.common.octet;if(T.substr(0,1)=="#")T=T.substr(1);x=parseInt(T.substr(0,2),16);S=parseInt(T.substr(2,2),16);M=parseInt(T.substr(4,2),16);for(i=p;i<m;i++){v=parseInt(x+(255-x)*(m-i-1)/m);w=parseInt(S+(255-S)*(m-i-1)/m);k=parseInt(M+(255-M)*(m-i-1)/m);C="#"+A(v)+A(w)+A(k);_=Math.round((r.length-1-D)*i/e+D);while(_<r.length-1&&r[_]==r[_+1]){_++;D++}c.push({color:C,cutoff:r[_]})}return c}},set:function(e,t,a){if(typeof t=="string"){e[t]=a}else{e[t.attr("data")]=t.val()}N()}};return P;function N(){P.isDirty=true;k.find(".config-ok").button("enable");k.find("button.config-cancel").addClass("ui-state-error")}function R(){var e=k.find(".map-mode-conflict"),t=false,a="min,max,bubbles,change-bubbles,treemap,change-treemap";if(S&&S.length&&S&&S.length){for(var n=0;n<S.length;n++){if(a.indexOf(S[n].mapMode())!=-1){t=true;break}}}if(t)e.show();else e.hide()}function F(e,t){return r(I.continuousColorStrip,{a:e,b:t})}function j(e){return r(I.continuousColorScale,{negStrip:F(e.negColor||g.NEG,g.MID),posStrip:F(g.MID,e.posColor||g.POS)})}}function fa(t,a,n,i,s){console.time("makeTreeMap");t.html("");var o=new Highcharts.Renderer(t[0],t.width(),t.height());t.hide();console.time("makeTreeMap calc");var r=[0,0,t.width(),t.height()];if(!i)i=a.dates[a.dates.length-1].s;var l=[],c,d,p=a.mapUnits,u=0,h=[],f;for(d in a.regionData[i]){if(jvm.Map.maps[n].paths[d]){f={code:d};if(s){f.fromValue=a.regionData[s][d];f.toValue=a.regionData[i][d];f.value=f.toValue-f.fromValue}else{f.value=a.regionData[i][d]}if(!isNaN(f.value)){u+=Math.abs(f.value);l.push(f)}}else{console.info(d+" code in fetched mapset is not found in "+n)}}l.sort(function(e,t){return t.value-e.value});for(c=0;c<l.length;c++){h.push(Math.abs(l[c].value)/u)}var m=e.common.squarify(r,h);console.timeEnd("makeTreeMap calc");var g=t.find(".MashableData_statBox");if(!g.length){t.append('<div class="MashableData_statBox"></div>');g=t.find(".MashableData_statBox")}for(c=0;c<m.length;c++){o.rect(m[c][0],m[c][1],m[c][2],m[c][3],0).attr({fill:l[c].value>0?"#99CCFF":"red",stroke:"black","stroke-width":1}).on("mouseenter",b(c)).on("mousemove",function(e){g.css("top",e.pageY).css("left",e.pageX+5).show()}).add();o.text(jvm.Map.maps[n].paths[l[c].code].name+"<br>"+Highcharts.numberFormat(l[c].value)+(a.fillUnits?" "+a.fillUnits:""),m[c][0]+2,m[c][1]+10).attr({rotation:0}).css({fontSize:"6pt",color:"black"}).on("mousemove",function(e){g.css("top",e.pageY).css("left",e.pageX+5).show()}).add()}function b(e){return function(t){var a=jvm.Map.maps[n].paths[l[e].code].name;g.html(a+":<br>"+l[e].value+" "+p).css("top",t.pageY).css("left",t.pageX+5).show()}}t.show().off().on("mouseout",function(){g.hide()});console.timeEnd("makeTreeMap")}e.common.sumArray=function(){function e(e,t){return e+t}return function(t){return t.reduce(e)}}();e.common.squarify=function(t,a){var n=function(e){this.setX=function(t){e[2]-=t-e[0];e[0]=t};this.setY=function(t){e[3]-=t-e[1];e[1]=t};this.getX=function(){return e[0]};this.getY=function(){return e[1]};this.getW=function(){return e[2]};this.getH=function(){return e[3]};this.getWidth=function(){return Math.min(e[2],e[3])}};var i=function(t,a){var n=Math.max.apply(null,t);var i=Math.min.apply(null,t);var s=e.common.sumArray(t);var o=s*s;var r=a*a;return Math.max(r*n/o,o/(r*i))};var s=function(t){var a=u.getX(),n=u.getY(),i=a+u.getW(),s=n+u.getH(),o,r,l;if(u.getW()<u.getH()){o=e.common.sumArray(t)/u.getW();if(n+o>=s){o=s-n}for(r=0;r<t.length;r++){l=t[r]/o;if(a+l>i||r+1===t.length){l=i-a}c.push([a,n,l,o]);a=a+l}u.setY(n+o)}else{o=e.common.sumArray(t)/u.getH();if(a+o>=i){o=i-a}for(r=0;r<t.length;r++){l=t[r]/o;if(n+l>s||r+1===t.length){l=s-n}c.push([a,n,o,l]);n=n+l}u.setX(a+o)}};var o=function(e){var t=[];t.push(e.shift());if(e.length===0){return t}var a=t.slice();var n=u.getWidth();do{a.push(e[0]);if(i(t,n)>i(a,n)){t=a.slice();e.shift()}else{break}}while(e.length>0);return t};var r=function(e){do{s(o(e))}while(e.length>0)};var l=[];var c=[];var d=[];var p;if(t[2]<=0||t[3]<=0){for(p=0;p<a.length;p++){c.push(t.slice())}}else{d=$.map(a,function(e){return e*(t[2]*t[3])});var u=new n(t.slice());r(d)}return c};