account={info:{username:null,userid:null,auth:null,email:null,fbemail:null,fbid:null,admin:null,ccName:null,ccadresss:null,cccity:null,ccstateprov:null,ccpostal:null,cccountry:null,ccType:null,ccLast4:null,ccExpMMYY:null,subscription:null,expire:null,orgid:null,organization:null,accesstoken:null,md:null},htmls:{subscription:'<div id="account-screen">'+"<h2>Account Management</h2>"+'<div class="account-auth">'+'<input type="radio" name="auth" id="authfb" value="fb" /><label for="authfb"><strong>use Facebook to authenticate me.</strong>  You don\'t have to remember another password.  Everybody wins!</label><br />'+'<input type="radio" name="auth" id="authmd" value="md" /><label for="authmd"><strong>create a separate MashableData password.</strong>  Your personal information will be hashed or encrypted.</label>'+"</div>"+"<h3>Basic information:</h3>"+'<span class="over">display name:</span><input class="req uname medium" data="user name" type="text" /><br />'+'<span class="over">main email:</span><input class="req email medium" data="email" type="text" /><br />'+'<div class="account-pwd hidden blue-inset">'+'<span class="over">MashableData password:</span><input class="req medium pwd" data="pwd" type="password" /><br />'+'<span class="over">confirm password:</span><input class="req medium pwdConfirm" data="pwdConfirm" type="password" />'+"</div>"+"<div>"+"<h3>Subscription type:</h3>"+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-trial" value="T" /><strong>free trial</strong> <em>Access to all features for a limited number of requests.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-ind" value="I" /><strong>individual</strong> <em>Unlimited graphs, custom series, searches and downloads for US$10 every 6 months.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-member" value="C" /><strong>join my organization\'s corporate account</strong> </label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-admin" value="A" /><strong>create a corporate account</strong> <em>Members will get unlimited usage plus confidential sharing of data and visualizations amoung members.  All billing and membership will be managed through this account, so only a single credit card is required.  Select this option to create and administer a new corporate account.</em></label><br />'+'<div class="validation blue-inset hidden">'+'Email validation code (required): <input class="req valcode" data="valcode" type="text" /><br />'+"<em>You email validation code is in an email sent moments ago from admin@mashabledata.com.</em>"+"</div>"+'<div class="regcode blue-inset hidden">'+'Registration code (required): <input class="req regcode" data="regcode" type="text" /><br />'+"<em>Your code is included in your invitation email sent by your organization's administrator.</em>"+"</div>"+'<div class="joinmode blue-inset hidden">'+'Company / organization name: <input data="orgName" id="account-org-name" class="long" /><br />'+"How will users join your organization?<br />"+'<label><input type="radio" name="account-join" id="account-inviteonly" value="inviteonly" /><strong>by invitation only</strong></label><br />'+'<label><input type="radio" name="account-join" id="account-emailorinvite" value="emailorinvite" /><strong>by invitation OR anyone able to receive email through an @<span class="italics account-main-email-domain"></span> account</strong></label>'+"<br /><br />"+"<em>You will be able to add email addresses of new members via the administration panel after your credit card is accepted. MashableData will then email an invitation with a unique registration code and instructions to each new member.</em><br />"+"</div>"+"</div>"+'<h3 class="payments hidden">Payment method:</h3>'+'<div class="payments hidden">'+'<span class="llabel">credit card number:</span><input class="cardNum" data="ccnum" type="text" />'+'<span class="mlabel">CCV:</span><input class="cardCCV tiny" data="ccv" data="optional" type="text" />'+'<span class="right"><span class="mlabel">Expiration:</span>'+'<select class="cardMonth"><option val="1">Jan</option><option val="2">Feb</option><option val="3">Mar</option><option val="4">Apr</option><option val="5">May</option><option val="6">Jun</option><option val="7">Jul</option><option val="8">Aug</option><option val="9">Sep</option><option val="10">Oct</option><option val="11">Nov</option><option val="12">Dec</option></select>'+'<select class="cardYear"></select></span>'+'<br /><span class="llabel">name on card:</span><input type="text" data="ccname" class="cardName medium" /><br />'+'<span class="llabel">address:</span><input type="text" data="ccaddress" class="cardAddress long" /><br />'+'<span class="llabel">city:</span><input type="text" data="cccity" class="cardCity medium" /><span class="cardStateProv mlabel">state:</span><input type="text" data="ccstateprov" class="cardStateProv short" /><span class="cardPostal mlabel">ZIP code:</span><input type="text" class="cardPostal tiny" data="ccpostal"  /><span class="mlabel">country:</span><select class="cardCountry"></select>'+"</div>"+'<button class="ok">ok</button> <button class="cancel">cancel</button>'+"</div>",signIn:'<div id="signin-md">Email:<br><input id="signin-email"><br>Password:<br><input id="signin-pwd"><br><button id="signin-signin">Sign in</button> <input id="signin-stay" type="checkbox" /> stay signed in<br><br>New to MashableData? Create an <a id="create-account" href="javascript:void(0)">account</a></div> '+'<div id="signin-or">~ OR ~</div>'+'<div id="signin-fb"> <fb:login-button></fb:login-button><br /><br />Use your FaceBook account to log in.<br /><br />(No spam or posting without your consent.  We promise and Facebook enforces our promise.)</div>'+'<div style="text-align: center;"><a id="license-link" href="license.html">MashableData Workbench Term of Service</a></div>',signedIn:'<div id="signedin-md"><button id="signedin-signout">Sign out</button><br><br><a id="signedin-subscribe" href="javascript:void(0);">Account &amp; Subscription</a><span id="signedin-admin" style="display:none;"><br><br><a href="admin_users.php" target="_blank">User Management & Billing</a> (Administrator only)</span></div>',verify:'<div id="verify-email">The following email needs verification.  Please enter the verification code emailed to the following email account:  <span class="email"></span><br />'+'<br /><input class="email" type="test" /> <br /><button class="verify">Verify</button> <button class="cancel">Cancel</button> <button class="cancel">Send New Verifcation Code</button></div>'},showPanel:function(e,t){$.fancybox(e,{showCloseButton:false,autoScale:true,overlayOpacity:t?0:.5,hideOnOverlayClick:t?true:false});var a=$("#fancybox-wrap");if(t){var i=t.offset();a.css({top:parseInt(i.top+t.height()-15)+"px",left:parseInt(i.left-a.width()-18+t.width())+"px"})}return a},showSignInOut:function(){var e=$("#menu-account");if(this.loggedIn()){account.showPanel(account.htmls.signedIn,e);if(account.info.subscription==="A")$("#signedin-admin").show();$("#signedin-signout").button().addClass("ui-state-error").click(function(){account.signOut()})}else{account.showPanel(account.htmls.signIn,e);$("#license-link").fancybox();FB.XFBML.parse(document.getElementById("signin-fb"))}$("#create-account,#signedin-subscribe").click(function(){account.showSubscribe()})},showSubscribe:function(){var e=account.showPanel(account.htmls.subscription);var t=$("#account-screen"),a="",i="";var n=false;var s=false;var o;account.subscribing=true;t.find("[data]").each(function(){o=$(this).attr("data");$(this).val(account.info[o])});t.find("input.account-level[value='"+(account.info.subscription||"T")+"']").click();if(account.info.subscription=="C"||account.info.subscription=="A"){t.find("input.account-level").attr("disabled",true);t.find("div.validation").html("You are a member of the corporate account of "+account.info.orgName+".<br><br>This account can only be changed or cancelled in the "+(account.info.subscription=="A"?'<a href="admin_users.php" target="_blank">':"")+"account administrator's panel"+(account.info.subscription=="A"?"</>":"")+".").show()}t.find("input.email").val(account.info.email).change(function(){if(account.isValidEmail(this.value)){$(".account-main-email-domain").html(this.value.split("@")[1].trim());bi({command:"CheckEmailForOrgInv",email:this.value.trim(),modal:"none"},function(e,t,a){s=e.invited;n=e.eligible;if(e.invited){Ua("Corporate membership found","Our records show that a registration code to join the corporate account of "+e.orgname+" was originally sent to "+this.value+" on "+e.date+". The registration email was just resent.  Please copy the registration code from either email into the form to complete your registration.");$("#account-lvl-member").click()}if(e.eligible){Ua("Corporate membership found",'Based on your email, you are eligible to join the corporate account of "'+e.orgname+'".  However, you must first validate your email address.  A registration code was just sent to '+this.value+". Please copy the validation code from the email into the registration form to complete your registration.");$("#account-lvl-member").click()}});if(!account.loggedIn()||this.value!=account.info.email){account.sendVerificationCode(this.value.trim())}}else{$(".account-main-email-domain").html("*no domain detected*")}}).change();t.find("input.uname").val(account.info.name);t.find("span.account-main-email").html(account.info.email);t.find("button.cancel").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){account.subscribing=false;$.fancybox.close()});if(this.loggedIn()){t.find("#"+(account.info.authmode=="Facebook"?"authfb":"authmd")).attr("checked",true);t.find(".email").attr("disabled",true);t.find("input:radio[name='auth']").attr("disabled",true)}bi({command:"CardSelects",modal:"none"},function(e,a,i){var n,s=t.find("select.cardYear"),o=t.find("select.cardCountry");for(n=0;n<e.countries.length;n++){o.append("<option>"+e.countries[n].name+"</option>")}o.val(account.info.ccountry||"United States");for(n=0;n<e.years.length;n++){s.append("<option>"+e.years[n]+"</option>")}if(account.info.ccexpiration){var r=account.info.ccexpiration.split("/");if(r.length==2){s.val(r[1]);t.find(".cardMonth").val(r[0])}}});t.find("input:radio[name=auth]").click(function(){if(this.id=="authmd"){t.find(".email").removeAttr("disabled");t.find("div.account-pwd").slideDown();r()}else{t.find("div.account-pwd").slideUp();if(account.loggedIn()&&account.info.authmode=="Facebook"){t.find(".email").attr("disabled",true)}else{account.loginout()}}});t.find("input:radio[name=account-level]").click(function(){if(this.id=="account-lvl-admin"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp();if(this.id=="account-lvl-admin"||this.id=="account-lvl-ind"){t.find(".payments").slideDown();r()}else t.find(".payments").slideUp();if(this.id=="account-lvl-member"){if(n){t.find("div.valcode").slideDown()}else{t.find("div.regcode").slideDown()}if(!s&&!n){Ua("No corporate account available","Our records do not show a corporate membership available to the email entered above.  Please contact the administrator of your organization's MashableData account to be added.")}r()}else{t.find("div.regcode,div.valcode").slideUp()}});t.find("input:radio[name=account-auth]").click(function(){if(this.id=="account-org-create"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp()});t.find("button.ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e="";if(t.find("input.uname").val().trim().length<5)e+="<li>Your display name must be least 5 characters</li>";if(!account.isValidEmail(t.find("input.email").val().trim()))e+="<li>Your main email is not a valid email address</li>";if(!t.find("input[name=auth]:checked"))e+="<li>Please indicate how you wish to be authenticated</li>";if(t.find("input[name=auth]:checked").val()=="md"&&(t.find(".pwd").val().trim().length<8||t.find(".pwd").val().trim()!=t.find(".pwdConfirm").val().trim())){e+="<li>Your passwords must match and be at 8 characters long</li>";t.find(".pwd").val("");t.find(".pwdConfirm").val("")}var a=t.find("input[name=account-level]:checked").val();if(!a)e+="<li>You must select a subscription level</li>";if(a=="admin"&&!t.find("input[name=account-join]:checked").val())e+="<li>You must indicate how users will be allowed to join your organization.</li>";if(a=="admin"||a=="indiv"){}if(e.length>0){Ua("Invalid responses","The following problems were detected:<br><ol>"+e+"</ol>Please correct these issues and resubmit.")}else{var i={command:"Subscribe",name:t.find("input.uname").val().trim(),email:t.find("input.email").val().trim(),auth:t.find("input[name=auth]:checked").val(),pwd:t.find("input.pwd").val().trim(),fbemail:t.find("input[name=account-fb]:checked").val()=="fbdiff"?t.find("input#account-fbemail").val().trim():t.find("input.email").val().trim(),twitemail:t.find("input[name=account-twit]:checked").val()=="twitdiff"?t.find("input#account-twitemail").val().trim():t.find("input.email").val().trim(),accountLevel:a,regCode:t.find("input.regcode").val(),accountJoinMode:t.find("input[name=account-join]:checked").val(),cardNum:t.find("input.cardNum").val(),cardMonth:t.find("input.cardMonth").val(),cardYear:t.find("input.cardYear").val(),cardCCV:t.find("input.cardCCV").val(),cardName:t.find("input.cardName").val(),cardAddress:t.find("input.cardAddress").val(),cardCity:t.find("input.cardCity").val(),cardStateProv:t.find("input.cardStateProv").val(),cardPostal:t.find("input.cardPostal").val(),cardCountry:t.find("input.cardCountry").val()};bi(i,function(e,t,a){if(e.status=="OK"){$.fancybox().close();account.info.name=i.name;account.info.email=i.email;account.info.fbemail=i.fbemail}Ua("Account and subscription managment",oRetrun.msg)})}});function r(){e.animate({top:50})}},isValidEmail:function(e){return e.split("@").length==2&&e.split("@")[1].split(".").length>0&&!/[\s]/.test(e)},showVerify:function(e){account.showPanel(account.htmls.verify);var t=$("#verify-email");t.find("span.email").html(e);t.find(".cancel").button({icons:{secondary:"ui-icon-closethick"}}).addClass("ui-state-error").click(function(){account.showSubscribe()});t.find(".cancel").button({icons:{secondary:"ui-icon-check"}}).click(function(){account.verified(e,t.find("input.email").val())})},signIn:function(e,t,a){},signInFB:function(e){if(e.authResponse){account.info.authmode="Facebook";var t=e.authResponse.accessToken;expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){account.info.fbid=e.id;account.fb_user=e;account.fb_user.accessToken=t;account.info.accesstoken=t;account.info.name=e.name;account.info.email=e.email;Ka()});$.fancybox.close()}},subscribe:function(e,t){},signOut:function(){FB.logout(function(e){localStorage.removeItem("token");localStorage.removeItem("mdtoken");window.location.reload()})},loginout:function(){if(account.loggedIn()){account.signOut()}else{FB.login(function(e){if(e.authResponse){loggedIn="facebook";accessToken=e.authResponse.accessToken;localStorage.setItem("fbtoken",accessToken);expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){fb_user=e;Ka()})}})}},loggedIn:function(){return this.info.userId!=null},sendVerificationCode:function(e){bi({command:"EmailVerify",email:e,verification:"x"},function(t,a,i){Ua("email verification code","A verification code was sent to "+e+".  Please check this email account and enter the code where directed. ")})}};var e=.5;var t=["aaaaaa","ffaaaa","aaffaa","aaaaff"];var i=[];function n(n,s){var o={panelId:n,$panel:$("#"+n),bandNo:0,lineNo:0,banding:false,bandStartPoint:void 0,standards:i,makeDirty:s,addStandard:function l(e){var t=this;bi({command:"GetAnnotation",annoid:e},function(e){standardAnno=jQuery.parseJSON(e.annotation);for(var a=0;a<standardAnno.length;a++){Qt[n].annotations.push(standardAnno[a])}t.build("new")})},fetchStandards:function(){if(i.length==0){var e=this;bi({command:"GetAnnotations"},function(t){for(var a=0;a<t.annotations.length;a++)i.push(t.annotations[a]);e.standards=i})}else{this.standards=i}},sync:function d(){var e=Qt[this.panelId].controls.chart;var t=e.options.xAxis,a=t.plotLines=[],i=t.plotBands=[];var n;for(var s=0;s<e.xAxis[0].plotLinesAndBands.length;s++){n=e.xAxis[0].plotLinesAndBands[s];if(n.id.substr(0,1)=="xb"){i.push(n.options)}else{a.push(n.options)}}},addPoint:function c(e){var t=Qt[n];if(typeof e!="undefined"){var a;for(var i=0;i<t.annotations.length;i++){if(t.annotations[i].type=="point"){a=t.controls.chart.get(t.annotations[i].id);if(a){a.update([a.x,a.y],false)}delete t.annotations[i].id}}t.annotations.push({type:"point",text:"",id:null,series:e.series.options.id,color:"#000000",from:gt(e.x,e.series.options.period)});this.build("point")}},addXLine:function p(e){var a=Qt[n];a.controls.chart.xAxis[0].addPlotLine({value:e.x,color:"#"+t[0],id:"xl"+this.lineNo,width:2,label:{text:" ",y:0,zIndex:3}});a.annotations.push({type:"line",text:"",id:"xl"+this.lineNo,color:t[0],from:gt(e.x,e.series.options.period)});this.lineNo++;this.build("table-only")},startXBand:function u(a){var i=Qt[n];this.bandStartPoint=a;this.bandColor=m(t[0],e);i.controls.chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.bandStartPoint.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});this.banding="x-Time";a.select(true)},build:function h(t){var a,i,s=this,o=$("#"+n+" div.annotations").show().find("table");if(o.html().length!=0){$("div#"+n+" .graph-save").button("enable");Qt[n].isDirty=true}if(!t)t="all";var r=Qt[n];var l="";var d="A";var c,p,u,h,f,g,b;var v={};for(c=0;c<r.controls.chart.yAxis.length;c++){v["labelsY-"+c]=[]}r.annotations.sort(function(e,t){if(e.type.charAt(0)=="h"&&e.type.charAt(0)=="h")return t.from-e.from;if(e.type.charAt(0)=="h")return-1;if(t.type.charAt(0)=="h")return 1;return s.parseDate(e.from)-s.parseDate(t.from)});for(c=0;c<r.annotations.length;c++){console.time("annotation loop");p=r.annotations[c];switch(p.type){case"point":if(t=="point"||t=="all"){h=r.controls.chart.get(p.series);if(h==null){r.annotations.splice(c,1);c--;break}f=r.controls.chart.get("labelsY-"+h.options.yAxis);for(var y=0;y<h.data.length;y++){if(h.data[y]){if(h.data[y].x==this.parseDate(p.from)){u=h.data[y];v["labelsY-"+h.options.yAxis].push({x:u.x,y:u.y,id:d,marker:{fillColor:p.color,lineColor:p.color,radius:8,symbol:"circle",enabled:true,states:{hover:{enabled:true,marker:{enabled:true,fillColor:p.color,lineColor:p.color,radius:8}}}}})}}}p.id=d}l+='<tr data="'+d+'"><td align="center"><b>'+d+"</b></td><td>"+p.from+'</td><td><input class="anno-text" type="text" value="'+p.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';d=String.fromCharCode(d.charCodeAt(0)+1);break;case"line":g=this.parseDate(p.from);if(g>=parseInt(r.start||r.firstdt)&&g<=parseInt(r.end||r.lastdt)){if(t=="line"||t=="all"||t=="new"&&!p.id){p.id="xl"+this.lineNo;this.lineNo++;i=this.labelOffset(r.controls.chart,p);r.controls.chart.xAxis[0].addPlotLine({color:p.color,value:this.parseDate(p.from),id:p.id,width:2,label:{text:p.text,y:i,zIndex:3}})}l+='<tr data="'+p.id+'"><td><input class="annotation-color-picker" type="text" value="'+p.color+'" /></td><td>'+p.from+'</td><td><input class="anno-text" type="text" value="'+p.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hline":if(t=="hline"||t=="all"||t=="new"&&!p.id){p.id="hl"+this.lineNo;this.lineNo++;for(a=0;a<r.controls.chart.yAxis.length;a++){if(r.controls.chart.yAxis[a].userOptions.title.text==p.yAxis){r.controls.chart.yAxis[a].addPlotLine({color:p.color,value:p.from,id:p.id,width:2,label:{text:p.text,zIndex:3}})}}}l+='<tr data="'+p.id+'"><td><input class="annotation-color-picker" type="text" value="'+p.color+'" /></td><td>'+p.from+" "+p.yAxis+'</td><td><input class="anno-text" type="text" value="'+p.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break;case"band":g=this.parseDate(p.from);b=this.parseDate(p.to);if(g>=parseInt(r.start||r.firstdt)&&g<=parseInt(r.end||r.lastdt)||b>=parseInt(r.start||r.firstdt)&&b<=parseInt(r.to||r.lastdt)){if(t=="band"||t=="all"||t=="new"&&!p.id){p.id="xb"+this.bandNo++;i=this.labelOffset(r.controls.chart,p);r.controls.chart.xAxis[0].addPlotBand({color:m(p.color,e),from:g,to:b,id:p.id,label:{text:p.text,y:i,zIndex:3}})}l+='<tr data="'+p.id+'"><td><input class="annotation-color-picker" type="text" value="'+p.color+'" /></td><td>'+p.from+"-"+p.to+'</td><td><input class="anno-text" type="text" value="'+p.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hband":if(t=="hband"||t=="all"||t=="new"&&!p.id){p.id="hb"+this.bandNo++;for(a=0;a<r.controls.chart.yAxis.length;a++){if(r.controls.chart.yAxis[a].userOptions.title.text==p.yAxis){r.controls.chart.yAxis[a].addPlotBand({color:m(p.color,e),from:p.from,to:p.to,id:p.id,label:{text:p.text,zIndex:3}})}}}l+='<tr data="'+p.id+'"><td><input class="annotation-color-picker" type="text" value="'+p.color+'" /></td><td>'+p.from+"-"+p.to+" "+p.yAxis+'</td><td><input class="anno-text" type="text" value="'+p.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break}console.timeEnd("annotation loop")}console.time("annotation redraw");if(t=="point"||t=="all"){for(var k in v){r.controls.chart.get(k).setData(v[k],false)}r.controls.chart.redraw()}console.timeEnd("annotation redraw");console.time("annotation rest");if(r.annotations.length==0)l+='<tr><td colspan="3" class="grey-italics">right-click on the chart to annotate a point, band, or event, or to perform a linear regression or average</td></tr>';o.html(l).find("input, select").change(function(){s.change(this)});o.find(".annotation-color-picker").colorPicker();o.find(".ui-icon-trash").click(function(){s["delete"](this)});console.timeEnd("annotation rest")},change:function f(t){var a,i,s,o=$(t).closest("tr").attr("data");this.$panel.find(".graph-save").button("enable");var r=Qt[n];var l;for(a=0;a<r.annotations.length;a++){if(o==r.annotations[a].id){l=r.annotations[a];break}}l.text=$(t).closest("tr").find("input.anno-text").val();l.color=$(t).closest("tr").find(".annotation-color-picker").val();switch(o.substr(0,2)){case"xb":i=this.labelOffset(r.controls.chart,l);r.controls.chart.xAxis[0].removePlotBand(o);r.controls.chart.xAxis[0].addPlotBand({color:m(l.color,e),from:this.parseDate(l.from),to:this.parseDate(l.to),id:l.id,label:{text:l.text,y:i,zIndex:3}});break;case"hb":for(a=0;a<r.controls.chart.yAxis.length;a++){if(r.controls.chart.yAxis[a].userOptions.title.text=l.yAxis){r.controls.chart.yAxis[a].removePlotBand(o);r.controls.chart.yAxis[a].addPlotBand({color:m(l.color,e),from:parseFloat(l.from),to:parseFloat(l.to),id:l.id,label:{text:l.text,zIndex:3}})}}break;case"hl":for(a=0;a<r.controls.chart.yAxis.length;a++){if(r.controls.chart.yAxis[a].userOptions.title.text=l.yAxis){r.controls.chart.yAxis[a].removePlotLine(o);r.controls.chart.yAxis[a].addPlotLine({color:l.color,value:parseFloat(l.from),id:l.id,width:2,label:{text:l.text,zIndex:3}})}}break;case"xl":i=this.labelOffset(r.controls.chart,l);r.controls.chart.xAxis[0].removePlotLine(o);r.controls.chart.xAxis[0].addPlotLine({color:l.color,value:this.parseDate(l.from),id:l.id,width:2,label:{text:l.text,y:i,zIndex:3}})}},"delete":function v(e){var t=$(e).closest("tr").attr("data");var i=Qt[n];for(var s=0;s<i.annotations.length;s++){if(t==i.annotations[s].id){i.annotations.splice(s,1);break}}if(t[1]=="b"||t[1]=="l"){for(a=0;a<i.controls.chart.axes.length;a++){i.controls.chart.axes[a].removePlotLine(t);i.controls.chart.axes[a].removePlotBand(t)}this.build("none")}else{this.build("point")}},startAnalysisBanding:function(e,t){var a=e.series.color;var i=Qt[n].controls.chart;r=parseInt(a.substr(1,2),16);g=parseInt(a.substr(3,2),16);b=parseInt(a.substr(5,2),16);this.bandColor="rgba("+r+","+g+","+b+",0.5)";this.banding=t+"-"+e.series.index;this.bandStartPoint=e;i.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:e.x,color:this.bandColor,id:t+this.bandNo++,label:{text:" ",y:0,zIndex:3}})},deleteAnalysis:function(e){var t,a,i,s,o=e.series.options.calculatedFrom;var r=e.series.options.id.substr(0,2);if(o){t=e.series.data[0][0];a=e.series.data[e.series.data.length-1][0];e.series.remove();switch(r){case"LR":s=Qt[n].plots[parseInt(o.substr(1))].options.linRegressions;break;case"AV":s=Qt[n].plots[parseInt(o.substr(1))].options.averages;break}this.makeDirty();for(i=0;i<s.length;i++){if(s[i][0]==a&&s[i][1]==t){s.splice(i,1);return true}}return false}},parseDate:function y(e){if(e.length==4){e="1 Jan "+e+" UTC"}else if(e.length==8){e="1 "+e+" UTC"}else{e+=" UTC"}return Date.parse(e)},labelOffset:function k(e,t){var a=10;var i=20;var n=.2;if(t.text==" "||t.text==" ")return 0;var s=e.xAxis[0].plotLinesAndBands;var o=e.xAxis[0].getExtremes();var r=(o.max-o.min)*n;var l;var d=[];if(t.to){l=(this.parseDate(t.from)+this.parseDate(t.to))/2}else{l=this.parseDate(t.from)}var c=0,p;for(var u=0;u<s.length;u++){if(s[u].id!="timeLine"){if(s[u].options.to){p=(s[u].options.from+s[u].options.to)/2}else{p=s[u].options.from}if(s[u].options.label.text.length>0&&Math.abs(p-l)<r){c++;d.push(s[u])}}}var h=a;for(var f=0;f<d.length;f++){if(d[f].options.label.y==h){h+=i;f=-1}}return h},mouseOverHCPoint:function w(e,t){var a=Qt[n].controls.chart;if(!this.banding)return;if(this.banding=="x-Time"){try{a.xAxis[0].removePlotBand("xb"+this.bandNo)}catch(i){}a.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:t.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});return}if(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-"){var s=this.banding.substr(0,2);try{a.xAxis[0].removePlotBand(s+this.bandNo)}catch(i){}this.endingX=L(t.x,this.bandStartPoint.series.data);a.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.endingX,color:this.bandColor,id:s+this.bandNo,label:{text:" ",y:0,zIndex:3}})}},endBanding:function x(a){var i,s,o;var r=this.mouseoverPoint;var l=typeof this.mouseoverPoint!="undefined";var d=Qt[n];var c=this;if(this.banding=="x-Time"){if(l){var p,u;p=gt(this.bandStartPoint.x,this.bandStartPoint.series.options.period);u=gt(r.x,r.series.options.period);this.banding=false;d.annotations.push({type:"band",text:"",id:"xb"+this.bandNo,color:"#"+t[0],from:p<u?p:u,to:p<u?u:p});this.build("table-only");return false}else{return{items:{info:{name:"Mouse-over a series before right-clicking to terminate a vertical band.",callback:function(e,t){}}}}}}if(this.banding&&(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-")){var h=this.banding.substr(0,2);d.controls.chart.xAxis[0].removePlotBand(h+this.bandNo);var f=Math.min(this.bandStartPoint.x,this.endingX);var g=Math.max(this.bandStartPoint.x,this.endingX);if(f<g){switch(h){case"LR":this.plotLinearRegression(this.bandStartPoint.series,f,g,true);var b=d.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!b.linRegressions)b.linRegressions=[];b.linRegressions.push([f,g]);break;case"AV":this.plotAverage(this.bandStartPoint.series,f,g,true);var b=d.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!b.averages)b.averages=[];b.averages.push([f,g]);break}c.makeDirty()}else{Ua("Error","The starting point and ending points must be different.")}this.banding=false;return}else{var v,y,k,w,x,C=d.controls.chart;for(x=0;x<C.yAxis.length;x++){i=C.yAxis[x].userOptions.title.text;if(this.banding=="y-"+i){v=$(C.container).offset().top;y=$(C.container).offset().left;k=(E?a.originalEvent.x:a.clientX-y)-C.plotLeft;w=(E?a.originalEvent.y:a.pageY-v)-C.plotTop;if(w>=0&&w<=C.plotSizeY){s=parseFloat(parseFloat(C.yAxis[x].translate(C.plotHeight-w,true).toPrecision(2)));return{items:{axis:{name:"<b>"+i+":</b>",type:"text",value:s},ok:{name:"<button>ok</button>",callback:function(a,n){o=$.contextMenu.getInputValues(n)["axis"];for(var s=0;s<C.yAxis.length;s++){if(C.yAxis[s].userOptions.title.text=c.banding.substr(2)){C.yAxis[s].removePlotBand("hb"+c.bandNo);var r,l;r=parseFloat(c.bandStartPoint);l=parseFloat(o);C.yAxis[s].removePlotBand("hb"+c.bandNo);C.yAxis[s].addPlotBand({id:"hb"+c.bandNo,color:m(t[0],e),from:Math.min(r,l),to:Math.max(r,l),label:{text:"",zIndex:3}});d.annotations.push({id:"hb"+c.bandNo,type:"hband",yAxis:i,text:"",color:"#"+t[0],from:Math.min(c.bandStartPoint,o),to:Math.max(c.bandStartPoint,o)});c.build("table-only");c.banding=false;c.makeDirty();break}}}},cancel:{name:"<button>cancel</button>",callback:function(e,t){for(x=0;x<C.yAxis.length;x++){C.yAxis[x].removePlotBand("hb"+c.bandNo);c.banding=false}}}}}}else{return false}}}}},plotAnnotationSeries:function(){var e,t,a,i;var s=Qt[n];var o=s.controls.chart;var r=s.start||(s.intervals?N(s):s.firstdt);if(s.plots&&s.plots.length>0){for(e=0;e<s.plots.length;e++){if(s.plots[e].options.linRegressions){for(t=0;t<s.plots[e].options.linRegressions.length;t++){a=s.plots[e].options.linRegressions[t];if(a[0]>=r&&a[0]<=parseInt(s.end||s.lastdt)&&(a[1]>=r&&a[1]<=parseInt(s.to||s.lastdt))){this.plotLinearRegression(o.get("P"+e),a[0],a[1])}}}if(s.plots[e].options.averages){for(t=0;t<s.plots[e].options.averages.length;t++){i=s.plots[e].options.averages[t];if(i[0]>=r&&i[0]<=parseInt(s.end||s.lastdt)&&(i[1]>=r&&i[1]<=parseInt(s.to||s.lastdt))){this.plotAverage(o.get("P"+e),i[0],i[1])}}}}}o.redraw()},plotLinearRegression:function(e,t,a,i){if(!i)i=false;var s=Qt[n].controls.chart;var o=0,r=null,l=null;var d=0,c=null,p=null;var u,h=[],f=0;if(typeof t=="undefined"||typeof a=="undefined"){h=e.data}else{for(u=0;u<e.data.length;u++){if(e.data[u].x>=t&&e.data[u].x<=a){h.push(e.data[u])}}}for(u=0;u<h.length;u++){if(h[u].x!=null&&h[u].y!=null){o+=h[u].x;d+=h[u].y;if(r==null){r=h[u].x}if(l==null){l=h[u].x}if(c==null){c=h[u].y}if(p==null){p=h[u].y}if(r>h[u].x){r=h[u].x}if(l<h[u].x){l=h[u].x}if(c>h[u].y){c=h[u].y}if(p<h[u].y){p=h[u].y}f++}}var m=o/f;var g=d/f;var b=0;var v=0;for(u=0;u<h.length;u++){if(h[u].x!=null&&h[u].y!=null){b+=(h[u].x-m)*(h[u].y-g);v+=(h[u].x-m)*(h[u].x-m)}}var y=b/v;var k=g-y*m;var w=y*S.value[e.options.period];var x=w.toString().search(/[1-9]/);var C=w.toString().indexOf(".");var M={name:"Linear regression of "+e.name+"<BR> (m="+Highcharts.numberFormat(w,C>5||C==-1?0:x+5-C)+" per "+S.units[e.options.period]+")",dashStyle:"LongDash",period:e.options.period,lineWidth:1,color:e.color,data:[],id:"LR"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(u=0;u<h.length;u++){if(h[u].x!=null&&h[u].y!=null){M.data.push([h[u].x,y*h[u].x+k])}}return s.addSeries(M,i)},plotAverage:function(e,t,a,i){if(!i)i=false;var s=Qt[n].controls.chart;var o=0,r=0;var l,d=[],c=0;if(typeof t=="undefined"||typeof a=="undefined"){d=e.data}else{for(l=0;l<e.data.length;l++){if(e.data[l].x>=t&&e.data[l].x<=a){d.push(e.data[l]);if(e.data[l].y!==null){o+=e.data[l].y;r++}}}}var p=o/r;var u={name:"Average of "+e.name,dashStyle:"ShortDash",period:e.options.period,lineWidth:1,color:e.color,data:[],id:"AV"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(l=0;l<d.length;l++){u.data.push([d[l].x,p])}return s.addSeries(u,i)}};o.fetchStandards();return o}function s(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)";var a=new RegExp(t);var i=a.exec(window.location.search);if(i==null)return"";else return decodeURIComponent(i[1].replace(/\+/g," "))}function o(e){e=e.toString(16);return(e.length==1?0:"")+e}function l(e){var t,a=[];if(typeof e.data=="string"){return e.data}else{for(t=0;t<e.data.length;t++){a.push(d(e.data[t][0],e.period)+"|"+(isNaN(e.data[t][1])||e.data[t][1]===null?"null":e.data[t][1]))}return a.join("||")}}function d(e,t){var a=new Date(parseInt(e));var i=a.getUTCFullYear();switch(t){case"M":i+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();break;case"Q":i+="Q"+parseInt((a.getUTCMonth()+3)/3);break;case"SA":i+="H"+parseInt((a.getUTCMonth()+6)/6);
break;case"W":case"D":i+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();i+=(a.getUTCDate().toString().length==1?"0":"")+a.getUTCDate();break}return i}function c(e){var t;t=new Date("1/1/"+e.substr(0,4)+" UTC");if(e.length>4){switch(e.substr(4,1)){case"Q":t.period="Q";t.setUTCMonth((e.substr(5,1)-1)*3);break;case"H":t.period="H";t.setUTCMonth((e.substr(5,1)-1)*6);break;default:t.period="M";t.setUTCMonth(e.substr(4,2))}if(e.length>6){t.period="D";t.setUTCDate(e.substr(6,2));if(e.length>8){t.setUTCHours(e.substr(9,2));t.setUTCMinutes(e.substr(12,2));t.setUTCSeconds(e.substr(15,2))}}}else{t.period="A"}t.s=e;return t}Date.prototype.toMDDateString=function(e){var t=e||this.period;if(!t)throw"no period found";var a=this.getUTCFullYear();switch(e){case"M":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();break;case"Q":a+="Q"+parseInt((this.getUTCMonth()+3)/3);break;case"SA":a+="H"+parseInt((this.getUTCMonth()+6)/6);break;case"W":case"D":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();a+=(this.getUTCDate().toString().length==1?"0":"")+this.getUTCDate();break}return a};if(!("pushUnique"in Array.prototype)){Array.prototype.pushUnique=function(e){if(this.indexOf(e)===-1){return this.push(e)}else{return false}}}function p(e,t,a){if(t&&typeof t!="object")t=new Date(parseInt(t));if(a&&typeof a!="object")a=new Date(parseInt(a));var i="",n;var s=24*60*60*1e3;var o=new Date;switch(e.toUpperCase()){case"DAYSPERMONTH":if(a){a=new Date(a.getUTCFullYear()+"-"+(a.getUTCMonth()+1)+"-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-12-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-01 UTC")}else{t=new Date(a.getTime());t.setUTCMonth(t.getUTCMonth()-119)}while(t<=a){i+=(i?"||":"")+d(t.getTime(),"M")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCMonth(t.getUTCMonth()+1))/s)}break;case"DAYSPERQUARTER":if(a){a=new Date(a.getUTCFullYear()+"-"+(a.getUTCMonth()+3)+"-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-12-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-"+(t.getUTCMonth()+3)+"-01 UTC")}else{t=new Date(a.getTime());t.setUTCMonth(t.getUTCMonth()-119)}while(t<=a){i+=(i?"||":"")+d(t.getTime(),"Q")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCMonth(t.getUTCMonth()+3))/s)}break;case"DAYSPERYEAR":a=a||new Date(o.getUTCFullYear()+"-01-01 UTC");if(a){a=new Date(a.getUTCFullYear()+"-01-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-01-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-01-01 UTC")}else{t=new Date(a.getUTCFullYear()-20+"-01-01 UTC")}while(t<=a){i+=(i?"||":"")+d(t.getTime(),"A")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCFullYear(t.getUTCFullYear()+1))/S.value.D)}break}return i}function u(e,t,a,i){var n,s;var o='<div id="downshiftWizard" style="width:600px;">'+"<h4>Frequency Shifting:</h4>";if(t)o+="You have selected to have the plot recalculated as <b></b>"+S.name[t]+"</b>.  Please select the method and treatment of missing and null values.<br>";else o+="You have requested to mash series with different frequencies.  This will require first recalculating the series data having a shorter reporting period to a common longer period.  Please confirm by selecting the algorithm and the treatment of missing and null values.<br>";o+="<br>Component series that must be recalculated:"+"<ol>";for(n=0;n<a.components.length;n++){s=e.assets[a.components[n].handle];o+="<li><b>"+s.name+"</b> ("+s.units+") "+S.name[t=="A"&&s.freqset.Q?"Q":"M"]+"</li>"}o+="</ol>"+"<br>Each component series will be individual recalculated as needed to the new frequency by:<br>"+'<label><input type="radio" name="dsw_algor" value="sum"> simple summation</label><br>'+'<label><input type="radio" name="dsw_algor" value="wavg"> day-weighted average</label><br>'+"<br>If some of the values used to calculate a new datum point are are null or missing (e.g. a month is missing when calulating an annual value):<br>"+'<label><input type="radio" name="dsw_missing" value="null"> the computed value for the datum will be null (i.e. all sub-values are required)</label><br>'+'<label><input type="radio" name="dsw_missing" value="zero"> treat as if the value were zero</label><br>'+'<label><input type="radio" name="dsw_missing" value="impute"> estimate value to be the day-weighted average of new period\'s existing component values if at least three-quarters of the component values exist</label><br>'+'<span class="ui-state-error warning-box"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span>WARNING: Change frequencies and use estimates with care.  Summations produce valid results for monthly production quantities, whereas day-weighted averages are statistically correct for rates where the implied denominator is constant.<br><br>For more information, see <a href="/workbench-help/changing-frequency/" traget="_blank" class="link">changing frequencies help</a>.</span>'+'<button id="dsw_ok" class="right">OK</button> <button id="dsw_cancel" class="right">cancel</button>'+"</div>";$.fancybox(o,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var r=$("#downshiftWizard");$("#dsw_ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e={algorithm:r.find("input:radio[name='dsw_algor']:checked").val(),missing:r.find("input:radio[name='dsw_missing']:checked").val()};if(e.algorithm&&e.missing){i(e);$.fancybox.close()}else{Ua("error","All form selections are required.")}});$("#dsw_cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close();i(false)})}function h(e,t,a,i){if(S.value[t]==S.value[e.period])return e.data;if(S.value[t]<S.value[e.period]||t!="A"&&t!="Q"||S.value[e.period]<S.value["M"])throw"unable to change data frequency from "+S.name[e.period]+" to "+S.name[t];var n=e.data.split("||"),s=[],o=[],r=t=="Q"?3:12,l=e.period=="M"?1:3,p=false,u,h,f;for(var m=0;m<n.length;m++){h=n[m].split("|");f=c(h[0]);if(p===false||f.getUTCMonth()-p.getUTCMonth()>r-1||f.getUTCFullYear()!=p.getUTCFullYear()){if(o.length!=0){s.push(g());o=[]}p=new Date(f.getUTCFullYear()+"-"+(Math.floor(f.getUTCMonth()/r)*r+1)+"-1 UTC")}o[f.getUTCMonth()]=h[1]}if(o.length!=0)s.push(g());return s;function g(){var e,n=0,s=0,c=0,h=0;u=d(p.getTime(),t);var f=p.getUTCMonth();for(var m=f;m<f+r;m=m+l){e=-Math.round(p.getTime()-p.setUTCMonth(p.getUTCMonth()+l)/S.value.D);if(typeof o[m]=="undefined"||o[m]===null){if(i=="null"){return u+"|null"}o[m]=0;if(i=="impute"){c++;s+=e;n-=e}}switch(a){case"wavg":h+=parseFloat(o[m])*e;n+=e;break;case"sum":h+=parseFloat(o[m]);break;default:throw"unrecognized down frequency conversion algorithm"}}if(s!=0&&h!="null")h=h*(n+s)/n;return u+"|"+(a=="wavg"?h/n:h)}}function f(e){if(Math.log(Math.abs(e))>-13)return Math.round(e*Math.pow(10,10))/Math.pow(10,10);else return e}function m(e,t){var a,i,n;if(e.substr(0,1)=="#")e=e.substr(1);a=s(parseInt(e.substr(0,2),16),t);i=s(parseInt(e.substr(2,2),16),t);n=s(parseInt(e.substr(4,2),16),t);if(a>0&&i>0&&n>0){return"rgba("+a+","+i+","+n+","+t+")"}else{return"rgb("+parseInt(e.substr(0,2),16)+","+parseInt(e.substr(2,2),16)+","+parseInt(e.substr(4,2),16)+")"}function s(e,t){return parseInt(e/t-(1-t)*255/t)}}function v(e,t){var a=e.slice(0);a.sort(function(e,t){return e[0]-t[0]});var i=[];if(a.length>0)i.push([a[0][0],a[0][1]]);var n;switch(t){case"T":case"N":case"D":case"W":maxInterval=Date.UTC(2e3,0,9)-Date.UTC(2e3,0,1);break;case"M":maxInterval=Date.UTC(2e3,1,2)-Date.UTC(2e3,0,1);break;case"SA":maxInterval=Date.UTC(2e3,7,2)-Date.UTC(2e3,0,1);break;default:maxInterval=Date.UTC(2001,2)-Date.UTC(2e3,1)}for(var s=1;s<a.length;s++){if(a[s-1][1]!=null&&a[s][1]!=null&&a[s][0]-a[s-1][0]>maxInterval){var o=new Date(a[s][0]);switch(t){case"d":case"w":o.setDate(o.getDate()+7);break;case"4":o.setDate(o.getDate()+28);break;case"m":o.setMonth(o.getMonth()+1);break;default:o.setMonth(o.getMonth()+12)}a.splice(s,0,[parseInt(o),null]);s++}}return a}var y={POS:"#0071A4",NEG:"#FF0000",MID:"#E5E5E5"};var k=30;var w=10;var x=["#2f7ed8","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92","#0d233a"];var C=["#008000","#FF0000","#0000FF","#FFFF00","#FF9900","#00FFFF","#FF0000"];var M=["Solid","Short Dash","Short Dot","Short Dash Dot","Short Dash Dot Dot","Dot","Dash","Long Dash","Dash Dot","Long Dash Dot","Long Dash Dot Dot"];var S={value:{N:1e3,D:24*3600*1e3,W:7*24*3600*1e3,M:30*24*3600*1e3,Q:365/4*24*3600*1e3,SA:365/2*24*3600*1e3,A:365*24*3600*1e3},order:["N","D","W","M","Q","SA","A"],name:{N:"non period data",D:"daily",W:"weekly",M:"monthly",Q:"quarterly",SA:"semiannual",A:"annual"},units:{N:"non-periodic data",D:"day",W:"week",M:"month",Q:"quarter",SA:"half-year",A:"year"}};var D={value:{"+":1,"-":2,"*":3,"/":4},cssClass:{"+":"op-addition","-":"op-subtraction","*":"op-multiply","/":"op-divide"}};var T="#AAAAAA";var A={name:0,units:1,source:2,notes:3,region:4,lat_lon:5,date:6,dataStart:7};var I=/[SUL]/;var U=/[MXSU]\d+/g;var P=/(\b[A-Z]{1,2}\b)/g;var F="http://www.w3.org/2000/svg";var E=/msie/i.test(navigator.userAgent)&&!window.opera;if(typeof console=="undefined")console={info:function(e){},log:function(e){}};function O(a,i){console.time("chartPanel");var n=typeof a=="string"?a:$(a).closest("div.graph-panel").get(0).id;var s=Qt[n];if(s.controls&&s.controls.chart){s.controls.chart.destroy();$.contextMenu("destroy","#"+n+" div.chart")}var o;console.time("makeChartOptionsObject");var r=B(Qt[n]);console.timeEnd("makeChartOptionsObject");var l=$("#"+n+" div.chart");if(r.series.length==0){l.hide();return void 0}l.show();r.chart.renderTo=l.get(0);r.plotOptions.series.point={events:{mouseOver:function(e){i.mouseoverPoint=this;i.mouseOverHCPoint(e,this)},mouseOut:function(e){delete i.mouseoverPoint},click:function(e){if(i.banding){i.endBanding(e)}else{d(this.x)}}}};r.chart.events={click:function(e){if(i.banding){i.endBanding(e)}else{d(e.xAxis[0].value)}},selection:function(e){var t;var a;if(e.resetSelection){if(o.cropButton)o.cropButton=o.cropButton.destroy();s.minZoom=s.start===null?s.firstdt:s.start;s.maxZoom=s.end===null?s.lastdt:s.end}else{var i=$.extend(true,{},o.options.chart.resetZoomButton);i.position.y+=30;var l={x:o.plotLeft,y:o.plotTop,width:o.plotWidth,height:o.plotHeight};o.cropButton=o.renderer.button("Crop X-axis",null,null,function(){$("#"+n+" button.graph-crop").click()},{zIndex:20},null).attr({align:"right"}).attr({align:i.position.align,title:"Crop x-axis to current zoom level"}).add().align(i.position,false,l);var d=e.xAxis[0].min;var c=e.xAxis[0].max;for(var p=0;p<r.series.length;p++){var u=r.series[p].data;t=L(d,u,t);a=L(c,u,a)}s.minZoom=t;s.maxZoom=a}}};console.time("highcharts");o=new Highcharts.Chart(r);if(s.controls)s.controls.chart=o;console.timeEnd("highcharts");i.plotAnnotationSeries();l.mouseover(function(a){if(i.banding){if(i.banding.substr(0,2)=="y-"){var n=$(o.container).offset().top,s=$(o.container).offset().left;var r=(E?a.originalEvent.x:a.clientX-s)-o.plotLeft,l=(E?a.originalEvent.y:a.pageY-n)-o.plotTop;if(l>=0&&l<=o.plotSizeY){for(var d=0;d<o.yAxis.length;d++){if(o.yAxis[d].userOptions.title.text==i.banding.substr(2)){var c=o.yAxis[d].translate(o.plotHeight-l,true);o.yAxis[d].removePlotBand("hb"+i.bandNo);o.yAxis[d].addPlotBand({id:"hb"+i.bandNo,color:m(t[0],e),from:parseFloat(i.bandStartPoint),to:c,label:{text:"",zIndex:3}})}}}}}}).keydown(function(e){if(i.banding&&e){for(var t=0;t<o.axes.length;t++){o.axes[t].removePlotLine(i.banding);o.axes[t].removePlotBand(i.banding)}i.banding=false}});console.time("contextMenu");$.contextMenu({selector:"#"+n+" div.chart",build:function(a,n){var r,l,d,c,p;var u,h,f,g;var b=i.mouseoverPoint;var v=typeof i.mouseoverPoint!="undefined";if(i.banding){return i.endBanding(n)}else{var y={items:{point:{name:"annotate point",disabled:!v,callback:function(e,t){i.addPoint(b)}},sep0:"---------",vline:{name:"add vertical line",disabled:!v,callback:function(e,t){i.addXLine(b)}},vband:{name:"start vertical band",disabled:!v,callback:function(e,t){i.startXBand(b)}},sep1:"---------",hline:{name:"add horizontal line",items:{}},hband:{name:"start horizontal band",items:{}},sep2:"---------",avg:{name:"start average",disabled:!v,callback:function(e,t){if(!g){i.startAnalysisBanding(b,"AV")}else{i.deleteAnalysis(b)}}},regression:{name:"start linear regression",disabled:!v,callback:function(e,t){if(!f){i.startAnalysisBanding(b,"LR")}else{i.deleteAnalysis(b)}}},standard:{name:"add standard annotations",items:{}}}};if(v&&b.series.options.calculatedFrom&&b.series.options.id.substr(0,2)=="LR"){y.items.regression.name="delete linear regression";y.items.regression.className="delete-item";f=true;delete y.items.avg}if(v&&b.series.options.calculatedFrom&&b.series.options.id.substr(0,2)=="AV"){y.items.avg.name="delete average";y.items.avg.className="delete-item";g=true;delete y.items.regression}c=$(o.container).offset().top;p=$(o.container).offset().left;l=(E?n.originalEvent.x:n.clientX-p)-o.plotLeft;d=(E?n.originalEvent.y:n.pageY-c)-o.plotTop;if(d>=0&&d<=o.plotSizeY){for(r=0;r<o.yAxis.length;r++){u=o.yAxis[r].userOptions.title.text;h=parseFloat(parseFloat(o.yAxis[r].translate(o.plotHeight-d,true).toPrecision(2)));y.items.hline.items["hltext"+r]={name:"<b>"+u+":</b>",type:"text",value:h};y.items.hline.items["hladd"+r]={name:"<button>add</button>",callback:function(e,t){var a=parseFloat($.contextMenu.getInputValues(t)["hltext"+e.substr(5)]);var n="hl"+i.lineNo++;o.yAxis[parseInt(e.substr(5))].addPlotLine({id:n,color:"#FF0000",width:2,value:a});s.annotations.push({id:n,type:"hline",color:"#FF0000",from:a,yAxis:o.yAxis[parseInt(e.substr(5))].userOptions.title.text,text:""});i.build("table-only")}};y.items.hband.items["hbtext"+r]={name:"<b>"+u+":</b>",type:"text",value:h};y.items.hband.items["hbadd"+r]={name:"<button>start</button>",callback:function(a,n){i.bandStartPoint=parseFloat($.contextMenu.getInputValues(n)["hbtext"+a.substr(5)]);i.banding="y-"+o.yAxis[a.substr(5)].userOptions.title.text;o.yAxis[parseInt(a.substr(5))].addPlotBand({id:"hb"+i.bandNo++,color:m(t[0],e),from:i.bandStartPoint,to:i.bandStartPoint})}};if(r!=0){y.items.hline.items["yadd"+r+"sep"]="---------";y.items.hband.items["yadd"+r+"sep"]="---------"}}}else{if(!v)return false;y.items.hline.disabled=true;y.items.hband.disabled=true}for(r=0;r<i.standards.length;r++){y.items.standard.items["SA"+i.standards[r].annoid]={name:i.standards[r].name,callback:function(e,t){i.addStandard(parseInt(e.substr(2)))}}}return y}}});console.timeEnd("contextMenu");$("#"+n+" .highcharts-title").click(function(){ot.show(this)});console.timeEnd("chartPanel");return o;function d(e){if(s.mapsets||s.pointsets){var t=L(e,s.calculatedMapData.dates);for(var a=0;a<s.calculatedMapData.dates.length;a++){if(s.calculatedMapData.dates[a]["dt"].getTime()==t){$("#"+n+" .map-slider").slider("value",a)}}}}}function N(e){var t=new Date(parseInt(e.lastdt));switch(e.largestPeriod){case"A":return t.setUTCFullYear(t.getUTCFullYear()-(e.intervals-1));case"SA":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*6);case"Q":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*3);case"M":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1));case"W":return t.setUTCDate(t.getUTCDate()-(e.intervals-1)*7);default:return t.setUTCDate(t.getUTCDate()-(e.intervals-1))}}function _(e){var t,a,i,n,s;var o=Qt[e];var r=o.controls.chart.options.chart;if(o.start===null){t=0}else{i=r.x.indexOf(o.start.toString());if(i>-1){t=i}else{n=null;for(i=0;i<r.x.length;i++){s=Math.abs(parseInt(r.x[i])-parseInt(o.start));if(n===null||n>s){n=s;t=i}}}}if(o.end===null){a=r.x.length-1}else{i=r.x.indexOf(o.end.toString());if(i>-1){a=i}else{n=null;for(i=0;i<r.x.length;i++){s=Math.abs(parseInt(r.x[i])-parseInt(o.end));if(n===null||n>s){n=s;a=i}}}}$("#"+e+" span.interval-crop-period").html(S.units[o.largestPeriod]+"s");$("#"+e+" div.crop-slider").slider("option","max",r.x.length-1).slider("option","values",[t,a])}function c(e){var t;t=new Date("1/1/"+e.substr(0,4)+" UTC");if(e.length>4){switch(e.substr(4,1)){case"Q":t.setUTCMonth((e.substr(5,1)-1)*3);break;case"H":t.setUTCMonth((e.substr(5,1)-1)*6);break;default:t.setUTCMonth(e.substr(4,2))}if(e.length>6){t.setUTCDate(e.substr(6,2));if(e.length>8){t.setUTCHours(e.substr(9,2));t.setUTCMinutes(e.substr(12,2));t.setUTCSeconds(e.substr(15,2))}}}return t}function L(e,t,a){var i;for(var n=0;n<t.length;n++){if(Array.isArray(t[n])){i=t[n][0]}else{if(t[n].dt){i=t[n].dt.getTime()}else{i=t[n].x}}if(Math.abs(e-i)<Math.abs(e-a)||a===undefined)a=i}return a}function G(e,t,a){t.assets=t.assets||{};if(!t.assets[e]){if(oMySeries&&oMySeries[e]&&oMySeries[e].data){t.assets[e]=$.extend(true,{},oMySeries[e])}else{a[e.charAt(0)].push(e.substr(1))}}}function R(e,t){var a={S:[],U:[],X:[],M:[]};var i,n,s;yt(e,function(){G(this.handle,e,a)});q(e,a,t)}function q(e,t,a){if(t.S.length>0||t.U.length>0){bi({command:"GetMashableData",sids:t.S,usids:t.U,modal:"persist"},function(i,n,s){for(handle in i.series)e.assets[handle]=i.series[handle];t.S=[];t.U=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.M.length>0){bi({command:"GetMapSets",mapsetids:t.M,map:e.map,modal:"persist"},function(i,n,s){for(handle in i.mapsets)e.assets[handle]=i.mapsets[handle];t.M=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.X.length>0){bi({command:"GetPointSets",pointsetids:t.X,map:e.map,modal:"persist"},function(i,n,s){for(handle in i.pointsets)e.assets[handle]=i.pointsets[handle];t.X=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()}function z(e,t){var a=Xt["G"+e];if(a){i()}else{for(gid in Xt){if(Xt[gid].ghash==e){a=Xt[gid];break}}if(a){i()}else{bi({command:"GetPublicGraph",ghash:e},function(e,t,n){for(var s in e.graphs){a=e.graphs[s];ti(a);i()}})}}function i(){var e=graphScriptFiles.concat(a.mapFile?["/global/js/maps/"+a.mapFile+".js"]:[]);require(e);R(a,function(){require(e,function(){nt($.extend(true,{},a));if(t)t()})})}}function W(){return{annotations:[],title:"",type:"auto",map:"",assets:{},analysis:null,mapconfig:{},start:null,end:null,published:"N"}}function B(e){console.time("makeChartOptionsObject");var t,a,i,n={},s={};var o={chart:{animation:false,type:"line",zoomType:"x",height:($("div.graph-panel").height()-70-(e.map?70:0))*(e.mapsets||e.pointsets?.4:1),x:[]},exporting:{enabled:false},plotOptions:{area:{stacking:"normal"},scatter:{zIndex:20,showInLegend:false},series:{zIndex:10,marker:{enabled:true,radius:4,symbol:"circle",states:{hover:{enabled:true}}},shadow:false,dataLabels:{align:"center",enabled:true,color:"#ffffff",formatter:function(){if(typeof this.point.id!="undefined"){return this.point.id}},y:9,x:0}}},legend:{enabled:true},credits:{enabled:true,text:"created with MashableData.com",href:"http://www.mashabledata.com"},series:[],title:{text:e.title,style:{cursor:"pointer"}},xAxis:{type:"datetime",min:e.start===null?e.intervals?N(e):null:parseInt(e.start),max:e.end===null?null:parseInt(e.end)},yAxis:[]};if(e.title.length==0){o.title.text="untitled - click to edit";o.title.style.color="grey";o.title.style.font="italic"}var r=0;function l(e,t){if(typeof t.firstdt!="undefined"){e.firstdt=typeof e.firstdt=="undefined"?parseInt(t.firstdt):Math.min(parseInt(t.firstdt),parseInt(e.firstdt));e.lastdt=typeof e.lastdt=="undefined"?parseInt(t.lastdt):Math.max(parseInt(t.lastdt),parseInt(e.lastdt))}else{if(t.mapsetid||t.pointsetid){for(location in t.data){e.firstdt=typeof e.firstdt=="undefined"?parseInt(t.data[location].firstdt):Math.min(parseInt(t.data[location].firstdt),parseInt(e.firstdt));e.lastdt=typeof e.lastdt=="undefined"?parseInt(t.data[location].lastdt):Math.max(parseInt(t.data[location].lastdt),parseInt(e.lastdt))}}}}yt(e,function(t,a){var i=e.assets[this.handle];if(i.src=="MashableData"){if(a.components.length==1){if(!e.firstdt&&!e.lastdt)yt(e,function(){l(e,e.assets[this.handle])});i.firstdt=e.firstdt;i.lastdt=e.lastdt}else{delete i.firstdt;delete i.lastdt;$.each(a.components,function(){l(i,e.assets[this.handle])})}i.data=p(i.skey,i.firstdt,i.lastdt)}});for(t=0;t<e.plots.length;t++){var d=e.plots[t];var c=H(e,t);if(!d.options.color)d.options.color=vt(e.plots);var u={name:c.name,marker:{enabled:e.type=="marker"},id:"P"+t,period:c.period,color:d.options.color,data:c.data,yAxis:0};if(d.options.type){if(d.options.type!="default")u.type=d.options.type}if(d.options.lineWidth)u.lineWidth=d.options.lineWidth;if(d.options.lineStyle)u.dashStyle=d.options.lineStyle;if(e.type=="area"||u.stack=="area"){u.stack=c.units}for(a=0;a<c.data.length;a++){n[c.data[a][0].toString()]=true}var h=c.units;var f={labels:{style:{color:"#333333"}},title:{text:h,style:{color:"#333333"}}};if(o.yAxis.length==0){o.yAxis.push(f)}else{var m=false;var g;for(g=0;g<o.yAxis.length;g++){if(o.yAxis[g].title.text==h){u.yAxis=g;m=true;break}}if(!m){f.title.style.color=u.color;f.labels.style.color=u.color;o.yAxis[0].title.style.color=o.series[0].color;o.yAxis[0].labels.style.color=o.series[0].color;f.opposite=true;o.yAxis.push(f);u.yAxis=g}}o.series.push(u);r++}for(var b in n){o.chart.x.push(Number(b))}o.chart.x.sort(function(e,t){return parseInt(e)-parseInt(t)});for(t=0;t<o.yAxis.length;t++){o.series.push({type:"scatter",id:"labelsY-"+t,yAxis:t,data:[],doNotShow:true})}switch(e.type){case"pie":var v=[{type:"pie",data:[]}];var y=e.end?parseInt(e.end):e.lastdt;for(t=0;t<o.series.length;t++){c=o.series[t];for(a=c.data.length-1;a>=0;a--){if(c.data[a][0]==y){v[0].data.push([c.name,c.data[a][1]]);break}}}o.series=v;o.chart.type=e.type;break;case"stacked-column":o.plotOptions.column={stacking:"normal"};for(t=0;t<o.series.length;t++){o.series[t].stack="stacked"}case"column":o.chart.type="column";break;case"area-percent":o.yAxis[0].title.text="percent";o.plotOptions.area.stacking="percent";case"area":o.chart.type="area";break;case"marker":break;case"auto":if(e.smallestPeriod!=e.largestPeriod){for(t=0;t<o.series.length;t++){if(e.largestPeriod==o.series[t].period){o.series[t].type="column";o.series[t].zIndex=8;o.series[t].pointRange=S.value[o.series[t].period];o.series[t].pointPlacement="between";o.series[t].pointPadding=0;o.series[t].groupPadding=.05}}}else{var k=0,w;for(t=0;t<o.series.length;t++){if(o.series[t].period){w=0;for(a=0;a<o.series[t].data.length;a++){i=o.series[t].data[a][0];if((!o.xAxis.min||o.xAxis.min<=i)&&(!o.xAxis.max||o.xAxis.max>=i))w++}k=Math.max(k,w)}}if(k<=5){o.chart.type="column";if(k==1&&e.smallestPeriod){if(o.xAxis.min)o.xAxis.min-=S.value[e.smallestPeriod]/4;if(o.xAxis.max)o.xAxis.max+=S.value[e.smallestPeriod]/4}}}break;case"logarithmic":for(t=0;t<o.yAxis.length;t++){o.yAxis[t].type="logarithmic"}break;case"normalized-line":var x;if(e.start){x=e.start}else{x=o.series[0].data[0][0]}var C=false;while(!C){C=true;for(t=0;t<o.series.length;t++){if(o.series[t].sid){while(x>o.series[t].data[0][0]){o.series[t].data.splice(0,1);if(o.series[t].data.length==0){break}if(x<o.series[t].data[0][0]){x=o.series[t].data[0][0]}}if(o.series[t].data.length==0){o.title.text="Error:  no common starting point for normalization";for(a=0;a<o.series.length;a++){o.series[a].data=[]}C=true;break}C=C&&x==o.series[t].data[0][0]}}}for(t=0;t<o.series.length;t++){for(a=o.series[t].data.length-1;a>=0;a--){o.series[t].data[a][1]=o.series[t].data[a][1]/o.series[t].data[0][1]}o.seriesyAxis=0}o.yAxis=[{title:{text:"Normalized to 1"}}]}if(e.smallestPeriod)o.xAxis.minTickInterval=S.value[e.smallestPeriod];console.timeEnd("makeChartOptionsObject");return o}function H(e,t){console.time("createSerieFromPlot");var a,i,n,s,o,r,l,d,p,u,m=[],g,b={};l=e.plots[t];d={name:rt(e,l),units:lt(e,l)};n=l.components;d.period=l.options.fdown||e.assets[n[0].handle].period;l.formula=V(l);var y="return "+l.formula.formula.replace(P,"values.$1")+";";var k=new Function("values",y);var w=[],x;for(s=0;s<n.length;s++){x=Y(s);w.push(x);if(l.options.fdown&&l.options.fdown!=e.assets[n[s].handle].period){p=h(e.assets[n[s].handle],l.options.fdown,l.options.algorithm,l.options.missing)}else{p=e.assets[n[s].handle].data.split("||")}for(o=0;o<p.length;o++){u=p[o].split("|");if(!b[u[0].toString()]){b[u[0].toString()]={}}b[u[0].toString()][x]=u[1]}}var C=!l.options.componentData||l.options.componentData=="required";var M=l.options.componentData=="missingAsZero";var $=l.options.componentData=="nullsMissingAsZero";var S=!l.options.breaks||l.options.breaks=="never";var D=l.options.breaks=="nulls";var T=l.options.breaks=="missing";for(g in b){a={};i=true;for(s=0;s<w.length;s++){if(!isNaN(b[g][w[s]])){a[w[s]]=parseFloat(b[g][w[s]])}else{if(b[g][w[s]]=="null"){if($){a[w[s]]=0}else{i=null;break}}else{if(C){i=null;break}else{a[w[s]]=0}}}}if(i){try{i=k(a);if(Math.abs(i)==Infinity||isNaN(i))i=null}catch(A){i=null}}if(i!==null||!S){if(i!==null)i=f(i);m.push([Date.parse(c(g)),i])}}m.sort(function(e,t){return e[0]-t[0]});if(T){m=v(m,d.period)}d.data=m;console.timeEnd("createSerieFromPlot");return d}function V(e){var t,a,i=false,n=false,s="",o="",r="",l="";var d=/[+-/*]+/;for(var c=0;c<e.components.length;c++){t=e.components[c];a=Y(c);if(!i&&t.options.dn&&t.options.dn=="d"){if(n){n=false;if(d.test(r))r="("+r+")";l+=r}s=l;l="";i=true}if(l.length==0){switch(t.options.op){case"/":n=true;r=p();l="1/";break;case"-":l="-"+p();break;case"+":case"*":default:l=p()}}else{switch(t.options.op){case"+":case"-":if(n){n=false;if(d.test(r))r="("+r+")";l+=r+" "+t.options.op+" "+p()}else{l+=" "+t.options.op+" "+p()}break;case"*":if(n){r+="*"+p()}else{l+="*"+p()}break;case"/":if(n){r+="*"+p()}else{n=true;l+="/";r=p()}}}}if(n){n=false;if(d.test(r))r="("+r+")";l+=r}if(i){o=l}else{s=l}if((e.options.k||1)==1){if(i){l=(s==""?1:d.test(s)?"("+s+")":s)+" / "+(d.test(o)?"("+o+")":o)}else{l=s}}else{if(i){l=e.options.k+" * "+(s=""?"":d.test(s)?"("+s+")":s)+" / "+(d.test(o)?"("+o+")":o)}else{l=e.options.k+" * "+(d.test(s)?"("+s+")":s)}}e.options.calculatedFormula={formula:l,denomFormula:o,numFormula:s,k:e.options.k||1};return e.options.calculatedFormula;function p(){return isNaN(t.options.k)||t.options.k==1?a:t.options.k+"*"+a}}function Y(e){var t="";if(e>25){t=String.fromCharCode("A".charCodeAt(0)+parseInt(e/26))}t+=String.fromCharCode("A".charCodeAt(0)+e%26);return t}function X(e,t,a){yi("creating grid");var i=a.attr("data");var n=a.find(".slick-holder");if(e)e.destroy();var s=Qt[t];var o={enableCellNavigation:true,enableColumnReorder:false,defaultColumnWidth:200,headerRowHeight:100};switch(i){case"chart":var r=Q(t);e=new Slick.Grid(n,r.rows,r.columns,o);break;case"regions":e=new Slick.Grid(n,s.calculatedMapData.regionGrid.data,s.calculatedMapData.regionGrid.columns,o);break;case"markers":e=new Slick.Grid(n,s.calculatedMapData.markerGrid.data,s.calculatedMapData.markerGrid.columns,o);break}vi()}function Q(e){console.time("gridDataForChart");var t,a,i,n,s,o,r,l,p,u,h,f,m,g,b;var v=Qt[e];var y=v.assets;var k;if(v.plots){var w=v.controls.chart}else{throw"Chart does not exist; cannot make grid objects"}var x,C,M=[];var $=[{id:"date",field:"date",name:"name:<br>"+"units:<br>"+"source:<br>"+"notes:<br>"+"region code:<br>"+"lat, lon:<br>"+"formula:",cssClass:"grid-date-column"}];for(t=0;t<v.plots.length;t++){i=v.plots[t];x="P"+t;l=w.get(x);var S=i.options.formula&&i.options.formula.formula.length>1||i.formula&&i.formula.formula.length>1||i.options.units||i.options.name;for(a=0;a<i.components.length;a++){C="P"+t+"-C"+a;n=y[i.components[a].handle];$.push({id:C,field:C,name:"<b>"+n.name+"</b><br>"+(n.units||"")+"<br>"+(n.src||"")+"<br>"+(n.notes||"")+"<br>"+(n.iso3166||"")+"<br>"+(n.lat?n.lat+", "+n.lon:"")+"<br>"+"<br>component "+Y(a),cssClass:"grid-series-column"});r=n.data.split("||");for(s=0;s<r.length;s++){u=r[s].split("|");p=c(u[0]);h=gt(p.getTime(),l.options.period);if((!v.start||v.start<=p)&&(!v.end||v.end>=p)){for(m=false,g=0;g<M.length;g++){if(M[g].id==u[0]){m=true;break}}if(!m)M.push({id:u[0],date:h,order:p});M[g][C]=u[1]===null?"-":u[1]}}}if(S){$.push({id:x,field:x,name:"<b>"+rt(v,i)+"</b><br>"+lt(v,i)+"<br>"+"<br>"+"<br>"+"<br>"+"<br>"+"<br>"+i.formula.formula,cssClass:"grid-calculated-column"});for(s=0;s<l.options.data.length;s++){b=l.options.data[s];h=gt(b[0],l.options.period);f=d(b[0],l.options.period);if((!v.start||v.start<=b[0])&&(!v.end||v.end>=b[0])){for(m=false,g=0;g<M.length;g++){if(M[g].id==f){m=true;break}}if(!m)M.push({id:f,date:h,order:b[0]});M[g][x]=b[1]===null?"-":b[1]}}}}M.sort(function(e,t){if(t.order!=e.order){return t.order-e.order}else{return t.id.length-e.id.length}});console.timeEnd("gridDataForChart ");return{columns:$,rows:M}}function Z(e){console.time("makeTableFromArray");var t,a;if(e[A.lat_lon].join("")=="lat, lon:")e.splice(A.lat_lon,1);if(e[A.region].join("")=="region code:")e.splice(A.region,1);for(t=0;t<e.length;t++){e[t]="<tr><td>"+e[t].join("</td><td>")+"</td></tr>"}console.timeEnd("makeTableFromArray");return'<table class="data-grid">'+e.join("")+"</table>"}function J(e){var t,a,i,n={},s=[],o={},r;var l={};var d={};var p={},u,h,m,g,b,v,y,k,w,x,C;var M,S;var D={};var T,A,I,U,F,E,O,N;if(e.mapsets){var _=e.mapsets;_.formula=V(_);T="return "+_.formula.formula.replace(P,"values.$1")+";";var L=new Function("values",T);A=[];U={};F=_.components;N={};var G=[];for(h=0;h<F.length;h++){O=Y(h);A.push(O);if(F[h].handle[0]=="M"){for(I in e.assets[F[h].handle].data){if(!U[I]){U[I]=true;G.push({geo:I,name:e.assets[F[h].handle].geoname})}E=e.assets[F[h].handle].data[I].data.split("||");for(m=0;m<E.length;m++){g=E[m].split("|");if(!N[g[0].toString()]){N[g[0].toString()]={}}if(!N[g[0].toString()][O]){N[g[0].toString()][O]={}}N[g[0].toString()][O][I]=g[1]===null||g[1]=="null"?null:parseFloat(g[1])}}}else{E=e.assets[F[h].handle].data.split("||");for(m=0;m<E.length;m++){g=E[m].split("|");if(!N[g[0].toString()]){N[g[0].toString()]={}}N[g[0].toString()][O]=g[1]===null||g[1]=="null"?null:parseFloat(g[1])}}}var R=!_.options.componentData||_.options.componentData=="required";var j=_.options.componentData=="missingAsZero";var q=_.options.componentData=="nullsMissingAsZero";var z=!_.options.breaks||_.options.breaks=="never";var W=_.options.breaks=="nulls";var B=_.options.breaks=="missing";t=rt(e,_);a=e.assets[F[0].handle].period;i=lt(e,_);for(r in N){M=Number.MAX_VALUE;S=Number.MIN_VALUE;k=false;for(I in U){w={};C=true;x=false;for(h=0;h<A.length;h++){if(!isNaN(N[r][A[h]])){w[A[h]]=parseFloat(N[r][A[h]])}else{if(N[r][A[h]]=="null"){if(q){w[A[h]]=0}else{C=null;break}}else{if(N[r][A[h]]&&!isNaN(N[r][A[h]][I])){if(N[r][A[h]][I]=="null"){if(q){w[A[h]]=0}else{C=null;break}}else{w[A[h]]=N[r][A[h]][I];x=true}}else{if(R){C=null;break}else{w[A[h]]=0}}}}}if(x){if(C){try{C=L(w);if(Math.abs(C)==Infinity||isNaN(C))C=null}catch(H){C=null}}if(C!==null){C=f(C);if(!d[r])d[r]={};d[r][I]=C;k=true;M=Math.min(M||C,C);S=Math.max(S||C,C)}}}if(k){n[r]={regionMin:M,regionMax:S}}else{delete d[r]}}var X=[{id:"date",width:100,field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];var Q=[];var Z=_.formula.formula!="A";G.sort(function(e,t){return e.name>t.name});var J,K,et,tt=true,at,it=rt(e,_),nt=lt(e,_,false,_.formula);for(r in d){at=c(r).getTime();et={order:at,date:gt(at,e.assets[F[0].handle].period)};for(h=0;h<G.length;h++){for(m=0;m<A.length;m++){I=G[h].geo;J=A[m]+"_"+h;K=e.assets[F[m].handle];if(tt)X.push({id:J,field:J,name:"<b>"+(K.maps&&K.data[I]?K.data[I].name:K.name)+"</b><br>"+(K.maps&&K.data[I]?K.data[I].geoname:K.geoname||"")+"<br>"+K.units+"<br>"+K.src+"<br>"+(K.maps&&K.data[I]?K.data[I].notes:K.notes||"not available")+(Z?"<br>component "+A[m]:""),cssClass:"grid-series-column"});if(F[m].handle[0]=="M"){et[J]=N[r][A[m]][I]}else{et[J]=N[r][A[m]]}if(typeof et[J]=="undefined")et[J]="-"}if(Z){if(tt)X.push({id:I,field:I,name:"<b>"+it+": "+G[h].name+"</b><br>"+nt+"<br><br>"+(Z?"<br>value = "+_.formula.formula:""),cssClass:"grid-calculated-column"});et[I]=typeof d[r][I]=="undefined"?"-":d[r][I]}}Q.push(et);tt=false}Q.sort(function(e,t){return t.order-e.order})}var st,ot;if(e.pointsets){var dt,ct={},pt;var ut=0,ht,ft,mt;var bt=[{id:"date",field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];
var yt=[];for(h=0;h<e.pointsets.length;h++){var kt=[];ht=e.pointsets[h];if(!ht.options.color)ht.options.color=vt(e.pointsets);ht.formula=V(ht);T="return "+ht.formula.formula.replace(P,"values.$1")+";";var wt=new Function("values",T);A=[];F=ht.components;N={};for(m=0;m<F.length;m++){O=Y(m);A.push(O);if(F[m].handle[0]=="X"){pt=e.assets[F[m].handle].data;for(dt in pt){if(!ct[dt]){ct[dt]=true;kt.push({latlon:dt,name:pt[dt].name})}if(o[dt]){o[dt].name+="<br>"+pt[dt].name}else{o[dt]={latLng:dt.split(","),name:pt[dt].name,style:{fill:ht.options.color}};o[dt].latLng[0]=parseFloat(o[dt].latLng[0]);o[dt].latLng[1]=parseFloat(o[dt].latLng[1])}E=pt[dt].data.split("||");for(mt=0;mt<E.length;mt++){g=E[mt].split("|");if(!N[g[0].toString()]){N[g[0].toString()]={}}if(!N[g[0].toString()][O]){N[g[0].toString()][O]={}}N[g[0].toString()][O][dt]=g[1]}}}else{E=e.assets[F[m].handle].data.split("||");for(mt=0;mt<E.length;mt++){g=E[mt].split("|");if(!N[g[0].toString()]){N[g[0].toString()]={}}N[g[0].toString()][O]=g[1]}}}var R=!ht.options.componentData||ht.options.componentData=="required";var j=ht.options.componentData=="missingAsZero";var q=ht.options.componentData=="nullsMissingAsZero";var z=!ht.options.breaks||ht.options.breaks=="never";var W=ht.options.breaks=="nulls";var B=ht.options.breaks=="missing";t=t+rt(e,ht);a=e.assets[F[0].handle].period;if(ht.options.attribute=="fill"){st=lt(e,ht)}else{ot=lt(e,ht)}for(r in N){M=Number.MAX_VALUE;S=Number.MIN_VALUE;k=false;for(dt in ct){w={};C=true;x=false;for(m=0;m<A.length;m++){if(!isNaN(N[r][A[m]])){w[A[m]]=parseFloat(N[r][A[m]])}else{if(N[r][A[m]]=="null"){if(q){w[A[m]]=0}else{C=null;break}}else{if(N[r][A[m]]&&!isNaN(N[r][A[m]][dt])){if(N[r][A[m]][dt]=="null"){if(q){w[A[m]]=0}else{C=null;break}}else{w[A[m]]=N[r][A[m]][dt];x=true}}else{if(R){C=null;break}else{w[A[m]]=0}}}}}if(x){if(C){try{C=wt(w);if(Math.abs(C)==Infinity||isNaN(C))C=null}catch(H){C=null}}if(C!==null){C=f(C);k=true;if(!l[r])l[r]={};if(!l[r][dt])l[r][dt]={};if(ht.options.attribute=="fill"){l[r][dt].f=C;M=Math.min(M,C);S=Math.max(S,C)}else{l[r][dt].r=C;M=Math.min(M,C);S=Math.max(S,C)}}}}if(k){if(!n[r])n[r]={};if(ht.options.attribute=="fill"){n[r].markerFillMin=Math.min(n[r].markerFillMin||M,M);n[r].markerFillMax=Math.max(n[r].markerFillMax||S,S)}else{n[r].markerRadiusMin=Math.min(n[r].markerRadiusMin||M,M);n[r].markerRadiusMax=Math.max(n[r].markerRadiusMax||S,S)}}else{delete l[r]}}kt.sort(function(e,t){return e.name>t.name});var xt=ht.formula.formula!="A";var J,K,et,tt=true,at,Ct=rt(e,ht),Mt=lt(e,ht,false,ht.formula);for(r in l){at=c(r).getTime();et={id:at,date:gt(at,e.assets[F[0].handle].period)};for(var $t=0;$t<kt.length;$t++){for(m=0;m<A.length;m++){dt=kt[$t].latlon;J=A[m]+"_"+$t;K=e.assets[F[m].handle];if(tt)bt.push({id:J,field:J,name:"<b>"+(K.coordinates&&K.data[dt]?K.data[dt].name:K.name)+"</b>"+"<br>"+(K.coordinates&&K.data[dt]?dt:K.geoname||"")+"<br>"+K.units+"<br>"+K.src+"<br>"+(K.maps&&K.data[dt]?K.data[dt].notes:K.notes||"")+(Z?"<br>component "+A[m]:""),cssClass:"grid-series-column"});if(F[m].handle[0]=="X"){et[J]=N[r][A[m]][dt]}else{et[J]=N[r][A[m]]}if(typeof et[J]=="undefined")et[J]="-"}if(xt){if(tt)bt.push({id:dt+"-"+h,field:dt+"-"+h,name:"<b>"+Ct+": "+kt[$t].name+"</b><br>"+Mt+"<br><br>"+(Z?"<br>value = "+ht.formula.formula:""),cssClass:"grid-calculated-column"});et[dt+"-"+h]=typeof l[r][dt]=="undefined"?"-":l[r][dt]}}for(var St=false,Dt=0;Dt<yt.length;Dt++){if(yt[Dt].id==et.id){$.extend(yt[Dt],et);St=true;break}}if(!St)yt.push(et);tt=false}yt.sort(function(e,t){return t.id-e.id})}for(v in l){for(dt in ct){if(typeof l[v][dt]=="undefined")l[v][dt]={f:null,r:null}}}}for(r in n){s.push({s:r,dt:c(r),regionMin:n[r].regionMin,regionMax:n[r].regionMax,markerRadiusMin:n[r].markerRadiusMin,markerRadiusMax:n[r].markerRadiusMax,markerFillMin:n[r].markerFillMin,markerFillMax:n[r].markerFillMax})}s.sort(function(e,t){return e.dt-t.dt});e.calculatedMapData={title:t,period:a,mapUnits:i,markers:o,markerData:l,dates:s,regionData:d,regionGrid:{columns:X,data:Q},markerGrid:{columns:bt,data:yt},fillUnits:st,radiusUnits:ot};return e.calculatedMapData}function K(e){var t,a,i,n,s,r={},l,d,c=e.calculatedMapData;c.regionMin=Number.MAX_VALUE;c.regionMax=Number.MIN_VALUE;c.startDateIndex=c.dates.length-1;c.endDateIndex=0;for(t=0;t<c.dates.length;t++){if((!e.start||parseInt(e.start)<=c.dates[t].dt.getTime())&&(!e.end||parseInt(e.end)>=c.dates[t].dt.getTime())){if(c.startDateIndex>t)c.startDateIndex=t;if(c.endDateIndex<t)c.endDateIndex=t;if(e.mapsets){c.regionMin=Math.min(c.dates[t].regionMin,c.regionMin);c.regionMax=Math.max(c.regionMax,c.dates[t].regionMax)}}}var p,u,h,f;if(e.mapsets){var m={};f=e.mapsets.options;u=!f.scale||f.scale=="continuous";l=c.regionMin;d=c.regionMax;h=l<0&&d>0;c.regionColors={};if(u){p={pos:_(f.posColor||y.POS),neg:_(f.negColor||y.NEG),mid:_(y.MID)};var g=new RGBColour(p.pos.r,p.pos.b,p.pos.g);var b=g.getHSV();var v=new HSVColour(b.h,h?10:20,h?90:100);var w=v.getIntegerRGB();p.posMid={r:w.r,g:w.g,b:w.b};var x=new RGBColour(p.neg.r,p.neg.b,p.neg.g);var C=x.getHSV();var M=new HSVColour(C.h,h?10:20,h?90:100);var $=M.getIntegerRGB();p.negMid={r:$.r,g:$.g,b:$.b}}for(t=c.startDateIndex;t<=c.endDateIndex;t++){n=c.dates[t].s;c.regionColors[n]={};if(c.regionData[n]){for(s in c.regionData[n]){r[s]=true;a=c.regionData[n][s];if(!isNaN(a)&&a!==null){a=parseFloat(a);if(u){if(a==0){c.regionColors[n][s]=y.MID}else{c.regionColors[n][s]=L(a,a<0?l:h?0:l,a>0?d:h?0:d,a<0?p.neg:p.posMid,a<0?p.negMid:p.pos,f.logMode=="on"&&!h&&l!=0&&d!=0)}}else{for(j=0;j<f.discreteColors.length;j++){if(j!=f.discreteColors.length-1&&a<=parseFloat(f.discreteColors[j].cutoff)||j==f.discreteColors.length-1){c.regionColors[n][s]=f.discreteColors[j].color;break}}}}else{c.regionColors[n][s]="#ffffff"}}}else{for(i in c.regionData){for(s in c.regionData[i]){c.regionColors[n][s]="#ffffff"}break}}}for(n in c.regionColors){for(s in r){if(typeof c.regionColors[n][s]=="undefined"){c.regionColors[n][s]="#ffffff"}}}}if(e.pointsets){f=e.mapconfig;u=!f.scale||f.scale=="continuous";if(u){}var S=Number.MAX_VALUE,D=Number.MIN_VALUE;var T=Number.MAX_VALUE,A=Number.MIN_VALUE;for(t=c.startDateIndex;t<=c.endDateIndex;t++){if(c.dates[t].markerRadiusMin){T=Math.min(c.dates[t].markerRadiusMin,T);A=Math.max(c.dates[t].markerRadiusMax,A)}if(c.dates[t].markerFillMin){S=Math.min(c.dates[t].markerFillMin,S);D=Math.max(c.dates[t].markerFillMax,D)}}var I;var U=T!=Number.MAX_VALUE;if(U){I=Math.max(Math.abs(T),Math.abs(A));c.radiusScale=I}var P=S!=Number.MAX_VALUE;if(P){c.markerFillMinValue=S;c.markerFillMaxValue=D;u=P&&(!e.mapconfig.scale||f.scale=="continuous");h=S<0&&D>0;if(u){p={pos:_(f.posColor||y.POS),neg:_(f.negColor||y.NEG),posMid:{},negMid:{},mid:_(y.MID)};var g=new RGBColour(p.pos.r,p.pos.b,p.pos.g);var b=g.getHSV();var v=new HSVColour(b.h,h?10:20,h?90:100);var w=v.getIntegerRGB();p.posMid={r:w.r,g:w.g,b:w.b};var x=new RGBColour(p.neg.r,p.neg.b,p.neg.g);var C=x.getHSV();var M=new HSVColour(C.h,h?10:20,h?90:100);var $=M.getIntegerRGB();p.negMid={r:$.r,g:$.g,b:$.b}}}var F,E,O,N={r:{},fill:{},stroke:{}};for(n in c.markerData){N.r[n]={};N.fill[n]={};N.stroke[n]={};for(F in c.markers){if(U){O=c.markerData[n][F].r||null;if(O<0){N.stroke[n][F]="#ff0000";O=Math.abs(O)}else{N.stroke[n][F]="#000000"}N.r[n][F]=(e.mapconfig.maxRadius||k)*Math.sqrt(O)/Math.sqrt(I)}if(P){E=c.markerData[n][F].f||null;if(isNaN(E)||E===null){N.fill[n][F]="#ffffff"}else{if(u){if(h){N.fill[n][F]=L(E,E<0?S:h?0:S,E>0?D:h?0:D,E<0?p.neg:p.posMid,E<0?p.negMid:p.pos)}else{N.fill[n][F]=L(E,E<0?S:h?0:S,E>0?D:h?0:D,E<0?p.neg:p.mid,E<0?p.mid:p.pos)}}else{for(j=0;j<e.mapconfig.discreteColors;j++){if(j==0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<=E||j!=0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<E){N.fill[n][F]=e.mapconfig.discreteColors[j].color}else break}}}}else{}}}c.markerAttr=N}function _(e){if(e.substr(0,1)=="#")e=e.substr(1);var t,a,i;t=parseInt(e.substr(0,2),16);a=parseInt(e.substr(2,2),16);i=parseInt(e.substr(4,2),16);return{r:t,g:a,b:i}}function L(e,t,a,i,n,s){var r,l,d,c,p,u,h;if(s){c=Math.log(Math.abs(e));p=Math.log(Math.min(Math.abs(t),Math.abs(a)));u=Math.log(Math.max(Math.abs(t),Math.abs(a)));h=(c-p)/(u-p)}else{h=(e-t)/(a-t)}r=o(Math.round(h*(n.r-i.r)+i.r));l=o(Math.round(h*(n.g-i.g)+i.g));d=o(Math.round(h*(n.b-i.b)+i.b));return"#"+r+l+d}}function et(e,t){while(t.length>=4){if(e[t])return e[t];t=t.substr(0,t.length-2)}return false}function tt(e,t){var a=$("#"+e+" div.jvmap div").html();a=at(a);it({type:t,filename:"MashableDataMap",width:2e3,svg:a,url:"https://www.mashabledata.com/workbench/export/index.php"})}function at(e){e=e.replace(/<div[^<]+<\/div>/gi,"");e=e.replace(/<svg /gi,'<svg xmlns="http://www.w3.org/2000/svg"  version="1.1" ');e=e.replace(/<g><\/g>/gi,"");e=e.replace(/<g/,'<rect x="0" y="0" width="100%" height="100%" fill="'+T+'"></rect><g');e=e.replace(/zIndex="[^"]+"/g,"").replace(/isShadow="[^"]+"/g,"").replace(/symbolName="[^"]+"/g,"").replace(/jQuery[0-9]+="[^"]+"/g,"").replace(/isTracker="[^"]+"/g,"").replace(/url\([^#]+#/g,"url(#").replace(/&nbsp;/g," ").replace(/&shy;/g,"­").replace(/id=([^" >]+)/g,'id="$1"').replace(/class=([^" ]+)/g,'class="$1"').replace(/ transform /g," ").replace(/:(path|rect)/g,"$1").replace(/style="([^"]+)"/g,function(e){return e.toLowerCase()});e=e.replace(/(url\(#highcharts-[0-9]+)&quot;/g,"$1").replace(/&quot;/g,"'");if(e.match(/ xmlns="/g)&&e.match(/ xmlns="/g).length===2){e=e.replace(/xmlns="[^"]+"/,"")}return e}function it(e){var t=Highcharts.createElement;var a=t("form",{method:"post",action:e.url},{display:"none"},document.body);for(var i in e){t("input",{type:"hidden",name:i,value:e[i]},null,a)}a.submit();Highcharts.discardElement(a)}function nt(e,t){yi(window.SVGAngle?"drawing the graph":"drawing the graph<br>Note: Graphs will draw 20 times faster in a modern browser such as Chrome, Firefox, Safari or Internet Exploer 9 or later");window.setTimeout(function(){st(e,t)},20)}function st(e,t){console.time("buildGraphPanel:header");var a,i;if(e.title.length==0){var s,o=0;for(s in e.assets){o++;if(o>1)break}if(o==1)e.title=e.assets[s].name}a=e.title;if(!t){t=di(a);console.time("buildGraphPanel: "+t)}else{console.time("buildGraphPanel: "+t);$("#graph-tabs li").find("[href='#"+t+"']").html(a);destroyChartObject(t)}if(e.intervals==0)e.intervals=null;var r=$("#"+t);var l=new n(t,M);e.controls={annotations:l,$thisPanel:r,provenance:{},redraw:w};console.timeEnd("buildGraphPanel:header");console.time("buildGraphPanel:timeEnd");r.html('<div class="graph-nav">'+'<ol class="graph-nav">'+'<li class="graph-nav-talk" data="graph-talk"></li>'+'<li class="graph-nav-data" data="graph-data"></li>'+'<li class="graph-nav-sources"  data="graph-sources"></li>'+'<li class="graph-nav-active graph-nav-graph" data="graph-chart"></li>'+"</ol>"+"</div>"+'<div class="graph-talk graph-subpanel" style="display: none;"><p>This graph must be saved at least once to enable Facebook comments.</p></div>'+'<div class="graph-data graph-subpanel" style="display: none;">'+'<div class="graph-data-inner">'+"<ul>"+'<li><a href="#data-chart-'+t+'">chart data</a></li>'+'<li><a href="#data-region-'+t+'">map region data</a></li>'+'<li><a href="#data-marker-'+t+'">map marker data</a></li>'+'</ul><button class="download-data ui-state-highlight" title="Download the graph data as an Excel workbook">Download to Excel&nbsp;</button>'+'<div id="data-chart-'+t+'" class="graph-data-subpanel" data="chart"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-region-'+t+'" class="graph-data-subpanel" data="regions"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-marker-'+t+'" class="graph-data-subpanel" data="markers"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+"</div>"+"</div>"+'<div class="provenance graph-sources graph-subpanel" style="display: none;"></div>'+'<div class="graph-chart graph-subpanel">'+'<div class="graph_control_panel" style="font-size: 11px !important;">'+'<div class="change-map">change base map '+'<select class="change-map"></select>'+"</div>"+'<div class="graph-type">default graph type '+'<select class="graph-type">'+'<option value="auto">auto (line &amp; column)</option>'+'<option value="line">line</option>'+'<option value="marker">line with markers</option>'+'<option value="column">column</option>'+'<option value="stacked-column">stacked column</option>'+'<option value="area-percent">stacked percent</option>'+'<option value="area">stacked area</option>'+'<option value="logarithmic">logarithmic</option>'+'<option value="normalized-line">normalized line</option>'+'<option value="pie">pie</option>'+"</select>"+"</div>"+'<div class="crop-tool"><fieldset><legend>Crop graph</legend>'+"<table>"+'<tr><td><input type="radio" name="'+t+'-rad-crop" id="'+t+'-rad-no-crop" class="rad-no-crop"></td><td><label for="'+t+'-rad-no-crop">no cropping (graph will expand as new data is gathered)</label></td></tr>'+'<tr><td><input type="radio" name="'+t+'-rad-crop" id="'+t+'-rad-hard-crop" class="rad-hard-crop"></td><td>'+'<div class="crop-dates"><i>select this option and slide endpoints for a fixed crop</i></div>'+'<div class="crop-slider"></div>'+"</td></tr>"+'<tr><td><input type="radio" name="'+t+'-rad-crop" id="'+t+'-rad-interval-crop" class="rad-interval-crop"></td>'+'<td><label for="'+t+'-rad-interval-crop">show latest <input class="interval-crop-count" value="'+(e.intervals||5)+'"> <span class="interval-crop-period"></span></label></td></tr>'+"</table>"+'<button class="graph-crop" style="display: none;">crop</button></fieldset>'+"</div>"+'<div class="annotations"><fieldset><legend>Chart annotations</legend>'+'<table class="annotations"></table>'+"</fieldset></div>"+'<div class="downloads">'+"<fieldset>"+"<legend>&nbsp;Download visualization&nbsp;</legend>"+'<select class="download-selector"></select> '+"format: "+'<span title="download the graph as a PNG formatted image" class="md-png rico export-chart">PNG</span>'+'<span title="download the graph as a SVG formatted vector graphic"class="md-svg rico export-chart">SVG</span>'+'<span title="download the graph as a PDF document" class="md-pdf rico export-chart">PDF</span>'+"</fieldset>"+"</div>"+'<div class="sharing">'+"<fieldset>"+"<legend>&nbsp;Sharing&nbsp;</legend>"+'<div class="share-links">'+'<a href="#" class="post-facebook"><img src="images/icons/facebook.png" />facebook</a> '+'<a class="graph-email">email </a> '+'<button class="graph-link">link </button>'+'</div><div class="searchability">'+'<input type="radio" name="'+t+'-searchability" id="'+t+'-searchable" value="Y" '+(e.published=="Y"?"checked":"")+' /><label for="'+t+'-searchable">public graph</label>'+'<input type="radio" name="'+t+'-searchability" id="'+t+'-private" value="N" '+(e.published=="N"?"checked":"")+' /><label for="'+t+'-private">'+(account.info.orgName?"restrict to "+account.info.orgName:"not searchable")+"</label>"+"</div>"+"</fieldset>"+"</div>"+'<br /><button class="graph-save">save</button> <button class="graph-saveas">save as</button> <button class="graph-close">close</button> <button class="graph-delete">delete</button><br />'+"</div>"+'<div class="chart-map" style="width:70%;display:inline;float:right;">'+'<div class="chart"></div>'+'<div class="map" style="display:none;">'+'<h3 class="map-title" style="color:black;"></h3>'+'<div class="map-and-cub-viz">'+'<div class="cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container map-controls">'+'<div class="map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="map-step-backward">step backwards</button>'+'<button class="map-play">play</button>'+'<button class="map-step-forward">step forwards</button>'+'<button class="map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="make-map" disabled="disabled">reset</button>'+'<button class="merge group hidden" disabled="disabled">group</button>'+'<button class="merge ungroup hidden" disabled="disabled">ungroup</button>'+'<span class="right"><label><input type="checkbox" class="legend" '+(e.mapconfig.showLegend?"checked":"")+">legend</label></span>"+'<span class="right"><label><input type="checkbox" class="map-list" '+(e.mapconfig.showList?"checked":"")+">list</label></span>"+"</div>"+"</div>"+'<div height="75px"><textarea style="width:98%;height:50px;margin-left:5px;" class="graph-analysis" maxlength="1000" /></div>'+"</div>"+"</div>");var d,c;console.timeEnd("buildGraphPanel:thisPanel");console.time("buildGraphPanel:thisPanel events");function p(){if(e.ghash)r.find(".graph-talk.graph-subpanel").html('<fb:comments href="https://www.mashabledata.com/workbench/#/t=g&graphcode='+e.ghash+'"></fb:comments>')}p();r.find("ol.graph-nav").children("li").click(function(){var a=$(this);r.find("ol.graph-nav").children("li").removeClass("graph-nav-active");r.find(".graph-subpanel").hide();var i=r.find("."+a.attr("data")).show();a.addClass("graph-nav-active");switch(a.attr("data")){case"graph-talk":FB.XFBML.parse(i.get(0),function(){r.find("iframe").width(r.find(".graph-talk.graph-subpanel").width()*.9+"px").css("margin","15px")});break;case"graph-data":U.provOk();r.find(".graph-data-inner").tabs(e.plots?"enable":"disable",0).tabs(e.mapsets?"enable":"disable",1).tabs(e.pointsets?"enable":"disable",2);var n=r.find(".graph-data-inner li:not(.ui-state-disabled)").first().find("a").click();if(n.html()=="chart data")X(c,t,$(n.attr("href")));break;case"graph-sources":U.build();break;case"graph-chart":U.provOk()}});r.find(".graph-data-inner").tabs({activate:function(e,a){console.timeEnd("complete grid data into table");X(c,t,a.newPanel);console.timeEnd("complete grid data into table")}});r.find("button.download-data").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var a=[];if(e.plots){var n=Q(t);a.push({name:"chart",grid:{columns:n.columns,data:n.rows}})}if(e.mapsets)a.push({name:"regions",grid:{columns:i.regionGrid.columns,data:i.regionGrid.data}});if(e.pointsets)a.push({name:"markers",grid:{columns:i.markerGrid.columns,data:i.markerGrid.data}});it({filename:e.title,data:JSON.stringify(a),url:"excel.php"})});var u=r.find(".graph-subpanel").width(r.width()-35-2).height(r.height()).find(".chart-map").width(r.width()-40-350).end().innerHeight();r.find(".graph-data-subpanel").height(r.innerHeight()-60);r.find(".graph-sources").width(r.width()-35-2-40);r.find(".graph-analysis").val(e.analysis);r.find("select.download-selector").change(function(){if($(this).val()=="map"){if(!e.mapsets&&!e.pointsets){Ua("no map","This graph does not have a map to download.  Map are adding to graphs by finding a series that belongs to a map set or a marker set and mapping the set.");$(this).val("chart")}}else{if(!e.plots){Ua("no chart","This graph does not have a chart to download.");$(this).val("map")}}});r.find(".export-chart").click(function(){var e,t=$(this);if(t.hasClass("md-jpg"))e="image/jpeg";if(t.hasClass("md-png"))e="image/png";if(t.hasClass("md-svg"))e="image/svg+xml";if(t.hasClass("md-pdf"))e="application/pdf";A(e)});r.find("a.post-facebook").click(function(){var a;if(e.mapsets||e.pointsets){a=at(P.container.html())}else{l.sync();a=e.controls.chart.getSVG()}$.ajax({type:"POST",url:"export/index.php",dataType:"json",data:{type:"FB",width:"800",svg:a},success:function(e,a,i){var n=Qt[t].analysis;var s=Qt[t].title;var o={method:"feed",link:"http://www.mashabledata.com/workbench#/t=g1&graphcode="+Qt[t].ghash,picture:e.imageURL,message:n,name:"MashableData visualization",caption:s,description:n};function r(e){alert("Post ID: "+e["post_id"])}FB.ui(o,r)},error:function(e,t,a){console.log(t)}})});var h="mailto: "+"?subject="+escape(e.title||"link to my MashableData visualization")+"&body="+escape((e.analysis||"Link to my interactive visualization on MashableData.com:")+"<br><br>http://www.mashabledata.com/workbench/#/t=g2&graphcode="+e.ghash);r.find(".graph-email").button({icons:{secondary:"ui-icon-mail-closed"}}).attr("href",h);r.find(".email-link").attr("href",h);r.find(".graph-link").button({icons:{secondary:"ui-icon-link"}}).click(function(){if(e.isDirty){Ua("Graph is not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var t=$(this).offset();var a='<div id="link-editor">'+'<button class="right" id="link-editor-close">close</button>'+'<button id="ghash-reset" class="ui-state-error right">reset link code</button>'+'<b>link code: </b><span id="link-ghash">'+e.ghash+"</span><br><br>"+"<em>The code below will create a link to your graph</em>"+'<textarea id="link-html">&lt;a href=&quot;http://www.mashabledata.com/workbench/#/t=g2&graphcode='+e.ghash+"&quot;&gt;"+(e.title||"MashableData graph")+"&lt;/a&gt;</textarea>"+"</div>";$.fancybox(a,{width:600,height:100,showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#fancybox-wrap").css({top:parseInt(t.top+$(this).height()-30)+"px",left:parseInt(t.left-620+$(this).width())+"px"});$("#link-editor-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()});$("#ghash-reset").button({icons:{secondary:"ui-icon-refresh"}}).click(function(){Ua("confirm link code reset","If you have emailed a link to this graph or posted it on FaceBook or Twitter, those links will no longer work once the graph's link code is reset. Plese confirm to reset.",[{text:"Confirm",click:function(){$(this).dialog("close");$("#ghash-reset").button("disable");bi({command:"resetGhash",gid:e.gid},function(t,a,i){var n=$("#link-html");n.html(n.html().replace(e.ghash,t.ghash));e.ghash=t.ghash;$("#link-ghash").html(e.ghash)})}},{text:"Cancel",click:function(){$(this).dialog("close")}}])})});r.find(".searchability").buttonset().find("#"+t+"-private").button("option","icons",{primary:"ui-icon-locked"}).end().find("#"+t+"-searchable").button("option","icons",{primary:"ui-icon-search"}).end().find("input").click(function(){e.published=$(this).val();M()});if(e.start&&e.end){r.find(".rad-hard-crop").attr("checked",true)}else{if(e.intervals){r.find(".rad-interval-crop").attr("checked",true)}else{r.find(".rad-no-crop").attr("checked",true)}}var f=function(){var t=r.find(".crop-slider").slider("values");r.find(".rad-hard-crop").attr("checked",true);e.intervals=null;e.start=e.controls.chart.options.chart.x[t[0]];e.end=e.controls.chart.options.chart.x[t[1]];w()};var m=function(t){var a=$(t).slider("values");return gt(e.controls.chart.options.chart.x[a[0]],e.smallestPeriod)+" - "+gt(d.options.chart.x[a[1]],e.smallestPeriod)};r.find("div.crop-slider").slider({range:true,stop:function(){f()},change:function(){if(e.controls.chart){r.find(".crop-dates").html(m(this))}},slide:function(){r.find(".crop-dates").html(m(this))}});$("#"+t+"-rad-hard-crop").change(function(){f()});$("#"+t+"-rad-interval-crop").change(function(){if($(this).val()=="on"){var t=parseInt(r.find("input.interval-crop-count").val());if(!t||t<1){t=1;r.find("input.interval-crop-count").val(t)}e.intervals=t;e.start=null;e.end=null;w()}});$("#"+t+"-rad-no-crop").change(function(){e.intervals=null;e.start=null;e.end=null;e.minZoom=e.firstdt;e.maxZoom=e.lastdt;w()});r.find("input.interval-crop-count").spinner({min:1,incrementalType:false,stop:function(a,i){e.start=null;e.end=null;if(e.intervals!=parseInt($(this).val())){e.intervals=parseInt($(this).val());d=O(t,l);if(e.plots)l.build()}}});r.find("button.graph-crop").click(function(){var e=Qt[t];e.start=e.minZoom>e.firstdt?e.minZoom:e.firstdt;e.end=e.maxZoom<e.lastdt?e.maxZoom:e.lastdt;$(this).attr("disabled","disabled");_(t);$("#"+t+"-rad-hard-crop").click()});r.find("div.annotations fieldset").height(u-r.find("div.change-map").height()-r.find("div.crop-tool").height()-r.find("div.graph-type").height()-r.find("div.downloads").height()-r.find("div.sharing").height()-50);r.find("input.graph-publish").change(function(){e.published=this.checked?"Y":"N"});r.find("select.graph-type").val(e.type).change(function(){if($(this).val()=="logarithmic"){for(var t=0;t<d.yAxis.length;t++){if(d.yAxis[t].getExtremes().dataMin<=0){r.find("select.graph-type").val(e.type);Ua("Logarithmic scaling not available","Logarithmic Y-axis scaling is not allowed if negative values are present");return false}}}e.type=$(this).val();w()});function g(){var t,a,i,n="<option>"+e.map+"</option>",s=[];for(t in e.assets){if(t[0]=="M"&&e.assets[t].maps){for(i in e.assets[t].maps){if(i!=e.map){s.push(i)}}}}s.sort();for(a=0;a<s.length;a++){n+="<option>"+s[a]+"</option>"}return n}r.find("select.change-map").html(g()).change(function(){var t=$(this);var a=e.assets;delete e.assets;var i=e.calculatedMapData;delete e.calculatedMapData;delete e.assets;var n=e.controls;delete e.controls;var s=$.extend(true,{},e);e.assets=a;s.assets={};e.calculatedMapData=i;e.controls=n;s.map=$(this).val();s.mapFile=mapsList[$(this).val()].jvectormap;var o,r={};function l(t){var i;for(o=0;o<t.components.length;o++){if(I.test(t.components[o].handle)){i=a[t.components[o].handle];if(i.mapsetid&&mapsList[e.map].bunny&&mapsList[e.map].bunny==i.geoid){r[i.handle]={mapsetid:i.mapsetid,handle:i.handle}}else{s.assets[i.handle]=i}}}}if(s.plots){for(o=0;o<s.plots.length;o++){l(s.plots[o])}}if(s.pointsets){for(o=0;o<s.pointsets.length;o++){l(s.plots[o])}}if(s.mapsets){l(s.mapsets)}var d;function c(e,t,a,i,n){var s,o;for(s=0;s<e.components.length;s++){if(e.components[s].handle==t){e.components[s].handle=a.handle;if(e.options.name)e.options.name=e.options.name.replace(i,replacement)}}}bi({command:"ChangeMaps",bunnies:r,fromgeoid:mapsList[e.map].bunny,togeoid:mapsList[s.map].bunny,modal:"persist"},function(a,i,n){var r=new RegExp(a.regex);s.title=s.title.replace(r,a.replacement);for(d in a.bunnies){s.assets[a.bunnies[d].handle]=a.bunnies[d];if(d){if(s.plots){for(o=0;o<s.plots.length;o++){c(s.plots[o],d,a.bunnies[d],a.regex,a.replacement)}}if(s.pointsets){for(o=0;o<s.pointsets.length;o++){c(s.plots[o],d,a.bunnies[d],a.regex,a.replacement)}}if(s.mapsets){c(s.mapsets,d,a.bunnies[d],a.regex,a.replacement)}}}var l=["/global/js/maps/"+s.mapFile+".js"];require(l);R(s,function(){require(l,function(){nt(s);t.val(e.map)})})})});var b;v();function v(){if(e.plots){r.find("div.graph-type").show()}else{r.find("div.graph-type").hide()}if(e.mapsets||e.pointsets){r.find("div.change-map").show()}else{r.find("div.change-map").hide()}var t="";if(e.plots)t+='<option value="chart">chart</option>';if(e.mapsets||e.pointsets)t+='<option value="map" selected>map</option>';if(b=$t(e)){if(typeof e.mapconfig.cubeid=="undefined")e.mapconfig.cubeid="sum"}else{if(e.mapconfig.cubeid=="sum")delete e.mapconfig.cubeid}if(e.mapconfig.cubeid)t+='<option value="cube">supplemental bar chart</option>';$(".download-selector").html(t)}function w(){yi("redrawing");setTimeout(function(){pi(t);if(e.plots){bt(e);d=O(t,l);l.build();r.find("div.chart").show()}else{r.find("div.chart").hide();r.find("div.annotations").hide()}v();if(e.mapsets||e.pointsets){L();if(e.plots)r.find("map-title").hide();else r.find("map-title").show();r.find("select.change-map").html(g())}else{r.find("div.map").hide()}vi()},10)}r.find(".graph-analysis").keydown(function(){Qt[t].analysis=this.value;M()});e.isDirty=!e.gid;function M(){e.isDirty=true;r.find(".graph-save").button("enable")}function S(){e.isDirty=false;r.find(".graph-save").button("disable")}function D(){ii(e,p);r.find("button.graph-delete, button.graph-saveas").button("enable");S()}function A(a){switch(r.find("select.download-selector").val()){case"map":tt(t,a);break;case"chart":l.sync();d.exportChart({type:a,width:2e3});break;case"cube":e.controls.vizChart.exportChart({type:a,width:2e3});break}}r.find("button.graph-save").button({icons:{secondary:"ui-icon-disk"}}).button(e.userid==account.info.userid&&e.gid?"disable":"enable").click(D);r.find("button.graph-saveas").button({icons:{secondary:"ui-icon-copy"},disabled:!e.gid}).click(function(){delete e.gid;ot.show(this,D)});r.find("button.graph-close").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){$("ul#graph-tabs a[href=#"+t+"]").siblings("span").click()});r.find("button.graph-delete").button({icons:{secondary:"ui-icon-trash"},disabled:!e.gid}).addClass("ui-state-error").click(function(){Ua("Permanently Delete Graph","Are you sure you want to delete this graph?",[{text:"Delete",id:"btn-dia-enable",click:function(){deleteMyGraph(t);$(this).dialog("close")}},{text:"Cancel",id:"btn-dia-disable",click:function(){$(this).dialog("close")}}])});console.timeEnd("buildGraphPanel:thisPanel events");console.time("buildGraphPanel:provController");bt(e);Qt[t]=e;var U=new Dt(t);e.controls.provenance=U;console.timeEnd("buildGraphPanel:provController");if(e.plots){console.time("buildGraphPanel:build annoatations");d=O(t,l);l.build();_(t);console.timeEnd("buildGraphPanel:build annoatations");r.find("div.highcharts-container").mousedown(function(e){if(e.which==3){}})}else{r.find("div.chart").hide();r.find("div.annotations").hide()}var P=null,F,E,N;console.time("buildGraphPanel:drawMap");L();console.timeEnd("buildGraphPanel:drawMap");function L(){if(e.map&&(e.mapsets||e.pointsets)){if(P)P.remove();var a=($("div.graph-panel").height()-85-(e.plots?0:55))*(e.plots?.6:1);if(parseInt(e.mapconfig.cubeid)||e.mapconfig.cubeid=="sum"){r.find(".cube-viz").show().height(a);r.find(".jvmap").css("width","70%")}else{if(e.controls.vizChart){e.controls.vizChart.destroy();delete e.controls.vizChart}r.find(".cube-viz").hide();r.find(".jvmap").removeAttr("style")}i=J(e);K(e);if(G())S();var n=wt(e.pointsets);var s=xt(e.pointsets);var o=/us.._merc_en/.test(e.mapFile)?.9:1;F={map:e.mapFile,zoomMin:o,focusOn:{scale:o,x:.5,y:.5},backgroundColor:T,zoomOnScroll:true,markersSelectable:true,markerStyle:{initial:{r:5},selected:{"stroke-width":4,stroke:"yellow"}},regionStyle:{selected:{"stroke-width":2,stroke:"black",fill:"#ffff80"},hover:{"stroke-width":2,stroke:"black","fill-opacity":1}},series:{regions:[{attribute:"fill"}],markers:[{attribute:"r"},{attribute:"fill"},{attribute:"stroke"}]},onRegionLabelShow:function(e,t,a){var n,s=[],o=et(i.regionData,i.dates[E].s);if(i.regionColors){var r=et(i.regionColors,i.dates[E].s);if(r&&typeof r[a]!="undefined"){for(n=0;n<i.dates.length;n++){if(i.regionData[i.dates[n].s]&&typeof i.regionData[i.dates[n].s][a]!="undefined")s.push(i.regionData[i.dates[n].s][a])}var l=o[a];t.html("<div><b>"+i.title+": "+P.getRegionName(a)+"</b> "+Highcharts.numberFormat(l,parseInt(l)==l?0:2)+" "+(i.mapUnits||"")+'</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>').css("z-Index",400);var d={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true,width:Math.min(400,10*s.length)+"px"};if(s.length<10)d.type="bar";if(typeof l!="undefined"&&l!==null)d.valueSpots[l.toString()+":"+l.toString()]="red";if(s.length>1)$(".inlinesparkline").sparkline(s,d)}}},regionsSelectable:typeof e.mapsets!="undefined",markers:i.markers,onMarkerLabelShow:function(e,t,a){var n,s=[],o=et(i.markerData,i.dates[E].s);for(n=0;n<i.dates.length;n++){if(typeof i.markerData[i.dates[n].s]!="undefined")s.push(i.markerData[i.dates[n].s][a].r||i.markerData[i.dates[n].s][a].f)}if(o&&o[a]){var r,l=o[a].r;if(G()){var d=[],c=a.split("+");for(n=0;n<c.length;n++){d.push(P.getRegionName(c[n]))}r="<div><b>"+i.title+": "+d.join(" + ")+"</b> "}else{r="<div><b>"+t.html()+":</b> "}if(o[a].r)r+=Highcharts.numberFormat(o[a].r,parseInt(o[a].r)==o[a].r?0:2)+" "+(i.radiusUnits||"")+"<br>";if(o[a].f)r+=Highcharts.numberFormat(o[a].f,parseInt(o[a].f)==o[a].f?0:2)+" "+(i.fillUnits||"")+"<br>";r+='</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>';t.html(r).css("z-Index",400);var p={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true};p.valueSpots[l.toString()+":"+l.toString()]="red";$(".inlinesparkline").sparkline(s,p)
}},onRegionSelected:function(e,t,a){u(t,a);m();var n=P.getSelectedMarkers();if(n.length>0){r.find(".map-graph-selected, .make-map").button("enable");return}var s=P.getSelectedRegions();for(var o=0;o<s.length;o++){if(i.regionColors){for(var l in i.regionColors){if(typeof i.regionColors[l][s[o]]!="undefined"){r.find(".map-graph-selected, .make-map").button("enable");return}break}}}r.find(".map-graph-selected, .make-map").button("disable")},onMarkerSelected:function(e,t,a){F.onRegionSelected(e,t,a)},onZoom:function(e,t){transferTransform()}};E=i.endDateIndex;r.find("div.map").show();r.find("div.jvmap").show().height(a).vectorMap(F);P=r.find("div.jvmap").vectorMap("get","mapObject");e.controls.map=P;var l=$('<div class="map-date"></div>').prependTo(r.find("div.jvectormap-container"));var c=r.find("div.jvmap svg g:first");if(G()){A();P.series.regions[0].setAttributes(i.regionsColorsForBubbles);r.find("button.merge").show()}var p=r.find(".map-slider").show().off().slider({value:i.endDateIndex,min:i.startDateIndex,max:i.endDateIndex,step:1,change:function(t,a){E=a.value;if(!G()&&i.regionColors){P.series.regions[0].setAttributes(et(i.regionColors,i.dates[E].s))}if(e.pointsets){if(s){P.series.markers[0].setAttributes(et(i.markerAttr.r,i.dates[E].s));P.series.markers[2].setAttributes(et(i.markerAttr.stroke,i.dates[E].s))}if(n){P.series.markers[1].setAttributes(et(i.markerAttr.fill,i.dates[E].s))}}if(G()){P.series.markers[0].setAttributes(et(i.markerAttr.r,i.dates[E].s));P.series.markers[2].setAttributes(et(i.markerAttr.stroke,i.dates[E].s))}if(e.plots){var o=d.xAxis[0];o.removePlotLine("timeLine");o.addPlotLine({value:i.dates[E].dt,color:"red",width:2,id:"timeLine"})}u()}}).slider("value",i.endDateIndex);function u(t,a){console.time("cubeVizFromMap");if(parseInt(e.mapconfig.cubeid)||e.mapconfig.cubeid=="sum"){var n,s=i.dates[E].s;if(t){n=t}else{n=null;var o=P.getSelectedRegions();if(o.length>0){n=o[0]}else{var r=P.getSelectedMarkers();if(r.length>0){n=r[0]}else{n=mapsList[e.map].bunny}}}if(e.mapconfig.cubeid=="sum"){if(!isNaN(n))n="G"+n;var d=e.mapsets.options.calculatedFormula;var c=d.numFormula.replace("-","+-").split("+");var p=d.numFormula.replace("-","+").split("+");var u,h,m={},g=[],v,y=[],k,w={},x={};$.each(e.mapsets.components,function(t){u=e.assets[this.handle];g.push(u.name);k=Y(t);if(this.handle[0]=="M"){m[k]=u.data[n]?u.data[n].data:null}else{m[k]=u.data}g.push(u.name);x[k]=u.name});for(v=p.length-1;v>=0;v--){if(p[v].trim()=="")p.splice(v,0,1);else y.unshift(x[p[v].trim()].split(" "))}var C=[],M=true,S=true;while(M&&S){for(v=0;v<y.length;v++){while(y[v].length>0&&y[v][0]=="")y[v].shift();while(y[v].length>0&&y[v][y[v].length-1]=="")y[v].pop();if(y[v].length>0){if(y[v][0]!=y[0][0])M=false;if(y[v].length>1){if(y[v][y[v].length-1]!=y[0][y[0].length-1])S=false}}else{M=S=false;break}}if(M)C.unshift(y[0][0]);if(S)C.push(y[0][y[0].length-1]);for(v=0;v<y.length;v++){if(M)y[v].shift();if(S)y[v].pop()}}var D=[];e.assets.cube={dimensions:[{list:[]}]};var T=e.assets.cube;T.theme=C.join(" ");T.name="";T.units=lt(e,e.mapsets);T["G"+n]={facetedData:[]};for(v=0;v<y.length;v++){T.dimensions[0].list.push({name:y[v].join(" ")});T["G"+n].facetedData[v]=m[p[v].trim()]}}var A="new";if(b){if(t){A=a?"add":"remove"}else{A="summation"}}Mt(e,n,s,A);console.time("vizChart.redraw");if(!f&&A=="remove")e.controls.vizChart.redraw();console.timeEnd("vizChart.redraw")}l.html(gt(i.dates[E].dt.getTime(),i.period));console.timeEnd("cubeVizFromMap")}if(e.mapconfig.showList){v(P)}r.find(".map-graph-selected").button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var t=P.getSelectedRegions();var a=P.getSelectedMarkers();var n=W(),s,o,r,l,d,c,p,u,h,f,m,g,b,v;n.plots=[];n.title="from map of "+e.title;for(r=0;r<a.length;r++){if(G()){s=$.extend(true,{},e.mapsets);delete s.formula;delete s.options.calculatedFormula;f=s.components;s.components=[];p=a[r].split("+");u=[];for(l=0;l<p.length;l++){u.push(P.getRegionName(p[l]));for(d=0;d<f.length;d++){if(f[d].handle[0]=="M"){b=$.extend({units:e.assets[f[d].handle].units,period:e.assets[f[d].handle].period},e.assets[f[d].handle].data[p[l]]);g=$.extend(true,{},f[d]);g.handle=b.handle;n.assets[b.handle]=b;s.components.push(g)}else{s.components.push($.extend(true,{},f[d]));n.assets[f[d].handle]=e.assets[f[d].handle]}}}s.options.name=rt(e,e.mapsets)+" for "+u.join("+");n.plots.push(s)}else{for(c=0;c<e.pointsets.length;c++){h=$.extend(true,{},e.pointsets[c]);v=false;m=h.components;for(d=0;d<m.length;d++){if(m[d].handle[0]=="X"&&e.assets[m[d].handle].data[a[r]]){v=true;sHandle=e.assets[m[d].handle].data[a[r]].handle;n.assets[sHandle]=$.extend({units:e.assets[m[d].handle].units,period:e.assets[m[d].handle].period},e.assets[m[d].handle].data[a[r]]);m[d].handle=sHandle}else{n.assets[m[d].handle]=e.assets[m[d].handle]}}if(v)n.plots.push(h)}}}if(e.mapsets&&e.mapsets){for(r=0;r<t.length;r++){for(var y in i.regionData){if(typeof i.regionColors[y][t[r]]!="undefined"){s=$.extend(true,{},e.mapsets);for(l=0;l<s.components.length;l++){if(s.components[l].handle.substr(0,1)=="M"){var k=e.assets[s.components[l].handle];var w=$.extend(true,{name:k.geoname,period:k.period,units:k.units,mapsetid:s.components[l].handle.substr(1)},k.data[t[r]]);s.components[l].handle=w.handle;n.assets[w.handle]=w}else{n.assets[s.components[l].handle]=$.extend(true,{},e.assets[s.components[l].handle])}}if(s.name)s.name+=" - "+P.getRegionName(t[r]);n.plots.push(s)}break}}}if(n.plots.length>0)ja(n,true)});var h=r.find(".map-play");h.off().click(function(){var e,t,a,n=Math.min(1e4/i.dates.length,500);if(h.attr("title")=="play"){h.button({text:false,icons:{primary:"ui-icon-pause"}}).attr("title","pause");s()}else{h.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}function s(){if(h.attr("title")=="pause"){e=new Date;var o=p.slider("value")+1;if(o>i.endDateIndex)o=i.startDateIndex;p.slider("value",o);t=new Date;a=Math.max(1,n-(t.getTime()-e.getTime()));if(o==i.endDateIndex){h.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}else{if(h.attr("title")=="pause"){window.setTimeout(s,a)}}}}}).button({text:false,icons:{primary:"ui-icon-play"}});r.find(".map-step-backward").off().click(function(){p.slider("value",p.slider("value")-1)}).button({text:false,icons:{primary:"ui-icon-seek-first"}});r.find(".map-step-forward").off().click(function(){p.slider("value",p.slider("value")+1)}).button({text:false,icons:{primary:"ui-icon-seek-end"}});if(e.plots)r.find("h3.map-title").hide();else r.find("h3.map-title").html(e.title).click(function(){ot.show(this)});var f=false;r.find(".make-map").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"}}).off().click(function(){f=true;P.clearSelectedMarkers();P.clearSelectedRegions();f=false;if(e.controls.vizChart)e.controls.vizChart.redraw();r.find(".map-graph-selected, .make-map").button("disable")});function m(){var t,a,i;N={newMerge:false,growable:false,splinter:false,ungroupable:false};if(!G())return;var n=P.getSelectedMarkers();var s=P.getSelectedRegions();for(t=0;t<n.length;t++){if(n[t].split("+").length>1){N.ungroupable=true;break}}if(e.mapsets.options.merges){for(t=0;t<s.length;t++){for(a=0;a<e.mapsets.options.merges.length;a++){if(e.mapsets.options.merges[a].indexOf(s[t])>=0){N.ungroupable=true;break}}}}if(n.length>1){N.growable=true}else{if(n.length==1){i=n[0].split("+");for(t=0;t<s.length;t++){if(i.indexOf(s[t])==-1){N.growable=true;break}}}else{if(s.length>1){if(N.ungroupable){N.growable=true}else{N["newMerge"]=true}}}}r.find("button.group").button(N.newMerge||N.growable?"enable":"disable");r.find("button.ungroup").button(N.ungroupable?"enable":"disable")}r.find("button.group").button({icons:{secondary:"ui-icon-circle-plus"}}).off().click(function(){if(N.newMerge){if(!e.mapsets.options.merges)e.mapsets.options.merges=[];e.mapsets.options.merges.push(P.getSelectedRegions())}if(N.growable){var t,a,n=[];var s=P.getSelectedMarkers();var o=P.getSelectedRegions();for(t=0;t<s.length;t++){n=n.concat(s[t].split("+"));if(s[t].split("+").length>1){for(a=0;a<e.mapsets.options.merges.length;a++){if(s[t]==e.mapsets.options.merges[a].join("+")){e.mapsets.options.merges.splice(a,1);break}}}}for(t=0;t<o.length;t++){for(a=0;a<e.mapsets.options.merges.length;a++){if(e.mapsets.options.merges[a].indexOf(o[t])>-1){n=n.concat(e.mapsets.options.merges.splice(a,1)[0]);break}}}for(t=0;t<o.length;t++){if(n.indexOf(o[t])==-1)n.push(o[t])}e.mapsets.options.merges.push(n)}P.removeAllMarkers();P.clearSelectedRegions();S();A();P.series.markers[0].setAttributes(et(i.markerAttr.r,i.dates[E].s));P.series.markers[2].setAttributes(et(i.markerAttr.stroke,i.dates[E].s));P.series.regions[0].setAttributes(i.regionsColorsForBubbles);M()});r.find("button.ungroup").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).off().click(function(){var t,a;var n=P.getSelectedMarkers();var s=P.getSelectedRegions();for(t=0;t<n.length;t++){if(n[t].split("+").length>1){for(a=0;a<e.mapsets.options.merges.length;a++){if(n[t]==e.mapsets.options.merges[a].join("+")){e.mapsets.options.merges.splice(a,1);break}}}}for(t=0;t<s.length;t++){for(a=0;a<e.mapsets.options.merges.length;a++){pos=e.mapsets.options.merges[a].indexOf(s[t]);if(pos!=-1){e.mapsets.options.merges[a].splice(pos,1);if(e.mapsets.options.merges[a].length==0){e.mapsets.options.merges.splice(a,1)}break}}}P.removeAllMarkers();P.clearSelectedRegions();S();A();P.series.markers[0].setAttributes(et(i.markerAttr.r,i.dates[E].s));P.series.markers[2].setAttributes(et(i.markerAttr.stroke,i.dates[E].s));P.series.regions[0].setAttributes(i.regionsColorsForBubbles);M()});var g;if(e.mapconfig.showLegend)g=w(P);r.find(".legend").change(function(){e.mapconfig.showLegend=$(this).prop("checked");M();if(e.mapconfig.showLegend){g=w(P)}else{g.remove()}});r.find("input.map-list").change(function(){e.mapconfig.showList=$(this).prop("checked");M();if(e.mapconfig.showList){v(P)}else{r.find("div.map-list").remove()}});if(e.mapconfig.showList)v(P)}function v(a){var n=[],s,o,l;if(r.find("div.map-list").length==0){r.find("div.jvectormap-container").prepend('<div class="map-list">'+'<div class="order">'+'<input type="radio" id="'+t+'-map-list-order-asc" name="'+t+'-map-list-order" value="asc" '+(e.mapconfig.listOrder!="desc"?"checked":"")+'><label for="'+t+'-map-list-order-asc">ascending</label>'+'<input type="radio" id="'+t+'-map-list-order-desc" name="'+t+'-map-list-order" value="desc" '+(e.mapconfig.listOrder=="desc"?"checked":"")+'><label for="'+t+'-map-list-order-desc">descending</label>'+"</div>"+'<button class="download-map-list">download list to Excel</button>'+"</div>").find("div.map-list .download-map-list").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var t=r.find("div.map-list table").get(0);var a=[];for(var i=0;i<t.rows.length;i++){a.push([t.rows[i].cells[0].innerHTML.replace("<br>",""),t.rows[i].cells[1].innerHTML,t.rows[i].cells[2].innerHTML])}it({filename:e.title,data:JSON.stringify([{name:"ranked list",grid:a}]),url:"excel.php"})}).end().find("div.map-list div.order").buttonset().find("input:radio").click(function(){e.mapconfig.listOrder=$(this).val();v(P)})}if(e.mapsets){o=i.mapUnits;var d=et(i.regionData,i.dates[E].s);for(s in d){if(d[s]!==null){n.push({name:P.getRegionName(s),value:d[s]})}}}else{if(i.fillUnits){o=i.fillUnits;l="f"}else{o=i.radiusUnits;l="r"}var c=et(i.markerData,i.dates[E].s);for(s in c){if(c[s][l]!==null){n.push({name:i.markers[s].name,value:c[s][l]})}}}n.sort(function(t,a){return(e.mapconfig.listOrder=="desc"?-1:1)*(a.value-t.value)});var p="<table><thead><th>Rank <br>"+r.find("div.map-date").html()+"</th><th>"+i.title+"</th><th>"+o+"</th></thead><tbody>";for(var u=0;u<n.length;u++){p+="<tr><td>"+(u+1)+"</td><td>"+n[u].name+"</td><td>"+n[u].value+"</td></tr>"}p+="</tbody></table>";r.find("div.map-list").find("table").remove().end().append(p).show()}function w(t){var a=10,i=5,n=20,s=10,o,l,d=0,c=0,p=0,u,h,f,m=20;if(e.mapsets&&!G()){if(e.mapsets.options.scale=="discrete"){l=185;d=n+2*s+e.mapsets.options.discreteColors.length*(s+20)}else{l=100;if(e.calculatedMapData.regionMin<0&&e.calculatedMapData.regionMax>0){d=6*s+2*80+4*n}else{d=4*s+80+3*n}}}else l=0;var g=xt(e.pointsets),b=wt(e.pointsets);if(e.pointsets||G()){o=185;if(g>1&&b==0){c+=g*(s+2*a)+(c==0?s:0)}if(g>0||G()){var v=parseInt(e.mapconfig.maxRadius)||k;var w=+v/Math.sqrt(10);c+=2*(s+Math.max(v,15)+w)+(c==0?s:0)}}else o=0;var x=t.canvas.addGroup();t.canvas.addCircle({cx:0,cy:0},{initial:{r:20,"fill-opacity":0,"stroke-width":0}},x);r.append('<div id="dummyLegend" class="hidden"></div>');var C=new Highcharts.Renderer($("#dummyLegend")[0],t.width,t.height);C.box=x.node;$("#dummyLegend").remove();var M=e.mapconfig.legendLocation||mapsList[e.map].legend||"TR";switch(M.substr(0,1)){case"T":h=s;break;case"C":h=(t.height-Math.max(c,d))/2-s;break;case"B":h=t.height-Math.max(c,d)-s}switch(M.substr(1,1)){case"L":f=s;if(M.substr(0,1)=="T")f+=30;break;case"C":f=(t.width-l-o)/2-s;break;case"R":f=t.width-l-o-s}C.rect(f,h,o+l,Math.max(c,d),5).attr({fill:"white",opacity:.5,"stroke-width":0}).add();var S={opacity:1,"stroke-width":0,"z-index":1e3};function D(e,t,a,i){var n,s,o,r,l,d,c,p,u;n=parseInt(a.substr(1,2),16);s=parseInt(a.substr(3,2),16);o=parseInt(a.substr(5,2),16);r=parseInt(i.substr(1,2),16);l=parseInt(i.substr(3,2),16);d=parseInt(i.substr(5,2),16);for(var h=0;h<40;h++){c=Math.round(n-(n-r)*h/39).toString(16);p=Math.round(s-(s-l)*h/39).toString(16);u=Math.round(o-(o-d)*h/39).toString(16);C.rect(e,t+2*h,20,2,0).attr({fill:"#"+(c.length==1?"0":"")+c+(p.length==1?"0":"")+p+(u.length==1?"0":"")+u,opacity:1,"stroke-width":0,"z-index":1e3}).add()}}if(e.pointsets||G()){if(g>1&&b==0){$.each(e.pointsets,function(t){if(this.options.attribute!="fill"){p=(t+1)*(s+2*a)-a;C.circle(f+s+a,h+p,Math.min(v,a)).attr({fill:this.options.color,opacity:1,"fill-opacity":1,stroke:"black","stroke-width":1}).add();C.text(rt(e,e.pointsets[t]).substring(0,m),f+2*(s+a),h+p).add()}p+=a})}if(g>0||G()){p+=s+(w||5);var T={"fill-opacity":0,opacity:1,stroke:"black","stroke-width":1};C.circle(f+s+v,h+p,w).attr(T).add();C.text(Ct((e.calculatedMapData.radiusScale||e.calculatedMapData.markerDataMax)/10),f+2*(v+s),h+p).css({fontSize:"12px"}).add();p+=(w||5)+s+v;C.circle(f+s+v,h+p,v).attr(T).add();C.text(Ct(e.calculatedMapData.radiusScale||e.calculatedMapData.markerDataMax),f+2*(v+s),h+p).css({fontSize:"12px"}).add();C.text(e.calculatedMapData.radiusUnits,f+2*(v+s),h+p+2*s).css({fontSize:"12px"}).add()}}if(e.mapsets&&!G()){C.text(lt(e,e.mapsets).substr(0,25),f+s,h+n+i).css({fontSize:"12px"}).add();if(e.mapsets.options.scale!="discrete"&&e.mapsets.options.logMode=="on")C.text("logarymic scale",f+s,h+2*n).css({fontSize:"12px"}).add();if(e.mapsets.options.scale=="discrete"){for(u=0;u<e.mapsets.options.discreteColors.length;u++){p=s+(e.mapsets.options.discreteColors.length-u)*(s+20);C.rect(f+o+s,h+p,n,n,0).attr({fill:e.mapsets.options.discreteColors[u].color,opacity:1,stroke:"black","stroke-width":1}).add();C.text((u==e.mapsets.options.discreteColors.length-1?"&gt; ":" ")+e.mapsets.options.discreteColors[u].cutoff,f+o+s+n+s,h+p+n/2+i).css({fontSize:"12px"}).add()}}else{p+=2*n;C.text(Ct(e.calculatedMapData.regionMax),f+o+s,h+p+n/2+i).css({fontSize:"12px"}).add();p+=n+s;if(e.calculatedMapData.regionMax>0){D(f+o+s,h+p,e.mapsets.options.posColor||y.POS,y.MID);p+=80+s;if(e.calculatedMapData.regionMin<0){C.text("0",f+o+s,h+p+n/2+i).css({fontSize:"12px"}).add();p+=n+s}}if(e.calculatedMapData.regionMin<0){D(f+o+s,h+p,y.MID,e.mapsets.options.negColor||y.NEG);p+=80+s}C.text(Ct(e.calculatedMapData.regionMin),f+o+s,h+p+n/2+i).css({fontSize:"12px"}).add();p+=n+s}}return x}function S(){var t,a,n,s=C.concat(x);i.regionsColorsForBubbles={};i.markers={};var o={x:100,y:100};if(G()){var r,l,d=0,c,p,u=[];var h,f,m={},g={r:{},stroke:{}};for(c=i.startDateIndex;c<=i.endDateIndex;c++){t=i.dates[c].s;m[t]={};g.r[t]={};g.stroke[t]={}}i.markerDataMin=Number.MAX_VALUE;i.markerDataMax=Number.MIN_VALUE;if(e.mapsets.options.merges){for(d=0;d<e.mapsets.options.merges.length;d++){h=e.mapsets.options.merges[d];f=h.join("+");n=i.title+" for "+f;i.markers[f]={name:f,point:o,style:{fill:"pink"}};for(c=i.startDateIndex;c<=i.endDateIndex;c++){l=0;for(p=0;p<h.length;p++){l+=i.regionData[i.dates[c].s][h[p]]||0}m[i.dates[c].s][f]={r:l};if(l!==null){i.markerDataMin=Math.min(i.markerDataMin,l);i.markerDataMax=Math.max(i.markerDataMax,l)}}for(p=0;p<h.length;p++){i.regionsColorsForBubbles[h[p]]=s[d%s.length]}u=u.concat(h)}}for(r in i.regionData[i.dates[0].s]){if(u.indexOf(r)==-1&&typeof i.regionData[i.dates[0].s][r]!="undefined"){i.markers[r]={name:r,point:o,style:{fill:"pink"}};i.regionsColorsForBubbles[r]=s[d++%s.length];for(c=i.startDateIndex;c<=i.endDateIndex;c++){t=i.dates[c].s;m[t][r]={r:i.regionData[t][r]};if(m[t][r].r!==null&&!isNaN(m[t][r].r)){i.markerDataMin=Math.min(i.markerDataMin,m[t][r].r);i.markerDataMax=Math.max(i.markerDataMax,m[t][r].r)}}}}var b=(e.mapconfig.maxRadius||k)/Math.sqrt(Math.max(Math.abs(i.markerDataMax),Math.abs(i.markerDataMin)));for(t in m){for(a in m[t]){rData=m[t][a].r||null;g.r[t][a]=b*Math.sqrt(Math.abs(rData));g.stroke[t][a]=rData<0?"#ff0000":"#000000"}}i.markerData=m;i.markerAttr=g;i.radiusUnits=i.mapUnits}}function D(t){var a,i=0,n=0,s=0,o,r,l;for(var d=0;d<t.length;d++){l=null;$.each(e.mapsets.components,function(a,i){if(e.assets[i.handle].data[t[d]]&&i.handle[0]=="M"&&e.assets[i.handle].data[t[d]].latLon){l=e.assets[i.handle].data[t[d]].latLon.split(",")}});a=c.find("path[data-code="+t[d]+"]").get(0).getBBox();if(l){r=P.latLngToPoint(l[0],l[1]);n+=(r.x-P.transX)*a.width*a.height/P.scale;s+=(r.y-P.transY)*a.width*a.height/P.scale}else{n+=(a.x+a.width/2)*a.width*a.height;s+=(a.y+a.height/2)*a.width*a.height}i+=a.width*a.height}o={x:(n/i+P.transX)*P.scale,y:(s/i+P.transY)*P.scale};return o}function A(){var t,a;if(G()){var n,s=0,o,r=[];if(e.mapsets.options.merges){for(s=0;s<e.mapsets.options.merges.length;s++){t=D(e.mapsets.options.merges[s]);a=P.pointToLatLng(t.x,t.y);i.markers[e.mapsets.options.merges[s].join("+")].latLng=[a.lat,a.lng];r=r.concat(e.mapsets.options.merges[s])}}c.find("path[data-code]").each(function(){n=$(this).attr("data-code");if(r.indexOf(n)==-1&&typeof i.regionData[i.dates[0].s][n]!="undefined"){t=D([n]);a=P.pointToLatLng(t.x,t.y);i.markers[n].latLng=[a.lat,a.lng]}});P.addMarkers(i.markers)}}}function G(){return e.mapsets&&e.mapsets.options.mode&&e.mapsets.options.mode=="bubble"}console.timeEnd("buildGraphPanel: "+t);vi();mi(e.ghash,r.get(0).id)}var ot={template:'<div id="dwrap2">'+'<div id="titleEditor" style="width: 560px">'+'<input type="text" width="300px" name="title" /> '+'<button id="graph-title-change-ok">OK</button> '+'<button id="graph-title-change-cancel">cancel</button>'+"</div>"+"</div>",show:function(e,t){var a=this;$.fancybox(this.template,{width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none",left:"55px",top:"55px"});$("#fancybox-wrap").stop().css({top:"70px"});$("#graph-title-change-ok").click(a.changeOk);$("#graph-title-change-cancel").click(a.changeCancel);var i=$(e).closest("div.graph-panel").get(0).id;$("#titleEditor input").keyup(function(e){if(e.keyCode==13)a.changeOk()}).attr("data",i).val(Qt[i].title).css("width","450px").focus();this.callback=t},callBack:false,changeOk:function(){var e=$("#titleEditor input").attr("data");var t=$("#titleEditor input").val().trim();var a=Qt[e];if(t!=a.title){a.title=t||"untitled";if(a.plots){if(a.title.length==0){a.controls.chart.setTitle({text:"untitled - click to edit",style:{color:"grey",font:"italic"}})}else{a.controls.chart.setTitle({text:a.title,style:{color:"black",font:"normal"}})}$("#"+e+" .highcharts-title").click(function(){ot.show(this)})}var i=t||"Graph "+e.substr(e.indexOf("-")+1);$("#graph-tabs a[href='#"+e+"']").attr("title",i).html(i);$("#"+e+" h3.map-title").html(a.title);if(a.title.length==0){if(this.callback)this.callback()}}this.changeCancel()},changeCancel:function(){$.fancybox.close();this.callBack=false}};function rt(e,t,a){var i,n,s,o="";if(typeof t.options.name!="undefined"&&t.options.name!=""&&!a){return t.options.name}else{var r=false;for(s=0;s<t.components.length;s++){n=t.components[s];i=n.handle;o+=(s!=0&&n.options.op?n.options.dn=="d"&&!r?" / ":" "+n.options.op+" ":" ")+e.assets[i].name;r=n.options.dn=="d"||r}return o}}function lt(e,t,a,i){var n,s,o,r="",l="";if(t.components.length==1){return t.options.units||(t.components[0].op=="/"?"per ":"")+(e.assets[t.components[0].handle].units||"")}if(!t.options.units||a){if(!i)i=V(t);var d=i.numFormula;var c=i.denomFormula;y("^(-)?(1)?","");var p=/[0-9]+/g;var u=p.test(d)||p.test(c);d=d.replace(p," ");c=c.replace(p," ");var h=/(\*|\(|\))/g;d=d.replace(h," ");c=c.replace(h," ");var f=/\//g;d=d.replace(f," per ");c=c.replace(f," per ");var m=/-/g;d=d.replace(m,"+");c=c.replace(m,"+");var g=/[\s]+/g;d=d.replace(g," ");c=c.replace(g," ");y("([A-Z]+)","{{$1}}");var b=/\+/g;for(n=0;n<t.components.length;n++){y("{{"+Y(n)+"}}",(e.assets[t.components[n].handle].units||"").replace(b," "))}var v=false;if(d!=""){o=d.split("+");d=o[0].trim();for(s=1;s<o.length;s++){if(o[s].trim()!=d)v=true}}if(c!=""){o=c.split("+");l=o[0].trim();for(s=1;s<o.length;s++){if(o[s].trim()!=o[0])v=true}}if(v){return"potentially mismatched units"}else{if(d==l&&d.length>0){return"ratio"}else{return(u?"user scaled ":"")+d+(l==""?"":" per "+l)}}}else{return t.options.units}function y(e,t){var a=new RegExp(e,"g");d=d.replace(a,t);l=l.replace(a,t)}}function dt(e){var t=$(e).closest("div.graph-panel:visible");if(t.length==1){return t.get(0).id}else{return null}}function ct(){var e=$("div.graph-panel:visible");if(e.length==1){return e.get(0).id}else{return null}}function pt(e){var t,a=new Date(e+" UTC");if(a.toString()!="NaN")return a;t=/^W[0-5]{0-1}[0-9]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*6)}return false}function ut(e){var t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"A";t=/^\s*[0-9]{4}[ -]{1}[0-2]{0-1}[0-9]{1-2}\s*$/i;if(t.test(e))return"M";t=/^\s*(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[ -]{1}[0-9]{4}\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}[ -]{1}(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"D";t=/^\s*W[0-5]{0-1}[0-9]{1} [0-9]{4}\s*$/i;if(t.test(e))return"W";t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e))return"Q";t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e))return"H";return false}function ht(e){var t=e.replace(/\s+/," ").match(/\b.+\b/);if(t===null)return"";else return t[0]}function ft(e,t){switch(t){case"A":return e.setUTCFullYear(e.getUTCFullYear()+1);case"Q":return e.setUTCMonth(e.getUTCMonth()+3);case"SA":return e.setUTCMonth(e.getUTCMonth()+6);case"M":return e.setUTCMonth(e.getUTCMonth()+1);case"W":return e.setUTCDate(e.getUTCDate()+6);case"D":return e.setUTCDate(e.getUTCDate()+1);default:return null}}var mt=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function gt(e,t){if(isNaN(e)==false&&e!==null){var a=new Date(parseInt(e));switch(t){case"A":return a.getUTCFullYear();case"Q":return"Q"+parseInt((a.getUTCMonth()+3)/3)+" "+a.getUTCFullYear();case"SA":case"M":return mt[a.getUTCMonth()]+" "+a.getUTCFullYear();case"W":case"D":return a.getUTCDate()+" "+mt[a.getUTCMonth()]+" "+a.getUTCFullYear();default:return a.toUTCString().substr(5,20)}}else{return"-"}}function bt(e){e.smallestPeriod="A";e.largestPeriod="N";var t,a,i,n,s;yt(e,function(){if(!e.assets[this.handle].firstdt&&(this.handle.charAt(0)=="M"||this.handle.charAt(0)=="X")){for(n in e.assets[this.handle].data){i=e.assets[this.handle].data[n].firstdt;e.assets[this.handle].firstdt=Math.min(e.assets[this.handle].firstdt,i)||i;i=e.assets[this.handle].data[n].lastdt;e.assets[this.handle].lastdt=Math.max(e.assets[this.handle].lastdt,i)||i}}i=e.assets[this.handle].firstdt;t=Math.min(i,t)||i||t;i=e.assets[this.handle].lastdt;a=Math.max(i,a)||i||t});if(e.plots){$.each(e.plots,function(){var t=this.options.fdown||e.assets[this.components[0].handle].period;if(S.value[e.smallestPeriod]>S.value[t])e.smallestPeriod=t;if(S.value[e.largestPeriod]<S.value[t])e.largestPeriod=t})}e.firstdt=t;e.lastdt=a;e.minZoom=e.start||e.firstdt;e.maxZoom=e.end||e.lastdt}function vt(e){var t=[];$.each(e,function(){if(this.options&&this.options.color)t.push(this.options.color)});var a=x.concat(C);for(var i=0;i<a.length;i++){if(t.indexOf(a[i])==-1)return a[i]}return a[e.length%a.length]}function yt(e,t){kt(e,function(){var e=this;$.each(e.components,function(a){t.call(this,a,e)})})}function kt(e,t){if(e.mapsets)t.call(e.mapsets);if(e.pointsets)$.each(e.pointsets,function(a){t.call(this,a,e.pointsets[a])});if(e.plots)$.each(e.plots,function(a){t.call(this,a,e.plots[a])})}function wt(e){var t=0;if(e instanceof Array){t=e.length-xt(e)}return t}function xt(e){var t=0;if(e instanceof Array){$.each(e,function(){if(this.options.attribute!="fill")t++})}return t}function Ct(e){var t=Math.floor(Math.log(Math.abs(e))/Math.LN10);var a=Math.round(e/Math.pow(10,t-2))*Math.pow(10,t-2);return Highcharts.numberFormat(a,t>1?0:2-t)}function Mt(e,t,a,i){if(typeof i=="undefined")i="new";var n,s,o,r,l=e.mapconfig.cubeid;if(!e.assets.cube)e.assets.cube={};var d=e.assets.cube;if(!d["G"+t]){var c=e.controls.$thisPanel.find("div.cube-viz");c.mask("loading...");bi({command:"GetCubeSeries",cubeid:l,geokey:t,modal:"none"},function(e,a,i){d["G"+t]={series:e.series};d.dimensions=e.dimensions;d.theme=e.theme;d.name=e.name;d.units=e.units;c.unmask();p()})}else{p()}function p(){var l=d.dimensions;var c=l.length;var p=null;if(isNaN(t)){yt(e,function(){if(!p){if(this.handle[0]=="M"&&e.assets[this.handle].data[t])p=e.assets[this.handle].data[t].geoname}})}else{p=e.map}var u=d["G"+t];if(u.series){var h=u.series;u.facetedData=[];function f(e,t,a){var i,n;for(i=0;i<l[e].list.length;i++){if(e==c-1){n=a.slice();n.push(l[e].list[i]);t.push(o(n))}else{var s=[];t.push(s);n=a.slice();n.push(l[e].list[i]);f(e+1,s,n)}}function o(e){var t,a,i;for(t=0;t<h.length;t++){a=true;i=h[t];for(var n=0;n<c;n++){if(i.name.toLowerCase().indexOf(" "+e[n].name.toLowerCase())===-1){a=false;break}}if(a){h.splice(t,1);return i.data}}return null}}f(0,u.facetedData,[]);delete u.series}var m={chart:{type:"bar",spacingRight:50,renderTo:e.controls.$thisPanel.find(".cube-viz")[0]},title:{text:d.theme+"<br>"+(p||""),style:{fontSize:"12px"}},subtitle:{text:"click on map to select location",style:{fontSize:"10px"},y:p?50:30},plotOptions:{bar:{dataLabels:{enabled:false,align:"left"},borderWidth:0,animation:false,stacking:null}},xAxis:{categories:[],title:{text:null},lineWidth:1,minorGridLineWidth:0,labels:{enabled:true},minorTickLength:0,tickLength:0},yAxis:{title:{text:d.units||""},labels:{enabled:false},lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",gridLineColor:"transparent",gridLineWidth:0},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false,type:"image/png",url:"https://www.mashabledata.com/workbench/export/index.php"},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{formatter:function(){return"<b>"+d.theme+"</b><br/>"+this.point.name+":<br/>"+Highcharts.numberFormat(Math.abs(this.point.y),0)+" "+d.units}}};var g=u.facetedData;var b,v;switch(c){case 1:barData=[];for(s=0;s<l[0].list.length;s++){b={y:St(g[s],a),name:l[0].list[s].name};if(l[0].list[s].color)b.color=l[0].list[s].color;barData.push(b);m.xAxis.categories.push(l[0].list[s].short||l[0].list[s].name)}m.series.push({id:t,name:p,data:barData,showInLegend:false});m.plotOptions.bar.dataLabels.enabled=true;break;case 2:for(s=0;s<l[0].list.length;s++){barData=[];for(o=0;o<l[1].list.length;o++){if(s==0)m.xAxis.categories.push(l[1].list[o].short||l[1].list[o].name);b={y:St(g[s][o],a),name:l[0].list[s].name+"<br>and "+l[1].list[o].name};barData.push(b)}n={name:l[0].list[s].name,data:barData};if(l[0].list[s].color)n.color=l[0].list[s].color;m.series.push(n);m.plotOptions.bar.stacking="normal"}break;case 3:for(s=0;s<l[0].list.length;s++){for(r=0;r<l[2].list.length;r++){barData=[];for(o=0;o<l[1].list.length;o++){if(s==0&&r==0)m.xAxis.categories.push(l[1].list[o].short||l[1].list[o].name);b={y:(s==0?-1:1)*St(g[s][o][r],a),name:l[0].list[s].name+"<br>and "+l[1].list[o].name+"<br>and "+l[2].list[r].name};barData.push(b)}n={name:l[2].list[r].name,data:barData};if(l[2].list[r].color)n.color=l[2].list[r].color;m.series.push(n)}}m.legend.enabled=false;m.plotOptions.bar.stacking="normal";m.xAxis.lineWidth=0;break}switch(i){case"add":m.series[0].showInLegend=true;e.controls.vizChart.addSeries(m.series[0]);break;case"remove":e.controls.vizChart.get(t).remove(false);break;case"summation":m.series[0].pointWidth=1;m.series[0].pointPadding=0;m.plotOptions.bar.groupPadding=0;default:if(e.controls.vizChart)e.controls.vizChart.destroy();e.controls.vizChart=new Highcharts.Chart(m)}}}function $t(e){if(!e.mapsets)return false;if(!e.mapsets.options.calculatedFormula)V(e.mapsets);var t=e.mapsets.options.calculatedFormula;for(var a=0;a<e.mapsets.components.length;a++){if(e.mapsets.components[a].handle[0]!="M")return false}return/[-+]/.test(t.numFormula)&&!/[*/]/.test(t.numFormula)}function St(e,t){if(!e)return null;var a,i=e.split("||");for(var n=0;n<i.length;n++){a=i[n].split("|");if(a[0]==t){if(a[1]=="null")return null;else return parseFloat(a[1])}}return null}function Dt(e){var t,a;var i={HTML:{compMath:'<div class="edit-block">'+'<div class="edit-math">'+'<input type="radio" id="required-'+e+'" name="comp-math-'+e+'" data="compMath"  value="required"/><label for="required-'+e+'">all values required else null</label>'+'<input type="radio" id="missingAsZero-'+e+'" name="comp-math-'+e+'" data="compMath"  value="missingAsZero"/><label for="missingAsZero-'+e+'">use zero for missing values</label>'+'<input type="radio" id="nullsMissingAsZero-'+e+'" name="comp-math-'+e+'" data="compMath" value="nullsMissingAsZero"/><label for="nullsMissingAsZero-'+e+'">use zero for missing and null values</label>'+"</div>"+"</div>"},graph:Qt[e],$prov:$("#"+e+" .provenance"),isDirty:false,build:function s(e){var i=this;var n,s,o,r,l,d;i.$prov.show();d='<button class="config-cancel">cancel edits</button>';o="";if(typeof e!="undefined"){if(i.$prov.find(".chart-plots").length==0)i.$prov.find(".config-cancel").after('<div class="chart-plots"><H4>Chart</H4><ol class="plots"></ol></div');i.$prov.find("ol.plots").append(i.plotHTML(e))}else{if(i.graph.plots)i.plotsEdits=$.extend(true,[],i.graph.plots);i.annoEdits=$.extend(true,[],i.graph.annotations);if(i.graph.mapsets)i.mapsetEdits=$.extend(true,{},i.graph.mapsets);if(i.graph.pointsets)i.pointsetsEdits=$.extend(true,[],i.graph.pointsets);i.mapconfigEdits=$.extend(true,{},i.graph.mapconfig);if(i.plotsEdits){o='<div class="chart-plots"><H4>Chart</H4><ol class="plots">';for(n=0;n<i.plotsEdits.length;n++){o+=i.plotHTML(n)}}o+="</ol>"+'<ol class="blank-plot landing components" style=""><li class="not-sortable">Drag and drop to plot lines to reorder them.  Drag and drop multiple series into a plot to create sums and ratios. Drag a series here to create a new plot line.</i></li></ol></div>';r=i.provenanceOfMap();i.$prov.html(d+o+r);if(i.mapsetEdits)t=this.legendEditor(i.$prov.find(".mapset-colors"),this.mapsetEdits.options,"M");if(i.pointsetsEdits){a=this.legendEditor(i.$prov.find(".pointsets-colors"),this.mapconfigEdits,"X");if(i.mapconfigEdits.markerScaling)i.$prov.find("div.pointsets div.color-scale").slideDown()}i.$prov.find("select.cubeSelector").change(function(){i.set(i.mapconfigEdits,$(this));delete i.graph.assets.cube});i.$prov.find(".map-mode").buttonset().find("input").click(function(){i.mapsetEdits.options.mode=$(this).val();
if(i.mapsetEdits.options.mode=="bubble"&&!i.mapsetEdits.options.merges){i.mapsetEdits.options.merges=[]}else{c.show()}});var c=i.$prov.find(".merge-mode").buttonset().find("input").click(function(){i.mapsetEdits.options.merge=$(this).val()});if(i.mapsetEdits&&(!i.mapsetEdits.options.mode||i.mapsetEdits.options.mode=="bubble"))c.hide();i.$prov.find("button.config-cancel").button({disabled:true,icons:{secondary:"ui-icon-closethick"}}).addClass("ui-state-error").click(function(){i.provClose()});i.$prov.find("button.config-apply").button({icons:{secondary:"ui-icon-check"}}).click(function(){i.provOk()})}i.$prov.find("li.plot").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});i.$prov.find("li.component").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});i.$prov.find(".edit-plot").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("li.component").each(function(){i.showComponentEditor(this,"plot")});i.showPlotEditor(e)});i.$prov.find(".edit-mapset").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){i.sortableOff();i.$prov.find(".mapset").find("ol.map-comp li.component").each(function(){i.showComponentEditor(this,"mapset")});i.showMapSetEditor()});i.$prov.find(".edit-pointset").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("ol li.component").each(function(){i.showComponentEditor(this,"pointset")});i.showPointSetEditor(e)});i.sortableOn()},plotHTML:function r(e){var t=this;var a=t.graph;var i,n="",s=t.plotsEdits[e];s.options.lineWidth=s.options.lineWidth||2;s.options.lineStyle=s.options.lineStyle||"Solid";i=s.options.color||(t.graph.chart&&t.graph.chart.get("P"+e)?t.graph.chart.get("P"+e).color:x[e%x.length]);n+='<li class="plot" data="P'+e+'">'+'<button class="edit-plot">configure</button>'+'<div class="line-sample" style="background-color:'+i+";height:"+s.options.lineWidth+'px;"><img src="images/'+s.options.lineStyle+'.png" height="'+s.options.lineWidth+'px" width="'+s.options.lineWidth*38+'px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">'+rt(a,s)+"</span> ("+t.plotPeriodicity(s)+') in <span class="plot-units">'+lt(a,s)+"</span></div>"+'<span class="plot-formula">= '+V(s).formula+"</span><br>"+t.componentsHTML(s)+"</li>";return n},componentsHTML:function(e){var t,a,i="plot",n="",s=this.graph;var o={sum:"summing",wavg:"day-weighted averaging of"};for(var r=0;r<e.components.length;r++){a=e.components[r];if(e.components[r].options.op==null)e.components[r].options.op="+";if(a.handle[0]=="M")i="map";if(a.handle[0]=="X")i="point";n+='<li class="component ui-state-default" data="'+a.handle+'">'+'<span class="plot-op ui-icon '+D.cssClass[e.components[r].options.op]+'">operation</span> '+'<span class="comp-edit-k" style="display:none;"><input class="short" value="'+(a.options.k||1)+'"> * </span>'+(a.handle[0]=="X"?Pt.pointset:a.handle[0]=="M"?Pt.mapset:"")+s.assets[a.handle].name+" ("+(e.options.fdown!=s.assets[a.handle].period&&e.options.algorithm?S.name[s.assets[a.handle].period]+' created by <a href="/workbench-help/changing-frequency/" traget="_blank">'+o[e.options.algorithm]+"</a> "+S.name[s.assets[a.handle].period]+" data":S.name[s.assets[a.handle].period])+") in "+s.assets[a.handle].units+(i=="plot"?' <a class="link comp-view">view source data</a>':"")+"</li>"}t='<ol class="components '+i+'-comp">'+n+"</ol>";return t},plotPeriodicity:function l(e){var t=this;var a,i,n;if(e.options.fdown){n=e.options.fdown}else{n=t.graph.assets[e.components[0].handle].period}if(e.options.fdown){return'<span class="plot-freq">'+S.name[e.options.fdown]+" synthesized</span>"}else{return'<span class="plot-freq">'+S.name[n]+"</span>"}},sortableOff:function(){var e=this;e.$prov.find("ol.plots").sortable("disable").enableSelection();e.$prov.find("ol.components").sortable("disable").enableSelection();e.$prov.find("ol.pointsets").sortable("disable").enableSelection()},sortableOn:function(){var e=this;e.$prov.find("ol.components").sortable({containment:e.$prov.get(0),connectWith:".components",disabled:false,cancel:".component-landing",axis:"y",delay:150,start:function(t,a){var i,n,s,o;if(a.item.parent().hasClass("map-comp")){s="map";o=e.mapsetEdits}if(a.item.parent().hasClass("plot-comp")){s="plot";o=e.plotsEdits[a.item.closest("li.plot").index()]}if(a.item.parent().hasClass("point-comp")){s="point";o=e.pointsetsEdits[a.item.closest("li.plot").index()]}if(s=="plot"||s=="point"){i=a.item.closest("li.plot").index()}else{i=null}n=a.item.index();e.dragging={type:s,plotIndex:i,compIndex:n,obj:o,$ol:a.item.parent()}},update:function(t,a){e.componentMoved(a)}}).disableSelection();e.$prov.find("ol.plots").sortable({axis:"y",dropOnEmpty:false,connectWith:".plots",disabled:false,start:function(t,a){e.dragging={type:"plot",plotIndex:a.item.index(),compIndex:null,$ol:a.item.parent()}},update:function(t,a){var i,s;var o=e.plotsEdits.splice(e.dragging.plotIndex,1)[0];e.plotsEdits.splice(a.item.index(),0,o);var r=a.item.index()>e.dragging.plotIndex?-1:1;for(i=0;i<e.annoEdits.length;i++){if(e.annoEdits[i].type=="point"){s=parseInt(e.annoEdits[i].series.substr(1));if(s==e.dragging.plotIndex){e.annoEdits[i].series="P"+a.item.index()}else{e.annoEdits[i].series="P"+(s+r).toString()}}}n()}}).disableSelection();e.$prov.find("ol.pointsets").sortable({axis:"y",dropOnEmpty:false,connectWith:".pointsets",disabled:false,start:function(t,a){e.dragging={type:"point",plotIndex:a.item.index(),compIndex:null,$ol:a.item.parent(),obj:e.pointsetsEdits[a.item.index()]}},update:function(t,a){if(a.sender==null)return;var i=e.pointsetEdits.splice(e.dragging.plotIndex,1);e.pointsetEdits.splice(a.item.index(),0,i);n()}}).disableSelection();this.$prov.find("a.comp-view").off().click(function(){var t=$(this).closest("li").attr("data");if(t){Ra(e.graph.assets[t])}})},componentMoved:function d(e){var t=this;var a,i,s;var o,r,l,d,c,p,u,h,f,m,g;var b=t.$prov;if(e.sender==null&&e.item.closest("ol")[0]!=t.dragging.$ol[0])return;h=e.item.closest(".plot").index();var v=e.item.parent().hasClass("blank-plot");if(e.item.parent().hasClass("map-comp")){m="map";if(!v)g=t.mapsetEdits}if(e.item.parent().hasClass("plot-comp")){m="plot";if(!v)g=t.plotsEdits[h]}if(e.item.parent().hasClass("point-comp")){m="point";if(!v)g=t.pointsetsEdits[h]}l=e.item.attr("data");if(l[0]=="M"&&m!="map"){t.$prov.find("ol.components").sortable("cancel");Ua("mapset restrictions","A mapset is a grouping of series, each correspond to an area on a map, such as a state or country.  Mapsets cannot be mixed with marker sets or displayed on a line graph.<br><br>Note that from from the map, you can easily select and chart any of this mapsets' component series.");return}if(l[0]=="M"&&m!="map"){t.$prov.find("ol.components").sortable("cancel");Ua("mapset restrictions","A pointset is a grouping of series, each correspond to a precise location determined by longitude and latitude values.  Pointsets cannot be mixed with area mapsets or displayed a line graph.<br><br>Note that from from the map, you can easily select and chart any of this pointsets' component series.");return}if(h!=t.dragging.plotIndex&&t.dragging.type==m&&e.item.closest("ol")[0]!=t.dragging.$ol[0]){for(o=0;o<g.components.length;o++){if(g.components[o].handle==l){t.$prov.find("ol.components").sortable("cancel");Ua("duplicate series",'This series is already a component of the target plot.<br><br>If you want to use a series multiple times in the plot formula, use <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> of the formula from with the <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> plot instead.');return}}}if(h!=t.dragging.plotIndex&&t.dragging.type==m&&!v){for(o=0;o<g.components.length;o++){if(t.graph.assets[l].period!=t.graph.assets[g.components[o].handle].period){t.$prov.find("ol.components").sortable("cancel");Ua("frequency discrepancy","When performing array math, the sample frequency of all component series must be the same.");return}}}e.item.parent().find(".component-landing").remove();var y=t.dragging.obj.components.splice(t.dragging.compIndex,1)[0];p=e.item.index();if(v){g={options:{},components:[y]};t.plotsEdits.push(g);t.$prov.find("ol.plots").append(t.plotHTML(t.plotsEdits.length-1))}else{g.components.splice(p,0,y)}t.setFormula(g,e.item.closest(".plot"));if(t.dragging.obj.components.length==0){if(t.dragging.type=="plot"){t.plotsEdits.splice(t.dragging.plotIndex,1);t.$prov.find("ol.plots li.plot")[t.dragging.plotIndex].remove();var k;for(o=0;o<t.annoEdits.length;o++){if(t.annoEdits[o].type=="point"){k=parseInt(t.annoEdits[o].series.substr(1));if(k==t.dragging.plotIndex){t.annoEdits.splice(o,1);o--}if(k>t.dragging.plotIndex){t.annoEdits[o].series="P"+--k}}}}if(t.dragging.type=="point"){t.pointsetsEdits.splice(t.dragging.plotIndex,1);t.$prov.find("ol.pointsets li.plot")[t.dragging.plotIndex].remove()}}else{t.setFormula(t.dragging.obj,t.dragging.$ol.parent())}if(v){e.item.remove();t.sortableOn()}n()},provOk:function c(t){var a=this;if(a.isDirty&&(a.plotsEdits||a.mapsetEdits||a.pointsetsEdits)){if(a.plotsEdits&&a.plotsEdits.length>0)a.graph.plots=a.plotsEdits;else delete a.graph.plots;a.graph.annotations=a.annoEdits;if(a.mapsetEdits&&a.mapsetEdits.components&&a.mapsetEdits.components.length>0)a.graph.mapsets=a.mapsetEdits;else delete a.graph.mapsets;if(a.pointsetsEdits&&a.pointsetsEdits.length>0)a.graph.pointsets=a.pointsetsEdits;else delete a.graph.pointsets;a.graph.mapconfig=a.mapconfigEdits;if(!a.graph.mapsets&&!a.graph.pointsets)a.graph.map="";this.provClose();if(!t)$("#"+e).find(".graph-type").change()}},provClose:function p(){var e=this;delete e.plotsEdits;delete e.annoEdits;delete e.mapsetEdits;delete e.pointsetsEdits;delete e.mapconfigEdits;e.$prov.find("ol.ui-sortable").sortable("destroy");e.$prov.closest("div.graph-panel").find(".graph-nav-graph").click();e.isDirty=false},compIndex:function(e){var t=$(e);var a=t.index();return a},showComponentEditor:function h(e,t){var a=this;var i,s,o=$(e);var r=$(e).closest("li.plot, li.pointset").index();if(t=="mapset")i=a.mapsetEdits;if(t=="pointset")i=a.pointsetsEdits[r];if(t=="plot")i=a.plotsEdits[r];var l=a.compIndex(o);var d=$(e).attr("data");var c=i.components[l];var p=(I.test(d)?'<button class="comp-copy prov-float-btn">make copy</button>':"")+'<button class="comp-delete prov-float-btn">remove series</button>';var u=$(p);o.find(".plot-op").hide().after('<div class="op">'+'<input type="radio" data="+"  id="op-addition'+d+'" value="+" name="op-radio'+d+'" /><label for="op-addition'+d+'">+</label>'+'<input type="radio" data="-"  id="op-subtraction'+d+'" value="-" name="op-radio'+d+'" /><label for="op-subtraction'+d+'">-</label>'+'<input type="radio" data="*"  id="op-multiply'+d+'" value="*" name="op-radio'+d+'" /><label for="op-multiply'+d+'">*</label>'+'<input type="radio" data="/"  id="op-divide'+d+'" value="/" name="op-radio'+d+'" /><label for="op-divide'+d+'">/</label>'+"</div>");o.find("div.op").find("input[data='"+c.options.op+"']").attr("checked","checked").end().buttonset().find("input:radio").change(function(){a.set(i.components[l].options,"op",$(this).val());a.setFormula(i,o.closest(".plot,.mapset"));o.find(".plot-op").attr("class","plot-op ui-icon "+D.cssClass[i.components[l].options.op])});u.appendTo(o).slideDown();o.find(".comp-edit-k").show().find("input").change(function(){if(!isNaN(parseFloat(this.value))){c.options.k=Math.abs(parseFloat(this.value));if(c.options.k==0)c.options.k=1;n();a.setFormula(i,o.closest("ol").parent())}else{Ua("Error","Scalors must be numerical")}$(this).val(c.options.k)});o.find(".comp-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){if(i.components.length==1){o.closest("li.plot, div.mapset").find(".plot-delete").click()}else{i.components.splice(l,1);o.remove();n()}});o.find(".comp-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){var e={options:{},components:[$.extend(true,{},c,{options:{op:"+"}})]};a.plotsEdits.push(e);var t=a.graph.assets[d].name;a.$prov.find("ol.plots").append(a.componentsHTML(e))})},showPlotEditor:function f(t){var a=this;a.sortableOff();var i=$(t);var s=i.index();var o=a.plotsEdits[s];var r=o.options;var l=o.options.color||a.graph.chart.get("P"+i.index()).color;i.find(".edit-plot, .plot-info").hide();var d='<select class="plot-thickness" data="lineWidth">';for(var c=1;c<=5;c++)d+='<option value="'+c+'">'+c+"px</option>";d+="</select>";var p='<select class="plot-linestyle" data="lineStyle">';for(var h=0;h<M.length;h++)p+='<option value="'+M[h].replace(/ /g,"")+'">'+M[h].toLowerCase()+"</option>";p+="</select>";var f=r.fdown||a.graph.assets[o.components[0].handle].period;var m=this.freqOptions(o);var g='<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete plot</button>'+'<fieldset class="edit-line" style="padding: 0 5px;display:inline-block;"><legend>color, thickness, &amp; style</legend>'+'<div class="edit-block"><input class="plot-color" type="text" data="color" value="'+(o.options.color||l)+'" /></div>'+d+p+"</fieldset>"+'<div class="edit-block">Name: <input class="plot-name" type="text" data="name" /></div>'+'<div class="edit-block"><span class="edit-label">display as:</span><select class="plot-type" data="type"><option value="">graph default</option><option value="line">line</option><option value="column">column</option><option value="area">stacked area</option></select></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text"  /><span class="plot-edit-k edit-label">scalor:<input class="short" value="'+(o.options.k||1)+'"></span> '+'<span class="edit-label">frequency:</span><select class="dshift">'+m+"</select></div><br>"+'<span class="edit-label">Point calculations:</span>'+a.HTML.compMath+'<div class="edit-block"><span class="edit-label">Break line</span><div class="edit-breaks">'+'<input type="radio" id="never-'+e+'" name="line-break-'+e+'" data="breaks" value="never" /><label for="never-'+e+'">never</label>'+'<input type="radio" id="nulls-'+e+'" name="line-break-'+e+'" data="breaks" value="nulls" /><label for="nulls-'+e+'">on nulls</label>'+'<input type="radio" id="missing-'+e+'" name="line-break-'+e+'" data="breaks" value="missing" /><label for="missing-'+e+'">on missing value and nulls</label></div>'+"</div>"+"</div>";var b=$(g);a.$prov.find("button.plot-close").click();b.find("input.plot-name").val(rt(a.graph,o)).change(function(){if(rt(a.graph,o,true)!=$(this).val()&&$(this).val().trim()!="")o.options.name=$(this).val();else delete o.options.name;n()});b.find("input.plot-units").val(lt(a.graph,o)).change(function(){if(lt(a.graph,o,true)!=$(this).val()&&$(this).val().trim()!=""){o.options.units=$(this).val()}else{delete o.options.units}i.find("span.plot-units").html(lt(a.graph,o));n()});b.find("select.dshift").val(f).change(function(){var e=$(this).val();var t=b.find("select.dshift option:selected").attr("data");if(e!=t){u(a.graph,e,o,function(t){if(t){r.fdown=e;r.algorithm=t.algorithm;r.missing=t.missing;$.each(o.components,function(){var t=a.graph.assets[this.handle];if(t.freqset[e]){this.handle=t.freqset[e]}else{this.handle=t.freqset[e=="A"&&t.freqset.Q?"Q":"M"]}});f=e;a.fetchNewSeries(o);n()}else{b.find("select.dshift").val(f)}})}else{delete r.fdown;delete r.algorithm;delete r.missing;$.each(o.components,function(){this.handle=a.graph.assets[this.handle].freqset[e]});f=e;a.fetchNewSeries(o);n()}});if(!o.options.componentData)o.options.componentData="required";b.find("div.edit-math").find("input[id='"+o.options.componentData+"-"+e+"']").click().end().buttonset().find("input:radio").change(function(){o.options.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];n()});if(!o.options.breaks)o.options.breaks="nulls";b.find("div.edit-breaks").find("input[id='"+o.options.breaks+"-"+e+"']").click().end().buttonset().find("input:radio").change(function(){a.set(o.options,$(this))});b.find(".edit-line legend").after(i.find(".line-sample").hide().clone().css("display","inline-block").show());b.find("input.plot-color").colorPicker().change(function(){a.set(o.options,$(this));i.find("div.line-sample").css("background-color",o.options.color)});b.find("select.plot-thickness").val(o.options.lineWidth).change(function(){a.set(o.options,$(this));i.find("div.line-sample").css("height",o.options.lineWidth).find("img").css("height",o.options.lineWidth).css("width",parseInt(o.options.lineWidth.substr(0,1)*38)+"px")});b.find("select.plot-linestyle").val(o.options.lineStyle).change(function(){a.set(o.options,$(this));i.find("div.line-sample img").attr("src","images/"+o.options.lineStyle+".png")});b.find("select.plot-type").val(o.options.type).change(function(){a.set(o.options,$(this))});b.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){o.options.k=Math.abs(parseFloat(this.value));if(o.options.k==0)o.options.k=1;a.setFormula(o,i);n()}else{Ua("Error","Scalors must be numerical")}$(this).val(o.options.k||1)});b.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){a.plotsEdits.splice(i.index(),1);i.remove();n()});b.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){a.plotsEdits.push($.extend(true,{},o));a.build(s)});b.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var e;i.find(".edit-plot, .plot-info, .line-sample, span.plot-formula").show();i.find(".plot-editor").slideUp("default",function(){i.find(".op.ui-buttonset").remove();if(!r.userFormula)i.find(".plot-op").show();i.find(".plot-editor, button.manual, button.guided, input.plot-formula").remove();i.find("li button").remove();b.remove()});i.find(".comp-edit-k").hide();a.$prov.find(".landing").slideDown();i.find(".comp-editor").slideUp("default",function(){$(this).remove()});i.find(".edit-plot").show();a.sortableOn()});b.prependTo(i);this.editPlotFormula(o,i);b.slideDown();a.$prov.find(".landing").slideUp()},freqOptions:function(e){var t,a,i,n,s="",o={},r;for(t=0;t<S.order.length;t++){i=true;r=S.order[t];for(a=0;a<e.components.length;a++){n=this.graph.assets[e.components[a].handle];if(!n.freqset){n.freqset={};n.freqset[n.period]=n.handle}if(!n.freqset[r])i=false}if(i){s+='<option value="'+r+'" data="'+r+'">'+S.name[r]+" using official data</option>";o[r]=true}}if(!o["Q"]&&o["M"])s+='<option value="Q" data="M">'+S.name.Q+" calculated from monthly data</option>";if(!o["A"]&&(o["M"]||o["Q"]))s+='<option value="A" data="'+(o["Q"]?"Q":"M")+'">'+S.name.A+" calculated from "+(o["Q"]?S.name.Q:S.name.M)+" data</option>";return s},fetchNewSeries:function(e){var t=this,a={S:[],U:[],X:[],M:[]};$.each(e.components,function(){G(this.handle,t.graph,a)});q(t.graph,a,vi)},showPointSetEditor:function(t){var i=this;i.sortableOff();var s=i.pointsetsEdits[t.index()];var o=s.options;t.find(".edit-plot, .plot-info").hide();var r='<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete marker set</button>'+'<div class="edit-block"><input class="marker-color" type="text" data="color" value="'+o.color+'" /></div>'+'<div class="edit-block">name: </span><input class="plot-name" type="text"  /></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" type="text" /><span class="plot-edit-k"><input class="short" value="'+(o.k||1)+'"> </div><br>'+'<span class="edit-label attribute">Values will change marker  </span>'+'<div class="attribute">'+'<input type="radio" name="attribute-'+e+'" id="attribute-r-'+e+'" data="attribute" value="r"/><label for="attribute-r-'+e+'">area</label>'+'<input type="radio" name="attribute-'+e+'" id="attribute-fill-'+e+'" data="attribute" value="fill" /><label for="attribute-fill-'+e+'">color</label>'+"</div>"+'<span class="edit-label">Point calculations:</span>'+i.HTML.compMath+"</div>"+"</div>";var l=$(r);i.$prov.find("button.plot-close").click();var l=$(r);l.find("input.plot-name").val(rt(i.graph,s)).change(function(){if(rt(i.graph,s,true)!=$(this).val()&&$(this).val().trim()!="")o.name=$(this).val();else delete o.name;n()});l.find("input.plot-units").val(lt(i.graph,s)).change(function(){if(lt(i.graph,s,true)!=$(this).val()&&$(this).val().trim()!="")o.units=$(this).val();else delete o.units;n()});l.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){o.k=Math.abs(parseFloat(this.value));if(o.k==0)o.k=1;i.setFormula(s,t)}else{Ua("Error","Scalors must be numerical")}$(this).val(o.k||1)});l.find(".marker-color").colorPicker().change(function(){i.set(o,$(this));l.find("div.marker").css("background-color",$(this).val())});function d(){for(var e=0;e<i.pointsetsEdits.length;e++){if(i.pointsetsEdits[e].options.attribute=="fill"){l.find(".color-picker.marker-color").hide();return}}l.find(".color-picker.marker-color").show()}d();l.find("div.attribute").find("[value='"+(o.attribute||"r")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){i.set(o,$(this));a.setRadLabel();a.legendOptionsShowHide()});if(!o.componentData)o.componentData="required";l.find("div.edit-math").find("input[id='"+o.componentData+"-"+e+"']").click().end().buttonset().find("input:radio").change(function(){o.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];n()});l.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){i.plotsEdits.splice(t.index(),1);t.remove();n()});l.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){i.plotsEdits.push($.extend(true,{},s));i.build(plotIndex)});l.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var e;t.find(".edit-plot, .plot-info, .line-sample").show();t.find(".plot-editor").slideUp("default",function(){t.find(".op.ui-buttonset").remove();if(!o.userFormula)t.find(".plot-op").show();t.find(".guided, .manual, input.plot-formula, .plot-editor, li button").remove();l.remove()});t.find(".comp-edit-k").hide();i.$prov.find(".landing").slideDown();t.find(".comp-editor").slideUp("default",function(){$(this).remove()});t.find(".edit-plot").show();i.sortableOn()});l.prependTo(t);this.editPlotFormula(s,t);l.slideDown();i.$prov.find(".landing").slideUp();t.find(".edit-pointset").hide()},provenanceOfMap:function m(){var e=this;var t="",a,i,n=[],s,o=[],r="",l=$t(e.graph);if(e.graph.map&&(e.mapsetEdits||e.pointsetsEdits)){yt(e.graph,function(){s=e.graph.assets[this.handle].themeid;if(s){n.pushUnique(s);if(!_t["T"+s])o.pushUnique(s)}});if(n.length>0||l){if(o.length>0){bi({command:"GetCubeList",themeids:o},function(t,a,i){for(var n in t.themes){_t[n]=t.themes[n]}e.$prov.find("select.cubeSelector").html(d())})}r='<div class="cubeSelector right">supplemental visualization: <select class="cubeSelector" data="cubeid">'+d()+"</select></div>"}function d(){var t,a,i,s='<option value="0">none</option>';if(l)s+='<option value="sum" '+(e.mapconfigEdits.cubeid=="sum"?"selected":"")+">bar graph of components</option>";for(t=0;t<n.length;t++){i=_t["T"+n[t]];if(i){for(a=0;a<i.cubes.length;a++){s+='<option value="'+i.cubes[a].cubeid+'" '+(e.mapconfigEdits.cubeid==i.cubes[a].cubeid?"selected":"")+">"+i.name+": "+i.cubes[a].name+"</option>"}}}return s}t='<div class="map-prov">'+r+"<h3>Map of "+e.graph.map+"</h3>";if(e.mapsetEdits){var c=e.mapsetEdits;t+='<div class="mapset">'+"<h4>"+Pt.mapset+" Mapped set of regions (country, state, or county)</h4>"+'<div class="mapset-colors" style="margin-bottom:5px;"></div>'+'<div class="plot-info">'+'<button class="edit-mapset right ehide">configure</button>'+'<div class="edit-block ehide">'+'<span class="plot-title">'+rt(e.graph,c)+"</span> ("+e.plotPeriodicity(c)+') in <span class="plot-units">'+lt(e.graph,c)+"</span>"+"</div>"+'<span class="plot-formula">= '+V(c).formula+"</span><br>"+'<span class="map-mode ehide">mode: '+(!c.options.mode||c.options.mode!="bubble"?"heat map":"bubbles with user defined regions")+"</span>"+'<div class="editor"></div>'+"</div>"+e.componentsHTML(c)+"</div>"}if(e.pointsetsEdits){t+='<div class="pointsets"><h4>'+Pt.pointset+" mapped set of markers (defined latitude and longitude)</h4>"+'<div class="pointsets-colors" style="margin-bottom:5px;"></div>'+'<ol class="pointsets">';for(a=0;a<e.pointsetsEdits.length;a++){i=e.pointsetsEdits[a];t+='<li class="pointset">'+'<button class="edit-pointset right">configure</button>'+'<div class="plot-info" style="display:inline-block;">'+'<div class="marker" style="background-color: '+(i.options.color||"#000000")+'"></div>'+'<span class="plot-title">'+rt(e.graph,i)+"</span> ("+e.plotPeriodicity(i)+') in <span class="plot-units">'+lt(e.graph,i)+"</span>"+'<span class="plot-formula">= '+V(i).formula+"</span></div>"+e.componentsHTML(e.pointsetsEdits[a])+"</li>"}t+="</ol></div>"}t+="</div>"}return t},editPlotFormula:function(e,t){if(e.options.userFormula){a()}else{i()}function a(){t.find("div.op, span.comp-edit-k").hide();t.find("button.manual").remove();t.find("span.plot-formula").hide().after('<button class="guided">guided editing</button>').after('<input class="plot-formula">');t.find("input.plot-formula").val(e.options.userFormula||V(e).formula).keyup(function(){try{var a=$(this).val();if(a.indexOf(";")>=0)throw"invalid mathematical syntax";var i="return "+a.replace(P,"values.$1")+";";var n=new Function("values",i);var s={},o;$.each(e.components,function(e){o=Y(e);if(a.indexOf(o)===-1)throw"all symbols must be used";s[Y(e)]=e});var r=n(s);$(this).removeClass("ui-state-error");e.options.userFormula=a;t.find("span.plot-formula").html("= "+e.options.userFormula)}catch(l){$(this).addClass("ui-state-error");delete e.options.userFormula}});t.find("button.guided").button({icons:{secondary:"ui-icon-star"}}).click(function(){i()})}function i(){t.find("div.op, span.comp-edit-k").show();t.find("input.plot-formula, button.guided").remove();t.find("span.plot-formula").html("= "+V(e).formula).show().after('<button class="manual">manual editing</button>');delete e.options.userFormula;t.find("button.manual").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){a()})}},showMapSetEditor:function(){var e=this;var t=this.mapsetEdits;var a=this.mapsetEdits.options;var i=e.$prov.find(".mapset");this.editPlotFormula(this.mapsetEdits,i);var s;e.$prov.find("button.plot-close").click();i.find(".edit-mapset").hide();var o='<div class="plot-editor" style="display: none;">';if(a.mode=="bubble"){o+='<span class="merge-formula">merge formula = &#931; numerator / &#931; denominator</span>'}o+='<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-delete prov-float-btn">delete heat map</button>'+""+'<div class="edit-block">name: </span><input class="plot-name" type="text" data="name"/></div><br>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text"/><span class="plot-edit-k"> scalor: <input class="short" value="'+(a.k||1)+'"></div><br>'+'<span class="edit-label">Point calculations:</span>'+e.HTML.compMath+'<div class="edit-block add-bunny"><button  class="add-bunny">add regional tracking plot</button></span></div> ';o+="</div>";var r=$(o);r.find("button.add-bunny").button({icons:{secondary:"ui-icon-plus"}}).click(function(){var s="add";if(s=="add"){var o,r,l,d=[];for(o=0;o<t.components.length;o++){if(t.components[o].handle[0]=="M"){d.push(t.components[o].handle.substr(1))}}bi({command:"GetBunnySeries",mapsetids:d,geoid:parseInt(mapsList[e.graph.map].bunny),mapname:e.graph.map},function(a,i,s){if(a.allfound){for(r in a.assets){e.graph.assets[a.assets[r].handle]=a.assets[r]}var l={options:{k:t.options.k||1,units:t.options.units},components:[]};for(o=0;o<t.components.length;o++){if(t.components[o].handle[0]=="M"){r=a.assets[t.components[o].handle].handle}else{r=t.components[o].handle}l.components.push({handle:r,options:{k:t.components[o].k||1,op:t.components[o].op||"+"}})}var d,c=e.plotsEdits,p=false;if(c){for(d=0;d<c.length;d++){if(l.options.k!=c[d].options.k||1){for(o=0;o<c[d].components.length;o++){if(c[d].components[o].handle!=l.components[o].handle||c[d].components[o].options.k||1!=l.components[o].options.k||c[d].components[o].options.op||"+"!=l.components[o].options.op)break}if(o==c[d].components.length){p=true;$(this).val(d);break}}}}if(!p){e.plotsEdits.push(l);e.build(d)}}else{Ua("unable to automatically create tracking plot","One or more of the component map sets does not have series for "+e.graph.map+" level of aggregation.")}n()})}else{if(s=="-1"){delete a.bunny}else{a.bunny=parseInt(s)}}e.setFormula(t,i);n()});r.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){a.k=Math.abs(parseFloat(this.value));if(a.k==0)a.k=1;e.setFormula(t,i);n()}else{Ua("Error","Scalors must be numerical")}$(this).val(a.k||1)});r.find("div.edit-math").find("[value='"+(a.compMath||"required")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){e.set(a,$(this))});r.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){e.mapsetEdits={};i.remove();if(!e.pointsetsEdits)e.$prov.find("map-prov").remove();n()});r.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){i.find(".edit-mapset, .plot-info").show();i.find(".plot-editor").slideUp("default",function(){i.find(".op.ui-buttonset, .comp-delete").remove();$(this).remove();i.find(".plot-op").show()});i.find(".guided, .manual, input.plot-formula, span.comp-edit-k").remove();i.find(".ehide").show();e.$prov.find(".landing").slideDown();i.find(".comp-editor").slideUp("default",function(){$(this).remove()});e.sortableOn()});r.find("input.plot-name").val(rt(e.graph,t)).change(function(){e.set(a,$(this));i.find("span.plot-title").html(t.options.name)});r.find("input.plot-units").val(lt(e.graph,t)).change(function(){e.set(a,$(this));i.find("span.plot-units").html(t.options.units)});r.appendTo(i.find(".editor").html("")).slideDown();i.find(".ehide").hide();e.$prov.find(".landing").slideUp()},setFormula:function(e,t){e.formula=V(e);var a=e.formula.formula;if(t){t.find("span.plot-formula").html("= "+a);if(!e.options.units)t.find("input.plot-units").val(lt(this.graph,e));if(!e.options.name)t.find("input.plot-name").val(rt(this.graph,e))}},legendEditor:function(a,i,s){var o,r=this,l=r.$prov.find(".map-prov");var d='<div class="edit-block">'+'<div class="map-mode edit-block">'+'<input type="radio" name="'+e+'-map-mode" id="'+e+'-map-mode-C" value="fill" data="mode" '+(!i.mode||i.mode!="bubble"?"checked":"")+' /><label for="'+e+'-map-mode-C">fill (heat map)</label>'+'<input type="radio" name="'+e+'-map-mode" id="'+e+'-map-mode-B" value="bubble" data="mode" '+(i.mode&&i.mode=="bubble"?"checked":"")+' /><label for="'+e+'-map-mode-B">bubbles (mergable into regional sums)</label>'+'</div><span class="merge-formula ital">merge formula = &#931; numerator / &#931; denominator</span>'+'<div class="radius"  style="display: none;">'+'<span class="edit-label radius-label">maximum '+(s=="X"?"marker":"bubble")+' radius (pixels): </span><input class="radius-spinner" value="'+(i.attribute=="fill"?r.mapconfigEdits.fixedRadius||w:r.mapconfigEdits.maxRadius||k)+'" />'+"</div>"+'<div class="edit-block color-scale" style="display: none;">'+'<div class="legend-scale"><span class="edit-label">Color scale:</span>'+'<input type="radio" id="legend-continuous-'+e+'" name="legend-type-'+e+'" data="scale" value="continuous" /><label for="legend-continuous-'+e+'">continous</label>'+'<input type="radio" id="legend-discrete-'+e+'" name="legend-type-'+e+'" data="scale" value="discrete"/><label for="legend-discrete-'+e+'">discrete</label>'+"</div>"+'<div class="lin-log-scaling"><span class="edit-label">Color mode:</span>'+'<input type="radio" id="lin-scaling-'+e+'" name="color-mode-'+e+'" data="logMode" value="off" /><label for="lin-scaling-'+e+'">linear</label>'+'<input type="radio" id="log-scaling-'+e+'" name="color-mode-'+e+'" data="logMode" value="on"/><label for="log-scaling-'+e+'">enhanced color</label>'+"</div>"+'<div class="edit-block legend-continuous" style="display: none;">'+'-<div class="continuous-color"><input class="neg color-picker" type="text" data="negColor" value="'+(i.negColor||y.NEG)+'" /></div>'+At(i)+'<div class="continuous-color"><input class="pos color-picker" type="text" data="posColor" value="'+(i.posColor||y.POS)+'" /></div>+'+"</div>"+'<div class="edit-block legend-discrete" style="display: none;"></div>'+"</div>";
var c=$(d);c.find("div.map-mode").find("[value='"+(i.mode||"fill")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){r.set(i,$(this));t.legendOptionsShowHide();p()});p();function p(){if(i.mode=="bubble")c.find(".merge-formula").show();else c.find(".merge-formula").hide()}c.find("div.legend-scale").find("[value='"+(i.scale||"continuous")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){r.set(i,$(this));u()});function u(){if(i.scale=="discrete"){c.find(".legend-discrete").removeAttr("style");c.find(".lin-log-scaling").hide();c.find(".legend-continuous").hide()}else{c.find(".legend-discrete").hide();c.find(".lin-log-scaling").removeAttr("style");c.find(".legend-continuous").removeAttr("style")}}u();c.find(".lin-log-scaling").find("[value='"+(i.logMode||"off")+"']").attr("checked",true).end().buttonset().find("input").change(function(){r.set(i,$(this))});c.find(".radius-spinner").spinner({min:2,max:200,change:function(e,t){if(s=="M"||i.attribute!="fill"){r.mapconfigEdits.maxRadius=$(this).val()}else{r.mapconfigEdits.fixedRadius=$(this).val()}n()}});c.find(".color-picker.pos").colorPicker().change(function(){r.set(i,$(this));c.find(".continuous-strip-pos").html(Tt("#CCCCCC",i.posColor));l.find(".map-legend").html("-"+At(i)+"+")});c.find(".color-picker.neg").colorPicker().change(function(){r.set(i,$(this));c.find(".continuous-strip-neg").html(Tt(i.negColor,"#CCCCCC"));l.find(".map-legend").html("-"+At(i)+"+")});c.find(".legend-discrete").append(r.discreteLegend(s));h();a.append(c);return{legendOptionsShowHide:h,setRadLabel:f};function h(){if(s=="X"||s=="M"&&i.mode=="bubble"){c.find("div.radius").slideDown()}else{c.find("div.radius").slideUp()}if(s=="M"&&i.mode!="bubble"||s=="X"&&r.mapconfigEdits.markerScaling!="none"&&wt(r.pointsetsEdits)>0){c.find("div.color-scale").slideDown();if(i.scale=="discrete"){c.find("div.legend-continuous").hide();c.find("div.legend-discrete").removeAttr("style")}else{c.find("div.legend-continuous").removeAttr("style");c.find("div.legend-discrete").hide()}}else{c.find("div.color-scale").slideUp()}}function f(){}},discreteLegend:function(e){var t,a,i,s,r,l=this;var d=e=="X"?l.mapconfigEdits:l.mapsetEdits.options;if(!Array.isArray(d.discreteColors)||d.discreteColors.length==1)d.discreteColors=p(5,d);t='<div class="edit-block">'+'<div class="edit-block discrete-legend"></div>'+'<button class="inc-discrete">+</button>'+'<button class="dec-discrete">-</button>'+'<button class="reset-discrete">calculate colors</button>'+"</div>";a=$(t);c();a.find("button.inc-discrete").button({disabled:d.discreteColors.length>9}).click(function(){a.find("button.inc-discrete").button("enable");d.discreteColors=p(d.discreteColors.length+1,d);if(d.discreteColors.length>9)$(this).button("disable");c();n()});a.find("button.dec-discrete").button({disabled:d.discreteColors.length<2}).click(function(){a.find("button.inc-discrete").button("enable");d.discreteColors=p(d.discreteColors.length-1,d);if(d.discreteColors.length<2)$(this).button("disable");c();n()});a.find("button.reset-discrete").button().click(function(){d.discreteColors=p(d.discreteColors.length,d);c();n()});return a;function c(){var e="";for(i=0;i<d.discreteColors.length;i++){e+='<div class="discrete-color"><input class="color" data="'+i+'" value="'+d.discreteColors[i].color+'" /></div>';if(i!=d.discreteColors.length-1){e+=' &#8804; <input class="cutoff" data="'+i+'" value="'+d.discreteColors[i].cutoff+'" />'}}a.find(".discrete-legend").html(e);a.find(".color").colorPicker().change(function(){s=parseInt($(this).attr("data"));d.discreteColors[s].color=$(this).val();n()});a.find(".cutoff").change(function(){s=parseInt($(this).attr("data"));r=$(this).val();if(isNaN(r)){for(i=0;i<d.discreteColors.length;i++){if(i<s)d.discreteColors[i].cutoff=Math.min(d.discreteColors[i].cutoff,r);if(i==s)d.discreteColors[i].cutoff=r;if(i>s)d.discreteColors[i].cutoff=Math.max(d.discreteColors[i].cutoff,r)}}n()})}function p(t,a){var i,n,s,r=[],d=[];var c=e=="X"?l.graph.calculatedMapData.markerData:l.graph.calculatedMapData.regionData;for(n in c){for(s in c[n]){if(c[n][s]!=null)r.push(c[n][s])}}r.sort(function(e,t){return e-t});var p=0,u=0;for(i=0;i<t;i++){if(r[parseInt(r.length/(t/(i+1)))]<0)p++}var h=r[0]<0&&r[r.length-1]>0;if(h){for(u=0;u<r.length;u++){if(r[u]>=0)break}if(h){if(p==0){p++}else{var f=(u/r.length-p/t)*t;if(f<-.5)p++;if(f>.5&&p>1)p--}}}var m=t-p;var g=a.negColor||y.NEG;if(g.substr(0,1)=="#")g=g.substr(1);var b,v,k,w,x,C,M;w=parseInt(g.substr(0,2),16);x=parseInt(g.substr(2,2),16);C=parseInt(g.substr(4,2),16);for(i=0;i<p;i++){b=parseInt(w+(255-w)*(p-i-1)/p);v=parseInt(x+(255-x)*(p-i-1)/p);k=parseInt(C+(255-C)*(p-i-1)/p);M="#"+b.toString(16)+v.toString(16)+k.toString(16);d.push({color:M,cutoff:i+1==p&&h?0:r[Math.round((r.length-1)*(i+1)/t)]})}var $,S=0,D=a.posColor||y.POS;if(D.substr(0,1)=="#")D=D.substr(1);w=parseInt(D.substr(0,2),16);x=parseInt(D.substr(2,2),16);C=parseInt(D.substr(4,2),16);for(i=p;i<m;i++){b=parseInt(w+(255-w)*(m-i-1)/m);v=parseInt(x+(255-x)*(m-i-1)/m);k=parseInt(C+(255-C)*(m-i-1)/m);M="#"+o(b)+o(v)+o(k);$=Math.round((r.length-1-S)*i/t+S);while($<r.length-1&&r[$]==r[$+1]){$++;S++}d.push({color:M,cutoff:r[$]})}return d}},set:function(e,t,a){if(typeof t=="string"){e[t]=a}else{e[t.attr("data")]=t.val()}n()}};return i;function n(){i.isDirty=true;i.$prov.find(".config-cancel").button("enable")}}function Tt(e,t){return'<span class="map_legend_gradient" style="-ms-filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='+e+", endColorstr="+t+", gradientType=1);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="+e+", endColorstr="+t+", gradientType=1)background-image: -webkit-gradient(linear, left bottom, right bottom, from("+e+"), to("+t+"));background-image: -webkit-linear-gradient(left, "+e+", "+t+");background-image: -moz-linear-gradient(left, "+e+", "+t+");background-image:  -o-linear-gradient(left, "+e+", "+t+";background-image: linear-gradient(to left, "+e+","+t+');"></span>'}function At(e){return'<div class="continuous-strip-neg">'+Tt(e.negColor||y.NEG,y.MID)+"</div>"+"0"+'<div class="continuous-strip-pos">'+Tt(y.MID,e.posColor||y.POS)+"</div>"}function It(){jQuery.extend({stringify:function e(t){if("JSON"in window){return JSON.stringify(t)}var a=typeof t;if(a!="object"||t===null){if(a=="string")t='"'+t+'"';return String(t)}else{var i,n,s=[],o=t&&t.constructor==Array;for(i in t){n=t[i];a=typeof n;if(t.hasOwnProperty(i)){if(a=="string"){n='"'+n+'"'}else if(a=="object"&&n!==null){n=jQuery.stringify(n)}s.push((o?"":'"'+i+'":')+String(n))}}return(o?"[":"{")+String(s)+(o?"]":"}")}}})}if(!("bind"in Function.prototype)){Function.prototype.bind=function(e){var t=this;if(arguments.length<=1){return function(){return t.apply(e,arguments)}}else{var a=Array.prototype.slice.call(arguments,1);return function(){return t.apply(e,arguments.length===0?a:a.concat(Array.prototype.slice.call(arguments)))}}}}if(!("trim"in String.prototype)){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(e,t){if(t===undefined)t=0;if(t<0)t+=this.length;if(t<0)t=0;for(var a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1}}if(!("lastIndexOf"in Array.prototype)){Array.prototype.lastIndexOf=function(e,t){if(t===undefined)t=this.length-1;if(t<0)t+=this.length;if(t>this.length-1)t=this.length-1;for(t++;t-->0;)if(t in this&&this[t]===e)return t;return-1}}if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this)e.call(t,this[a],a,this)}}if(!("map"in Array.prototype)){Array.prototype.map=function(e,t){var a=new Array(this.length);for(var i=0,n=this.length;i<n;i++)if(i in this)a[i]=e.call(t,this[i],i,this);return a}}if(!("filter"in Array.prototype)){Array.prototype.filter=function(e,t){var a=[],i;for(var n=0,s=this.length;n<s;n++)if(n in this&&e.call(t,i=this[n],n,this))a.push(i);return a}}if(!("every"in Array.prototype)){Array.prototype.every=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this&&!e.call(t,this[a],a,this))return false;return true}}if(!("some"in Array.prototype)){Array.prototype.some=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this&&e.call(t,this[a],a,this))return true;return false}}var Ut={plot:'<li class="plot ui-state-highlight" data="{{order}}">'+'<a class="edit-plot link" style="float:right;">edit <span class="ui-icon ui-icon-arrowthickstop-1-s" style="display: inline-block;"> edit</span></a>'+'<div class="line-sample" style="padding:0;margin:0 10px 10px 0;display:inline-block;border-width:0;background-color:{{color}};height:{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px;width:38px;">'+'<img src="images/{{options.lineStyle}}.png" height="{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px" width="{{imageWidth}}px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">{{name}}</span> in {{plotUnits}} {{plotPeriodicity}}</div>'+'<ul class="series" style="list-style-type: none;" data="{{order}}">'+'{{#component}}<li class="serie ui-state-default" data="{{handle}}" plot="{{order}}"><span class="plot-op ui-icon {{opUI}}">operation</span> '+'{{seriesname}}<button class="edit-comp">edit</button></li>{{/component}}'};graphScriptFiles=["/global/js/highcharts/js/modules/exporting.src.js","/global/js/colorpicker/jquery.colorPicker.min.js","/global/js/colour/Colour.js","/global/js/jvectormap/jquery-jvectormap-1.2.2.min.js"];var Pt={mapset:'<span class="ui-icon ui-icon-mapset" title="series is part of a map set"></span>',pointset:'<span class="ui-icon ui-icon-pointset" title="series is part of a set of markers (defined longitude and latitude)"></span>',hasCubeViz:'<span class="ui-icon ui-icon-cube" title="map has supplemental visualizations"></span>',hasHeatMap:'<span class="ui-icon ui-icon-mapset" title="contains a heat-map"></span>',hasMarkerMap:'<span class="ui-icon ui-icon-pointset" title="contains sets of mapped markers (defined longitude and latitude)."></span>',hasBubbleMap:'<span class="ui-icon ui-icon-bubble" title="bubble map of data aggregated into user-defined regions"></span>'};var Ft={noMySeries:'Your My Series folder is empty.  Please search for Public Series, which can be graphed and added to your My Series folder for future quick reference.<br><br>You can also use the <button id="new-series" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">new series</span></button> feature to enter or upload your own data.',noSeriesSelected:"Click on one or more series below to select them before previewing.<br><br>Alternatively, you can double-click on a series to quickly preview it.",editLimit:"Only one series or set can be edited at a time.",noGraphSelected:"Click on a row in the table below to select a graph first.<br><br>As a shortcut, you can double-click on a graph to select and open it.",noMyGraphs:"You have no My Graphs.  Graphs are built by searching for public series or upload your own data and building a graph. Saving graphs you build adds to them to your My Graphs folder.<br><br>You can also view a public graph and make a personal copy.<br><br>See the help (upper right after you close this dialogue) to learn more.",noPublicGraphs:"First search for public graphs.  Note that a search with no keywords will return the most recent published graphs.",deleteMySeries:"This action will remove the series from your My Series favorites. Public series will still be available through the Public Series finder.  Any uploads or edits will be lost.  Please confirm to delete.",signInRequired:"You must be signed in to do this edit and create your own series.  Please use the sign in button to use your Facebook account."};var Et=0;var Ot={quickView:50,views:55,checkbox:25,save:25,shortDate:74,mmmyyyy:62,longDate:125,deleteIcon:35,map:125,periodicity:25,linkIcon:30,src:150,drillIcon:35,count:60,scrollbarWidth:35,padding:11};var Nt={heights:{graphTabsGap:null,tableControls:42,innerDataTable:null,scrollHeads:null,windowMinimum:580},widths:{windowMinimum:750,mySeriesTable:{columns:{}},publicSeriesTable:{columns:{}},myGraphsTable:{columns:{}},publicGraphTable:{columns:{}}}};var _t={};var Lt=7;var Gt=/\S/;var Rt;var jt;var qt;var zt;var Wt=0;var Bt=0;var Ht={};var Vt="",Yt="";var oMySeries={};var Xt={};var Qt={};var Zt=null;var Jt=null;var Kt=false;var ea=false;var ta;var aa=1;var ia=0;var na;var sa;var oa=-1;var ra={uselatest:"N"};var la;var da=[];var ca=false;if(typeof console=="undefined")console={};if(typeof console.info=="undefined")console.info=function(e){};if(typeof console.log=="undefined")console.log=function(e){};if(typeof console.time=="undefined")console.time=function(e){};if(typeof console.timeEnd=="undefined")console.timeEnd=function(e){};window.fbAsyncInit=function(){FB.init({appId:"209270205811334",channelURL:"//www.mashabledata.com/fb_channel.php",status:true,cookie:true,oauth:true,xfbml:true});FB.getLoginStatus(function(e){account.signInFB(e);FB.Event.subscribe("auth.login",function(e){account.signInFB(e)})})};function pa(){var e,t="facebook-jssdk";if(document.getElementById(t)){return}e=document.createElement("script");e.id=t;e.async=true;e.src="//connect.facebook.net/en_US/all.js";document.getElementsByTagName("head")[0].appendChild(e)}$(document).ready(function(){try{var e=window.localStorage.getItem("dummy")}catch(a){$("#dialog-top").html("MashableData Workbench requires a HTML 5 compliant browser.  The latest version of Internet Explorer, Chrome, Safari or Firefox are recommended.  Internet Explorer 8 users may experience slow rendering.<br><br>");Aa=$("#dialog").dialog({modal:true,title:"Incompatible browser",width:500});$(".ui-dialog-titlebar-close").remove();return false}$(document).mouse({distance:10});require(["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"]);It();$("#edit-my-series").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){Ha(na)});$("#quick-view-to-series").button({icons:{secondary:"ui-icon-person"}}).click(function(){qa(this)});$("#quick-view-delete-series").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){li(this)});$("#quick-view-chart-or-map").buttonset();$("#quick-view-map").button({icons:{secondary:"ui-icon-flag"}});$("#quick-view-chart").button({icons:{secondary:"ui-icon-image"}});$("#quick-view-add-to-graph").button().addClass("ui-state-active").click(function(){if($("#quick-view-map:visible").length==1&&$("#quick-view-map:checked").length==1){Wa(this)}else{za(this)}});$("#quick-view-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){Ba()});$(".show-graph-link").fancybox({width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none"});jQuery.fancybox.center=function(){};$("#show-hide-pickers").button({icons:{secondary:"browse-rollup"}});$("#menu-account").button({icons:{secondary:"ui-icon-triangle-1-s"}}).click(function(){account.showSignInOut()});$("#menu-help").button({icons:{secondary:"ui-icon-help"}}).click(function(){$helpMenu=account.showPanel('<div style="width:400px;height:300px;">'+"<ul>"+'<li><a target="help" title="Features" href="http://www.mashabledata.com/features/">Features and tour</a></li>'+'<li><a target="help" title="Searching and browsing for data" href="http://www.mashabledata.com/searching-and-browsing-for-data/">Searching and browsing for data</a></li>'+'<li><a target="help" title="Using series math to answer complex questions" href="http://www.mashabledata.com/using-series-math-to-answer-complex-questions/">Using series math to answer complex questions</a> (corn v. wheat)</li>'+'<li><a target="help" title="My Series &amp; Graphs" href="http://www.mashabledata.com/my-series-graphs/">My Series &amp; Graphs</a></li>'+'<li><a target="help" title="What are map sets and point sets?" href="http://www.mashabledata.com/what-are-map-sets-and-point-sets/">What are map sets and point sets?</a></li>'+'<li><a target="help" title="Creating maps" href="http://www.mashabledata.com/creating-maps/">Creating maps</a>'+"<ul>"+'<li><a target="help" title="Maps: Comparing against a regional average" href="http://www.mashabledata.com/creating-maps/maps-comparing-against-a-regional-average/">Comparing against a regional average</a> (Unemployment by state)</li>'+'<li><a target="help" title="Changing base maps" href="http://www.mashabledata.com/creating-maps/changing-base-maps/">Changing base maps</a></li>'+'<li><a target="help" title="Map colors (continuous, discrete and logarithmic)" href="http://www.mashabledata.com/workbench-help/creating-maps/map-colors-continuous-discrete-and-logarithmic/">Map colors (continuous, discrete and logarithmic)</a></li>'+'<li><a target="help" title="Bubble maps and user defined regions" href="http://www.mashabledata.com/workbench-help/creating-maps/bubble-maps-and-user-defined-regions/">Bubble maps and user defined regions</a></li>'+"</ul>"+"</li>"+'<li><a target="help" title="User series and the Highcharts plugin" href="http://www.mashabledata.com/workbench-help/user-series-and-the-highcharts-plugin/">User series and the Highcharts plugin</a></li>'+'<li><a target="help" title="Accounts: free, individual and corporate" href="http://www.mashabledata.com/workbench-help/accounts-free-individual-and-corporate/">Accounts: free, individual and corporate</a></li>'+'<li><a target="help" title="Publishing graphs and fair use" href="http://www.mashabledata.com/workbench-help/publishing-graphs-and-fair-use/">Publishing graphs and fair use</a></li>'+"</ul>"+"</div>",$("#menu-help"))});la=$("#series-tabs li a").click(function(){hi(this)}).filter("[data='#local-series']").get(0);Nt.heights.scrollHeads=$("div#local-series div.dataTables_scrollHead").height();fa();ma();Pa();ba();$("#series-table_filter input, #my_graphs_table_filter input").change(function(){mi()});ta=$("#canvas").tabs({tabTemplate:'<li class="graph-tab"><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close" onclick="removeTab(this)">Remove Tab</span></li>',add:function(e,t){var a="Loading graph.  Please wait.";return $(t.panel).append("<p>"+a+"</p>")},activate:function(e,t){mi()}});if(document.URL.indexOf("localhost")>=0){account.info.userId=2;account.info.accessToken="paste token here";ei()}else{pa()}$(window).bind("resize load",fa()).bind("focus",function(e){if(Kt){if(Pa()>0){Rt.fnFilter("");Rt.fnSort([[Lt,"asc"]])}}e.bubbles=true;return true});ga();va();$("#tblPublicSeries_processing, #tblPublicGraphs_processing").html("searching the MashableData servers...");$("div.dataTables_scrollBody").height(Nt.heights.innerDataTable);$("#series-search-button, #graphs-search-button").addClass("ui-state-active").button({icons:{secondary:"ui-icon-search"}});vi();$("ul#series-tabs").click(function(){Oa()});hasher.changed.add(ua);hasher.initialized.add(ua);hasher.init();window.onbeforeunload=function(){return"Your work will be lost."};for(var i in mapsList)da.push(i);da.sort();$("body").resize(fa);$("#series_search_periodicity, #series_search_source, #series-search-button").click(xa);$("#show-hide-pickers").click(function(){Ea();mi()});require(graphScriptFiles,function(){$.fn.colorPicker.defaults.colors.splice(-1,0,x,t);Highcharts.setOptions({tooltip:{formatter:function(){var e=gt(this.point.x,this.series.options.period)+"<br>"+this.series.name.trim()+":<br>"+Highcharts.numberFormat(this.y,parseInt(this.y)==this.y?0:3,".",",")+" "+this.series.yAxis.options.title.text;return e}}})});(function(){if(window.location.href.indexOf("workbenchdev")<0&&window.location.href.indexOf("nolog")<0&&!window.localStorage.getItem("nolog")){var e=jQuery.event.dispatch;jQuery.event.dispatch=function(){try{e.apply(this,arguments)}catch(t){vi();var a=window.nagivator?navigator.appName+" - "+navigator.appCodeName+" - "+navigator.appVersion:"undefined";$.ajax({type:"POST",url:"api.php",data:{command:"LogError",browser:a,url:window.location.href,message:t.message,stack:t.stack,uid:account.info.userId,lang:navigator.language,platform:navigator.platform,version:workbenchVersion},dataType:"json"});Ua("error","A error has occurred.  MashableData servers have logged the error and our technician have been alerted.")}}}})()});function ua(e,t){ca=true;var a,i={},n,s=e.split("&");for(var o=0;o<s.length;o++){n=s[o].split("=");i[n[0]]=n[1]}if(i.t){switch(i.t.toLowerCase()){case"ms":$("#series-tabs").find("li.local-series a").click();a=$("#series-table_filter").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s)).keyup()}if(ta.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cs":$("#series-tabs").find("li.cloud-series a").click();a=$("#series_search_text");Bt==i.cat||0;$("#series_search_periodicity").val(i.f||"all");$("#series_search_source").val(i.api||"all");$("#public-mapset-radio").find("input[value="+(i.sets||"all")+"]").click();if(Bt!=0){a.val("category: "+Ht[Bt].name);xa()}else{if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s));$("#series-search-button").click()}}if(ta.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"mg":$("#series-tabs").find("li.my-graphs a").click();a=$("#my_graphs_table_filter").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s)).keyup()}if(ta.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cg":$("#series-tabs").find("li.public-graphs a").click();a=$("#public_graphs_search").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s));xa(true)}if(ta.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;default:var r=$("#graph-tabs").find("a[href=#graphTab"+i.t.substr(1)+"]");if(r.length==1){r.click()}else{if(i.graphcode){for(var l in Qt){if(Qt[l].ghash==i.graphcode){var d=$("#graph-tabs a[href='#"+l+"']");if(d.length==1){var c=true;d.click();break}}}if(!c){Ta(i.graphcode)}}}$("#show-hide-pickers").hide()}}ca=false}function ha(e){if(!ca){hasher.changed.active=false;hasher.setHash(e);hasher.changed.active=true}}function fa(){var e=Math.max($(window).innerHeight()-10,Nt.heights.windowMinimum);var t=Math.max($(window).innerWidth()-10,Nt.widths.windowMinimum);$("div#wrapper").height(e).width(t);Nt.heights.menuBar=$("#title-bar").outerHeight(true);Nt.heights.canvas=e-Nt.heights.menuBar-2;Nt.heights.graphTabs=$("#graph-tabs").outerHeight();$("div#canvas").height(Nt.heights.canvas);$("div.graph-panel").height(Nt.heights.canvas-Nt.heights.graphTabs).width(t).css("margin","0").css("padding","0");Nt.heights.pickers=Nt.heights.canvas;$("div.picker").height(Nt.heights.pickers);Nt.heights.innerDataTable=Nt.heights.pickers-Nt.heights.tableControls-Nt.heights.scrollHeads-40;$("div.dataTables_scrollBody").height(Nt.heights.innerDataTable);Nt.widths.canvas=$("#canvas").innerWidth();Nt.widths.mySeriesTable.table=Nt.widths.canvas-8*Ot.padding-Ot.scrollbarWidth;var a=Nt.widths.mySeriesTable.table-(Ot.periodicity+2*Ot.shortDate+Ot.src+Ot.shortDate);Nt.widths.mySeriesTable.columns.units=parseInt(a*.2);Nt.widths.mySeriesTable.columns.series=parseInt(a*.55);Nt.widths.mySeriesTable.columns.category=parseInt(a*.25);$("#series-table_wrapper").find("thead").find("th.title").width(Nt.widths.mySeriesTable.columns.series+"px").end().find("th.units").width(Nt.widths.mySeriesTable.columns.units+"px").end().find("th.cat").width(Nt.widths.mySeriesTable.columns.category+"px");Nt.widths.publicSeriesTable.table=Nt.widths.canvas-7*Ot.padding-Ot.scrollbarWidth;a=Nt.widths.publicSeriesTable.table-(Ot.periodicity+Ot.src+2*Ot.mmmyyyy);Nt.widths.publicSeriesTable.columns.series=a*.4;Nt.widths.publicSeriesTable.columns.units=a*.3;Nt.widths.publicSeriesTable.columns.category=a*.3;$("#tblPublicSeries_wrapper").find("thead").find("th.title").width(Nt.widths.publicSeriesTable.columns.series+"px").end().find("th.units").width(Nt.widths.publicSeriesTable.columns.units+"px").end().find("th.cat").width(Nt.widths.publicSeriesTable.columns.category+"px");Nt.widths.myGraphsTable.table=Nt.widths.canvas-6*Ot.padding-Ot.scrollbarWidth;a=Nt.widths.myGraphsTable.table-(Ot.quickView+Ot.shortDate+Ot.map);Nt.widths.myGraphsTable.columns.title=a*.25;Nt.widths.myGraphsTable.columns.analysis=a*.5;Nt.widths.myGraphsTable.columns.series=a*.25;$("#my_graphs_table_wrapper").find("thead").find("th.title").width(Nt.widths.myGraphsTable.columns.title+"px").end().find("th.analysis").width(Nt.widths.myGraphsTable.columns.analysis+"px").end().find("th.series").width(Nt.widths.myGraphsTable.columns.series+"px");Nt.widths.publicGraphTable.table=Nt.widths.canvas-6*Ot.padding-Ot.scrollbarWidth;a=Nt.widths.publicGraphTable.table-(Ot.quickView+Ot.shortDate+Ot.map);Nt.widths.publicGraphTable.columns.title=a*.4;Nt.widths.publicGraphTable.columns.analysis=a*.35;Nt.widths.publicGraphTable.columns.series=a*.25;$("#tblPublicGraphs_wrapper").find("thead").find("th.title").width(Nt.widths.publicGraphTable.columns.title+"px").end().find("th.analysis").width(Nt.widths.publicGraphTable.columns.analysis+"px").end().find("th.series").width(Nt.widths.publicGraphTable.columns.series+"px")}function ma(){Rt=$("#series-table").html("").dataTable({bProcessing:true,sDom:"frti",bPaginate:false,bFilter:true,bAutoWidth:false,fnInfoCallback:function(e,t,a,i,n,s){return"showing "+(i==n?"":n+" of ")+i+" series"},oLanguage:{sSearch:""},sScrollY:Nt.heights.innerDataTable-140+"px",aaSorting:[[Lt,"desc"]],aoColumns:[{mData:"name",sTitle:"Series Name<span></span>",sClass:"title",bSortable:true,sWidth:Nt.widths.mySeriesTable.columns.series+"px",mRender:function(e,t,a){return(a.mapsetid?Pt.mapset:"")+(a.pointsetid?Pt.pointset:"")+(a.themeid?Pt.hasCubeViz:"")+e+'<span class="handle">'+a.handle+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",bSortable:true,sWidth:Nt.widths.mySeriesTable.columns.units+"px",mRender:function(e,t,a){return e}},{mData:"period",sTitle:"P<span></span>",sClass:"dt-freq",bSortable:true,sWidth:Ot.periodicity+"px",mRender:function(e,t,a){return $a(a.period)}},{mData:"firstdt",sTitle:"from<span></span>",sClass:"dte",sWidth:Ot.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return gt(e,a.period)}},{mData:"lastdt",sTitle:"to<span></span>",sClass:"dte",sWidth:Ot.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return gt(e,a.period)}},{mData:"graph",sTitle:"Category<span></span>",sClass:"cat",bSortable:true,sWidth:Nt.widths.mySeriesTable.columns.category+"px",mRender:function(e,t,a){return e}},{mData:null,sTitle:"Source<span></span>",sClass:"dt-source",bSortable:false,sWidth:Ot.src+"px",resize:false,mRender:function(e,t,a){if(a.url){return Da(a.url,a.src)}else{return'<span class=" ui-icon ui-icon-person" title="user series"></span> '+a.username||""}}},{mData:"save_dt",sTitle:"added<span></span>",bSortable:true,sType:"numeric",sWidth:Ot.shortDate+"px",resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return ka(e)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){Rt.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");La()}});$("#series-table_filter").appendTo("#series-bar-controls").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#series-table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("enter key phrase to filter").addClass("grey-italics").on("click keydown",function(){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ya);$(".new-series").button().click(function(){Va()});$("#series-table_info").appendTo("#local-series-header")}function ga(){jt=$("#tblPublicSeries").html("").dataTable({sDom:"frti",bServerSide:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public series"},fnServerData:function(e,t,a){var i=$("#tblPublicSeries_filter input").val();t.push({name:"command",value:"SearchSeries"});t.push({name:"uid",value:Ka()});t.push({name:"accessToken",value:account.info.accessToken});t.push({name:"periodicity",value:$("#series_search_periodicity").val()});t.push({name:"apiid",value:$("#series_search_source").val()});t.push({name:"catid",value:Bt});t.push({name:"mapset",value:$("input:radio[name=public-mapset-radio]:checked").val()});t.push({name:"lastSearch",value:Vt});t.push({name:"search",value:i});if(Vt!=i){Vt=i;jt.fnSort([]);return}$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,i){Et+=parseFloat(e.exec_time);console.log(e.command+" ("+e.search+"): "+e.exec_time+" ("+Et+"ms)");if(e.status=="ok")a(e,t,i);else Ua("server error",e.status)},error:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,i,n,s){return n+" series"},bAutoWidth:false,bProcessing:true,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bDestroy:true,sScrollX:$("#canvas").width()-55+"px",aaSorting:[],iDeferLoading:0,aoColumns:[{mData:"name",sTitle:"Series Name<span></span>",bSortable:true,sWidth:Nt.widths.publicSeriesTable.columns.series+"px",sClass:"title",mRender:function(e,t,a){return(a.mapsetid?Pt.mapset:"")+(a.pointsetid?Pt.pointset:"")+(a.themeid?Pt.hasCubeViz:"")+Sa(e)+'<span class="handle">'+(a.userid?"U":"S")+a.seriesid+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",sWidth:Nt.widths.publicSeriesTable.columns.units+"px",bSortable:true,mRender:function(e,t,a){return Sa(e)}},{mData:null,sTitle:"P<span></span>",sWidth:Ot.periodicity+"px",bSortable:true,sClass:"dt-freq",mRender:function(e,t,a){return $a(a.period)}},{mData:"firstdt",sTitle:"from<span></span>",sClass:"dte",sWidth:Ot.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],mRender:function(e,t,a){return Sa(gt(e,a.period))}},{mData:"lastdt",sTitle:"to<span></span>",sClass:"dte",sWidth:Ot.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){return Sa(gt(e,a.period))}},{mData:"title",sTitle:"Category (click to browse)<span></span>",sClass:"cat",sWidth:Nt.widths.publicSeriesTable.columns.category+"px",bSortable:true,mRender:function(e,t,a){if(a.apiid!=null&&a.title!=null){return'<span class="ui-icon browse-right">browse similar series</span> '+Sa(e)}else{return Sa(e)}}},{mData:null,sTitle:"Source<span></span>",bSortable:false,sClass:"url",sWidth:Ot.src+"px",resize:false,mRender:function(e,t,a){return Da(a.url,a.src)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){jt.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");Ga()}if(t.hasClass("cat")){var a=t.closest("tr").find("span.handle").html();if(a)Ya(a.substr(1))}});$("#tblPublicSeries_info").html("").appendTo("#cloud-series-search");$("#tblPublicSeries_filter").hide();$("#public-mapset-radio").buttonset().find("input").change(function(){xa()});$("#series_search_text").val("enter search keywords (-keyword to exclude)").keyup(function(e){wa(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")});$("#cloud-series-browse").button({icons:{secondary:"ui-icon-circle-triangle-e"}}).click(function(){Ya()})}function ba(){qt=$("#my_graphs_table").html(" ").dataTable({sDom:"frti",bFilter:true,bPaginate:false,bAutoWidth:false,bProcessing:true,bDestroy:true,fnInfoCallback:function(e,t,a,i,n,s){return(i==n?"":"found "+n+" of ")+i+" graphs"+(n>0?" <b>Click on a title to open</b>":"")
},oLanguage:{sSearch:""},oColReorder:{iFixedColumns:2},sScrollY:Nt.heights.innerDataTable-120+"px",sScrollX:Nt.widths.myGraphsTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"wrap title",sWidth:Nt.widths.myGraphsTable.columns.title+"px",mRender:function(e,t,a){return e.trim()+'<span class="handle" data="G'+a.gid+'">G'+a.gid+"</span> "}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:Ot.map+"px",mRender:function(e,t,a){return(a.mapsets?a.mapsets.options.mode=="bubble"?Pt.hasBubbleMap:Pt.hasHeatMap:"")+(a.pointsets?Pt.hasMarkerMap:"")+(a.themeid?Pt.hasCubeViz:"")+Sa(e)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:true,sClass:"analysis",sWidth:Nt.widths.myGraphsTable.columns.analysis+"px",mRender:function(e,t,a){return Sa(e.trim())}},{mData:"serieslist",sTitle:"Series ploted or mapped<span></span>",bSortable:true,sClass:"series",sWidth:Nt.widths.myGraphsTable.columns.series+"px",mRender:function(e,t,a){return Sa(e)}},{mData:null,sTitle:"Views<span></span>",bSortable:true,sClass:"dt-count",sWidth:Ot.views+"px",mRender:function(e,t,a){if(a.published=="N"){return'<span class=" ui-icon ui-icon-locked" title="This graph has not been published.  You must publish your graphs from the graph editor">locked</span>'}else{return a.views}}},{mData:"updatedt",sTitle:"Created<span></span>",asSorting:["desc","asc"],sType:"numeric",sClass:"dte",sWidth:Ot.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return ka(e)}}]}).click(function(e){var t=$(e.target).closest("td");qt.find("tr.ui-selected").removeClass("ui-selected");var a=qt.fnGetData(t.closest("tr").addClass("ui-selected").get(0));Ta(a.gid)});$("#my_graphs_table_filter").prependTo("#myGraphsHeader").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#my_graphs_table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("search my graphs").addClass("grey-italics").on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ya);$("#my_graphs_table_info").appendTo("#myGraphsHeader")}function va(){zt=$("#tblPublicGraphs").dataTable({sDom:"frti",bPaginate:false,bDestroy:true,bAutoWidth:false,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bProcessing:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public graphs"},bServerSide:true,fnServerData:function(e,t,a){t.push({name:"command",value:"SearchGraphs"});t.push({name:"search",value:$("#tblPublicGraphs_filter input").val()});$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,i){if(e.status=="ok")a(e,t,i);else Ua("server error",e.status)},complete:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,i,n,s){return n+" graph"+(n==1?"s":"")+(n>0?" <b>click on title to view</b>":"")},iDeferLoading:0,oColReorder:{iFixedColumns:2},sScrollX:Nt.widths.publicGraphTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"title",sWidth:Nt.widths.publicGraphTable.columns.title+"px",mRender:function(e,t,a){return e+'<span class="handle">G'+a.graphid+"</span>"}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:Ot.map+"px",mRender:function(e,t,a){return(a.mapsets?Pt.hasHeatMap:"")+(a.pointsets?Pt.hasMarkerMap:"")+(a.themeid?Pt.hasCubeViz:"")+Sa(e)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:false,sWidth:Nt.widths.publicGraphTable.columns.analysis+"px"},{mData:"serieslist",sTitle:"Series<span></span>",bSortable:false,sClass:"series",sWidth:Nt.widths.publicGraphTable.columns.series+"px"},{mData:"views",sTitle:"Views<span></span>",bSortable:true,sClass:"count",sWidth:Ot.views+"px"},{mData:"modified",sTitle:"Modified<span></span>",bSortable:true,sType:"numeric",asSorting:["desc","asc"],sClass:"dte",sWidth:Ot.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return ka(e)}}]}).click(function(e){var t=$(e.target).closest("td");zt.find("tr.ui-selected").removeClass("ui-selected");var a=zt.fnGetData(t.closest("tr").addClass("ui-selected").get(0));var i=zt.find("tr.ui-selected");if(i.length==1){var a=zt.fnGetData(i.get(0));if(a){hasher.setHash(encodeURI("t=g&graphcode="+a.ghash))}else{Ua("search for public graphs",Ft.noPublicGraphs)}}});$("#tblPublicGraphs_info").appendTo("#public_graphs_search");$("#tblPublicGraphs_filter").hide();$("#graphs_search_text").val("enter search terms or leave blank for latest graphs").keyup(function(e){Ma(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")})}function ya(){var e=$(this);var t=e.closest("div").find("span.filterReset");if(e.val().length==0){t.removeClass("ui-icon-circle-close").addClass("ui-icon-circle-close-inactive")}else{t.removeClass("ui-icon-circle-close-inactive").addClass("ui-icon-circle-close")}}function ka(e){var t=new Date;var a=t.toDateString();if(isNaN(e)){t.setTime(Date.parse(e))}else{t.setTime(e)}if(t.toDateString()==a){return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(16,5)+"</span>"}else{return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(4,11)+"</span>"}}function wa(e){var t="which"in e?e.which:e.keyCode;if(Bt){var a=$("#series_search_text");a.val(a.val().replace("category: ",""));Bt=0}if(t==13&&e.target.id=="series_search_text"||e.target.id!="series_search_text"){xa();e.preventDefault()}}function xa(e){Xa();var t=$("#series_search_text");if(Bt&&$("#series_search_source").val()!="ALL"){t.val(t.val().replace("category: ",""));Bt=0}var a=t.hasClass("grey-italics")?"":t.val();if(a.match(/(title|name|skey):"[^"]+"/i)==null){a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/ /g," +")}$("#tblPublicSeries_filter input").val(a);jt.fnFilter(a);if(!e)mi()}function Ca(e){var t='title:"'+$(e).text()+'"';$("#series_search_text").val(t);xa()}function Ma(e){var t="which"in e?e.which:e.keyCode;if(t==13&&e.target.id=="graphs_search_text"||e.target.innerHTML=="search"){var a=$("#graphs_search_text").hasClass("grey-italics")?"":$("#graphs_search_text").val();a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/ /g," +");$("#tblPublicGraphs_filter input").val(a);zt.fnFilter(a);mi()}}function $a(e){switch(e){case"D":return'<span title="Daily data">D</span>';case"W":return'<span title="Weekly data">W</span>';case"M":return'<span title="Monthly data">M</span>';case"Q":return'<span title="Quarterly data">Q</span>';case"SA":return'<span title="Semi-annual data">SA</span>';case"A":return'<span title="Annual data">A</span>';default:return e}}function Sa(e){return'<span title="'+(e==null?" ":e)+'">'+(e==null?" ":e)+"</span>"}function Da(e,t){t=t||e.replace(/\b(http(s)*:\/\/)*(www.)*/gi,"").replace("/"," /");return'<a href="'+e+'" target="_blank" title="'+e+'"><span class=" ui-icon ui-icon-extlink">'+e+"</span>"+t+"</a>"}function Ta(e){z(e);Na()}var Aa;function Ia(){Ua("User Agreement","<span id=\"dialog-top\">MashableData is a free workbench to analyze and graph data series.  Data series viewed using our plugin have been securely cached in your browser's local storage.  To power the workbench, the data series must be shared with our servers.  Once sharing is enabled, you will be able to search and view series and public graphs on MashableData.com's servers.<br /><br />"+'<span id="dialog-learn"><i>To learn more, please read <a href="/" target="help">how MashableData works</a> and our <a href="/" target="help">privacy policy</a>.</i></span>'+"<br /><br />Ok to anonymously share the datasets you have browsed?</span>",[{text:"Enable",id:"btn-dia-enable",click:function(){var e=new Date;window.localStorage.setItem("authorized",e);pa();$(this).dialog("close")}},{text:"Disable",id:"btn-dia-disable",click:function(){window.localStorage.clear();window.localStorage.setItem("authorized","no");$(this).dialog("close");window.location="."}}])}function Ua(e,t,a){$("#dialog").html("<br><br>"+t+"<br><br>");if(!a){a=[{text:"OK",id:"btn-OK",click:function(){$(this).dialog("close")}}]}Aa=$("#dialog").dialog({modal:true,title:e,width:500,buttons:a,open:function(){$("#btn-dia-enable").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}function Pa(){var e,t=0,a={},i=window.localStorage.getItem("newSeries");if(i!=null){window.localStorage.removeItem("newSeries");var n=JSON.parse(i);var s=new Date;var o={command:"UploadMyMashableData",adddt:s.getTime(),series:[]};for(var r=0;r<n.length;r++){t++;e=JSON.parse(localStorage.getItem(n[r]));localStorage.removeItem(n[r]);e.handle="L"+ia++;e.data=l(e);if(account.loggedIn()){o.series.push(e);a[e.handle]=e}else{oMySeries[e.handle]=e;oi($.extend({},e))}}if(account.loggedIn()){bi(o,function(t,i,n){var s;for(var o in t.handles){s=t.handles[o];a[o].handle=s;e.usid=s.substr(1);oi($.extend({},a[o]))}})}}Kt=true;return t}function Fa(e,t){var a=window.localStorage.getItem(t);var i=false;if(a==null){}else{var n=a.split("|");for(var s=0;s<n.length;s++){if(n[s]==e){n.splice(s,1);i=true}}if(n.length==0){window.localStorage.removeItem(t)}else{window.localStorage.setItem(t,n.join("|"))}}return i}function Ea(){var e=$("div.picker:visible").length;if(e==1){$(".show-hide").slideToggle(function(){var e=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");$(e).hide()});$("#show-hide-pickers").hide({complete:mi})}else{$(".show-hide").slideToggle(function(){});if(ta.find("li.graph-tab").length>0)$("#show-hide-pickers").show()}}function Oa(){if($("div.picker:visible").length==0)Ea()}function Na(){if($("div.picker:visible").length==1)Ea()}function _a(e){var t=$(e).closest("div.graph-panel").get(0).id;Qt[t].controls.chart.setTitle({text:e.value});Qt[t].title=e.value;if(e.value.length==0){var a="Graph"+t.substring(t.indexOf("-")+1);$("a[href=#"+t+"]").html(a).attr("title",a)}else{$("a[href=#"+t+"]").html(e.value).attr("title",e.value)}Qt[t].controls.chart.redraw()}function La(){var e=[],t=false;$("#local-series-header input").focus();Zt=Rt.find("tr.ui-selected").each(function(){e.push(Rt.fnGetData(this))});if(e.length==0){for(var a in oMySeries){t=true;break}if(t)Ua("no series selected",Ft.noSeriesSelected);else Ua("no series selected",Ft.noMySeries)}else{Ra(e,false)}}function Ga(){var e=[],t=false;$("#series_search_text").focus();jt.find("tr.ui-selected").each(function(){e.push(jt.fnGetData(this))});if(e.length==0){Ua("selection required",Ft.noSeriesSelected)}else{Ra(e,true)}}function Ra(e,t){var a=[],i=[],n,s;for(s=0;s<e.length;s++){if(!e[s].data){if(e[s].handle[0]=="S")a.push(e[s].handle.substring(1));if(e[s].handle[0]=="U")i.push(e[s].handle.substring(1))}}if(a.length+i.length==0){ja(e,t)}else{bi({command:"GetMashableData",sids:a,usids:i},function(a,i,o){for(s=0;s<e.length;s++){n=e[s].handle;if(oMySeries[n]){oMySeries[n].data=a.series[n].data;oMySeries[n].notes=a.series[n].notes;oMySeries[n].geocounts=a.series[n].geocounts}e.splice(s,1,a.series[n])}ja(e,t)})}}function ja(e,t){var a,i,n;var s=false,o=[],r=[],l=[];var d=$("#quick-view-maps");if(Zt)$("#quick-view-delete-series").show();else $("#quick-view-delete-series").hide();if(e.plots){a=e;na=e}else{if(e instanceof Array)i=e;else i=[e];na=i;a=W();a.plots=[];var c=[];for(n=0;n<i.length;n++){a.assets[i[n].handle]=i[n];a.plots.push({components:[{handle:i[n].handle,options:{k:1,op:"+"}}],options:{}});c.push(i[n].handle)}}var p=B(a);delete p.chart.height;if(i instanceof Array){if(i.length==1){p.title={text:i[0].name};p.legend={enabled:false}}else{delete p.title}}p.chart.borderWidth=2;p.chart.renderTo="highcharts-div";sa=new Highcharts.Chart(p);var u="";if(!e.plots){if(i.length==1&&i[0].notes){u='<table><tr><td width="20%">Graph title or API category:</td><td width="*">'+i[0].graph||""+"</td></tr>"+"<tr><td>Series notes:</td><td>"+i[0].notes||""+"</td></tr>"+"<tr><td>My Series count:</td><td>"+i[0].myseriescount||""+"</td></tr>"+"<tr><td>Graphs (including unpublished) count:</td><td>"+i[0].graphcount||""+"</td></tr>"+"<tr><td>Series key:</td><td>"+i[0].skey||""+"</td></tr>"+"</table>"}for(n=0;n<i.length;n++){if(i[n].mapsetid&&l.indexOf("M"+i[n].mapsetid)==-1||i[n].pointsetid&&l.indexOf("X"+i[n].pointsetid)==-1){if(i[n].mapsetid)l.push("M"+i[n].mapsetid);else l.push("X"+i[n].pointsetid);for(var h in i[n].geocounts){if(i[n].geocounts[h].set>1){s=true;if(i[n].geocounts[h].regions){o.push('<option value="'+h+'">'+h+" ("+i[n].geocounts[h].set+")</option>")}else{r.push('<option class="other-map" value="'+h+'">'+h+" ("+i[n].geocounts[h].set+")</option>")}}}}}}if(s){o.sort();r.sort();$("#quick-view-chart-or-map").show().find("input").off().click(f);d.html(o.join("")+(r.length>0?'<option class="other-maps" value="other">other maps for this set:</option>'+r.join(""):""))}else{d.hide();$("#quick-view-chart-or-map").hide()}$("#qv-info").html(u);function f(){var e=$("#quick-view-chart-or-map input:checked").val()!="chart";var t=d.css("display")!="none";if(e&&!t||!e&&t)d.animate({width:"toggle"})}f();if(t){$("#quick-view-to-series").button("disable").show();$("#quick-view-delete-series").hide()}else{$("#quick-view-to-series").hide();$("#quick-view-delete-series").show()}var m='<option value="new">new graph</option>';$("div.graph-panel").each(function(){var e=$("ul#graph-tabs li a[href='#"+this.id+"']");m+='<option value="'+this.id+'"'+(e.closest("li").hasClass("ui-tabs-selected")?" selected":"")+">"+e.get(0).innerHTML+"</option>"});$("#quick-view-to-graphs").html(m).val(ct()).off().click(function(){$("#quick-view-add-to-graph").find(".ui-button-text").html($(this).val()=="new"?"create graph":"add to graph")}).click();$(".show-graph-link").click()}function qa(e){$(e).button("disable");for(var t=0;t<na.length;t++){na[t].save_dt=(new Date).getTime();var a=oi(na[t]);si(na[t])}Ua("My Series","series added.",[]);$("#dialog").closest(".ui-dialog").fadeOut(1e3,function(){$("#dialog").dialog("close")})}function za(e){var t,a=$("#quick-view-to-graphs").val();if(na.plots){if(a!="new"){var i=na.plots,n=Qt[a];n.controls.provenance.provOk(false);if(!n.plots)n.plots=[];for(var s=0;s<i.length;s++){n.plots.push(i[s])}for(var o in na.assets){Qt[a].assets[o]=Qt[a].assets[o]||na.assets[o]}$("ul#graph-tabs li a[href='#"+a+"']").click();n.controls.redraw()}else{nt(na)}}else{if(!(na instanceof Array))na=[na];if(a!="new"){t=Qt[a];t.controls.provenance.provOk(false)}else{t=W()}if(!t.plots)t.plots=[];for(var r=0;r<na.length;r++){t.assets[na[r].handle]=$.extend({save_dt:(new Date).getTime()},na[r]);t.plots.push({components:[{handle:na[r].handle,options:{k:1,op:"+"}}],options:{}})}if(a!="new"){$("ul#graph-tabs li a[href='#"+a+"']").click();t.controls.redraw()}else{nt(t)}}Ba();Na();mi()}function Wa(){var e=$("#quick-view-to-graphs").val();var t;var a=$("#quick-view-maps").val();if(Qt[e]&&Qt[e].map&&(Qt[e].map!=a||Qt[e].mapsets&&na[0].period!=Qt[e].assets[Qt[e].mapsets.components[0].handle].period||Qt[e].pointsets&&na[0].period!=Qt[e].assets[Qt[e].pointsets[0].components[0].handle].period)){Ua("Map Error","This graph already has a "+Qt[e].map+" map.  Additional map data can be added, but must use the same base map <i>and</i> data set must have same frequecy.");return null}if(a=="other"){Ua("selection required","Please select a base map to graph this set.");return null}var i;if(e=="new"){i=W()}else{i=Qt[e];i.controls.provenance.provOk(false)}i.map=a;i.mapconfig.legendLocation=mapsList[a].legend;i.mapFile=mapsList[a].jvectormap;require(["/global/js/maps/"+i.mapFile+".js"]);if(!i.plots)i.plots=[];for(var n=0;n<na.length;n++){serie=na[n];i.plots.push({options:{},components:[{handle:serie.handle,options:{k:1,op:"+"}}]});if(serie.geocounts&&serie.geocounts[a]){if(!isNaN(serie.mapsetid)&&serie.mapsetid>0&&!o(serie.mapsetid)){if(!i.mapsets)i.mapsets={options:{},components:[]};t="M"+serie.mapsetid;i.mapsets.components.push({handle:t,options:{k:1,op:i.mapsets.components.length==0?"+":"/"}})}if(!isNaN(serie.pointsetid)&&serie.pointsetid>0&&!r(serie.pointsetid)){if(!i.pointsets)i.pointsets=[];t="X"+serie.pointsetid;i.pointsets.push({options:{},components:[{handle:t,options:{k:1,op:"+"}}]})}}}if(serie.themeid){if(_t["T"+serie.themeid]){s(serie.themeid)}else{bi({command:"GetCubeList",themeids:[serie.themeid]},function(e,t,a){_t["T"+serie.themeid]=e.themes["T"+serie.themeid];s(serie.themeid)})}}else l();Ba();function s(e){var t=_t["T"+e];var a='<div id="select-cube" style="width:330px;">'+"<h4>Map linked visualization available</h4>"+"<p>This series is part of a "+t.name+"structure set that supports the following facetted vizualizations, which will be linked to the user's map clicks.</p><p>Please choose one.</p>"+'<select class="cubeSelector" size="'+t.cubes.length+'">';for(var n=0;n<t.cubes.length;n++){a+='<option value="'+t.cubes[n].cubeid+'" '+(n==t.cubes.length-1?"selected":"")+">"+t.cubes[n].name+"</option>"}a+="</select></label><br><br>"+'<button class="right" id="noViz">skip</button> <button class="right" id="vizSetOk">add linked visualization</button> '+"</div>";$.fancybox(a,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var s=$("#select-cube");$("#vizSetOk").button({icons:{secondary:"ui-icon-cube"}}).click(function(){var e=s.find(".cubeSelector").val();i.mapconfig.cubeid=e;o()});$("#noViz").button({icons:{secondary:"ui-icon-close"}}).click(function(){o()});function o(){$.fancybox.close();l()}}function o(e){if(i.mapsets){for(var t=0;t<i.mapsets.components.length;t++){if(i.mapsets.components.handle=="M"+e)return true}}return false}function r(e){if(i.pointsets){for(var t=0,a=i.pointsets.length;t<a;t++){for(var n=0,a=i.pointsets[t].components.length;n<a;n++){if(i.pointsets[t].components.handle=="X"+e)return true}}}return false}function l(){R(i,function(){require(["/global/js/maps/"+i.mapFile+".js"],function(){if(i.title===null||i.title==""){i.title=i.mapsets?rt(i,i.mapsets):rt(i,i.pointsets[0])}if(e=="new"){nt(i)}else{$("ul#graph-tabs li a[href='#"+e+"']").click();i.controls.redraw()}yi("drawing");mi()});Na()})}}function Ba(){sa.destroy();delete Zt;$("#fancybox-close").click()}function Ha(e){if($("#outer-show-graph-div:visible").length==1)Ba();if(e.length==1){var t=e[0];if(t.mapsetid||t.pointsetid){var a='<div id="seriesOrSet" style="width:330px;">'+"<h4>This series is part of a set</h4>"+'<label><input type="radio" name="editSeriesOrSet" value="series" checked> edit just this series </label><br>'+'<label><input type="radio" name="editSeriesOrSet" value="set"> view and edit the set\'s series for the map:<br>'+'<select class="hidden" style="margin-top: 8px;margin-left: 25px"></select></label><br><br>'+'<button class="right" id="seriesOrSetCancel">cancel</button> <button class="right" id="seriesOrSetOk">OK</button>'+"</div>";$.fancybox(a,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var i=$("#seriesOrSet");var n,s="",o=i.find("select").html("").show().click(function(){i.find("input:radio").removeAttr("checked").filter('[value="set"]').attr("checked","checked")});if(t.geocounts){for(n in t.geocounts){s+='<option value="'+n+"|"+mapsList[n].jvectormap+'">'+n+" ("+t.geocounts[n].set+")</option>"}o.html(s)}else{bi({command:"GetAvailableMaps",mapsetid:t.mapsetid,pointsetid:t.pointsetid,geoid:t.geoid},function(e,t,a){for(var i=0;i<e.maps.length;i++){s+='<option value="'+e.maps[i].name+"|"+e.maps[i].file+'">'+e.maps[i].name+" ("+e.maps[i].count+")</option>"}o.html(s)})}$("#seriesOrSetOk").button({icons:{secondary:"ui-icon-check"}}).click(function(){if($("input:radio[name='editSeriesOrSet']:checked").val()=="series"){Va(e)}else{if(t.pointsetid)Va("X"+t.pointsetid,o.val());if(t.mapsetid)Va("M"+t.mapsetid,o.val())}$.fancybox.close()});$("#seriesOrSetCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}else Va(e)}else Va(e)}function Va(e,t){if(!account.loggedIn()){Ua("account required",Ft.signInRequired);return}var a;var i=false;var n=false;var s=2;var o="U";$("#series-tabs").find("li.local-series a").click();var r=["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"];var l=null,d={U:{name:0,units:1,notes:2,handle:3,header:4},M:{name:0,units:1,notes:2,geoid:3,handle:4,header:5},X:{name:0,units:1,notes:2,geoid:3,handle:4,lat:5,lon:6,header:7}};if(e&&!Array.isArray(e)){require(r);if(e[0]=="M"){o=e;bi({command:"GetSet",mapsetid:parseInt(o.substr(1)),map:t.split("|")[0],modal:"persist"},function(e,t,a){require(r,function(){p(e.setData)})});function p(e){h();var t,a,i,n,r,l=[["map set",e.name],["units",e.units],["notes",""],["geoid"],[o],["date"]];for(i=0;i<e.geographies.length;i++){l[d.M.geoid].push(e.geographies[i].geoid);console.info("trying to set mapset's series handles");l[d.M.handle].push(e.geographies[i].handle);l[d.M.header].push(e.geographies[i].geoname);r=d.M.header+1;if(e.geographies[i].data){t=e.geographies[i].data.split("||");t.sort();for(n=0;n<t.length;n++){a=t[n].split("|");while(r<l.length&&l[r][0]<a[0])l[r++].push("");if(r==l.length){l.push(c())}else{if(l[r][0]==a[0])l[r].push(a[1]);if(l[r][0]<a[0])l.splice(r,0,c())}r++}}while(r<l.length)l[r++].push("");function c(){var e,t=[a[0]];for(e=1;e<l[4].length-1;e++)t.push("");t.push(a[1]);return t}}s=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:s}).find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();vi()}}if(e[0]=="X"){o=e;bi({command:"GetPointSets",pointsetids:[parseInt(o.substr(1))],map:t.split("|")[0],modal:"persist"},function(e,t,a){require(r,function(){u(e.pointsets[o])})});function u(e){h();var t,a,i,n,r,l=[["marker set",e.name],["units",e.units],["notes",""],["geoid"],["lat"],["lon"],[o],["date"]];for(var c in e.data){l[d.X.geoid].push(e.data[c].geoid);l[d.X.handle].push(e.data[c].handle);l[d.X.lat].push(e.data[c].lat);l[d.X.lon].push(e.data[c].lon);l[d.X.handle].push(e.data[c].handle);l[d.X.header].push(e.data[c].name.replace(e.name,"").trim());r=d.X.header+1;if(e.data[c].data){t=e.data[c].data.split("||");t.sort();for(n=0;n<t.length;n++){a=t[n].split("|");while(r<l.length&&l[r][0]<a[0])l[r++].push("");if(r==l.length){l.push(p())}else{if(l[r][0]==a[0])l[r].push(a[1]);if(l[r][0]<a[0])l.splice(r,0,p())}r++}}while(r<l.length)l[r++].push("");function p(){var e,t=[a[0]];for(e=1;e<l[d.X.header].length-1;e++)t.push("");t.push(a[1]);return t}}s=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:s}).find("table.htCore tr").show().filter(":eq("+d.X.handle+")").hide().end().filter(":eq("+d.X.geoid+")").hide();vi()}}}else{require(r,function(){m(e)})}function h(){s=2;var e=0,t=0;var r=$("div#edit-user-series").height($("div#local-series").height()).fadeIn();a=$("#data-editor").height($("div#local-series").height()-50).html("");r.find("button.series-edit-save").button({icons:{secondary:"ui-icon-disk"}}).off().click(function(){v()});r.find("button.series-edit-cancel").button({icons:{secondary:"ui-icon-close"}}).off().click(function(){y()});r.find("button.series-edit-preview").button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var e=b();if(e)ja(e,false)});r.find("button.series-edit-geoset").button({icons:{secondary:"ui-icon-flag"}}).show().off().click(function(){g()});r.find("button.series-edit-save-as").button({icons:{secondary:"ui-icon-copy"}});a.handsontable({minCols:2,minSpareCols:-1,minSpareRows:1,autoWrapRow:true,contextMenu:["row_above","row_below","col_right"],fillHandle:false,cells:function(e,t,a){var i={};if(e<d[o[0]].header&&t==0||e==d[o[0]].header){i.readOnly=true}i.type={renderer:f};return i},onSelection:function(i,s,o,r){if(i==o&&s==r){var l=$(a.handsontable("getCell",i,s)).css("background-color").toUpperCase();if(l=="RGB(224, 255, 255)"||l=="#E0FFFF")a.handsontable("selectCell",i,s+1);if(l=="RGB(128, 128, 128)"||l=="#808080"){a.handsontable("selectCell",i+(t==s&&e-i==1?-1:1),s)}e=i;t=s;if(i>4){var d=a.handsontable("getDataAtCell",i,0);if(d==""||d==null){var c=(a.handsontable("getDataAtCell",i-1,0)||"").toString();if(c.length>3){var p=pt(c);if(p){n=ut(c);if(n){a.handsontable("setDataAtCell",i,0,gt(ft(p,n),n))}}}}}}},onBeforeChange:function(e){var t=0;for(var a=0;a<e.length;a++){if(e[a][1]>t)t=e[a][1]}if(t>=s){s=t+1;$("#data-editor").handsontable("updateSettings",{cols:s});for(a=2;a<s;a++)$("#data-editor").handsontable("getCell",3,a).innerHTML="value"}},onChange:function(e,t){if(t=="edit"||t=="empty"){try{var i=a.handsontable("getDataReference");for(var n=i[0].length-1;n>1;n--){var s="";for(var o=0;o<i.length;o++){if(o!=3)s+=i[o][n];if(Gt.test(s))break}if(Gt.test(s))break;a.handsontable("alter","remove_col",n,n+1)}i=a.handsontable("getDataReference");for(var o=i.length-1;o>5;o--){var s="";for(var n=0;n<i[0].length;n++){if(o!=3)s+=i[o][n]}if(Gt.test(s))break;if(o<i.length-1)a.handsontable("alter","remove_row",o)}}catch(r){console.log(r)}}}});i=true}function f(e,t,a,i,n,r,l){switch(o[0]){case"U":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.U.header&&i==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}if(a==d.U.header){t.style.background="#808080";t.style.fontWeight="bold"}break;case"M":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.M.header){if(i==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}else{if(i==1){t.colSpan=Math.min(5,s-1)}else{$(t).addClass("hidden")}}}if(a==d.M.header){t.style.background="#808080";t.style.fontWeight="bold"}}}function m(e){if(!i)h();var t,a,s=$("#data-editor");$("button#series-edit-save").attr("disabled","disabled");if(e){var o=e[0],r=o.handle;var l=r[0];switch(l){case"U":$("button#series-edit-save").removeAttr("disabled");case"S":n=o.period;if(o.data){t=o.data.split("||").sort();for(a=0;a<t.length;a++){t[a]=t[a].split("|");t[a][0]=gt(c(t[a][0]).getTime(),o.period)}t.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);s.attr("data",r).handsontable("loadData",t);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()}else{var p=[],u=[];if(r.charAt(0)=="U")u.push(parseInt(r.substr(1)));else p.push(parseInt(r.substr(1)));bi({command:"GetMashableData",sids:p,usids:u},function(e,t,a){o.data=e.series[r].data;o.notes=e.series[r].notes;var i=e.series[r].data.split("||").sort();for(var n=0;n<i.length;n++){i[n]=i[n].split("|");i[n][0]=gt(c(i[n][0]).getTime(),o.period)}i.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);s.attr("data",r).handsontable("loadData",i);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()})}break;default:Ua("series editor","This option is not yet supported");return}}else{s.handsontable("loadData",[["name",""],["units",""],["notes",""],["handle","new"],["date","value"]]);s.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide();n=false}$("div#edit-user-series").slideDown()}function g(){e();function e(){var e,a="",i;for(i=0;i<da.length;i++){a+='<option value="'+da[i]+'">'+da[i]+"</option>"}var n='<div id="setsWizard" style="width:330px;">'+"<h4>Create a set of series that can be mapped:</h4>"+'<label><input name="setsWizardType" type="radio" value="M" checked /> as regions</label><br />'+'<label><input name="setsWizardType" type="radio" value="X" /> as points (requires latitudes and longitudes)</label><br /><br />'+'<select id="setsWizardMap" style="width: 300px;">'+'<option value="nomap" class="nomap">select map</option>'+a+"</select><br><br>"+'<button class="right" id="setsWizardCancel">cancel</button><button class="right" id="setsWizardOk">OK</button>'+"</div>";$.fancybox(n,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});$("#setsWizardMap").change(function(){if($(this).val()!="nomap"){$("#setsWizardOk").button("option","disabled",false);$(this).find("option[value='nomap']").remove()}});$("#setsWizardOk").button({icons:{secondary:"ui-icon-check"},disabled:true}).click(function(){t($("#setsWizardMap").val(),$("#setsWizardMap").text(),$("input:radio[name='setsWizardType']:checked").val());$.fancybox.close()});$("#setsWizardCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}function t(e,t,n){o=n;if(n=="M")bi({command:"GetMapGeographies",map:e},i);else{var r=[["point set"],["units"],["notes"],["geoid"],["handle"],["date"]];for(var l=0;l<jsoData.geographies.length;l++){r[d.M.geoid].push(jsoData.geographies[l].geoid);r[d.M.name].push(jsoData.geographies[l].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();s=jsoData.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:r,minCols:s})}}function i(e,t,i){var n=[["map set"],["units"],["notes"],["geoid"],["handle"],["date"]];for(var o=0;o<e.geographies.length;o++){n[d.M.geoid].push(e.geographies[o].geoid);n[d.M.header].push(e.geographies[o].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();s=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:n,minCols:s})}}function b(){var e=$("#data-editor");e.handsontable("destroyEditor",false);var t=e.data("handsontable").getData();var a=1,i=[];var n,s,r,l,c=d[o];var p,u,h,f,m,g;for(p=1;p<t[0].length;p++){g=false;for(u=d[o[0]].header+1;u<t.length;u++){if(t[u][p]!==null&&Gt.test(t[u][p])){if(o=="U"&&(!Gt.test(t[d.U.name][p])||t[d.U.name][p]===null||!Gt.test(t[d.U.units][p])||t[d.U.units][p]===null)){Ua("Invalid Series","Name and units are required fields.");return false}g=true;break}}var b;if(g){switch(o[0]){case"M":n={handle:t[d.M.handle][p],name:t[d.M.name][1]+" - "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.M.units][1],notes:t[d.M.geoid][p],geoid:t[d.M.geoid][p],save_dt:(new Date).getTime()};b=d.M.header;break;case"X":n={handle:t[d.X.handle][p],name:t[d.X.name][1]+" "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.X.units][1],notes:t[d.X.notes][1],geoid:t[d.X.geoid][p],lat:t[d.X.lon][p],lon:t[d.X.lat][p],save_dt:(new Date).getTime()};b=d.X.header;break;default:n={handle:t[d.U.handle][p],name:t[d.U.name][p],units:t[d.U.units][p],notes:t[d.U.notes][p],save_dt:(new Date).getTime()};b=d.U.header;break}if(!n.handle){n.handle="L"+a++}if(n.name.length==0||n.units.length==0){Ua("Invalid Series","Name and units are required fields.");return false}s=[];l="";for(u=b+1;u<t.length;u++){if(t[u][p]!==null&&t[u][p].length>0){if(isNaN(t[u][p])&&t[u][p].toLowerCase()!="null"){Ua("Unreadable Values","Value cells must be numbers, 'null', or blank.");return false}m=pt(t[u][0]);if(!m){Ua("Invalid Date Formats","Valid date formats are required in the left column for non-empty values.");return false}s.push({x:m.getTime(),y:parseFloat(t[u][p])})}}r=ri(s);s.sort(function(e,t){return e.x-t.x});for(var v in s){var y=new Date(s[v].x);switch(r.period){case"A":l+="||"+y.getUTCFullYear()+"|"+s[v].y;break;case"W":case"D":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+"|"+s[v].y;break;case"M":case"Q":case"SA":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+"|"+s[v].y;break;case"N":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+" "+y.getUTCHours()+":"+y.getUTCHours()+":"+y.getUTCMinutes()+"|"+s[v].y;break}}n.data=l.substr(2);n.period=r.period;if(n.data.trim().length>0){i.push(n);$.extend(n,r)}}}if(i.length==0){Ua("No data","No date-value pairs found.");return false}return i}function v(){var e,t=b();if(t){bi({command:"SaveUserSeries",series:t,set:o,setname:t[0].setname},function(a,i,n){for(e=0;e<t.length;e++){if(t[e].handle.substr(0,1)=="U"&&t[e].handle.substr(0,1)=="U"){Rt.find("span.handle:contains("+t[e].handle+")").each(function(){if($(this).html()==t[e].handle)Rt.fnDeleteRow($(this).closest("tr").get(0))
})}t[e].handle="U"+a.series[e].usid;t[e].usid=a.series[e].usid;t[e].mapsetid=a.series[e].mapsetid;t[e].pointsetid=a.series[e].pointsetid;t[e].graph="";t[e].url="";t[e].username=account.info.name||"user";t[e].userid=account.info.userId||null;Rt.fnAddData(t[e]);oMySeries[t[e].handle]=t[e]}});y()}vi()}function y(){var e=$("#data-editor");e.handsontable("destroy");e.attr("style","overflow:scroll;");$("div#edit-user-series").fadeOut()}}function Ya(e){bi({command:"GetCatChains",sid:e||0},function(t,a,i){var n=0,s,o=0;var r=$('<table id="cat-chains">');var l={},d,c,p;console.log(t.chains);for(var u in t.chains){d=l;p=null;if(t.chains[u].length>o)o=t.chains[u].length;for(s=t.chains[u].length-1;s>=0;s--){Ht[t.chains[u][s].catid]=t.chains[u][s];Ht[t.chains[u][s].catid].parentid=p;if(p!==null){if(d[t.chains[u][s].name]){d[t.chains[u][s].name].catProps.count++}else{d[t.chains[u][s].name]={catProps:t.chains[u][s]};if(t.chains[u].length-1!=s)d[t.chains[u][s].name].catProps.siblings=t.chains[u][s+1].children;d[t.chains[u][s].name].catProps.count=1;d[t.chains[u][s].name].catProps.parentid=p}d=d[t.chains[u][s].name]}p=t.chains[u][s].catid}r.append("<tr></tr>");n++}var h=false,f,m;var g=[],b,v;for(b in l){if(b!="catProps")g.push(l[b])}while(!h){h=true;c=[];for(s=0;s<g.length;s++){if(g[s]==null){c.push(null)}else{h=false;v=true;for(d in g[s]){if(d!="catProps"){c.push(g[s][d]);v=false}}if(v)c.push(null);m=g[s].catProps;f=$('<td class="cat-branch" rowspan="'+m.count+'">'+'<span class="chain" data="'+m.catid+'">'+(m.siblings>1&&e?'<span class="ui-icon browse-rolldown" onclick="showSiblingCats(this)" title="show sibling categories"></span>':"")+(parseInt(m.scount)>0?'<a title="Click to view the '+m.scount+' series in this category" onclick="publicCat('+m.catid+')">'+m.name+"("+m.scount+")</a>":m.name)+"</span>"+(m.children>0&&v?'<span class="ui-icon browse-right" data="'+m.catid+'" onclick="showChildCats(this,'+m.catid+')">show child categories</span>':"")+"</td>");r.find("tr:eq("+s+")").append(f)}}g=c}if($("#cloud-series:visible").length==1){$("div#browse-api").height($("#cloud-series").height()).width($("#cloud-series").width())}$("div#browse-api").html("").append(r).fadeIn();$("div#browse-api").prepend("Below are category heirarchy for the series selected. Note that a series can be in more than one category.<br><br>"+'<button id="browse-reset">reset</button> <button id="browse-close">close</button><br><br>');$("#browse-reset").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"},disabled:true}).click(function(){Ya(e)});$("#browse-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){Xa()})})}function Xa(){$("div#browse-api").fadeOut()}function Qa(e){var t,a,i;var n;var s=$(e);n=s.closest("td");i=$(e).hasClass("ui-icon-stop");var o;o=$("#cat-chains");o.find("span.sibling").closest("div").remove();o.find("td").children("br").remove();o.find(".ui-icon.ui-icon-stop").removeClass("ui-icon-stop").addClass("browse-rolldown");var r=o.find("td.expanded").removeClass("expanded").find("span.browse-right").remove().end();if(r.length==1&&r.html()=="")r.remove();if(i)return;t=n.addClass("expanded").find(".browse-rolldown").removeClass("browse-rolldown").addClass("ui-icon-stop").end().children("span").attr("data");var l=Ht[Ht[t].parentid];if(l.childrenCats){d(l.childrenCats)}else{bi({command:"GetCatSiblings",catid:t},function(e,t,i){l.childrenCats=[];for(var n=0;n<e.siblings.length;n++){a=e.siblings[n];l.childrenCats.push(a.catid);if(!Ht[a.catid]){a.parentid=l.catid;Ht[a.catid]=a}}d(l.childrenCats)})}function d(a){var i;$(e).removeClass("browse-rolldown").addClass("ui-icon-stop");for(var s=0;s<a.length;s++){i=Ht[a[s]];if(i.catid==t){if(i.children>0){n.find("span.chain").append('<span class="ui-icon browse-right" onclick="showChildCats(this, '+i.catid+')" title="show child categories"></span>')}}else{n.append("<div>"+(i.children>0?' <span class="ui-icon browse-right" onclick="showChildCats(this, '+i.catid+')" data="'+i.catid+'" title="show child categories">asdf</span>':"")+'<span class="ui-icon ui-icon-stop"></span><span class="sibling">'+(parseInt(i.scount)>0?'<a title="Click to view the '+i.scount+' series in this category" onclick="publicCat('+i.catid+')">'+i.name+" ("+i.scount+")</a>":i.name)+"</span>"+"</div>")}}}}function Za(e,t){var a,i;if(!t){t=$(e).attr("data")}if(Ht[t].childrenCats){n(Ht[t].childrenCats)}else{bi({command:"GetCatChildren",catid:t},function(e,i,s){Ht[t].childrenCats=[];for(var o=0;o<e.children.length;o++){a=e.children[o];if(!Ht[a.catid]){a.parentid=t;Ht[a.catid]=a}Ht[t].childrenCats.push(a.catid)}n(Ht[t].childrenCats)})}function n(e){var n="",s=t;while(Ht[s].parentid!==null){n='<td class="chain"><span class="chain" data="'+s+'">'+'<span class="ui-icon browse-rolldown" onclick="showSiblingCats(this)" title="show sibling categories"></span>'+Ht[s].name+"</span></td>"+n;s=Ht[s].parentid}var o=$("#cat-chains").html("<tr>"+n+"</tr>");i=$('<td class="chain expanded"></td>');for(var r=0;r<e.length;r++){a=Ht[e[r]];i.append("<div>"+(a.children>0?' <span class="ui-icon browse-right" onclick="showChildCats(this)" data="'+a.catid+'" title="show child categories"></span>':"")+'<span class="ui-icon ui-icon-stop"></span><span class="sibling">'+(parseInt(a.scount)>0?'<a title="Click to view the '+a.scount+' series in this category" onclick="publicCat('+a.catid+')">'+a.name+" ("+a.scount+")</a>":a.name)+"</span>"+"</div>")}o.find("tr").append(i);$("button.browse-reset").button("enable")}}function Ja(e,t){Bt=e;hasher.replaceHash(fi())}function Ka(){if(account.loggedIn())return account.info.userId;if(account.fb_user){var e={command:"GetUserId",authmode:"FB",username:account.fb_user.id,name:account.fb_user.name,email:account.fb_user.email,company:"",accesstoken:account.fb_user.accessToken};$.ajax({type:"POST",url:"api.php",data:e,dataType:"json",success:function(e,t,a){if(e.status=="ok"){console.info("GetUserId success");$.extend(account.info,account.fb_user,e);if(account.info.orgId&&account.info.orgName){$("#series_search_source").append('<option value="org">'+account.info.orgName+"</option>")}$("#menu-account").find(".ui-button-text").html(account.info.name);ei();if(account.subscribing)account.showSubscribe()}else{console.log(e);Ua("Login Status",e.status)}},error:function(e,t,a){console.log(e)}});return false}return null}function ei(){var e,t,a,i;var n=new Date;var s={command:"UploadMyMashableData",adddt:n.getTime(),series:[]};for(e in oMySeries){if(e[0]=="L"){s.series.push(oMySeries[e])}}if(s.series.length>0){bi(s,function(e,n,s){for(t in e.handles){a=e.handles[t];i=oMySeries[t];i.handle=a;i.sid=a.substr(1);delete oMySeries[t];oMySeries[a]=i;for(tab in Qt){o(Qt[tab],t,i)}for(var r in Xt){o(Xt[r],t,i)}}ai()})}else{ai()}function o(e,t,a){var i;if(e.assets){if(e.assets[t]){delete e.assets[t];e.assets[a.handle]=a}else{return}}yt(e,function(){if(this.handle==t)this.handle=a.handle})}console.info("syncMyAccount run");bi({command:"GetMyGraphs"},function(e,t,a){for(var i in e.graphs){Xt[i]=e.graphs[i];ti(Xt[i]);qt.fnAddData(Xt[i])}})}function ti(e){if(e.annotations){e.annotations=i(e.annotations,[])}else{e.annotations=[]}for(var t in e.plots){e.plots[t].options=i(e.plots[t].options,{});for(var a in e.plots[t].components){e.plots[t].components[a].options=i(e.plots[t].components[a].options,{})}}for(var t in e.pointsets){e.pointsets[t].options=i(e.pointsets[t].options,{});for(var a in e.pointsets[t].components){e.pointsets[t].components[a].options=i(e.pointsets[t].components[a].options,{})}}e.mapconfig=i(e.mapconfig,{});if(e.mapsets){e.mapsets.options=i(e.mapsets.options,{});for(var a in e.mapsets.components){e.mapsets.components[a].options=i(e.mapsets.components[a].options,{})}}function i(e,t){try{return JSON.parse(e)}catch(a){return t}}}function ai(){bi({command:"GetMySeries",modal:"persist"},function(e,t,a){var i=[];for(var n in e.series){e.series[n].save_dt=parseInt(e.series[n].save_dt);oMySeries[n]=e.series[n];i.push(e.series[n])}Rt.fnClearTable();Rt.fnAddData(i)})}function ii(e,t){if(e.gid){e.updatedt=(new Date).getTime()}else{e.createdt=(new Date).getTime()}e.serieslist=[];yt(e,function(){e.serieslist.push(e.assets[this.handle].name)});e.serieslist=e.serieslist.join("; ");var a=e.assets;var i=e.calculatedMapData;var n=e.controls;delete e.assets;delete e.calculatedMapData;delete e.controls;var s={command:"ManageMyGraphs"};var o={},r=["assts"];$.extend(true,s,e);s.annotations=ni(e);s.mapconfig=$.stringify(e.mapconfig);var l,d;kt(s,function(){this.options=$.stringify(this.options);$.each(this.components,function(){this.options=$.stringify(this.options)})});e.assets=a;e.calculatedMapData=i;e.controls=n;bi(s,function(s,o,r){e.gid=s.gid;e.ghash=s.ghash;e.isDirty=false;delete e.assets;delete e.calculatedMapData;delete e.controls;var l=$.extend(true,{from:"",to:""},e);e.assets=a;e.calculatedMapData=i;e.controls=n;l.updatedt=(new Date).getTime();if("G"+e.gid in Xt){var d;d=$(qt).find("span.handle[data=G"+e.gid+"]").closest("tr").get(0);qt.fnUpdate(l,d)}else{qt.fnAddData(l)}Xt["G"+e.gid]=l;Qt[ct()]=e;if(t)t()})}function ni(e){var t="[";for(var a=0;a<e.annotations.length;a++){t+='{"type":"'+e.annotations[a].type+'",';if(e.annotations[a].type=="point")t+='"series":"'+e.annotations[a].series+'",';if(e.annotations[a].type.substring(0,1)=="h")t+='"yAxis":"'+e.annotations[a].yAxis+'",';t+='"color":"'+e.annotations[a].color+'",';t+='"from":"'+e.annotations[a].from+'",';if(e.annotations[a].type.indexOf("band")>-1)t+='"to":"'+e.annotations[a].to+'",';t+='"text":"'+e.annotations[a].text+'"}';if(a<e.annotations.length-1)t+=","}return t+"]"}function si(e){if(gi())return false;bi({command:"ManageMySeries",modal:"none",jsts:e.save_dt,handle:e.handle,to:e.save},function(e,t,a){})}function oi(e){if(e.handle){if(e.save_dt)e.save_dt=parseInt(e.save_dt);if(oMySeries[e.handle]){var t=Rt.find("button[data='"+e.handle+"']").closest("tr");if(t.length==1){Rt.fnDeleteRow(t.get(0))}}Rt.fnAddData(e);oMySeries[e.handle]=e}else{console.log("Error loading series object: invalid series handle.")}return e.handle}function ri(e){var t={firstdt:null,lastdt:null,minValue:null,maxValue:null,period:"A",points:e.length};var a=null;var i=null;var n=null;var s=null;var o;if(t.points==1){o=new Date(e[0].x);if(o.getUTCMonth()!=0)t.period="M";if(o.getUTCDate()!=1)t.period="D";if(o.getUTCHours()+o.getUTCMinutes()+o.getUTCSeconds()!=0)t.period="T"}else{for(var r=0;r<t.points;r++){var l=e[r];if(t.firstdt==null||t.firstdt>l.x)t.firstdt=l.x;if(t.lastdt==null||t.lastdt<l.x)t.lastdt=l.x;if(t.minValue==null||t.minValue>l.y)t.minValue=l.y;if(t.maxValue==null||t.maxValue<l.x)t.maxValue=l.y;o=new Date(l.x);if(s==null){s=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()}else if(s!==true&&s!=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()){s=true}if(a==null){a=o.getUTCDate()}else if(a!==true&&a!=o.getUTCDate()){a=true}if(i==null){i=o.getUTCDay()}else if(i!==true&&i!=o.getUTCDay()){i=true}if(n==null){n=o.getUTCMonth()}else if(n!==true&&n!=o.getUTCMonth()){n=true}}if(s===true){t.period="T"}else if(i!==true){t.period="W"}else if(a===true){t.period="D"}else if(n===true){t.period="M"}else{t.period="A"}}return t}function li(){var e;Ua("confirm deletion",Ft.deleteMySeries,[{text:"delete",id:"btn-delete",click:function(){for(var t=0;t<Zt.length;t++){e=Rt.fnGetData(Zt.get(t));if(account.loggedIn()){e.save=null;si(e)}delete oMySeries[e.handle];Rt.fnDeleteRow(Zt.get(t))}$(this).dialog("close");Ba()}},{text:"cancel",id:"btn-cancel",click:function(){$(this).dialog("close")}}])}function di(e){var t=e.length==0?"Graph "+aa:e;var a=ta.tabs("add","#graphTab"+aa,t);$("#graphTab"+aa).addClass("graph-panel");$("#canvas").tabs().find(".ui-tabs-nav").sortable({axis:"x",distance:10});ta.tabs("select",ta.tabs("length")-1);$(".ui-tabs-selected a").each(function(){$(this).attr("title",$(this).html())});aa++;fa();$("#btnEditGraphTop").removeAttr("disabled");if($("#delete-my-series").attr("disabled")!="disabled"){$("button.add-to-graph").removeAttr("disabled")}$("#graph-tabs a:last").click(function(){Na()});return $("#canvas .graph-panel:last").attr("id")}function ci(e){var t=$(e).parent().children("a").attr("href");var a=t.substr(1);$(t).remove();$(e).parent().remove();pi(a);delete Qt[a];ta.tabs("refresh");if(ta.find("li").length==0){Jt=null;$("#btnEditGraphTop").attr("disabled","disabled");$("button.add-to-graph").attr("disabled","disabled");la.click()}else{$("#graph-tabs a:last").click()}$("#graph_title").attr("value","")}function pi(e){if(Qt[e]&&Qt[e].controls){var t=Qt[e].controls;if(t.chart){t.chart.destroy();delete t.chart;$.contextMenu("destroy","#"+e+" div.chart")}if(t.map){t.map.remove();delete t.map}if(t.vizChart){t.vizChart.destroy();delete t.vizChart}}}function ui(e){var t=[];if(e.length==1){return e[0]}if(e.length==0){return""}firstTitleWords=e[0].split(" ");for(var a=0;a<firstTitleWords.length;a++){var i=true;for(var n=1;n<e.length;n++){var s=" "+e[n]+" ";if(s.indexOf(" "+firstTitleWords[a]+" ")==-1){i=false;break}}if(i){t.push(firstTitleWords[a])}}return t.join(" ")}function hi(e){la=e;var t=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");var a=$(e).attr("data");$(e).parent().addClass("ui-tabs-selected ui-state-active");$(t).hide();$(a).show().find(".dataTables_filter input,#series_search_text,#graphs_search_text").get(0).focus();mi();return false}function fi(){var e,t=$("#series-tabs li.ui-tabs-selected a").attr("data"),a="grey-italics";switch(t){case"#local-series":e=$("#series-table_filter input");return encodeURI("t=ms"+(e.hasClass(a)?"":"&s="+e.val()));case"#cloud-series":if(Bt!=0){return encodeURI("t=cs&cat="+Bt)}else{e=$("#series_search_text");return encodeURI("t=cs"+(e.hasClass(a)?"":"&s="+e.val()+"&f="+$("#series_search_periodicity").val())+"&api="+$("#series_search_source").val()+"&sets="+$("#public-mapset-radio").find("input:checked").val())}case"#myGraphs":e=$("#my_graphs_table_filter input");return encodeURI("t=mg"+(e.hasClass(a)?"":"&s="+e.val()));case"#publicGraphs":e=$("#public_graphs_search input");return encodeURI("t=cg"+(e.hasClass(a)?"":"&s="+e.val()));default:var i=ct();if(i&&Qt[i]){return encodeURI("t=g"+i.substr(8)+(Qt[i].ghash?"&graphcode="+Qt[i].ghash:""))}}}function mi(e,t){if(e){a="t=g"+t.replace("graphTab","")+"&graphcode="+e}else{var a=fi()}if(a&&hasher.getHash()!=a){if(hasher.getHash().search("t=g&graphcode=")==-1){ha(a)}else{hasher.replaceHash(a)}}}function gi(){if(!account.loggedIn()){$("#dialog").html("<span><p>You must be signed in to use this function.  You can sign into MashableData.com with your Facebook account.  (Google+ account federation coming soon!)</p>"+"<p>Logging in does <em>not</em> grant MashableData automatic access to your email or to post to your account.</p>"+"</span><br>");Aa=$("#dialog").dialog({modal:true,title:"Sign in required",width:500,buttons:[{text:"Close",id:"btn-dia-close",click:function(){$(this).dialog("close")}}],open:function(){$("#btn-dia-close").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}return!account.loggedIn()}function bi(e,t){if(e.modal!="none")yi();$.ajax({type:"POST",url:"api.php",encoding:"UTF-8",data:$.extend({uid:Ka(),version:workbenchVersion,accessToken:account.info.accessToken},e),dataType:"json",success:function(a,i,n){if(a.status=="ok"){Et+=parseFloat(a.exec_time);console.info(e.command+": "+a.exec_time+" (total server time: "+Et+"ms)");t(a,i,n);if(e.modal!="persist")vi();if(a.msg)Ua("",a.msg)}else{vi();Ua("Connected to server, but the command failed.",a.status+'<br><br>If this is a system error and continues to occur, please email <a href="mailto:support@mashabledata.com">support@mashabledata.com</a>.')}},error:function(e,t,a){vi();Ua(t,"A system error occurred while trying to connect to the server.  Check your internet connectivity and try again later.");console.log(t);console.log(e)}})}function vi(){$("#wrapper").unmask()}function yi(e){$("#wrapper").mask(e||"Loading...")}