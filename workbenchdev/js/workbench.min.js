var e={globals:{isEmbedded:window.location.hostname.indexOf("www.mashabledata.com")===-1||window.location.pathname.indexOf("workbench")===-1,BAND_TRANSPARENCY:.5,colorsPlotBands:["aaaaaa","ffaaaa","aaffaa","aaaaff"],standardAnnotations:[],iconsHMTL:{mapset:'<span class="ui-icon ui-icon-mapset" title="series is part of a map set"></span>',pointset:'<span class="ui-icon ui-icon-pointset" title="series is part of a set of markers (defined longitude and latitude)"></span>',hasCubeViz:'<span class="ui-icon ui-icon-cube" title="map has supplemental visualizations"></span>',hasHeatMap:'<span class="ui-icon ui-icon-mapset" title="contains a heat-map"></span>',hasMarkerMap:'<span class="ui-icon ui-icon-pointset" title="contains sets of mapped markers (defined longitude and latitude)."></span>',hasBubbleMap:'<span class="ui-icon ui-icon-bubble" title="bubble map of data aggregated into user-defined regions"></span>'},themeCubes:{},panelGraphs:{},MySeries:{},MyGraphs:{},MAP_COLORS:{POS:"#0071A4",NEG:"#FF0000",MID:"#E5E5E5"},DEFAULT_RADIUS_SCALE:30,DEFAULT_RADIUS_FIXED:10,hcColors:["#2f7ed8","#8bbc21","#910000","#1aadce","#492970","#f28f43","#77a1e5","#c42525","#a6c96a","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92","#0d233a"],primeColors:["#008000","#FF0000","#0000FF","#FFFF00","#FF9900","#00FFFF","#FF0000"],dashStyles:["Solid","Short Dash","Short Dot","Short Dash Dot","Short Dash Dot Dot","Dot","Dash","Long Dash","Dash Dot","Long Dash Dot","Long Dash Dot Dot"],period:{value:{N:1e3,D:24*3600*1e3,W:7*24*3600*1e3,M:30*24*3600*1e3,Q:365/4*24*3600*1e3,SA:365/2*24*3600*1e3,A:365*24*3600*1e3},order:["N","D","W","M","Q","SA","A"],name:{N:"non period data",D:"daily",W:"weekly",M:"monthly",Q:"quarterly",SA:"semiannual",A:"annual"},units:{N:"non-periodic data",D:"day",W:"week",M:"month",Q:"quarter",SA:"half-year",A:"year"}},op:{value:{"+":1,"-":2,"*":3,"/":4},cssClass:{"+":"op-addition","-":"op-subtraction","*":"op-multiply","/":"op-divide"}},mapBackground:"#AAAAAA",graphScriptFiles:["/global/js/highcharts/js/modules/exporting.src.js","/global/js/colorpicker/jquery.colorPicker.min.js","/global/js/colour/Colour.js","/global/js/jvectormap/jquery-jvectormap-1.2.2.min.js"],rowPosition:{name:0,units:1,source:2,notes:3,region:4,lat_lon:5,date:6,dataStart:7},vectorPattern:/[SUL]/,handlePattern:/[MXSU]\d+/g,patVariable:/(\b[A-Z]{1,2}\b)/g,isIE:/msie/i.test(navigator.userAgent)&&!window.opera,months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}};if(typeof console=="undefined")console={info:function(e){},log:function(e){}};e.common={octet:function fa(e){e=e.toString(16);return(e.length==1?0:"")+e},mashableDataString:function ma(e){var t,a=[];if(typeof e.data=="string"){return e.data}else{for(t=0;t<e.data.length;t++){a.push(mashableDate(e.data[t][0],e.period)+"|"+(isNaN(e.data[t][1])||e.data[t][1]===null?"null":e.data[t][1]))}return a.join("||")}},mashableDate:function ga(e,t){var a=new Date(parseInt(e));var i=a.getUTCFullYear();switch(t){case"M":i+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();break;case"Q":i+="Q"+parseInt((a.getUTCMonth()+3)/3);break;case"SA":i+="H"+parseInt((a.getUTCMonth()+6)/6);break;case"W":case"D":i+=(a.getUTCMonth().toString().length==1?"0":"")+a.getUTCMonth();i+=(a.getUTCDate().toString().length==1?"0":"")+a.getUTCDate();break}return i},dateFromMdDate:function ba(e){var t;t=new Date("1/1/"+e.substr(0,4)+" UTC");if(e.length>4){switch(e.substr(4,1)){case"Q":t.period="Q";t.setUTCMonth((e.substr(5,1)-1)*3);break;case"H":t.period="H";t.setUTCMonth((e.substr(5,1)-1)*6);break;default:t.period="M";t.setUTCMonth(e.substr(4,2))}if(e.length>6){t.period="D";t.setUTCDate(e.substr(6,2));if(e.length>8){t.setUTCHours(e.substr(9,2));t.setUTCMinutes(e.substr(12,2));t.setUTCSeconds(e.substr(15,2))}}}else{t.period="A"}t.s=e;return t},dateConversionData:function va(e,t,a){if(t&&typeof t!="object")t=new Date(parseInt(t));if(a&&typeof a!="object")a=new Date(parseInt(a));var i="",s;var n=24*60*60*1e3;var o=new Date;var r=this.mashableDate;switch(e.toUpperCase()){case"DAYSPERMONTH":if(a){a=new Date(a.getUTCFullYear()+"-"+(a.getUTCMonth()+1)+"-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-12-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-01 UTC")}else{t=new Date(a.getTime());t.setUTCMonth(t.getUTCMonth()-119)}while(t<=a){i+=(i?"||":"")+r(t.getTime(),"M")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCMonth(t.getUTCMonth()+1))/n)}break;case"DAYSPERQUARTER":if(a){a=new Date(a.getUTCFullYear()+"-"+(a.getUTCMonth()+3)+"-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-12-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-"+(t.getUTCMonth()+3)+"-01 UTC")}else{t=new Date(a.getTime());t.setUTCMonth(t.getUTCMonth()-119)}while(t<=a){i+=(i?"||":"")+r(t.getTime(),"Q")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCMonth(t.getUTCMonth()+3))/n)}break;case"DAYSPERYEAR":a=a||new Date(o.getUTCFullYear()+"-01-01 UTC");if(a){a=new Date(a.getUTCFullYear()+"-01-01 UTC")}else{a=new Date(o.getUTCFullYear()+"-01-01 UTC")}if(t&&t<a){t=new Date(t.getUTCFullYear()+"-01-01 UTC")}else{t=new Date(a.getUTCFullYear()-20+"-01-01 UTC")}while(t<=a){i+=(i?"||":"")+r(t.getTime(),"A")+"|"+Math.round(Math.abs(t.getTime()-t.setUTCFullYear(t.getUTCFullYear()+1))/period.value.D)}break}return i},selectDownshift:function ya(e,t,a,i){var s,n;var o='<div id="downshiftWizard" style="width:600px;">'+"<h4>Frequency Shifting:</h4>";if(t)o+="You have selected to have the plot recalculated as <b></b>"+period.name[t]+"</b>.  Please select the method and treatment of missing and null values.<br>";else o+="You have requested to mash series with different frequencies.  This will require first recalculating the series data having a shorter reporting period to a common longer period.  Please confirm by selecting the algorithm and the treatment of missing and null values.<br>";o+="<br>Component series that must be recalculated:"+"<ol>";for(s=0;s<a.components.length;s++){n=e.assets[a.components[s].handle];o+="<li><b>"+n.name+"</b> ("+n.units+") "+period.name[t=="A"&&n.freqset.Q?"Q":"M"]+"</li>"}o+="</ol>"+"<br>Each component series will be individual recalculated as needed to the new frequency by:<br>"+'<label><input type="radio" name="dsw_algor" value="sum"> simple summation</label><br>'+'<label><input type="radio" name="dsw_algor" value="wavg"> day-weighted average</label><br>'+"<br>If some of the values used to calculate a new datum point are are null or missing (e.g. a month is missing when calulating an annual value):<br>"+'<label><input type="radio" name="dsw_missing" value="null"> the computed value for the datum will be null (i.e. all sub-values are required)</label><br>'+'<label><input type="radio" name="dsw_missing" value="zero"> treat as if the value were zero</label><br>'+'<label><input type="radio" name="dsw_missing" value="impute"> estimate value to be the day-weighted average of new period\'s existing component values if at least three-quarters of the component values exist</label><br>'+'<span class="ui-state-error warning-box"><span class="ui-icon ui-icon-alert" style="display:inline-block;"></span>WARNING: Change frequencies and use estimates with care.  Summations produce valid results for monthly production quantities, whereas day-weighted averages are statistically correct for rates where the implied denominator is constant.<br><br>For more information, see <a href="/workbench-help/changing-frequency/" traget="_blank" class="link">changing frequencies help</a>.</span>'+'<button id="dsw_ok" class="right">OK</button> <button id="dsw_cancel" class="right">cancel</button>'+"</div>";$.fancybox(o,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var r=$("#downshiftWizard");$("#dsw_ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e={algorithm:r.find("input:radio[name='dsw_algor']:checked").val(),missing:r.find("input:radio[name='dsw_missing']:checked").val()};if(e.algorithm&&e.missing){i(e);$.fancybox.close()}else{vt("error","All form selections are required.")}});$("#dsw_cancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close();i(false)})},downShiftData:function ka(t,a,i,s){var n=e.globals.period;if(n.value[a]==n.value[t.period])return t.data;if(n.value[a]<n.value[t.period]||a!="A"&&a!="Q"||n.value[t.period]<n.value["M"])throw"unable to change data frequency from "+n.name[t.period]+" to "+n.name[a];var o=t.data.split("||"),r=[],l=[],d=a=="Q"?3:12,c=t.period=="M"?1:3,p=false,u,h,f;for(var m=0;m<o.length;m++){h=o[m].split("|");f=this.dateFromMdDate(h[0]);if(p===false||f.getUTCMonth()-p.getUTCMonth()>d-1||f.getUTCFullYear()!=p.getUTCFullYear()){if(l.length!=0){r.push(g());l=[]}p=new Date(f.getUTCFullYear()+"-"+(Math.floor(f.getUTCMonth()/d)*d+1)+"-1 UTC")}l[f.getUTCMonth()]=h[1]}if(l.length!=0)r.push(g());return r;function g(){var t,o=0,r=0,h=0,f=0;u=e.common.mashableDate(p.getTime(),a);var m=p.getUTCMonth();for(var g=m;g<m+d;g=g+c){t=-Math.round(p.getTime()-p.setUTCMonth(p.getUTCMonth()+c)/n.value.D);if(typeof l[g]=="undefined"||l[g]===null){if(s=="null"){return u+"|null"}l[g]=0;if(s=="impute"){h++;r+=t;o-=t}}switch(i){case"wavg":f+=parseFloat(l[g])*t;o+=t;break;case"sum":f+=parseFloat(l[g]);break;default:throw"unrecognized down frequency conversion algorithm"}}if(r!=0&&f!="null")f=f*(o+r)/o;return u+"|"+(i=="wavg"?f/o:f)}},rationalize:function wa(e){if(Math.log(Math.abs(e))>-13)return Math.round(e*Math.pow(10,10))/Math.pow(10,10);else return e},equivalentRGBA:function xa(e,t){var a,i,s;if(e.substr(0,1)=="#")e=e.substr(1);a=n(parseInt(e.substr(0,2),16),t);i=n(parseInt(e.substr(2,2),16),t);s=n(parseInt(e.substr(4,2),16),t);if(a>0&&i>0&&s>0){return"rgba("+a+","+i+","+s+","+t+")"}else{return"rgb("+parseInt(e.substr(0,2),16)+","+parseInt(e.substr(2,2),16)+","+parseInt(e.substr(4,2),16)+")"}function n(e,t){return parseInt(e/t-(1-t)*255/t)}},addBreaks:function Ca(e,t){var a=e.slice(0);a.sort(function(e,t){return e[0]-t[0]});var i=[];if(a.length>0)i.push([a[0][0],a[0][1]]);var s;switch(t){case"T":case"N":case"D":case"W":maxInterval=Date.UTC(2e3,0,9)-Date.UTC(2e3,0,1);break;case"M":maxInterval=Date.UTC(2e3,1,2)-Date.UTC(2e3,0,1);break;case"SA":maxInterval=Date.UTC(2e3,7,2)-Date.UTC(2e3,0,1);break;default:maxInterval=Date.UTC(2001,2)-Date.UTC(2e3,1)}for(var n=1;n<a.length;n++){if(a[n-1][1]!=null&&a[n][1]!=null&&a[n][0]-a[n-1][0]>maxInterval){var o=new Date(a[n][0]);switch(t){case"d":case"w":o.setDate(o.getDate()+7);break;case"4":o.setDate(o.getDate()+28);break;case"m":o.setMonth(o.getMonth()+1);break;default:o.setMonth(o.getMonth()+12)}a.splice(n,0,[parseInt(o),null]);n++}}return a},callApi:function Ma(t,a){var i,s=e.globals.isEmbedded;if(s){i=$.extend({uid:false,host:window.location.host},t)}else{i=$.extend({uid:qt(),version:workbenchVersion,accessToken:account.info.accessToken},t)}if(!s&&t.modal!="none")na();$.ajax({type:"POST",url:s?"http://remote.mashabledata.com/"+(e.globals.embed||""):"api.php",encoding:"UTF-8",data:i,dataType:"json",success:function(e,i,n){console.info(e);if(e.status=="ok"){if(!s){D+=parseFloat(e.exec_time);if(e.msg)vt("",e.msg);console.info(t.command+": "+e.exec_time+" (total server time: "+D+"ms)")}a(e,i,n);if(t.modal!="persist"&&!s)sa()}else{if(s){return e.status}else{sa();vt("Connected to server, but the command failed.",e.status+'<br><br>If this is a system error and continues to occur, please email <a href="mailto:support@mashabledata.com">support@mashabledata.com</a>.')}}},error:function(e,t,a){console.log(t);console.log(e);if(s){return"A system error occurred while trying to connect to the MashableData servers.  Please try again later"}else{sa();vt(t,"A system error occurred while trying to connect to the server.  Check your internet connectivity and try again later.")}}})}};e.Annotator=function $a(t,i){var s=e,n=s.globals,o=s.common,l=s.grapher;var d=n.BAND_TRANSPARENCY;var c=n.panelGraphs;var p=o.equivalentRGBA;var u=n.period;var h={panelId:t,bandNo:0,lineNo:0,banding:false,bandStartPoint:void 0,makeDirty:i,callApi:s.common.callApi,addStandard:function m(e){var a=this;a.callApi({command:"GetAnnotation",annoid:e},function(e){standardAnno=jQuery.parseJSON(e.annotation);for(var i=0;i<standardAnno.length;i++){c[t].annotations.push(standardAnno[i])}a.build("new")})},fetchStandards:function(){if(n.standardAnnotations.length==0){var e=this;this.callApi({command:"GetAnnotations"},function(e){for(var t=0;t<e.annotations.length;t++)n.standardAnnotations.push(e.annotations[t])})}},sync:function v(){var e=c[this.panelId].controls.chart;var t=e.options.xAxis,a=t.plotLines=[],i=t.plotBands=[];var s;for(var n=0;n<e.xAxis[0].plotLinesAndBands.length;n++){s=e.xAxis[0].plotLinesAndBands[n];if(s.id.substr(0,1)=="xb"){i.push(s.options)}else{a.push(s.options)}}},addPoint:function k(e){var a=c[t];if(typeof e!="undefined"){var i;for(var s=0;s<a.annotations.length;s++){if(a.annotations[s].type=="point"){i=a.controls.chart.get(a.annotations[s].id);if(i){i.update([i.x,i.y],false)}delete a.annotations[s].id}}a.annotations.push({type:"point",text:"",id:null,series:e.series.options.id,color:"#000000",from:y(e.x,e.series.options.period)});this.build("point")}},addXLine:function w(e){var a=c[t];a.controls.chart.xAxis[0].addPlotLine({value:e.x,color:"#"+f[0],id:"xl"+this.lineNo,width:2,label:{text:" ",y:0,zIndex:3}});a.annotations.push({type:"line",text:"",id:"xl"+this.lineNo,color:f[0],from:y(e.x,e.series.options.period)});this.lineNo++;this.build("table-only")},startXBand:function x(e){var a=c[t];this.bandStartPoint=e;this.bandColor=p(f[0],d);a.controls.chart.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.bandStartPoint.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});this.banding="x-Time";e.select(true)},build:function C(e){var a,i,s=this,o=c[t],r=o.controls.$thisPanel,l=r.find("div.annotations").show().find("table");if(l&&l.length!=0){r.find(".graph-save").button("enable");o.isDirty=true}if(!e)e="all";var u="";var h="A";var f,m,g,b,v,y,k;var w={};for(f=0;f<o.controls.chart.yAxis.length;f++){w["labelsY-"+f]=[]}o.annotations.sort(function(e,t){if(e.type.charAt(0)=="h"&&e.type.charAt(0)=="h")return t.from-e.from;if(e.type.charAt(0)=="h")return-1;if(t.type.charAt(0)=="h")return 1;return s.parseDate(e.from)-s.parseDate(t.from)});for(f=0;f<o.annotations.length;f++){console.time("annotation loop");m=o.annotations[f];switch(m.type){case"point":if(e=="point"||e=="all"){b=o.controls.chart.get(m.series);if(b==null){o.annotations.splice(f,1);f--;break}v=o.controls.chart.get("labelsY-"+b.options.yAxis);for(var x=0;x<b.data.length;x++){if(b.data[x]){if(b.data[x].x==this.parseDate(m.from)){g=b.data[x];w["labelsY-"+b.options.yAxis].push({x:g.x,y:g.y,id:h,marker:{fillColor:m.color,lineColor:m.color,radius:8,symbol:"circle",enabled:true,states:{hover:{enabled:true,marker:{enabled:true,fillColor:m.color,lineColor:m.color,radius:8}}}}})}}}m.id=h}u+='<tr data="'+h+'"><td align="center"><b>'+h+"</b></td><td>"+m.from+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';h=String.fromCharCode(h.charCodeAt(0)+1);break;case"line":y=this.parseDate(m.from);if(y>=parseInt(o.start||o.firstdt)&&y<=parseInt(o.end||o.lastdt)){if(e=="line"||e=="all"||e=="new"&&!m.id){m.id="xl"+this.lineNo;this.lineNo++;i=this.labelOffset(o.controls.chart,m);o.controls.chart.xAxis[0].addPlotLine({color:m.color,value:this.parseDate(m.from),id:m.id,width:2,label:{text:m.text,y:i,zIndex:3}})}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hline":if(e=="hline"||e=="all"||e=="new"&&!m.id){m.id="hl"+this.lineNo;this.lineNo++;for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text==m.yAxis){o.controls.chart.yAxis[a].addPlotLine({color:m.color,value:m.from,id:m.id,width:2,label:{text:m.text,zIndex:3}})}}}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+" "+m.yAxis+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break;case"band":y=this.parseDate(m.from);k=this.parseDate(m.to);if(y>=parseInt(o.start||o.firstdt)&&y<=parseInt(o.end||o.lastdt)||k>=parseInt(o.start||o.firstdt)&&k<=parseInt(o.to||o.lastdt)){if(e=="band"||e=="all"||e=="new"&&!m.id){m.id="xb"+this.bandNo++;i=this.labelOffset(o.controls.chart,m);o.controls.chart.xAxis[0].addPlotBand({color:p(m.color,d),from:y,to:k,id:m.id,label:{text:m.text,y:i,zIndex:3}})}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+"-"+m.to+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>'}break;case"hband":if(e=="hband"||e=="all"||e=="new"&&!m.id){m.id="hb"+this.bandNo++;for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text==m.yAxis){o.controls.chart.yAxis[a].addPlotBand({color:p(m.color,d),from:m.from,to:m.to,id:m.id,label:{text:m.text,zIndex:3}})}}}u+='<tr data="'+m.id+'"><td><input class="annotation-color-picker" type="text" value="'+m.color+'" /></td><td>'+m.from+"-"+m.to+" "+m.yAxis+'</td><td><input class="anno-text" type="text" value="'+m.text+'"></td><td><a class="ui-icon ui-icon-trash">delete</a></td></tr>';break}console.timeEnd("annotation loop")}console.time("annotation redraw");if(e=="point"||e=="all"){for(var C in w){o.controls.chart.get(C).setData(w[C],false)}console.info("annotations fired chart redraw");o.controls.chart.redraw()}console.timeEnd("annotation redraw");if(!n.isEmbedded){console.time("annotation rest");if(o.annotations.length==0)u+='<tr><td colspan="3" class="grey-italics">right-click on the chart to annotate a point, band, or event, or to perform a linear regression or average</td></tr>';l.html(u).find("input, select").change(function(){s.change(this)});l.find(".annotation-color-picker").colorPicker();l.find(".ui-icon-trash").click(function(){s["delete"](this)});console.timeEnd("annotation rest")}},change:function M(e){var a,i,s,n=$(e).closest("tr").attr("data");c[t].controls.$thisPanel.find(".graph-save").button("enable");var o=c[t];var r;for(a=0;a<o.annotations.length;a++){if(n==o.annotations[a].id){r=o.annotations[a];break}}r.text=$(e).closest("tr").find("input.anno-text").val();r.color=$(e).closest("tr").find(".annotation-color-picker").val();switch(n.substr(0,2)){case"xb":i=this.labelOffset(o.controls.chart,r);o.controls.chart.xAxis[0].removePlotBand(n);o.controls.chart.xAxis[0].addPlotBand({color:p(r.color,d),from:this.parseDate(r.from),to:this.parseDate(r.to),id:r.id,label:{text:r.text,y:i,zIndex:3}});break;case"hb":for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text=r.yAxis){o.controls.chart.yAxis[a].removePlotBand(n);o.controls.chart.yAxis[a].addPlotBand({color:p(r.color,d),from:parseFloat(r.from),to:parseFloat(r.to),id:r.id,label:{text:r.text,zIndex:3}})}}break;case"hl":for(a=0;a<o.controls.chart.yAxis.length;a++){if(o.controls.chart.yAxis[a].userOptions.title.text=r.yAxis){o.controls.chart.yAxis[a].removePlotLine(n);o.controls.chart.yAxis[a].addPlotLine({color:r.color,value:parseFloat(r.from),id:r.id,width:2,label:{text:r.text,zIndex:3}})}}break;case"xl":i=this.labelOffset(o.controls.chart,r);o.controls.chart.xAxis[0].removePlotLine(n);o.controls.chart.xAxis[0].addPlotLine({color:r.color,value:this.parseDate(r.from),id:r.id,width:2,label:{text:r.text,y:i,zIndex:3}})}},"delete":function S(e){var i=$(e).closest("tr").attr("data");var s=c[t];for(var n=0;n<s.annotations.length;n++){if(i==s.annotations[n].id){s.annotations.splice(n,1);break}}if(i[1]=="b"||i[1]=="l"){for(a=0;a<s.controls.chart.axes.length;a++){s.controls.chart.axes[a].removePlotLine(i);s.controls.chart.axes[a].removePlotBand(i)}this.build("none")}else{this.build("point")}},startAnalysisBanding:function(e,a){var i=e.series.color;var s=c[t].controls.chart;r=parseInt(i.substr(1,2),16);g=parseInt(i.substr(3,2),16);b=parseInt(i.substr(5,2),16);this.bandColor="rgba("+r+","+g+","+b+",0.5)";this.banding=a+"-"+e.series.index;this.bandStartPoint=e;s.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:e.x,color:this.bandColor,id:a+this.bandNo++,label:{text:" ",y:0,zIndex:3}})},deleteAnalysis:function(e){var a,i,s,n,o=e.series.options.calculatedFrom;var r=e.series.options.id.substr(0,2);if(o){a=e.series.data[0][0];i=e.series.data[e.series.data.length-1][0];e.series.remove();switch(r){case"LR":n=c[t].plots[parseInt(o.substr(1))].options.linRegressions;break;case"AV":n=c[t].plots[parseInt(o.substr(1))].options.averages;break}this.makeDirty();for(s=0;s<n.length;s++){if(n[s][0]==i&&n[s][1]==a){n.splice(s,1);return true}}return false}},parseDate:function D(e){if(e.length==4){e="1 Jan "+e+" UTC"}else if(e.length==8){e="1 "+e+" UTC"}else{e+=" UTC"}return Date.parse(e)},labelOffset:function T(e,t){var a=10;var i=20;var s=.2;if(t.text==" "||t.text==" ")return 0;var n=e.xAxis[0].plotLinesAndBands;var o=e.xAxis[0].getExtremes();var r=(o.max-o.min)*s;var l;var d=[];if(t.to){l=(this.parseDate(t.from)+this.parseDate(t.to))/2}else{l=this.parseDate(t.from)}var c=0,p;for(var u=0;u<n.length;u++){if(n[u].id!="timeLine"){if(n[u].options.to){p=(n[u].options.from+n[u].options.to)/2}else{p=n[u].options.from}if(n[u].options.label.text.length>0&&Math.abs(p-l)<r){c++;d.push(n[u])}}}var h=a;for(var f=0;f<d.length;f++){if(d[f].options.label.y==h){h+=i;f=-1}}return h},mouseOverHCPoint:function A(e,a){var i=c[t].controls.chart;if(!this.banding)return;if(this.banding=="x-Time"){try{i.xAxis[0].removePlotBand("xb"+this.bandNo)}catch(s){}i.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:a.x,color:this.bandColor,id:"xb"+this.bandNo,label:{text:" ",y:0,zIndex:3}});return}if(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-"){var n=this.banding.substr(0,2);try{i.xAxis[0].removePlotBand(n+this.bandNo)}catch(s){}this.endingX=closestDate(a.x,this.bandStartPoint.series.data);i.xAxis[0].addPlotBand({from:this.bandStartPoint.x,to:this.endingX,color:this.bandColor,id:n+this.bandNo,label:{text:" ",y:0,zIndex:3}})}},endBanding:function I(e){var a,i,s;var n=this.mouseoverPoint;var o=typeof this.mouseoverPoint!="undefined";var r=c[t];var l=this;if(this.banding=="x-Time"){if(o){var u,h;u=y(this.bandStartPoint.x,this.bandStartPoint.series.options.period);h=y(n.x,n.series.options.period);this.banding=false;r.annotations.push({type:"band",text:"",id:"xb"+this.bandNo,color:"#"+f[0],from:u<h?u:h,to:u<h?h:u});this.build("table-only");return false}else{return{items:{info:{name:"Mouse-over a series before right-clicking to terminate a vertical band.",callback:function(e,t){}}}}}}if(this.banding&&(this.banding.substr(0,3)=="LR-"||this.banding.substr(0,3)=="AV-")){var m=this.banding.substr(0,2);r.controls.chart.xAxis[0].removePlotBand(m+this.bandNo);var g=Math.min(this.bandStartPoint.x,this.endingX);var b=Math.max(this.bandStartPoint.x,this.endingX);if(g<b){switch(m){case"LR":this.plotLinearRegression(this.bandStartPoint.series,g,b,true);var v=r.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!v.linRegressions)v.linRegressions=[];v.linRegressions.push([g,b]);break;case"AV":this.plotAverage(this.bandStartPoint.series,g,b,true);var v=r.plots[parseInt(this.bandStartPoint.series.options.id.substr(1))].options;if(!v.averages)v.averages=[];v.averages.push([g,b]);break}l.makeDirty()}else{vt("Error","The starting point and ending points must be different.")}this.banding=false;return}else{var k,w,x,C,M,S=r.controls.chart;for(M=0;M<S.yAxis.length;M++){a=S.yAxis[M].userOptions.title.text;if(this.banding=="y-"+a){k=$(S.container).offset().top;w=$(S.container).offset().left;x=(isIE?e.originalEvent.x:e.clientX-w)-S.plotLeft;C=(isIE?e.originalEvent.y:e.pageY-k)-S.plotTop;if(C>=0&&C<=S.plotSizeY){i=parseFloat(parseFloat(S.yAxis[M].translate(S.plotHeight-C,true).toPrecision(2)));return{items:{axis:{name:"<b>"+a+":</b>",type:"text",value:i},ok:{name:"<button>ok</button>",callback:function(e,t){s=$.contextMenu.getInputValues(t)["axis"];for(var i=0;i<S.yAxis.length;i++){if(S.yAxis[i].userOptions.title.text=l.banding.substr(2)){S.yAxis[i].removePlotBand("hb"+l.bandNo);var n,o;n=parseFloat(l.bandStartPoint);o=parseFloat(s);S.yAxis[i].removePlotBand("hb"+l.bandNo);S.yAxis[i].addPlotBand({id:"hb"+l.bandNo,color:p(f[0],d),from:Math.min(n,o),to:Math.max(n,o),label:{text:"",zIndex:3}});r.annotations.push({id:"hb"+l.bandNo,type:"hband",yAxis:a,text:"",color:"#"+f[0],from:Math.min(l.bandStartPoint,s),to:Math.max(l.bandStartPoint,s)});l.build("table-only");l.banding=false;l.makeDirty();break}}}},cancel:{name:"<button>cancel</button>",callback:function(e,t){for(M=0;M<S.yAxis.length;M++){S.yAxis[M].removePlotBand("hb"+l.bandNo);l.banding=false}}}}}}else{return false}}}}},plotAnnotationSeries:function(){var e,a,i,s;var n=c[t];var o=n.controls.chart;var r=n.start||(n.intervals?l.intervalStartDt(n):n.firstdt);if(n.plots&&n.plots.length>0){for(e=0;e<n.plots.length;e++){if(n.plots[e].options.linRegressions){for(a=0;a<n.plots[e].options.linRegressions.length;a++){i=n.plots[e].options.linRegressions[a];if(i[0]>=r&&i[0]<=parseInt(n.end||n.lastdt)&&(i[1]>=r&&i[1]<=parseInt(n.to||n.lastdt))){this.plotLinearRegression(o.get("P"+e),i[0],i[1])}}}if(n.plots[e].options.averages){for(a=0;a<n.plots[e].options.averages.length;a++){s=n.plots[e].options.averages[a];if(s[0]>=r&&s[0]<=parseInt(n.end||n.lastdt)&&(s[1]>=r&&s[1]<=parseInt(n.to||n.lastdt))){this.plotAverage(o.get("P"+e),s[0],s[1])}}}}}o.redraw()},plotLinearRegression:function(e,a,i,s){if(!s)s=false;var n=c[t].controls.chart;var o=0,r=null,l=null;var d=0,p=null,h=null;var f,m=[],g=0;if(typeof a=="undefined"||typeof i=="undefined"){m=e.data}else{for(f=0;f<e.data.length;f++){if(e.data[f].x>=a&&e.data[f].x<=i){m.push(e.data[f])}}}for(f=0;f<m.length;f++){if(m[f].x!=null&&m[f].y!=null){o+=m[f].x;d+=m[f].y;if(r==null){r=m[f].x}if(l==null){l=m[f].x}if(p==null){p=m[f].y}if(h==null){h=m[f].y}if(r>m[f].x){r=m[f].x}if(l<m[f].x){l=m[f].x}if(p>m[f].y){p=m[f].y}if(h<m[f].y){h=m[f].y}g++}}var b=o/g;var v=d/g;var y=0;var k=0;for(f=0;f<m.length;f++){if(m[f].x!=null&&m[f].y!=null){y+=(m[f].x-b)*(m[f].y-v);k+=(m[f].x-b)*(m[f].x-b)}}var w=y/k;var x=v-w*b;var C=w*u.value[e.options.period];var M=C.toString().search(/[1-9]/);var $=C.toString().indexOf(".");var S={name:"Linear regression of "+e.name+"<BR> (m="+Highcharts.numberFormat(C,$>5||$==-1?0:M+5-$)+" per "+u.units[e.options.period]+")",dashStyle:"LongDash",period:e.options.period,lineWidth:1,color:e.color,data:[],id:"LR"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(f=0;f<m.length;f++){if(m[f].x!=null&&m[f].y!=null){S.data.push([m[f].x,w*m[f].x+x])}}return n.addSeries(S,s)},plotAverage:function(e,a,i,s){if(!s)s=false;var n=c[t].controls.chart;var o=0,r=0;var l,d=[],p=0;if(typeof a=="undefined"||typeof i=="undefined"){d=e.data}else{for(l=0;l<e.data.length;l++){if(e.data[l].x>=a&&e.data[l].x<=i){d.push(e.data[l]);if(e.data[l].y!==null){o+=e.data[l].y;r++}}}}var u=o/r;var h={name:"Average of "+e.name,dashStyle:"ShortDash",period:e.options.period,lineWidth:1,color:e.color,data:[],id:"AV"+this.bandNo++,calculatedFrom:e.options.id,shadow:false,marker:{enabled:false}};for(l=0;l<d.length;l++){h.data.push([d[l].x,u])}return n.addSeries(h,s)}};if(!n.isEmbedded)h.fetchStandards();return h};e.grapher=function(){var a=e,i=a.globals,s=a.common,n=i.panelGraphs,o=i.months,r=i.period,l=i.patVariable,d=i.hcColors,c=i.primeColors,p=i.MAP_COLORS,u=i.DEFAULT_RADIUS_SCALE,h=i.DEFAULT_RADIUS_FIXED,m=i.dashStyles,g=i.op,b=i.MyGraphs,v=i.vectorPattern,y=i.handlePattern,k=i.isIE,w=i.mapBackground,x=i.graphScriptFiles,C=s.dateFromMdDate,M=s.rationalize,S=s.callApi;var D={chartPanel:function st(e){console.time("chartPanel");var t=n[e];console.time("makeChartOptionsObject");var s=O(t);console.timeEnd("makeChartOptionsObject");var o=t.controls.$thisPanel.find("div.mashabledata_chart");if(s.series.length==0){o.hide();return void 0}var r;if(t.controls&&t.controls.chart){t.controls.chart.destroy();$.contextMenu("destroy","#"+e+" div.mashabledata_chart")}o.show();s.chart.renderTo=o.get(0);var l=t.controls.annotations;if(i.isEmbedded){s.plotOptions.series.point={events:{click:function(e){d(this.x)}}};s.chart.events={click:function(e){d(e.xAxis[0].value)}}}else{s.plotOptions.series.point={events:{mouseOver:function(e){l.mouseoverPoint=this;l.mouseOverHCPoint(e,this)},mouseOut:function(e){delete l.mouseoverPoint},click:function(e){if(l.banding){l.endBanding(e)}else{d(this.x)}}}};s.chart.events={click:function(e){if(l.banding){l.endBanding(e)}else{d(e.xAxis[0].value)}},selection:function(a){var i;var n;if(a.resetSelection){if(r.cropButton)r.cropButton=r.cropButton.destroy();t.minZoom=t.start===null?t.firstdt:t.start;t.maxZoom=t.end===null?t.lastdt:t.end}else{var o=$.extend(true,{},r.options.chart.resetZoomButton);o.position.y+=30;var l={x:r.plotLeft,y:r.plotTop,width:r.plotWidth,height:r.plotHeight};r.cropButton=r.renderer.button("Crop X-axis",null,null,function(){$("#"+e+" button.graph-crop").click()},{zIndex:20},null).attr({align:"right"}).attr({align:o.position.align,title:"Crop x-axis to current zoom level"}).add().align(o.position,false,l);var d=a.xAxis[0].min;var c=a.xAxis[0].max;for(var p=0;p<s.series.length;p++){var u=s.series[p].data;i=U(d,u,i);n=U(c,u,n)}t.minZoom=i;t.maxZoom=n}}}}console.time("highcharts");r=new Highcharts.Chart(s);if(t.controls)t.controls.chart=r;console.timeEnd("highcharts");l.plotAnnotationSeries();if(!i.isEmbedded){o.mouseover(function(e){if(l.banding){if(l.banding.substr(0,2)=="y-"){var t=$(r.container).offset().top,a=$(r.container).offset().left;var i=(k?e.originalEvent.x:e.clientX-a)-r.plotLeft,s=(k?e.originalEvent.y:e.pageY-t)-r.plotTop;if(s>=0&&s<=r.plotSizeY){for(var n=0;n<r.yAxis.length;n++){if(r.yAxis[n].userOptions.title.text==l.banding.substr(2)){var o=r.yAxis[n].translate(r.plotHeight-s,true);r.yAxis[n].removePlotBand("hb"+l.bandNo);r.yAxis[n].addPlotBand({id:"hb"+l.bandNo,color:equivalentRGBA(f[0],BAND_TRANSPARENCY),from:parseFloat(l.bandStartPoint),to:o,label:{text:"",zIndex:3}})}}}}}}).keydown(function(e){if(l.banding&&e){for(var t=0;t<r.axes.length;t++){r.axes[t].removePlotLine(l.banding);r.axes[t].removePlotBand(l.banding)}l.banding=false}});console.time("contextMenu");$.contextMenu({selector:"#"+e+" div.mashabledata_chart",build:function(e,i){var s,n,o,d,c;var p,u,h,m;var g=l.mouseoverPoint;var b=typeof l.mouseoverPoint!="undefined";if(l.banding){return l.endBanding(i)}else{var v={items:{point:{name:"annotate point",disabled:!b,callback:function(e,t){l.addPoint(g)}},sep0:"---------",vline:{name:"add vertical line",disabled:!b,callback:function(e,t){l.addXLine(g)}},vband:{name:"start vertical band",disabled:!b,callback:function(e,t){l.startXBand(g)}},sep1:"---------",hline:{name:"add horizontal line",items:{}},hband:{name:"start horizontal band",items:{}},sep2:"---------",avg:{name:"start average",disabled:!b,callback:function(e,t){if(!m){l.startAnalysisBanding(g,"AV")}else{l.deleteAnalysis(g)}}},regression:{name:"start linear regression",disabled:!b,callback:function(e,t){if(!h){l.startAnalysisBanding(g,"LR")}else{l.deleteAnalysis(g)}}},standard:{name:"add standard annotations",items:{}}}};if(b&&g.series.options.calculatedFrom&&g.series.options.id.substr(0,2)=="LR"){v.items.regression.name="delete linear regression";v.items.regression.className="delete-item";h=true;delete v.items.avg}if(b&&g.series.options.calculatedFrom&&g.series.options.id.substr(0,2)=="AV"){v.items.avg.name="delete average";v.items.avg.className="delete-item";m=true;delete v.items.regression}d=$(r.container).offset().top;c=$(r.container).offset().left;
n=(k?i.originalEvent.x:i.clientX-c)-r.plotLeft;o=(k?i.originalEvent.y:i.pageY-d)-r.plotTop;if(o>=0&&o<=r.plotSizeY){for(s=0;s<r.yAxis.length;s++){p=r.yAxis[s].userOptions.title.text;u=parseFloat(parseFloat(r.yAxis[s].translate(r.plotHeight-o,true).toPrecision(2)));v.items.hline.items["hltext"+s]={name:"<b>"+p+":</b>",type:"text",value:u};v.items.hline.items["hladd"+s]={name:"<button>add</button>",callback:function(e,a){var i=parseFloat($.contextMenu.getInputValues(a)["hltext"+e.substr(5)]);var s="hl"+l.lineNo++;r.yAxis[parseInt(e.substr(5))].addPlotLine({id:s,color:"#FF0000",width:2,value:i});t.annotations.push({id:s,type:"hline",color:"#FF0000",from:i,yAxis:r.yAxis[parseInt(e.substr(5))].userOptions.title.text,text:""});l.build("table-only")}};v.items.hband.items["hbtext"+s]={name:"<b>"+p+":</b>",type:"text",value:u};v.items.hband.items["hbadd"+s]={name:"<button>start</button>",callback:function(e,t){l.bandStartPoint=parseFloat($.contextMenu.getInputValues(t)["hbtext"+e.substr(5)]);l.banding="y-"+r.yAxis[e.substr(5)].userOptions.title.text;r.yAxis[parseInt(e.substr(5))].addPlotBand({id:"hb"+l.bandNo++,color:equivalentRGBA(f[0],BAND_TRANSPARENCY),from:l.bandStartPoint,to:l.bandStartPoint})}};if(s!=0){v.items.hline.items["yadd"+s+"sep"]="---------";v.items.hband.items["yadd"+s+"sep"]="---------"}}}else{if(!b)return false;v.items.hline.disabled=true;v.items.hband.disabled=true}for(s=0;s<a.globals.standardAnnotations.length;s++){v.items.standard.items["SA"+a.globals.standardAnnotations[s].annoid]={name:a.globals.standardAnnotations[s].name,callback:function(e,t){l.addStandard(parseInt(e.substr(2)))}}}return v}}});console.timeEnd("contextMenu");$("#"+e+" .highcharts-title").click(function(){J.show(this)})}console.timeEnd("chartPanel");return r;function d(e){var a=t.calculatedMapData;if(t.mapsets||t.pointsets){if(a.startDateIndex!=a.endDateIndex){var i=U(e,a.dates);for(var s=0;s<a.dates.length;s++){if(a.dates[s]["dt"].getTime()==i){t.controls.$thisPanel.find(".mashabledata_map-slider").slider("value",s)}}}}}},intervalStartDt:function nt(e){var t=new Date(parseInt(e.lastdt));switch(e.largestPeriod){case"A":return t.setUTCFullYear(t.getUTCFullYear()-(e.intervals-1));case"SA":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*6);case"Q":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1)*3);case"M":return t.setUTCMonth(t.getUTCMonth()-(e.intervals-1));case"W":return t.setUTCDate(t.getUTCDate()-(e.intervals-1)*7);default:return t.setUTCDate(t.getUTCDate()-(e.intervals-1))}},setCropSlider:function ot(e){if(i.isEmbedded)return;var t,a,s,o,l;var d=n[e];var c=d.controls.chart.options.chart;if(d.start===null){t=0}else{s=c.x.indexOf(d.start.toString());if(s>-1){t=s}else{o=null;for(s=0;s<c.x.length;s++){l=Math.abs(parseInt(c.x[s])-parseInt(d.start));if(o===null||o>l){o=l;t=s}}}}if(d.end===null){a=c.x.length-1}else{s=c.x.indexOf(d.end.toString());if(s>-1){a=s}else{o=null;for(s=0;s<c.x.length;s++){l=Math.abs(parseInt(c.x[s])-parseInt(d.end));if(o===null||o>l){o=l;a=s}}}}$("#"+e+" span.interval-crop-period").html(r.units[d.largestPeriod]+"s");$("#"+e+" div.crop-slider").slider("option","max",c.x.length-1).slider("option","values",[t,a])},dateFromMdDate:function rt(e){var t;t=new Date("1/1/"+e.substr(0,4)+" UTC");if(e.length>4){switch(e.substr(4,1)){case"Q":t.setUTCMonth((e.substr(5,1)-1)*3);break;case"H":t.setUTCMonth((e.substr(5,1)-1)*6);break;default:t.setUTCMonth(e.substr(4,2))}if(e.length>6){t.setUTCDate(e.substr(6,2));if(e.length>8){t.setUTCHours(e.substr(9,2));t.setUTCMinutes(e.substr(12,2));t.setUTCSeconds(e.substr(15,2))}}}return t},closestDate:function lt(e,t,a){var i;for(var s=0;s<t.length;s++){if(Array.isArray(t[s])){i=t[s][0]}else{if(t[s].dt){i=t[s].dt.getTime()}else{i=t[s].x}}if(Math.abs(e-i)<Math.abs(e-a)||a===undefined)a=i}return a},assetNeeded:function dt(e,t,a){t.assets=t.assets||{};if(!t.assets[e]){if(oMySeries&&oMySeries[e]&&oMySeries[e].data){t.assets[e]=$.extend(true,{},oMySeries[e])}else{a[e.charAt(0)].push(e.substr(1))}}},getAssets:function ct(e,t){var a={S:[],U:[],X:[],M:[]};var i,s,n;Y(e,function(){P(this.handle,e,a)});E(e,a,t)},fetchAssets:function pt(e,t,a){if(t.S.length>0||t.U.length>0){S({command:"GetMashableData",sids:t.S,usids:t.U,modal:"persist"},function(i,s,n){for(handle in i.series)e.assets[handle]=i.series[handle];t.S=[];t.U=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.M.length>0){S({command:"GetMapSets",mapsetids:t.M,map:e.map,modal:"persist"},function(i,s,n){for(handle in i.mapsets)e.assets[handle]=i.mapsets[handle];t.M=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.X.length>0){S({command:"GetPointSets",pointsetids:t.X,map:e.map,modal:"persist"},function(i,s,n){for(handle in i.pointsets)e.assets[handle]=i.pointsets[handle];t.X=[];if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()})}if(t.M.length+t.X.length+t.U.length+t.S.length==0)a()},createMyGraph:function ut(e,t){var a=b["G"+e];if(a){n($.extend(true,{},a))}else{for(var s in b){if(b[s].ghash==e){a=b[s];break}}if(a){n($.extend(true,{},a))}else{S({command:"GetPublicGraph",ghash:e},function(e,t,a){for(var i in e.graphs){D.inflateGraph(e.graphs[i]);n(e.graphs[i])}})}}function n(e){var a=(i.isEmbedded?[]:x).concat(e.mapFile?[(i.isEmbedded?"//remote.mashabledata.com/":"/global/js/maps/")+e.mapFile+".js"]:[]);require(a);_(e,function(){require(a,function(){q(e);if(t)t()})})}},inflateGraph:function ht(e){if(e.annotations){e.annotations=i(e.annotations,[])}else{e.annotations=[]}for(var t in e.plots){e.plots[t].options=i(e.plots[t].options,{});for(var a in e.plots[t].components){e.plots[t].components[a].options=i(e.plots[t].components[a].options,{})}}for(var t in e.pointsets){e.pointsets[t].options=i(e.pointsets[t].options,{});for(var a in e.pointsets[t].components){e.pointsets[t].components[a].options=i(e.pointsets[t].components[a].options,{})}}e.mapconfig=i(e.mapconfig,{});if(e.mapsets){e.mapsets.options=i(e.mapsets.options,{});for(var a in e.mapsets.components){e.mapsets.components[a].options=i(e.mapsets.components[a].options,{})}}function i(e,t){try{return JSON.parse(e.replace(/u0022/g,'"'))}catch(a){return t}}},emptyGraph:function ft(){return{annotations:[],title:"",type:"auto",map:"",assets:{},analysis:null,mapconfig:{},start:null,end:null,published:"N"}},makeChartOptionsObject:function mt(e){console.time("makeChartOptionsObject");var t,a,i,s={},n={};var o={chart:{animation:false,type:"line",zoomType:"x",x:[]},exporting:{enabled:false},plotOptions:{area:{stacking:"normal"},scatter:{zIndex:20,showInLegend:false},series:{zIndex:10,marker:{enabled:true,radius:4,symbol:"circle",states:{hover:{enabled:true}}},shadow:false,dataLabels:{align:"center",enabled:true,color:"#ffffff",formatter:function(){if(typeof this.point.id!="undefined"){return this.point.id}},y:9,x:0}}},legend:{enabled:true},credits:{enabled:true,text:"created with MashableData.com",href:"http://www.mashabledata.com"},series:[],title:{text:e.title,style:{cursor:"pointer"}},xAxis:{type:"datetime",min:e.start===null?e.intervals?A(e):null:parseInt(e.start),max:e.end===null?null:parseInt(e.end)},yAxis:[]};if(e.controls)o.chart.height=(e.controls.$thisPanel.height()-70-(e.map?70:0))*(e.mapsets||e.pointsets?.4:1);if(e.title.length==0){o.title.text="untitled - click to edit";o.title.style.color="grey";o.title.style.font="italic"}var l=0;function d(e,t){if(typeof t.firstdt!="undefined"){e.firstdt=typeof e.firstdt=="undefined"?parseInt(t.firstdt):Math.min(parseInt(t.firstdt),parseInt(e.firstdt));e.lastdt=typeof e.lastdt=="undefined"?parseInt(t.lastdt):Math.max(parseInt(t.lastdt),parseInt(e.lastdt))}else{if(t.mapsetid||t.pointsetid){for(location in t.data){e.firstdt=typeof e.firstdt=="undefined"?parseInt(t.data[location].firstdt):Math.min(parseInt(t.data[location].firstdt),parseInt(e.firstdt));e.lastdt=typeof e.lastdt=="undefined"?parseInt(t.data[location].lastdt):Math.max(parseInt(t.data[location].lastdt),parseInt(e.lastdt))}}}}Y(e,function(t,a){var i=e.assets[this.handle];if(i.src=="MashableData"){if(a.components.length==1){if(!e.firstdt&&!e.lastdt)Y(e,function(){d(e,e.assets[this.handle])});i.firstdt=e.firstdt;i.lastdt=e.lastdt}else{delete i.firstdt;delete i.lastdt;$.each(a.components,function(){d(i,e.assets[this.handle])})}i.data=dateConversionData(i.skey,i.firstdt,i.lastdt)}});for(t=0;t<e.plots.length;t++){var c=e.plots[t];var p=L(e,t);if(!c.options.color)c.options.color=et(e.plots);var u={name:p.name,marker:{enabled:e.type=="marker"},id:"P"+t,period:p.period,color:c.options.color,data:p.data,yAxis:0};if(c.options.type){if(c.options.type!="default")u.type=c.options.type}if(c.options.lineWidth)u.lineWidth=c.options.lineWidth;if(c.options.lineStyle)u.dashStyle=c.options.lineStyle;if(e.type=="area"||u.stack=="area"){u.stack=p.units}for(a=0;a<p.data.length;a++){s[p.data[a][0].toString()]=true}var h=p.units;var f={labels:{style:{color:"#333333"}},title:{text:h,style:{color:"#333333"}}};if(o.yAxis.length==0){o.yAxis.push(f)}else{var m=false;var g;for(g=0;g<o.yAxis.length;g++){if(o.yAxis[g].title.text==h){u.yAxis=g;m=true;break}}if(!m){f.title.style.color=u.color;f.labels.style.color=u.color;o.yAxis[0].title.style.color=o.series[0].color;o.yAxis[0].labels.style.color=o.series[0].color;f.opposite=true;o.yAxis.push(f);u.yAxis=g}}o.series.push(u);l++}for(var b in s){o.chart.x.push(Number(b))}o.chart.x.sort(function(e,t){return parseInt(e)-parseInt(t)});for(t=0;t<o.yAxis.length;t++){o.series.push({type:"scatter",id:"labelsY-"+t,yAxis:t,data:[],doNotShow:true})}switch(e.type){case"pie":var v=[{type:"pie",data:[]}];var y=e.end?parseInt(e.end):e.lastdt;for(t=0;t<o.series.length;t++){p=o.series[t];for(a=p.data.length-1;a>=0;a--){if(p.data[a][0]==y){v[0].data.push([p.name,p.data[a][1]]);break}}}o.series=v;o.chart.type=e.type;break;case"stacked-column":o.plotOptions.column={stacking:"normal"};for(t=0;t<o.series.length;t++){o.series[t].stack="stacked"}case"column":o.chart.type="column";break;case"area-percent":o.yAxis[0].title.text="percent";o.plotOptions.area.stacking="percent";case"area":o.chart.type="area";break;case"marker":break;case"auto":if(e.smallestPeriod!=e.largestPeriod){for(t=0;t<o.series.length;t++){if(e.largestPeriod==o.series[t].period){o.series[t].type="column";o.series[t].zIndex=8;o.series[t].pointRange=r.value[o.series[t].period];o.series[t].pointPlacement="between";o.series[t].pointPadding=0;o.series[t].groupPadding=.05}}}else{var k=0,w;for(t=0;t<o.series.length;t++){if(o.series[t].period){w=0;for(a=0;a<o.series[t].data.length;a++){i=o.series[t].data[a][0];if((!o.xAxis.min||o.xAxis.min<=i)&&(!o.xAxis.max||o.xAxis.max>=i))w++}k=Math.max(k,w)}}if(k<=5){o.chart.type="column";if(k==1&&e.smallestPeriod){if(o.xAxis.min)o.xAxis.min-=r.value[e.smallestPeriod]/4;if(o.xAxis.max)o.xAxis.max+=r.value[e.smallestPeriod]/4}}}break;case"logarithmic":for(t=0;t<o.yAxis.length;t++){o.yAxis[t].type="logarithmic"}break;case"normalized-line":var x;if(e.start){x=e.start}else{x=o.series[0].data[0][0]}var C=false;while(!C){C=true;for(t=0;t<o.series.length;t++){if(o.series[t].sid){while(x>o.series[t].data[0][0]){o.series[t].data.splice(0,1);if(o.series[t].data.length==0){break}if(x<o.series[t].data[0][0]){x=o.series[t].data[0][0]}}if(o.series[t].data.length==0){o.title.text="Error:  no common starting point for normalization";for(a=0;a<o.series.length;a++){o.series[a].data=[]}C=true;break}C=C&&x==o.series[t].data[0][0]}}}for(t=0;t<o.series.length;t++){for(a=o.series[t].data.length-1;a>=0;a--){o.series[t].data[a][1]=o.series[t].data[a][1]/o.series[t].data[0][1]}o.seriesyAxis=0}o.yAxis=[{title:{text:"Normalized to 1"}}]}if(e.smallestPeriod)o.xAxis.minTickInterval=r.value[e.smallestPeriod];console.timeEnd("makeChartOptionsObject");return o},createSerieFromPlot:function gt(e,t){console.time("createSerieFromPlot");var a,i,n,o,r,d,c,p,u,h,f=[],m,g={};c=e.plots[t];p={name:B(e,c),units:W(e,c)};n=c.components;p.period=c.options.fdown||e.assets[n[0].handle].period;c.formula=G(c);var b="return "+c.formula.formula.replace(l,"values.$1")+";";var v=new Function("values",b);var y=[],k;for(o=0;o<n.length;o++){k=R(o);y.push(k);if(c.options.fdown&&c.options.fdown!=e.assets[n[o].handle].period){u=s.downShiftData(e.assets[n[o].handle],c.options.fdown,c.options.algorithm,c.options.missing)}else{u=e.assets[n[o].handle].data.split("||")}for(r=0;r<u.length;r++){h=u[r].split("|");if(!g[h[0].toString()]){g[h[0].toString()]={}}g[h[0].toString()][k]=h[1]}}var w=!c.options.componentData||c.options.componentData=="required";var x=c.options.componentData=="missingAsZero";var $=c.options.componentData=="nullsMissingAsZero";var S=!c.options.breaks||c.options.breaks=="never";var D=c.options.breaks=="nulls";var T=c.options.breaks=="missing";for(m in g){a={};i=true;for(o=0;o<y.length;o++){if(!isNaN(g[m][y[o]])){a[y[o]]=parseFloat(g[m][y[o]])}else{if(g[m][y[o]]=="null"){if($){a[y[o]]=0}else{i=null;break}}else{if(w){i=null;break}else{a[y[o]]=0}}}}if(i){try{i=v(a);if(Math.abs(i)==Infinity||isNaN(i))i=null}catch(A){i=null}}if(i!==null||!S){if(i!==null)i=M(i);f.push([Date.parse(C(m)),i])}}f.sort(function(e,t){return e[0]-t[0]});if(T){f=addBreaks(f,p.period)}p.data=f;console.timeEnd("createSerieFromPlot");return p},plotFormula:function bt(e){var t,a,i=false,s=false,n="",o="",r="",l="";var d=/[+-/*]+/;for(var c=0;c<e.components.length;c++){t=e.components[c];a=R(c);if(!i&&t.options.dn&&t.options.dn=="d"){if(s){s=false;if(d.test(r))r="("+r+")";l+=r}n=l;l="";i=true}if(l.length==0){switch(t.options.op){case"/":s=true;r=p();l="1/";break;case"-":l="-"+p();break;case"+":case"*":default:l=p()}}else{switch(t.options.op){case"+":case"-":if(s){s=false;if(d.test(r))r="("+r+")";l+=r+" "+t.options.op+" "+p()}else{l+=" "+t.options.op+" "+p()}break;case"*":if(s){r+="*"+p()}else{l+="*"+p()}break;case"/":if(s){r+="*"+p()}else{s=true;l+="/";r=p()}}}}if(s){s=false;if(d.test(r))r="("+r+")";l+=r}if(i){o=l}else{n=l}if((e.options.k||1)==1){if(i){l=(n==""?1:d.test(n)?"("+n+")":n)+" / "+(d.test(o)?"("+o+")":o)}else{l=n}}else{if(i){l=e.options.k+" * "+(n=""?"":d.test(n)?"("+n+")":n)+" / "+(d.test(o)?"("+o+")":o)}else{l=e.options.k+" * "+(d.test(n)?"("+n+")":n)}}e.options.calculatedFormula={formula:l,denomFormula:o,numFormula:n,k:e.options.k||1};return e.options.calculatedFormula;function p(){return isNaN(t.options.k)||t.options.k==1?a:t.options.k+"*"+a}},compSymbol:function yt(e){var t="";if(e>25){t=String.fromCharCode("A".charCodeAt(0)+parseInt(e/26))}t+=String.fromCharCode("A".charCodeAt(0)+e%26);return t},buildGraphPanel:function kt(s,o){if(i.isEmbedded){r(s)}else{na("drawing the graph"+(window.SVGAngle?"":"<br>Note: Graphs will draw 20 times faster in a modern browser such as Chrome, Firefox, Safari or Internet Exploer 9 or later"));window.setTimeout(function(){r(s,o)},20)}function r(s,o){var r,h,f;console.time("buildGraphPanel:header");if(s.title.length==0){var m,g=0;for(m in s.assets){g++;if(g>1)break}if(g==1)s.title=s.assets[m].name}r=s.title;var b,y=i.isEmbedded;if(y){o="G"+s.ghash;f=$("div[data='"+s.ghash+"']:first");if(f.length==0)return}else{if(!o){o=Qt(r);$("#graph-tabs li").find("[href='#"+o+"']").html(r)}f=$("#"+o)}if(s.intervals==0)s.intervals=null;var k=new e.Annotator(o,Y);s.controls={annotations:k,$thisPanel:f,provenance:{},redraw:q};console.timeEnd("buildGraphPanel:header");if(y){b='<div class="mashabledata_chart-map">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<span class="right"><label><input type="checkbox" class="mashabledata_legend" '+(s.mapconfig.showLegend?"checked":"")+">legend</label></span>"+'<span class="right"><label><input type="checkbox" class="mashabledata_map-list" '+(s.mapconfig.showList?"checked":"")+">list</label></span>"+"</div>"+"</div>"+'<div class="mashabledata_graph-analysis"></div>'+"</div>"}else{b='<div class="graph-nav">'+'<ol class="graph-nav">'+'<li class="graph-nav-talk" data="graph-talk"></li>'+'<li class="graph-nav-data" data="graph-data"></li>'+'<li class="graph-nav-sources"  data="graph-sources"></li>'+'<li class="graph-nav-active graph-nav-graph" data="graph-chart"></li>'+"</ol>"+"</div>"+'<div class="graph-talk graph-subpanel" style="display: none;"><p>This graph must be saved at least once to enable Facebook comments.</p></div>'+'<div class="graph-data graph-subpanel" style="display: none;">'+'<div class="graph-data-inner">'+"<ul>"+'<li><a href="#data-chart-'+o+'">chart data</a></li>'+'<li><a href="#data-region-'+o+'">map region data</a></li>'+'<li><a href="#data-marker-'+o+'">map marker data</a></li>'+'</ul><button class="download-data ui-state-highlight" title="Download the graph data as an Excel workbook">Download to Excel&nbsp;</button>'+'<div id="data-chart-'+o+'" class="graph-data-subpanel" data="chart"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-region-'+o+'" class="graph-data-subpanel" data="regions"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+'<div id="data-marker-'+o+'" class="graph-data-subpanel" data="markers"><div class="slick-holder" style="width: 100%; height:100%;"></div></div>'+"</div>"+"</div>"+'<div class="provenance graph-sources graph-subpanel" style="display: none;"></div>'+'<div class="graph-chart graph-subpanel">'+'<div class="graph_control_panel" style="font-size: 11px !important;">'+'<div class="change-map">change base map '+'<select class="change-map"></select>'+"</div>"+'<div class="graph-type">default graph type '+'<select class="graph-type">'+'<option value="auto">auto (line &amp; column)</option>'+'<option value="line">line</option>'+'<option value="marker">line with markers</option>'+'<option value="column">column</option>'+'<option value="stacked-column">stacked column</option>'+'<option value="area-percent">stacked percent</option>'+'<option value="area">stacked area</option>'+'<option value="logarithmic">logarithmic</option>'+'<option value="normalized-line">normalized line</option>'+'<option value="pie">pie</option>'+"</select>"+"</div>"+'<div class="crop-tool"><fieldset><legend>Crop graph</legend>'+"<table>"+'<tr><td><input type="radio" name="'+o+'-rad-crop" id="'+o+'-rad-no-crop" class="rad-no-crop"></td><td><label for="'+o+'-rad-no-crop">no cropping (graph will expand as new data is gathered)</label></td></tr>'+'<tr><td><input type="radio" name="'+o+'-rad-crop" id="'+o+'-rad-hard-crop" class="rad-hard-crop"></td><td>'+'<div class="crop-dates"><i>select this option and slide endpoints for a fixed crop</i></div>'+'<div class="crop-slider"></div>'+"</td></tr>"+'<tr><td><input type="radio" name="'+o+'-rad-crop" id="'+o+'-rad-interval-crop" class="rad-interval-crop"></td>'+'<td><label for="'+o+'-rad-interval-crop">show latest <input class="interval-crop-count" value="'+(s.intervals||5)+'"> <span class="interval-crop-period"></span></label></td></tr>'+"</table>"+'<button class="graph-crop" style="display: none;">crop</button></fieldset>'+"</div>"+'<div class="annotations"><fieldset><legend>Chart annotations</legend>'+'<table class="annotations"></table>'+"</fieldset></div>"+'<div class="downloads">'+"<fieldset>"+"<legend>&nbsp;Download visualization&nbsp;</legend>"+'<select class="download-selector"></select> '+"format: "+'<span title="download the graph as a PNG formatted image" class="md-png rico export-chart">PNG</span>'+'<span title="download the graph as a SVG formatted vector graphic"class="md-svg rico export-chart">SVG</span>'+'<span title="download the graph as a PDF document" class="md-pdf rico export-chart">PDF</span>'+"</fieldset>"+"</div>"+'<div class="sharing">'+"<fieldset>"+"<legend>&nbsp;Sharing&nbsp;</legend>"+'<div class="share-links">'+'<a href="#" class="post-facebook"><img src="images/icons/facebook.png" />facebook</a> '+'<a class="graph-email">email </a> '+'<button class="graph-link">link </button>'+'</div><div class="searchability">'+'<input type="radio" name="'+o+'-searchability" id="'+o+'-searchable" value="Y" '+(s.published=="Y"?"checked":"")+' /><label for="'+o+'-searchable">public graph</label>'+'<input type="radio" name="'+o+'-searchability" id="'+o+'-private" value="N" '+(s.published=="N"?"checked":"")+' /><label for="'+o+'-private">'+(account.info.orgName?"restrict to "+account.info.orgName:"not searchable")+"</label>"+"</div>"+"</fieldset>"+"</div>"+'<br /><button class="graph-save">save</button> <button class="graph-saveas">save as</button> <button class="graph-close">close</button> <button class="graph-delete">delete</button><br />'+"</div>"+'<div class="mashabledata_chart-map" style="width:70%;display:inline;float:right;">'+'<div class="mashabledata_chart"></div>'+'<div class="mashabledata_map" style="display:none;">'+'<h3 class="mashabledata_map-title" style="color:black;"></h3>'+'<div class="mashabledata_map-and-cub-viz">'+'<div class="mashabledata_cube-viz right" style="width:29%;display:none;border:thin black solid;"></div>'+'<div class="mashabledata_jvmap" style="display: inline-block;"></div>'+"</div>"+'<div class="container mashabledata_map-controls">'+'<div class="mashabledata_map-slider" style="display: inline-block;width: 280px;"></div>'+'<button class="mashabledata_map-step-backward">step backwards</button>'+'<button class="mashabledata_map-play">play</button>'+'<button class="mashabledata_map-step-forward">step forwards</button>'+'<button class="mashabledata_map-graph-selected" title="graph selected regions and markers"  disabled="disabled">graph</button>'+'<button class="mashabledata_make-map" disabled="disabled">reset</button>'+'<button class="merge group hidden" disabled="disabled">group</button>'+'<button class="merge ungroup hidden" disabled="disabled">ungroup</button>'+'<span class="right"><label><input type="checkbox" class="legend" '+(s.mapconfig.showLegend?"checked":"")+">legend</label></span>"+'<span class="right"><label><input type="checkbox" class="map-list" '+(s.mapconfig.showList?"checked":"")+">list</label></span>"+"</div>"+"</div>"+'<div height="75px"><textarea style="width:98%;height:50px;margin-left:5px;" class="graph-analysis" maxlength="1000" /></div>'+"</div>"+"</div>"}f.html(b);var x,D;console.timeEnd("buildGraphPanel:thisPanel");console.time("buildGraphPanel:thisPanel events");if(y){f.find("div.mashabledata_graph-analysis").html(s.analysis)}else{function A(){if(s.ghash)f.find(".graph-talk.graph-subpanel").html('<fb:comments href="https://www.mashabledata.com/workbench/#/t=g&graphcode='+s.ghash+'"></fb:comments>')}A();f.find("ol.graph-nav").children("li").click(function(){var e=$(this);f.find("ol.graph-nav").children("li").removeClass("graph-nav-active");f.find(".graph-subpanel").hide();var t=f.find("."+e.attr("data")).show();e.addClass("graph-nav-active");switch(e.attr("data")){case"graph-talk":FB.XFBML.parse(t.get(0),function(){f.find("iframe").width(f.find(".graph-talk.graph-subpanel").width()*.9+"px").css("margin","15px")});break;case"graph-data":nt.provOk();f.find(".graph-data-inner").tabs(s.plots?"enable":"disable",0).tabs(s.mapsets?"enable":"disable",1).tabs(s.pointsets?"enable":"disable",2);var a=f.find(".graph-data-inner li:not(.ui-state-disabled)").first().find("a").click();if(a.html()=="chart data")da(D,o,$(a.attr("href")));break;case"graph-sources":nt.build();break;case"graph-chart":nt.provOk()}});f.find(".graph-data-inner").tabs({activate:function(e,t){console.timeEnd("complete grid data into table");da(D,o,t.newPanel);console.timeEnd("complete grid data into table")}});f.find("button.download-data").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var e=[];if(s.plots){var t=ca(o);e.push({name:"chart",grid:{columns:t.columns,data:t.rows}})}if(s.mapsets)e.push({name:"regions",grid:{columns:h.regionGrid.columns,data:h.regionGrid.data}});if(s.pointsets)e.push({name:"markers",grid:{columns:h.markerGrid.columns,data:h.markerGrid.data}});ha({filename:s.title,data:JSON.stringify(e),url:"excel.php"})});var U=f.find(".graph-subpanel").width(f.width()-35-2).height(f.height()).find(".mashabledata_chart-map").width(f.width()-40-350).end().innerHeight();f.find(".graph-data-subpanel").height(f.innerHeight()-60);f.find(".graph-sources").width(f.width()-35-2-40);f.find(".graph-analysis").val(s.analysis);f.find("select.download-selector").change(function(){if($(this).val()=="map"){if(!s.mapsets&&!s.pointsets){vt("no map","This graph does not have a map to download.  Map are adding to graphs by finding a series that belongs to a map set or a marker set and mapping the set.");$(this).val("chart")}}else{if(!s.plots){vt("no chart","This graph does not have a chart to download.");$(this).val("map")}}});f.find(".export-chart").click(function(){var e,t=$(this);if(t.hasClass("md-jpg"))e="image/jpeg";if(t.hasClass("md-png"))e="image/png";if(t.hasClass("md-svg"))e="image/svg+xml";if(t.hasClass("md-pdf"))e="application/pdf";st(e)});f.find("a.post-facebook").click(function(){var e;if(s.mapsets||s.pointsets){e=ua(ot.container.html())}else{k.sync();e=s.controls.chart.getSVG()}$.ajax({type:"POST",url:"export/index.php",dataType:"json",data:{type:"FB",width:"800",svg:e},success:function(e,t,a){var i=n[o].analysis;var s=n[o].title;var r={method:"feed",link:"http://www.mashabledata.com/workbench#/t=g1&graphcode="+n[o].ghash,picture:e.imageURL,message:i,name:"MashableData visualization",caption:s,description:i};function l(e){alert("Post ID: "+e["post_id"])}FB.ui(r,l)},error:function(e,t,a){console.log(t)}})});var P="mailto: "+"?subject="+escape(s.title||"link to my MashableData visualization")+"&body="+escape((s.analysis||"Link to my interactive visualization on MashableData.com:")+"<br><br>http://www.mashabledata.com/workbench/#/t=g2&graphcode="+s.ghash);f.find(".graph-email").button({icons:{secondary:"ui-icon-mail-closed"}}).attr("href",P);f.find(".email-link").attr("href",P);f.find(".graph-link").button({icons:{secondary:"ui-icon-link"}}).click(function(){if(s.isDirty){vt("Graph is not saved","Please save the graph first so that links will show the graph as currently displayed.");return}var e=$(this).offset();var t='<div id="link-editor">'+'<button class="right" id="link-editor-close">close</button>'+'<button id="ghash-reset" class="ui-state-error right">reset link code</button>'+'<b>link code: </b><span id="link-ghash">'+s.ghash+"</span><br><br>"+"<em>The code below will create a link to your graph</em>"+'<textarea id="link-html">&lt;a href=&quot;http://www.mashabledata.com/workbench/#/t=g2&graphcode='+s.ghash+"&quot;&gt;"+(s.title||"MashableData graph")+"&lt;/a&gt;</textarea>"+"</div>";$.fancybox(t,{width:600,height:100,showCloseButton:false,autoDimensions:false,autoScale:false,overlayOpacity:0});$("#fancybox-wrap").css({top:parseInt(e.top+$(this).height()-30)+"px",left:parseInt(e.left-620+$(this).width())+"px"});$("#link-editor-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()});$("#ghash-reset").button({icons:{secondary:"ui-icon-refresh"}}).click(function(){vt("confirm link code reset","If you have emailed a link to this graph or posted it on FaceBook or Twitter, those links will no longer work once the graph's link code is reset. Plese confirm to reset.",[{text:"Confirm",click:function(){$(this).dialog("close");$("#ghash-reset").button("disable");S({command:"resetGhash",gid:s.gid},function(e,t,a){var i=$("#link-html");i.html(i.html().replace(s.ghash,e.ghash));s.ghash=e.ghash;$("#link-ghash").html(s.ghash)})}},{text:"Cancel",click:function(){$(this).dialog("close")}}])})});f.find(".searchability").buttonset().find("#"+o+"-private").button("option","icons",{primary:"ui-icon-locked"}).end().find("#"+o+"-searchable").button("option","icons",{primary:"ui-icon-search"}).end().find("input").click(function(){s.published=$(this).val();Y()});if(s.start&&s.end){f.find(".rad-hard-crop").attr("checked",true)}else{if(s.intervals){f.find(".rad-interval-crop").attr("checked",true)}else{f.find(".rad-no-crop").attr("checked",true)}}var E=function(){var e=f.find(".crop-slider").slider("values");f.find(".rad-hard-crop").attr("checked",true);s.intervals=null;s.start=s.controls.chart.options.chart.x[e[0]];s.end=s.controls.chart.options.chart.x[e[1]];q()};var F=function(e){var t=$(e).slider("values");return V(s.controls.chart.options.chart.x[t[0]],s.smallestPeriod)+" - "+V(x.options.chart.x[t[1]],s.smallestPeriod)};f.find("div.crop-slider").slider({range:true,stop:function(){E()},change:function(){if(s.controls.chart){f.find(".crop-dates").html(F(this))}},slide:function(){f.find(".crop-dates").html(F(this))}});$("#"+o+"-rad-hard-crop").change(function(){E()});$("#"+o+"-rad-interval-crop").change(function(){if($(this).val()=="on"){var e=parseInt(f.find("input.interval-crop-count").val());if(!e||e<1){e=1;f.find("input.interval-crop-count").val(e)}s.intervals=e;s.start=null;s.end=null;q()}});$("#"+o+"-rad-no-crop").change(function(){s.intervals=null;s.start=null;s.end=null;s.minZoom=s.firstdt;s.maxZoom=s.lastdt;q()});f.find("input.interval-crop-count").spinner({min:1,incrementalType:false,stop:function(e,t){s.start=null;s.end=null;if(s.intervals!=parseInt($(this).val())){s.intervals=parseInt($(this).val());q()}}});f.find("button.graph-crop").click(function(){var e=n[o];e.start=e.minZoom>e.firstdt?e.minZoom:e.firstdt;e.end=e.maxZoom<e.lastdt?e.maxZoom:e.lastdt;$(this).attr("disabled","disabled");I(o);$("#"+o+"-rad-hard-crop").click()});f.find("div.annotations fieldset").height(U-f.find("div.change-map").height()-f.find("div.crop-tool").height()-f.find("div.graph-type").height()-f.find("div.downloads").height()-f.find("div.sharing").height()-50);f.find("input.graph-publish").change(function(){s.published=this.checked?"Y":"N"});f.find("select.graph-type").val(s.type).change(function(){if($(this).val()=="logarithmic"){for(var e=0;e<x.yAxis.length;e++){if(x.yAxis[e].getExtremes().dataMin<=0){f.find("select.graph-type").val(s.type);vt("Logarithmic scaling not available","Logarithmic Y-axis scaling is not allowed if negative values are present");return false}}}s.type=$(this).val();q()});function O(){var e,t,a,i="<option>"+s.map+"</option>",n=[];for(e in s.assets){if(e[0]=="M"&&s.assets[e].maps){for(a in s.assets[e].maps){if(a!=s.map){n.push(a)}}}}n.sort();for(t=0;t<n.length;t++){i+="<option>"+n[t]+"</option>"}return i}f.find("select.change-map").html(O()).change(function(){var e=$(this);var t=s.assets;delete s.assets;var a=s.calculatedMapData;delete s.calculatedMapData;delete s.assets;var i=s.controls;delete s.controls;var n=$.extend(true,{},s);s.assets=t;n.assets={};s.calculatedMapData=a;s.controls=i;n.map=$(this).val();n.mapFile=mapsList[$(this).val()].jvectormap;var o,r={};function l(e){var a;for(o=0;o<e.components.length;o++){if(v.test(e.components[o].handle)){a=t[e.components[o].handle];if(a.mapsetid&&mapsList[s.map].bunny&&mapsList[s.map].bunny==a.geoid){r[a.handle]={mapsetid:a.mapsetid,handle:a.handle}}else{n.assets[a.handle]=a}}}}if(n.plots){for(o=0;o<n.plots.length;o++){l(n.plots[o])}}if(n.pointsets){for(o=0;o<n.pointsets.length;o++){l(n.plots[o])}}if(n.mapsets){l(n.mapsets)}var d;function c(e,t,a,i,s){var n,o;for(n=0;n<e.components.length;n++){if(e.components[n].handle==t){e.components[n].handle=a.handle;if(e.options.name)e.options.name=e.options.name.replace(i,replacement)}}}S({command:"ChangeMaps",bunnies:r,fromgeoid:mapsList[s.map].bunny,togeoid:mapsList[n.map].bunny,modal:"persist"},function(t,a,i){var r=new RegExp(t.regex);
n.title=n.title.replace(r,t.replacement);for(d in t.bunnies){n.assets[t.bunnies[d].handle]=t.bunnies[d];if(d){if(n.plots){for(o=0;o<n.plots.length;o++){c(n.plots[o],d,t.bunnies[d],t.regex,t.replacement)}}if(n.pointsets){for(o=0;o<n.pointsets.length;o++){c(n.plots[o],d,t.bunnies[d],t.regex,t.replacement)}}if(n.mapsets){c(n.mapsets,d,t.bunnies[d],t.regex,t.replacement)}}}var l=["/global/js/maps/"+n.mapFile+".js"];require(l);_(n,function(){require(l,function(){kt(n);e.val(s.map)})})})});L();function L(){if(s.plots){f.find("div.graph-type").show()}else{f.find("div.graph-type").hide()}if(s.mapsets||s.pointsets){f.find("div.change-map").show()}else{f.find("div.change-map").hide()}var e="";if(s.plots)e+='<option value="chart">chart</option>';if(s.mapsets||s.pointsets)e+='<option value="map" selected>map</option>';if(H=z(s)){if(typeof s.mapconfig.cubeid=="undefined")s.mapconfig.cubeid="sum"}else{if(s.mapconfig.cubeid=="sum")delete s.mapconfig.cubeid}if(s.mapconfig.cubeid)e+='<option value="cube">supplemental bar chart</option>';$(".download-selector").html(e)}function q(){na("redrawing");setTimeout(function(){Jt(o);if(s.plots){K(s);x=T(o);k.build();f.find("div.mashabledata_chart").show()}else{f.find("div.mashabledata_chart").hide();f.find("div.annotations").hide()}L();if(s.mapsets||s.pointsets){ct();if(s.plots)f.find("map-title").hide();else f.find("map-title").show();f.find("select.change-map").html(O())}else{f.find("div.mashabledata_map").hide()}sa()},10)}}var H;if(!y){f.find(".graph-analysis").keydown(function(){n[o].analysis=this.value;Y()})}s.isDirty=!s.gid;function Y(){s.isDirty=true;f.find(".graph-save").button("enable")}function X(){s.isDirty=false;f.find(".graph-save").button("disable")}function it(){Bt(s,A);f.find("button.graph-delete, button.graph-saveas").button("enable");X()}function st(e){switch(f.find("select.download-selector").val()){case"map":pa(o,e);break;case"chart":k.sync();x.exportChart({type:e,width:2e3});break;case"cube":s.controls.vizChart.exportChart({type:e,width:2e3});break}}if(!y){f.find("button.graph-save").button({icons:{secondary:"ui-icon-disk"}}).button(s.userid==account.info.userid&&s.gid?"disable":"enable").click(it);f.find("button.graph-saveas").button({icons:{secondary:"ui-icon-copy"},disabled:!s.gid}).click(function(){delete s.gid;J.show(this,it)});f.find("button.graph-close").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){$("ul#graph-tabs a[href=#"+o+"]").siblings("span").click()});f.find("button.graph-delete").button({icons:{secondary:"ui-icon-trash"},disabled:!s.gid}).addClass("ui-state-error").click(function(){vt("Permanently Delete Graph","Are you sure you want to delete this graph?",[{text:"Delete",id:"btn-dia-enable",click:function(){deleteMyGraph(o);$(this).dialog("close")}},{text:"Cancel",id:"btn-dia-disable",click:function(){$(this).dialog("close")}}])})}console.timeEnd("buildGraphPanel:thisPanel events");K(s);n[o]=s;if(!y){console.time("buildGraphPanel:provController");var nt=new t(o);s.controls.provenance=nt;console.timeEnd("buildGraphPanel:provController")}if(s.plots){console.time("buildGraphPanel:build annoatations");x=T(o);k.build();I(o);console.timeEnd("buildGraphPanel:build annoatations");f.find("div.highcharts-container").mousedown(function(e){if(e.which==3){}})}else{f.find("div.mashabledata_chart").hide();f.find("div.annotations").hide()}var ot=null,rt,lt,dt;console.time("buildGraphPanel:drawMap");ct();console.timeEnd("buildGraphPanel:drawMap");function ct(){if(s.map&&(s.mapsets||s.pointsets)){if(ot)ot.remove();var e=(s.controls.$thisPanel.height()-85-(s.plots?0:55))*(s.plots?.6:1);if(parseInt(s.mapconfig.cubeid)||s.mapconfig.cubeid=="sum"){f.find(".mashabledata_cube-viz").show().height(e);f.find(".mashabledata_jvmap").css("width","70%")}else{if(s.controls.vizChart){s.controls.vizChart.destroy();delete s.controls.vizChart}f.find(".mashabledata_cube-viz").hide();f.find(".mashabledata_jvmap").removeAttr("style")}h=ut(s);ht(s);if(pt())T();var t=Q(s.pointsets);var a=Z(s.pointsets);var i=/us.._merc_en/.test(s.mapFile)?.9:1;rt={map:s.mapFile,zoomMin:i,focusOn:{scale:i,x:.5,y:.5},backgroundColor:w,zoomOnScroll:true,markersSelectable:true,markerStyle:{initial:{r:5},selected:{"stroke-width":4,stroke:"yellow"}},regionStyle:{selected:{"stroke-width":2,stroke:"black",fill:"#ffff80"},hover:{"stroke-width":2,stroke:"black","fill-opacity":1}},series:{regions:[{attribute:"fill"}],markers:[{attribute:"r"},{attribute:"fill"},{attribute:"stroke"}]},onRegionLabelShow:function(e,t,a){var i,s=[],n=ft(h.regionData,h.dates[lt].s);if(h.regionColors){var o=ft(h.regionColors,h.dates[lt].s);if(o&&typeof o[a]!="undefined"){for(i=0;i<h.dates.length;i++){if(h.regionData[h.dates[i].s]&&typeof h.regionData[h.dates[i].s][a]!="undefined")s.push(h.regionData[h.dates[i].s][a])}var r=n[a];t.html("<div><b>"+h.title+": "+ot.getRegionName(a)+"</b> "+Highcharts.numberFormat(r,parseInt(r)==r?0:2)+" "+(h.mapUnits||"")+'</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>').css("z-Index",400);var l={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true,width:Math.min(400,10*s.length)+"px"};if(s.length<10)l.type="bar";if(typeof r!="undefined"&&r!==null)l.valueSpots[r.toString()+":"+r.toString()]="red";if(s.length>1)$(".inlinesparkline").sparkline(s,l)}}},regionsSelectable:typeof s.mapsets!="undefined",markers:h.markers,onMarkerLabelShow:function(e,t,a){var i,s=[],n=ft(h.markerData,h.dates[lt].s);for(i=0;i<h.dates.length;i++){if(typeof h.markerData[h.dates[i].s]!="undefined")s.push(h.markerData[h.dates[i].s][a].r||h.markerData[h.dates[i].s][a].f)}if(n&&n[a]){var o,r=n[a].r;if(pt()){var l=[],d=a.split("+");for(i=0;i<d.length;i++){l.push(ot.getRegionName(d[i]))}o="<div><b>"+h.title+": "+l.join(" + ")+"</b> "}else{o="<div><b>"+t.html()+":</b> "}if(n[a].r)o+=Highcharts.numberFormat(n[a].r,parseInt(n[a].r)==n[a].r?0:2)+" "+(h.radiusUnits||"")+"<br>";if(n[a].f)o+=Highcharts.numberFormat(n[a].f,parseInt(n[a].f)==n[a].f?0:2)+" "+(h.fillUnits||"")+"<br>";o+='</div><span class="inlinesparkline" style="height: 30px;margin:0 5px;"></span>';t.html(o).css("z-Index",400);var c={height:"30px",valueSpots:{},spotColor:false,minSpotColor:false,maxSpotColor:false,disableInteraction:true};c.valueSpots[r.toString()+":"+r.toString()]="red";$(".inlinesparkline").sparkline(s,c)}},onRegionClick:function(){if(!b.is(":visible"))ot.clearSelectedRegions()},onRegionSelected:function(e,t,a){g(t,a);C();var i=ot.getSelectedMarkers();if(i.length>0){f.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("enable");return}var s=ot.getSelectedRegions();console.info("onRegionSelected "+s.length);if(b.is(":visible")){for(var n=0;n<s.length;n++){if(h.regionColors){for(var o in h.regionColors){if(typeof h.regionColors[o][s[n]]!="undefined"){f.find(".mashabledata_map-graph-selected, .make-map").button("enable");return}break}}}f.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("disable")}},onMarkerSelected:function(e,t,a){rt.onRegionSelected(e,t,a)},onZoom:function(e,t){transferTransform()}};lt=h.endDateIndex;f.find("div.mashabledata_map").show();f.find("div.mashabledata_jvmap").show().height(e).vectorMap(rt);ot=f.find("div.mashabledata_jvmap").vectorMap("get","mapObject");s.controls.map=ot;var n=$('<div class="mashabledata_map-date"></div>').prependTo(f.find("div.jvectormap-container"));var r=f.find("div.mashabledata_jvmap svg g:first");if(pt()){I();ot.series.regions[0].setAttributes(h.regionsColorsForBubbles);f.find("button.merge").show()}var l=f.find(".mashabledata_map-slider");if(h.startDateIndex!=h.endDateIndex){l.show().off().slider({value:h.endDateIndex,min:h.startDateIndex,max:h.endDateIndex,step:1,change:function(e,t){lt=t.value;m(lt)}}).slider("value",h.endDateIndex)}else{l.hide();m(h.startDateIndex)}function m(e){if(!pt()&&h.regionColors){ot.series.regions[0].setAttributes(ft(h.regionColors,h.dates[e].s))}if(s.pointsets){if(a){ot.series.markers[0].setAttributes(ft(h.markerAttr.r,h.dates[e].s));ot.series.markers[2].setAttributes(ft(h.markerAttr.stroke,h.dates[e].s))}if(t){ot.series.markers[1].setAttributes(ft(h.markerAttr.fill,h.dates[e].s))}}if(pt()){ot.series.markers[0].setAttributes(ft(h.markerAttr.r,h.dates[e].s));ot.series.markers[2].setAttributes(ft(h.markerAttr.stroke,h.dates[e].s))}if(s.plots){var i=x.xAxis[0];i.removePlotLine("timeLine");i.addPlotLine({value:h.dates[e].dt,color:"red",width:2,id:"timeLine"})}g()}function g(e,t){console.time("cubeVizFromMap");if(parseInt(s.mapconfig.cubeid)||s.mapconfig.cubeid=="sum"){var a,i=h.dates[lt].s;if(e){a=e}else{a=null;var o=ot.getSelectedRegions();if(o.length>0){a=o[0]}else{var r=ot.getSelectedMarkers();if(r.length>0){a=r[0]}else{a=s.bunny||mapsList[s.map].bunny}}}if(s.mapconfig.cubeid=="sum"){if(!isNaN(a))a="G"+a;var l=s.mapsets.options.calculatedFormula;var d=l.numFormula.replace("-","+-").split("+");var c=l.numFormula.replace("-","+").split("+");var p,u,f={},m=[],g,b=[],v,y={},w={};$.each(s.mapsets.components,function(e){p=s.assets[this.handle];m.push(p.name);v=R(e);if(this.handle[0]=="M"){f[v]=p.data[a]?p.data[a].data:null}else{f[v]=p.data}m.push(p.name);w[v]=p.name});for(g=c.length-1;g>=0;g--){if(c[g].trim()=="")c.splice(g,0,1);else b.unshift(w[c[g].trim()].split(" "))}var x=[],C=true,M=true;while(C&&M){for(g=0;g<b.length;g++){while(b[g].length>0&&b[g][0]=="")b[g].shift();while(b[g].length>0&&b[g][b[g].length-1]=="")b[g].pop();if(b[g].length>0){if(b[g][0]!=b[0][0])C=false;if(b[g].length>1){if(b[g][b[g].length-1]!=b[0][b[0].length-1])M=false}}else{C=M=false;break}}if(C)x.unshift(b[0][0]);if(M)x.push(b[0][b[0].length-1]);for(g=0;g<b.length;g++){if(C)b[g].shift();if(M)b[g].pop()}}var S=[];s.assets.cube={dimensions:[{list:[]}]};var D=s.assets.cube;D.theme=x.join(" ");D.name="";D.units=W(s,s.mapsets);D["G"+a]={facetedData:[]};for(g=0;g<b.length;g++){D.dimensions[0].list.push({name:b[g].join(" ")});D["G"+a].facetedData[g]=f[c[g].trim()]}}var T="new";if(H){if(e){T=t?"add":"remove"}else{T="summation"}}at(s,a,i,T);console.time("vizChart.redraw");if(!k&&T=="remove")s.controls.vizChart.redraw();console.timeEnd("vizChart.redraw")}n.html(V(h.dates[lt].dt.getTime(),h.period));console.timeEnd("cubeVizFromMap")}if(s.mapconfig.showList){S(ot)}var b=f.find(".mashabledata_map-graph-selected");if(Highcharts&&h.startDateIndex!=h.endDateIndex){b.button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var e=ot.getSelectedRegions();var t=ot.getSelectedMarkers();var a=N(),i,n,o,r,l,d,c,p,u,f,m,g,b,v;a.plots=[];a.title="from map of "+s.title;for(o=0;o<t.length;o++){if(pt()){i=$.extend(true,{},s.mapsets);delete i.formula;delete i.options.calculatedFormula;f=i.components;i.components=[];c=t[o].split("+");p=[];for(r=0;r<c.length;r++){p.push(ot.getRegionName(c[r]));for(l=0;l<f.length;l++){if(f[l].handle[0]=="M"){b=$.extend({units:s.assets[f[l].handle].units,period:s.assets[f[l].handle].period},s.assets[f[l].handle].data[c[r]]);g=$.extend(true,{},f[l]);g.handle=b.handle;a.assets[b.handle]=b;i.components.push(g)}else{i.components.push($.extend(true,{},f[l]));a.assets[f[l].handle]=s.assets[f[l].handle]}}}i.options.name=B(s,s.mapsets)+" for "+p.join("+");a.plots.push(i)}else{for(d=0;d<s.pointsets.length;d++){u=$.extend(true,{},s.pointsets[d]);v=false;m=u.components;for(l=0;l<m.length;l++){if(m[l].handle[0]=="X"&&s.assets[m[l].handle].data[t[o]]){v=true;sHandle=s.assets[m[l].handle].data[t[o]].handle;a.assets[sHandle]=$.extend({units:s.assets[m[l].handle].units,period:s.assets[m[l].handle].period},s.assets[m[l].handle].data[t[o]]);m[l].handle=sHandle}else{a.assets[m[l].handle]=s.assets[m[l].handle]}}if(v)a.plots.push(u)}}}if(s.mapsets&&s.mapsets){for(o=0;o<e.length;o++){for(var y in h.regionData){if(typeof h.regionColors[y][e[o]]!="undefined"){i=$.extend(true,{},s.mapsets);for(r=0;r<i.components.length;r++){if(i.components[r].handle.substr(0,1)=="M"){var k=s.assets[i.components[r].handle];var w=$.extend(true,{name:k.geoname,period:k.period,units:k.units,mapsetid:i.components[r].handle.substr(1)},k.data[e[o]]);i.components[r].handle=w.handle;a.assets[w.handle]=w}else{a.assets[i.components[r].handle]=$.extend(true,{},s.assets[i.components[r].handle])}}if(i.name)i.name+=" - "+ot.getRegionName(e[o]);a.plots.push(i)}break}}}if(a.plots.length>0)Tt(a,true)})}else{b.hide()}var v=f.find(".mashabledata_map-play");if(h.startDateIndex!=h.endDateIndex){v.off().click(function(){var e,t,a,i=Math.min(1e4/h.dates.length,500);if(v.attr("title")=="play"){v.button({text:false,icons:{primary:"ui-icon-pause"}}).attr("title","pause");s()}else{v.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}function s(){if(v.attr("title")=="pause"){e=new Date;var n=l.slider("value")+1;if(n>h.endDateIndex)n=h.startDateIndex;l.slider("value",n);t=new Date;a=Math.max(1,i-(t.getTime()-e.getTime()));if(n==h.endDateIndex){v.button({text:false,icons:{primary:"ui-icon-play"}}).attr("title","play")}else{if(v.attr("title")=="pause"){window.setTimeout(s,a)}}}}}).button({text:false,icons:{primary:"ui-icon-play"}});f.find(".mashabledata_map-step-backward").off().click(function(){l.slider("value",l.slider("value")-1)}).button({text:false,icons:{primary:"ui-icon-seek-first"}});f.find(".mashabledata_map-step-forward").off().click(function(){l.slider("value",l.slider("value")+1)}).button({text:false,icons:{primary:"ui-icon-seek-end"}})}else{v.hide();f.find(".mashabledata_map-step-backward, .mashabledata_map-step-forward").hide()}if(s.plots)f.find("h3.mashabledata_map-title").hide();else f.find("h3.mashabledata_map-title").html(s.title).click(function(){J.show(this)});var k=false;if(Highcharts&&h.startDateIndex!=h.endDateIndex){f.find(".mashabledata_make-map").button({icons:{secondary:"ui-icon-arrowrefresh-1-s"}}).off().click(function(){k=true;ot.clearSelectedMarkers();ot.clearSelectedRegions();k=false;if(s.controls.vizChart)s.controls.vizChart.redraw();f.find(".mashabledata_map-graph-selected, .mashabledata_make-map").button("disable")})}else{f.find(".mashabledata_make-map").hide()}function C(){var e,t,a;dt={newMerge:false,growable:false,splinter:false,ungroupable:false};if(!pt())return;var i=ot.getSelectedMarkers();var n=ot.getSelectedRegions();for(e=0;e<i.length;e++){if(i[e].split("+").length>1){dt.ungroupable=true;break}}if(s.mapsets.options.merges){for(e=0;e<n.length;e++){for(t=0;t<s.mapsets.options.merges.length;t++){if(s.mapsets.options.merges[t].indexOf(n[e])>=0){dt.ungroupable=true;break}}}}if(i.length>1){dt.growable=true}else{if(i.length==1){a=i[0].split("+");for(e=0;e<n.length;e++){if(a.indexOf(n[e])==-1){dt.growable=true;break}}}else{if(n.length>1){if(dt.ungroupable){dt.growable=true}else{dt["newMerge"]=true}}}}f.find("button.group").button(dt.newMerge||dt.growable?"enable":"disable");f.find("button.ungroup").button(dt.ungroupable?"enable":"disable")}if(!y){f.find("button.group").button({icons:{secondary:"ui-icon-circle-plus"}}).off().click(function(){if(dt.newMerge){if(!s.mapsets.options.merges)s.mapsets.options.merges=[];s.mapsets.options.merges.push(ot.getSelectedRegions())}if(dt.growable){var e,t,a=[];var i=ot.getSelectedMarkers();var n=ot.getSelectedRegions();for(e=0;e<i.length;e++){a=a.concat(i[e].split("+"));if(i[e].split("+").length>1){for(t=0;t<s.mapsets.options.merges.length;t++){if(i[e]==s.mapsets.options.merges[t].join("+")){s.mapsets.options.merges.splice(t,1);break}}}}for(e=0;e<n.length;e++){for(t=0;t<s.mapsets.options.merges.length;t++){if(s.mapsets.options.merges[t].indexOf(n[e])>-1){a=a.concat(s.mapsets.options.merges.splice(t,1)[0]);break}}}for(e=0;e<n.length;e++){if(a.indexOf(n[e])==-1)a.push(n[e])}s.mapsets.options.merges.push(a)}ot.removeAllMarkers();ot.clearSelectedRegions();T();I();ot.series.markers[0].setAttributes(ft(h.markerAttr.r,h.dates[lt].s));ot.series.markers[2].setAttributes(ft(h.markerAttr.stroke,h.dates[lt].s));ot.series.regions[0].setAttributes(h.regionsColorsForBubbles);Y()});f.find("button.ungroup").button({icons:{secondary:"ui-icon-arrow-4-diag"}}).off().click(function(){var e,t;var a=ot.getSelectedMarkers();var i=ot.getSelectedRegions();for(e=0;e<a.length;e++){if(a[e].split("+").length>1){for(t=0;t<s.mapsets.options.merges.length;t++){if(a[e]==s.mapsets.options.merges[t].join("+")){s.mapsets.options.merges.splice(t,1);break}}}}for(e=0;e<i.length;e++){for(t=0;t<s.mapsets.options.merges.length;t++){pos=s.mapsets.options.merges[t].indexOf(i[e]);if(pos!=-1){s.mapsets.options.merges[t].splice(pos,1);if(s.mapsets.options.merges[t].length==0){s.mapsets.options.merges.splice(t,1)}break}}}ot.removeAllMarkers();ot.clearSelectedRegions();T();I();ot.series.markers[0].setAttributes(ft(h.markerAttr.r,h.dates[lt].s));ot.series.markers[2].setAttributes(ft(h.markerAttr.stroke,h.dates[lt].s));ot.series.regions[0].setAttributes(h.regionsColorsForBubbles);Y()})}var M;if(s.mapconfig.showLegend)M=D(ot);f.find(".mashabledata_legend").change(function(){s.mapconfig.showLegend=$(this).prop("checked");Y();if(s.mapconfig.showLegend){M=D(ot)}else{M.remove()}});f.find("input.mashabledata_map-list").change(function(){s.mapconfig.showList=$(this).prop("checked");Y();if(s.mapconfig.showList){S(ot)}else{f.find("div.mashabledata_map-list").remove()}});if(s.mapconfig.showList)S(ot)}function S(e){var t=[],a,i,n;if(f.find("div.mashabledata_map-list").length==0){f.find("div.jvectormap-container").prepend('<div class="mashabledata_map-list">'+'<div class="order">'+'<input type="radio" id="'+o+'-map-list-order-asc" name="'+o+'-map-list-order" value="asc" '+(s.mapconfig.listOrder!="desc"?"checked":"")+'><label for="'+o+'-map-list-order-asc">ascending</label>'+'<input type="radio" id="'+o+'-map-list-order-desc" name="'+o+'-map-list-order" value="desc" '+(s.mapconfig.listOrder=="desc"?"checked":"")+'><label for="'+o+'-map-list-order-desc">descending</label>'+"</div>"+'<button class="download-map-list">download list to Excel</button>'+"</div>").find("div.mashabledata_map-list .download-map-list").button({icons:{secondary:"ui-icon-calculator"}}).click(function(){var e=f.find("div.mashabledata_map-list table").get(0);var t=[];for(var a=0;a<e.rows.length;a++){t.push([e.rows[a].cells[0].innerHTML.replace("<br>",""),e.rows[a].cells[1].innerHTML,e.rows[a].cells[2].innerHTML])}ha({filename:s.title,data:JSON.stringify([{name:"ranked list",grid:t}]),url:"excel.php"})}).end().find("div.mashabledata_map-list div.order").buttonset().find("input:radio").click(function(){s.mapconfig.listOrder=$(this).val();S(ot)})}if(s.mapsets){i=h.mapUnits;var r=ft(h.regionData,h.dates[lt].s);for(a in r){if(r[a]!==null){t.push({name:ot.getRegionName(a),value:r[a]})}}}else{if(h.fillUnits){i=h.fillUnits;n="f"}else{i=h.radiusUnits;n="r"}var l=ft(h.markerData,h.dates[lt].s);for(a in l){if(l[a][n]!==null){t.push({name:h.markers[a].name,value:l[a][n]})}}}t.sort(function(e,t){return(s.mapconfig.listOrder=="desc"?-1:1)*(t.value-e.value)});var d="<table><thead><th>Rank <br>"+f.find("div.mashabledata_map-date").html()+"</th><th>"+h.title+"</th><th>"+i+"</th></thead><tbody>";for(var c=0;c<t.length;c++){d+="<tr><td>"+(c+1)+"</td><td>"+t[c].name+"</td><td>"+t[c].value+"</td></tr>"}d+="</tbody></table>";f.find("div.mashabledata_map-list").find("table").remove().end().append(d).show()}function D(e){var t=10,a=5,i=20,n=10,o,r,l=0,d=0,c=0,h,m,g,b=20;if(s.mapsets&&!pt()){if(s.mapsets.options.scale=="discrete"){r=185;l=i+2*n+s.mapsets.options.discreteColors.length*(n+20)}else{r=100;if(s.calculatedMapData.regionMin<0&&s.calculatedMapData.regionMax>0){l=6*n+2*80+4*i}else{l=4*n+80+3*i}}}else r=0;var v=Z(s.pointsets),y=Q(s.pointsets);if(s.pointsets||pt()){o=185;if(v>1&&y==0){d+=v*(n+2*t)+(d==0?n:0)}if(v>0||pt()){var k=parseInt(s.mapconfig.maxRadius)||u;var w=+k/Math.sqrt(10);d+=2*(n+Math.max(k,15)+w)+(d==0?n:0)}}else o=0;var x=e.canvas.addGroup();e.canvas.addCircle({cx:0,cy:0},{initial:{r:20,"fill-opacity":0,"stroke-width":0}},x);f.append('<div id="dummyLegend" class="hidden"></div>');var C=new Highcharts.Renderer($("#dummyLegend")[0],e.width,e.height);C.box=x.node;$("#dummyLegend").remove();var M=s.mapconfig.legendLocation||mapsList[s.map].legend||"TR";switch(M.substr(0,1)){case"T":m=n;break;case"C":m=(e.height-Math.max(d,l))/2-n;break;case"B":m=e.height-Math.max(d,l)-n}switch(M.substr(1,1)){case"L":g=n;if(M.substr(0,1)=="T")g+=30;break;case"C":g=(e.width-r-o)/2-n;break;case"R":g=e.width-r-o-n}C.rect(g,m,o+r,Math.max(d,l),5).attr({fill:"white",opacity:.5,"stroke-width":0}).add();var S={opacity:1,"stroke-width":0,"z-index":1e3};function D(e,t,a,i){var s,n,o,r,l,d,c,p,u;s=parseInt(a.substr(1,2),16);n=parseInt(a.substr(3,2),16);o=parseInt(a.substr(5,2),16);r=parseInt(i.substr(1,2),16);l=parseInt(i.substr(3,2),16);d=parseInt(i.substr(5,2),16);for(var h=0;h<40;h++){c=Math.round(s-(s-r)*h/39).toString(16);p=Math.round(n-(n-l)*h/39).toString(16);u=Math.round(o-(o-d)*h/39).toString(16);C.rect(e,t+2*h,20,2,0).attr({fill:"#"+(c.length==1?"0":"")+c+(p.length==1?"0":"")+p+(u.length==1?"0":"")+u,opacity:1,"stroke-width":0,"z-index":1e3}).add()}}if(s.pointsets||pt()){if(v>1&&y==0){$.each(s.pointsets,function(e){if(this.options.attribute!="fill"){c=(e+1)*(n+2*t)-t;C.circle(g+n+t,m+c,Math.min(k,t)).attr({fill:this.options.color,opacity:1,"fill-opacity":1,stroke:"black","stroke-width":1}).add();C.text(B(s,s.pointsets[e]).substring(0,b),g+2*(n+t),m+c).add()}c+=t})}if(v>0||pt()){c+=n+(w||5);var T={"fill-opacity":0,opacity:1,stroke:"black","stroke-width":1};C.circle(g+n+k,m+c,w).attr(T).add();C.text(tt((s.calculatedMapData.radiusScale||s.calculatedMapData.markerDataMax)/10),g+2*(k+n),m+c).css({fontSize:"12px"}).add();c+=(w||5)+n+k;C.circle(g+n+k,m+c,k).attr(T).add();C.text(tt(s.calculatedMapData.radiusScale||s.calculatedMapData.markerDataMax),g+2*(k+n),m+c).css({fontSize:"12px"}).add();C.text(s.calculatedMapData.radiusUnits,g+2*(k+n),m+c+2*n).css({fontSize:"12px"}).add()}}if(s.mapsets&&!pt()){C.text(W(s,s.mapsets).substr(0,25),g+n,m+i+a).css({fontSize:"12px"}).add();if(s.mapsets.options.scale!="discrete"&&s.mapsets.options.logMode=="on")C.text("logarymic scale",g+n,m+2*i).css({fontSize:"12px"}).add();if(s.mapsets.options.scale=="discrete"){for(h=0;h<s.mapsets.options.discreteColors.length;h++){c=n+(s.mapsets.options.discreteColors.length-h)*(n+20);C.rect(g+o+n,m+c,i,i,0).attr({fill:s.mapsets.options.discreteColors[h].color,opacity:1,stroke:"black","stroke-width":1}).add();C.text((h==s.mapsets.options.discreteColors.length-1?"&gt; ":" ")+s.mapsets.options.discreteColors[h].cutoff,g+o+n+i+n,m+c+i/2+a).css({fontSize:"12px"}).add()}}else{c+=2*i;C.text(tt(s.calculatedMapData.regionMax),g+o+n,m+c+i/2+a).css({fontSize:"12px"}).add();c+=i+n;if(s.calculatedMapData.regionMax>0){D(g+o+n,m+c,s.mapsets.options.posColor||p.POS,p.MID);c+=80+n;if(s.calculatedMapData.regionMin<0){C.text("0",g+o+n,m+c+i/2+a).css({fontSize:"12px"}).add();c+=i+n}}if(s.calculatedMapData.regionMin<0){D(g+o+n,m+c,p.MID,s.mapsets.options.negColor||p.NEG);c+=80+n}C.text(tt(s.calculatedMapData.regionMin),g+o+n,m+c+i/2+a).css({fontSize:"12px"}).add();c+=i+n}}return x}function T(){var e,t,a,i=c.concat(d);h.regionsColorsForBubbles={};h.markers={};var n={x:100,y:100};if(pt()){var o,r,l=0,p,f,m=[];var g,b,v={},y={r:{},stroke:{}};for(p=h.startDateIndex;p<=h.endDateIndex;p++){e=h.dates[p].s;v[e]={};y.r[e]={};y.stroke[e]={}}h.markerDataMin=Number.MAX_VALUE;h.markerDataMax=Number.MIN_VALUE;if(s.mapsets.options.merges){for(l=0;l<s.mapsets.options.merges.length;l++){g=s.mapsets.options.merges[l];b=g.join("+");a=h.title+" for "+b;h.markers[b]={name:b,point:n,style:{fill:"pink"}};for(p=h.startDateIndex;p<=h.endDateIndex;p++){r=0;for(f=0;f<g.length;f++){r+=h.regionData[h.dates[p].s][g[f]]||0}v[h.dates[p].s][b]={r:r};if(r!==null){h.markerDataMin=Math.min(h.markerDataMin,r);h.markerDataMax=Math.max(h.markerDataMax,r)}}for(f=0;f<g.length;f++){h.regionsColorsForBubbles[g[f]]=i[l%i.length]}m=m.concat(g)}}for(o in h.regionData[h.dates[0].s]){if(m.indexOf(o)==-1&&typeof h.regionData[h.dates[0].s][o]!="undefined"){h.markers[o]={name:o,point:n,style:{fill:"pink"}};h.regionsColorsForBubbles[o]=i[l++%i.length];for(p=h.startDateIndex;p<=h.endDateIndex;p++){e=h.dates[p].s;v[e][o]={r:h.regionData[e][o]};if(v[e][o].r!==null&&!isNaN(v[e][o].r)){h.markerDataMin=Math.min(h.markerDataMin,v[e][o].r);h.markerDataMax=Math.max(h.markerDataMax,v[e][o].r)}}}}var k=(s.mapconfig.maxRadius||u)/Math.sqrt(Math.max(Math.abs(h.markerDataMax),Math.abs(h.markerDataMin)));for(e in v){for(t in v[e]){rData=v[e][t].r||null;y.r[e][t]=k*Math.sqrt(Math.abs(rData));y.stroke[e][t]=rData<0?"#ff0000":"#000000"}}h.markerData=v;h.markerAttr=y;h.radiusUnits=h.mapUnits}}function A(e){var t,a=0,i=0,n=0,o,l,d;for(var c=0;c<e.length;c++){d=null;$.each(s.mapsets.components,function(t,a){if(s.assets[a.handle].data[e[c]]&&a.handle[0]=="M"&&s.assets[a.handle].data[e[c]].latLon){d=s.assets[a.handle].data[e[c]].latLon.split(",")}});t=r.find("path[data-code="+e[c]+"]").get(0).getBBox();if(d){l=ot.latLngToPoint(d[0],d[1]);i+=(l.x-ot.transX)*t.width*t.height/ot.scale;n+=(l.y-ot.transY)*t.width*t.height/ot.scale}else{i+=(t.x+t.width/2)*t.width*t.height;n+=(t.y+t.height/2)*t.width*t.height}a+=t.width*t.height}o={x:(i/a+ot.transX)*ot.scale,y:(n/a+ot.transY)*ot.scale};return o}function I(){var e,t;if(pt()){var a,i=0,n,o=[];if(s.mapsets.options.merges){for(i=0;i<s.mapsets.options.merges.length;i++){e=A(s.mapsets.options.merges[i]);t=ot.pointToLatLng(e.x,e.y);h.markers[s.mapsets.options.merges[i].join("+")].latLng=[t.lat,t.lng];o=o.concat(s.mapsets.options.merges[i])}}r.find("path[data-code]").each(function(){a=$(this).attr("data-code");if(o.indexOf(a)==-1&&typeof h.regionData[h.dates[0].s][a]!="undefined"){e=A([a]);t=ot.pointToLatLng(e.x,e.y);h.markers[a].latLng=[t.lat,t.lng]}});ot.addMarkers(h.markers)}}}function pt(){return s.mapsets&&s.mapsets.options.mode&&s.mapsets.options.mode=="bubble"}console.timeEnd("buildGraphPanel: "+o);if(!y){sa();aa(s.ghash,f.get(0).id)}function ut(e){var t,a,i,s={},n=[],o={},r;var d={};var c={};var p={},u,h,f,m,g,b,v,y,k,w,x;var S,D;var T={};var A,I,U,P,_,E,F,N;if(e.mapsets){var O=e.mapsets;O.formula=G(O);A="return "+O.formula.formula.replace(l,"values.$1")+";";var L=new Function("values",A);I=[];P={};_=O.components;N={};var q=[];for(h=0;h<_.length;h++){F=R(h);I.push(F);if(_[h].handle[0]=="M"){for(U in e.assets[_[h].handle].data){if(!P[U]){P[U]=true;q.push({geo:U,name:e.assets[_[h].handle].geoname})}E=e.assets[_[h].handle].data[U].data.split("||");for(f=0;f<E.length;f++){m=E[f].split("|");if(!N[m[0].toString()]){N[m[0].toString()]={}}if(!N[m[0].toString()][F]){N[m[0].toString()][F]={}}N[m[0].toString()][F][U]=m[1]===null||m[1]=="null"?null:parseFloat(m[1])}}}else{E=e.assets[_[h].handle].data.split("||");for(f=0;f<E.length;f++){m=E[f].split("|");if(!N[m[0].toString()]){N[m[0].toString()]={}}N[m[0].toString()][F]=m[1]===null||m[1]=="null"?null:parseFloat(m[1])}}}var j=!O.options.componentData||O.options.componentData=="required";var z=O.options.componentData=="missingAsZero";var H=O.options.componentData=="nullsMissingAsZero";var Y=!O.options.breaks||O.options.breaks=="never";var X=O.options.breaks=="nulls";var Q=O.options.breaks=="missing";t=B(e,O);a=e.assets[_[0].handle].period;i=W(e,O);for(r in N){S=Number.MAX_VALUE;D=Number.MIN_VALUE;y=false;for(U in P){k={};x=true;w=false;for(h=0;h<I.length;h++){if(!isNaN(N[r][I[h]])){k[I[h]]=parseFloat(N[r][I[h]])}else{if(N[r][I[h]]=="null"){if(H){k[I[h]]=0}else{x=null;break}}else{if(N[r][I[h]]&&!isNaN(N[r][I[h]][U])){if(N[r][I[h]][U]=="null"){if(H){k[I[h]]=0}else{x=null;break}}else{k[I[h]]=N[r][I[h]][U];w=true}}else{if(j){x=null;break}else{k[I[h]]=0}}}}}if(w){if(x){try{x=L(k);if(Math.abs(x)==Infinity||isNaN(x))x=null}catch(Z){x=null}}if(x!==null){x=M(x);if(!c[r])c[r]={};c[r][U]=x;y=true;S=Math.min(S||x,x);D=Math.max(D||x,x)}}}if(y){s[r]={regionMin:S,regionMax:D}}else{delete c[r]}}var J=[{id:"date",width:100,field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];var K=[];var tt=O.formula.formula!="A";q.sort(function(e,t){return e.name>t.name});var at,it,st,nt=true,ot,rt=B(e,O),lt=W(e,O,false,O.formula);for(r in c){ot=C(r).getTime();st={order:ot,date:V(ot,e.assets[_[0].handle].period)};for(h=0;h<q.length;h++){for(f=0;f<I.length;f++){U=q[h].geo;at=I[f]+"_"+h;it=e.assets[_[f].handle];if(nt)J.push({id:at,field:at,name:"<b>"+(it.maps&&it.data[U]?it.data[U].name:it.name)+"</b><br>"+(it.maps&&it.data[U]?it.data[U].geoname:it.geoname||"")+"<br>"+it.units+"<br>"+it.src+"<br>"+(it.maps&&it.data[U]?it.data[U].notes:it.notes||"not available")+(tt?"<br>component "+I[f]:""),cssClass:"grid-series-column"});if(_[f].handle[0]=="M"){st[at]=N[r][I[f]][U]}else{st[at]=N[r][I[f]]}if(typeof st[at]=="undefined")st[at]="-"}if(tt){if(nt)J.push({id:U,field:U,name:"<b>"+rt+": "+q[h].name+"</b><br>"+lt+"<br><br>"+(tt?"<br>value = "+O.formula.formula:""),cssClass:"grid-calculated-column"});st[U]=typeof c[r][U]=="undefined"?"-":c[r][U]}}K.push(st);nt=false}K.sort(function(e,t){return t.order-e.order})}var dt,ct;if(e.pointsets){var pt,ut={},ht;var ft=0,mt,gt,bt;var vt=[{id:"date",field:"date",name:"name:<br>location:<br>units:<br>source:<br>notes:<br>formula:",cssClass:"grid-date-column"}];var yt=[];for(h=0;h<e.pointsets.length;h++){var kt=[];mt=e.pointsets[h];if(!mt.options.color)mt.options.color=et(e.pointsets);mt.formula=G(mt);A="return "+mt.formula.formula.replace(l,"values.$1")+";";var wt=new Function("values",A);I=[];_=mt.components;N={};for(f=0;f<_.length;f++){F=R(f);I.push(F);if(_[f].handle[0]=="X"){ht=e.assets[_[f].handle].data;for(pt in ht){if(!ut[pt]){ut[pt]=true;kt.push({latlon:pt,name:ht[pt].name})}if(o[pt]){o[pt].name+="<br>"+ht[pt].name}else{o[pt]={latLng:pt.split(","),name:ht[pt].name,style:{fill:mt.options.color}};o[pt].latLng[0]=parseFloat(o[pt].latLng[0]);o[pt].latLng[1]=parseFloat(o[pt].latLng[1])}E=ht[pt].data.split("||");for(bt=0;bt<E.length;bt++){m=E[bt].split("|");if(!N[m[0].toString()]){N[m[0].toString()]={}}if(!N[m[0].toString()][F]){N[m[0].toString()][F]={}}N[m[0].toString()][F][pt]=m[1]}}}else{E=e.assets[_[f].handle].data.split("||");for(bt=0;bt<E.length;bt++){m=E[bt].split("|");if(!N[m[0].toString()]){N[m[0].toString()]={}}N[m[0].toString()][F]=m[1]}}}var j=!mt.options.componentData||mt.options.componentData=="required";var z=mt.options.componentData=="missingAsZero";var H=mt.options.componentData=="nullsMissingAsZero";var Y=!mt.options.breaks||mt.options.breaks=="never";var X=mt.options.breaks=="nulls";var Q=mt.options.breaks=="missing";t=t+B(e,mt);a=e.assets[_[0].handle].period;if(mt.options.attribute=="fill"){dt=W(e,mt)}else{ct=W(e,mt)}for(r in N){S=Number.MAX_VALUE;D=Number.MIN_VALUE;y=false;for(pt in ut){k={};x=true;w=false;for(f=0;f<I.length;f++){if(!isNaN(N[r][I[f]])){k[I[f]]=parseFloat(N[r][I[f]])}else{if(N[r][I[f]]=="null"){if(H){k[I[f]]=0}else{x=null;break}}else{if(N[r][I[f]]&&!isNaN(N[r][I[f]][pt])){if(N[r][I[f]][pt]=="null"){if(H){k[I[f]]=0}else{x=null;break}}else{k[I[f]]=N[r][I[f]][pt];w=true}}else{if(j){x=null;break}else{k[I[f]]=0}}}}}if(w){if(x){try{x=wt(k);if(Math.abs(x)==Infinity||isNaN(x))x=null}catch(Z){x=null}}if(x!==null){x=M(x);y=true;if(!d[r])d[r]={};if(!d[r][pt])d[r][pt]={};if(mt.options.attribute=="fill"){d[r][pt].f=x;S=Math.min(S,x);D=Math.max(D,x)}else{d[r][pt].r=x;S=Math.min(S,x);D=Math.max(D,x)}}}}if(y){if(!s[r])s[r]={};if(mt.options.attribute=="fill"){s[r].markerFillMin=Math.min(s[r].markerFillMin||S,S);s[r].markerFillMax=Math.max(s[r].markerFillMax||D,D)}else{s[r].markerRadiusMin=Math.min(s[r].markerRadiusMin||S,S);s[r].markerRadiusMax=Math.max(s[r].markerRadiusMax||D,D)}}else{delete d[r]}}kt.sort(function(e,t){return e.name>t.name});var xt=mt.formula.formula!="A";var at,it,st,nt=true,ot,Ct=B(e,mt),Mt=W(e,mt,false,mt.formula);for(r in d){ot=C(r).getTime();st={id:ot,date:V(ot,e.assets[_[0].handle].period)};for(var $t=0;$t<kt.length;$t++){for(f=0;f<I.length;f++){pt=kt[$t].latlon;at=I[f]+"_"+$t;it=e.assets[_[f].handle];if(nt)vt.push({id:at,field:at,name:"<b>"+(it.coordinates&&it.data[pt]?it.data[pt].name:it.name)+"</b>"+"<br>"+(it.coordinates&&it.data[pt]?pt:it.geoname||"")+"<br>"+it.units+"<br>"+it.src+"<br>"+(it.maps&&it.data[pt]?it.data[pt].notes:it.notes||"")+(tt?"<br>component "+I[f]:""),cssClass:"grid-series-column"});
if(_[f].handle[0]=="X"){st[at]=N[r][I[f]][pt]}else{st[at]=N[r][I[f]]}if(typeof st[at]=="undefined")st[at]="-"}if(xt){if(nt)vt.push({id:pt+"-"+h,field:pt+"-"+h,name:"<b>"+Ct+": "+kt[$t].name+"</b><br>"+Mt+"<br><br>"+(tt?"<br>value = "+mt.formula.formula:""),cssClass:"grid-calculated-column"});st[pt+"-"+h]=typeof d[r][pt]=="undefined"?"-":d[r][pt]}}for(var St=false,Dt=0;Dt<yt.length;Dt++){if(yt[Dt].id==st.id){$.extend(yt[Dt],st);St=true;break}}if(!St)yt.push(st);nt=false}yt.sort(function(e,t){return t.id-e.id})}for(b in d){for(pt in ut){if(typeof d[b][pt]=="undefined")d[b][pt]={f:null,r:null}}}}for(r in s){n.push({s:r,dt:C(r),regionMin:s[r].regionMin,regionMax:s[r].regionMax,markerRadiusMin:s[r].markerRadiusMin,markerRadiusMax:s[r].markerRadiusMax,markerFillMin:s[r].markerFillMin,markerFillMax:s[r].markerFillMax})}n.sort(function(e,t){return e.dt-t.dt});e.calculatedMapData={title:t,period:a,mapUnits:i,markers:o,markerData:d,dates:n,regionData:c,regionGrid:{columns:J,data:K},markerGrid:{columns:vt,data:yt},fillUnits:dt,radiusUnits:ct};return e.calculatedMapData}function ht(e){var t,i,s,n,o,r={},l,d,c=e.calculatedMapData;c.regionMin=Number.MAX_VALUE;c.regionMax=Number.MIN_VALUE;c.startDateIndex=c.dates.length-1;c.endDateIndex=0;for(t=0;t<c.dates.length;t++){if((!e.start||parseInt(e.start)<=c.dates[t].dt.getTime())&&(!e.end||parseInt(e.end)>=c.dates[t].dt.getTime())){if(c.startDateIndex>t)c.startDateIndex=t;if(c.endDateIndex<t)c.endDateIndex=t;if(e.mapsets){c.regionMin=Math.min(c.dates[t].regionMin,c.regionMin);c.regionMax=Math.max(c.regionMax,c.dates[t].regionMax)}}}var h,f,m,g;if(e.mapsets){var b={};g=e.mapsets.options;f=!g.scale||g.scale=="continuous";l=c.regionMin;d=c.regionMax;m=l<0&&d>0;c.regionColors={};if(f){h={pos:O(g.posColor||p.POS),neg:O(g.negColor||p.NEG),mid:O(p.MID)};var v=new RGBColour(h.pos.r,h.pos.b,h.pos.g);var y=v.getHSV();var k=new HSVColour(y.h,m?10:20,m?90:100);var w=k.getIntegerRGB();h.posMid={r:w.r,g:w.g,b:w.b};var x=new RGBColour(h.neg.r,h.neg.b,h.neg.g);var C=x.getHSV();var M=new HSVColour(C.h,m?10:20,m?90:100);var $=M.getIntegerRGB();h.negMid={r:$.r,g:$.g,b:$.b}}for(t=c.startDateIndex;t<=c.endDateIndex;t++){n=c.dates[t].s;c.regionColors[n]={};if(c.regionData[n]){for(o in c.regionData[n]){r[o]=true;i=c.regionData[n][o];if(!isNaN(i)&&i!==null){i=parseFloat(i);if(f){if(i==0){c.regionColors[n][o]=p.MID}else{c.regionColors[n][o]=L(i,i<0?l:m?0:l,i>0?d:m?0:d,i<0?h.neg:h.posMid,i<0?h.negMid:h.pos,g.logMode=="on"&&!m&&l!=0&&d!=0)}}else{for(j=0;j<g.discreteColors.length;j++){if(j!=g.discreteColors.length-1&&i<=parseFloat(g.discreteColors[j].cutoff)||j==g.discreteColors.length-1){c.regionColors[n][o]=g.discreteColors[j].color;break}}}}else{c.regionColors[n][o]="#ffffff"}}}else{for(s in c.regionData){for(o in c.regionData[s]){c.regionColors[n][o]="#ffffff"}break}}}for(n in c.regionColors){for(o in r){if(typeof c.regionColors[n][o]=="undefined"){c.regionColors[n][o]="#ffffff"}}}}if(e.pointsets){g=e.mapconfig;f=!g.scale||g.scale=="continuous";if(f){}var S=Number.MAX_VALUE,D=Number.MIN_VALUE;var T=Number.MAX_VALUE,A=Number.MIN_VALUE;for(t=c.startDateIndex;t<=c.endDateIndex;t++){if(c.dates[t].markerRadiusMin){T=Math.min(c.dates[t].markerRadiusMin,T);A=Math.max(c.dates[t].markerRadiusMax,A)}if(c.dates[t].markerFillMin){S=Math.min(c.dates[t].markerFillMin,S);D=Math.max(c.dates[t].markerFillMax,D)}}var I;var U=T!=Number.MAX_VALUE;if(U){I=Math.max(Math.abs(T),Math.abs(A));c.radiusScale=I}var P=S!=Number.MAX_VALUE;if(P){c.markerFillMinValue=S;c.markerFillMaxValue=D;f=P&&(!e.mapconfig.scale||g.scale=="continuous");m=S<0&&D>0;if(f){h={pos:O(g.posColor||p.POS),neg:O(g.negColor||p.NEG),posMid:{},negMid:{},mid:O(p.MID)};var v=new RGBColour(h.pos.r,h.pos.b,h.pos.g);var y=v.getHSV();var k=new HSVColour(y.h,m?10:20,m?90:100);var w=k.getIntegerRGB();h.posMid={r:w.r,g:w.g,b:w.b};var x=new RGBColour(h.neg.r,h.neg.b,h.neg.g);var C=x.getHSV();var M=new HSVColour(C.h,m?10:20,m?90:100);var $=M.getIntegerRGB();h.negMid={r:$.r,g:$.g,b:$.b}}}var _,E,F,N={r:{},fill:{},stroke:{}};for(n in c.markerData){N.r[n]={};N.fill[n]={};N.stroke[n]={};for(_ in c.markers){if(U){F=c.markerData[n][_].r||null;if(F<0){N.stroke[n][_]="#ff0000";F=Math.abs(F)}else{N.stroke[n][_]="#000000"}N.r[n][_]=(e.mapconfig.maxRadius||u)*Math.sqrt(F)/Math.sqrt(I)}if(P){E=c.markerData[n][_].f||null;if(isNaN(E)||E===null){N.fill[n][_]="#ffffff"}else{if(f){if(m){N.fill[n][_]=L(E,E<0?S:m?0:S,E>0?D:m?0:D,E<0?h.neg:h.posMid,E<0?h.negMid:h.pos)}else{N.fill[n][_]=L(E,E<0?S:m?0:S,E>0?D:m?0:D,E<0?h.neg:h.mid,E<0?h.mid:h.pos)}}else{for(j=0;j<e.mapconfig.discreteColors;j++){if(j==0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<=E||j!=0&&parseFloat(e.mapconfig.discreteColors[j].cutoff)<E){N.fill[n][_]=e.mapconfig.discreteColors[j].color}else break}}}}else{}}}c.markerAttr=N}function O(e){if(e.substr(0,1)=="#")e=e.substr(1);var t,a,i;t=parseInt(e.substr(0,2),16);a=parseInt(e.substr(2,2),16);i=parseInt(e.substr(4,2),16);return{r:t,g:a,b:i}}function L(e,t,i,s,n,o){var r,l,d,c,p,u,h,f=a.common.octet;if(o){c=Math.log(Math.abs(e));p=Math.log(Math.min(Math.abs(t),Math.abs(i)));u=Math.log(Math.max(Math.abs(t),Math.abs(i)));h=(c-p)/(u-p)}else{h=(e-t)/(i-t)}r=f(Math.round(h*(n.r-s.r)+s.r));l=f(Math.round(h*(n.g-s.g)+s.g));d=f(Math.round(h*(n.b-s.b)+s.b));return"#"+r+l+d}}function ft(e,t){while(t.length>=4){if(e[t])return e[t];t=t.substr(0,t.length-2)}return false}}},isSummationMap:function wt(e){if(!e.mapsets)return false;if(!e.mapsets.options.calculatedFormula)G(e.mapsets);var t=e.mapsets.options.calculatedFormula;for(var a=0;a<e.mapsets.components.length;a++){if(e.mapsets.components[a].handle[0]!="M")return false}return/[-+]/.test(t.numFormula)&&!/[*/]/.test(t.numFormula)},plotName:function xt(e,t,a){var i,s,n,o="";if(typeof t.options.name!="undefined"&&t.options.name!=""&&!a){return t.options.name}else{var r=false;for(n=0;n<t.components.length;n++){s=t.components[n];i=s.handle;o+=(n!=0&&s.options.op?s.options.dn=="d"&&!r?" / ":" "+s.options.op+" ":" ")+e.assets[i].name;r=s.options.dn=="d"||r}return o}},plotUnits:function Ct(e,t,a,i){var s,n,o,r="",l="";if(t.components.length==1){return t.options.units||(t.components[0].op=="/"?"per ":"")+(e.assets[t.components[0].handle].units||"")}if(!t.options.units||a){if(!i)i=G(t);var d=i.numFormula;var c=i.denomFormula;y("^(-)?(1)?","");var p=/[0-9]+/g;var u=p.test(d)||p.test(c);d=d.replace(p," ");c=c.replace(p," ");var h=/(\*|\(|\))/g;d=d.replace(h," ");c=c.replace(h," ");var f=/\//g;d=d.replace(f," per ");c=c.replace(f," per ");var m=/-/g;d=d.replace(m,"+");c=c.replace(m,"+");var g=/[\s]+/g;d=d.replace(g," ");c=c.replace(g," ");y("([A-Z]+)","{{$1}}");var b=/\+/g;for(s=0;s<t.components.length;s++){y("{{"+R(s)+"}}",(e.assets[t.components[s].handle].units||"").replace(b," "))}var v=false;if(d!=""){o=d.split("+");d=o[0].trim();for(n=1;n<o.length;n++){if(o[n].trim()!=d)v=true}}if(c!=""){o=c.split("+");l=o[0].trim();for(n=1;n<o.length;n++){if(o[n].trim()!=o[0])v=true}}if(v){return"potentially mismatched units"}else{if(d==l&&d.length>0){return"ratio"}else{return(u?"user scaled ":"")+d+(l==""?"":" per "+l)}}}else{return t.options.units}function y(e,t){var a=new RegExp(e,"g");d=d.replace(a,t);l=l.replace(a,t)}},visiblePanelId:function Mt(){var e=$("div.graph-panel:visible");if(e.length==1){return e.get(0).id}else{return null}},formatDateByPeriod:function $t(e,t){if(isNaN(e)==false&&e!==null){var a=new Date(parseInt(e));switch(t){case"A":return a.getUTCFullYear();case"Q":return"Q"+parseInt((a.getUTCMonth()+3)/3)+" "+a.getUTCFullYear();case"SA":case"M":return o[a.getUTCMonth()]+" "+a.getUTCFullYear();case"W":case"D":return a.getUTCDate()+" "+o[a.getUTCMonth()]+" "+a.getUTCFullYear();default:return a.toUTCString().substr(5,20)}}else{return"-"}},eachComponent:function St(e,t){X(e,function(){var e=this;$.each(e.components,function(a){t.call(this,a,e)})})},eachPlot:function Dt(e,t){if(e.mapsets)t.call(e.mapsets);if(e.pointsets)$.each(e.pointsets,function(a){t.call(this,a,e.pointsets[a])});if(e.plots)$.each(e.plots,function(a){t.call(this,a,e.plots[a])})},fillScalingCount:function At(e){var t=0;if(e instanceof Array){t=e.length-Z(e)}return t},areaScalingCount:function It(e){var t=0;if(e instanceof Array){$.each(e,function(){if(this.options.attribute!="fill")t++})}return t}};var T=D.chartPanel,A=D.intervalStartDt,I=D.setCropSlider,C=D.dateFromMdDate,U=D.closestDate,P=D.assetNeeded,_=D.getAssets,E=D.fetchAssets,F=D.createMyGraph,N=D.emptyGraph,O=D.makeChartOptionsObject,L=D.createSerieFromPlot,G=D.plotFormula,R=D.compSymbol,q=D.buildGraphPanel,z=D.isSummationMap,B=D.plotName,W=D.plotUnits,H=D.visiblePanelId,V=D.formatDateByPeriod,Y=D.eachComponent,X=D.eachPlot,Q=D.fillScalingCount,Z=D.areaScalingCount;var J={template:'<div id="dwrap2">'+'<div id="titleEditor" style="width: 560px">'+'<input type="text" width="300px" name="title" /> '+'<button id="graph-title-change-ok">OK</button> '+'<button id="graph-title-change-cancel">cancel</button>'+"</div>"+"</div>",show:function(e,t){var a=this;$.fancybox(this.template,{width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none",left:"55px",top:"55px"});$("#fancybox-wrap").stop().css({top:"70px"});$("#graph-title-change-ok").click(a.changeOk);$("#graph-title-change-cancel").click(a.changeCancel);var i=$(e).closest("div.graph-panel").get(0).id;$("#titleEditor input").keyup(function(e){if(e.keyCode==13)a.changeOk()}).attr("data",i).val(n[i].title).css("width","450px").focus();this.callback=t},callBack:false,changeOk:function(){var e=$("#titleEditor input").attr("data");var t=$("#titleEditor input").val().trim();var a=n[e];if(t!=a.title){a.title=t||"untitled";if(a.plots){if(a.title.length==0){a.controls.chart.setTitle({text:"untitled - click to edit",style:{color:"grey",font:"italic"}})}else{a.controls.chart.setTitle({text:a.title,style:{color:"black",font:"normal"}})}$("#"+e+" .highcharts-title").click(function(){J.show(this)})}var i=t||"Graph "+e.substr(e.indexOf("-")+1);$("#graph-tabs a[href='#"+e+"']").attr("title",i).html(i);$("#"+e+" h3.mashabledata_map-title").html(a.title);if(a.title.length==0){if(this.callback)this.callback()}}this.changeCancel()},changeCancel:function(){$.fancybox.close();this.callBack=false}};return D;function K(e){e.smallestPeriod="A";e.largestPeriod="N";var t,a,i,s,n;Y(e,function(){if(!e.assets[this.handle].firstdt&&(this.handle.charAt(0)=="M"||this.handle.charAt(0)=="X")){for(s in e.assets[this.handle].data){i=e.assets[this.handle].data[s].firstdt;e.assets[this.handle].firstdt=Math.min(e.assets[this.handle].firstdt,i)||i;i=e.assets[this.handle].data[s].lastdt;e.assets[this.handle].lastdt=Math.max(e.assets[this.handle].lastdt,i)||i}}i=e.assets[this.handle].firstdt;t=Math.min(i,t)||i||t;i=e.assets[this.handle].lastdt;a=Math.max(i,a)||i||t});if(e.plots){$.each(e.plots,function(){var t=this.options.fdown||e.assets[this.components[0].handle].period;if(r.value[e.smallestPeriod]>r.value[t])e.smallestPeriod=t;if(r.value[e.largestPeriod]<r.value[t])e.largestPeriod=t})}e.firstdt=t;e.lastdt=a;e.minZoom=e.start||e.firstdt;e.maxZoom=e.end||e.lastdt}function et(e){var t=[];$.each(e,function(){if(this.options&&this.options.color)t.push(this.options.color)});var a=d.concat(c);for(var i=0;i<a.length;i++){if(t.indexOf(a[i])==-1)return a[i]}return a[e.length%a.length]}function tt(e){var t=Math.floor(Math.log(Math.abs(e))/Math.LN10);var a=Math.round(e/Math.pow(10,t-2))*Math.pow(10,t-2);return Highcharts.numberFormat(a,t>1?0:2-t)}function at(e,t,a,i){if(typeof i=="undefined")i="new";var s,n,o,r,l=e.mapconfig.cubeid;if(!e.assets.cube)e.assets.cube={};var d=e.assets.cube;if(!d["G"+t]){var c=e.controls.$thisPanel.find("div.mashabledata_cube-viz");c.mask("loading...");S({command:"GetCubeSeries",ghash:e.ghash||"",cubeid:l,geokey:t,modal:"none"},function(e,a,i){d["G"+t]={series:e.series};d.dimensions=e.dimensions;d.theme=e.theme;d.name=e.name;d.units=e.units;c.unmask();p()})}else{p()}function p(){var l=d.dimensions;var c=l.length;var p=null;if(isNaN(t)){Y(e,function(){if(!p){if(this.handle[0]=="M"&&e.assets[this.handle].data[t])p=e.assets[this.handle].data[t].geoname}})}else{p=e.map}var u=d["G"+t];if(u.series){var h=u.series;u.facetedData=[];function f(e,t,a){var i,s;for(i=0;i<l[e].list.length;i++){if(e==c-1){s=a.slice();s.push(l[e].list[i]);t.push(o(s))}else{var n=[];t.push(n);s=a.slice();s.push(l[e].list[i]);f(e+1,n,s)}}function o(e){var t,a,i;for(t=0;t<h.length;t++){a=true;i=h[t];for(var s=0;s<c;s++){if(i.name.toLowerCase().indexOf(" "+e[s].name.toLowerCase())===-1){a=false;break}}if(a){h.splice(t,1);return i.data}}return null}}f(0,u.facetedData,[]);delete u.series}var m={chart:{type:"bar",spacingRight:50,renderTo:e.controls.$thisPanel.find(".mashabledata_cube-viz")[0]},title:{text:d.theme+"<br>"+(p||""),style:{fontSize:"12px"}},subtitle:{text:"click on map to select location",style:{fontSize:"10px"},y:p?50:30},plotOptions:{bar:{dataLabels:{enabled:false,align:"left"},borderWidth:0,animation:false,stacking:null}},xAxis:{categories:[],title:{text:null},lineWidth:1,minorGridLineWidth:0,labels:{enabled:true},minorTickLength:0,tickLength:0},yAxis:{title:{text:d.units||""},labels:{enabled:false},lineWidth:0,minorGridLineWidth:0,lineColor:"transparent",gridLineColor:"transparent",gridLineWidth:0},credits:{href:"http://www.mashabledata.com",text:"created with MashableData.com"},exporting:{enabled:false,type:"image/png",url:"https://www.mashabledata.com/workbench/export/index.php"},legend:{floating:false,borderWidth:0,y:-5},series:[],tooltip:{formatter:function(){return"<b>"+d.theme+"</b><br/>"+this.point.name+":<br/>"+Highcharts.numberFormat(Math.abs(this.point.y),0)+" "+d.units}}};var g=u.facetedData;var b,v;switch(c){case 1:barData=[];for(n=0;n<l[0].list.length;n++){b={y:it(g[n],a),name:l[0].list[n].name};if(l[0].list[n].color)b.color=l[0].list[n].color;barData.push(b);m.xAxis.categories.push(l[0].list[n].short||l[0].list[n].name)}m.series.push({id:t,name:p,data:barData,showInLegend:false});m.plotOptions.bar.dataLabels.enabled=true;break;case 2:for(n=0;n<l[0].list.length;n++){barData=[];for(o=0;o<l[1].list.length;o++){if(n==0)m.xAxis.categories.push(l[1].list[o].short||l[1].list[o].name);b={y:it(g[n][o],a),name:l[0].list[n].name+"<br>and "+l[1].list[o].name};barData.push(b)}s={name:l[0].list[n].name,data:barData};if(l[0].list[n].color)s.color=l[0].list[n].color;m.series.push(s);m.plotOptions.bar.stacking="normal"}break;case 3:for(n=0;n<l[0].list.length;n++){for(r=0;r<l[2].list.length;r++){barData=[];for(o=0;o<l[1].list.length;o++){if(n==0&&r==0)m.xAxis.categories.push(l[1].list[o].short||l[1].list[o].name);b={y:(n==0?-1:1)*it(g[n][o][r],a),name:l[0].list[n].name+"<br>and "+l[1].list[o].name+"<br>and "+l[2].list[r].name};barData.push(b)}s={name:l[2].list[r].name,data:barData};if(l[2].list[r].color)s.color=l[2].list[r].color;m.series.push(s)}}m.legend.enabled=false;m.plotOptions.bar.stacking="normal";m.xAxis.lineWidth=0;break}switch(i){case"add":m.series[0].showInLegend=true;e.controls.vizChart.addSeries(m.series[0]);break;case"remove":e.controls.vizChart.get(t).remove(false);break;case"summation":m.series[0].pointWidth=1;m.series[0].pointPadding=0;m.plotOptions.bar.groupPadding=0;default:if(e.controls.vizChart)e.controls.vizChart.destroy();e.controls.vizChart=new Highcharts.Chart(m)}}}function it(e,t){if(!e)return null;var a,i=e.split("||");for(var s=0;s<i.length;s++){a=i[s].split("|");if(a[0]==t){if(a[1]=="null")return null;else return parseFloat(a[1])}}return null}}();account={info:{username:null,userid:null,auth:null,email:null,fbemail:null,fbid:null,admin:null,ccName:null,ccadresss:null,cccity:null,ccstateprov:null,ccpostal:null,cccountry:null,ccType:null,ccLast4:null,ccExpMMYY:null,subscription:null,expire:null,orgid:null,organization:null,accesstoken:null,md:null},htmls:{subscription:'<div id="account-screen">'+"<h2>Account Management</h2>"+'<div class="account-auth">'+'<input type="radio" name="auth" id="authfb" value="fb" /><label for="authfb"><strong>use Facebook to authenticate me.</strong>  You don\'t have to remember another password.  Everybody wins!</label><br />'+'<input type="radio" name="auth" id="authmd" value="md" /><label for="authmd"><strong>create a separate MashableData password.</strong>  Your personal information will be hashed or encrypted.</label>'+"</div>"+"<h3>Basic information:</h3>"+'<span class="over">display name:</span><input class="req uname medium" data="user name" type="text" /><br />'+'<span class="over">main email:</span><input class="req email medium" data="email" type="text" /><br />'+'<div class="account-pwd hidden blue-inset">'+'<span class="over">MashableData password:</span><input class="req medium pwd" data="pwd" type="password" /><br />'+'<span class="over">confirm password:</span><input class="req medium pwdConfirm" data="pwdConfirm" type="password" />'+"</div>"+"<div>"+"<h3>Subscription type:</h3>"+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-trial" value="T" /><strong>free trial</strong> <em>Access to all features for a limited number of requests.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-ind" value="I" /><strong>individual</strong> <em>Unlimited graphs, custom series, searches and downloads for US$10 every 6 months.</em></label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-member" value="C" /><strong>join my organization\'s corporate account</strong> </label><br />'+'<label><input type="radio" name="account-level" class="account-level" id="account-lvl-admin" value="A" /><strong>create a corporate account</strong> <em>Members will get unlimited usage plus confidential sharing of data and visualizations amoung members.  All billing and membership will be managed through this account, so only a single credit card is required.  Select this option to create and administer a new corporate account.</em></label><br />'+'<div class="validation blue-inset hidden">'+'Email validation code (required): <input class="req valcode" data="valcode" type="text" /><br />'+"<em>You email validation code is in an email sent moments ago from admin@mashabledata.com.</em>"+"</div>"+'<div class="regcode blue-inset hidden">'+'Registration code (required): <input class="req regcode" data="regcode" type="text" /><br />'+"<em>Your code is included in your invitation email sent by your organization's administrator.</em>"+"</div>"+'<div class="joinmode blue-inset hidden">'+'Company / organization name: <input data="orgName" id="account-org-name" class="long" /><br />'+"How will users join your organization?<br />"+'<label><input type="radio" name="account-join" id="account-inviteonly" value="inviteonly" /><strong>by invitation only</strong></label><br />'+'<label><input type="radio" name="account-join" id="account-emailorinvite" value="emailorinvite" /><strong>by invitation OR anyone able to receive email through an @<span class="italics account-main-email-domain"></span> account</strong></label>'+"<br /><br />"+"<em>You will be able to add email addresses of new members via the administration panel after your credit card is accepted. MashableData will then email an invitation with a unique registration code and instructions to each new member.</em><br />"+"</div>"+"</div>"+'<h3 class="payments hidden">Payment method:</h3>'+'<div class="payments hidden">'+'<span class="llabel">credit card number:</span><input class="cardNum" data="ccnum" type="text" />'+'<span class="mlabel">CCV:</span><input class="cardCCV tiny" data="ccv" data="optional" type="text" />'+'<span class="right"><span class="mlabel">Expiration:</span>'+'<select class="cardMonth"><option val="1">Jan</option><option val="2">Feb</option><option val="3">Mar</option><option val="4">Apr</option><option val="5">May</option><option val="6">Jun</option><option val="7">Jul</option><option val="8">Aug</option><option val="9">Sep</option><option val="10">Oct</option><option val="11">Nov</option><option val="12">Dec</option></select>'+'<select class="cardYear"></select></span>'+'<br /><span class="llabel">name on card:</span><input type="text" data="ccname" class="cardName medium" /><br />'+'<span class="llabel">address:</span><input type="text" data="ccaddress" class="cardAddress long" /><br />'+'<span class="llabel">city:</span><input type="text" data="cccity" class="cardCity medium" /><span class="cardStateProv mlabel">state:</span><input type="text" data="ccstateprov" class="cardStateProv short" /><span class="cardPostal mlabel">ZIP code:</span><input type="text" class="cardPostal tiny" data="ccpostal"  /><span class="mlabel">country:</span><select class="cardCountry"></select>'+"</div>"+'<button class="ok">ok</button> <button class="cancel">cancel</button>'+"</div>",signIn:'<div id="signin-md">Email:<br><input id="signin-email"><br>Password:<br><input id="signin-pwd"><br><button id="signin-signin">Sign in</button> <input id="signin-stay" type="checkbox" /> stay signed in<br><br>New to MashableData? Create an <a id="create-account" href="javascript:void(0)">account</a></div> '+'<div id="signin-or">~ OR ~</div>'+'<div id="signin-fb"> <fb:login-button></fb:login-button><br /><br />Use your FaceBook account to log in.<br /><br />(No spam or posting without your consent.  We promise and Facebook enforces our promise.)</div>'+'<div style="text-align: center;"><a id="license-link" href="license.html">MashableData Workbench Term of Service</a></div>',signedIn:'<div id="signedin-md"><button id="signedin-signout">Sign out</button><br><br><a id="signedin-subscribe" href="javascript:void(0);">Account &amp; Subscription</a><span id="signedin-admin" style="display:none;"><br><br><a href="admin_users.php" target="_blank">User Management & Billing</a> (Administrator only)</span></div>',verify:'<div id="verify-email">The following email needs verification.  Please enter the verification code emailed to the following email account:  <span class="email"></span><br />'+'<br /><input class="email" type="test" /> <br /><button class="verify">Verify</button> <button class="cancel">Cancel</button> <button class="cancel">Send New Verifcation Code</button></div>'},showPanel:function(e,t){$.fancybox(e,{showCloseButton:false,autoScale:true,overlayOpacity:t?0:.5,hideOnOverlayClick:t?true:false});var a=$("#fancybox-wrap");if(t){var i=t.offset();a.css({top:parseInt(i.top+t.height()-15)+"px",left:parseInt(i.left-a.width()-18+t.width())+"px"})}return a},showSignInOut:function(){var e=$("#menu-account");if(this.loggedIn()){account.showPanel(account.htmls.signedIn,e);if(account.info.subscription==="A")$("#signedin-admin").show();$("#signedin-signout").button().addClass("ui-state-error").click(function(){account.signOut()})}else{account.showPanel(account.htmls.signIn,e);$("#license-link").fancybox();FB.XFBML.parse(document.getElementById("signin-fb"))}$("#create-account,#signedin-subscribe").click(function(){account.showSubscribe()})},showSubscribe:function(){var e=account.showPanel(account.htmls.subscription);var t=$("#account-screen"),a="",i="";var s=false;var n=false;var o;account.subscribing=true;t.find("[data]").each(function(){o=$(this).attr("data");$(this).val(account.info[o])});t.find("input.account-level[value='"+(account.info.subscription||"T")+"']").click();if(account.info.subscription=="C"||account.info.subscription=="A"){t.find("input.account-level").attr("disabled",true);t.find("div.validation").html("You are a member of the corporate account of "+account.info.orgName+".<br><br>This account can only be changed or cancelled in the "+(account.info.subscription=="A"?'<a href="admin_users.php" target="_blank">':"")+"account administrator's panel"+(account.info.subscription=="A"?"</>":"")+".").show()}t.find("input.email").val(account.info.email).change(function(){if(account.isValidEmail(this.value)){$(".account-main-email-domain").html(this.value.split("@")[1].trim());C({command:"CheckEmailForOrgInv",email:this.value.trim(),modal:"none"},function(e,t,a){n=e.invited;s=e.eligible;if(e.invited){vt("Corporate membership found","Our records show that a registration code to join the corporate account of "+e.orgname+" was originally sent to "+this.value+" on "+e.date+". The registration email was just resent.  Please copy the registration code from either email into the form to complete your registration.");$("#account-lvl-member").click()}if(e.eligible){vt("Corporate membership found",'Based on your email, you are eligible to join the corporate account of "'+e.orgname+'".  However, you must first validate your email address.  A registration code was just sent to '+this.value+". Please copy the validation code from the email into the registration form to complete your registration.");$("#account-lvl-member").click()}});if(!account.loggedIn()||this.value!=account.info.email){account.sendVerificationCode(this.value.trim())}}else{$(".account-main-email-domain").html("*no domain detected*")}}).change();t.find("input.uname").val(account.info.name);t.find("span.account-main-email").html(account.info.email);t.find("button.cancel").button({icons:{secondary:"ui-icon-closethick"}}).click(function(){account.subscribing=false;$.fancybox.close()});if(this.loggedIn()){t.find("#"+(account.info.authmode=="Facebook"?"authfb":"authmd")).attr("checked",true);t.find(".email").attr("disabled",true);t.find("input:radio[name='auth']").attr("disabled",true)}C({command:"CardSelects",modal:"none"},function(e,a,i){var s,n=t.find("select.cardYear"),o=t.find("select.cardCountry");for(s=0;s<e.countries.length;s++){o.append("<option>"+e.countries[s].name+"</option>")}o.val(account.info.ccountry||"United States");for(s=0;s<e.years.length;s++){n.append("<option>"+e.years[s]+"</option>")}if(account.info.ccexpiration){var r=account.info.ccexpiration.split("/");if(r.length==2){n.val(r[1]);t.find(".cardMonth").val(r[0])}}});t.find("input:radio[name=auth]").click(function(){if(this.id=="authmd"){t.find(".email").removeAttr("disabled");t.find("div.account-pwd").slideDown();r()}else{t.find("div.account-pwd").slideUp();if(account.loggedIn()&&account.info.authmode=="Facebook"){t.find(".email").attr("disabled",true)}else{account.loginout()}}});t.find("input:radio[name=account-level]").click(function(){if(this.id=="account-lvl-admin"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp();if(this.id=="account-lvl-admin"||this.id=="account-lvl-ind"){t.find(".payments").slideDown();r()}else t.find(".payments").slideUp();if(this.id=="account-lvl-member"){if(s){t.find("div.valcode").slideDown()}else{t.find("div.regcode").slideDown()}if(!n&&!s){vt("No corporate account available","Our records do not show a corporate membership available to the email entered above.  Please contact the administrator of your organization's MashableData account to be added.")}r()}else{t.find("div.regcode,div.valcode").slideUp()}});t.find("input:radio[name=account-auth]").click(function(){if(this.id=="account-org-create"){t.find("div.joinmode").slideDown();r()}else t.find("div.joinmode").slideUp()});t.find("button.ok").button({icons:{secondary:"ui-icon-check"}}).click(function(){var e="";if(t.find("input.uname").val().trim().length<5)e+="<li>Your display name must be least 5 characters</li>";if(!account.isValidEmail(t.find("input.email").val().trim()))e+="<li>Your main email is not a valid email address</li>";if(!t.find("input[name=auth]:checked"))e+="<li>Please indicate how you wish to be authenticated</li>";if(t.find("input[name=auth]:checked").val()=="md"&&(t.find(".pwd").val().trim().length<8||t.find(".pwd").val().trim()!=t.find(".pwdConfirm").val().trim())){e+="<li>Your passwords must match and be at 8 characters long</li>";t.find(".pwd").val("");t.find(".pwdConfirm").val("")}var a=t.find("input[name=account-level]:checked").val();if(!a)e+="<li>You must select a subscription level</li>";if(a=="admin"&&!t.find("input[name=account-join]:checked").val())e+="<li>You must indicate how users will be allowed to join your organization.</li>";if(a=="admin"||a=="indiv"){}if(e.length>0){vt("Invalid responses","The following problems were detected:<br><ol>"+e+"</ol>Please correct these issues and resubmit.")}else{var i={command:"Subscribe",name:t.find("input.uname").val().trim(),email:t.find("input.email").val().trim(),auth:t.find("input[name=auth]:checked").val(),pwd:t.find("input.pwd").val().trim(),fbemail:t.find("input[name=account-fb]:checked").val()=="fbdiff"?t.find("input#account-fbemail").val().trim():t.find("input.email").val().trim(),twitemail:t.find("input[name=account-twit]:checked").val()=="twitdiff"?t.find("input#account-twitemail").val().trim():t.find("input.email").val().trim(),accountLevel:a,regCode:t.find("input.regcode").val(),accountJoinMode:t.find("input[name=account-join]:checked").val(),cardNum:t.find("input.cardNum").val(),cardMonth:t.find("input.cardMonth").val(),cardYear:t.find("input.cardYear").val(),cardCCV:t.find("input.cardCCV").val(),cardName:t.find("input.cardName").val(),cardAddress:t.find("input.cardAddress").val(),cardCity:t.find("input.cardCity").val(),cardStateProv:t.find("input.cardStateProv").val(),cardPostal:t.find("input.cardPostal").val(),cardCountry:t.find("input.cardCountry").val()};C(i,function(e,t,a){if(e.status=="OK"){$.fancybox().close();account.info.name=i.name;account.info.email=i.email;account.info.fbemail=i.fbemail}vt("Account and subscription managment",oRetrun.msg)})}});function r(){e.animate({top:50})}},isValidEmail:function(e){return e.split("@").length==2&&e.split("@")[1].split(".").length>0&&!/[\s]/.test(e)},showVerify:function(e){account.showPanel(account.htmls.verify);var t=$("#verify-email");t.find("span.email").html(e);t.find(".cancel").button({icons:{secondary:"ui-icon-closethick"}}).addClass("ui-state-error").click(function(){account.showSubscribe()});t.find(".cancel").button({icons:{secondary:"ui-icon-check"}}).click(function(){account.verified(e,t.find("input.email").val())})},signIn:function(e,t,a){},signInFB:function(e){if(e.authResponse){account.info.authmode="Facebook";var t=e.authResponse.accessToken;expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){account.info.fbid=e.id;account.fb_user=e;account.fb_user.accessToken=t;account.info.accesstoken=t;account.info.name=e.name;account.info.email=e.email;qt()});$.fancybox.close()}},subscribe:function(e,t){},signOut:function(){FB.logout(function(e){localStorage.removeItem("token");localStorage.removeItem("mdtoken");window.location.reload()})},loginout:function(){if(account.loggedIn()){account.signOut()}else{FB.login(function(e){if(e.authResponse){loggedIn="facebook";accessToken=e.authResponse.accessToken;localStorage.setItem("fbtoken",accessToken);expiresIn=e.authResponse.expiresIn;FB.api("/me",function(e){fb_user=e;qt()})}})}},loggedIn:function(){return this.info.userId!=null},sendVerificationCode:function(e){C({command:"EmailVerify",email:e,verification:"x"},function(t,a,i){vt("email verification code","A verification code was sent to "+e+".  Please check this email account and enter the code where directed. ")})}};function t(t){var a,i,s=e,n=s.globals,o=s.grapher;var r=n.dashStyles,l=n.DEFAULT_RADIUS_FIXED,p=n.DEFAULT_RADIUS_SCALE,u=n.hcColors,h=n.period,f=n.op,m=n.MAP_COLORS,g=o.plotName,b=o.plotUnits,v=o.plotFormula,y=o.fillScalingCount,k=o.eachComponent;var x={HTML:{compMath:'<div class="edit-block">'+'<div class="edit-math">'+'<input type="radio" id="required-'+t+'" name="comp-math-'+t+'" data="compMath"  value="required"/><label for="required-'+t+'">all values required else null</label>'+'<input type="radio" id="missingAsZero-'+t+'" name="comp-math-'+t+'" data="compMath"  value="missingAsZero"/><label for="missingAsZero-'+t+'">use zero for missing values</label>'+'<input type="radio" id="nullsMissingAsZero-'+t+'" name="comp-math-'+t+'" data="compMath" value="nullsMissingAsZero"/><label for="nullsMissingAsZero-'+t+'">use zero for missing and null values</label>'+"</div>"+"</div>"},graph:n.panelGraphs[t],$prov:$("#"+t+" .provenance"),isDirty:false,build:function T(e){var t=this;
var s,n,o,r,l,d;t.$prov.show();d='<button class="config-cancel">cancel edits</button>';o="";if(typeof e!="undefined"){if(t.$prov.find(".chart-plots").length==0)t.$prov.find(".config-cancel").after('<div class="chart-plots"><H4>Chart</H4><ol class="plots"></ol></div');t.$prov.find("ol.plots").append(t.plotHTML(e))}else{if(t.graph.plots)t.plotsEdits=$.extend(true,[],t.graph.plots);t.annoEdits=$.extend(true,[],t.graph.annotations);if(t.graph.mapsets)t.mapsetEdits=$.extend(true,{},t.graph.mapsets);if(t.graph.pointsets)t.pointsetsEdits=$.extend(true,[],t.graph.pointsets);t.mapconfigEdits=$.extend(true,{},t.graph.mapconfig);if(t.plotsEdits){o='<div class="chart-plots"><H4>Chart</H4><ol class="plots">';for(s=0;s<t.plotsEdits.length;s++){o+=t.plotHTML(s)}}o+="</ol>"+'<ol class="blank-plot landing components" style=""><li class="not-sortable">Drag and drop to plot lines to reorder them.  Drag and drop multiple series into a plot to create sums and ratios. Drag a series here to create a new plot line.</i></li></ol></div>';r=t.provenanceOfMap();t.$prov.html(d+o+r);if(t.mapsetEdits)a=this.legendEditor(t.$prov.find(".mapset-colors"),this.mapsetEdits.options,"M");if(t.pointsetsEdits){i=this.legendEditor(t.$prov.find(".pointsets-colors"),this.mapconfigEdits,"X");if(t.mapconfigEdits.markerScaling)t.$prov.find("div.pointsets div.color-scale").slideDown()}t.$prov.find("select.cubeSelector").change(function(){t.set(t.mapconfigEdits,$(this));delete t.graph.assets.cube});t.$prov.find(".map-mode").buttonset().find("input").click(function(){t.mapsetEdits.options.mode=$(this).val();if(t.mapsetEdits.options.mode=="bubble"&&!t.mapsetEdits.options.merges){t.mapsetEdits.options.merges=[]}else{c.show()}});var c=t.$prov.find(".merge-mode").buttonset().find("input").click(function(){t.mapsetEdits.options.merge=$(this).val()});if(t.mapsetEdits&&(!t.mapsetEdits.options.mode||t.mapsetEdits.options.mode=="bubble"))c.hide();t.$prov.find("button.config-cancel").button({disabled:true,icons:{secondary:"ui-icon-closethick"}}).addClass("ui-state-error").click(function(){t.provClose()});t.$prov.find("button.config-apply").button({icons:{secondary:"ui-icon-check"}}).click(function(){t.provOk()})}t.$prov.find("li.plot").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});t.$prov.find("li.component").off("click").click(function(e){if(!e.isPropagationStopped()){e.stopPropagation()}});t.$prov.find(".edit-plot").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("li.component").each(function(){t.showComponentEditor(this,"plot")});t.showPlotEditor(e)});t.$prov.find(".edit-mapset").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){t.sortableOff();t.$prov.find(".mapset").find("ol.map-comp li.component").each(function(){t.showComponentEditor(this,"mapset")});t.showMapSetEditor()});t.$prov.find(".edit-pointset").button({icons:{secondary:"ui-icon-pencil"}}).off("click").click(function(){var e=$(this).closest("li");e.find("ol li.component").each(function(){t.showComponentEditor(this,"pointset")});t.showPointSetEditor(e)});t.sortableOn()},plotHTML:function A(e){var t=this;var a=t.graph;var i,s="",n=t.plotsEdits[e];n.options.lineWidth=n.options.lineWidth||2;n.options.lineStyle=n.options.lineStyle||"Solid";i=n.options.color||(t.graph.chart&&t.graph.chart.get("P"+e)?t.graph.chart.get("P"+e).color:u[e%u.length]);s+='<li class="plot" data="P'+e+'">'+'<button class="edit-plot">configure</button>'+'<div class="line-sample" style="background-color:'+i+";height:"+n.options.lineWidth+'px;"><img src="images/'+n.options.lineStyle+'.png" height="'+n.options.lineWidth+'px" width="'+n.options.lineWidth*38+'px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">'+g(a,n)+"</span> ("+t.plotPeriodicity(n)+') in <span class="plot-units">'+b(a,n)+"</span></div>"+'<span class="plot-formula">= '+v(n).formula+"</span><br>"+t.componentsHTML(n)+"</li>";return s},componentsHTML:function(e){var t,a,i="plot",s="",n=this.graph;var o={sum:"summing",wavg:"day-weighted averaging of"};for(var r=0;r<e.components.length;r++){a=e.components[r];if(e.components[r].options.op==null)e.components[r].options.op="+";if(a.handle[0]=="M")i="map";if(a.handle[0]=="X")i="point";s+='<li class="component ui-state-default" data="'+a.handle+'">'+'<span class="plot-op ui-icon '+f.cssClass[e.components[r].options.op]+'">operation</span> '+'<span class="comp-edit-k" style="display:none;"><input class="short" value="'+(a.options.k||1)+'"> * </span>'+(a.handle[0]=="X"?c.pointset:a.handle[0]=="M"?c.mapset:"")+n.assets[a.handle].name+" ("+(e.options.fdown!=n.assets[a.handle].period&&e.options.algorithm?h.name[n.assets[a.handle].period]+' created by <a href="/workbench-help/changing-frequency/" traget="_blank">'+o[e.options.algorithm]+"</a> "+h.name[n.assets[a.handle].period]+" data":h.name[n.assets[a.handle].period])+") in "+n.assets[a.handle].units+(i=="plot"?' <a class="link comp-view">view source data</a>':"")+"</li>"}t='<ol class="components '+i+'-comp">'+s+"</ol>";return t},plotPeriodicity:function I(e){var t=this;var a,i,s;if(e.options.fdown){s=e.options.fdown}else{s=t.graph.assets[e.components[0].handle].period}if(e.options.fdown){return'<span class="plot-freq">'+h.name[e.options.fdown]+" synthesized</span>"}else{return'<span class="plot-freq">'+h.name[s]+"</span>"}},sortableOff:function(){var e=this;e.$prov.find("ol.plots").sortable("disable").enableSelection();e.$prov.find("ol.components").sortable("disable").enableSelection();e.$prov.find("ol.pointsets").sortable("disable").enableSelection()},sortableOn:function(){var e=this;e.$prov.find("ol.components").sortable({containment:e.$prov.get(0),connectWith:".components",disabled:false,cancel:".component-landing",axis:"y",delay:150,start:function(t,a){var i,s,n,o;if(a.item.parent().hasClass("map-comp")){n="map";o=e.mapsetEdits}if(a.item.parent().hasClass("plot-comp")){n="plot";o=e.plotsEdits[a.item.closest("li.plot").index()]}if(a.item.parent().hasClass("point-comp")){n="point";o=e.pointsetsEdits[a.item.closest("li.plot").index()]}if(n=="plot"||n=="point"){i=a.item.closest("li.plot").index()}else{i=null}s=a.item.index();e.dragging={type:n,plotIndex:i,compIndex:s,obj:o,$ol:a.item.parent()}},update:function(t,a){e.componentMoved(a)}}).disableSelection();e.$prov.find("ol.plots").sortable({axis:"y",dropOnEmpty:false,connectWith:".plots",disabled:false,start:function(t,a){e.dragging={type:"plot",plotIndex:a.item.index(),compIndex:null,$ol:a.item.parent()}},update:function(t,a){var i,s;var n=e.plotsEdits.splice(e.dragging.plotIndex,1)[0];e.plotsEdits.splice(a.item.index(),0,n);var o=a.item.index()>e.dragging.plotIndex?-1:1;for(i=0;i<e.annoEdits.length;i++){if(e.annoEdits[i].type=="point"){s=parseInt(e.annoEdits[i].series.substr(1));if(s==e.dragging.plotIndex){e.annoEdits[i].series="P"+a.item.index()}else{e.annoEdits[i].series="P"+(s+o).toString()}}}M()}}).disableSelection();e.$prov.find("ol.pointsets").sortable({axis:"y",dropOnEmpty:false,connectWith:".pointsets",disabled:false,start:function(t,a){e.dragging={type:"point",plotIndex:a.item.index(),compIndex:null,$ol:a.item.parent(),obj:e.pointsetsEdits[a.item.index()]}},update:function(t,a){if(a.sender==null)return;var i=e.pointsetEdits.splice(e.dragging.plotIndex,1);e.pointsetEdits.splice(a.item.index(),0,i);M()}}).disableSelection();this.$prov.find("a.comp-view").off().click(function(){var t=$(this).closest("li").attr("data");if(t){Dt(e.graph.assets[t])}})},componentMoved:function U(e){var t=this;var a,i,s;var n,o,r,l,d,c,p,u,h,f,m;var g=t.$prov;if(e.sender==null&&e.item.closest("ol")[0]!=t.dragging.$ol[0])return;u=e.item.closest(".plot").index();var b=e.item.parent().hasClass("blank-plot");if(e.item.parent().hasClass("map-comp")){f="map";if(!b)m=t.mapsetEdits}if(e.item.parent().hasClass("plot-comp")){f="plot";if(!b)m=t.plotsEdits[u]}if(e.item.parent().hasClass("point-comp")){f="point";if(!b)m=t.pointsetsEdits[u]}r=e.item.attr("data");if(r[0]=="M"&&f!="map"){t.$prov.find("ol.components").sortable("cancel");vt("mapset restrictions","A mapset is a grouping of series, each correspond to an area on a map, such as a state or country.  Mapsets cannot be mixed with marker sets or displayed on a line graph.<br><br>Note that from from the map, you can easily select and chart any of this mapsets' component series.");return}if(r[0]=="M"&&f!="map"){t.$prov.find("ol.components").sortable("cancel");vt("mapset restrictions","A pointset is a grouping of series, each correspond to a precise location determined by longitude and latitude values.  Pointsets cannot be mixed with area mapsets or displayed a line graph.<br><br>Note that from from the map, you can easily select and chart any of this pointsets' component series.");return}if(u!=t.dragging.plotIndex&&t.dragging.type==f&&e.item.closest("ol")[0]!=t.dragging.$ol[0]){for(n=0;n<m.components.length;n++){if(m.components[n].handle==r){t.$prov.find("ol.components").sortable("cancel");vt("duplicate series",'This series is already a component of the target plot.<br><br>If you want to use a series multiple times in the plot formula, use <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> of the formula from with the <button class="manual ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-secondary ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">manual editing</span><span class="ui-button-icon-secondary ui-icon ui-icon-pencil"></span></button> plot instead.');return}}}if(u!=t.dragging.plotIndex&&t.dragging.type==f&&!b){for(n=0;n<m.components.length;n++){if(t.graph.assets[r].period!=t.graph.assets[m.components[n].handle].period){t.$prov.find("ol.components").sortable("cancel");vt("frequency discrepancy","When performing array math, the sample frequency of all component series must be the same.");return}}}e.item.parent().find(".component-landing").remove();var v=t.dragging.obj.components.splice(t.dragging.compIndex,1)[0];c=e.item.index();if(b){m={options:{},components:[v]};t.plotsEdits.push(m);t.$prov.find("ol.plots").append(t.plotHTML(t.plotsEdits.length-1))}else{m.components.splice(c,0,v)}t.setFormula(m,e.item.closest(".plot"));if(t.dragging.obj.components.length==0){if(t.dragging.type=="plot"){t.plotsEdits.splice(t.dragging.plotIndex,1);t.$prov.find("ol.plots li.plot")[t.dragging.plotIndex].remove();var y;for(n=0;n<t.annoEdits.length;n++){if(t.annoEdits[n].type=="point"){y=parseInt(t.annoEdits[n].series.substr(1));if(y==t.dragging.plotIndex){t.annoEdits.splice(n,1);n--}if(y>t.dragging.plotIndex){t.annoEdits[n].series="P"+--y}}}}if(t.dragging.type=="point"){t.pointsetsEdits.splice(t.dragging.plotIndex,1);t.$prov.find("ol.pointsets li.plot")[t.dragging.plotIndex].remove()}}else{t.setFormula(t.dragging.obj,t.dragging.$ol.parent())}if(b){e.item.remove();t.sortableOn()}M()},provOk:function P(e){var a=this;if(a.isDirty&&(a.plotsEdits||a.mapsetEdits||a.pointsetsEdits)){if(a.plotsEdits&&a.plotsEdits.length>0)a.graph.plots=a.plotsEdits;else delete a.graph.plots;a.graph.annotations=a.annoEdits;if(a.mapsetEdits&&a.mapsetEdits.components&&a.mapsetEdits.components.length>0)a.graph.mapsets=a.mapsetEdits;else delete a.graph.mapsets;if(a.pointsetsEdits&&a.pointsetsEdits.length>0)a.graph.pointsets=a.pointsetsEdits;else delete a.graph.pointsets;a.graph.mapconfig=a.mapconfigEdits;if(!a.graph.mapsets&&!a.graph.pointsets)a.graph.map="";this.provClose();if(!e)$("#"+t).find(".graph-type").change()}},provClose:function _(){var e=this;delete e.plotsEdits;delete e.annoEdits;delete e.mapsetEdits;delete e.pointsetsEdits;delete e.mapconfigEdits;e.$prov.find("ol.ui-sortable").sortable("destroy");e.$prov.closest("div.graph-panel").find(".graph-nav-graph").click();e.isDirty=false},compIndex:function(e){var t=$(e);var a=t.index();return a},showComponentEditor:function E(e,t){var a=this;var i,s,o=$(e);var r=$(e).closest("li.plot, li.pointset").index();if(t=="mapset")i=a.mapsetEdits;if(t=="pointset")i=a.pointsetsEdits[r];if(t=="plot")i=a.plotsEdits[r];var l=a.compIndex(o);var d=$(e).attr("data");var c=i.components[l];var p=(n.vectorPattern.test(d)?'<button class="comp-copy prov-float-btn">make copy</button>':"")+'<button class="comp-delete prov-float-btn">remove series</button>';var u=$(p);o.find(".plot-op").hide().after('<div class="op">'+'<input type="radio" data="+"  id="op-addition'+d+'" value="+" name="op-radio'+d+'" /><label for="op-addition'+d+'">+</label>'+'<input type="radio" data="-"  id="op-subtraction'+d+'" value="-" name="op-radio'+d+'" /><label for="op-subtraction'+d+'">-</label>'+'<input type="radio" data="*"  id="op-multiply'+d+'" value="*" name="op-radio'+d+'" /><label for="op-multiply'+d+'">*</label>'+'<input type="radio" data="/"  id="op-divide'+d+'" value="/" name="op-radio'+d+'" /><label for="op-divide'+d+'">/</label>'+"</div>");o.find("div.op").find("input[data='"+c.options.op+"']").attr("checked","checked").end().buttonset().find("input:radio").change(function(){a.set(i.components[l].options,"op",$(this).val());a.setFormula(i,o.closest(".plot,.mapset"));o.find(".plot-op").attr("class","plot-op ui-icon "+f.cssClass[i.components[l].options.op])});u.appendTo(o).slideDown();o.find(".comp-edit-k").show().find("input").change(function(){if(!isNaN(parseFloat(this.value))){c.options.k=Math.abs(parseFloat(this.value));if(c.options.k==0)c.options.k=1;M();a.setFormula(i,o.closest("ol").parent())}else{vt("Error","Scalors must be numerical")}$(this).val(c.options.k)});o.find(".comp-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){if(i.components.length==1){o.closest("li.plot, div.mapset").find(".plot-delete").click()}else{i.components.splice(l,1);o.remove();M()}});o.find(".comp-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){var e={options:{},components:[$.extend(true,{},c,{options:{op:"+"}})]};a.plotsEdits.push(e);var t=a.graph.assets[d].name;a.$prov.find("ol.plots").append(a.componentsHTML(e))})},showPlotEditor:function F(e){var a=this;a.sortableOff();var i=$(e);var s=i.index();var n=a.plotsEdits[s];var o=n.options;var l=n.options.color||a.graph.chart.get("P"+i.index()).color;i.find(".edit-plot, .plot-info").hide();var d='<select class="plot-thickness" data="lineWidth">';for(var c=1;c<=5;c++)d+='<option value="'+c+'">'+c+"px</option>";d+="</select>";var p='<select class="plot-linestyle" data="lineStyle">';for(var u=0;u<r.length;u++)p+='<option value="'+r[u].replace(/ /g,"")+'">'+r[u].toLowerCase()+"</option>";p+="</select>";var h=o.fdown||a.graph.assets[n.components[0].handle].period;var f=this.freqOptions(n);var m='<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete plot</button>'+'<fieldset class="edit-line" style="padding: 0 5px;display:inline-block;"><legend>color, thickness, &amp; style</legend>'+'<div class="edit-block"><input class="plot-color" type="text" data="color" value="'+(n.options.color||l)+'" /></div>'+d+p+"</fieldset>"+'<div class="edit-block">Name: <input class="plot-name" type="text" data="name" /></div>'+'<div class="edit-block"><span class="edit-label">display as:</span><select class="plot-type" data="type"><option value="">graph default</option><option value="line">line</option><option value="column">column</option><option value="area">stacked area</option></select></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text"  /><span class="plot-edit-k edit-label">scalor:<input class="short" value="'+(n.options.k||1)+'"></span> '+'<span class="edit-label">frequency:</span><select class="dshift">'+f+"</select></div><br>"+'<span class="edit-label">Point calculations:</span>'+a.HTML.compMath+'<div class="edit-block"><span class="edit-label">Break line</span><div class="edit-breaks">'+'<input type="radio" id="never-'+t+'" name="line-break-'+t+'" data="breaks" value="never" /><label for="never-'+t+'">never</label>'+'<input type="radio" id="nulls-'+t+'" name="line-break-'+t+'" data="breaks" value="nulls" /><label for="nulls-'+t+'">on nulls</label>'+'<input type="radio" id="missing-'+t+'" name="line-break-'+t+'" data="breaks" value="missing" /><label for="missing-'+t+'">on missing value and nulls</label></div>'+"</div>"+"</div>";var v=$(m);a.$prov.find("button.plot-close").click();v.find("input.plot-name").val(g(a.graph,n)).change(function(){if(g(a.graph,n,true)!=$(this).val()&&$(this).val().trim()!="")n.options.name=$(this).val();else delete n.options.name;M()});v.find("input.plot-units").val(b(a.graph,n)).change(function(){if(b(a.graph,n,true)!=$(this).val()&&$(this).val().trim()!=""){n.options.units=$(this).val()}else{delete n.options.units}i.find("span.plot-units").html(b(a.graph,n));M()});v.find("select.dshift").val(h).change(function(){var e=$(this).val();var t=v.find("select.dshift option:selected").attr("data");if(e!=t){selectDownshift(a.graph,e,n,function(t){if(t){o.fdown=e;o.algorithm=t.algorithm;o.missing=t.missing;$.each(n.components,function(){var t=a.graph.assets[this.handle];if(t.freqset[e]){this.handle=t.freqset[e]}else{this.handle=t.freqset[e=="A"&&t.freqset.Q?"Q":"M"]}});h=e;a.fetchNewSeries(n);M()}else{v.find("select.dshift").val(h)}})}else{delete o.fdown;delete o.algorithm;delete o.missing;$.each(n.components,function(){this.handle=a.graph.assets[this.handle].freqset[e]});h=e;a.fetchNewSeries(n);M()}});if(!n.options.componentData)n.options.componentData="required";v.find("div.edit-math").find("input[id='"+n.options.componentData+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){n.options.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];M()});if(!n.options.breaks)n.options.breaks="nulls";v.find("div.edit-breaks").find("input[id='"+n.options.breaks+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){a.set(n.options,$(this))});v.find(".edit-line legend").after(i.find(".line-sample").hide().clone().css("display","inline-block").show());v.find("input.plot-color").colorPicker().change(function(){a.set(n.options,$(this));i.find("div.line-sample").css("background-color",n.options.color)});v.find("select.plot-thickness").val(n.options.lineWidth).change(function(){a.set(n.options,$(this));i.find("div.line-sample").css("height",n.options.lineWidth).find("img").css("height",n.options.lineWidth).css("width",parseInt(n.options.lineWidth.substr(0,1)*38)+"px")});v.find("select.plot-linestyle").val(n.options.lineStyle).change(function(){a.set(n.options,$(this));i.find("div.line-sample img").attr("src","images/"+n.options.lineStyle+".png")});v.find("select.plot-type").val(n.options.type).change(function(){a.set(n.options,$(this))});v.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){n.options.k=Math.abs(parseFloat(this.value));if(n.options.k==0)n.options.k=1;a.setFormula(n,i);M()}else{vt("Error","Scalors must be numerical")}$(this).val(n.options.k||1)});v.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){a.plotsEdits.splice(i.index(),1);i.remove();M()});v.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){a.plotsEdits.push($.extend(true,{},n));a.build(s)});v.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var e;i.find(".edit-plot, .plot-info, .line-sample, span.plot-formula").show();i.find(".plot-editor").slideUp("default",function(){i.find(".op.ui-buttonset").remove();if(!o.userFormula)i.find(".plot-op").show();i.find(".plot-editor, button.manual, button.guided, input.plot-formula").remove();i.find("li button").remove();v.remove()});i.find(".comp-edit-k").hide();a.$prov.find(".landing").slideDown();i.find(".comp-editor").slideUp("default",function(){$(this).remove()});i.find(".edit-plot").show();a.sortableOn()});v.prependTo(i);this.editPlotFormula(n,i);v.slideDown();a.$prov.find(".landing").slideUp()},freqOptions:function(e){var t,a,i,s,n="",o={},r;for(t=0;t<h.order.length;t++){i=true;r=h.order[t];for(a=0;a<e.components.length;a++){s=this.graph.assets[e.components[a].handle];if(!s.freqset){s.freqset={};s.freqset[s.period]=s.handle}if(!s.freqset[r])i=false}if(i){n+='<option value="'+r+'" data="'+r+'">'+h.name[r]+" using official data</option>";o[r]=true}}if(!o["Q"]&&o["M"])n+='<option value="Q" data="M">'+h.name.Q+" calculated from monthly data</option>";if(!o["A"]&&(o["M"]||o["Q"]))n+='<option value="A" data="'+(o["Q"]?"Q":"M")+'">'+h.name.A+" calculated from "+(o["Q"]?h.name.Q:h.name.M)+" data</option>";return n},fetchNewSeries:function(e){var t=this,a={S:[],U:[],X:[],M:[]};$.each(e.components,function(){assetNeeded(this.handle,t.graph,a)});fetchAssets(t.graph,a,sa)},showPointSetEditor:function(e){var a=this;a.sortableOff();var s=a.pointsetsEdits[e.index()];var n=s.options;e.find(".edit-plot, .plot-info").hide();var o='<div class="plot-editor" style="display: none;">'+'<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-copy prov-float-btn">make copy</button>'+'<button class="plot-delete prov-float-btn">delete marker set</button>'+'<div class="edit-block"><input class="marker-color" type="text" data="color" value="'+n.color+'" /></div>'+'<div class="edit-block">name: </span><input class="plot-name" type="text"  /></div>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" type="text" /><span class="plot-edit-k"><input class="short" value="'+(n.k||1)+'"> </div><br>'+'<span class="edit-label attribute">Values will change marker  </span>'+'<div class="attribute">'+'<input type="radio" name="attribute-'+t+'" id="attribute-r-'+t+'" data="attribute" value="r"/><label for="attribute-r-'+t+'">area</label>'+'<input type="radio" name="attribute-'+t+'" id="attribute-fill-'+t+'" data="attribute" value="fill" /><label for="attribute-fill-'+t+'">color</label>'+"</div>"+'<span class="edit-label">Point calculations:</span>'+a.HTML.compMath+"</div>"+"</div>";var r=$(o);a.$prov.find("button.plot-close").click();var r=$(o);r.find("input.plot-name").val(g(a.graph,s)).change(function(){if(g(a.graph,s,true)!=$(this).val()&&$(this).val().trim()!="")n.name=$(this).val();else delete n.name;M()});r.find("input.plot-units").val(b(a.graph,s)).change(function(){if(b(a.graph,s,true)!=$(this).val()&&$(this).val().trim()!="")n.units=$(this).val();else delete n.units;M()});r.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){n.k=Math.abs(parseFloat(this.value));if(n.k==0)n.k=1;a.setFormula(s,e)}else{vt("Error","Scalors must be numerical")}$(this).val(n.k||1)});r.find(".marker-color").colorPicker().change(function(){a.set(n,$(this));r.find("div.marker").css("background-color",$(this).val())});function l(){for(var e=0;e<a.pointsetsEdits.length;e++){if(a.pointsetsEdits[e].options.attribute=="fill"){r.find(".color-picker.marker-color").hide();return}}r.find(".color-picker.marker-color").show()}l();r.find("div.attribute").find("[value='"+(n.attribute||"r")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){a.set(n,$(this));i.setRadLabel();i.legendOptionsShowHide()});if(!n.componentData)n.componentData="required";r.find("div.edit-math").find("input[id='"+n.componentData+"-"+t+"']").click().end().buttonset().find("input:radio").change(function(){n.componentData=$(this).closest("div").find(".ui-state-active").attr("for").split("-")[0];M()});r.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){a.plotsEdits.splice(e.index(),1);e.remove();M()});r.find("button.plot-copy").button({icons:{secondary:"ui-icon-copy"}}).click(function(){a.plotsEdits.push($.extend(true,{},s));a.build(plotIndex)});r.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){var t;e.find(".edit-plot, .plot-info, .line-sample").show();e.find(".plot-editor").slideUp("default",function(){e.find(".op.ui-buttonset").remove();if(!n.userFormula)e.find(".plot-op").show();e.find(".guided, .manual, input.plot-formula, .plot-editor, li button").remove();r.remove()});e.find(".comp-edit-k").hide();a.$prov.find(".landing").slideDown();e.find(".comp-editor").slideUp("default",function(){$(this).remove()});e.find(".edit-plot").show();a.sortableOn()});r.prependTo(e);this.editPlotFormula(s,e);r.slideDown();a.$prov.find(".landing").slideUp();e.find(".edit-pointset").hide()},provenanceOfMap:function N(){var e=this;var t="",a,i,n=[],o,r=[],l="",p=s.grapher.isSummationMap(e.graph);if(e.graph.map&&(e.mapsetEdits||e.pointsetsEdits)){k(e.graph,function(){o=e.graph.assets[this.handle].themeid;if(o){n.pushUnique(o);if(!d["T"+o])r.pushUnique(o)}});if(n.length>0||p){if(r.length>0){C({command:"GetCubeList",themeids:r},function(t,a,i){for(var s in t.themes){d[s]=t.themes[s]}e.$prov.find("select.cubeSelector").html(u())})}l='<div class="cubeSelector right">supplemental visualization: <select class="cubeSelector" data="cubeid">'+u()+"</select></div>"}function u(){var t,a,i,s='<option value="0">none</option>';if(p)s+='<option value="sum" '+(e.mapconfigEdits.cubeid=="sum"?"selected":"")+">bar graph of components</option>";for(t=0;t<n.length;t++){i=d["T"+n[t]];if(i){for(a=0;a<i.cubes.length;a++){s+='<option value="'+i.cubes[a].cubeid+'" '+(e.mapconfigEdits.cubeid==i.cubes[a].cubeid?"selected":"")+">"+i.name+": "+i.cubes[a].name+"</option>"}}}return s}t='<div class="map-prov">'+l+"<h3>Map of "+e.graph.map+"</h3>";if(e.mapsetEdits){var h=e.mapsetEdits;t+='<div class="mapset">'+"<h4>"+c.mapset+" Mapped set of regions (country, state, or county)</h4>"+'<div class="mapset-colors" style="margin-bottom:5px;"></div>'+'<div class="plot-info">'+'<button class="edit-mapset right ehide">configure</button>'+'<div class="edit-block ehide">'+'<span class="plot-title">'+g(e.graph,h)+"</span> ("+e.plotPeriodicity(h)+') in <span class="plot-units">'+b(e.graph,h)+"</span>"+"</div>"+'<span class="plot-formula">= '+v(h).formula+"</span><br>"+'<span class="map-mode ehide">mode: '+(!h.options.mode||h.options.mode!="bubble"?"heat map":"bubbles with user defined regions")+"</span>"+'<div class="editor"></div>'+"</div>"+e.componentsHTML(h)+"</div>"}if(e.pointsetsEdits){t+='<div class="pointsets"><h4>'+c.pointset+" mapped set of markers (defined latitude and longitude)</h4>"+'<div class="pointsets-colors" style="margin-bottom:5px;"></div>'+'<ol class="pointsets">';for(a=0;a<e.pointsetsEdits.length;a++){i=e.pointsetsEdits[a];t+='<li class="pointset">'+'<button class="edit-pointset right">configure</button>'+'<div class="plot-info" style="display:inline-block;">'+'<div class="marker" style="background-color: '+(i.options.color||"#000000")+'"></div>'+'<span class="plot-title">'+g(e.graph,i)+"</span> ("+e.plotPeriodicity(i)+') in <span class="plot-units">'+b(e.graph,i)+"</span>"+'<span class="plot-formula">= '+v(i).formula+"</span></div>"+e.componentsHTML(e.pointsetsEdits[a])+"</li>"}t+="</ol></div>"}t+="</div>"}return t},editPlotFormula:function(e,t){if(e.options.userFormula){a()}else{i()}function a(){t.find("div.op, span.comp-edit-k").hide();t.find("button.manual").remove();t.find("span.plot-formula").hide().after('<button class="guided">guided editing</button>').after('<input class="plot-formula">');t.find("input.plot-formula").val(e.options.userFormula||v(e).formula).keyup(function(){try{var a=$(this).val();if(a.indexOf(";")>=0)throw"invalid mathematical syntax";var i="return "+a.replace(patVariable,"values.$1")+";";var s=new Function("values",i);var n={},o;$.each(e.components,function(e){o=w(e);if(a.indexOf(o)===-1)throw"all symbols must be used";n[w(e)]=e});var r=s(n);$(this).removeClass("ui-state-error");e.options.userFormula=a;t.find("span.plot-formula").html("= "+e.options.userFormula)}catch(l){$(this).addClass("ui-state-error");delete e.options.userFormula}});t.find("button.guided").button({icons:{secondary:"ui-icon-star"}}).click(function(){i()})}function i(){t.find("div.op, span.comp-edit-k").show();t.find("input.plot-formula, button.guided").remove();t.find("span.plot-formula").html("= "+v(e).formula).show().after('<button class="manual">manual editing</button>');delete e.options.userFormula;t.find("button.manual").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){a()})}},showMapSetEditor:function(){var e=this;var t=this.mapsetEdits;var a=this.mapsetEdits.options;var i=e.$prov.find(".mapset");this.editPlotFormula(this.mapsetEdits,i);var s;e.$prov.find("button.plot-close").click();i.find(".edit-mapset").hide();var n='<div class="plot-editor" style="display: none;">';if(a.mode=="bubble"){n+='<span class="merge-formula">merge formula = &#931; numerator / &#931; denominator</span>'}n+='<button class="plot-close prov-float-btn">close</button>'+'<button class="plot-delete prov-float-btn">delete heat map</button>'+""+'<div class="edit-block">name: </span><input class="plot-name" type="text" data="name"/></div><br>'+'<div class="edit-block"><span class="edit-label">units:</span><input class="plot-units long" data="units" type="text"/><span class="plot-edit-k"> scalor: <input class="short" value="'+(a.k||1)+'"></div><br>'+'<span class="edit-label">Point calculations:</span>'+e.HTML.compMath+'<div class="edit-block add-bunny"><button  class="add-bunny">add regional tracking plot</button></span></div> ';n+="</div>";var o=$(n);o.find("button.add-bunny").button({icons:{secondary:"ui-icon-plus"}}).click(function(){var s="add";if(s=="add"){var n,o,r,l=[];for(n=0;n<t.components.length;n++){if(t.components[n].handle[0]=="M"){l.push(t.components[n].handle.substr(1))}}C({command:"GetBunnySeries",mapsetids:l,geoid:parseInt(mapsList[e.graph.map].bunny),mapname:e.graph.map},function(a,i,s){if(a.allfound){for(o in a.assets){e.graph.assets[a.assets[o].handle]=a.assets[o]}var r={options:{k:t.options.k||1,units:t.options.units},components:[]};for(n=0;n<t.components.length;n++){if(t.components[n].handle[0]=="M"){o=a.assets[t.components[n].handle].handle}else{o=t.components[n].handle}r.components.push({handle:o,options:{k:t.components[n].k||1,op:t.components[n].op||"+"}})}var l,d=e.plotsEdits,c=false;if(d){for(l=0;l<d.length;l++){if(r.options.k!=d[l].options.k||1){for(n=0;n<d[l].components.length;n++){if(d[l].components[n].handle!=r.components[n].handle||d[l].components[n].options.k||1!=r.components[n].options.k||d[l].components[n].options.op||"+"!=r.components[n].options.op)break}if(n==d[l].components.length){c=true;$(this).val(l);break}}}}if(!c){e.plotsEdits.push(r);e.build(l)}}else{vt("unable to automatically create tracking plot","One or more of the component map sets does not have series for "+e.graph.map+" level of aggregation.")}M()})}else{if(s=="-1"){delete a.bunny}else{a.bunny=parseInt(s)}}e.setFormula(t,i);M()});o.find(".plot-edit-k input").change(function(){if(!isNaN(parseFloat(this.value))){a.k=Math.abs(parseFloat(this.value));if(a.k==0)a.k=1;e.setFormula(t,i);M()}else{vt("Error","Scalors must be numerical")}$(this).val(a.k||1)});o.find("div.edit-math").find("[value='"+(a.compMath||"required")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){e.set(a,$(this))});o.find("button.plot-delete").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){e.mapsetEdits={};i.remove();if(!e.pointsetsEdits)e.$prov.find("map-prov").remove();M()});o.find("button.plot-close").button({icons:{secondary:"ui-icon-arrowstop-1-n"}}).click(function(){i.find(".edit-mapset, .plot-info").show();i.find(".plot-editor").slideUp("default",function(){i.find(".op.ui-buttonset, .comp-delete").remove();
$(this).remove();i.find(".plot-op").show()});i.find(".guided, .manual, input.plot-formula, span.comp-edit-k").remove();i.find(".ehide").show();e.$prov.find(".landing").slideDown();i.find(".comp-editor").slideUp("default",function(){$(this).remove()});e.sortableOn()});o.find("input.plot-name").val(g(e.graph,t)).change(function(){e.set(a,$(this));i.find("span.plot-title").html(t.options.name)});o.find("input.plot-units").val(b(e.graph,t)).change(function(){e.set(a,$(this));i.find("span.plot-units").html(t.options.units)});o.appendTo(i.find(".editor").html("")).slideDown();i.find(".ehide").hide();e.$prov.find(".landing").slideUp()},setFormula:function(e,t){e.formula=v(e);var a=e.formula.formula;if(t){t.find("span.plot-formula").html("= "+a);if(!e.options.units)t.find("input.plot-units").val(b(this.graph,e));if(!e.options.name)t.find("input.plot-name").val(g(this.graph,e))}},legendEditor:function(e,i,s){var n,o=this,r=o.$prov.find(".map-prov");var l='<div class="edit-block">'+'<div class="map-mode edit-block">'+'<input type="radio" name="'+t+'-map-mode" id="'+t+'-map-mode-C" value="fill" data="mode" '+(!i.mode||i.mode!="bubble"?"checked":"")+' /><label for="'+t+'-map-mode-C">fill (heat map)</label>'+'<input type="radio" name="'+t+'-map-mode" id="'+t+'-map-mode-B" value="bubble" data="mode" '+(i.mode&&i.mode=="bubble"?"checked":"")+' /><label for="'+t+'-map-mode-B">bubbles (mergable into regional sums)</label>'+'</div><span class="merge-formula ital">merge formula = &#931; numerator / &#931; denominator</span>'+'<div class="radius"  style="display: none;">'+'<span class="edit-label radius-label">maximum '+(s=="X"?"marker":"bubble")+' radius (pixels): </span><input class="radius-spinner" value="'+(i.attribute=="fill"?o.mapconfigEdits.fixedRadius||DEFAULT_RADIUS_FIXED:o.mapconfigEdits.maxRadius||p)+'" />'+"</div>"+'<div class="edit-block color-scale" style="display: none;">'+'<div class="legend-scale"><span class="edit-label">Color scale:</span>'+'<input type="radio" id="legend-continuous-'+t+'" name="legend-type-'+t+'" data="scale" value="continuous" /><label for="legend-continuous-'+t+'">continous</label>'+'<input type="radio" id="legend-discrete-'+t+'" name="legend-type-'+t+'" data="scale" value="discrete"/><label for="legend-discrete-'+t+'">discrete</label>'+"</div>"+'<div class="lin-log-scaling"><span class="edit-label">Color mode:</span>'+'<input type="radio" id="lin-scaling-'+t+'" name="color-mode-'+t+'" data="logMode" value="off" /><label for="lin-scaling-'+t+'">linear</label>'+'<input type="radio" id="log-scaling-'+t+'" name="color-mode-'+t+'" data="logMode" value="on"/><label for="log-scaling-'+t+'">enhanced color</label>'+"</div>"+'<div class="edit-block legend-continuous" style="display: none;">'+'-<div class="continuous-color"><input class="neg color-picker" type="text" data="negColor" value="'+(i.negColor||m.NEG)+'" /></div>'+D(i)+'<div class="continuous-color"><input class="pos color-picker" type="text" data="posColor" value="'+(i.posColor||m.POS)+'" /></div>+'+"</div>"+'<div class="edit-block legend-discrete" style="display: none;"></div>'+"</div>";var d=$(l);d.find("div.map-mode").find("[value='"+(i.mode||"fill")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){o.set(i,$(this));a.legendOptionsShowHide();c()});c();function c(){if(i.mode=="bubble")d.find(".merge-formula").show();else d.find(".merge-formula").hide()}d.find("div.legend-scale").find("[value='"+(i.scale||"continuous")+"']").attr("checked",true).end().buttonset().find("input:radio").change(function(){o.set(i,$(this));u()});function u(){if(i.scale=="discrete"){d.find(".legend-discrete").removeAttr("style");d.find(".lin-log-scaling").hide();d.find(".legend-continuous").hide()}else{d.find(".legend-discrete").hide();d.find(".lin-log-scaling").removeAttr("style");d.find(".legend-continuous").removeAttr("style")}}u();d.find(".lin-log-scaling").find("[value='"+(i.logMode||"off")+"']").attr("checked",true).end().buttonset().find("input").change(function(){o.set(i,$(this))});d.find(".radius-spinner").spinner({min:2,max:200,change:function(e,t){if(s=="M"||i.attribute!="fill"){o.mapconfigEdits.maxRadius=$(this).val()}else{o.mapconfigEdits.fixedRadius=$(this).val()}M()}});d.find(".color-picker.pos").colorPicker().change(function(){o.set(i,$(this));d.find(".continuous-strip-pos").html(S("#CCCCCC",i.posColor));r.find(".map-legend").html("-"+D(i)+"+")});d.find(".color-picker.neg").colorPicker().change(function(){o.set(i,$(this));d.find(".continuous-strip-neg").html(S(i.negColor,"#CCCCCC"));r.find(".map-legend").html("-"+D(i)+"+")});d.find(".legend-discrete").append(o.discreteLegend(s));h();e.append(d);return{legendOptionsShowHide:h,setRadLabel:f};function h(){if(s=="X"||s=="M"&&i.mode=="bubble"){d.find("div.radius").slideDown()}else{d.find("div.radius").slideUp()}if(s=="M"&&i.mode!="bubble"||s=="X"&&o.mapconfigEdits.markerScaling!="none"&&y(o.pointsetsEdits)>0){d.find("div.color-scale").slideDown();if(i.scale=="discrete"){d.find("div.legend-continuous").hide();d.find("div.legend-discrete").removeAttr("style")}else{d.find("div.legend-continuous").removeAttr("style");d.find("div.legend-discrete").hide()}}else{d.find("div.color-scale").slideUp()}}function f(){}},discreteLegend:function(e){var t,a,i,n,o,r=this;var l=e=="X"?r.mapconfigEdits:r.mapsetEdits.options;if(!Array.isArray(l.discreteColors)||l.discreteColors.length==1)l.discreteColors=c(5,l);t='<div class="edit-block">'+'<div class="edit-block discrete-legend"></div>'+'<button class="inc-discrete">+</button>'+'<button class="dec-discrete">-</button>'+'<button class="reset-discrete">calculate colors</button>'+"</div>";a=$(t);d();a.find("button.inc-discrete").button({disabled:l.discreteColors.length>9}).click(function(){a.find("button.inc-discrete").button("enable");l.discreteColors=c(l.discreteColors.length+1,l);if(l.discreteColors.length>9)$(this).button("disable");d();M()});a.find("button.dec-discrete").button({disabled:l.discreteColors.length<2}).click(function(){a.find("button.inc-discrete").button("enable");l.discreteColors=c(l.discreteColors.length-1,l);if(l.discreteColors.length<2)$(this).button("disable");d();M()});a.find("button.reset-discrete").button().click(function(){l.discreteColors=c(l.discreteColors.length,l);d();M()});return a;function d(){var e="";for(i=0;i<l.discreteColors.length;i++){e+='<div class="discrete-color"><input class="color" data="'+i+'" value="'+l.discreteColors[i].color+'" /></div>';if(i!=l.discreteColors.length-1){e+=' &#8804; <input class="cutoff" data="'+i+'" value="'+l.discreteColors[i].cutoff+'" />'}}a.find(".discrete-legend").html(e);a.find(".color").colorPicker().change(function(){n=parseInt($(this).attr("data"));l.discreteColors[n].color=$(this).val();M()});a.find(".cutoff").change(function(){n=parseInt($(this).attr("data"));o=$(this).val();if(isNaN(o)){for(i=0;i<l.discreteColors.length;i++){if(i<n)l.discreteColors[i].cutoff=Math.min(l.discreteColors[i].cutoff,o);if(i==n)l.discreteColors[i].cutoff=o;if(i>n)l.discreteColors[i].cutoff=Math.max(l.discreteColors[i].cutoff,o)}}M()})}function c(t,a){var i,n,o,l=[],d=[];var c=e=="X"?r.graph.calculatedMapData.markerData:r.graph.calculatedMapData.regionData;for(n in c){for(o in c[n]){if(c[n][o]!=null)l.push(c[n][o])}}l.sort(function(e,t){return e-t});var p=0,u=0;for(i=0;i<t;i++){if(l[parseInt(l.length/(t/(i+1)))]<0)p++}var h=l[0]<0&&l[l.length-1]>0;if(h){for(u=0;u<l.length;u++){if(l[u]>=0)break}if(h){if(p==0){p++}else{var f=(u/l.length-p/t)*t;if(f<-.5)p++;if(f>.5&&p>1)p--}}}var g=t-p;var b=a.negColor||m.NEG;if(b.substr(0,1)=="#")b=b.substr(1);var v,y,k,w,x,C,M;w=parseInt(b.substr(0,2),16);x=parseInt(b.substr(2,2),16);C=parseInt(b.substr(4,2),16);for(i=0;i<p;i++){v=parseInt(w+(255-w)*(p-i-1)/p);y=parseInt(x+(255-x)*(p-i-1)/p);k=parseInt(C+(255-C)*(p-i-1)/p);M="#"+v.toString(16)+y.toString(16)+k.toString(16);d.push({color:M,cutoff:i+1==p&&h?0:l[Math.round((l.length-1)*(i+1)/t)]})}var $,S=0,D=a.posColor||m.POS,T=s.common.octet;if(D.substr(0,1)=="#")D=D.substr(1);w=parseInt(D.substr(0,2),16);x=parseInt(D.substr(2,2),16);C=parseInt(D.substr(4,2),16);for(i=p;i<g;i++){v=parseInt(w+(255-w)*(g-i-1)/g);y=parseInt(x+(255-x)*(g-i-1)/g);k=parseInt(C+(255-C)*(g-i-1)/g);M="#"+T(v)+T(y)+T(k);$=Math.round((l.length-1-S)*i/t+S);while($<l.length-1&&l[$]==l[$+1]){$++;S++}d.push({color:M,cutoff:l[$]})}return d}},set:function(e,t,a){if(typeof t=="string"){e[t]=a}else{e[t.attr("data")]=t.val()}M()}};return x;function M(){x.isDirty=true;x.$prov.find(".config-cancel").button("enable")}function S(e,t){return'<span class="map_legend_gradient" style="-ms-filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='+e+", endColorstr="+t+", gradientType=1);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="+e+", endColorstr="+t+", gradientType=1)background-image: -webkit-gradient(linear, left bottom, right bottom, from("+e+"), to("+t+"));background-image: -webkit-linear-gradient(left, "+e+", "+t+");background-image: -moz-linear-gradient(left, "+e+", "+t+");background-image:  -o-linear-gradient(left, "+e+", "+t+";background-image: linear-gradient(to left, "+e+","+t+');"></span>'}function D(e){return'<div class="continuous-strip-neg">'+S(e.negColor||m.NEG,m.MID)+"</div>"+"0"+'<div class="continuous-strip-pos">'+S(m.MID,e.posColor||m.POS)+"</div>"}}if(typeof console=="undefined")console={};if(typeof console.info=="undefined")console.info=function(e){};if(typeof console.log=="undefined")console.log=function(e){};if(typeof console.time=="undefined")console.time=function(e){};if(typeof console.timeEnd=="undefined")console.timeEnd=function(e){};function i(){jQuery.extend({stringify:function e(t){if("JSON"in window){return JSON.stringify(t)}var a=typeof t;if(a!="object"||t===null){if(a=="string")t='"'+t+'"';return String(t)}else{var i,s,n=[],o=t&&t.constructor==Array;for(i in t){s=t[i];a=typeof s;if(t.hasOwnProperty(i)){if(a=="string"){s='"'+s+'"'}else if(a=="object"&&s!==null){s=jQuery.stringify(s)}n.push((o?"":'"'+i+'":')+String(s))}}return(o?"[":"{")+String(n)+(o?"]":"}")}}})}Date.prototype.toMDDateString=function(e){var t=e||this.period;if(!t)throw"no period found";var a=this.getUTCFullYear();switch(e){case"M":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();break;case"Q":a+="Q"+parseInt((this.getUTCMonth()+3)/3);break;case"SA":a+="H"+parseInt((this.getUTCMonth()+6)/6);break;case"W":case"D":a+=(this.getUTCMonth().toString().length==1?"0":"")+this.getUTCMonth();a+=(this.getUTCDate().toString().length==1?"0":"")+this.getUTCDate();break}return a};if(!("pushUnique"in Array.prototype)){Array.prototype.pushUnique=function(e){if(this.indexOf(e)===-1){return this.push(e)}else{return false}}}if(!("bind"in Function.prototype)){Function.prototype.bind=function(e){var t=this;if(arguments.length<=1){return function(){return t.apply(e,arguments)}}else{var a=Array.prototype.slice.call(arguments,1);return function(){return t.apply(e,arguments.length===0?a:a.concat(Array.prototype.slice.call(arguments)))}}}}if(!("trim"in String.prototype)){String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(e,t){if(t===undefined)t=0;if(t<0)t+=this.length;if(t<0)t=0;for(var a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1}}if(!("lastIndexOf"in Array.prototype)){Array.prototype.lastIndexOf=function(e,t){if(t===undefined)t=this.length-1;if(t<0)t+=this.length;if(t>this.length-1)t=this.length-1;for(t++;t-->0;)if(t in this&&this[t]===e)return t;return-1}}if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this)e.call(t,this[a],a,this)}}if(!("map"in Array.prototype)){Array.prototype.map=function(e,t){var a=new Array(this.length);for(var i=0,s=this.length;i<s;i++)if(i in this)a[i]=e.call(t,this[i],i,this);return a}}if(!("filter"in Array.prototype)){Array.prototype.filter=function(e,t){var a=[],i;for(var s=0,n=this.length;s<n;s++)if(s in this&&e.call(t,i=this[s],s,this))a.push(i);return a}}if(!("every"in Array.prototype)){Array.prototype.every=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this&&!e.call(t,this[a],a,this))return false;return true}}if(!("some"in Array.prototype)){Array.prototype.some=function(e,t){for(var a=0,i=this.length;a<i;a++)if(a in this&&e.call(t,this[a],a,this))return true;return false}}var s=e,n=s.globals,o=s.grapher,l=s.common;var d=n.themeCubes,c=n.iconsHMTL,p=n.panelGraphs,oMySeries=n.MySeries,u=n.MyGraphs,h=n.hcColors,f=n.colorsPlotBands,m=n.graphScriptFiles;var v=o.createMyGraph,y=o.formatDateByPeriod,k=o.visiblePanelId,w=o.compSymbol;var x=l.dateFromMdDate,C=l.callApi;var M={plot:'<li class="plot ui-state-highlight" data="{{order}}">'+'<a class="edit-plot link" style="float:right;">edit <span class="ui-icon ui-icon-arrowthickstop-1-s" style="display: inline-block;"> edit</span></a>'+'<div class="line-sample" style="padding:0;margin:0 10px 10px 0;display:inline-block;border-width:0;background-color:{{color}};height:{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px;width:38px;">'+'<img src="images/{{options.lineStyle}}.png" height="{{#options.lineWidth}}{{.}}{{/options.lineWidth}}{{^options.lineWidth}}2{{/options.lineWidth}}px" width="{{imageWidth}}px"></div>'+'<div class="plot-info" style="display:inline-block;"><span class="plot-title">{{name}}</span> in {{plotUnits}} {{plotPeriodicity}}</div>'+'<ul class="series" style="list-style-type: none;" data="{{order}}">'+'{{#component}}<li class="serie ui-state-default" data="{{handle}}" plot="{{order}}"><span class="plot-op ui-icon {{opUI}}">operation</span> '+'{{seriesname}}<button class="edit-comp">edit</button></li>{{/component}}'};var S={noMySeries:'Your My Series folder is empty.  Please search for Public Series, which can be graphed and added to your My Series folder for future quick reference.<br><br>You can also use the <button id="new-series" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover" role="button" aria-disabled="false"><span class="ui-button-text">new series</span></button> feature to enter or upload your own data.',noSeriesSelected:"Click on one or more series below to select them before previewing.<br><br>Alternatively, you can double-click on a series to quickly preview it.",editLimit:"Only one series or set can be edited at a time.",noGraphSelected:"Click on a row in the table below to select a graph first.<br><br>As a shortcut, you can double-click on a graph to select and open it.",noMyGraphs:"You have no My Graphs.  Graphs are built by searching for public series or upload your own data and building a graph. Saving graphs you build adds to them to your My Graphs folder.<br><br>You can also view a public graph and make a personal copy.<br><br>See the help (upper right after you close this dialogue) to learn more.",noPublicGraphs:"First search for public graphs.  Note that a search with no keywords will return the most recent published graphs.",deleteMySeries:"This action will remove the series from your My Series favorites. Public series will still be available through the Public Series finder.  Any uploads or edits will be lost.  Please confirm to delete.",signInRequired:"You must be signed in to do this edit and create your own series.  Please use the sign in button to use your Facebook account."};var D=0;var T={quickView:50,views:55,checkbox:25,save:25,shortDate:74,mmmyyyy:62,longDate:125,deleteIcon:35,map:125,periodicity:25,linkIcon:30,src:150,drillIcon:35,count:60,scrollbarWidth:35,padding:11};var A={heights:{graphTabsGap:null,tableControls:42,innerDataTable:null,scrollHeads:null,windowMinimum:580},widths:{windowMinimum:750,mySeriesTable:{columns:{}},publicSeriesTable:{columns:{}},myGraphsTable:{columns:{}},publicGraphTable:{columns:{}}}};var I=7;var U=/\S/;var P;var _;var E;var F;var N=0;var O={};var L="",G="";var R=null;var q=null;var z=false;var B;var W=1;var H=0;var V;var Y;var X;var Q=[];var Z=false;window.fbAsyncInit=function(){FB.init({appId:"209270205811334",channelURL:"//www.mashabledata.com/fb_channel.php",status:true,cookie:true,oauth:true,xfbml:true});FB.getLoginStatus(function(e){account.signInFB(e);FB.Event.subscribe("auth.login",function(e){account.signInFB(e)})})};function J(){var e,t="facebook-jssdk";if(document.getElementById(t)){return}e=document.createElement("script");e.id=t;e.async=true;e.src="//connect.facebook.net/en_US/all.js";document.getElementsByTagName("head")[0].appendChild(e)}$(document).ready(function(){try{var e=window.localStorage.getItem("dummy")}catch(t){$("#dialog-top").html("MashableData Workbench requires a HTML 5 compliant browser.  The latest version of Internet Explorer, Chrome, Safari or Firefox are recommended.  Internet Explorer 8 users may experience slow rendering.<br><br>");gt=$("#dialog").dialog({modal:true,title:"Incompatible browser",width:500});$(".ui-dialog-titlebar-close").remove();return false}$(document).mouse({distance:10});requirejs.config({waitSeconds:15});require(["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"]);i();$("#edit-my-series").button({icons:{secondary:"ui-icon-pencil"}}).click(function(){_t(V)});$("#quick-view-to-series").button({icons:{secondary:"ui-icon-person"}}).click(function(){At(this)});$("#quick-view-delete-series").button({icons:{secondary:"ui-icon-trash"}}).addClass("ui-state-error").click(function(){Xt(this)});$("#quick-view-chart-or-map").buttonset();$("#quick-view-map").button({icons:{secondary:"ui-icon-flag"}});$("#quick-view-chart").button({icons:{secondary:"ui-icon-image"}});$("#quick-view-add-to-graph").button().addClass("ui-state-active").click(function(){if($("#quick-view-map:visible").length==1&&$("#quick-view-map:checked").length==1){Ut(this)}else{It(this)}});$("#quick-view-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){Pt()});$(".show-graph-link").fancybox({width:"100%",height:"100%",autoScale:true,showCloseButton:false,scrolling:"no",transitionIn:"none",transitionOut:"none"});jQuery.fancybox.center=function(){};$("#show-hide-pickers").button({icons:{secondary:"browse-rollup"}});$("#menu-account").button({icons:{secondary:"ui-icon-triangle-1-s"}}).click(function(){account.showSignInOut()});$("#menu-help").button({icons:{secondary:"ui-icon-help"}}).click(function(){$helpMenu=account.showPanel('<div style="width:400px;height:300px;">'+"<ul>"+'<li><a target="help" title="Features" href="http://www.mashabledata.com/features/">Features and tour</a></li>'+'<li><a target="help" title="Searching and browsing for data" href="http://www.mashabledata.com/searching-and-browsing-for-data/">Searching and browsing for data</a></li>'+'<li><a target="help" title="Using series math to answer complex questions" href="http://www.mashabledata.com/using-series-math-to-answer-complex-questions/">Using series math to answer complex questions</a> (corn v. wheat)</li>'+'<li><a target="help" title="My Series &amp; Graphs" href="http://www.mashabledata.com/my-series-graphs/">My Series &amp; Graphs</a></li>'+'<li><a target="help" title="What are map sets and point sets?" href="http://www.mashabledata.com/what-are-map-sets-and-point-sets/">What are map sets and point sets?</a></li>'+'<li><a target="help" title="Creating maps" href="http://www.mashabledata.com/creating-maps/">Creating maps</a>'+"<ul>"+'<li><a target="help" title="Maps: Comparing against a regional average" href="http://www.mashabledata.com/creating-maps/maps-comparing-against-a-regional-average/">Comparing against a regional average</a> (Unemployment by state)</li>'+'<li><a target="help" title="Changing base maps" href="http://www.mashabledata.com/creating-maps/changing-base-maps/">Changing base maps</a></li>'+'<li><a target="help" title="Map colors (continuous, discrete and logarithmic)" href="http://www.mashabledata.com/workbench-help/creating-maps/map-colors-continuous-discrete-and-logarithmic/">Map colors (continuous, discrete and logarithmic)</a></li>'+'<li><a target="help" title="Bubble maps and user defined regions" href="http://www.mashabledata.com/workbench-help/creating-maps/bubble-maps-and-user-defined-regions/">Bubble maps and user defined regions</a></li>'+"</ul>"+"</li>"+'<li><a target="help" title="User series and the Highcharts plugin" href="http://www.mashabledata.com/workbench-help/user-series-and-the-highcharts-plugin/">User series and the Highcharts plugin</a></li>'+'<li><a target="help" title="Accounts: free, individual and corporate" href="http://www.mashabledata.com/workbench-help/accounts-free-individual-and-corporate/">Accounts: free, individual and corporate</a></li>'+'<li><a target="help" title="Publishing graphs and fair use" href="http://www.mashabledata.com/workbench-help/publishing-graphs-and-fair-use/">Publishing graphs and fair use</a></li>'+"</ul>"+"</div>",$("#menu-help"))});X=$("#series-tabs li a").click(function(){ea(this)}).filter("[data='#local-series']").get(0);A.heights.scrollHeads=$("div#local-series div.dataTables_scrollHead").height();tt();at();yt();st();$("#series-table_filter input, #my_graphs_table_filter input").change(function(){aa()});B=$("#canvas").tabs({tabTemplate:'<li class="graph-tab"><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>',add:function(e,t){var a="Loading graph.  Please wait.";$("#canvas li.graph-tab span.ui-icon-close").off().click(Zt);return $(t.panel).append("<p>"+a+"</p>")},activate:function(e,t){aa()}});if(document.URL.indexOf("localhost")>=0){account.info.userId=2;account.info.accessToken="paste token here";jt()}else{J()}$(window).bind("resize load",tt()).bind("focus",function(e){if(z){if(yt()>0){P.fnFilter("");P.fnSort([[I,"asc"]])}}e.bubbles=true;return true});it();nt();$("#tblPublicSeries_processing, #tblPublicGraphs_processing").html("searching the MashableData servers...");$("div.dataTables_scrollBody").height(A.heights.innerDataTable);$("#series-search-button, #graphs-search-button").addClass("ui-state-active").button({icons:{secondary:"ui-icon-search"}});sa();$("ul#series-tabs").click(function(){xt()});hasher.changed.add(K);hasher.initialized.add(K);hasher.init();window.onbeforeunload=function(){return"Your work will be lost."};for(var a in mapsList)Q.push(a);Q.sort();$("body").resize(tt);$("#series_search_periodicity, #series_search_source, #series-search-button").click(dt);$("#show-hide-pickers").click(function(){wt();aa()});require(m,function(){$.fn.colorPicker.defaults.colors.splice(-1,0,h,f);Highcharts.setOptions({tooltip:{formatter:function(){var e=y(this.point.x,this.series.options.period)+"<br>"+this.series.name.trim()+":<br>"+Highcharts.numberFormat(this.y,parseInt(this.y)==this.y?0:3,".",",")+" "+this.series.yAxis.options.title.text;return e}}})});(function(){if(window.location.href.indexOf("workbenchdev")<0&&window.location.href.indexOf("nolog")<0&&!window.localStorage.getItem("nolog")){var e=jQuery.event.dispatch;jQuery.event.dispatch=function(){try{e.apply(this,arguments)}catch(t){sa();var a=window.nagivator?navigator.appName+" - "+navigator.appCodeName+" - "+navigator.appVersion:"undefined";$.ajax({type:"POST",url:"api.php",data:{command:"LogError",browser:a,url:window.location.href,message:t.message,stack:t.stack,uid:account.info.userId,lang:navigator.language,platform:navigator.platform,version:workbenchVersion},dataType:"json"});vt("error","A error has occurred.  MashableData servers have logged the error and our technician have been alerted.")}}}})()});function K(e,t){Z=true;var a,i={},s,n=e.split("&");for(var o=0;o<n.length;o++){s=n[o].split("=");i[s[0]]=s[1]}if(i.t){switch(i.t.toLowerCase()){case"ms":$("#series-tabs").find("li.local-series a").click();a=$("#series-table_filter").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s)).keyup()}if(B.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cs":$("#series-tabs").find("li.cloud-series a").click();a=$("#series_search_text");N==i.cat||0;$("#series_search_periodicity").val(i.f||"all");$("#series_search_source").val(i.api||"all");$("#public-mapset-radio").find("input[value="+(i.sets||"all")+"]").click();if(N!=0){a.val("category: "+O[N].name);dt()}else{if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s));$("#series-search-button").click()}}if(B.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"mg":$("#series-tabs").find("li.my-graphs a").click();a=$("#my_graphs_table_filter").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s)).keyup()}if(B.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;case"cg":$("#series-tabs").find("li.public-graphs a").click();a=$("#public_graphs_search").find("input");if(i.s&&decodeURI(i.s)!=a.val()){a.click().val(decodeURI(i.s));dt(true)}if(B.find("li.graph-tab").length>0)$("#show-hide-pickers").show();break;default:var r=$("#graph-tabs").find("a[href=#graphTab"+i.t.substr(1)+"]");if(r.length==1){r.click()}else{if(i.graphcode){for(var l in p){if(p[l].ghash==i.graphcode){var d=$("#graph-tabs a[href='#"+l+"']");if(d.length==1){var c=true;d.click();break}}}if(!c){mt(i.graphcode)}}}$("#show-hide-pickers").hide()}}Z=false}function et(e){if(!Z){hasher.changed.active=false;hasher.setHash(e);hasher.changed.active=true}}function tt(){var e=Math.max($(window).innerHeight()-10,A.heights.windowMinimum);var t=Math.max($(window).innerWidth()-10,A.widths.windowMinimum);$("div#wrapper").height(e).width(t);A.heights.menuBar=$("#title-bar").outerHeight(true);A.heights.canvas=e-A.heights.menuBar-2;A.heights.graphTabs=$("#graph-tabs").outerHeight();$("div#canvas").height(A.heights.canvas);$("div.graph-panel").height(A.heights.canvas-A.heights.graphTabs).width(t).css("margin","0").css("padding","0");A.heights.pickers=A.heights.canvas;$("div.picker").height(A.heights.pickers);A.heights.innerDataTable=A.heights.pickers-A.heights.tableControls-A.heights.scrollHeads-40;$("div.dataTables_scrollBody").height(A.heights.innerDataTable);A.widths.canvas=$("#canvas").innerWidth();A.widths.mySeriesTable.table=A.widths.canvas-8*T.padding-T.scrollbarWidth;var a=A.widths.mySeriesTable.table-(T.periodicity+2*T.shortDate+T.src+T.shortDate);A.widths.mySeriesTable.columns.units=parseInt(a*.2);A.widths.mySeriesTable.columns.series=parseInt(a*.55);A.widths.mySeriesTable.columns.category=parseInt(a*.25);$("#series-table_wrapper").find("thead").find("th.title").width(A.widths.mySeriesTable.columns.series+"px").end().find("th.units").width(A.widths.mySeriesTable.columns.units+"px").end().find("th.cat").width(A.widths.mySeriesTable.columns.category+"px");A.widths.publicSeriesTable.table=A.widths.canvas-7*T.padding-T.scrollbarWidth;a=A.widths.publicSeriesTable.table-(T.periodicity+T.src+2*T.mmmyyyy);A.widths.publicSeriesTable.columns.series=a*.4;A.widths.publicSeriesTable.columns.units=a*.3;A.widths.publicSeriesTable.columns.category=a*.3;$("#tblPublicSeries_wrapper").find("thead").find("th.title").width(A.widths.publicSeriesTable.columns.series+"px").end().find("th.units").width(A.widths.publicSeriesTable.columns.units+"px").end().find("th.cat").width(A.widths.publicSeriesTable.columns.category+"px");A.widths.myGraphsTable.table=A.widths.canvas-6*T.padding-T.scrollbarWidth;a=A.widths.myGraphsTable.table-(T.quickView+T.shortDate+T.map);A.widths.myGraphsTable.columns.title=a*.25;A.widths.myGraphsTable.columns.analysis=a*.5;A.widths.myGraphsTable.columns.series=a*.25;$("#my_graphs_table_wrapper").find("thead").find("th.title").width(A.widths.myGraphsTable.columns.title+"px").end().find("th.analysis").width(A.widths.myGraphsTable.columns.analysis+"px").end().find("th.series").width(A.widths.myGraphsTable.columns.series+"px");A.widths.publicGraphTable.table=A.widths.canvas-6*T.padding-T.scrollbarWidth;a=A.widths.publicGraphTable.table-(T.quickView+T.shortDate+T.map);A.widths.publicGraphTable.columns.title=a*.4;A.widths.publicGraphTable.columns.analysis=a*.35;A.widths.publicGraphTable.columns.series=a*.25;$("#tblPublicGraphs_wrapper").find("thead").find("th.title").width(A.widths.publicGraphTable.columns.title+"px").end().find("th.analysis").width(A.widths.publicGraphTable.columns.analysis+"px").end().find("th.series").width(A.widths.publicGraphTable.columns.series+"px")}function at(){P=$("#series-table").html("").dataTable({bProcessing:true,sDom:"frti",bPaginate:false,bFilter:true,bAutoWidth:false,fnInfoCallback:function(e,t,a,i,s,n){return"showing "+(i==s?"":s+" of ")+i+" series"},oLanguage:{sSearch:""},sScrollY:A.heights.innerDataTable-140+"px",aaSorting:[[I,"desc"]],aoColumns:[{mData:"name",sTitle:"Series Name<span></span>",sClass:"title",bSortable:true,sWidth:A.widths.mySeriesTable.columns.series+"px",mRender:function(e,t,a){return(a.mapsetid?c.mapset:"")+(a.pointsetid?c.pointset:"")+(a.themeid?c.hasCubeViz:"")+e+'<span class="handle">'+a.handle+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",bSortable:true,sWidth:A.widths.mySeriesTable.columns.units+"px",mRender:function(e,t,a){return e}},{mData:"period",sTitle:"P<span></span>",sClass:"dt-freq",bSortable:true,sWidth:T.periodicity+"px",mRender:function(e,t,a){return ut(a.period)}},{mData:"firstdt",sTitle:"from<span></span>",sClass:"dte",sWidth:T.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return y(e,a.period)}},{mData:"lastdt",sTitle:"to<span></span>",sClass:"dte",sWidth:T.shortDate+"px",bSortable:true,sType:"numeric",asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return y(e,a.period)}},{mData:"graph",sTitle:"Category<span></span>",sClass:"cat",bSortable:true,sWidth:A.widths.mySeriesTable.columns.category+"px",mRender:function(e,t,a){return e}},{mData:null,sTitle:"Source<span></span>",sClass:"dt-source",bSortable:false,sWidth:T.src+"px",resize:false,mRender:function(e,t,a){if(a.url){return ft(a.url,a.src)}else{return'<span class=" ui-icon ui-icon-person" title="user series"></span> '+a.username||""}}},{mData:"save_dt",sTitle:"added<span></span>",bSortable:true,sType:"numeric",sWidth:T.shortDate+"px",resize:false,mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){P.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");$t()}});$("#series-table_filter").appendTo("#series-bar-controls").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#series-table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("enter key phrase to filter").addClass("grey-italics").on("click keydown",function(){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ot);$(".new-series").button().click(function(){Et()});$("#series-table_info").appendTo("#local-series-header")}function it(){_=$("#tblPublicSeries").html("").dataTable({sDom:"frti",bServerSide:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public series"},fnServerData:function(e,t,a){var i=$("#tblPublicSeries_filter input").val();t.push({name:"command",value:"SearchSeries"});t.push({name:"uid",value:qt()});t.push({name:"accessToken",value:account.info.accessToken});t.push({name:"periodicity",value:$("#series_search_periodicity").val()});t.push({name:"apiid",value:$("#series_search_source").val()});t.push({name:"catid",value:N});t.push({name:"mapset",value:$("input:radio[name=public-mapset-radio]:checked").val()});t.push({name:"lastSearch",value:L});t.push({name:"search",value:i});if(L!=i){L=i;_.fnSort([]);return}$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,i){D+=parseFloat(e.exec_time);
console.log(e.command+" ("+e.search+"): "+e.exec_time+" ("+D+"ms)");if(e.status=="ok")a(e,t,i);else vt("server error",e.status)},error:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,i,s,n){return s+" series"},bAutoWidth:false,bProcessing:true,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bDestroy:true,sScrollX:$("#canvas").width()-55+"px",aaSorting:[],iDeferLoading:0,aoColumns:[{mData:"name",sTitle:"Series Name<span></span>",bSortable:true,sWidth:A.widths.publicSeriesTable.columns.series+"px",sClass:"title",mRender:function(e,t,a){return(a.mapsetid?c.mapset:"")+(a.pointsetid?c.pointset:"")+(a.themeid?c.hasCubeViz:"")+ht(e)+'<span class="handle">'+(a.userid?"U":"S")+a.seriesid+"</span>"}},{mData:"units",sTitle:"Units<span></span>",sClass:"units",sWidth:A.widths.publicSeriesTable.columns.units+"px",bSortable:true,mRender:function(e,t,a){return ht(e)}},{mData:null,sTitle:"P<span></span>",sWidth:T.periodicity+"px",bSortable:true,sClass:"dt-freq",mRender:function(e,t,a){return ut(a.period)}},{mData:"firstdt",sTitle:"from<span></span>",sClass:"dte",sWidth:T.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],mRender:function(e,t,a){return ht(y(e,a.period))}},{mData:"lastdt",sTitle:"to<span></span>",sClass:"dte",sWidth:T.mmmyyyy+"px",bSortable:true,asSorting:["desc","asc"],resize:false,mRender:function(e,t,a){return ht(y(e,a.period))}},{mData:"title",sTitle:"Category (click to browse)<span></span>",sClass:"cat",sWidth:A.widths.publicSeriesTable.columns.category+"px",bSortable:true,mRender:function(e,t,a){if(a.apiid!=null&&a.title!=null){return'<span class="ui-icon browse-right">browse similar series</span> '+ht(e)}else{return ht(e)}}},{mData:null,sTitle:"Source<span></span>",bSortable:false,sClass:"url",sWidth:T.src+"px",resize:false,mRender:function(e,t,a){return ft(a.url,a.src)}}]}).click(function(e){var t=$(e.target).closest("td");if(t.hasClass("title")||t.hasClass("units")||t.hasClass("dt-freq")||t.hasClass("dte")){_.find("tr.ui-selected").removeClass("ui-selected");t.closest("tr").addClass("ui-selected");St()}if(t.hasClass("cat")){var a=t.closest("tr").find("span.handle").html();if(a)Ft(a.substr(1))}});$("#tblPublicSeries_info").html("").appendTo("#cloud-series-search");$("#tblPublicSeries_filter").hide();$("#public-mapset-radio").buttonset().find("input").change(function(){dt()});$("#series_search_text").val("enter search keywords (-keyword to exclude)").keyup(function(e){lt(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")});$("#cloud-series-browse").button({icons:{secondary:"ui-icon-circle-triangle-e"}}).click(function(){Ft()})}function st(){E=$("#my_graphs_table").html(" ").dataTable({sDom:"frti",bFilter:true,bPaginate:false,bAutoWidth:false,bProcessing:true,bDestroy:true,fnInfoCallback:function(e,t,a,i,s,n){return(i==s?"":"found "+s+" of ")+i+" graphs"+(s>0?" <b>Click on a title to open</b>":"")},oLanguage:{sSearch:""},oColReorder:{iFixedColumns:2},sScrollY:A.heights.innerDataTable-120+"px",sScrollX:A.widths.myGraphsTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"wrap title",sWidth:A.widths.myGraphsTable.columns.title+"px",mRender:function(e,t,a){return e.trim()+'<span class="handle" data="G'+a.gid+'">G'+a.gid+"</span> "}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:T.map+"px",mRender:function(e,t,a){return(a.mapsets?a.mapsets.options.mode=="bubble"?c.hasBubbleMap:c.hasHeatMap:"")+(a.pointsets?c.hasMarkerMap:"")+(a.themeid?c.hasCubeViz:"")+ht(e)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:true,sClass:"analysis",sWidth:A.widths.myGraphsTable.columns.analysis+"px",mRender:function(e,t,a){return ht(e.trim())}},{mData:"serieslist",sTitle:"Series ploted or mapped<span></span>",bSortable:true,sClass:"series",sWidth:A.widths.myGraphsTable.columns.series+"px",mRender:function(e,t,a){return ht(e)}},{mData:null,sTitle:"Views<span></span>",bSortable:true,sClass:"dt-count",sWidth:T.views+"px",mRender:function(e,t,a){if(a.published=="N"){return'<span class=" ui-icon ui-icon-locked" title="This graph has not been published.  You must publish your graphs from the graph editor">locked</span>'}else{return a.views}}},{mData:"updatedt",sTitle:"Created<span></span>",asSorting:["desc","asc"],sType:"numeric",sClass:"dte",sWidth:T.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");E.find("tr.ui-selected").removeClass("ui-selected");var a=E.fnGetData(t.closest("tr").addClass("ui-selected").get(0));mt(a.gid)});$("#my_graphs_table_filter").prependTo("#myGraphsHeader").append("<span class=\"filterReset ui-icon ui-icon-circle-close-inactive\" style=\"color:white;overflow:hidden;float:right;text-align:left;position:relative;top:3px;\" onclick=\"$('#my_graphs_table_filter :input').attr('value','').keyup();\">clear filter</span>").find("input").val("search my graphs").addClass("grey-italics").on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")}).on("keyup change",ot);$("#my_graphs_table_info").appendTo("#myGraphsHeader")}function nt(){F=$("#tblPublicGraphs").dataTable({sDom:"frti",bPaginate:false,bDestroy:true,bAutoWidth:false,bScrollInfinite:true,iDisplayLength:50,iScrollLoadGap:200,bProcessing:true,oLanguage:{sEmptyTable:"Please use the form above to search the MashableData servers for public graphs"},bServerSide:true,fnServerData:function(e,t,a){t.push({name:"command",value:"SearchGraphs"});t.push({name:"search",value:$("#tblPublicGraphs_filter input").val()});$.ajax({dataType:"json",type:"POST",url:"api.php",data:t,success:function(e,t,i){if(e.status=="ok")a(e,t,i);else vt("server error",e.status)},complete:function(e){console.log(e)}})},fnInfoCallback:function(e,t,a,i,s,n){return s+" graph"+(s==1?"s":"")+(s>0?" <b>click on title to view</b>":"")},iDeferLoading:0,oColReorder:{iFixedColumns:2},sScrollX:A.widths.publicGraphTable.table+"px",aaSorting:[[5,"desc"]],aoColumns:[{mData:"title",sTitle:"Title<span></span>",bSortable:true,sClass:"title",sWidth:A.widths.publicGraphTable.columns.title+"px",mRender:function(e,t,a){return e+'<span class="handle">G'+a.graphid+"</span>"}},{mData:"map",sTitle:"Map<span></span>",bSortable:true,sWidth:T.map+"px",mRender:function(e,t,a){return(a.mapsets?c.hasHeatMap:"")+(a.pointsets?c.hasMarkerMap:"")+(a.themeid?c.hasCubeViz:"")+ht(e)}},{mData:"analysis",sTitle:"Analysis<span></span>",bSortable:false,sWidth:A.widths.publicGraphTable.columns.analysis+"px"},{mData:"serieslist",sTitle:"Series<span></span>",bSortable:false,sClass:"series",sWidth:A.widths.publicGraphTable.columns.series+"px"},{mData:"views",sTitle:"Views<span></span>",bSortable:true,sClass:"count",sWidth:T.views+"px"},{mData:"modified",sTitle:"Modified<span></span>",bSortable:true,sType:"numeric",asSorting:["desc","asc"],sClass:"dte",sWidth:T.shortDate+"px",mRender:function(e,t,a){if(t=="sort")return parseInt(e);else return rt(e)}}]}).click(function(e){var t=$(e.target).closest("td");F.find("tr.ui-selected").removeClass("ui-selected");var a=F.fnGetData(t.closest("tr").addClass("ui-selected").get(0));var i=F.find("tr.ui-selected");if(i.length==1){var a=F.fnGetData(i.get(0));if(a){hasher.setHash(encodeURI("t=g&graphcode="+a.ghash))}else{vt("search for public graphs",S.noPublicGraphs)}}});$("#tblPublicGraphs_info").appendTo("#public_graphs_search");$("#tblPublicGraphs_filter").hide();$("#graphs_search_text").val("enter search terms or leave blank for latest graphs").keyup(function(e){pt(e)}).on("click keydown",function(e){$(this).removeClass("grey-italics").val("").off("click keydown")});$("#graphs-search-button").click(pt)}function ot(){var e=$(this);var t=e.closest("div").find("span.filterReset");if(e.val().length==0){t.removeClass("ui-icon-circle-close").addClass("ui-icon-circle-close-inactive")}else{t.removeClass("ui-icon-circle-close-inactive").addClass("ui-icon-circle-close")}}function rt(e){var t=new Date;var a=t.toDateString();if(isNaN(e)){t.setTime(Date.parse(e))}else{t.setTime(e)}if(t.toDateString()==a){return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(16,5)+"</span>"}else{return'<span title="'+t.toString().substr(4,20)+'">'+t.toString().substr(4,11)+"</span>"}}function lt(e){var t="which"in e?e.which:e.keyCode;if(N){var a=$("#series_search_text");a.val(a.val().replace("category: ",""));N=0}if(t==13&&e.target.id=="series_search_text"||e.target.id!="series_search_text"){dt();e.preventDefault()}}function dt(e){Rt();var t=$("#series_search_text");if(N&&$("#series_search_source").val()!="ALL"){t.val(t.val().replace("category: ",""));N=0}var a=t.hasClass("grey-italics")?"":t.val();if(a.match(/(title|name|skey):"[^"]+"/i)==null){a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/ /g," +")}$("#tblPublicSeries_filter input").val(a);_.fnFilter(a);if(!e)aa()}function ct(e){var t='title:"'+$(e).text()+'"';$("#series_search_text").val(t);dt()}function pt(e){var t="which"in e?e.which:e.keyCode;if(t==13&&e.target.id=="graphs_search_text"||e.target.innerHTML=="search"){var a=$("#graphs_search_text").hasClass("grey-italics")?"":$("#graphs_search_text").val();a=(" "+a+" ").replace(/[\s]+/g," ");a=a.substring(1,a.length-1);a="+"+a.replace(/ /g," +");$("#tblPublicGraphs_filter input").val(a);F.fnFilter(a);aa()}}function ut(e){switch(e){case"D":return'<span title="Daily data">D</span>';case"W":return'<span title="Weekly data">W</span>';case"M":return'<span title="Monthly data">M</span>';case"Q":return'<span title="Quarterly data">Q</span>';case"SA":return'<span title="Semi-annual data">SA</span>';case"A":return'<span title="Annual data">A</span>';default:return e}}function ht(e){return'<span title="'+(e==null?" ":e)+'">'+(e==null?" ":e)+"</span>"}function ft(e,t){t=t||e.replace(/\b(http(s)*:\/\/)*(www.)*/gi,"").replace("/"," /");return'<a href="'+e+'" target="_blank" title="'+e+'"><span class=" ui-icon ui-icon-extlink">'+e+"</span>"+t+"</a>"}function mt(e){v(e);Ct()}var gt;function bt(){vt("User Agreement","<span id=\"dialog-top\">MashableData is a free workbench to analyze and graph data series.  Data series viewed using our plugin have been securely cached in your browser's local storage.  To power the workbench, the data series must be shared with our servers.  Once sharing is enabled, you will be able to search and view series and public graphs on MashableData.com's servers.<br /><br />"+'<span id="dialog-learn"><i>To learn more, please read <a href="/" target="help">how MashableData works</a> and our <a href="/" target="help">privacy policy</a>.</i></span>'+"<br /><br />Ok to anonymously share the datasets you have browsed?</span>",[{text:"Enable",id:"btn-dia-enable",click:function(){var e=new Date;window.localStorage.setItem("authorized",e);J();$(this).dialog("close")}},{text:"Disable",id:"btn-dia-disable",click:function(){window.localStorage.clear();window.localStorage.setItem("authorized","no");$(this).dialog("close");window.location="."}}])}function vt(e,t,a){$("#dialog").html("<br><br>"+t+"<br><br>");if(!a){a=[{text:"OK",id:"btn-OK",click:function(){$(this).dialog("close")}}]}gt=$("#dialog").dialog({modal:true,title:e,width:500,buttons:a,open:function(){$("#btn-dia-enable").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}function yt(){var e,t=0,a={},i=window.localStorage.getItem("newSeries");if(i!=null){window.localStorage.removeItem("newSeries");var n=JSON.parse(i);var o=new Date;var r={command:"UploadMyMashableData",adddt:o.getTime(),series:[]};for(var l=0;l<n.length;l++){t++;e=JSON.parse(localStorage.getItem(n[l]));localStorage.removeItem(n[l]);e.handle="L"+H++;e.data=s.common.mashableDataString(e);if(account.loggedIn()){r.series.push(e);a[e.handle]=e}else{oMySeries[e.handle]=e;Vt($.extend({},e))}}if(account.loggedIn()){C(r,function(t,i,s){var n;for(var o in t.handles){n=t.handles[o];a[o].handle=n;e.usid=n.substr(1);Vt($.extend({},a[o]))}})}}z=true;return t}function kt(e,t){var a=window.localStorage.getItem(t);var i=false;if(a==null){}else{var s=a.split("|");for(var n=0;n<s.length;n++){if(s[n]==e){s.splice(n,1);i=true}}if(s.length==0){window.localStorage.removeItem(t)}else{window.localStorage.setItem(t,s.join("|"))}}return i}function wt(){var e=$("div.picker:visible").length;if(e==1){$(".show-hide").slideToggle(function(){var e=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");$(e).hide()});$("#show-hide-pickers").hide({complete:aa})}else{$(".show-hide").slideToggle(function(){});if(B.find("li.graph-tab").length>0)$("#show-hide-pickers").show()}}function xt(){if($("div.picker:visible").length==0)wt()}function Ct(){if($("div.picker:visible").length==1)wt()}function Mt(e){var t=$(e).closest("div.graph-panel").get(0).id;p[t].controls.chart.setTitle({text:e.value});p[t].title=e.value;if(e.value.length==0){var a="Graph"+t.substring(t.indexOf("-")+1);$("a[href=#"+t+"]").html(a).attr("title",a)}else{$("a[href=#"+t+"]").html(e.value).attr("title",e.value)}p[t].controls.chart.redraw()}function $t(){var e=[],t=false;$("#local-series-header input").focus();R=P.find("tr.ui-selected").each(function(){e.push(P.fnGetData(this))});if(e.length==0){for(var a in oMySeries){t=true;break}if(t)vt("no series selected",S.noSeriesSelected);else vt("no series selected",S.noMySeries)}else{Dt(e,false)}}function St(){var e=[],t=false;$("#series_search_text").focus();_.find("tr.ui-selected").each(function(){e.push(_.fnGetData(this))});if(e.length==0){vt("selection required",S.noSeriesSelected)}else{Dt(e,true)}}function Dt(e,t){var a=[],i=[],s,n;for(n=0;n<e.length;n++){if(!e[n].data){if(e[n].handle[0]=="S")a.push(e[n].handle.substring(1));if(e[n].handle[0]=="U")i.push(e[n].handle.substring(1))}}if(a.length+i.length==0){Tt(e,t)}else{C({command:"GetMashableData",sids:a,usids:i},function(a,i,o){for(n=0;n<e.length;n++){s=e[n].handle;if(oMySeries[s]){oMySeries[s].data=a.series[s].data;oMySeries[s].notes=a.series[s].notes;oMySeries[s].geocounts=a.series[s].geocounts}e.splice(n,1,a.series[s])}Tt(e,t)})}}function Tt(e,t){var a,i,s;var n=false,r=[],l=[],d=[];var c=$("#quick-view-maps");if(R)$("#quick-view-delete-series").show();else $("#quick-view-delete-series").hide();if(e.plots){a=e;V=e}else{if(e instanceof Array)i=e;else i=[e];V=i;a=emptyGraph();a.plots=[];var p=[];for(s=0;s<i.length;s++){a.assets[i[s].handle]=i[s];a.plots.push({components:[{handle:i[s].handle,options:{k:1,op:"+"}}],options:{}});p.push(i[s].handle)}}var u=o.makeChartOptionsObject(a);delete u.chart.height;if(i instanceof Array){if(i.length==1){u.title={text:i[0].name};u.legend={enabled:false}}else{delete u.title}}u.chart.borderWidth=2;u.chart.renderTo="highcharts-div";Y=new Highcharts.Chart(u);var h="";if(!e.plots){if(i.length==1&&i[0].notes){h='<table><tr><td width="20%">Graph title or API category:</td><td width="*">'+i[0].graph||""+"</td></tr>"+"<tr><td>Series notes:</td><td>"+i[0].notes||""+"</td></tr>"+"<tr><td>My Series count:</td><td>"+i[0].myseriescount||""+"</td></tr>"+"<tr><td>Graphs (including unpublished) count:</td><td>"+i[0].graphcount||""+"</td></tr>"+"<tr><td>Series key:</td><td>"+i[0].skey||""+"</td></tr>"+"</table>"}for(s=0;s<i.length;s++){if(i[s].mapsetid&&d.indexOf("M"+i[s].mapsetid)==-1||i[s].pointsetid&&d.indexOf("X"+i[s].pointsetid)==-1){if(i[s].mapsetid)d.push("M"+i[s].mapsetid);else d.push("X"+i[s].pointsetid);for(var f in i[s].geocounts){if(i[s].geocounts[f].set>1){n=true;if(i[s].geocounts[f].regions){r.push('<option value="'+f+'">'+f+" ("+i[s].geocounts[f].set+")</option>")}else{l.push('<option class="other-map" value="'+f+'">'+f+" ("+i[s].geocounts[f].set+")</option>")}}}}}}if(n){r.sort();l.sort();$("#quick-view-chart-or-map").show().find("input").off().click(m);c.html(r.join("")+(l.length>0?'<option class="other-maps" value="other">other maps for this set:</option>'+l.join(""):""))}else{c.hide();$("#quick-view-chart-or-map").hide()}$("#qv-info").html(h);function m(){var e=$("#quick-view-chart-or-map input:checked").val()!="chart";var t=c.css("display")!="none";if(e&&!t||!e&&t)c.animate({width:"toggle"})}m();if(t){$("#quick-view-to-series").button("disable").show();$("#quick-view-delete-series").hide()}else{$("#quick-view-to-series").hide();$("#quick-view-delete-series").show()}var g='<option value="new">new graph</option>';$("div.graph-panel").each(function(){var e=$("ul#graph-tabs li a[href='#"+this.id+"']");g+='<option value="'+this.id+'"'+(e.closest("li").hasClass("ui-tabs-selected")?" selected":"")+">"+e.get(0).innerHTML+"</option>"});$("#quick-view-to-graphs").html(g).val(k()).off().click(function(){$("#quick-view-add-to-graph").find(".ui-button-text").html($(this).val()=="new"?"create graph":"add to graph")}).click();$(".show-graph-link").click()}function At(e){$(e).button("disable");for(var t=0;t<V.length;t++){V[t].save_dt=(new Date).getTime();var a=Vt(V[t]);Ht(V[t])}vt("My Series","series added.",[]);$("#dialog").closest(".ui-dialog").fadeOut(1e3,function(){$("#dialog").dialog("close")})}function It(e){var t,a=$("#quick-view-to-graphs").val();if(V.plots){if(a!="new"){var i=V.plots,s=p[a];s.controls.provenance.provOk(false);if(!s.plots)s.plots=[];for(var n=0;n<i.length;n++){s.plots.push(i[n])}for(var o in V.assets){p[a].assets[o]=p[a].assets[o]||V.assets[o]}$("ul#graph-tabs li a[href='#"+a+"']").click();s.controls.redraw()}else{buildGraphPanel(V)}}else{if(!(V instanceof Array))V=[V];if(a!="new"){t=p[a];t.controls.provenance.provOk(false)}else{t=emptyGraph()}if(!t.plots)t.plots=[];for(var r=0;r<V.length;r++){t.assets[V[r].handle]=$.extend({save_dt:(new Date).getTime()},V[r]);t.plots.push({components:[{handle:V[r].handle,options:{k:1,op:"+"}}],options:{}})}if(a!="new"){$("ul#graph-tabs li a[href='#"+a+"']").click();t.controls.redraw()}else{buildGraphPanel(t)}}Pt();Ct();aa()}function Ut(){var e=$("#quick-view-to-graphs").val();var t;var a=$("#quick-view-maps").val();if(p[e]&&p[e].map&&(p[e].map!=a||p[e].mapsets&&V[0].period!=p[e].assets[p[e].mapsets.components[0].handle].period||p[e].pointsets&&V[0].period!=p[e].assets[p[e].pointsets[0].components[0].handle].period)){vt("Map Error","This graph already has a "+p[e].map+" map.  Additional map data can be added, but must use the same base map <i>and</i> data set must have same frequecy.");return null}if(a=="other"){vt("selection required","Please select a base map to graph this set.");return null}var i;if(e=="new"){i=emptyGraph()}else{i=p[e];i.controls.provenance.provOk(false)}i.map=a;i.mapconfig.legendLocation=mapsList[a].legend;i.mapFile=mapsList[a].jvectormap;require(["/global/js/maps/"+i.mapFile+".js"]);if(!i.plots)i.plots=[];for(var s=0;s<V.length;s++){serie=V[s];i.plots.push({options:{},components:[{handle:serie.handle,options:{k:1,op:"+"}}]});if(serie.geocounts&&serie.geocounts[a]){if(!isNaN(serie.mapsetid)&&serie.mapsetid>0&&!o(serie.mapsetid)){if(!i.mapsets)i.mapsets={options:{},components:[]};t="M"+serie.mapsetid;i.mapsets.components.push({handle:t,options:{k:1,op:i.mapsets.components.length==0?"+":"/"}})}if(!isNaN(serie.pointsetid)&&serie.pointsetid>0&&!r(serie.pointsetid)){if(!i.pointsets)i.pointsets=[];t="X"+serie.pointsetid;i.pointsets.push({options:{},components:[{handle:t,options:{k:1,op:"+"}}]})}}}if(serie.themeid){if(d["T"+serie.themeid]){n(serie.themeid)}else{C({command:"GetCubeList",themeids:[serie.themeid]},function(e,t,a){d["T"+serie.themeid]=e.themes["T"+serie.themeid];n(serie.themeid)})}}else l();Pt();function n(e){var t=d["T"+e];var a='<div id="select-cube" style="width:330px;">'+"<h4>Map linked visualization available</h4>"+"<p>This series is part of a "+t.name+"structure set that supports the following facetted vizualizations, which will be linked to the user's map clicks.</p><p>Please choose one.</p>"+'<select class="cubeSelector" size="'+t.cubes.length+'">';for(var s=0;s<t.cubes.length;s++){a+='<option value="'+t.cubes[s].cubeid+'" '+(s==t.cubes.length-1?"selected":"")+">"+t.cubes[s].name+"</option>"}a+="</select></label><br><br>"+'<button class="right" id="noViz">skip</button> <button class="right" id="vizSetOk">add linked visualization</button> '+"</div>";$.fancybox(a,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var n=$("#select-cube");$("#vizSetOk").button({icons:{secondary:"ui-icon-cube"}}).click(function(){var e=n.find(".cubeSelector").val();i.mapconfig.cubeid=e;o()});$("#noViz").button({icons:{secondary:"ui-icon-close"}}).click(function(){o()});function o(){$.fancybox.close();l()}}function o(e){if(i.mapsets){for(var t=0;t<i.mapsets.components.length;t++){if(i.mapsets.components.handle=="M"+e)return true}}return false}function r(e){if(i.pointsets){for(var t=0,a=i.pointsets.length;t<a;t++){for(var s=0,a=i.pointsets[t].components.length;s<a;s++){if(i.pointsets[t].components.handle=="X"+e)return true}}}return false}function l(){getAssets(i,function(){require(["/global/js/maps/"+i.mapFile+".js"],function(){if(i.title===null||i.title==""){i.title=i.mapsets?plotName(i,i.mapsets):plotName(i,i.pointsets[0])}if(e=="new"){buildGraphPanel(i)}else{$("ul#graph-tabs li a[href='#"+e+"']").click();i.controls.redraw()}na("drawing");aa()});Ct()})}}function Pt(){Y.destroy();delete R;$("#fancybox-close").click()}function _t(e){if($("#outer-show-graph-div:visible").length==1)Pt();if(e.length==1){var t=e[0];if(t.mapsetid||t.pointsetid){var a='<div id="seriesOrSet" style="width:330px;">'+"<h4>This series is part of a set</h4>"+'<label><input type="radio" name="editSeriesOrSet" value="series" checked> edit just this series </label><br>'+'<label><input type="radio" name="editSeriesOrSet" value="set"> view and edit the set\'s series for the map:<br>'+'<select class="hidden" style="margin-top: 8px;margin-left: 25px"></select></label><br><br>'+'<button class="right" id="seriesOrSetCancel">cancel</button> <button class="right" id="seriesOrSetOk">OK</button>'+"</div>";$.fancybox(a,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});var i=$("#seriesOrSet");var s,n="",o=i.find("select").html("").show().click(function(){i.find("input:radio").removeAttr("checked").filter('[value="set"]').attr("checked","checked")});if(t.geocounts){for(s in t.geocounts){n+='<option value="'+s+"|"+mapsList[s].jvectormap+'">'+s+" ("+t.geocounts[s].set+")</option>"}o.html(n)}else{C({command:"GetAvailableMaps",mapsetid:t.mapsetid,pointsetid:t.pointsetid,geoid:t.geoid},function(e,t,a){for(var i=0;i<e.maps.length;i++){n+='<option value="'+e.maps[i].name+"|"+e.maps[i].file+'">'+e.maps[i].name+" ("+e.maps[i].count+")</option>"}o.html(n)})}$("#seriesOrSetOk").button({icons:{secondary:"ui-icon-check"}}).click(function(){if($("input:radio[name='editSeriesOrSet']:checked").val()=="series"){Et(e)}else{if(t.pointsetid)Et("X"+t.pointsetid,o.val());if(t.mapsetid)Et("M"+t.mapsetid,o.val())}$.fancybox.close()});$("#seriesOrSetCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}else Et(e)}else Et(e)}function Et(e,t){if(!account.loggedIn()){vt("account required",S.signInRequired);return}var a;var i=false;var s=false;var n=2;var o="U";$("#series-tabs").find("li.local-series a").click();var r=["/global/js/handsontable/jquery.handsontable.0.7.5.src.js","/global/js/contextMenu/jquery.contextMenu.1.5.14.src.js"];var l=null,d={U:{name:0,units:1,notes:2,handle:3,header:4},M:{name:0,units:1,notes:2,geoid:3,handle:4,header:5},X:{name:0,units:1,notes:2,geoid:3,handle:4,lat:5,lon:6,header:7}};if(e&&!Array.isArray(e)){require(r);if(e[0]=="M"){o=e;C({command:"GetSet",mapsetid:parseInt(o.substr(1)),map:t.split("|")[0],modal:"persist"},function(e,t,a){require(r,function(){c(e.setData)})});function c(e){u();var t,a,i,s,r,l=[["map set",e.name],["units",e.units],["notes",""],["geoid"],[o],["date"]];for(i=0;i<e.geographies.length;i++){l[d.M.geoid].push(e.geographies[i].geoid);console.info("trying to set mapset's series handles");l[d.M.handle].push(e.geographies[i].handle);l[d.M.header].push(e.geographies[i].geoname);r=d.M.header+1;if(e.geographies[i].data){t=e.geographies[i].data.split("||");t.sort();for(s=0;s<t.length;s++){a=t[s].split("|");while(r<l.length&&l[r][0]<a[0])l[r++].push("");if(r==l.length){l.push(c())}else{if(l[r][0]==a[0])l[r].push(a[1]);if(l[r][0]<a[0])l.splice(r,0,c())}r++}}while(r<l.length)l[r++].push("");function c(){var e,t=[a[0]];for(e=1;e<l[4].length-1;e++)t.push("");t.push(a[1]);return t}}n=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:n}).find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();sa()}}if(e[0]=="X"){o=e;C({command:"GetPointSets",pointsetids:[parseInt(o.substr(1))],map:t.split("|")[0],modal:"persist"},function(e,t,a){require(r,function(){p(e.pointsets[o])})});function p(e){u();var t,a,i,s,r,l=[["marker set",e.name],["units",e.units],["notes",""],["geoid"],["lat"],["lon"],[o],["date"]];for(var c in e.data){l[d.X.geoid].push(e.data[c].geoid);l[d.X.handle].push(e.data[c].handle);l[d.X.lat].push(e.data[c].lat);l[d.X.lon].push(e.data[c].lon);l[d.X.handle].push(e.data[c].handle);l[d.X.header].push(e.data[c].name.replace(e.name,"").trim());r=d.X.header+1;if(e.data[c].data){t=e.data[c].data.split("||");t.sort();for(s=0;s<t.length;s++){a=t[s].split("|");while(r<l.length&&l[r][0]<a[0])l[r++].push("");if(r==l.length){l.push(p())}else{if(l[r][0]==a[0])l[r].push(a[1]);if(l[r][0]<a[0])l.splice(r,0,p())}r++}}while(r<l.length)l[r++].push("");function p(){var e,t=[a[0]];for(e=1;e<l[d.X.header].length-1;e++)t.push("");t.push(a[1]);return t}}n=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:l,minCols:n}).find("table.htCore tr").show().filter(":eq("+d.X.handle+")").hide().end().filter(":eq("+d.X.geoid+")").hide();sa()}}}else{require(r,function(){f(e)})}function u(){n=2;var e=0,t=0;var r=$("div#edit-user-series").height($("div#local-series").height()).fadeIn();a=$("#data-editor").height($("div#local-series").height()-50).html("");r.find("button.series-edit-save").button({icons:{secondary:"ui-icon-disk"}}).off().click(function(){b()});r.find("button.series-edit-cancel").button({icons:{secondary:"ui-icon-close"}}).off().click(function(){v()});r.find("button.series-edit-preview").button({icons:{secondary:"ui-icon-image"}}).off().click(function(){var e=g();if(e)Tt(e,false)});r.find("button.series-edit-geoset").button({icons:{secondary:"ui-icon-flag"}}).show().off().click(function(){m()});r.find("button.series-edit-save-as").button({icons:{secondary:"ui-icon-copy"}});a.handsontable({minCols:2,minSpareCols:-1,minSpareRows:1,autoWrapRow:true,contextMenu:["row_above","row_below","col_right"],fillHandle:false,cells:function(e,t,a){var i={};if(e<d[o[0]].header&&t==0||e==d[o[0]].header){i.readOnly=true}i.type={renderer:h};return i},onSelection:function(i,n,o,r){if(i==o&&n==r){var l=$(a.handsontable("getCell",i,n)).css("background-color").toUpperCase();if(l=="RGB(224, 255, 255)"||l=="#E0FFFF")a.handsontable("selectCell",i,n+1);if(l=="RGB(128, 128, 128)"||l=="#808080"){a.handsontable("selectCell",i+(t==n&&e-i==1?-1:1),n)}e=i;t=n;if(i>4){var d=a.handsontable("getDataAtCell",i,0);if(d==""||d==null){var c=(a.handsontable("getDataAtCell",i-1,0)||"").toString();if(c.length>3){var p=ra(c);if(p){s=oa(c);if(s){a.handsontable("setDataAtCell",i,0,y(la(p,s),s))}}}}}}},onBeforeChange:function(e){var t=0;for(var a=0;a<e.length;a++){if(e[a][1]>t)t=e[a][1]}if(t>=n){n=t+1;$("#data-editor").handsontable("updateSettings",{cols:n});for(a=2;a<n;a++)$("#data-editor").handsontable("getCell",3,a).innerHTML="value"}},onChange:function(e,t){if(t=="edit"||t=="empty"){try{var i=a.handsontable("getDataReference");for(var s=i[0].length-1;s>1;s--){var n="";for(var o=0;o<i.length;o++){if(o!=3)n+=i[o][s];if(U.test(n))break}if(U.test(n))break;a.handsontable("alter","remove_col",s,s+1)}i=a.handsontable("getDataReference");for(var o=i.length-1;o>5;o--){var n="";for(var s=0;s<i[0].length;s++){if(o!=3)n+=i[o][s]}if(U.test(n))break;if(o<i.length-1)a.handsontable("alter","remove_row",o)}}catch(r){console.log(r)}}}});i=true}function h(e,t,a,i,s,r,l){switch(o[0]){case"U":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.U.header&&i==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}if(a==d.U.header){t.style.background="#808080";t.style.fontWeight="bold"}break;case"M":Handsontable.TextCell.renderer.apply(this,arguments);if(a<d.M.header){if(i==0){t.style.background="#E0FFFF";t.style.fontWeight="bold"}else{if(i==1){t.colSpan=Math.min(5,n-1)}else{$(t).addClass("hidden")}}}if(a==d.M.header){t.style.background="#808080";t.style.fontWeight="bold"}}}function f(e){if(!i)u();var t,a,n=$("#data-editor");$("button#series-edit-save").attr("disabled","disabled");if(e){var o=e[0],r=o.handle;var l=r[0];switch(l){case"U":$("button#series-edit-save").removeAttr("disabled");case"S":s=o.period;if(o.data){t=o.data.split("||").sort();for(a=0;a<t.length;a++){t[a]=t[a].split("|");t[a][0]=y(x(t[a][0]).getTime(),o.period)}t.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);n.attr("data",r).handsontable("loadData",t);n.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()}else{var c=[],p=[];if(r.charAt(0)=="U")p.push(parseInt(r.substr(1)));else c.push(parseInt(r.substr(1)));C({command:"GetMashableData",sids:c,usids:p},function(e,t,a){o.data=e.series[r].data;o.notes=e.series[r].notes;var i=e.series[r].data.split("||").sort();for(var s=0;s<i.length;s++){i[s]=i[s].split("|");i[s][0]=y(x(i[s][0]).getTime(),o.period)}i.unshift(["name",o.name],["units",o.units],["notes",o.notes],["handle",o.handle],["date","value"]);n.attr("data",r).handsontable("loadData",i);n.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide()})}break;default:vt("series editor","This option is not yet supported");return}}else{n.handsontable("loadData",[["name",""],["units",""],["notes",""],["handle","new"],["date","value"]]);n.find("table.htCore tr").show().filter(":eq("+d.U.handle+")").hide();s=false}$("div#edit-user-series").slideDown()}function m(){e();function e(){var e,a="",i;for(i=0;i<Q.length;i++){a+='<option value="'+Q[i]+'">'+Q[i]+"</option>"}var s='<div id="setsWizard" style="width:330px;">'+"<h4>Create a set of series that can be mapped:</h4>"+'<label><input name="setsWizardType" type="radio" value="M" checked /> as regions</label><br />'+'<label><input name="setsWizardType" type="radio" value="X" /> as points (requires latitudes and longitudes)</label><br /><br />'+'<select id="setsWizardMap" style="width: 300px;">'+'<option value="nomap" class="nomap">select map</option>'+a+"</select><br><br>"+'<button class="right" id="setsWizardCancel">cancel</button><button class="right" id="setsWizardOk">OK</button>'+"</div>";$.fancybox(s,{showCloseButton:false,autoScale:true,overlayOpacity:.5,hideOnOverlayClick:false});$("#setsWizardMap").change(function(){if($(this).val()!="nomap"){$("#setsWizardOk").button("option","disabled",false);$(this).find("option[value='nomap']").remove()}});$("#setsWizardOk").button({icons:{secondary:"ui-icon-check"},disabled:true}).click(function(){t($("#setsWizardMap").val(),$("#setsWizardMap").text(),$("input:radio[name='setsWizardType']:checked").val());$.fancybox.close()});$("#setsWizardCancel").button({icons:{secondary:"ui-icon-close"}}).click(function(){$.fancybox.close()})}function t(e,t,s){o=s;if(s=="M")C({command:"GetMapGeographies",map:e},i);else{var r=[["point set"],["units"],["notes"],["geoid"],["handle"],["date"]];for(var l=0;l<jsoData.geographies.length;l++){r[d.M.geoid].push(jsoData.geographies[l].geoid);r[d.M.name].push(jsoData.geographies[l].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();n=jsoData.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:r,minCols:n})}}function i(e,t,i){var s=[["map set"],["units"],["notes"],["geoid"],["handle"],["date"]];
for(var o=0;o<e.geographies.length;o++){s[d.M.geoid].push(e.geographies[o].geoid);s[d.M.header].push(e.geographies[o].name)}a.find("table.htCore tr").show().filter(":eq("+d.M.handle+")").hide().end().filter(":eq("+d.M.geoid+")").hide();n=e.geographies.length+1;$("#data-editor").removeAttr("data").handsontable({data:s,minCols:n})}}function g(){var e=$("#data-editor");e.handsontable("destroyEditor",false);var t=e.data("handsontable").getData();var a=1,i=[];var s,n,r,l,c=d[o];var p,u,h,f,m,g;for(p=1;p<t[0].length;p++){g=false;for(u=d[o[0]].header+1;u<t.length;u++){if(t[u][p]!==null&&U.test(t[u][p])){if(o=="U"&&(!U.test(t[d.U.name][p])||t[d.U.name][p]===null||!U.test(t[d.U.units][p])||t[d.U.units][p]===null)){vt("Invalid Series","Name and units are required fields.");return false}g=true;break}}var b;if(g){switch(o[0]){case"M":s={handle:t[d.M.handle][p],name:t[d.M.name][1]+" - "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.M.units][1],notes:t[d.M.geoid][p],geoid:t[d.M.geoid][p],save_dt:(new Date).getTime()};b=d.M.header;break;case"X":s={handle:t[d.X.handle][p],name:t[d.X.name][1]+" "+t[d.M.header][p],setname:t[d.M.name][1],units:t[d.X.units][1],notes:t[d.X.notes][1],geoid:t[d.X.geoid][p],lat:t[d.X.lon][p],lon:t[d.X.lat][p],save_dt:(new Date).getTime()};b=d.X.header;break;default:s={handle:t[d.U.handle][p],name:t[d.U.name][p],units:t[d.U.units][p],notes:t[d.U.notes][p],save_dt:(new Date).getTime()};b=d.U.header;break}if(!s.handle){s.handle="L"+a++}if(s.name.length==0||s.units.length==0){vt("Invalid Series","Name and units are required fields.");return false}n=[];l="";for(u=b+1;u<t.length;u++){if(t[u][p]!==null&&t[u][p].length>0){if(isNaN(t[u][p])&&t[u][p].toLowerCase()!="null"){vt("Unreadable Values","Value cells must be numbers, 'null', or blank.");return false}m=ra(t[u][0]);if(!m){vt("Invalid Date Formats","Valid date formats are required in the left column for non-empty values.");return false}n.push({x:m.getTime(),y:parseFloat(t[u][p])})}}r=Yt(n);n.sort(function(e,t){return e.x-t.x});for(var v in n){var y=new Date(n[v].x);switch(r.period){case"A":l+="||"+y.getUTCFullYear()+"|"+n[v].y;break;case"W":case"D":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+"|"+n[v].y;break;case"M":case"Q":case"SA":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+"|"+n[v].y;break;case"N":l+="||"+y.getUTCFullYear()+(y.getUTCMonth()<=9?"0":"")+y.getUTCMonth()+(y.getUTCDate()<=9?"0":"")+y.getUTCDate()+" "+y.getUTCHours()+":"+y.getUTCHours()+":"+y.getUTCMinutes()+"|"+n[v].y;break}}s.data=l.substr(2);s.period=r.period;if(s.data.trim().length>0){i.push(s);$.extend(s,r)}}}if(i.length==0){vt("No data","No date-value pairs found.");return false}return i}function b(){var e,t=g();if(t){C({command:"SaveUserSeries",series:t,set:o,setname:t[0].setname},function(a,i,s){for(e=0;e<t.length;e++){if(t[e].handle.substr(0,1)=="U"&&t[e].handle.substr(0,1)=="U"){P.find("span.handle:contains("+t[e].handle+")").each(function(){if($(this).html()==t[e].handle)P.fnDeleteRow($(this).closest("tr").get(0))})}t[e].handle="U"+a.series[e].usid;t[e].usid=a.series[e].usid;t[e].mapsetid=a.series[e].mapsetid;t[e].pointsetid=a.series[e].pointsetid;t[e].graph="";t[e].url="";t[e].username=account.info.name||"user";t[e].userid=account.info.userId||null;P.fnAddData(t[e]);oMySeries[t[e].handle]=t[e]}});v()}sa()}function v(){var e=$("#data-editor");e.handsontable("destroy");e.attr("style","overflow:scroll;");$("div#edit-user-series").fadeOut()}}function Ft(e){C({command:"GetCatChains",sid:e||0},function(t,a,i){var s=0,n,o=0;var r=$('<table id="cat-chains">');var l={},d,c,p;console.log(t.chains);for(var u in t.chains){d=l;p=null;if(t.chains[u].length>o)o=t.chains[u].length;for(n=t.chains[u].length-1;n>=0;n--){O[t.chains[u][n].catid]=t.chains[u][n];O[t.chains[u][n].catid].parentid=p;if(p!==null){if(d[t.chains[u][n].name]){d[t.chains[u][n].name].catProps.count++}else{d[t.chains[u][n].name]={catProps:t.chains[u][n]};if(t.chains[u].length-1!=n)d[t.chains[u][n].name].catProps.siblings=t.chains[u][n+1].children;d[t.chains[u][n].name].catProps.count=1;d[t.chains[u][n].name].catProps.parentid=p}d=d[t.chains[u][n].name]}p=t.chains[u][n].catid}r.append("<tr></tr>");s++}var h=false,f,m;var g=[],b,v;for(b in l){if(b!="catProps")g.push(l[b])}while(!h){h=true;c=[];for(n=0;n<g.length;n++){if(g[n]==null){c.push(null)}else{h=false;v=true;for(d in g[n]){if(d!="catProps"){c.push(g[n][d]);v=false}}if(v)c.push(null);m=g[n].catProps;f=$('<td class="cat-branch'+(m.children>0?" expandable":"")+'" rowspan="'+m.count+'">'+'<div class="in-path" data="'+m.catid+'">'+(m.siblings>1&&e?'<span class="ui-icon browse-rolldown" title="show sibling categories"></span>':"")+(parseInt(m.scount)>0?'<a title="Click to view the '+m.scount+' series in this category">'+m.name+" ("+m.scount+")</a>":'<span class="title">'+m.name+"</span>")+(m.children>0?v?'<span class="ui-icon browse-right">show child categories</span>':'<span class="ui-icon browsed-right">child categories shown to right</span>':"")+"</div>"+"</td>");r.find("tr:eq("+n+")").append(f)}}g=c}r.click(Gt);if($("#cloud-series:visible").length==1){$("div#browse-api").height($("#cloud-series").height()).width($("#cloud-series").width())}$("div#browse-api").empty().prepend('<span style="padding:5px;">Click below to expand sibling and child categories.  Categories containing series are shown as links.  Note that a series can be in more than one category.</span>'+'<button id="browse-close" class="right">close</button>').append(r).fadeIn();$("#browse-close").button({icons:{secondary:"ui-icon-close"}}).click(function(){Rt()})})}function Nt(e){var t,a,i;var s=$(e).closest("div");var n=s.closest("td");var o=s.find("span.ui-icon-stop").length==1;i=$("#cat-chains");i.find("div.sibling").remove();i.find(".ui-icon.ui-icon-stop").removeClass("ui-icon-stop").addClass("browse-rolldown");var r=i.find("td.expanded").removeClass("expanded").addClass("expandable");if(r.length==1&&r.html()=="")r.remove();if(o)return;t=n.addClass("expanded").removeClass("expandable").find(".browse-rolldown").removeClass("browse-rolldown").addClass("ui-icon-stop").end().find("div").attr("data");var l=O[O[t].parentid];if(l.childrenCats){d(l.childrenCats)}else{C({command:"GetCatSiblings",catid:t},function(e,t,i){l.childrenCats=[];for(var s=0;s<e.siblings.length;s++){a=e.siblings[s];l.childrenCats.push(a.catid);if(!O[a.catid]){a.parentid=l.catid;O[a.catid]=a}}d(l.childrenCats)})}function d(e){var a,i;s.find("browse-rolldown").removeClass("browse-rolldown").addClass("ui-icon-stop");for(var o=0;o<e.length;o++){a=O[e[o]];if(a.catid==t){if(a.children>0){i=$('<span class="ui-icon browse-right" title="show child categories" data="'+a.catid+'"></span>');i.find(".browse-right").click(function(){Ot(this)});n.find("span.chain").append()}}else{i=$('<div class="sibling" data="'+a.catid+'">'+(a.children>0?' <span class="ui-icon browse-right" title="show child categories">show children categories</span>':"")+'<span class="ui-icon ui-icon-stop"></span><span class="sibling">'+(a.scount>0?'<a title="Click to view the '+a.scount+' series in this category">'+a.name+" ("+a.scount+")</a>":a.name)+"</span>"+"</div>");i.find(".browse-right").click(function(){Ot(this)});n.append(i)}}}}function Ot(e){var t,a;var i=$(e).closest("div").attr("data");if(O[i].childrenCats){s(O[i].childrenCats)}else{C({command:"GetCatChildren",catid:i},function(e,a,n){O[i].childrenCats=[];for(var o=0;o<e.children.length;o++){t=e.children[o];if(!O[t.catid]){t.parentid=i;O[t.catid]=t}O[i].childrenCats.push(t.catid)}s(O[i].childrenCats)})}function s(e){var s="",n=i;while(O[n].parentid!==null){s='<td class="cat-branch'+(O[n].children>0?" expandable":"")+'">'+'<div class="in-path">'+(O[n].siblings>0?'<span class="ui-icon browse-rolldown" title="show sibling categories"></span>':"")+(parseInt(O[n].scount)>0?'<a title="Click to view the '+O[n].scount+' series in this category" >'+O[n].name+" ("+O[n].scount+")</a>":O[n].name)+'<span class="ui-icon browsed-right">child categories shown to right</span>'+"</div></td>"+s;n=O[n].parentid}var o=$("#cat-chains").html("<tr>"+s+"</tr>");o.find("span.browse-rolldown").click(function(){Nt(this)});a=$('<td class="chain expanded"></td>');for(var r=0;r<e.length;r++){t=O[e[r]];a.append('<div data="'+t.catid+'">'+(t.children>0?' <span class="ui-icon browse-right" data="'+t.catid+'" title="show child categories"></span>':"")+'<span class="ui-icon ui-icon-stop"></span>'+(parseInt(t.scount)>0?'<a title="Click to view the '+t.scount+' series in this category" >'+t.name+" ("+t.scount+")</a>":t.name)+"</div>")}o.find("tr").append(a)}}function Lt(e){N=e;hasher.replaceHash(ta())}function Gt(e){var t=e.target;switch(t.nodeName){case"A":Lt($(t).closest("div").attr("data"));break;case"TD":var a=$(t).children("DIV");if(a.length!=1)return;t=$(a).get(0);case"DIV":case"SPAN":if($(t).hasClass("browse-right"))return Ot(t);if($(t).hasClass("browsed-rolldown"))return Nt(t);var i=$(t).closest("div");if(i.find("span.browse-right").length==1)return Ot(t);if(i.find("span.browse-rolldown").length==1)return Nt(t);break}}function Rt(){$("div#browse-api").fadeOut(function(){$(this).empty()})}function qt(){if(account.loggedIn())return account.info.userId;if(account.fb_user){var e={command:"GetUserId",authmode:"FB",username:account.fb_user.id,name:account.fb_user.name,email:account.fb_user.email,company:"",accesstoken:account.fb_user.accessToken};$.ajax({type:"POST",url:"api.php",data:e,dataType:"json",success:function(e,t,a){if(e.status=="ok"){console.info("GetUserId success");$.extend(account.info,account.fb_user,e);if(account.info.orgId&&account.info.orgName){$("#series_search_source").append('<option value="org">'+account.info.orgName+"</option>")}$("#menu-account").find(".ui-button-text").html(account.info.name);jt();if(account.subscribing)account.showSubscribe()}else{console.log(e);vt("Login Status",e.status)}},error:function(e,t,a){console.log(e)}});return false}return null}function jt(){var e,t,a,i;var s=new Date;var n={command:"UploadMyMashableData",adddt:s.getTime(),series:[]};for(e in oMySeries){if(e[0]=="L"){n.series.push(oMySeries[e])}}if(n.series.length>0){C(n,function(e,s,n){for(t in e.handles){a=e.handles[t];i=oMySeries[t];i.handle=a;i.sid=a.substr(1);delete oMySeries[t];oMySeries[a]=i;for(tab in p){r(p[tab],t,i)}for(var o in u){r(u[o],t,i)}}zt()})}else{zt()}function r(e,t,a){var i;if(e.assets){if(e.assets[t]){delete e.assets[t];e.assets[a.handle]=a}else{return}}o.eachComponent(e,function(){if(this.handle==t)this.handle=a.handle})}console.info("syncMyAccount run");C({command:"GetMyGraphs"},function(e,t,a){for(var i in e.graphs){u[i]=e.graphs[i];o.inflateGraph(u[i]);E.fnAddData(u[i])}})}function zt(){C({command:"GetMySeries",modal:"persist"},function(e,t,a){var i=[];for(var s in e.series){e.series[s].save_dt=parseInt(e.series[s].save_dt);oMySeries[s]=e.series[s];i.push(e.series[s])}P.fnClearTable();P.fnAddData(i)})}function Bt(e,t){if(e.gid){e.updatedt=(new Date).getTime()}else{e.createdt=(new Date).getTime()}e.serieslist=[];o.eachComponent(e,function(){e.serieslist.push(e.assets[this.handle].name)});e.serieslist=e.serieslist.join("; ");var a=e.assets;var i=e.calculatedMapData;var s=e.controls;delete e.assets;delete e.calculatedMapData;delete e.controls;var n={command:"ManageMyGraphs"};var r={},l=["assts"];$.extend(true,n,e);n.annotations=Wt(e);n.mapconfig=$.stringify(e.mapconfig);var d,c;o.eachPlot(n,function(){this.options=$.stringify(this.options);$.each(this.components,function(){this.options=$.stringify(this.options)})});e.assets=a;e.calculatedMapData=i;e.controls=s;C(n,function(n,o,r){e.gid=n.gid;e.ghash=n.ghash;e.isDirty=false;delete e.assets;delete e.calculatedMapData;delete e.controls;var l=$.extend(true,{from:"",to:""},e);e.assets=a;e.calculatedMapData=i;e.controls=s;l.updatedt=(new Date).getTime();if("G"+e.gid in u){var d;d=$(E).find("span.handle[data=G"+e.gid+"]").closest("tr").get(0);E.fnUpdate(l,d)}else{E.fnAddData(l)}u["G"+e.gid]=l;p[k()]=e;if(t)t()})}function Wt(e){var t="[";for(var a=0;a<e.annotations.length;a++){t+='{"type":"'+e.annotations[a].type+'",';if(e.annotations[a].type=="point")t+='"series":"'+e.annotations[a].series+'",';if(e.annotations[a].type.substring(0,1)=="h")t+='"yAxis":"'+e.annotations[a].yAxis+'",';t+='"color":"'+e.annotations[a].color+'",';t+='"from":"'+e.annotations[a].from+'",';if(e.annotations[a].type.indexOf("band")>-1)t+='"to":"'+e.annotations[a].to+'",';t+='"text":"'+e.annotations[a].text+'"}';if(a<e.annotations.length-1)t+=","}return t+"]"}function Ht(e){if(ia())return false;C({command:"ManageMySeries",modal:"none",jsts:e.save_dt,handle:e.handle,to:e.save},function(e,t,a){})}function Vt(e){if(e.handle){if(e.save_dt)e.save_dt=parseInt(e.save_dt);if(oMySeries[e.handle]){var t=P.find("button[data='"+e.handle+"']").closest("tr");if(t.length==1){P.fnDeleteRow(t.get(0))}}P.fnAddData(e);oMySeries[e.handle]=e}else{console.log("Error loading series object: invalid series handle.")}return e.handle}function Yt(e){var t={firstdt:null,lastdt:null,minValue:null,maxValue:null,period:"A",points:e.length};var a=null;var i=null;var s=null;var n=null;var o;if(t.points==1){o=new Date(e[0].x);if(o.getUTCMonth()!=0)t.period="M";if(o.getUTCDate()!=1)t.period="D";if(o.getUTCHours()+o.getUTCMinutes()+o.getUTCSeconds()!=0)t.period="T"}else{for(var r=0;r<t.points;r++){var l=e[r];if(t.firstdt==null||t.firstdt>l.x)t.firstdt=l.x;if(t.lastdt==null||t.lastdt<l.x)t.lastdt=l.x;if(t.minValue==null||t.minValue>l.y)t.minValue=l.y;if(t.maxValue==null||t.maxValue<l.x)t.maxValue=l.y;o=new Date(l.x);if(n==null){n=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()}else if(n!==true&&n!=o.getUTCHours()+":"+o.getUTCMinutes()+":"+o.getUTCSeconds()+"."+o.getUTCMilliseconds()){n=true}if(a==null){a=o.getUTCDate()}else if(a!==true&&a!=o.getUTCDate()){a=true}if(i==null){i=o.getUTCDay()}else if(i!==true&&i!=o.getUTCDay()){i=true}if(s==null){s=o.getUTCMonth()}else if(s!==true&&s!=o.getUTCMonth()){s=true}}if(n===true){t.period="T"}else if(i!==true){t.period="W"}else if(a===true){t.period="D"}else if(s===true){t.period="M"}else{t.period="A"}}return t}function Xt(){var e;vt("confirm deletion",S.deleteMySeries,[{text:"delete",id:"btn-delete",click:function(){for(var t=0;t<R.length;t++){e=P.fnGetData(R.get(t));if(account.loggedIn()){e.save=null;Ht(e)}delete oMySeries[e.handle];P.fnDeleteRow(R.get(t))}$(this).dialog("close");Pt()}},{text:"cancel",id:"btn-cancel",click:function(){$(this).dialog("close")}}])}function Qt(e){var t=e.length==0?"Graph "+W:e;var a="graphTab"+W++;var i=B.tabs("add","#"+a,t);$("#"+a).addClass("graph-panel");$("#canvas").tabs().find(".ui-tabs-nav").sortable({axis:"x",distance:10});B.tabs("select",B.tabs("length")-1);$(".ui-tabs-selected a").each(function(){$(this).attr("title",$(this).html())});tt();$("#btnEditGraphTop").removeAttr("disabled");if($("#delete-my-series").attr("disabled")!="disabled"){$("button.add-to-graph").removeAttr("disabled")}$("#graph-tabs a:last").click(function(){Ct()});return a}function Zt(e){var t=$(e.target);var a=t.parent().children("a").attr("href");var i=a.substr(1);Jt(i);$(a).remove();t.parent().remove();delete p[i];B.tabs("refresh");if(B.find("li").length==0){q=null;$("#btnEditGraphTop").attr("disabled","disabled");$("button.add-to-graph").attr("disabled","disabled");X.click()}else{$("#graph-tabs a:last").click()}$("#graph_title").attr("value","")}function Jt(e){if(p[e]&&p[e].controls){var t=p[e].controls;if(t.chart){t.chart.destroy();delete t.chart;$.contextMenu("destroy","#"+e+" div.chart")}if(t.map){t.map.remove();delete t.map}if(t.vizChart){t.vizChart.destroy();delete t.vizChart}}}function Kt(e){var t=[];if(e.length==1){return e[0]}if(e.length==0){return""}firstTitleWords=e[0].split(" ");for(var a=0;a<firstTitleWords.length;a++){var i=true;for(var s=1;s<e.length;s++){var n=" "+e[s]+" ";if(n.indexOf(" "+firstTitleWords[a]+" ")==-1){i=false;break}}if(i){t.push(firstTitleWords[a])}}return t.join(" ")}function ea(e){X=e;var t=$("#series-tabs li.ui-tabs-selected").removeClass("ui-tabs-selected ui-state-active").find("a").attr("data");var a=$(e).attr("data");$(e).parent().addClass("ui-tabs-selected ui-state-active");$(t).hide();$(a).show().find(".dataTables_filter input,#series_search_text,#graphs_search_text").get(0).focus();aa();return false}function ta(){var e,t=$("#series-tabs li.ui-tabs-selected a").attr("data"),a="grey-italics";switch(t){case"#local-series":e=$("#series-table_filter input");return encodeURI("t=ms"+(e.hasClass(a)?"":"&s="+e.val()));case"#cloud-series":if(N!=0){return encodeURI("t=cs&cat="+N)}else{e=$("#series_search_text");return encodeURI("t=cs"+(e.hasClass(a)?"":"&s="+e.val()+"&f="+$("#series_search_periodicity").val())+"&api="+$("#series_search_source").val()+"&sets="+$("#public-mapset-radio").find("input:checked").val())}case"#myGraphs":e=$("#my_graphs_table_filter input");return encodeURI("t=mg"+(e.hasClass(a)?"":"&s="+e.val()));case"#publicGraphs":e=$("#public_graphs_search input");return encodeURI("t=cg"+(e.hasClass(a)?"":"&s="+e.val()));default:var i=k();if(i&&p[i]){return encodeURI("t=g"+i.substr(8)+(p[i].ghash?"&graphcode="+p[i].ghash:""))}}}function aa(e,t){if(e){a="t=g"+t.replace("graphTab","")+"&graphcode="+e}else{var a=ta()}if(a&&hasher.getHash()!=a){if(hasher.getHash().search("t=g&graphcode=")==-1){et(a)}else{hasher.replaceHash(a)}}}function ia(){if(!account.loggedIn()){$("#dialog").html("<span><p>You must be signed in to use this function.  You can sign into MashableData.com with your Facebook account.  (Google+ account federation coming soon!)</p>"+"<p>Logging in does <em>not</em> grant MashableData automatic access to your email or to post to your account.</p>"+"</span><br>");gt=$("#dialog").dialog({modal:true,title:"Sign in required",width:500,buttons:[{text:"Close",id:"btn-dia-close",click:function(){$(this).dialog("close")}}],open:function(){$("#btn-dia-close").focus()},close:function(){}});$(".ui-dialog-titlebar-close").remove()}return!account.loggedIn()}function sa(){$("#wrapper").unmask()}function na(e){$("#wrapper").mask(e||"Loading...")}function oa(e){var t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"A";t=/^\s*[0-9]{4}[ -]{1}[0-2]{0-1}[0-9]{1-2}\s*$/i;if(t.test(e))return"M";t=/^\s*(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[ -]{1}[0-9]{4}\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}[ -]{1}(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s*$/i;if(t.test(e))return"M";t=/^\s*[0-9]{4}\s*$/i;if(t.test(e))return"D";t=/^\s*W[0-5]{0-1}[0-9]{1} [0-9]{4}\s*$/i;if(t.test(e))return"W";t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e))return"Q";t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e))return"H";return false}function ra(e){var t,a=new Date(e+" UTC");if(a.toString()!="NaN")return a;t=/^W[0-5]{0-1}[0-9]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^Q[1-4]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*3)}t=/^H[1-2]{1}\s[0-9]{4}/i;if(t.test(e)){a=new Date(parseInt(e.substr(3))+" UTC");return a.setUTCMonth((parseInt(e.charAt(1))-1)*6)}return false}function la(e,t){switch(t){case"A":return e.setUTCFullYear(e.getUTCFullYear()+1);case"Q":return e.setUTCMonth(e.getUTCMonth()+3);case"SA":return e.setUTCMonth(e.getUTCMonth()+6);case"M":return e.setUTCMonth(e.getUTCMonth()+1);case"W":return e.setUTCDate(e.getUTCDate()+6);case"D":return e.setUTCDate(e.getUTCDate()+1);default:return null}}function da(e,t,a){na("creating grid");var i=a.attr("data");var s=a.find(".slick-holder");if(e)e.destroy();var n=p[t];var o={enableCellNavigation:true,enableColumnReorder:false,defaultColumnWidth:200,headerRowHeight:100};switch(i){case"chart":var r=ca(t);e=new Slick.Grid(s,r.rows,r.columns,o);break;case"regions":e=new Slick.Grid(s,n.calculatedMapData.regionGrid.data,n.calculatedMapData.regionGrid.columns,o);break;case"markers":e=new Slick.Grid(s,n.calculatedMapData.markerGrid.data,n.calculatedMapData.markerGrid.columns,o);break}sa()}function ca(e){console.time("gridDataForChart");var t,a,i,n,o,r,l,d,c,u,h,f,m,g,b;var v=p[e];var k=v.assets;var C;if(v.plots){var M=v.controls.chart}else{throw"Chart does not exist; cannot make grid objects"}var $,S,D=[];var T=[{id:"date",field:"date",name:"name:<br>"+"units:<br>"+"source:<br>"+"notes:<br>"+"region code:<br>"+"lat, lon:<br>"+"formula:",cssClass:"grid-date-column"}];for(t=0;t<v.plots.length;t++){i=v.plots[t];$="P"+t;d=M.get($);var A=i.options.formula&&i.options.formula.formula.length>1||i.formula&&i.formula.formula.length>1||i.options.units||i.options.name;for(a=0;a<i.components.length;a++){S="P"+t+"-C"+a;n=k[i.components[a].handle];T.push({id:S,field:S,name:"<b>"+n.name+"</b><br>"+(n.units||"")+"<br>"+(n.src||"")+"<br>"+(n.notes||"")+"<br>"+(n.iso3166||"")+"<br>"+(n.lat?n.lat+", "+n.lon:"")+"<br>"+"<br>component "+w(a),cssClass:"grid-series-column"});l=n.data.split("||");for(o=0;o<l.length;o++){u=l[o].split("|");c=x(u[0]);h=y(c.getTime(),d.options.period);if((!v.start||v.start<=c)&&(!v.end||v.end>=c)){for(m=false,g=0;g<D.length;g++){if(D[g].id==u[0]){m=true;break}}if(!m)D.push({id:u[0],date:h,order:c});D[g][S]=u[1]===null?"-":u[1]}}}if(A){T.push({id:$,field:$,name:"<b>"+plotName(v,i)+"</b><br>"+plotUnits(v,i)+"<br>"+"<br>"+"<br>"+"<br>"+"<br>"+"<br>"+i.formula.formula,cssClass:"grid-calculated-column"});for(o=0;o<d.options.data.length;o++){b=d.options.data[o];h=y(b[0],d.options.period);f=s.common.mashableDate(b[0],d.options.period);if((!v.start||v.start<=b[0])&&(!v.end||v.end>=b[0])){for(m=false,g=0;g<D.length;g++){if(D[g].id==f){m=true;break}}if(!m)D.push({id:f,date:h,order:b[0]});D[g][$]=b[1]===null?"-":b[1]}}}}D.sort(function(e,t){if(t.order!=e.order){return t.order-e.order}else{return t.id.length-e.id.length}});console.timeEnd("gridDataForChart ");return{columns:T,rows:D}}function pa(e,t){var a=$("#"+e+" div.jvmap div").html();a=ua(a);ha({type:t,filename:"MashableDataMap",width:2e3,svg:a,url:"https://www.mashabledata.com/workbench/export/index.php"})}function ua(e){e=e.replace(/<div[^<]+<\/div>/gi,"");e=e.replace(/<svg /gi,'<svg xmlns="http://www.w3.org/2000/svg"  version="1.1" ');e=e.replace(/<g><\/g>/gi,"");e=e.replace(/<g/,'<rect x="0" y="0" width="100%" height="100%" fill="'+mapBackground+'"></rect><g');e=e.replace(/zIndex="[^"]+"/g,"").replace(/isShadow="[^"]+"/g,"").replace(/symbolName="[^"]+"/g,"").replace(/jQuery[0-9]+="[^"]+"/g,"").replace(/isTracker="[^"]+"/g,"").replace(/url\([^#]+#/g,"url(#").replace(/&nbsp;/g," ").replace(/&shy;/g,"­").replace(/id=([^" >]+)/g,'id="$1"').replace(/class=([^" ]+)/g,'class="$1"').replace(/ transform /g," ").replace(/:(path|rect)/g,"$1").replace(/style="([^"]+)"/g,function(e){return e.toLowerCase()});e=e.replace(/(url\(#highcharts-[0-9]+)&quot;/g,"$1").replace(/&quot;/g,"'");if(e.match(/ xmlns="/g)&&e.match(/ xmlns="/g).length===2){e=e.replace(/xmlns="[^"]+"/,"")}return e}function ha(e){var t=Highcharts.createElement;var a=t("form",{method:"post",action:e.url},{display:"none"},document.body);for(var i in e){t("input",{type:"hidden",name:i,value:e[i]},null,a)}a.submit();Highcharts.discardElement(a)}